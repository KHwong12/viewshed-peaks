var N=Object.defineProperty,D=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable;var _=(t,e,s)=>e in t?N(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,K=(t,e)=>{for(var s in e||(e={}))L.call(e,s)&&_(t,s,e[s]);if(I)for(var s of I(e))P.call(e,s)&&_(t,s,e[s]);return t},E=(t,e)=>D(t,G(e));import{r as V,w as q,I as z,A as H,le as U}from"./vendor.d423bc92.js";import{o as W}from"./definitions.9156fef2.js";import{p as Y,l as d}from"./tileUtils.cf31bf24.js";(()=>{if(!("document"in globalThis))return()=>null;const t=document.createElement("canvas"),e=t.getContext("2d"),s=512;return t.height=s,t.width=1,i=>{e.clearRect(0,0,1,t.height);const r=e.createLinearGradient(0,0,0,t.height);for(const{ratio:a,color:n}of i.colorStops)r.addColorStop(Math.max(a,.001),`rgba(${n[0]}, ${n[1]}, ${n[2]}, ${n[3]})`);return e.fillStyle=r,e.fillRect(0,0,1,t.height),e.getImageData(0,0,1,t.height).data}})();function B(t,e,s,i){const{blurRadius:r,fieldOffset:a,field:n}=e,p=new Float64Array(s*i),y=J(r),h=Math.round(3*r);let c,f=Number.NEGATIVE_INFINITY;const m=Q(n,a),g=new Set;for(const b of t){const u=b.getCursor();for(;u.next();){const M=u.getObjectId();if(g.has(M))continue;g.add(M);const o=u.readLegacyPointGeometry(),w=128;if(o.x<-w||o.x>=s+w||o.y<-w||o.y>i+w)continue;const v=+m(u),k=Math.round(o.x)-h,F=Math.round(o.y)-h,C=Math.max(0,k),O=Math.max(0,F),$=Math.min(i,Math.round(o.y)+h),A=Math.min(s,Math.round(o.x)+h);for(let T=O;T<$;T++){const R=y[T-F];for(let x=C;x<A;x++){const j=y[x-k];c=p[T*s+x]+=R*j*v,c>f&&(f=c)}}}}return{matrix:p.buffer,max:f}}function J(t){const e=Math.round(3*t),s=2*t*t,i=new Float64Array(2*e+1);for(let r=0;r<=i.length;r++)i[r]=Math.exp(-((r-e)**2)/s)/Math.sqrt(2*Math.PI)*(t/2);return i}function Q(t,e){return t!=null?typeof e=="string"?s=>-1*+s.readAttribute(t):s=>+s.readAttribute(t)+e:s=>1}class l{constructor(e,s){this.offset=e,this.extent=s}}function X(t){const e=t.key,s=new Map,i=256,r=W,a=t.tileInfoView.tileInfo.isWrappable;return s.set(d(e,-1,-1,a).id,new l([-r,-r],[r-i,r-i,r,r])),s.set(d(e,0,-1,a).id,new l([0,-r],[0,r-i,r,r])),s.set(d(e,1,-1,a).id,new l([r,-r],[0,r-i,i,r])),s.set(d(e,-1,0,a).id,new l([-r,0],[r-i,0,r,r])),s.set(d(e,1,0,a).id,new l([r,0],[0,0,i,r])),s.set(d(e,-1,1,a).id,new l([-r,r],[r-i,0,r,i])),s.set(d(e,0,1,a).id,new l([0,r],[0,0,r,i])),s.set(d(e,1,1,a).id,new l([r,r],[0,0,i,i])),s}let S=class extends Y{constructor(){super(...arguments),this.type="heatmap",this._tileKeyToFeatureSets=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])}async update(t,e){const s=e.schema.processors[0];s.type==="heatmap"&&z(this._schema,s)&&(t.mesh=!0,this._schema=s)}onTileUpdate(t){for(const e of t.removed)this._tileKeyToFeatureSets.delete(e.key.id)}onTileClear(t){const e={clear:!0};return this._tileKeyToFeatureSets.delete(t.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:e})}async onTileMessage(t,e,s){this._tileKeyToFeatureSets.has(t.key.id)||this._tileKeyToFeatureSets.set(t.key.id,new Map);const i=this._tileKeyToFeatureSets.get(t.key.id);if(H(e.addOrUpdate)&&e.addOrUpdate.hasFeatures&&i.set(e.addOrUpdate.instance,e),e.end){const r=[],a=X(t);this._tileKeyToFeatureSets.forEach((h,c)=>{if(c===t.key.id)h.forEach(f=>U(f.addOrUpdate,m=>r.push(m)));else if(a.has(c)){const f=a.get(c),[m,g]=f.offset;h.forEach(b=>U(b.addOrUpdate,u=>{const M=u.transform(m,g,1,1);r.push(M)}))}});const n=B(r,this._schema.mesh,512,512),p={tileKey:t.key.id,intensityInfo:n},y=[n.matrix];return this.remoteClient.invoke("tileRenderer.onTileData",p,E(K({},s),{transferList:y}))}}onTileError(t,e,s){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:t.id,error:e},s)}};S=V([q("esri.views.2d.layers.features.processors.HeatmapProcessor")],S);const re=S;export{re as default};
