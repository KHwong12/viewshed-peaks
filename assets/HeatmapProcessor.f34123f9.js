var D=Object.defineProperty,G=Object.defineProperties;var L=Object.getOwnPropertyDescriptors;var _=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var I=(t,e,r)=>e in t?D(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,K=(t,e)=>{for(var r in e||(e={}))P.call(e,r)&&I(t,r,e[r]);if(_)for(var r of _(e))V.call(e,r)&&I(t,r,e[r]);return t},E=(t,e)=>G(t,L(e));import{e as j,i as q,m as z,r as H,kX as C}from"./index.89a7b683.js";import{o as W}from"./definitions.9156fef2.js";import{p as X,l as d}from"./tileUtils.2e7f19fc.js";(()=>{if(!("document"in globalThis))return()=>null;const t=document.createElement("canvas"),e=t.getContext("2d"),r=512;return t.height=r,t.width=1,i=>{e.clearRect(0,0,1,t.height);const s=e.createLinearGradient(0,0,0,t.height);for(const{ratio:a,color:n}of i.colorStops)s.addColorStop(Math.max(a,.001),`rgba(${n[0]}, ${n[1]}, ${n[2]}, ${n[3]})`);return e.fillStyle=s,e.fillRect(0,0,1,t.height),e.getImageData(0,0,1,t.height).data}})();function Y(t,e,r,i){const{blurRadius:s,fieldOffset:a,field:n}=e,p=new Float64Array(r*i),y=B(s),h=Math.round(3*s);let c,u=Number.NEGATIVE_INFINITY;const m=J(n,a),g=new Set;for(const k of t){const f=k.getCursor();for(;f.next();){const M=f.getObjectId();if(g.has(M))continue;g.add(M);const o=f.readLegacyPointGeometry(),T=128;if(o.x<-T||o.x>=r+T||o.y<-T||o.y>i+T)continue;const O=+m(f),b=Math.round(o.x)-h,F=Math.round(o.y)-h,U=Math.max(0,b),$=Math.max(0,F),v=Math.min(i,Math.round(o.y)+h),R=Math.min(r,Math.round(o.x)+h);for(let w=$;w<v;w++){const A=y[w-F];for(let x=U;x<R;x++){const N=y[x-b];c=p[w*r+x]+=A*N*O,c>u&&(u=c)}}}}return{matrix:p.buffer,max:u}}function B(t){const e=Math.round(3*t),r=2*t*t,i=new Float64Array(2*e+1);for(let s=0;s<=i.length;s++)i[s]=Math.exp(-((s-e)**2)/r)/Math.sqrt(2*Math.PI)*(t/2);return i}function J(t,e){return t!=null?typeof e=="string"?r=>-1*+r.readAttribute(t):r=>+r.readAttribute(t)+e:r=>1}class l{constructor(e,r){this.offset=e,this.extent=r}}function Q(t){const e=t.key,r=new Map,i=256,s=W,a=t.tileInfoView.tileInfo.isWrappable;return r.set(d(e,-1,-1,a).id,new l([-s,-s],[s-i,s-i,s,s])),r.set(d(e,0,-1,a).id,new l([0,-s],[0,s-i,s,s])),r.set(d(e,1,-1,a).id,new l([s,-s],[0,s-i,i,s])),r.set(d(e,-1,0,a).id,new l([-s,0],[s-i,0,s,s])),r.set(d(e,1,0,a).id,new l([s,0],[0,0,i,s])),r.set(d(e,-1,1,a).id,new l([-s,s],[s-i,0,s,i])),r.set(d(e,0,1,a).id,new l([0,s],[0,0,s,i])),r.set(d(e,1,1,a).id,new l([s,s],[0,0,i,i])),r}let S=class extends X{constructor(){super(...arguments),this.type="heatmap",this._tileKeyToFeatureSets=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])}async update(t,e){const r=e.schema.processors[0];r.type==="heatmap"&&z(this._schema,r)&&(t.mesh=!0,this._schema=r)}onTileUpdate(t){for(const e of t.removed)this._tileKeyToFeatureSets.delete(e.key.id)}onTileClear(t){const e={clear:!0};return this._tileKeyToFeatureSets.delete(t.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:e})}async onTileMessage(t,e,r){this._tileKeyToFeatureSets.has(t.key.id)||this._tileKeyToFeatureSets.set(t.key.id,new Map);const i=this._tileKeyToFeatureSets.get(t.key.id);if(H(e.addOrUpdate)&&e.addOrUpdate.hasFeatures&&i.set(e.addOrUpdate.instance,e),e.end){const s=[],a=Q(t);this._tileKeyToFeatureSets.forEach((h,c)=>{if(c===t.key.id)h.forEach(u=>C(u.addOrUpdate,m=>s.push(m)));else if(a.has(c)){const u=a.get(c),[m,g]=u.offset;h.forEach(k=>C(k.addOrUpdate,f=>{const M=f.transform(m,g,1,1);s.push(M)}))}});const n=Y(s,this._schema.mesh,512,512),p={tileKey:t.key.id,intensityInfo:n},y=[n.matrix];return this.remoteClient.invoke("tileRenderer.onTileData",p,E(K({},r),{transferList:y}))}}onTileError(t,e,r){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:t.id,error:e},r)}};S=j([q("esri.views.2d.layers.features.processors.HeatmapProcessor")],S);const se=S;export{se as default};
