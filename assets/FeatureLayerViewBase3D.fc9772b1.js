var z=Object.defineProperty,J=Object.defineProperties;var H=Object.getOwnPropertyDescriptors;var N=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var P=(e,t,i)=>t in e?z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,m=(e,t)=>{for(var i in t||(t={}))K.call(t,i)&&P(e,i,t[i]);if(N)for(var i of N(t))W.call(t,i)&&P(e,i,t[i]);return e},g=(e,t)=>J(e,H(t));import{cz as T,f8 as X,h as Y,r as h,db as ee,e as a,d as l,i as w,p as q,t as G,f9 as te,V as re,bD as ie,fa as se,fb as k,f as B,Z as ae,fc as oe,cj as ne,fd as le,w as U,ak as I,cg as V,ch as D,fe as S,n as ue,aN as ce,aq as Q,ff as j,fg as he,fh as A,fi as de,fj as pe,fk as L,fl as E,x as O,fm as ye,bh as fe,bi as me,al as ge,fn as Fe,cl as we}from"./index.89a7b683.js";import{U as be,E as xe,S as ve,s as Ce}from"./EventedSet.0072de0a.js";import{d as R,t as Oe}from"./popupUtils.85d7881b.js";import{o as Z}from"./floorFilterUtils.1acb5b5d.js";import{i as _e}from"./RefreshableLayerView.567b5392.js";class qe{constructor(t){this._schedule=t,this._handle=new Ee(t)}destroy(){this._handle.destroy()}invoke(t,i){return t.buffer&&t.buffer.byteLength!==0?(t.options.sourceSpatialReference&&t.options.sourceSpatialReference instanceof T&&(t.options=g(m({},t.options),{sourceSpatialReference:t.options.sourceSpatialReference.toJSON()})),this._handle.invoke(t,i).then(r=>this._schedule(()=>{if(r.spatialReference=T.fromJSON(r.spatialReference),r.fields)for(let o=0;o<r.fields.length;o++)r.fields[o]=X.fromJSON(r.fields[o]);const s=r.spatialReference;for(const o of r.features)o.uid=Y.generateUID(),h(o.geometry)&&(o.geometry.spatialReference=s);return r}))):Promise.resolve(null)}}class Ee extends ee{constructor(t){super("PBFDecoderWorker","_parseFeatureQuery",t)}getTransferList(t){return[t.buffer]}}let F=class extends q{constructor(e){super(e)}get queryFeaturesDehydrated(){const e=this.layer.capabilities,t=e&&e.query;if(t&&t.supportsFormatPBF){var i,r;G(this._decoder)&&(this._decoder=new qe(this.schedule));const s={sourceSpatialReference:(i=(r=this.layer.spatialReference)==null?void 0:r.toJSON())!=null?i:null,applyTransform:!0,maxStringAttributeLength:1024};return(o,n)=>te(this.layer.parsedUrl,o,"pbf",this._createRequestOptions(n)).then(u=>(re(n),h(this._decoder)?this._decoder.invoke({buffer:u.data,options:s},n.signal):Promise.reject(ie())))}return(s,o)=>se(this.layer.parsedUrl,s,this.layer.spatialReference,this._createRequestOptions(o)).then(n=>k(n.data))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}destroy(){this._decoder=B(this._decoder)}_createRequestOptions(e){return g(m({},e),{query:m(g(m({},this.layer.customParameters),{token:this.layer.apiKey}),e==null?void 0:e.query)})}};a([l({constructOnly:!0})],F.prototype,"layer",void 0),a([l({constructOnly:!0})],F.prototype,"schedule",void 0),a([l({readOnly:!0})],F.prototype,"queryFeaturesDehydrated",null),F=a([w("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],F);let x=class extends q{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};a([l({constructOnly:!0})],x.prototype,"layer",void 0),a([l({readOnly:!0})],x.prototype,"queryFeaturesDehydrated",null),x=a([w("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],x);let _=class extends q{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}};a([l({constructOnly:!0})],_.prototype,"layer",void 0),_=a([w("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],_);let v=class extends q{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.source.queryFeaturesJSON(e,t).then(k,i=>{if(i&&i.name==="query-features-json:unsupported")return this.layer.queryFeatures(e,t);throw i})}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};function Re(e,t){return e.type==="feature"&&e.source.type==="feature-layer"?h(e.infoFor3D)?new x({layer:e}):new F({layer:e,schedule:t}):e.type==="feature"&&e.source.type==="memory"||e.type==="csv"||e.type==="geojson"||e.type==="wfs"?new v({layer:e,source:e.source}):e.type==="ogc-feature"?new _({layer:e}):null}a([l({constructOnly:!0})],v.prototype,"layer",void 0),a([l({constructOnly:!0})],v.prototype,"source",void 0),v=a([w("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],v);class Me{constructor(t){this._memoryCache=null,this._capabilities=null;const i=t.layerView.layer;this.layerView=t.layerView,this.objectIdField=i.objectIdField,this.globalIdField="globalIdField"in i?i.globalIdField:null,this.returnZ=t.returnZ,this.returnM=t.returnM;const r=this.layerView.view.resourceController;this.query=Re(i,s=>r.schedule(s)),r&&this.memoryCacheEnabled&&(this._memoryCache=r.memoryController.newCache(i.uid))}get memoryCacheEnabled(){switch(this.layerView.layer.source.type){case"feature-layer":case"ogc-feature":return!0;case"csv":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=B(this._memoryCache),this.query.destroy()}createQuery(){const t=this.layerView.layer.createQuery();return t.outFields=this.layerView.availableFields,t.returnZ=this.returnZ,t.returnM=this.returnM,t.outSpatialReference=this.tilingScheme.spatialReference,t}get memoryCache(){return this._memoryCache}get viewingMode(){return this.layerView.view.state.viewingMode}get tilingScheme(){return this.layerView.view.featureTiles.tilingScheme}get scheduler(){const t=this.layerView.view.resourceController;return t?t.scheduler:null}get geometryType(){return this.layerView.layer.geometryType}get fullExtent(){return this.layerView.layer.fullExtent}get tileMaxRecordCount(){return this.layerView.layer.capabilities.query.tileMaxRecordCount}get maxRecordCount(){return this.layerView.layer.capabilities.query.maxRecordCount}get capabilities(){return h(this._capabilities)||(this._capabilities=be(this.layerView.layer)),this._capabilities}logFetchError(t,i){t.error("#fetchTile()",this.layerView.layer,i&&i.message?i.message:i)}}const C=ae.getLogger("esri.views.layers.FeatureLayerView"),$e=e=>{let t=class extends e{constructor(...i){super(...i),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){U(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","featureEffect","layer.timeInfo","layer.floorInfo","timeExtent"],()=>this._handleRequiredFieldsChange(),!0),I(this,"view.floors","change",()=>this._handleRequiredFieldsChange()),I(this,"layer.sublayer","change",()=>this._handleRequiredFieldsChange())}get availableFields(){const{layer:i,layer:{fieldsIndex:r},requiredFields:s}=this;return"outFields"in i&&i.outFields?V(r,[...D(r,i.outFields),...s]):V(r,s)}set effect(i){S(C,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect=i}get effect(){return S(C,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(i){i!==void 0?this._override("featureEffect",i):this._clearOverride("featureEffect")}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(i){C.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(i){throw new Error("missing implementation")}createQuery(){const i={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},r=h(this.filter)?this.filter.createQuery(i):new ue(i);if(this.layer.type==="feature"){const s=Z(this);h(s)&&(r.where=r.where?`(${r.where}) AND (${s})`:s)}return h(this.timeExtent)&&(r.timeExtent=h(r.timeExtent)?r.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),r}queryFeatures(i,r){throw new Error("missing implementation")}queryObjectIds(i,r){throw new Error("missing implementation")}queryFeatureCount(i,r){throw new Error("missing implementation")}queryExtent(i,r){throw new Error("missing implementation")}async fetchPopupFeatures(i,r){const s=this.validateFetchPopupFeatures(r);if(s)throw s;return this.fetchClientPopupFeatures(r)}_loadArcadeModules(i){if(i.get("expressionInfos.length")||Array.isArray(i.content)&&i.content.some(r=>r.type==="expression"))return ce()}_handleRequiredFieldsChange(){const i=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",i),i.then(()=>{this._updatingRequiredFieldsPromise===i&&this._set("_updatingRequiredFieldsPromise",null)})}async _updateRequiredFields(){if(!this.layer||!this.view)return;const i=this.view.type==="3d",{layer:r,layer:{fieldsIndex:s,objectIdField:o}}=this,n="renderer"in r&&r.renderer,u="orderBy"in r&&r.orderBy,d=r.featureReduction,c=new Set,b=await Q([n?n.collectRequiredFields(c,s):null,j(c,r),i?he(c,r):null,h(this.filter)?A(c,r,this.filter):null,h(this.featureEffect)?A(c,r,this.featureEffect.filter):null,d?de(c,r,d):null,u?pe(c,r,u):null]);if(r.timeInfo&&this.timeExtent&&L(c,r.fieldsIndex,[r.timeInfo.startField,r.timeInfo.endField]),r.type==="feature"&&r.floorInfo&&L(c,r.fieldsIndex,[r.floorInfo.floorField]),r.type==="subtype-group"){E(c,s,r.subtypeField);const y=r.sublayers.map(M=>{var $;return Promise.all([($=M.renderer)==null?void 0:$.collectRequiredFields(c,s),j(c,M)])});await Q(y)}for(const y of b)y.error&&C.error(y.error);E(c,s,o),i&&"displayField"in r&&r.displayField&&E(c,s,r.displayField);const f=Array.from(c).sort();this._set("requiredFields",f)}validateFetchPopupFeatures(i){if(G(i))return null;for(const r of i.clientGraphics){const s=r.layer;if("popupEnabled"in s&&!s.popupEnabled)return new O("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if("popupTemplate"in s&&!R(s,i))return new O("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s});if(r.isAggregate&&!(s.featureReduction&&"popupTemplate"in s.featureReduction&&s.featureReduction.popupEnabled&&s.featureReduction.popupTemplate))return new O("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}}async fetchClientPopupFeatures(i){const r=h(i)?i.clientGraphics:null;if(!r||r.length===0)return[];const s=new Array(r.length),o=new Map,n=await this.createPopupQuery(i);for(let u=0;u<r.length;u++){const d=r[u];if(d.isAggregate){s[u]=d;continue}const{layer:c}=d;if(!("popupEnabled"in c))continue;const b=D(this.layer.fieldsIndex,n.outFields),f=R(c,i);if(!h(f))continue;const y=await this._loadArcadeModules(f);y&&y.arcadeUtils.hasGeometryOperations(f)||!ye(b,d)?o.set(d.getObjectId(),u):s[u]=d}if(this.layer.type==="stream"||o.size===0)return s.filter(Boolean);n.objectIds=Array.from(o.keys());try{const u=await this.layer.queryFeatures(n);for(const d of u.features)s[o.get(d.getObjectId())]=d}catch{}return s.filter(Boolean)}async createPopupQuery(i){const r=this.layer.createQuery(),s=new Set;let o=!1;const n=h(i)&&i.clientGraphics?i.clientGraphics.map(u=>u.layer):[this.layer];for(const u of n){if(!("popupEnabled"in u))continue;const d=R(u,i);if(!h(d))continue;const c=await this._loadArcadeModules(d),b=c&&c.arcadeUtils.hasGeometryOperations(d);o=!(this.layer.geometryType!=="point"&&!b);const f=await Oe(this.layer,d);for(const y of f)s.add(y)}if(r.returnGeometry=o,r.returnZ=o,r.returnM=o,r.outFields=Array.from(s),r.outSpatialReference=this.view.spatialReference,this.layer.type==="feature"){const u=Z(this);h(u)&&(r.where=r.where?`(${r.where}) AND (${u})`:u)}return r}canResume(){return!!super.canResume()&&(!h(this.timeExtent)||!this.timeExtent.isEmpty)}};return a([l()],t.prototype,"_updatingRequiredFieldsPromise",void 0),a([l({readOnly:!0})],t.prototype,"availableFields",null),a([l()],t.prototype,"effect",null),a([l({type:oe})],t.prototype,"featureEffect",null),a([l({type:ne})],t.prototype,"filter",void 0),a([l(le)],t.prototype,"timeExtent",void 0),a([l()],t.prototype,"layer",void 0),a([l({type:Number})],t.prototype,"maximumNumberOfFeatures",null),a([l({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),a([l({readOnly:!0})],t.prototype,"requiredFields",void 0),a([l()],t.prototype,"suspended",void 0),a([l()],t.prototype,"view",void 0),t=a([w("esri.views.layers.FeatureLayerView")],t),t};let p=class extends _e(xe($e(fe(me)))){constructor(e){super(e),this._controllerTotal=0,this._graphicsCoreTotal=0,this.suspendResumeExtentMode="data"}initialize(){this.updatingHandles.add(this,"view.floors",()=>this.graphics3d.filterVisibility.filterChanged())}destroy(){this.fetcherContext&&(this.fetcherContext.destroy(),this.fetcherContext=null)}get maximumNumberOfFeatures(){var e,t;return(e=(t=this.controller)==null?void 0:t.maximumNumberOfFeatures)!=null?e:this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(e){this._set("maximumNumberOfFeatures",e),this.controller&&(this.controller.maximumNumberOfFeatures=e)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){var e,t,i;let r=0;if((e=this.controller)!=null&&e.updating){const o=this.controller.updatingRemaining,n=Math.max(this.controller.updatingTotal,this._controllerTotal);n>0&&(r=(n-o)/n,this._controllerTotal=n)}let s=0;if((t=this.graphics3d)!=null&&(i=t.graphicsCore)!=null&&i.updating){const o=this.graphics3d.graphicsCore.updatingRemaining,n=Math.max(o,this._graphicsCoreTotal);n>0&&(s=(n-o)/n,this._graphicsCoreTotal=n)}return .5*(r+s)}get updatePolicy(){if(!this.controller)return 0;switch(this.controller.mode){case"snapshot":{const e=Ne[this.layer.geometryType];return e==null||this.controller.serviceDataCount>e?0:1}case"tiles":return 0}}get hasZ(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&e.returnZ!=null?e.returnZ:t.supportsZ)}get hasM(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&"returnM"in e&&e.returnM!=null&&e.returnM}setVisibility(e,t){this.graphics3d&&this.graphics3d.graphicsCore.setObjectIdVisibility(e,t)}createQuery(){return super.createQuery()}queryFeatures(e,t){const i=()=>super.queryFeatures(e,t);return this.layer.geometryType==="mesh"?this._queryFeaturesMesh(this._ensureQuery(e),i):i()}beforeSetController(e){e.maximumNumberOfFeatures=this.maximumNumberOfFeatures}createController(){this.fetcherContext=new Me({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const e=new ve({layerView:this,context:this.fetcherContext,graphics:new Ce,extent:this.clippingExtent});return this.updatingHandles.add(e,"serviceDataExtent",t=>{this.graphics3d&&(this.graphics3d.dataExtent=t)},2),this.handles.add(U(this,"suspended",t=>{t?e.suspend():e.resume()},!0)),this.updatingHandles.add(this.graphics3d.graphicsCore,"displayFeatureLimit",()=>this.updateDisplayFeatureLimit(e),2),this.handles.add([this.view.resourceController.memoryController.events.on("quality-changed",()=>this.updateDisplayFeatureLimit()),ge(this,"updating",()=>{this._controllerTotal=0,this._graphicsCoreTotal=0,this.notifyChange("updatingProgressValue")})]),e}async doRefresh(e){e&&!this.suspended&&this.controller&&this.controller.refetch(),this.graphics3d.filterVisibility.dirty=!0}getUsedMemory(){const e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.usedMemory:0)+(this.controller?this.controller.memoryForUnusedFeatures:0)}getUnloadedMemory(){const e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.unprocessedMemoryEstimate:0)+(this.controller?this.controller.expectedFeatureDiff*e.usedMemoryPerGraphic:0)}ignoresMemoryFactor(){return this.controller&&this.controller.hasMaximumNumberOfFeaturesOverride}updateDisplayFeatureLimit(e=this.controller){if(!e||!this.graphics3d||!this.graphics3d.graphicsCore)return;const t=this.graphics3d.graphicsCore.displayFeatureLimit,i=this.view.resourceController.memoryController.memoryFactor;if(i===1)e.displayFeatureLimit=t;else{const r=Math.ceil(t.maximumNumberOfFeatures*i),s=Math.ceil(t.maximumTotalNumberOfFeatures*i),o=Math.ceil(t.minimumTotalNumberOfFeatures*i);e.displayFeatureLimit=g(m({},t),{maximumNumberOfFeatures:r,maximumTotalNumberOfFeatures:s,minimumTotalNumberOfFeatures:o})}}async _queryFeaturesMesh(e,t){await this._validateQueryFeaturesMesh(e);const i=await t();if(e&&e.outStatistics)return i;const r=this.layer.objectIdField,s=this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID,o=[];for(const n of i.features)if(n.geometry){const u=s.get(n.attributes[r]);u&&(n.geometry=Fe(u.graphic.geometry),o.push(n))}else o.push(n);return i.features=o,i}async _validateQueryFeaturesMesh(e){if(!e)return;const t=r=>{throw new O("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${r}'`)},i=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const r of i)e[r]!=null&&t(r);"returnM"in e&&e.returnM&&t("returnM"),"returnCentroid"in e&&e.returnCentroid&&t("returnCentroid"),h(e.outSpatialReference)&&!e.outSpatialReference.equals(this.view.spatialReference)&&t("outSpatialReference")}get performanceInfo(){const e=this.controller&&this.controller.displayFeatureLimit,t=h(e)&&e.averageSymbolComplexity,i=h(t)?`f:${t.primitivesPerFeature},v:${t.primitivesPerCoordinate}`:"n/a",r=g(m({},this._getResourceInfo()),{storedFeatures:0,totalVertices:0,partial:this.maximumNumberOfFeaturesExceeded,mode:this.controller?this.controller.mode:"n/a",symbolComplexity:i,nodes:this.controller?this.controller.tileDescriptors.length:0});if(this.controller&&r.displayedNumberOfFeatures){const s=this.controller.debug;r.storedFeatures=s.storedFeatures,r.totalVertices=s.totalVertices}return r}get test(){return{updatePolicy:this.updatePolicy,controller:this.controller}}};a([l()],p.prototype,"layer",void 0),a([l()],p.prototype,"controller",void 0),a([l()],p.prototype,"maximumNumberOfFeatures",null),a([l()],p.prototype,"maximumNumberOfFeaturesExceeded",null),a([l(we)],p.prototype,"updatingProgress",void 0),a([l({readOnly:!0,dependsOn:["controller.updatingRemaining","controller.updatingTotal","graphics3d.graphicsCore.updatingRemaining"]})],p.prototype,"updatingProgressValue",null),a([l({readOnly:!0})],p.prototype,"updatePolicy",null),a([l({readOnly:!0})],p.prototype,"hasZ",null),a([l({readOnly:!0})],p.prototype,"hasM",null),a([l()],p.prototype,"suspendResumeExtentMode",void 0),p=a([w("esri.views.3d.layers.FeatureLayerViewBase3D")],p);const Ne={point:5e3,polygon:500,polyline:1e3},Qe=p;export{Qe as x};
