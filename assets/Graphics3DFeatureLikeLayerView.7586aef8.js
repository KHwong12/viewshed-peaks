import{e as r,d as n,i as b,p as w,n as C,aa as Q,dH as _,t as m,fE as F,Z as q,u as I,r as d,an as E,ak as T,cj as j,g as k,l as U,m as x,fF as V,h as v,w as g,fG as N,eo as A,bI as G,F as J,q as $}from"./index.89a7b683.js";import{y as M,I as L}from"./Graphics3DScaleVisibility.bc09a75c.js";import{d as D,s as P}from"./Graphics3DObjectStates.53e927e5.js";import{L as Z}from"./QueryEngine.23601ed8.js";import{o as z}from"./floorFilterUtils.1acb5b5d.js";import{c as B}from"./Graphics3DFrustumVisibility.d6305daa.js";import{n as S}from"./attributeUtils.a1b96ab7.js";const H=Z;let h=class extends w{constructor(e){super(e),this._dataQueryEngineInstance=null}get queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new C({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this.ensureDataQueryEngine()}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t){return this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e),t)}async executeQueryForCount(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:i,extent:s}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:i,extent:Q.fromJSON(s)}}async executeQueryForIds(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const i=await this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),s=_.fromJSON(i);return s.features.forEach(a=>{a.layer=this.layer,a.sourceLayer=this.layer}),s}async executeQuery(e,t){const i=await this.dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),s=_.fromJSON(i);return s.features.forEach(a=>{a.layer=this.layer,a.sourceLayer=this.layer}),s}_ensureQueryJSON(e){return m(e)?this.defaultQueryJSON:("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),e.toJSON())}ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,t=this.layer.objectIdField,i=F.toJSON(this.queryGeometryType),s=this.layer.fields.map(R=>R.toJSON()),a=this.layerView.view.resourceController.scheduler,u=this.priority,c=this.spatialReference.toJSON(),p=this.layerView.graphics3d.graphicsCore.featureStore,{hasZ:y,hasM:O}=this.layerView;return this._dataQueryEngineInstance=new H({hasZ:y,hasM:O,geometryType:i,fields:s,timeInfo:e,spatialReference:c,objectIdField:t,featureStore:p,scheduler:a,priority:u}),this._dataQueryEngineInstance}};r([n({constructOnly:!0})],h.prototype,"layerView",void 0),r([n({constructOnly:!0})],h.prototype,"priority",void 0),r([n({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],h.prototype,"spatialReference",void 0),r([n({readOnly:!0,aliasOf:"layerView.layer"})],h.prototype,"layer",void 0),r([n({readOnly:!0})],h.prototype,"queryGeometryType",null),r([n({readOnly:!0})],h.prototype,"defaultQueryJSON",null),h=r([b("esri.views.3d.layers.graphics.QueryEngine")],h);const Y=h,K=q.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");let o=class extends w{constructor(...e){super(...e),this._dirty=!1,this._querying=!1,this._handles=new I}get updating(){return this._dirty||this._querying||d(this._queryResult)}setup(e,t){this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,this._queryEngine=new Y({layerView:this._layerView,priority:E.FILTER_VISIBILITY});const i=this._layerView.view.resourceController.scheduler;this._handles.add(i.registerTask(E.FILTER_VISIBILITY,this)),this._handles.add(T(t.owner,"loadedGraphics","after-changes",s=>this._graphicsChanged(s),()=>this.dirty=!0)),this.filterChanged()}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities(e=>e.clearVisibilityFlag(2)),this._queryResult=null,this._querying=!1),this.dirty=!1}_graphicsChanged(e){this._queryEngine&&(1&e.type)==0||(this.dirty=!0)}updateVisibility(e){this.active&&(e.hasVisibilityFlag(2,0)||e.setVisibilityFlag(2,!1,0),this.dirty=!0)}filterChanged(){const e=this.recomputeFilter();e!==this._filter&&(this._filter=e,this.dirty=!0)}get active(){return this._filter&&this._core.graphics3DGraphics.size>0}recomputeFilter(){const e="filter"in this._layerView?this._layerView.filter:null,t="timeExtent"in this._layerView?this._layerView.timeExtent:null,i=z(this._layerView);if(m(t)&&m(i))return e;const s=d(e)?e.clone():new j;if(d(t)&&(s.timeExtent=d(s.timeExtent)?s.timeExtent.intersection(t):t),d(i)){const a=s.where==null||s.where==="";s.where=a?i:`(${s.where}) AND (${i})`}return s}get running(){return this._dirty&&!this._querying||d(this._queryResult)}runTask(e){if(!this.active)return void this.clear();!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._filter).then(i=>{this._queryResult=i,this._querying=!1}).catch(i=>{if(!k(i)){K.warn("FeatureFilter query failed: "+i,{error:i});const s=new Set;this._core.graphics3DGraphics.forEach(a=>s.add(this._getFeatureId(a.graphic))),this._queryResult=s,this._querying=!1}}),e.madeProgress());const t=this._queryResult;d(t)&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities(i=>{if(e.done)return!1;const s=t.has(this._getFeatureId(i.graphic));return!!i.setVisibilityFlag(2,s,0)&&(e.madeProgress(),!0)}),e.done||(this._queryResult=null))}_getFeatureId(e){return e.objectId==null?e.attributes[this._objectIdField]:e.objectId}set dirty(e){this._dirty=e}};r([n({readOnly:!0})],o.prototype,"updating",null),r([n({readOnly:!0})],o.prototype,"running",null),r([n()],o.prototype,"_dirty",void 0),r([n()],o.prototype,"_querying",void 0),r([n()],o.prototype,"_queryResult",void 0),o=r([b("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],o);let l=class extends w{constructor(e){super(e),this._handles=new I,this.watchUpdatingTracking=new U,this.suspendResumeExtentMode="computed",this.dataExtent=null,this.suspendResumeExtent=null}get suspended(){var e;return(e=this.scaleVisibility)==null?void 0:e.suspended}get suspendInfo(){var e,t;const i={};return(e=this.scaleVisibility)!=null&&e.suspended&&(i.outsideScaleRange=!0),(t=this.frustumVisibility)!=null&&t.suspended&&(i.outsideOfView=!0),i}get updating(){var e,t,i;return!!((e=this.graphicsCore)!=null&&e.updating||(t=this.frustumVisibility)!=null&&t.updating||(i=this.watchUpdatingTracking)!=null&&i.updating)}normalizeCtorArgs(e){const t=e.frustumVisibilityEnabled?new B:null,i=e.scaleVisibilityEnabled?new M:null,s=(e.filterVisibilityEnabled||e.timeExtentVisibilityEnabled)&&e.layer.geometryType!=="multipatch"?new o:null,a=e.elevationAlignmentEnabled?new D:null,u=new L({owner:e.owner,layer:e.layer,preferredUpdatePolicy:e.preferredUpdatePolicy,elevationFeatureExpressionEnabled:e.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.owner.hasZ,hasM:e.owner.hasM}),{updateClippingExtent:c,suspendResumeExtentMode:p,dataExtent:y}=e;return{graphicsCore:u,frustumVisibility:t,scaleVisibility:i,filterVisibility:s,elevationAlignment:a,updateClippingExtent:c,suspendResumeExtentMode:p,dataExtent:y}}initialize(){this.scaleVisibility&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",()=>this.scaleVisibility.layerMinMaxScaleChangeHandler()),this.filterVisibility&&(this.watchUpdatingTracking.add(this.owner,"filter",()=>this.filterVisibility.filterChanged()),this.watchUpdatingTracking.add(this.owner,"timeExtent",()=>this.filterVisibility.filterChanged())),this.elevationAlignment&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",(e,t)=>{x(e,t)&&this.watchUpdatingTracking.addPromise(this.graphicsCore.elevationInfoChange())}),this.watchUpdatingTracking.add(this.layer,"labelsVisible",()=>this.graphicsCore.updateVisibilityInfo()),this.watchUpdatingTracking.add(this.layer,"labelingInfo",(e,t)=>{x(e,t)&&this.graphicsCore.updateLabelingInfo()})}async setup(){this.frustumVisibility&&this.frustumVisibility.setup(this.owner);const e=this.owner,t=this.owner.view.basemapTerrain,i=(s,a,u)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(s,a,u);if(this.scaleVisibility&&this.scaleVisibility.setup(e,this.layer,i,this.graphicsCore,t),this.filterVisibility&&("filter"in e||"timeExtent"in e)&&this.filterVisibility.setup(e,this.graphicsCore),this.elevationAlignment){const s=e.view.elevationProvider;this.elevationAlignment.setup(e,i,this.graphicsCore,s)}this._set("objectStates",new P(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",e.view.deconflictor.addGraphicsOwner(this.graphicsCore)),await V(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates})),this.watchUpdatingTracking.add(this.layer,"renderer",s=>this.watchUpdatingTracking.addPromise(this.graphicsCore.rendererChange(s))),this.watchUpdatingTracking.add(e,"fullOpacity",()=>this.graphicsCore.opacityChange()),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this.watchUpdatingTracking.add(e.view,"clippingArea",()=>this._updateClippingExtent()),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await V(this.graphicsCore.updateLabelingInfo())}destroy(){this._handles&&(this._handles.destroy(),this._handles=null);const e=["watchUpdatingTracking","frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","objectStates","graphicsCore"];for(const t of e){const i=this[t];i&&(i.destroy(),this._set(t,null))}this._set("layer",null),this._set("owner",null)}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(1,null);return this.objectStates.setUid(t,e.uid),i}highlight(e,t){if(e instanceof C){const{set:i,handle:s}=this.objectStates.acquireSet(0,t);return this.owner.queryObjectIds(e).then(a=>this.objectStates.setObjectIds(i,a)),s}if(typeof e=="number"||typeof e=="string")return this.highlight([e],t);if(e instanceof v)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof v){const i=e;if(S(this.layer.fieldsIndex,i[0].attributes,t)==null){const s=i.map(c=>c.uid),{set:a,handle:u}=this.objectStates.acquireSet(0,null);return this.objectStates.setUids(a,s),u}e=i.map(s=>S(this.layer.fieldsIndex,s.attributes,t))}if(typeof e[0]=="number"||typeof e[0]=="string"){const i=e,{set:s,handle:a}=this.objectStates.acquireSet(0,t);return this.objectStates.setObjectIds(s,i),a}}return W}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(g(this,"suspendResumeExtentMode",()=>{switch(this._handles.remove(f),this.suspendResumeExtentMode){case"computed":this._handles.add([g(this.graphicsCore,"computedExtent",e=>this.updateSuspendResumeExtent(e)),this.graphicsCore.watch("extentPadding",()=>this.updateSuspendResumeExtent(this.graphicsCore.computedExtent))],f);break;case"data":this._handles.add([g(this,"dataExtent",e=>this.updateSuspendResumeExtent(e)),this.graphicsCore.watch("extentPadding",()=>this.updateSuspendResumeExtent(this.dataExtent))],f);break;default:N(this.suspendResumeExtentMode)}}))}updateSuspendResumeExtent(e){e?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(e,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null)}extentToSuspendResumeRect(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!A(e,i))return;e=G(e,i)}return J(e,t,$,this.graphicsCore.extentPadding)}suspendResumeExtentChanged(e){this.frustumVisibility&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e)}};r([n({aliasOf:"graphicsCore.layer"})],l.prototype,"layer",void 0),r([n({aliasOf:"graphicsCore.owner"})],l.prototype,"owner",void 0),r([n({constructOnly:!0})],l.prototype,"updateClippingExtent",void 0),r([n({constructOnly:!0})],l.prototype,"graphicsCore",void 0),r([n({constructOnly:!0})],l.prototype,"scaleVisibility",void 0),r([n({constructOnly:!0})],l.prototype,"filterVisibility",void 0),r([n({constructOnly:!0})],l.prototype,"elevationAlignment",void 0),r([n({constructOnly:!0})],l.prototype,"frustumVisibility",void 0),r([n({readOnly:!0})],l.prototype,"deconfliction",void 0),r([n({readOnly:!0})],l.prototype,"labeling",void 0),r([n({readOnly:!0})],l.prototype,"objectStates",void 0),r([n({readOnly:!0})],l.prototype,"watchUpdatingTracking",void 0),r([n()],l.prototype,"suspendResumeExtentMode",void 0),r([n()],l.prototype,"dataExtent",void 0),r([n({readOnly:!0})],l.prototype,"suspended",null),r([n({readOnly:!0})],l.prototype,"suspendInfo",null),r([n({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating","watchUpdatingTracking.updating"]})],l.prototype,"updating",null),l=r([b("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],l);const ae=l,f="suspendResumeExtentMode",W={remove(){},pause(){},resume(){}};export{Y as p,ae as v};
