var U=Object.defineProperty,W=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var k=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var P=(t,e,a)=>e in t?U(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a,y=(t,e)=>{for(var a in e||(e={}))k.call(e,a)&&P(t,a,e[a]);if(O)for(var a of O(e))Z.call(e,a)&&P(t,a,e[a]);return t},T=(t,e)=>W(t,j(e));import{bl as b,bm as _,bn as N,bo as Q,bp as J,bq as K,br as X,bs as Y,bt as ee,bu as te,bv as ae,bw as ie,bx as se,Z as F,bh as re,bi as ne,by as oe,g as E,t as D,bz as le,aQ as $,aq as he,aa as G,bA as ue,bB as ce,bC as de,bk as me,bD as L,aV as R,bE as ge,r as H,bF as pe,U as fe,V as z,bG as ye,bH as xe,aw as we,e as x,d as w,i as be}from"./index.89a7b683.js";import{l as _e}from"./projectExtentUtils.c2292b8f.js";import{O as ve,E as Se}from"./ImageMaterialTechnique.971b25d8.js";import{i as Ce}from"./RefreshableLayerView.567b5392.js";function Ee(t,e,a){const s=b(t)/_(t),i={width:a,height:a};return s>1.0001?i.height=a/s:s<.9999&&(i.width=a*s),i.width=Math.round(i.width/(b(t)/b(e))),i.height=Math.round(i.height/(_(t)/_(e))),i}function V(t){return N.createSquareGeometry([[t[0],t[1],-1],[t[2],t[1],-1],[t[2],t[3],-1],[t[0],t[3],-1]])}function Re(t,e){if(!Q(t,e))return V(e);const a=[t[1]-e[1],Math.min(t[3],e[3])-Math.max(t[1],e[1]),e[3]-t[3],123456],s=[t[0]-e[0],Math.min(t[2],e[2])-Math.max(t[0],e[0]),e[2]-t[2],123456],i=e[2]-e[0],o=e[3]-e[1],n=s[0]>0&&s[2]>0?3:2,r=a[0]>0&&a[2]>0?3:2,u=(r+1)*(n+1),l=new Float64Array(3*u),c=new Float32Array(2*u),h=new Uint32Array(6*(r*n-1));let v=0,S=0,I=0,d=0,g=0;for(let p=0;p<4;p++){const M=a[p];if(M<=0)continue;let C=0;for(let f=0;f<4;f++){const q=s[f];q<=0||(l[S++]=e[0]+C,l[S++]=e[1]+v,l[S++]=-1,c[I++]=C/i,c[I++]=v/o,f<3&&p<3&&(f!==1||p!==1)&&(h[g++]=d,h[g++]=d+1,h[g++]=d+n+1,h[g++]=d+1,h[g++]=d+n+2,h[g++]=d+n+1),d++,C+=q)}v+=M}const B=new Uint32Array(h.length);return new J([["position",{size:3,data:l,exclusive:!0}],["normal",{size:3,data:Ae,exclusive:!0}],["uv0",{size:2,data:c,exclusive:!0}]],[["position",h],["normal",B],["uv0",h]])}const Ae=[0,0,1];class $e extends K{constructor(e){super(e,Me),this.supportsEdges=!0,this.techniqueConfig=new ve}getTechniqueConfig(e,a){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparencyPassType=a.transparencyPassType,this.techniqueConfig.enableOffset=a.camera.relativeElevation<X,this.techniqueConfig.multipassTerrainEnabled=a.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=a.cullAboveGround,this.techniqueConfig}intersect(e,a,s,i,o,n,r){Y(e,a,i,o,n,void 0,r)}requiresSlot(e,a){return e===20?!0:ee(a)===4?e===2:e===(this.parameters.transparent?this.parameters.writeDepth?4:7:2)}createGLMaterial(e){return e.output===0||e.output===7||e.output===4?new Ie(e):void 0}createBufferWriter(){return new te(ae)}}class Ie extends ie{constructor(e){super(y(y({},e),e.material.parameters))}updateParameters(e){const a=this._material.parameters;return this.updateTexture(a.textureId),this.ensureTechnique(Se,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&(this._material.setParameters({sceneHasOcludees:e.hasOccludees}),this.updateParameters(e))}beginSlot(e){return this._output!==0&&this._output!==7||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,a){this.bindTextures(a.program),this.bindTextureScale(a.program),a.bindPass(this._material.parameters,e)}}const Me=y({transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,opacity:1,textureId:null,initTextureTransparent:!0},se),A=F.getLogger("esri.views.3d.layers.DynamicLayerView3D");let m=class extends Ce(re(ne)){constructor(){super(...arguments),this.drapeSourceType=0,this.updatePolicy=1,this.fullExtentInLocalViewSpatialReference=null,this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlays=new Array,this.updateWhenStationary=!0,this.refreshDebounced=oe(async t=>{this.destroyed||await this._doRefresh(t).catch(e=>{E(e)||F.getLogger(this.declaredClass).error(e)})},2e3)}initialize(){this.addResolvingPromise(_e(this).then(t=>this._set("fullExtentInLocalViewSpatialReference",t))),this.updatingHandles.add(this,"suspended",()=>this._suspendedChangeHandler()),this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")},()=>{})),this._isScaleRangeLayer()&&this.updatingHandles.add(this.layer,"scaleRangeId",()=>this.notifyChange("suspended"))}destroy(){this.clear()}setDrapingExtent(t,e){this._spatialReference=e,t.forEach(a=>{this._overlays[a.index]=a,this._updateImageExtent(a)})}_updateImageExtent(t){const e=this._clippedExtent(t.extent,qe);if(D(e))return;const a=Ee(t.extent,e,t.resolution);let s=t.pixelRatio*this.view.pixelRatio;if("imageMaxWidth"in this.layer||"imageMaxHeight"in this.layer){const o=this.layer.imageMaxWidth,n=this.layer.imageMaxHeight;if(a.width>o){const r=o/a.width;a.height=Math.floor(a.height*r),a.width=o,s*=r}if(a.height>n){const r=n/a.height;a.width=Math.floor(a.width*r),a.height=n,s*=r}}const i=this._extents[t.index];i&&le(i.extent,e)&&this._imageSizeEquals(e,i.imageSize,a)||(this._extents[t.index]={extent:$(e),imageSize:a,pixelRatio:s},this.suspended||this._fetch(t.index).catch(o=>{E(o)||A.error(o)}))}clear(){for(let t=0;t<this._images.length;t++)this._clearImage(t)}async doRefresh(){return this._doRefresh()}async _doRefresh(t){if(this.suspended)return;const e=[];for(let a=0;a<this._extents.length;a++)this._extents[a]&&e.push(this._fetch(a,t));await he(e)}canResume(){if(!super.canResume())return!1;if(this._isScaleRangeLayer()){const{minScale:t,maxScale:e}=this.layer;if(t>0||e>0){const a=this.view.scale;if(a<e||t>0&&a>t)return!1}}return!0}isUpdating(){return this._images.some(t=>!!t.loadingPromise)}async processResult(t,e,a){(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(t.image=e)}findExtentInfoAt(t){for(const e of this._extents){const a=e.extent;if(new G(a[0],a[1],a[2],a[3],this._spatialReference).contains(t))return e}return null}getFetchOptions(){}async redraw(t,e){await ue(this._images,async(a,s)=>{a&&(await t(a,e),await this._createStageObjects(s,a.image,e))})}_imageSizeEquals(t,e,a){if(!this.maximumDataResolution)return!1;const s=b(t)/this.maximumDataResolution.x,i=_(t)/this.maximumDataResolution.y,o=s/e.width,n=i/e.height,r=s/a.width,u=i/a.height,l=Math.abs(o-r),c=Math.abs(n-u),h=ce.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return l<=h&&c<=h}async _fetch(t,e){if(this.suspended)return;const a=this._extents[t],s=a.extent;this._images[t]||(this._images[t]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:$(s)});const i=this._images[t];i.loadingAbortController&&(i.loadingAbortController.abort(),i.loadingAbortController=null);const o=new G(s[0],s[1],s[2],s[3],this._spatialReference);if(o.width===0||o.height===0)return void this._clearImage(t);const n=new AbortController;i.loadingAbortController=n,de(e,()=>n.abort());const r=n.signal,u=this._waitFetchReady(r).then(()=>{const l=T(y({requestAsImageElement:!0,pixelRatio:this._overlays[t].pixelRatio},this.getFetchOptions()),{signal:r}),{height:c,width:h}=a.imageSize;return this.layer.fetchImage(o,h,c,l)}).then(l=>{if(me(r))throw A.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),L();return this.processResult(i,l)}).then(()=>R(i.renderExtent,s));i.loadingPromise=u,ge(u,()=>{u===i.loadingPromise&&(i.loadingPromise=null,i.loadingAbortController=null)}),this.notifyChange("updating"),await u.then(async()=>{if(r.aborted)throw L();await this._createStageObjects(t,i.image,r),this.notifyChange("updating")}).catch(l=>{throw l&&!E(l)&&A.error(l),this.notifyChange("updating"),l})}_clearImage(t){const e=this._images[t];if(e){H(e.renderGeometry)&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([e.renderGeometry],this,2),e.renderGeometry=null);const a=this.view._stage;a.remove(e.texture),e.texture=null,a.remove(e.material),e.material=null,e.loadingAbortController&&(e.loadingAbortController.abort(),e.loadingAbortController=null),e.loadingPromise=null,e.image=null,e.pixelData=null}}async _createStageObjects(t,e,a){const s=this.view._stage,i=this._images[t],o=this.view.basemapTerrain.overlayManager.renderer,n=()=>{s.remove(i.texture),i.texture=null,H(i.renderGeometry)&&(o.removeGeometries([i.renderGeometry],this,2),i.renderGeometry=null)};if(e){const r=new pe(e,{width:e.width,height:e.height,preMultiplyAlpha:!0,wrap:{s:33071,t:33071}});let u;if(await fe(this._images[t===0?1:0].loadingPromise),z(a),t===0)u=V(i.renderExtent);else{const l=this._images[0].renderExtent;if(!l)return void n();u=Re(l,i.renderExtent)}n(),s.add(r),s.loadSynchronous(r),i.texture=r,D(i.material)?(i.material=new $e({transparent:!0,textureId:r.id}),s.add(i.material)):i.material.setParameters({textureId:r.id}),i.renderGeometry=new ye(u,i.material),i.renderGeometry.origin=this._overlays[t].renderLocalOrigin,o.addGeometries([i.renderGeometry],this,2)}else n(),s.remove(i.material),i.material=null}_isScaleRangeLayer(){return"minScale"in this.layer&&"maxScale"in this.layer}_isScaleRangeActive(){return!!this._isScaleRangeLayer()&&(this.layer.minScale>0||this.layer.maxScale>0)}_clippedExtent(t,e){if(this.view.viewingMode!=="local")return R(e,t);const a=this.view.basemapTerrain;return a.ready?xe(t,a.extent,e):R(e,t)}_suspendedChangeHandler(){this.suspended?this.clear():this.refreshDebounced()}async _waitFetchReady(t){await we(this.view,"stationary",t),z(t)}};x([w()],m.prototype,"layer",void 0),x([w()],m.prototype,"suspended",void 0),x([w({readOnly:!0})],m.prototype,"fullExtentInLocalViewSpatialReference",void 0),x([w()],m.prototype,"updating",void 0),m=x([be("esri.views.3d.layers.DynamicLayerView3D")],m);const qe=$(),Le=m;export{Le as V};
