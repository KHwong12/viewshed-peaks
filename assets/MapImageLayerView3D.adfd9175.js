var D=Object.defineProperty,M=Object.defineProperties;var T=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var I=(r,e,t)=>e in r?D(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,j=(r,e)=>{for(var t in e||(e={}))L.call(e,t)&&I(r,t,e[t]);if(P)for(var t of P(e))O.call(e,t)&&I(r,t,e[t]);return r},E=(r,e)=>M(r,T(e));import{r as o,t as l,fr as S,w as F,U as G,A as u,g1 as Q,aJ as R,b2 as _}from"./vendor.d423bc92.js";import{V as $}from"./DynamicLayerView3D.77ab56a2.js";import{c as q}from"./ExportImageParameters.794f82a0.js";import{s as z}from"./clickToleranceUtils.f03f410d.js";import{t as H,d as N}from"./popupUtils.a905553f.js";import{a as k}from"./drapedUtils.0a78620b.js";import"./projectExtentUtils.1289c9eb.js";import"./ImageMaterialTechnique.9a60abee.js";import"./RefreshableLayerView.dc4ceb0c.js";import"./sublayerUtils.5227ee88.js";const J=r=>{let e=class extends r{initialize(){this.exportImageParameters=new q({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(t,n){const{layer:d}=this;if(!t)return Promise.reject(new G("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:d}));const y=this.get("view.scale"),h=[],f=async a=>{const i=a.minScale===0||y<=a.minScale,s=a.maxScale===0||y>=a.maxScale;if(a.visible&&i&&s){if(a.sublayers)a.sublayers.forEach(f);else if(a.popupEnabled){const p=N(a,E(j({},n),{defaultPopupTemplateEnabled:!1}));u(p)&&h.unshift({sublayer:a,popupTemplate:p})}}},V=d.sublayers.toArray().reverse().map(f);await Promise.all(V);const A=h.map(async({sublayer:a,popupTemplate:i})=>{await a.load().catch(()=>{});const s=a.createQuery(),p=u(n)?n.event:null,g=z({renderer:a.renderer,event:p}),w=this.createFetchPopupFeaturesQueryGeometry(t,g);if(s.geometry=w,s.outFields=await H(a,i),this.layer.type==="map-image"&&"floors"in this.view){var x,v;const U=(x=this.view)==null||(v=x.floors)==null?void 0:v.clone(),m=Q(U,a);u(m)&&(s.where=s.where?`(${s.where}) AND (${m})`:m)}const b=await this._loadArcadeModules(i);return b&&b.arcadeUtils.hasGeometryOperations(i)||(s.maxAllowableOffset=w.width/g),(await a.queryFeatures(s)).features});return(await R(A)).reduce((a,i)=>i.value?[...a,...i.value]:a,[]).filter(a=>a!=null)}canResume(){var t;return!!super.canResume()&&((t=this.timeExtent)==null||!t.isEmpty)}_loadArcadeModules(t){if(t.get("expressionInfos.length")||Array.isArray(t.content)&&t.content.some(n=>n.type==="expression"))return _()}};return o([l()],e.prototype,"exportImageParameters",void 0),o([l({readOnly:!0})],e.prototype,"exportImageVersion",null),o([l()],e.prototype,"layer",void 0),o([l()],e.prototype,"suspended",void 0),o([l(S)],e.prototype,"timeExtent",void 0),e=o([F("esri.views.layers.MapImageLayerView")],e),e};let c=class extends J($){constructor(){super(...arguments),this.type="map-image-3d"}initialize(){this.updatingHandles.add(this,"exportImageVersion",()=>this.updatingHandles.addPromise(this.refreshDebounced()))}createFetchPopupFeaturesQueryGeometry(r,e){return k(r,e,this.view)}getFetchOptions(){return{timeExtent:this.timeExtent}}};c=o([F("esri.views.3d.layers.MapImageLayerView3D")],c);const se=c;export{se as default};
