import{nx as K,f1 as Q,ac as Z,ny as $,bu as ee,nz as C,gB as z,nA as te,C as ae,lt as re,nB as ie,nC as E,eY as V,hd as ne}from"./vendor.d423bc92.js";import{r as N,m as se,I as oe,q as ce}from"./cimAnalyzer.0966c9e8.js";import{j as J,W as le,O as A,t as W,s as me,a as he}from"./CIMSymbolHelper.f60c7096.js";import"./BidiEngine.8aecf25d.js";import"./number.dfbabd3f.js";const fe=512;class ye{constructor(e){this._resourceManager=e}dispose(){this._rasterizationCanvas=null}rasterizeJSONResource(e,t,s){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),e.type==="simple-fill"||e.type==="esriSFS"){const[m,n,h]=J.rasterizeSimpleFill(this._rasterizationCanvas,e.style,t);return{size:[n,h],image:new Uint32Array(m.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0}}if(e.type==="simple-line"||e.type==="esriSLS"||e.type==="line"&&e.dashTemplate){let m,n;if(e.type==="simple-line"||e.type==="esriSLS")switch(m=le(e.style,e.cap),e.cap){case"butt":n="Butt";break;case"square":n="Square";break;default:n="Round"}else m=e.dashTemplate,n=e.cim.capStyle;const[h,y,g]=J.rasterizeSimpleLine(m,n);return{size:[y,g],image:new Uint32Array(h.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let a,r,o;if(e.type==="simple-marker"||e.type==="esriSMS"||e.type==="line-marker"?(a=A.fromSimpleMarker(e),o=N(a)):e.cim&&e.cim.type==="CIMHatchFill"?(a=A.fromCIMHatchFill(e.cim),r=new W(a.frame.xmin,-a.frame.ymax,a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin)):e.cim.markerPlacement&&e.cim.markerPlacement.type==="CIMMarkerPlacementInsidePolygon"?(a=A.fromCIMInsidePolygon(e.cim),r=new W(a.frame.xmin,-a.frame.ymax,a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin)):(a=e.cim,o=N(a)),o&&!s){const[m,n,h]=se(o);return m?{size:[n,h],image:new Uint32Array(m.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}const[i,c,l,f,p]=A.rasterize(this._rasterizationCanvas,a,r,this._resourceManager,!s);return i?{size:[c,l],image:new Uint32Array(i.buffer),sdf:!1,simplePattern:!1,anchorX:f,anchorY:p}:null}rasterizeImageResource(e,t,s,a){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;const r=this._rasterizationCanvas.getContext("2d");s instanceof ImageData?r.putImageData(s,0,0):(s.setAttribute("width",`${e}px`),s.setAttribute("height",`${t}px`),r.drawImage(s,0,0,e,t));const o=r.getImageData(0,0,e,t),i=new Uint8Array(o.data);if(a){for(const n of a)if(n&&n.oldColor&&n.oldColor.length===4&&n.newColor&&n.newColor.length===4){const[h,y,g,M]=n.oldColor,[I,w,x,P]=n.newColor;if(h===I&&y===w&&g===x&&M===P)continue;for(let d=0;d<i.length;d+=4)h===i[d]&&y===i[d+1]&&g===i[d+2]&&M===i[d+3]&&(i[d]=I,i[d+1]=w,i[d+2]=x,i[d+3]=P)}}let c;for(let n=0;n<i.length;n+=4)c=i[n+3]/255,i[n]=i[n]*c,i[n+1]=i[n+1]*c,i[n+2]=i[n+2]*c;let l=i,f=e,p=t;const m=fe;if(f>=m||p>=m){const n=f/p;n>1?(f=m,p=Math.round(m/n)):(p=m,f=Math.round(m*n)),l=new Uint8Array(4*f*p);const h=new Uint8ClampedArray(l.buffer);K(i,e,t,h,f,p,!1)}return{size:[f,p],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}var D;(function(u){u.Legend="legend",u.Preview="preview"})(D||(D={}));const Y=(u,e,t)=>{if(u&&u.targetSize){let s;if(t){const a=Math.max(t.frame.xmax-t.frame.xmin,t.frame.ymax-t.frame.ymin);s=u.targetSize/z(a)}else s=u.targetSize/e.referenceSize;return s}return u&&u.scaleFactor?u.scaleFactor:1},B={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class Ie{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new me,this._cimResourceManager=new he,this._rasterizer=new ye(this._cimResourceManager)}async rasterizeCIMSymbolAsync(e,t,s,a,r,o,i,c){a=a||(t?t.centroid!=null?"esriGeometryPolygon":Q(t.geometry):null)||ge(e);const l=await this.analyzeCIMSymbol(e,t?ue(t.attributes):null,s,a,c);return this.rasterizeCIMSymbol(l,t,a,r,o,i)}async analyzeCIMSymbol(e,t,s,a,r){const o=[],i=t?{geometryType:a,spatialReference:this._spatialReference,fields:t}:null;let c;await oe(e.data,i,this._cimResourceManager,o,this._avoidSDF),Z(r);for(const l of o)l.cim.type!=="CIMPictureMarker"&&l.cim.type!=="CIMPictureFill"&&l.cim.type!=="CIMPictureStroke"||(c||(c=[]),c.push(this.fetchPictureMarkerResource(l,r))),s&&l.type==="text"&&typeof l.text=="string"&&l.text.indexOf("[")>-1&&(l.text=$(s,l.text,l.cim.textCase));return c&&await Promise.all(c),o}async fetchPictureMarkerResource(e,t){const s=e.materialHash;if(!this._pictureMarkerCache.get(s)){const a=(await ee(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(s,a)}}rasterizeCIMSymbol(e,t,s,a,r,o){const i=[];for(const c of e){a&&typeof a.scaleFactor=="function"&&(a.scaleFactor=a.scaleFactor(t,r,o));const l=this._getRasterizedResource(c,t,s,a,r,o);if(!l)continue;let f=0,p=l.anchorX||0,m=l.anchorY||0,n=!1,h=0,y=0;if(s==="esriGeometryPoint"){const g=Y(a,c,null);if(h=C(c.offsetX,t,r,o)*g||0,y=C(c.offsetY,t,r,o)*g||0,c.type==="marker")f=C(c.rotation,t,r,o)||0,n=!!c.rotateClockwise&&c.rotateClockwise;else if(c.type==="text"){if(f=C(c.angle,t,r,o)||0,c.horizontalAlignment!==void 0)switch(c.horizontalAlignment){case"left":p=-.5;break;case"right":p=.5;break;default:p=0}if(c.verticalAlignment!==void 0)switch(c.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0}}}l!=null&&i.push({angle:f,rotateClockWise:n,anchorX:p,anchorY:m,offsetX:h,offsetY:y,rasterizedResource:l})}return this.getSymbolImage(i)}getSymbolImage(e){const t=document.createElement("canvas"),s=t.getContext("2d");let a=0,r=0,o=0,i=0;const c=[];for(let m=0;m<e.length;m++){const n=e[m],h=n.rasterizedResource;if(!h)continue;const y=h.size,g=n.offsetX,M=n.offsetY,I=n.anchorX,w=n.anchorY,x=n.rotateClockWise||!1;let P=n.angle,d=z(g)-y[0]*(.5+I),_=z(M)-y[1]*(.5+w),S=d+y[0],k=_+y[1];if(P){x&&(P=-P);const b=Math.sin(P*Math.PI/180),v=Math.cos(P*Math.PI/180),X=d*v-_*b,T=d*b+_*v,U=d*v-k*b,H=d*b+k*v,L=S*v-k*b,O=S*b+k*v,G=S*v-_*b,j=S*b+_*v;d=Math.min(X,U,L,G),_=Math.min(T,H,O,j),S=Math.max(X,U,L,G),k=Math.max(T,H,O,j)}a=d<a?d:a,r=_<r?_:r,o=S>o?S:o,i=k>i?k:i;const F=s.createImageData(h.size[0],h.size[1]);F.data.set(new Uint8ClampedArray(h.image.buffer));const q={offsetX:g,offsetY:M,rotateClockwise:x,angle:P,rasterizedImage:F,anchorX:I,anchorY:w};c.push(q)}t.width=o-a,t.height=i-r;const l=-a,f=i;for(let m=0;m<c.length;m++){const n=c[m],h=this._imageDataToCanvas(n.rasterizedImage),y=n.rasterizedImage.width,g=n.rasterizedImage.height,M=l-y*(.5+n.anchorX),I=f-g*(.5-n.anchorY);if(n.angle){const w=(360-n.angle)*Math.PI/180;s.save(),s.translate(z(n.offsetX),-z(n.offsetY)),s.translate(l,f),s.rotate(w),s.translate(-l,-f),s.drawImage(h,M,I),s.restore()}else s.drawImage(h,M+z(n.offsetX),I-z(n.offsetY))}const p=new te({x:l/t.width-.5,y:f/t.height-.5});return{imageData:t.width!==0&&t.height!==0?s.getImageData(0,0,t.width,t.height):s.createImageData(1,1),anchorPosition:p}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,s=t.getContext("2d");return t.width=e.width,t.height=e.height,s.putImageData(e,0,0),t}_imageTo32Array(e,t,s,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const r=this._imageDataCanvas,o=r.getContext("2d");if(r.width=t,r.height=s,o.drawImage(e,0,0,t,s),a){o.save();const i=new ae(a);o.fillStyle=i.toHex(),o.globalCompositeOperation="multiply",o.fillRect(0,0,t,s),o.globalCompositeOperation="destination-atop",o.drawImage(e,0,0,t,s),o.restore()}return new Uint32Array(o.getImageData(0,0,t,s).data.buffer)}_getRasterizedResource(e,t,s,a,r,o){let i,c,l,f,p=null,m=null;if(s==="esriGeometryPolyline"||s==="esriGeometryPolygon"){const h=a&&a.style?a.style:D.Legend,y=s==="esriGeometryPolyline"?B.stroke[h]:B.fill[h];if(e.type==="line"){if(e.cim.type!=="CIMSolidStroke"){if(e.cim.type==="CIMPictureStroke"){const g=C(e.width,t,r,o),M=C(e.color,t,r,o),{image:I,width:w,height:x}=this._getPictureResource(e,g,M);return this._rasterizePictureResource(e,I,w,x,y,g)}return null}({analyzedCIM:i,hash:l}=R(e,t,r,o)),c=this._embedCIMLayerInVectorMarker(i,y)}else if(e.type==="marker"){if(e.cim.type==="CIMPictureMarker"||e.cim.type!=="CIMVectorMarker")return null;e.cim.offsetX=C(e.offsetX,t,r,o),e.cim.offsetY=C(e.offsetY,t,r,o),e.cim.rotation=C(e.rotation,t,r,o),e.cim.markerPlacement=e.markerPlacement,{analyzedCIM:i}=R(e,t,r,o),l=re(JSON.stringify(i)).toString(),c=this._embedCIMLayerInVectorMarker(i,y),p=C(e.size,t,r,o),m=e.path}else{if(e.type==="text")return null;if(e.type==="fill"){if(e.cim.type==="CIMHatchFill"||e.cim.type==="CIMVectorMarker"||e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill"){const g=e.cim.size||e.cim.height;let M,I,w;if(e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill")({image:M,width:I,height:w}=this._getPictureResource(e,g,C(e.color,t,r,o)));else{({analyzedCIM:i,hash:l}=R(e,t,r,o));const x=this._rasterizer.rasterizeJSONResource({cim:i,type:e.type,url:e.url,mosaicHash:l,size:g,path:m},1,this._avoidSDF);M=x.image,I=x.size[0],w=x.size[1]}return this._rasterizePictureResource(e,M,I,w,y,null)}if(e.cim.type!=="CIMSolidFill")return null;({analyzedCIM:i,hash:l}=R(e,t,r,o)),c=this._embedCIMLayerInVectorMarker(i,y)}}}else{if(e.type==="text")return f=this._rasterizeTextResource(e,t,a,r,o),f;({analyzedCIM:i,hash:l}=R(e,t,r,o));const h=Y(a,e,null);if(e.cim.type==="CIMPictureMarker"){const y=C(e.size,t,r,o)*h,{image:g,width:M,height:I}=this._getPictureResource(e,y,C(e.color,t,r,o));return f={image:g,size:[M,I],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},f}ie(i,h,{preserveOutlineWidth:!1}),c=i}l+=s,a&&(l+=JSON.stringify(a));const n=this._resourceCache;return n.has(l)?n.get(l):(f=this._rasterizer.rasterizeJSONResource({cim:c,type:e.type,url:e.url,mosaicHash:l,size:p,path:m},window.devicePixelRatio||1,this._avoidSDF),n.set(l,f),f)}_rasterizeTextResource(e,t,s,a,r){const o=Y(s,e,null),i=C(e.text,t,a,r);if(!i||i.length===0)return null;const c=C(e.fontName,t,a,r),l=C(e.style,t,a,r),f=C(e.weight,t,a,r),p=C(e.decoration,t,a,r),m=C(e.size,t,a,r)*o,n=C(e.horizontalAlignment,t,a,r),h=C(e.verticalAlignment,t,a,r),y=E(C(e.color,t,a,r)),g=E(C(e.outlineColor,t,a,r)),M={color:y,size:m,horizontalAlignment:n,verticalAlignment:h,font:{family:c,style:l,weight:f,decoration:p},halo:{size:C(e.outlineSize,t,a,r)||0,color:g,style:l},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(i,M)}_rasterizePictureResource(e,t,s,a,r,o){const i=document.createElement("canvas"),c=i.getContext("2d");i.height=z(Math.max(r.frame.ymax-r.frame.ymin,o)),i.width=z(r.frame.xmax-r.frame.xmin);const l=c.createImageData(s,a);l.data.set(new Uint8ClampedArray(t.buffer));const f=this._imageDataToCanvas(l),p=c.createPattern(f,"repeat"),m=Math.cos((-e.cim.rotation||0)*Math.PI/180),n=Math.sin((-e.cim.rotation||0)*Math.PI/180);p.setTransform({m11:m,m12:n,m21:-n,m22:m,m41:z(e.cim.offsetX)||0,m42:z(e.cim.offsetY)||0});const h=r.canvasPaths;let y,g,M;V(h)?(y=h.rings,c.fillStyle=p,g=c.fill,M=["evenodd"]):ne(h)&&(y=h.paths,c.strokeStyle=p,c.lineWidth=o,g=c.stroke,y[0][0][1]=i.height/2,y[0][1][1]=i.height/2),c.beginPath();for(const x of y){const P=x?x.length:0;if(P>1){let d=x[0];c.moveTo(z(d[0]),z(d[1]));for(let _=1;_<P;++_)d=x[_],c.lineTo(z(d[0]),z(d[1]));c.closePath()}}g.apply(c,M);const I=c.getImageData(0,0,i.width,i.height),w=new Uint8Array(I.data);return{size:[i.width,i.height],image:new Uint32Array(w.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t,s){const a=this._pictureMarkerCache.get(e.materialHash);if(!a)return null;const r=a.height/a.width,o=t?r>1?z(t):z(t)/r:a.width,i=t?r>1?z(t)*r:z(t):a.height;return{image:this._imageTo32Array(a,o,i,s),width:o,height:i}}_embedCIMLayerInVectorMarker(e,t){const s=V(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol",a=t.frame;return{type:"CIMVectorMarker",frame:a,size:a.ymax-a.ymin,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:s,symbolLayers:[e]}}]}}}function ue(u){return(u?Object.keys(u):[]).map(e=>({name:e,alias:e,type:typeof u[e]=="string"?"esriFieldTypeString":"esriFieldTypeDouble"}))}function ge(u){if(!(u&&u.data&&u.data.symbol))return null;switch(u.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}function R(u,e,t,s){let a,r;return typeof u.materialHash=="function"?(a=(0,u.materialHash)(e,t,s),r=ce(u.cim,u.materialOverrides)):(a=u.materialHash,r=u.cim),{analyzedCIM:r,hash:a}}export{Ie as CIMSymbolRasterizer,D as GeometryStyle};
