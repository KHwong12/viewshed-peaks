var gye=Object.defineProperty,yye=Object.defineProperties;var vye=Object.getOwnPropertyDescriptors;var CC=Object.getOwnPropertySymbols;var MB=Object.prototype.hasOwnProperty,PB=Object.prototype.propertyIsEnumerable;var AB=(t,e,i)=>e in t?gye(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,E=(t,e)=>{for(var i in e||(e={}))MB.call(e,i)&&AB(t,i,e[i]);if(CC)for(var i of CC(e))PB.call(e,i)&&AB(t,i,e[i]);return t},he=(t,e)=>yye(t,vye(e));var $B=(t,e)=>{var i={};for(var r in t)MB.call(t,r)&&e.indexOf(r)<0&&(i[r]=t[r]);if(t!=null&&CC)for(var r of CC(t))e.indexOf(r)<0&&PB.call(t,r)&&(i[r]=t[r]);return i};function u(t,e,i,r){var s,n=arguments.length,o=n<3?e:r===null?r=Object.getOwnPropertyDescriptor(e,i):r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,i,r);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,i,o):s(e,i))||o);return n>3&&o&&Object.defineProperty(e,i,o),o}function _ye(t){return t&&t.release&&typeof t.release=="function"}function bye(t){return t&&t.acquire&&typeof t.acquire=="function"}class Xi{constructor(e,i,r,s=1,n=0){if(this.ctor=e,this.acquireFunction=i,this.releaseFunction=r,this.allocationSize=s,this._pool=new Array(n),this._initialSize=n,this.ctor)for(let o=0;o<n;o++)this._pool[o]=new this.ctor;this.allocationSize=Math.max(s,1)}destroy(){this.prune(0)}acquire(...e){let i;if(Xi.test.disabled)i=new this.ctor;else{if(this._pool.length===0){const r=this.allocationSize;for(let s=0;s<r;s++)this._pool[s]=new this.ctor}i=this._pool.pop()}return this.acquireFunction?this.acquireFunction(i,...e):bye(i)&&i.acquire(...e),i}release(e){e&&!Xi.test.disabled&&(this.releaseFunction?this.releaseFunction(e):_ye(e)&&e.release(),this._pool.push(e))}prune(e=this._initialSize){if(!(e>=this._pool.length)){for(let i=e;i<this._pool.length;++i){const r=this._pool[i];this._dispose(r)}this._pool.length=e}}_dispose(e){e.dispose&&typeof e.dispose=="function"&&e.dispose()}}Xi.test={disabled:!1};function wye(t){t.length=0}class uo{constructor(e=50,i=50){this._pool=new Xi(Array,void 0,wye,i,e)}acquire(){return this._pool.acquire()}release(e){this._pool.release(e)}prune(){this._pool.prune(0)}static acquire(){return iD.acquire()}static release(e){return iD.release(e)}static prune(){iD.prune()}}const iD=new uo(100);var EB,OB;let wh;var RB,IB;(EB=globalThis.dojoConfig)!=null&&EB.has||(OB=globalThis.esriConfig)!=null&&OB.has?wh=E(E({},(RB=globalThis.dojoConfig)==null?void 0:RB.has),(IB=globalThis.esriConfig)==null?void 0:IB.has):wh={};function ae(t){return typeof wh[t]=="function"?wh[t]=wh[t](globalThis):wh[t]}ae.add=(t,e,i,r)=>((r||wh[t]===void 0)&&(wh[t]=e),i&&ae(t)),ae.cache=wh,ae.add("esri-deprecation-warnings",!0),(()=>{var t;ae.add("host-webworker",globalThis.WorkerGlobalScope!==void 0&&self instanceof globalThis.WorkerGlobalScope);const e=typeof window!="undefined"&&typeof location!="undefined"&&typeof document!="undefined"&&window.location===location&&window.document===document;if(ae.add("host-browser",e),ae.add("host-node",typeof globalThis.process=="object"&&((t=globalThis.process.versions)==null?void 0:t.node)&&globalThis.process.versions.v8),ae.add("dom",e),ae("host-browser")){const i=navigator,r=i.userAgent,s=i.appVersion,n=parseFloat(s);if(ae.add("wp",parseFloat(r.split("Windows Phone")[1])||void 0),ae.add("msapp",parseFloat(r.split("MSAppHost/")[1])||void 0),ae.add("khtml",s.includes("Konqueror")?n:void 0),ae.add("edge",parseFloat(r.split("Edge/")[1])||void 0),ae.add("opr",parseFloat(r.split("OPR/")[1])||void 0),ae.add("webkit",!ae("wp")&&!ae("edge")&&parseFloat(r.split("WebKit/")[1])||void 0),ae.add("chrome",!ae("edge")&&!ae("opr")&&parseFloat(r.split("Chrome/")[1])||void 0),ae.add("android",!ae("wp")&&parseFloat(r.split("Android ")[1])||void 0),ae.add("safari",!s.includes("Safari")||ae("wp")||ae("chrome")||ae("android")||ae("edge")||ae("opr")?void 0:parseFloat(s.split("Version/")[1])),ae.add("mac",s.includes("Macintosh")),!ae("wp")&&r.match(/(iPhone|iPod|iPad)/)){const o=RegExp.$1.replace(/P/,"p"),a=r.match(/OS ([\d_]+)/)?RegExp.$1:"1",l=parseFloat(a.replace(/_/,".").replace(/_/g,""));ae.add(o,l),ae.add("ios",l)}ae.add("trident",parseFloat(s.split("Trident/")[1])||void 0),ae("webkit")||(!r.includes("Gecko")||ae("wp")||ae("khtml")||ae("trident")||ae("edge")||ae.add("mozilla",n),ae("mozilla")&&ae.add("ff",parseFloat(r.split("Firefox/")[1]||r.split("Minefield/")[1])||void 0))}})(),(()=>{if(globalThis.navigator){const t=navigator.userAgent,e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i.test(t),i=/iPhone/i.test(t);e&&ae.add("esri-mobile",e),i&&ae.add("esri-iPhone",i),ae.add("esri-geolocation",!!navigator.geolocation)}ae.add("esri-canvas-svg-support",!ae("trident")),ae.add("esri-wasm","WebAssembly"in globalThis),ae.add("esri-shared-array-buffer",()=>{const t="SharedArrayBuffer"in globalThis,e=globalThis.crossOriginIsolated===!1;return t&&!e}),ae.add("esri-atomics","Atomics"in globalThis),ae.add("esri-workers","Worker"in globalThis),ae.add("esri-text-decoder","TextDecoder"in globalThis),ae.add("esri-text-encoder","TextEncoder"in globalThis),ae.add("web-feat:cache","caches"in globalThis),ae.add("esri-workers-arraybuffer-transfer",!ae("safari")||Number(ae("safari"))>=12),ae.add("featurelayer-simplify-thresholds",[.5,.5,.5,.5]),ae.add("featurelayer-simplify-payload-size-factors",[1,1,4]),ae.add("featurelayer-snapshot-enabled",!0),ae.add("featurelayer-snapshot-point-min-threshold",8e4),ae.add("featurelayer-snapshot-point-max-threshold",4e5),ae.add("featurelayer-snapshot-point-coverage",.1),ae.add("featurelayer-advanced-symbols",!1),ae.add("featurelayer-pbf",!0),ae.add("featurelayer-pbf-statistics",!1),ae.add("feature-layers-workers",!0),ae.add("mapview-transitions-duration",200),ae.add("mapserver-pbf-enabled",!1),ae.add("vectortilelayer-max-buffers",ae("ff")?160:Number.POSITIVE_INFINITY),ae("host-webworker")||ae("host-browser")&&(ae.add("esri-csp-restrictions",()=>{try{new Function}catch{return!0}return!1}),ae.add("esri-image-decode",()=>{if("decode"in new Image){const t=new Image;return t.src='data:image/svg+xml;charset=UTF-8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>',void t.decode().then(()=>{ae.add("esri-image-decode",!0,!0,!0)}).catch(()=>{ae.add("esri-image-decode",!1,!0,!0)})}return!1}),ae.add("esri-url-encodes-apostrophe",()=>{const t=window.document.createElement("a");return t.href="?'",t.href.includes("?%27")}))})();const DB=new Set;function xye(t,e,i=!1){i&&DB.has(e)||(i&&DB.add(e),t.warn(`\u{1F6D1} DEPRECATED - ${e}`))}function FB(t,e,i={}){ae("esri-deprecation-warnings")&&hg(t,`Module: ${e}`,i)}function kv(t,e,i={}){if(ae("esri-deprecation-warnings")){const{moduleName:r}=i;hg(t,`Function: ${(r?r+"::":"")+e+"()"}`,i)}}function rD(t,e,i={}){if(ae("esri-deprecation-warnings")){const{moduleName:r}=i;hg(t,`Property: ${(r?r+"::":"")+e}`,i)}}function hg(t,e,i={}){if(ae("esri-deprecation-warnings")){const{replacement:r,version:s,see:n,warnOnce:o}=i;let a=e;r&&(a+=`
	\u{1F6E0}\uFE0F Replacement: ${r}`),s&&(a+=`
	\u2699\uFE0F Version: ${s}`),n&&(a+=`
	\u{1F517} See ${n} for more details.`),xye(t,a,o)}}const yp=null;function _(t){return t!=null}function A(t){return t==null}function Vst(t){return t===void 0}function vp(t,e){return _(t)?e(t):yp}function at(t){return t}function Nst(t,e){if(A(t))throw new Error(e);return t}function st(t,e){return _(t)?t:typeof e=="function"?e():e}function tt(t){return _(t)&&t.destroy(),null}function Ge(t){return _(t)&&t.dispose(),null}function ln(t){return _(t)&&t.remove(),null}function Rl(t){return _(t)&&t.abort(),null}function nr(t){return _(t)&&t.release(),null}function Ust(t,e){return _(t)&&_(e)?t.equals(e):t===e}function Sye(t){return null}function jst(t,e){const i=new Array;return t.forEach(r=>{const s=e(r);_(s)&&i.push(s)}),i}function Bst(t,e){const i=new Array;for(const r of t)i.push(xh(r,null,e));return i}function Gst(t,e){for(const i of t)xh(i,null,e)}function xh(t,e,i){return _(t)?i(t):e}function LB(t,e){return _(t)?e(t):null}function qst(t){return t.filter(e=>_(e))}function or(t,...e){let i=t;for(let r=0;r<e.length&&i;++r)i=i[e[r]];return i}function Kr(t){return t}class $a{constructor(e=1){this._seed=e}set seed(e){this._seed=e==null?Math.random()*$a._m:e}getInt(){return this._seed=($a._a*this._seed+$a._c)%$a._m,this._seed}getFloat(){return this.getInt()/($a._m-1)}getIntRange(e,i){return Math.round(this.getFloatRange(e,i))}getFloatRange(e,i){const r=i-e;return e+this.getInt()/$a._m*r}}$a._m=2147483647,$a._a=48271,$a._c=0;function MC(t,e){return e?t.filter((i,r,s)=>s.findIndex(e.bind(null,i))===r):t.filter((i,r,s)=>s.indexOf(i)===r)}function _p(t,e,i){if(A(t)&&A(e))return!0;if(A(t)||A(e)||t.length!==e.length)return!1;if(i){for(let r=0;r<t.length;r++)if(!i(t[r],e[r]))return!1}else for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}function Tye(t,e,i){let r,s;return i?(r=e.filter(n=>!t.some(o=>i(o,n))),s=t.filter(n=>!e.some(o=>i(o,n)))):(r=e.filter(n=>!t.includes(n)),s=t.filter(n=>!e.includes(n))),{added:r,removed:s}}function Hst(t,e){const i=t.length;if(i===0)return[];const r=[];for(let s=0;s<i;s+=e)r.push(t.slice(s,s+e));return r}const Cye=!!Array.prototype.fill;function Mye(t,e){if(Cye)return new Array(t).fill(e);const i=new Array(t);for(let r=0;r<t;r++)i[r]=e;return i}function Pye(t,e){e===void 0&&(e=t,t=0);const i=new Array(e-t);for(let r=t;r<e;r++)i[r-t]=r;return i}function Aye(t,e,i){const r=t.length;let s=0,n=r-1;for(;s<n;){const a=s+Math.floor((n-s)/2);e>t[a]?s=a+1:n=a}const o=t[s];return i?e>=t[r-1]?-1:o===e?s:s-1:o===e?s:-1}function $ye(t){return t.reduce((e,i)=>e.concat(i||[]),[])}class kB{constructor(){this.last=0}}const zB=new kB;function VB(t,e,i,r){r=r||zB;const s=Math.max(0,r.last-10);for(let o=s;o<i;++o)if(t[o]===e)return r.last=o,o;const n=Math.min(s,i);for(let o=0;o<n;++o)if(t[o]===e)return r.last=o,o;return-1}function PC(t,e,i,r){const s=i==null?t.length:i,n=VB(t,e,s,r);if(n!==-1)return t[n]=t[s-1],i==null&&t.pop(),e}const Il=new Set;function Eye(t,e,i=t.length,r=e.length,s,n){if(r===0||i===0)return i;Il.clear();for(let a=0;a<r;++a)Il.add(e[a]);s=s||zB;const o=Math.max(0,s.last-10);for(let a=o;a<i;++a)if(Il.has(t[a])&&(n&&n.push(t[a]),Il.delete(t[a]),t[a]=t[i-1],--i,--a,Il.size===0||i===0))return Il.clear(),i;for(let a=0;a<o;++a)if(Il.has(t[a])&&(n&&n.push(t[a]),Il.delete(t[a]),t[a]=t[i-1],--i,--a,Il.size===0||i===0))return Il.clear(),i;return Il.clear(),i}function Oye(t){return t?(NB.seed=t,()=>NB.getFloat()):Math.random}function Wst(t,e){const i=Oye(e);for(let r=t.length-1;r>0;r--){const s=Math.floor(i()*(r+1)),n=t[r];t[r]=t[s],t[s]=n}return t}const NB=new $a;function sD(t,e){const i=t.indexOf(e);return i!==-1?(t.splice(i,1),e):null}function Rye(t,e){if(t.forEach)t.forEach(e);else for(let i=0;i<t.length;i++)e(t[i],i,t)}function nD(t,e,i){if(t.slice)return t.slice(e,i);e===void 0?e=0:(e<0&&(e+=t.length),e=Math.min(t.length,Math.max(0,e))),i===void 0?i=t.length:(i<0&&(i+=t.length),i=Math.min(t.length,Math.max(0,i)));const r=Math.max(0,i-e),s=new t.constructor(r);for(let n=0;n<r;n++)s[n]=t[e+n];return s}function Bw(t){return t instanceof ArrayBuffer||t&&t.constructor&&t.constructor.name==="ArrayBuffer"}function Iye(t){return t instanceof Int8Array||t&&t.constructor&&t.constructor.name==="Int8Array"}function dg(t){return t instanceof Uint8Array||t&&t.constructor&&t.constructor.name==="Uint8Array"}function Dye(t){return t instanceof Uint8ClampedArray||t&&t.constructor&&t.constructor.name==="Uint8ClampedArray"}function Fye(t){return t instanceof Int16Array||t&&t.constructor&&t.constructor.name==="Int16Array"}function AC(t){return t instanceof Uint16Array||t&&t.constructor&&t.constructor.name==="Uint16Array"}function Lye(t){return t instanceof Int32Array||t&&t.constructor&&t.constructor.name==="Int32Array"}function $C(t){return t instanceof Uint32Array||t&&t.constructor&&t.constructor.name==="Uint32Array"}function UB(t){return t instanceof Float32Array||t&&t.constructor&&t.constructor.name==="Float32Array"}function jB(t){return t instanceof Float64Array||t&&t.constructor&&t.constructor.name==="Float64Array"}function kye(t){const e=new Array(t.length);for(let i=0;i<t.length;i++)e[i]=t[i];return e}function EC(t){return A(t)?0:128+t.buffer.byteLength+64}function BB(t,e){let i;if(e)for(i in t)t.hasOwnProperty(i)&&(t[i]===void 0?delete t[i]:t[i]instanceof Object&&BB(t[i],!0));else for(i in t)t.hasOwnProperty(i)&&t[i]===void 0&&delete t[i];return t}function ie(t){if(!t||typeof t!="object"||typeof t=="function")return t;if(Iye(t)||dg(t)||Dye(t)||Fye(t)||AC(t)||Lye(t)||$C(t)||UB(t)||jB(t))return nD(t);if(t instanceof Date)return new Date(t.getTime());if(t instanceof ArrayBuffer)return t.slice(0,t.byteLength);if(t instanceof Map){const r=new Map;return t.forEach((s,n)=>{r.set(n,ie(s))}),r}if(t instanceof Set){const r=new Set;return t.forEach(s=>{r.add(ie(s))}),r}let e;const i=t;if(typeof i.clone=="function")e=i.clone();else if(typeof i.map=="function"&&typeof i.forEach=="function")e=i.map(ie);else if(typeof i.notifyChange=="function"&&typeof i.watch=="function")e=i.clone();else{e={};for(const r of Object.getOwnPropertyNames(t))e[r]=ie(t[r])}return e}function OC(t,e){return t===e||typeof t=="number"&&isNaN(t)&&typeof e=="number"&&isNaN(e)||typeof(t||{}).getTime=="function"&&typeof(e||{}).getTime=="function"&&t.getTime()===e.getTime()||!1}function oD(t,e){return t===e||(t==null||typeof t=="string"?t===e:typeof t=="number"?t===e||typeof e=="number"&&isNaN(t)&&isNaN(e):t instanceof Date?e instanceof Date&&t.getTime()===e.getTime():Array.isArray(t)?Array.isArray(e)&&_p(t,e):t instanceof Set?e instanceof Set&&Vye(t,e):t instanceof Map?e instanceof Map&&Nye(t,e):typeof t=="object"&&typeof e=="object"&&zye(t,e))}function zye(t,e){if(t===null||e===null)return!1;const i=Object.keys(t),r=i.length;if(e===null||Object.keys(e).length!==r)return!1;for(const s of i)if(t[s]!==e[s]||!Object.prototype.hasOwnProperty.call(e,s))return!1;return!0}function Vye(t,e){if(t.size!==e.size)return!1;for(const i of t)if(!e.has(i))return!1;return!0}function Nye(t,e){if(t.size!==e.size)return!1;for(const[i,r]of t){const s=e.get(i);if(s!==r||s===void 0&&!e.has(i))return!1}return!0}function GB(t,e,i=!1){return HB(t,e,i)}function zv(t,e){if(e!=null)return e[t]||qB(t.split("."),!1,e)}function Bo(t,e,i){const r=t.split("."),s=r.pop(),n=qB(r,!0,i);n&&s&&(n[s]=e)}function qB(t,e,i){let r=i;for(const s of t){if(r==null)return;if(!(s in r)){if(!e)return;r[s]={}}r=r[s]}return r}function HB(t,e,i){return e?Object.keys(e).reduce(function(r,s){let n=r[s],o=e[s];return n===o?r:n===void 0?(r[s]=ie(o),r):(Array.isArray(o)||Array.isArray(r)?(n=n?Array.isArray(n)?r[s]=n.concat():r[s]=[n]:r[s]=[],o&&(Array.isArray(o)||(o=[o]),i?o.forEach(a=>{n.indexOf(a)===-1&&n.push(a)}):r[s]=o.concat())):o&&typeof o=="object"?r[s]=HB(n,o,i):r.hasOwnProperty(s)&&!e.hasOwnProperty(s)||(r[s]=o),r)},t||{}):t}var WB;const ei={apiKey:void 0,applicationUrl:(WB=globalThis.location)==null?void 0:WB.href,assetsPath:"",fontsUrl:"https://static.arcgis.com/fonts",geometryService:null,geometryServiceUrl:"https://utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",geoRSSServiceUrl:"https://utility.arcgis.com/sharing/rss",kmlServiceUrl:"https://utility.arcgis.com/sharing/kml",portalUrl:"https://www.arcgis.com",workers:{loaderConfig:{has:{},paths:{},map:{},packages:[]}},request:{httpsDomains:["arcgis.com","arcgisonline.com","esrikr.com","premiumservices.blackbridge.com","esripremium.accuweather.com","gbm.digitalglobe.com","firstlook.digitalglobe.com","msi.digitalglobe.com"],interceptors:[],maxUrlLength:2e3,proxyRules:[],proxyUrl:null,timeout:6e4,trustedServers:[],useIdentity:!0},log:{interceptors:[],level:null}};if(globalThis.esriConfig&&(GB(ei,globalThis.esriConfig,!0),delete ei.has),!ei.assetsPath){const t="4.22.2";ei.assetsPath=`https://js.arcgis.com/${t.slice(0,-2)}/@arcgis/core/assets`}ei.baseUrl&&console.warn("[esri.config]","baseUrl has been replaced by assetsPath"),Object.defineProperty(ei,"baseUrl",{set(){console.warn("[esri.config]","baseUrl has been replaced by assetsPath")}}),ei.request.corsEnabledServers=[],ei.request.corsEnabledServers.push=function(){return console.warn("[esri.config]","request.corsEnabledServers is not supported and will be removed in a future release. See http://esriurl.com/cors8664"),0};const Uye=/\{([^\}]+)\}/g;function ZB(t){return t==null?"":t}function Dl(t,e){return t.replace(Uye,typeof e=="object"?(i,r)=>ZB(zv(r,e)):(i,r)=>ZB(e(r)))}function JB(t,e){return t.replace(/([\.$?*|{}\(\)\[\]\\\/\+\-^])/g,i=>e&&e.indexOf(i)!==-1?i:`\\${i}`)}function aD(t){let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i),e|=0;return e}function Zst(t){return new DOMParser().parseFromString(t||"","text/html").body.innerText||""}const QB={info:0,warn:1,error:2,none:3};class le{constructor(e){this.level=null,this._module="",this._parent=null,this.writer=null,this._loggedMessages={error:new Map,warn:new Map,info:new Map},e.level!=null&&(this.level=e.level),e.writer!=null&&(this.writer=e.writer),this._module=e.module,le._loggers[this.module]=this;const i=this.module.lastIndexOf(".");i!==-1&&(this._parent=le.getLogger(this.module.slice(0,i)))}get module(){return this._module}get parent(){return this._parent}error(...e){this._log("error","always",...e)}warn(...e){this._log("warn","always",...e)}info(...e){this._log("info","always",...e)}errorOnce(...e){this._log("error","once",...e)}warnOnce(...e){this._log("warn","once",...e)}infoOnce(...e){this._log("info","once",...e)}errorOncePerTick(...e){this._log("error","oncePerTick",...e)}warnOncePerTick(...e){this._log("warn","oncePerTick",...e)}infoOncePerTick(...e){this._log("info","oncePerTick",...e)}get test(){const e=this;return{loggedMessages:e._loggedMessages,clearLoggedWarnings:()=>e._loggedMessages.warn.clear()}}static get testSingleton(){return{resetLoggers(e={}){const i=le._loggers;return le._loggers=e,i},set throttlingDisabled(e){le._throttlingDisabled=e}}}static getLogger(e){let i=le._loggers[e];return i||(i=new le({module:e})),i}_log(e,i,...r){if(!!this._matchLevel(e)){if(i!=="always"&&!le._throttlingDisabled){const s=this._argsToKey(r),n=this._loggedMessages[e].get(s);if(i==="once"&&n!=null||i==="oncePerTick"&&n&&n>=le._tickCounter)return;this._loggedMessages[e].set(s,le._tickCounter),le._scheduleTickCounterIncrement()}for(const s of ei.log.interceptors)if(s(e,this.module,...r))return;this._inheritedWriter()(e,this.module,...r)}}_parentWithMember(e,i){let r=this;for(;_(r);){const s=r[e];if(_(s))return s;r=r.parent}return i}_inheritedWriter(){return this._parentWithMember("writer",this._consoleWriter)}_consoleWriter(e,i,...r){console[e](`[${i}]`,...r)}_matchLevel(e){const i=ei.log.level?ei.log.level:"warn";return QB[this._parentWithMember("level",i)]<=QB[e]}_argsToKey(...e){const i=(r,s)=>typeof s!="object"||Array.isArray(s)?s:"[Object]";return aD(JSON.stringify(e,i))}static _scheduleTickCounterIncrement(){le._tickCounterScheduled||(le._tickCounterScheduled=!0,Promise.resolve().then(()=>{le._tickCounter++,le._tickCounterScheduled=!1}))}}le._loggers={},le._tickCounter=0,le._tickCounterScheduled=!1,le._throttlingDisabled=!1;function Gw(t){return pg(()=>t.forEach(e=>_(e)&&e.remove()))}function pg(t){return{remove:()=>{t&&(t(),t=void 0)}}}function jye(t,e){const i=setTimeout(t,e);return pg(()=>clearTimeout(i))}function Ea(t){return t?t.__accessor__?t.__accessor__:t.propertyInvalidated?t:null:null}function Bye(t,e){return t!=null&&t.metadatas&&t.metadatas[e]!=null}function RC(t,e,i){return i?IC(t,e,{policy:i,path:""}):IC(t,e,null)}function IC(t,e,i){return e?Object.keys(e).reduce(function(r,s){let n=null,o="merge";if(i&&(n=i.path?`${i.path}.${s}`:s,o=i.policy(n)),o==="replace")return r[s]=e[s],r;if(r[s]===void 0)return r[s]=ie(e[s]),r;let a=r[s],l=e[s];if(a===l)return r;if(Array.isArray(l)||Array.isArray(r))a=a?Array.isArray(a)?r[s]=a.concat():r[s]=[a]:r[s]=[],l&&(Array.isArray(l)||(l=[l]),l.forEach(c=>{a.indexOf(c)===-1&&a.push(c)}));else if(l&&typeof l=="object")if(i){const c=i.path;i.path=Kr(n),r[s]=IC(a,l,i),i.path=c}else r[s]=IC(a,l,null);else r.hasOwnProperty(s)&&!e.hasOwnProperty(s)||(r[s]=l);return r},t||{}):t}function YB(t){return Array.isArray(t)?t:t.split(".")}function XB(t){return t.indexOf(",")>-1?t.split(",").map(e=>e.trim()):[t.trim()]}function Gye(t){if(Array.isArray(t)){const e=[];for(const i of t)e.push(...XB(i));return e}return XB(t)}function KB(t,e,i,r){const s=Gye(e);if(s.length!==1){const n=s.map(o=>r(t,o,i));return Gw(n)}return r(t,s[0],i)}function lD(t){let e=!1;return()=>{e||(e=!0,t())}}function eG(t,e){const i=t[t.length-1]==="?"?t.slice(0,-1):t;if(e.getItemAt!=null||Array.isArray(e)){const s=parseInt(i,10);if(!isNaN(s))return Array.isArray(e)?e[s]:e.getItemAt(s)}const r=Ea(e);return Bye(r,i)?r.get(i):e[i]}function tG(t,e,i){if(t==null)return t;const r=eG(e[i],t);return!r&&i<e.length-1?void 0:i===e.length-1?r:tG(r,e,i+1)}function Vv(t,e,i=0){return typeof e=="string"&&e.indexOf(".")===-1?eG(e,t):tG(t,YB(e),i)}function DC(t,e){return Vv(t,e)}function iG(t,e){return Vv(e,t)!==void 0}class rG{constructor(e){this.autoDestroy=!1,this.properties=e}}function qw(t){let e=t.constructor.__accessorMetadata__;const i=Object.prototype.hasOwnProperty.call(t.constructor,"__accessorMetadata__");if(e){if(!i){const r=Object.create(e.properties),s=e.autoDestroy;for(const n in r)r[n]=ie(r[n]);e=new rG(r),e.autoDestroy=s,Object.defineProperty(t.constructor,"__accessorMetadata__",{value:e,enumerable:!1,configurable:!0,writable:!0})}}else e=new rG({}),Object.defineProperty(t.constructor,"__accessorMetadata__",{value:e,enumerable:!1,configurable:!0,writable:!0});return Kr(t.constructor.__accessorMetadata__)}function qye(t){return qw(t).properties}function FC(t,e){const i=qye(t);let r=i[e];return r||(r=i[e]={}),r}function Hye(t,e){return RC(t,e,Zye)}const Wye=/^(?:[^.]+\.)?(?:value|type|(?:json\.type|json\.origins\.[^.]\.type))$/;function Zye(t){return Wye.test(t)?"replace":"merge"}let LC,Hw=[];const Jye=le.getLogger("esri.core.Accessor");function bt(t){LC!==void 0&&LC.onObservableAccessed(t)}let kC=!1,zC=!1;function Sh(t,e,i){if(kC)return cD(t,e,i);sG(t);const r=e.call(i);return nG(),r}function Qye(t,e){return Sh(void 0,t,e)}function cD(t,e,i){const r=kC;kC=!0,sG(t);let s=null;try{s=e.call(i)}catch(n){zC&&Jye.error(n)}return nG(),kC=r,s}function sG(t){LC=t,Hw.push(t)}function nG(){const t=Hw.pop();LC=Hw.length>0?Hw[Hw.length-1]:void 0,t!==void 0&&t.onTrackingEnd()}function oG(t,e){if(32&e.flags)return;const i=zC;zC=!1,64&e.flags?cD(e,e.metadata.get,t):aG(t,e),zC=i}const Yye=[];function aG(t,e){128&e.flags||(e.flags|=128,cD(e,()=>{const i=e.metadata.dependsOn||Yye;for(const r of i)if(typeof r=="string"&&r.indexOf(".")===-1)lG(t,r,!1);else{const s=YB(r);for(let n=0,o=t;n<s.length&&o!=null&&typeof o=="object";++n)o=lG(o,s[n],n!==s.length-1)}}),e.flags&=-129)}function lG(t,e,i){const r=e[e.length-1]==="?"?e.slice(0,-1):e;if(t.getItemAt!=null||Array.isArray(t)){const o=parseInt(r,10);if(!isNaN(o))return Array.isArray(t)?t[o]:t.getItemAt(o)}const s=Ea(t),n=s==null?void 0:s.properties.get(r);return n&&(bt(n),oG(t,n)),i?t[r]:void 0}class cG{constructor(e,i){this._observers=e,this._observer=i}remove(){sD(this._observers,this._observer)}}class uG{constructor(e,i,r){this.properties=e,this.propertyName=i,this.metadata=r,this._observers=null,this._accessed=null,this._handles=null,this.flags=1|(r.nonNullable?8:0)|(r.hasOwnProperty("value")?16:0)|(r.get===void 0?32:0)|(r.dependsOn===void 0?64:0)}destroy(){this._accessed=null,this._observers=null,this._clearObservationHandles()}getComputed(){bt(this);const e=this.properties.store,i=this.propertyName,r=this.flags,s=e.get(i);if(4&r||1&~r&&e.has(i))return s;this.flags|=4;const n=this.properties.host;let o;64&r?o=Sh(this,this.metadata.get,n):(aG(n,this),o=this.metadata.get.call(n)),e.set(i,o,1);const a=e.get(i);return a===s?this.flags&=-2:Qye(this.commit,this),this.flags&=-5,a}onObservableAccessed(e){e!==this&&(this._accessed===null&&(this._accessed=[]),this._accessed.includes(e)||this._accessed.push(e))}onTrackingEnd(){this._clearObservationHandles(),this.flags|=32;const e=this._accessed;if(e===null)return;let i=this._handles;i===null&&(i=this._handles=[]);for(let r=0;r<e.length;++r)i.push(e[r].observe(this));e.length=0}observe(e){return this._observers===null&&(this._observers=[]),this._observers.includes(e)||this._observers.push(e),new cG(this._observers,e)}notifyChange(){this.onInvalidated(),this.onCommitted()}invalidate(){this.onInvalidated()}onInvalidated(){2&~this.flags&&(this.flags|=1);const e=this._observers;if(e!==null)for(let i=0;i<e.length;++i)e[i].onInvalidated()}commit(){this.flags&=-2,this.onCommitted()}onCommitted(){if(this._observers===null)return;const e=this._observers.slice();for(let i=0;i<e.length;++i)e[i].onCommitted()}_clearObservationHandles(){const e=this._handles;if(e!==null){for(let i=0;i<e.length;++i)e[i].remove();e.length=0}}}const uD=7;function bp(t){switch(t){case"defaults":return 0;case"service":return 2;case"portal-item":return 3;case"web-scene":return 4;case"web-map":return 5;case"user":return 6}}function VC(t){switch(t){case 0:return"defaults";case 2:return"service";case 3:return"portal-item";case 4:return"web-scene";case 5:return"web-map";case 6:return"user"}return Kr(void 0)}function Xye(t){return VC(t)}class hD{constructor(){this._values=new Map}clone(e){const i=new hD;return this._values.forEach((r,s)=>{e&&e.has(s)||i.set(s,ie(r))}),i}get(e){return this._values.get(e)}originOf(){return 6}keys(){return[...this._values.keys()]}set(e,i){this._values.set(e,i)}delete(e){this._values.delete(e)}has(e){return this._values.has(e)}forEach(e){this._values.forEach(e)}}function NC(t,e,i){return t!==void 0}function hG(t,e,i,r){return t!==void 0&&(!(i==null&&8&t.flags)||(r.lifecycle,!1))}function Kye(t){return t&&typeof t.destroy=="function"}le.getLogger("esri.core.accessorSupport.Properties");class e0e{constructor(e){this.host=e,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=0,this.store=new hD,this._origin=6;const i=this.host.constructor.__accessorMetadata__,r=i.properties;for(const s in r){const n=new uG(this,s,r[s]);this.properties.set(s,n)}this.metadatas=r,this._autoDestroy=i.autoDestroy}initialize(){this.lifecycle=1}constructed(){this.lifecycle=2}destroy(){if(this.destroyed=!0,this._autoDestroy)for(const[e,i]of this.properties){const r=this.internalGet(e);r&&Kye(r)&&(r.destroy(),8&~i.flags&&this._internalSet(i,null)),i.destroy()}else for(const[e,i]of this.properties)i.destroy()}get initialized(){return this.lifecycle!==0}get(e){const i=this.properties.get(e);if(i.metadata.get)return i.getComputed();bt(i);const r=this.store;return r.has(e)?r.get(e):i.metadata.value}originOf(e){const i=this.store.originOf(e);if(i===void 0){const r=this.properties.get(e);if(r!==void 0&&16&r.flags)return"defaults"}return VC(i)}has(e){return!!this.properties.has(e)&&this.store.has(e)}keys(){return[...this.properties.keys()]}internalGet(e){const i=this.properties.get(e);if(NC(i))return this.store.has(e)?this.store.get(e):i.metadata.value}internalSet(e,i){const r=this.properties.get(e);NC(r)&&this._internalSet(r,i)}getDependsInfo(e,i,r){const s=this.properties.get(i);if(!NC(s))return"";const n=new Set,o=Sh({onObservableAccessed:l=>n.add(l),onTrackingEnd:()=>{}},()=>{var l;return(l=s.metadata.get)==null?void 0:l.call(e)});let a=`${r}${e.declaredClass.split(".").pop()}.${i}: ${o}
`;if(n.size===0)return a;r+="  ";for(const l of n){if(!(l instanceof uG))continue;const c=l.properties.host,h=l.propertyName,p=Ea(c);a+=p?p.getDependsInfo(c,h,r):`${r}${h}: undefined
`}return a}setAtOrigin(e,i,r){const s=this.properties.get(e);if(NC(s))return this._setAtOrigin(s,i,r)}isOverridden(e){const i=this.properties.get(e);return i!==void 0&&!!(2&i.flags)}clearOverride(e){const i=this.properties.get(e);i!==void 0&&2&i.flags&&(i.flags&=-3,i.notifyChange())}override(e,i){const r=this.properties.get(e);if(!hG(r,e,i,this))return;const s=r.metadata.cast;if(s){const n=this._cast(s,i),{valid:o,value:a}=n;if(dD.release(n),!o)return;i=a}r.flags|=2,this._internalSet(r,i)}set(e,i){const r=this.properties.get(e);if(!hG(r,e,i,this))return;const s=r.metadata.cast;if(s){const o=this._cast(s,i),{valid:a,value:l}=o;if(dD.release(o),!a)return;i=l}const n=r.metadata.set;n?n.call(this.host,i):this._internalSet(r,i)}setDefaultOrigin(e){this._origin=bp(e)}getDefaultOrigin(){return VC(this._origin)}notifyChange(e){const i=this.properties.get(e);i!==void 0&&i.notifyChange()}invalidate(e){const i=this.properties.get(e);i!==void 0&&i.invalidate()}commit(e){const i=this.properties.get(e);i!==void 0&&i.commit()}_internalSet(e,i){const r=this.lifecycle!==0?this._origin:0;this._setAtOrigin(e,i,r)}_setAtOrigin(e,i,r){const s=this.store,n=e.propertyName;s.has(n,r)&&OC(i,s.get(n))&&2&~e.flags&&r===s.originOf(n)||(e.invalidate(),s.set(n,i,r),e.commit(),oG(this.host,e))}_cast(e,i){const r=dD.acquire();return r.valid=!0,r.value=i,e&&(r.value=e.call(this.host,i,r)),r}}class t0e{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}}const dD=new Xi(t0e);function UC(t,e,i){if(t&&e)if(typeof e=="object")for(const r of Object.getOwnPropertyNames(e))UC(t,r,e[r]);else{if(e.indexOf(".")!==-1){const r=e.split("."),s=r.splice(r.length-1,1)[0];return void UC(DC(t,r),s,i)}t[e]=i}}le.getLogger("esri.core.accessorSupport.set");class dG extends Xi{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=Sye(this._set)}acquire(...e){const i=super.acquire(...e);return this._set.delete(i),i}release(e){e&&!this._set.has(e)&&(super.release(e),this._set.add(e))}_dispose(e){this._set.delete(e),super._dispose(e)}}const jC=[];function Nv(t){jC.push(t),jC.length===1&&queueMicrotask(()=>{const e=jC.slice();jC.length=0;for(const i of e)i()})}const i0e=29;class wp{constructor(e,i=i0e){this.name=e,this._counter=0,this._items=new Array(i)}record(e){this._items[++this._counter%this._items.length]=e}get median(){return this._items.slice().sort((e,i)=>e-i)[Math.floor(this._items.length/2)]}get average(){return this._items.reduce((e,i)=>e+i,0)/this._items.length}get last(){return this._items[this._counter%this._items.length]}}var pD;(function(t){const e=(n,o,a,l)=>{let c=o,h=o;const p=a>>>1,f=n[c-1];for(;h<=p;){h=c<<1,h<a&&l(n[h-1],n[h])<0&&++h;const g=n[h-1];if(l(g,f)<=0)break;n[c-1]=g,c=h}n[c-1]=f},i=(n,o)=>n<o?-1:n>o?1:0;function r(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=i);for(let h=a>>>1;h>o;h--)e(n,h,a,l);const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,e(n,c,h,l)}}function*s(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=i);for(let h=a>>>1;h>o;h--)e(n,h,a,l),yield;const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,e(n,c,h,l),yield}}t.sort=r,t.iterableSort=s})(pD||(pD={}));const pG=pD,r0e=1.5,s0e=1.1;class ct{constructor(e){this.data=[],this._length=0,this._allocator=void 0,this._deallocator=()=>null,this._shrink=()=>{},this._hint=new kB,e&&(e.initialSize&&(this.data=new Array(e.initialSize)),e.allocator&&(this._allocator=e.allocator),e.deallocator!==void 0&&(this._deallocator=e.deallocator),e.shrink&&(this._shrink=()=>fG(this)))}toArray(){return this.data.slice(0,this.length)}getItemAt(e){if(!(e<0||e>=this._length))return this.data[e]}get length(){return this._length}set length(e){if(e>this._length){if(this._allocator){for(;this._length<e;)this.data[this._length++]=this._allocator(this.data[this._length]);return}this._length=e}else{if(this._deallocator)for(let i=e;i<this._length;++i)this.data[i]=this._deallocator(this.data[i]);this._length=e,this._shrink()}}clear(){this.length=0}prune(){this.clear(),this.data=[]}push(e){this.data[this._length++]=e}pushArray(e,i=e.length){for(let r=0;r<i;r++)this.data[this._length++]=e[r]}fill(e,i){for(let r=0;r<i;r++)this.data[this._length++]=e}pushNew(){this._allocator&&(this.data[this.length]=this._allocator(this.data[this.length]));const e=this.data[this._length];return++this._length,e}unshift(e){this.data.unshift(e),this._length++,fG(this)}pop(){if(this.length===0)return;const e=this.data[this.length-1];return this.length=this.length-1,this._shrink(),e}remove(e){const i=VB(this.data,e,this.length,this._hint);if(i!==-1)return this.data.splice(i,1),this.length=this.length-1,e}removeUnordered(e){const i=PC(this.data,e,this.length,this._hint);return i!==void 0&&(this.length=this.length-1),this._shrink(),i}removeUnorderedIndex(e){if(!(e>=this.length||e<0))return this.swapElements(e,this.length-1),this.pop()}removeUnorderedMany(e,i=e.length,r){this.length=Eye(this.data,e,this.length,i,this._hint,r),this._shrink()}front(){if(this.length!==0)return this.data[0]}back(){if(this.length!==0)return this.data[this.length-1]}swapElements(e,i){e>=this.length||i>=this.length||e===i||([this.data[e],this.data[i]]=[this.data[i],this.data[e]])}sort(e){pG.sort(this.data,0,this.length,e)}iterableSort(e){return pG.iterableSort(this.data,0,this.length,e)}some(e,i){for(let r=0;r<this.length;++r)if(e.call(i,this.data[r],r,this.data))return!0;return!1}filterInPlace(e,i){let r=0;for(let s=0;s<this._length;++s){const n=this.data[s];e.call(i,n,s,this.data)&&(this.data[s]=this.data[r],this.data[r]=n,r++)}if(this._deallocator)for(let s=r;s<this._length;s++)this.data[s]=this._deallocator(this.data[s]);return this._length=r,this._shrink(),this}forAll(e,i){const r=this.length,s=this.data;for(let n=0;n<r;++n)e.call(i,s[n],n,s)}forEach(e,i){for(let r=0;r<this.length;++r)e.call(i,this.data[r],r,this.data)}map(e,i){const r=new Array(this.length);for(let s=0;s<this.length;++s)r[s]=e.call(i,this.data[s],s,this.data);return r}reduce(e,i){let r=i;for(let s=0;s<this.length;++s)r=e(r,this.data[s],s,this.data);return r}has(e){const i=this.length,r=this.data;for(let s=0;s<i;++s)if(r[s]===e)return!0;return!1}}function fG(t){t.data.length>r0e*t.length&&(t.data.length=Math.floor(t.length*s0e))}function n0e(t){return{setTimeout:(e,i)=>{const r=t.setTimeout(e,i);return{remove:()=>t.clearTimeout(r)}}}}const BC=n0e(globalThis);function o0e(t,e){return t.replace(/\$\{([^\s\:\}]*)(?:\:([^\s\:\}]+))?\}/g,function(i,r){if(r==="")return"$";const s=zv(r,e),n=s==null?"":s;if(n===void 0)throw new Error(`could not find key "${r}" in template`);return n.toString()})}class GC{constructor(e,i,r){this.name=e,this.details=r,this.message=void 0,this instanceof GC&&(this.message=i&&o0e(i,r)||"")}toString(){return"["+this.name+"]: "+this.message}}class Q extends GC{constructor(e,i,r){if(super(e,i,r),!(this instanceof Q))return new Q(e,i,r)}toJSON(){if(this.details!=null)try{return{name:this.name,message:this.message,details:JSON.parse(JSON.stringify(this.details,(e,i)=>{if(i&&typeof i=="object"&&typeof i.toJSON=="function")return i;try{return ie(i)}catch{return"[object]"}}))}}catch(e){throw le.getLogger("esri.core.Error").error(e),e}return{name:this.name,message:this.message,details:this.details}}static fromJSON(e){return new Q(e.name,e.message,e.details)}}Q.prototype.type="error";function fD(t){return t&&(typeof t.on=="function"||typeof t.addEventListener=="function")}function qC(t,e,i){if(!fD(t))throw new TypeError("target is not a Evented or EventTarget object");if("on"in t)return t.on(e,i);if(Array.isArray(e)){const r=e.slice();for(const s of r)t.addEventListener(s,i);return{remove(){for(const s of r)t.removeEventListener(s,i)}}}return t.addEventListener(e,i),{remove(){t.removeEventListener(e,i)}}}function mG(t,e,i){if(!fD(t))throw new TypeError("target is not a Evented or EventTarget object");if("once"in t)return t.once(e,i);const r=qC(t,e,s=>{r.remove(),i.call(t,s)});return{remove(){r.remove()}}}const a0e={Win:"Meta",Scroll:"ScrollLock",Spacebar:" ",Down:"ArrowDown",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Del:"Delete",Apps:"ContextMenu",Esc:"Escape",Multiply:"*",Add:"+",Subtract:"-",Decimal:".",Divide:"/"};function Fl({key:t}){return a0e[t]||t}function mD(t){return Promise.all(t)}function gG(t){return new Promise((e,i)=>{try{t(e,i)}catch(r){Promise.resolve().then(()=>i(r))}})}function $t(t="Aborted"){return new Q("AbortError",t)}function Dt(t,e="Aborted"){if(Ir(t))throw $t(e)}function HC(t){return _(t)?"aborted"in t?t:t.signal:t}function Ir(t){const e=HC(t);return _(e)&&e.aborted}function Wc(t){if(bi(t))throw t}function gD(t){if(!bi(t))throw t}function ps(t,e){const i=HC(t);if(!A(i)){if(!i.aborted)return mG(i,"abort",()=>e());e()}}function WC(t,e){const i=HC(t);if(!A(i))return Dt(i),mG(i,"abort",()=>e($t()))}function yD(t,e){const i=HC(e);return A(i)?t:new Promise((r,s)=>{let n=ps(e,()=>s($t()));const o=()=>n=ln(n);t.then(o,o),t.then(r,s)})}function bi(t){return t&&t.name==="AbortError"}function vD(t){return t.catch(e=>{if(!bi(e))throw e})}function Jst(t,e=le.getLogger("esri")){return t.catch(i=>{bi(i)||e.error(i)})}function xp(){let t=null;const e=new Promise((i,r)=>{t={promise:void 0,resolve:i,reject:r}});return t.promise=e,t}function En(t){if(!t)return;if(typeof t.forEach!="function"){const i=Object.keys(t);return En(i.map(r=>t[r])).then(r=>{const s={};return i.forEach((n,o)=>s[n]=r[o]),s})}const e=t;return gG(i=>{const r=[];let s=e.length;s===0&&i(r),e.forEach(n=>{const o={promise:n||Promise.resolve(n)};r.push(o),o.promise.then(a=>{o.value=a}).catch(a=>{o.error=a}).then(()=>{--s,s===0&&i(r)})})})}function l0e(t){return En(t).then(e=>e.filter(i=>!!i.value).map(i=>i.value))}function Qst(t){return Promise.reject(t)}function Ww(t){return Promise.resolve(t)}function Zw(t,e,i){const r=new AbortController;return ps(i,()=>r.abort()),new Promise((s,n)=>{let o=setTimeout(()=>{o=0,s(e)},t);ps(r,()=>{o&&(clearTimeout(o),n($t()))})})}function fg(t){return t&&typeof t.then=="function"}function _D(t){return ZC(t)?t:Promise.resolve(t)}function ZC(t){return t&&typeof t=="object"&&"then"in t&&typeof t.then=="function"}function yG(t,e=-1){let i,r,s,n,o=null;const a=(...l)=>{if(i){r=l,n&&n.reject($t()),n=xp();const f=Kr(n.promise);if(o){const g=o;o=null,g.abort()}return f}if(s=n||xp(),n=null,e>0){const f=new AbortController;i=_D(t(...l,f.signal));const g=i;Zw(e).then(()=>{i===g&&(n?f.abort():o=f)})}else i=1,i=_D(t(...l));const c=()=>{const f=r;r=s=i=o=null,f!=null&&a(...f)},h=i,p=s;return h.then(c,c),h.then(p.resolve,p.reject),Kr(p.promise)};return a}function Th(){let t,e;const i=new Promise((s,n)=>{t=s,e=n}),r=s=>{t(s)};return r.resolve=s=>t(s),r.reject=s=>e(s),r.timeout=(s,n)=>BC.setTimeout(()=>r.reject(n),s),r.promise=i,r}function Yst(t,e){return t.then(e,e)}function Jw(t,e){let i,r=new AbortController;const s=t(r.signal);let n={promise:s,finished:!1,abort:()=>{r&&(r.abort(),r=null)}};const o=()=>{n&&(n.finished=!0,n=null),_(i)&&(i.remove(),i=null),r=null};return s.then(o,o),i=ps(e,()=>{_(n)&&n.abort()}),n}function Xst(t){return Promise.resolve().then(()=>{Dt(t)})}function Ft(t){return t}function vG(t){return Ft(1e3*t)}function Ll(t){return t}function c0e(t){return Ll(.001*t)}class u0e{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}}class h0e{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}}let bD=0,wD=0;const Qw={time:Ft(0),deltaTime:Ft(0),elapsedFrameTime:Ft(0),frameDuration:Ft(0)},xD=["prepare","preRender","render","postRender","update"],SD=[],mg=new ct;class d0e{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}}const JC={frameTasks:mg,willDispatch:!1,clearFrameTasks:p0e,dispatch:wG,executeFrameTasks:m0e};function Yw(t){const e=new h0e(t);return SD.push(e),JC.willDispatch||(JC.willDispatch=!0,Nv(wG)),e}function gg(t){const e=new u0e(t);return mg.push(e),QC==null&&(bD=performance.now(),QC=requestAnimationFrame(_G)),new d0e(e)}let QC=null;function p0e(t=!1){mg.forAll(e=>{e.removed=!0}),t&&bG()}function f0e(t){wD=Math.max(0,t)}function _G(){const t=performance.now();QC=null,QC=mg.length>0?requestAnimationFrame(_G):null,JC.executeFrameTasks(t)}function m0e(t){const e=Ft(t-bD);bD=t;const i=wD>0?wD:1e3/60,r=Math.max(0,e-i);for(let s=0;s<xD.length;s++){const n=performance.now(),o=xD[s];mg.forAll(a=>{var l;a.paused||a.removed||(s===0&&a.ticks++,a.phases[o]&&(Qw.time=t,Qw.deltaTime=a.ticks===0?Ft(0):e,Qw.elapsedFrameTime=Ft(performance.now()-t),Qw.frameDuration=Ft(i-r),(l=a.phases[o])==null||l.call(a,Qw)))}),y0e[s].record(performance.now()-n)}bG(),v0e.record(performance.now()-t)}const YC=new ct;function bG(){mg.forAll(t=>{t.removed&&YC.push(t)}),mg.removeUnorderedMany(YC.data,YC.length),YC.clear()}function wG(){for(;SD.length;){const t=Kr(SD.shift());t.isActive&&t.callback()}JC.willDispatch=!1}function g0e(t=1,e){const i=Th(),r=()=>{Ir(e)?i.reject($t()):t===0?i():(--t,Nv(()=>r()))};return r(),i.promise}const y0e=xD.map(t=>new wp(t)),v0e=new wp("total");function xG(t,e){for(const i of t.entries())if(e(i[0]))return!0;return!1}let _0e=0;const b0e=0;function On(){return++_0e}class XC{constructor(e){this._notify=e,this._accessed=[],this._handles=[],this._invalidCount=0}destroy(){this._accessed.length=0,this.clear()}onInvalidated(){this._invalidCount++}onCommitted(){const e=this._invalidCount;if(e===1)return this._invalidCount=0,void this._notify();this._invalidCount=e>0?e-1:0}onObservableAccessed(e){this._accessed.includes(e)||this._accessed.push(e)}onTrackingEnd(){const e=this._handles,i=this._accessed;for(let r=0;r<i.length;++r)e.push(i[r].observe(this));i.length=0}clear(){const e=this._handles;for(let i=0;i<e.length;++i)e[i].remove();e.length=0}}let Uv=!1;const KC=[];function SG(t,e){let i=new XC(n),r=null,s=!1;function n(){if(!i||s)return;if(Uv)return void MG(n);const a=r;i.clear(),Uv=!0,s=!0,r=Sh(i,t),s=!1,Uv=!1,e(r,a),PG()}function o(){i&&(i.destroy(),i=null,r=null)}return s=!0,r=Sh(i,t),s=!1,{remove:o}}function TG(t,e){let i=new XC(s),r=null;function s(){e(r,o)}function n(){i&&(i.destroy(),i=null),r=null}function o(){return i?(i.clear(),r=Sh(i,t),r):null}return o(),{remove:n}}function CG(t){let e=new XC(r),i=!1;function r(){e&&!i&&(Uv?MG(r):(e.clear(),Uv=!0,i=!0,Sh(e,t),i=!1,Uv=!1,PG()))}function s(){e&&(e.destroy(),e=null)}return i=!0,Sh(e,t),i=!1,{remove:s}}function MG(t){KC.includes(t)||KC.unshift(t)}function PG(){for(;KC.length;)KC.pop()()}class Xw{constructor(){this.uid=On(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,i,r,s,n){return this.pool.acquire(0,e,i,r,s,n,OC)}static acquireTracked(e,i,r,s){return this.pool.acquire(1,e,i,r,null,null,s)}notify(e,i){this.type===0?this.callback.call(this.target,e,i,this.path,this.target):this.callback.call(null,e,i)}acquire(e,i,r,s,n,o,a){this.uid=On(),this.removed=!1,this.type=e,this.oldValue=i,this.callback=r,this.getValue=s,this.target=n,this.path=o,this.equals=a}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=On(),this.removed=!0}}Xw.pool=new dG(Xw);const eM=new uo,Ch=new Set;let tM;function iM(t){Ch.delete(t),Ch.add(t),tM||(tM=Yw(S0e))}function w0e(t){if(t.removed)return;const e=t.oldValue,i=t.getValue();t.equals(e,i)||(t.oldValue=i,t.notify(i,e))}function x0e(t){for(const e of Ch.values())e.target===t&&(e.removed=!0)}function S0e(){let t=10;for(;tM&&t--;){tM=null;const e=T0e(),i=eM.acquire();for(const r of e){const s=r.uid;w0e(r),s===r.uid&&r.removed&&i.push(r)}for(const r of Ch)r.removed&&(i.push(r),Ch.delete(r));for(const r of i)Xw.pool.release(r);eM.release(i),eM.release(e),TD.forEach(r=>r())}}function T0e(){const t=eM.acquire();t.length=Ch.size;let e=0;for(const i of Ch)t[e]=i,++e;return Ch.clear(),t}const TD=new Set;function AG(t){return TD.add(t),{remove(){TD.delete(t)}}}function C0e(t,e,i){let r=KB(t,e,i,(s,n,o)=>{let a,l,c=TG(()=>Vv(s,n),(h,p)=>{s.__accessor__.destroyed||a&&a.uid!==l?r.remove():(a||(a=Xw.acquireUntracked(h,o,p,s,n),l=a.uid),iM(a))});return{remove:lD(()=>{c.remove(),a&&(a.uid!==l||a.removed||(a.removed=!0,iM(a)),a=null),r=c=null})}});return r}function M0e(t,e,i){const r=KB(t,e,i,(s,n,o)=>{let a=!1;return SG(()=>Vv(s,n),(l,c)=>{s.__accessor__.destroyed?r.remove():a||(a=!0,OC(c,l)||o.call(s,l,c,n,s),a=!1)})});return r}function P0e(t,e,i,r=!1){return!t.__accessor__||t.__accessor__.destroyed?{remove(){}}:r?M0e(t,e,i):C0e(t,e,i)}function A0e(t,e,i){let r,s,n=TG(t,(o,a)=>{r&&r.uid!==s?n.remove():(r||(r=Xw.acquireTracked(o,e,a,i),s=r.uid),iM(r))});return{remove:lD(()=>{n.remove(),r&&(r.uid!==s||r.removed||(r.removed=!0,iM(r)),r=null),n=null})}}function $0e(t,e,i){let r=!1;return SG(t,(s,n)=>{r||(r=!0,i(n,s)||e(s,n),r=!1)})}function E0e(t,e,i=!1,r=OC){return i?$0e(t,e,r):A0e(t,e,r)}function $G(t){return xG(Ch,e=>e.oldValue===t)}function vr(t,e){for(const[i,r]of t)if(e(r,i))return!0;return!1}function Kst(t,e){for(const[i,r]of t)if(e(r,i))return r;return null}function EG(t,e,i){const r=t.get(e);if(r!==void 0)return r;const s=i();return t.set(e,s),s}const jv=le.getLogger("esri.core.Accessor");function O0e(t){return t==null?t:new Date(t)}function R0e(t){return t==null?t:!!t}function Kw(t){return t==null?t:t.toString()}function kl(t){return t==null?t:(t=parseFloat(t),isNaN(t)?0:t)}function CD(t){return t==null?t:Math.round(parseFloat(t))}function OG(t){return t&&t.constructor&&t.constructor.__accessorMetadata__!==void 0}function rM(t,e){return e!=null&&t&&!(e instanceof t)}function RG(t){return t&&"isCollection"in t}function IG(t){return t&&t.Type?typeof t.Type=="function"?t.Type:t.Type.base:null}function I0e(t,e){if(!e||!e.constructor||!RG(e.constructor))return MD(t,e)?e:new t(e);const i=IG(t.prototype.itemType),r=IG(e.constructor.prototype.itemType);return i?r?i===r?e:i.prototype.isPrototypeOf(r.prototype)?new t(e):(MD(t,e),e):new t(e):e}function MD(t,e){return!!OG(e)&&(jv.error("Accessor#set","Assigning an instance of '"+(e.declaredClass||"unknown")+"' which is not a subclass of '"+sM(t)+"'"),!0)}function Bv(t,e){return e==null?e:RG(t)?I0e(t,e):rM(t,e)?MD(t,e)?e:new t(e):e}function sM(t){return t&&t.prototype&&t.prototype.declaredClass||"unknown"}const D0e=new WeakMap;function F0e(t){switch(t){case Number:return kl;case Oi:return CD;case Boolean:return R0e;case String:return Kw;case Date:return O0e;default:return EG(D0e,t,()=>Bv.bind(null,t))}}function Ni(t,e){const i=F0e(t);return arguments.length===1?i:i(e)}function ex(t,e,i){return arguments.length===1?ex.bind(null,t):e&&(Array.isArray(e)?e.map(r=>t(r,i)):[t(e,i)])}function L0e(t,e){return arguments.length===1?ex(Ni.bind(null,t)):ex(Ni.bind(null,t),e)}function DG(t,e,i){return e!==0&&Array.isArray(i)?i.map(r=>DG(t,e-1,r)):t(i)}function nM(t,e,i){if(arguments.length===2)return nM.bind(null,t,e);if(!i)return i;let r=e,s=i=DG(t,e,i);for(;r>0&&Array.isArray(s);)r--,s=s[0];if(s!==void 0)for(let n=0;n<r;n++)i=[i];return i}function k0e(t,e,i){return arguments.length===2?nM(Ni.bind(null,t),e):nM(Ni.bind(null,t),e,i)}function FG(t){return!!Array.isArray(t)&&!t.some(e=>{const i=typeof e;return!(i==="string"||i==="number"||i==="function"&&t.length>1)})}function PD(t,e){if(arguments.length===2)return PD(t).call(null,e);const i=new Set,r=t.filter(a=>typeof a!="function"),s=t.filter(a=>typeof a=="function");for(const a of t)typeof a!="string"&&typeof a!="number"||i.add(a);let n=null,o=null;return(a,l)=>{if(a==null)return a;const c=typeof a,h=c==="string"||c==="number";return h&&(i.has(a)||s.some(p=>c==="string"&&p===String||c==="number"&&p===Number))||c==="object"&&s.some(p=>!rM(a,p))?a:(h&&r.length?(n||(n=r.map(p=>typeof p=="string"?`'${p}'`:`${p}`).join(", ")),jv.error("Accessor#set",`'${a}' is not a valid value for this property, only the following values are valid: ${n}`)):typeof a=="object"&&s.length?(o||(o=s.map(p=>sM(p)).join(", ")),jv.error("Accessor#set",`'${a}' is not a valid value for this property, value must be one of ${o}`)):jv.error("Accessor#set",`'${a}' is not a valid value for this property`),l&&(l.valid=!1),null)}}function Zc(t,e){if(arguments.length===2)return Zc(t).call(null,e);const i={},r=[],s=[];for(const l in t.typeMap){const c=t.typeMap[l];i[l]=Ni(c),r.push(sM(c)),s.push(l)}const n=()=>`'${r.join("', '")}'`,o=()=>`'${s.join("', '")}'`,a=typeof t.key=="string"?l=>l[t.key]:t.key;return l=>{if(t.base&&!rM(t.base,l)||l==null)return l;const c=a(l)||t.defaultKeyValue,h=i[c];if(!h)return jv.error("Accessor#set",`Invalid property value, value needs to be one of ${n()}, or a plain object that can autocast (having .type = ${o()})`),null;if(!rM(t.typeMap[c],l))return l;if(typeof t.key=="string"&&!OG(l)){const p={};for(const f in l)f!==t.key&&(p[f]=l[f]);return h(p)}return h(l)}}class Oi{}const ent={native:t=>({type:"native",value:t}),array:t=>({type:"array",value:t}),oneOf:t=>({type:"one-of",values:t})};function z0e(t){if(!t||!("type"in t))return!1;switch(t.type){case"native":case"array":case"one-of":return!0}return!1}function LG(t){switch(t.type){case"native":return Ni(t.value);case"array":return ex(LG(t.value));case"one-of":return V0e(t);default:return null}}function V0e(t){let e=null;return(i,r)=>$D(i,t)?i:(e==null&&(e=AD(t)),jv.error("Accessor#set",`Invalid property value, value needs to be of type ${e}`),r&&(r.valid=!1),null)}function AD(t){switch(t.type){case"native":switch(t.value){case Number:return"number";case String:return"string";case Boolean:return"boolean";case Oi:return"integer";case Date:return"date";default:return sM(t.value)}case"array":return`array of ${AD(t.value)}`;case"one-of":{const e=t.values.map(i=>AD(i));return`one of ${e.slice(0,e.length-1)} or ${e[e.length-1]}`}}return"unknown"}function $D(t,e){if(t==null)return!0;switch(e.type){case"native":switch(e.value){case Number:case Oi:return typeof t=="number";case Boolean:return typeof t=="boolean";case String:return typeof t=="string"}return t instanceof e.value;case"array":return!!Array.isArray(t)&&!t.some(i=>!$D(i,e.value));case"one-of":return e.values.some(i=>$D(t,i))}}function d(t={}){return(e,i)=>{if(e===Function.prototype)throw new Error(`Inappropriate use of @property() on a static field: ${e.name}.${i}. Accessor does not support static properties.`);const r=Object.getOwnPropertyDescriptor(e,i),s=FC(e,i);r&&(r.get||r.set?(s.get=r.get||s.get,s.set=r.set||s.set):"value"in r&&("value"in t&&le.getLogger("esri.core.accessorSupport.decorators.property").warn(`@property() will redefine the value of "${i}" on "${e.constructor.name}" already defined in the metadata`,t),s.value=t.value=r.value)),t.readOnly!=null&&(s.readOnly=t.readOnly);const n=t.aliasOf;if(n){const l=typeof n=="string"?n:n.source,c=typeof n=="string"?null:n.overridable===!0;let h;s.dependsOn=[l],s.get=function(){let p=DC(this,l);if(typeof p=="function"){h||(h=l.split(".").slice(0,-1).join("."));const f=DC(this,h);f&&(p=p.bind(f))}return p},s.readOnly||(s.set=c?function(p){p!==void 0?this._override(i,p):this._clearOverride(i)}:function(p){UC(this,l,p)})}const o=t.type,a=t.types;s.cast||(o?s.cast=N0e(o):a&&(Array.isArray(a)?s.cast=ex(Zc(a[0])):s.cast=Zc(a))),t.range&&(s.cast=U0e(s.cast,t.range)),Hye(s,t)}}function kG(t,e,i){const r=FC(t,i);r.json||(r.json={});let s=r.json;return e!==void 0&&(s.origins||(s.origins={}),s.origins[e]||(s.origins[e]={}),s=s.origins[e]),s}function N0e(t){let e=0,i=t;if(z0e(t))return LG(t);for(;Array.isArray(i)&&i.length===1&&typeof i[0]!="string"&&typeof i[0]!="number";)i=i[0],e++;const r=i;if(FG(r))return e===0?PD(r):nM(PD(r),e);if(e===1)return L0e(r);if(e>1)return k0e(r,e);const s=t;return s.from?s.from:Ni(s)}function U0e(t,e){return i=>{let r=+t(i);return e.step!=null&&(r=Math.round(r/e.step)*e.step),e.min!=null&&(r=Math.max(e.min,r)),e.max!=null&&(r=Math.min(e.max,r)),r}}function j0e(t){if(t.json&&t.json.origins){const e=t.json.origins,i={"web-document":["web-scene","web-map"]};for(const r in i)if(e[r]){const s=e[r];i[r].forEach(n=>{e[n]=s}),delete e[r]}}}class Go extends GC{constructor(e,i,r){if(super(e,i,r),!(this instanceof Go))return new Go(e,i,r)}}Go.prototype.type="warning";function zG(t){return!!t&&t.prototype&&t.prototype.declaredClass&&t.prototype.declaredClass.indexOf("esri.core.Collection")===0}const ED=le.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function VG(t,e,i){var r,s;t&&(!i&&!e.read||(r=e.read)!=null&&r.reader||((s=e.read)==null?void 0:s.enabled)===!1||q0e(t)&&Bo("read.reader",Gv(t),e))}function Gv(t){var e;const i=(e=t.ndimArray)!=null?e:0;if(i>1)return G0e(t);if(i===1)return UG(t);if("type"in t&&jG(t.type)){var r,s;const n=(r=t.type.prototype)==null||(s=r.itemType)==null?void 0:s.Type,o=UG(typeof n=="function"?{type:n}:{types:n});return(a,l,c)=>{const h=o(a,l,c);return h&&new t.type(h)}}return OD(t)}function OD(t){return"type"in t?B0e(t.type):H0e(t.types)}function B0e(t){return t.prototype.read?(e,i,r)=>{if(e==null)return e;const s=typeof e;if(s!=="object")return void ED.error(`Expected JSON value of type 'object' to deserialize type '${t.prototype.declaredClass}', but got '${s}'`);const n=new t;return n.read(e,r),n}:t.fromJSON}function NG(t,e,i,r){return r!==0&&Array.isArray(e)?e.map(s=>NG(t,s,i,r-1)):t(e,void 0,i)}function G0e(t){var e;const i=OD(t),r=NG.bind(null,i),s=(e=t.ndimArray)!=null?e:0;return(n,o,a)=>{if(n==null)return n;n=r(n,a,s);let l=s,c=n;for(;l>0&&Array.isArray(c);)l--,c=c[0];if(c!==void 0)for(let h=0;h<l;h++)n=[n];return n}}function UG(t){const e=OD(t);return(i,r,s)=>{if(i==null)return i;if(Array.isArray(i)){const o=[];for(const a of i){const l=e(a,void 0,s);l!==void 0&&o.push(l)}return o}const n=e(i,void 0,s);return n!==void 0?[n]:void 0}}function jG(t){if(!zG(t))return!1;const e=t.prototype.itemType;return!(!e||!e.Type)&&(typeof e.Type=="function"?RD(e.Type):BG(e.Type))}function q0e(t){return"types"in t?BG(t.types):RD(t.type)}function RD(t){return!Array.isArray(t)&&!!t&&t.prototype&&("read"in t.prototype||"fromJSON"in t||jG(t))}function BG(t){for(const e in t.typeMap)if(!RD(t.typeMap[e]))return!1;return!0}function H0e(t){var e;let i=null;const r=(e=t.errorContext)!=null?e:"type";return(s,n,o)=>{if(s==null)return s;const a=typeof s;if(a!=="object")return void ED.error(`Expected JSON value of type 'object' to deserialize, but got '${a}'`);i||(i=W0e(t));const l=t.key;if(typeof l!="string")return;const c=s[l],h=c?i[c]:t.defaultKeyValue?t.typeMap[t.defaultKeyValue]:void 0;if(!h){const f=`Type '${c||"unknown"}' is not supported`;return o&&o.messages&&s&&o.messages.push(new Go(`${r}:unsupported`,f,{definition:s,context:o})),void ED.error(f)}const p=new h;return p.read(s,o),p}}function W0e(t){const e={};for(const s in t.typeMap){var i,r;const n=t.typeMap[s],o=qw(n.prototype);if(typeof t.key=="function")continue;const a=o.properties[t.key];if(!a)continue;(i=a.json)!=null&&i.type&&Array.isArray(a.json.type)&&a.json.type.length===1&&typeof a.json.type[0]=="string"&&(e[a.json.type[0]]=n);const l=(r=a.json)==null?void 0:r.write;if(!l||!l.writer){e[s]=n;continue}const c=l.target,h=typeof c=="string"?c:t.key,p={};l.writer(s,p,h),p[h]&&(e[p[h]]=n)}return e}function Z0e(t){if(t.json||(t.json={}),qG(t.json),HG(t.json),GG(t.json),t.json.origins)for(const e in t.json.origins)qG(t.json.origins[e]),HG(t.json.origins[e]),GG(t.json.origins[e]);return!0}function GG(t){t.name&&(t.read&&typeof t.read=="object"?t.read.source===void 0&&(t.read.source=t.name):t.read={source:t.name},t.write&&typeof t.write=="object"?t.write.target===void 0&&(t.write.target=t.name):t.write={target:t.name})}function qG(t){typeof t.read=="boolean"?t.read={enabled:t.read}:typeof t.read=="function"?t.read={enabled:!0,reader:t.read}:t.read&&typeof t.read=="object"&&t.read.enabled===void 0&&(t.read.enabled=!0)}function HG(t){typeof t.write=="boolean"?t.write={enabled:t.write}:typeof t.write=="function"?t.write={enabled:!0,writer:t.write}:t.write&&typeof t.write=="object"&&t.write.enabled===void 0&&(t.write.enabled=!0)}const J0e=le.getLogger("esri.core.accessorSupport.extensions.serializableProperty.writer");function WG(t,e){var i;if(!e.write||e.write.writer||e.write.enabled===!1&&!e.write.overridePolicy)return;const r=(i=t==null?void 0:t.ndimArray)!=null?i:0;t&&(r===1||"type"in t&&zG(t.type))?e.write.writer=X0e:r>1?e.write.writer=K0e(r):e.types?Array.isArray(e.types)?e.write.writer=Y0e(e.types[0]):e.write.writer=Q0e(e.types):e.write.writer=tx}function Q0e(t){return(e,i,r,s)=>e?ZG(e,t,s)?tx(e,i,r,s):void 0:tx(e,i,r,s)}function ZG(t,e,i){for(const n in e.typeMap)if(t instanceof e.typeMap[n])return!0;if(i!=null&&i.messages){var r,s;const n=(r=e.errorContext)!=null?r:"type",o=`Values of type '${(s=typeof e.key!="function"?t[e.key]:t.declaredClass)!=null?s:"Unknown"}' cannot be written`;i&&i.messages&&t&&i.messages.push(new Q(`${n}:unsupported`,o,{definition:t,context:i})),J0e.error(o)}return!1}function Y0e(t){return(e,i,r,s)=>!e||!Array.isArray(e)?tx(e,i,r,s):tx(e.filter(n=>ZG(n,t,s)),i,r,s)}function tx(t,e,i,r){Bo(i,oM(t,r),e)}function oM(t,e){return t&&typeof t.write=="function"?t.write({},e):t&&typeof t.toJSON=="function"?t.toJSON():typeof t=="number"?aM(t):t}function aM(t){return t===-1/0?-Number.MAX_VALUE:t===1/0?Number.MAX_VALUE:isNaN(t)?null:t}function X0e(t,e,i,r){let s;t===null?s=null:t&&typeof t.map=="function"?(s=t.map(n=>oM(n,r)),typeof s.toArray=="function"&&(s=s.toArray())):s=[oM(t,r)],Bo(i,s,e)}function JG(t,e,i){return i!==0&&Array.isArray(t)?t.map(r=>JG(r,e,i-1)):oM(t,e)}function K0e(t){return function(e,i,r,s){let n;if(e===null)n=null;else{n=JG(e,s,t);let o=t,a=n;for(;o>0&&Array.isArray(a);)o--,a=a[0];if(a!==void 0)for(let l=0;l<o;l++)n=[n]}Bo(r,n,i)}}function ID(t,e){return DD(t,"read",e)}function QG(t,e){return DD(t,"write",e)}function DD(t,e,i){let r=t&&t.json;if(t&&t.json&&t.json.origins&&i){const s=t.json.origins[i.origin];s&&(e==="any"||e in s)&&(r=s)}return r}function eve(t){const e=tve(t);if(t.json.origins)for(const i in t.json.origins){const r=t.json.origins[i],s=r.types?ive(r):e;VG(s,r,!1),r.types&&!r.write&&t.json.write&&t.json.write.enabled&&(r.write=E({},t.json.write)),WG(s,r)}VG(e,t.json,!0),WG(e,t.json)}function tve(t){return t.json.types?FD(t.json):t.type?YG(t):FD(t)}function ive(t){return t.type?YG(t):FD(t)}function YG(t){if(!t.type)return;let e=0,i=t.type;for(;Array.isArray(i)&&!FG(i);)i=i[0],e++;return{type:i,ndimArray:e}}function FD(t){if(!t.types)return;let e=0,i=t.types;for(;Array.isArray(i);)i=i[0],e++;return{types:i,ndimArray:e}}function rve(t){Z0e(t)&&(j0e(t),eve(t))}const LD=new Set,kD=new Set;function R(t){return e=>{e.prototype.declaredClass=t,nve(e);const i=[],r=[];let s=e.prototype;for(;s;)s.hasOwnProperty("initialize")&&!LD.has(s.initialize)&&(LD.add(s.initialize),i.push(s.initialize)),s.hasOwnProperty("destroy")&&!kD.has(s.destroy)&&(kD.add(s.destroy),r.push(s.destroy)),s=Object.getPrototypeOf(s);LD.clear(),kD.clear();class n extends e{constructor(...a){if(super(...a),this.constructor===n&&typeof this.postscript=="function"){if(i.length&&Object.defineProperty(this,"initialize",{enumerable:!1,configurable:!0,value(){for(let l=i.length-1;l>=0;l--)i[l].call(this)}}),r.length){let l=!1;Object.defineProperty(this,"destroy",{enumerable:!1,configurable:!0,value(){if(!l){l=!0;for(let c=0;c<r.length;c++)r[c].call(this)}}})}this.postscript(...a)}}}return n.__accessorMetadata__=qw(e.prototype),n.prototype.declaredClass=t,n}}function sve(t,e){return e.get==null?function(){const i=this.__accessor__.properties.get(t);if(i===void 0)return;bt(i);const r=this.__accessor__.store;return r.has(t)?r.get(t):i.metadata.value}:function(){const i=this.__accessor__.properties.get(t);if(i!==void 0)return i.getComputed()}}function nve(t){const e=t.prototype,i=qw(e).properties,r={};for(const s of Object.getOwnPropertyNames(i)){const n=i[s];rve(n),r[s]={enumerable:!0,configurable:!0,get:sve(s,n),set(o){const a=this.__accessor__;if(a!==void 0){if(!Object.isFrozen(this)){if(a.initialized&&n.readOnly)throw new TypeError(`[accessor] cannot assign to read-only property '${s}' of ${this.declaredClass}`);if(a.lifecycle===2&&n.constructOnly)throw new TypeError(`[accessor] cannot assign to construct-only property '${s}' of ${this.declaredClass}`);a.set(s,o)}}else Object.defineProperty(this,s,{enumerable:!0,configurable:!0,writable:!0,value:o})}}}Object.defineProperties(t.prototype,r)}function ove(t){if(t==null)return{value:t};if(Array.isArray(t))return{type:[t[0]],value:null};switch(typeof t){case"object":return t.constructor&&t.constructor.__accessorMetadata__||t instanceof Date?{type:t.constructor,value:t}:t;case"boolean":return{type:Boolean,value:t};case"string":return{type:String,value:t};case"number":return{type:Number,value:t};case"function":return{type:t,value:null};default:return}}class ve{constructor(...e){if(this.constructor===ve)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");Object.defineProperty(this,"__accessor__",{enumerable:!1,value:new e0e(this)}),e.length>0&&this.normalizeCtorArgs&&(this.__accessor__.ctorArgs=this.normalizeCtorArgs.apply(this,e))}static createSubclass(e={}){if(Array.isArray(e))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:i,declaredClass:r,constructor:s}=e;delete e.declaredClass,delete e.properties,delete e.constructor;const n=this;class o extends n{constructor(...l){super(...l),this.inherited=null,s&&s.apply(this,l)}}qw(o.prototype);for(const a in e){const l=e[a];o.prototype[a]=typeof l=="function"?function(...c){const h=this.inherited;let p;this.inherited=function(...f){if(n.prototype[a])return n.prototype[a].apply(this,f)};try{p=l.apply(this,c)}catch(f){throw this.inherited=h,f}return this.inherited=h,p}:e[a]}for(const a in i){const l=ove(i[a]);d(l)(o.prototype,a)}return R(r)(o)}postscript(e){const i=this.__accessor__,r=i.ctorArgs||e;i.initialize(),r&&(this.set(r),i.ctorArgs=null),i.constructed(),this.initialize()}initialize(){}destroy(){this.destroyed||(x0e(this),this.__accessor__.destroy())}get initialized(){return this.__accessor__&&this.__accessor__.initialized||!1}get constructed(){return this.__accessor__&&this.__accessor__.lifecycle===2||!1}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}commitProperty(e){this.get(e)}get(e){return DC(this,e)}hasOwnProperty(e){return this.__accessor__?this.__accessor__.has(e):Object.prototype.hasOwnProperty.call(this,e)}isInstanceOf(e){return kv(le.getLogger(this.declaredClass),"isInstanceOf",{replacement:"Use instanceof directly",version:"4.16"}),this instanceof e}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(e,i){return UC(this,e,i),this}watch(e,i,r){return P0e(this,e,i,r)}_clearOverride(e){return this.__accessor__.clearOverride(e)}_override(e,i){return this.__accessor__.override(e,i)}_isOverridden(e){return this.__accessor__.isOverridden(e)}notifyChange(e){this.__accessor__.notifyChange(e)}_get(e){return this.__accessor__.internalGet(e)}_set(e,i){return this.__accessor__.internalSet(e,i),this}}class qv{constructor(){this._emitter=new qv.EventEmitter(this)}emit(e,i){return this._emitter.emit(e,i)}on(e,i){return this._emitter.on(e,i)}once(e,i){return this._emitter.once(e,i)}hasEventListener(e){return this._emitter.hasEventListener(e)}}(function(t){class e{constructor(s=null){this.target=s,this._listenersMap=null}clear(){this._listenersMap&&this._listenersMap.clear(),this._listenersMap=null}emit(s,n){const o=this._listenersMap&&this._listenersMap.get(s);if(!o)return!1;const a=this.target||this;return[...o].forEach(l=>{l.call(a,n)}),o.length>0}on(s,n){if(Array.isArray(s)){const a=s.map(l=>this.on(l,n));return Gw(a)}if(s.indexOf(",")>-1)throw new TypeError("Evented.on() with a comma delimited string of event types is not supported");this._listenersMap||(this._listenersMap=new Map);const o=this._listenersMap.get(s)||[];return o.push(n),this._listenersMap.set(s,o),{remove:()=>{const a=this._listenersMap&&this._listenersMap.get(s)||[],l=a.indexOf(n);l>=0&&a.splice(l,1)}}}once(s,n){const o=this.on(s,a=>{o.remove(),n.call(null,a)});return o}hasEventListener(s){const n=this._listenersMap&&this._listenersMap.get(s);return n!=null&&n.length>0}}t.EventEmitter=e,t.EventedMixin=r=>{let s=class extends r{constructor(){super(...arguments),this._emitter=new e}destroy(){this._emitter.clear()}emit(n,o){return this._emitter.emit(n,o)}on(n,o){return this._emitter.on(n,o)}once(n,o){return this._emitter.once(n,o)}hasEventListener(n){return this._emitter.hasEventListener(n)}};return s=u([R("esri.core.Evented")],s),s};let i=class extends ve{constructor(){super(...arguments),this._emitter=new qv.EventEmitter(this)}destroy(){this._emitter.clear()}emit(r,s){return this._emitter.emit(r,s)}on(r,s){return this._emitter.on(r,s)}once(r,s){return this._emitter.once(r,s)}hasEventListener(r){return this._emitter.hasEventListener(r)}};i=u([R("esri.core.Evented")],i),t.EventedAccessor=i})(qv||(qv={}));const Ci=qv;function zD(t){return(e,i)=>{e[i]=t}}class ave{constructor(){this._observers=[]}observe(e){return this._observers.includes(e)||this._observers.push(e),new cG(this._observers,e)}notify(){const e=this._observers.slice();for(let i=0;i<e.length;++i){const r=e[i];r.onInvalidated(),r.onCommitted()}}}var Mh;class lve{constructor(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1,this.item=void 0,this.type=void 0}preventDefault(){this.cancellable&&(this.defaultPrevented=!0)}reset(e){this.defaultPrevented=!1,this.item=e}}const Oa=new Xi(lve,void 0,t=>{t.item=null,t.target=null,t.defaultPrevented=!1,t.cancellable=!1}),cve=()=>{};function VD(t){return t?t instanceof yg?t.toArray():t.length?Array.prototype.slice.apply(t):[]:[]}function ND(t){if(t&&t.length)return t[0]}function uve(t,e,i,r){const s=Math.min(t.length-i,e.length-r);let n=0;for(;n<s&&t[i+n]===e[r+n];)n++;return n}function XG(t,e,i,r){e&&e.forEach((s,n,o)=>{t.push(s),XG(t,i.call(r,s,n,o),i,r)})}const Sp=new Set,Tp=new Set,Cp=new Set,UD=new Map;let hve=0,yg=Mh=class extends Ci.EventedAccessor{constructor(t){super(t),this._chgListeners=[],this._notifications=null,this._timer=null,this._observable=new ave,this.length=0,this._items=[],Object.defineProperty(this,"uid",{value:hve++})}static isCollection(t){return t!=null&&t instanceof Mh}normalizeCtorArgs(t){return t?Array.isArray(t)||t instanceof Mh?{items:t}:t:{}}destroy(){this.removeAll()}*[Symbol.iterator](){yield*this.items}get items(){return bt(this._observable),this._items}set items(t){this._emitBeforeChanges(1)||(this._splice(0,this.length,VD(t)),this._emitAfterChanges(1))}hasEventListener(t){return t==="change"?this._chgListeners.length>0:this._emitter.hasEventListener(t)}on(t,e){if(t==="change"){const i=this._chgListeners,r={removed:!1,callback:e};return i.push(r),this._notifications&&this._notifications.push({listeners:i.slice(),items:this._items.slice(),changes:[]}),{remove(){this.remove=cve,r.removed=!0,i.splice(i.indexOf(r),1)}}}return this._emitter.on(t,e)}once(t,e){const i=this.on(t,e);return{remove(){i.remove()}}}add(t,e){if(bt(this._observable),this._emitBeforeChanges(1))return this;const i=this.getNextIndex(e!=null?e:null);return this._splice(i,0,[t]),this._emitAfterChanges(1),this}addMany(t,e=this._items.length){if(bt(this._observable),!t||!t.length)return this;if(this._emitBeforeChanges(1))return this;const i=this.getNextIndex(e);return this._splice(i,0,VD(t)),this._emitAfterChanges(1),this}removeAll(){if(bt(this._observable),!this.length||this._emitBeforeChanges(2))return[];const t=this._splice(0,this.length)||[];return this._emitAfterChanges(2),t}clone(){return bt(this._observable),this._createNewInstance({items:this._items.map(ie)})}concat(...t){bt(this._observable);const e=t.map(VD);return this._createNewInstance({items:this._items.concat(...e)})}drain(t,e){if(bt(this._observable),!this.length||this._emitBeforeChanges(2))return;const i=Kr(this._splice(0,this.length)),r=i.length;for(let s=0;s<r;s++)t.call(e,i[s],s,i);this._emitAfterChanges(2)}every(t,e){return bt(this._observable),this._items.every(t,e)}filter(t,e){let i;return bt(this._observable),i=arguments.length===2?this._items.filter(t,e):this._items.filter(t),this._createNewInstance({items:i})}find(t,e){return bt(this._observable),this._items.find(t,e)}findIndex(t,e){return bt(this._observable),this._items.findIndex(t,e)}flatten(t,e){bt(this._observable);const i=[];return XG(i,this,t,e),new Mh(i)}forEach(t,e){return bt(this._observable),this._items.forEach(t,e)}getItemAt(t){return bt(this._observable),this._items[t]}getNextIndex(t){bt(this._observable);const e=this.length;return(t=t==null?e:t)<0?t=0:t>e&&(t=e),t}includes(t,e=0){return bt(this._observable),this._items.includes(t,e)}indexOf(t,e=0){return bt(this._observable),this._items.indexOf(t,e)}join(t=","){return bt(this._observable),this._items.join(t)}lastIndexOf(t,e=this.length-1){return bt(this._observable),this._items.lastIndexOf(t,e)}map(t,e){bt(this._observable);const i=this._items.map(t,e);return new Mh({items:i})}reorder(t,e=this.length-1){bt(this._observable);const i=this.indexOf(t);if(i!==-1){if(e<0?e=0:e>=this.length&&(e=this.length-1),i!==e){if(this._emitBeforeChanges(4))return t;this._splice(i,1),this._splice(e,0,[t]),this._emitAfterChanges(4)}return t}}pop(){if(bt(this._observable),!this.length||this._emitBeforeChanges(2))return;const t=ND(this._splice(this.length-1,1));return this._emitAfterChanges(2),t}push(...t){return bt(this._observable),this._emitBeforeChanges(1)||(this._splice(this.length,0,t),this._emitAfterChanges(1)),this.length}reduce(t,e){bt(this._observable);const i=this._items;return arguments.length===2?i.reduce(t,e):i.reduce(t)}reduceRight(t,e){bt(this._observable);const i=this._items;return arguments.length===2?i.reduceRight(t,e):i.reduceRight(t)}remove(t){return bt(this._observable),this.removeAt(this.indexOf(t))}removeAt(t){if(bt(this._observable),t<0||t>=this.length||this._emitBeforeChanges(2))return;const e=ND(this._splice(t,1));return this._emitAfterChanges(2),e}removeMany(t){if(bt(this._observable),!t||!t.length||this._emitBeforeChanges(2))return[];const e=t instanceof Mh?t.toArray():t,i=this._items,r=[],s=e.length;for(let n=0;n<s;n++){const o=e[n],a=i.indexOf(o);if(a>-1){const l=1+uve(e,i,n+1,a+1),c=this._splice(a,l);c&&c.length>0&&r.push.apply(r,c),n+=l-1}}return this._emitAfterChanges(2),r}reverse(){if(bt(this._observable),this._emitBeforeChanges(4))return this;const t=this._splice(0,this.length);return t&&(t.reverse(),this._splice(0,0,t)),this._emitAfterChanges(4),this}shift(){if(bt(this._observable),!this.length||this._emitBeforeChanges(2))return;const t=ND(this._splice(0,1));return this._emitAfterChanges(2),t}slice(t=0,e=this.length){return bt(this._observable),this._createNewInstance({items:this._items.slice(t,e)})}some(t,e){return bt(this._observable),this._items.some(t,e)}sort(t){if(bt(this._observable),!this.length||this._emitBeforeChanges(4))return this;const e=Kr(this._splice(0,this.length));return arguments.length?e.sort(t):e.sort(),this._splice(0,0,e),this._emitAfterChanges(4),this}splice(t,e,...i){bt(this._observable);const r=(e?2:0)|(i.length?1:0);if(this._emitBeforeChanges(r))return[];const s=this._splice(t,e,i)||[];return this._emitAfterChanges(r),s}toArray(){return bt(this._observable),this._items.slice()}toJSON(){return bt(this._observable),this.toArray()}toLocaleString(){return bt(this._observable),this._items.toLocaleString()}toString(){return bt(this._observable),this._items.toString()}unshift(...t){return bt(this._observable),!t.length||this._emitBeforeChanges(1)||(this._splice(0,0,t),this._emitAfterChanges(1)),this.length}_createNewInstance(t){return new this.constructor(t)}_splice(t,e,i){const r=this._items,s=this.itemType;let n,o;if(!this._notifications&&this.hasEventListener("change")&&(this._notifications=[{listeners:this._chgListeners.slice(),items:this._items.slice(),changes:[]}],this._timer&&this._timer.remove(),this._timer=Yw(()=>this._dispatchChange())),e){if(o=r.splice(t,e),this.hasEventListener("before-remove")){const a=Oa.acquire();a.target=this,a.cancellable=!0;for(let l=0,c=o.length;l<c;l++)n=o[l],a.reset(n),this.emit("before-remove",a),a.defaultPrevented&&(o.splice(l,1),r.splice(t,0,n),t+=1,l-=1,c-=1);Oa.release(a)}if(this.length=this._items.length,this.hasEventListener("after-remove")){const a=Oa.acquire();a.target=this,a.cancellable=!1;const l=o.length;for(let c=0;c<l;c++)a.reset(o[c]),this.emit("after-remove",a);Oa.release(a)}}if(i&&i.length){if(s){const h=[];for(const p of i){const f=s.ensureType(p);f==null&&p!=null||h.push(f)}i=h}const a=this.hasEventListener("before-add"),l=this.hasEventListener("after-add"),c=t===this.length;if(a||l){const h=Oa.acquire();h.target=this,h.cancellable=!0;const p=Oa.acquire();p.target=this,p.cancellable=!1;for(const f of i)a?(h.reset(f),this.emit("before-add",h),h.defaultPrevented||(c?r.push(f):r.splice(t++,0,f),this._set("length",r.length),l&&(p.reset(f),this.emit("after-add",p)))):(c?r.push(f):r.splice(t++,0,f),this._set("length",r.length),p.reset(f),this.emit("after-add",p));Oa.release(p),Oa.release(h)}else{if(c)for(const h of i)r.push(h);else r.splice(t,0,...i);this._set("length",r.length)}}return(i&&i.length||o&&o.length)&&this._notifyChangeEvent(i,o),o}_emitBeforeChanges(t){let e=!1;if(this.hasEventListener("before-changes")){const i=Oa.acquire();i.target=this,i.cancellable=!0,i.type=t,this.emit("before-changes",i),e=i.defaultPrevented,Oa.release(i)}return e}_emitAfterChanges(t){if(this.hasEventListener("after-changes")){const e=Oa.acquire();e.target=this,e.cancellable=!1,e.type=t,this.emit("after-changes",e),Oa.release(e)}this._observable.notify()}_notifyChangeEvent(t,e){this.hasEventListener("change")&&this._notifications&&this._notifications[this._notifications.length-1].changes.push({added:t,removed:e})}_dispatchChange(){if(this._timer&&(this._timer.remove(),this._timer=null),!this._notifications)return;const t=this._notifications;this._notifications=null;for(const e of t){const i=e.changes;Sp.clear(),Tp.clear(),Cp.clear();for(const{added:l,removed:c}of i){if(l)if(Cp.size===0&&Tp.size===0)for(const h of l)Sp.add(h);else for(const h of l)Tp.has(h)?(Cp.add(h),Tp.delete(h)):Cp.has(h)||Sp.add(h);if(c)if(Cp.size===0&&Sp.size===0)for(const h of c)Tp.add(h);else for(const h of c)Sp.has(h)?Sp.delete(h):(Cp.delete(h),Tp.add(h))}const r=uo.acquire();Sp.forEach(l=>{r.push(l)});const s=uo.acquire();Tp.forEach(l=>{s.push(l)});const n=this._items,o=e.items,a=uo.acquire();if(Cp.forEach(l=>{o.indexOf(l)!==n.indexOf(l)&&a.push(l)}),e.listeners&&(r.length||s.length||a.length)){const l={target:this,added:r,removed:s,moved:a},c=e.listeners.length;for(let h=0;h<c;h++){const p=e.listeners[h];p.removed||p.callback.call(this,l)}}uo.release(r),uo.release(s),uo.release(a)}Sp.clear(),Tp.clear(),Cp.clear()}};yg.ofType=t=>{if(!t)return Mh;if(UD.has(t))return UD.get(t);let e=null;if(typeof t=="function")e=t.prototype.declaredClass;else if(t.base)e=t.base.prototype.declaredClass;else for(const r in t.typeMap){const s=t.typeMap[r].prototype.declaredClass;e?e+=` | ${s}`:e=s}let i=class extends Mh{};return u([zD({Type:t,ensureType:typeof t=="function"?Ni(t):Zc(t)})],i.prototype,"itemType",void 0),i=u([R(`esri.core.Collection<${e}>`)],i),UD.set(t,i),i},u([d()],yg.prototype,"length",void 0),u([d()],yg.prototype,"items",null),yg=Mh=u([R("esri.core.Collection")],yg);const We=yg;function vg(t,e,i=We){return e||(e=new i),e===t||(e.removeAll(),dve(t)?e.addMany(t):t&&e.add(t)),e}function KG(t){return t}function dve(t){return t&&(Array.isArray(t)||"items"in t&&Array.isArray(t.items))}function pve(t,e,i){if(!t||!t.read||t.read.enabled===!1||!t.read.source)return!1;const r=t.read.source;if(typeof r=="string"){if(r===e||r.indexOf(".")>-1&&r.indexOf(e)===0&&iG(r,i))return!0}else for(const s of r)if(s===e||s.indexOf(".")>-1&&s.indexOf(e)===0&&iG(s,i))return!0;return!1}function fve(t){return t&&(!t.read||t.read.enabled!==!1&&!t.read.source)}function mve(t,e,i,r,s){let n=ID(e[i],s);fve(n)&&(t[i]=!0);for(const o of Object.getOwnPropertyNames(e))n=ID(e[o],s),pve(n,i,r)&&(t[o]=!0)}function gve(t,e,i,r){const s=i.metadatas,n=DD(s[e],"any",r),o=n&&n.default;if(o===void 0)return;const a=typeof o=="function"?o.call(t,e,r):o;a!==void 0&&i.set(e,a)}const eq={origin:"service"};function tq(t,e,i=eq){if(!e||typeof e!="object")return;const r=Ea(t),s=r.metadatas,n={};for(const o of Object.getOwnPropertyNames(e))mve(n,s,o,e,i);r.setDefaultOrigin(i.origin);for(const o of Object.getOwnPropertyNames(n)){const a=ID(s[o],i).read,l=a&&a.source;let c;c=l&&typeof l=="string"?Vv(e,l):e[o],a&&a.reader&&(c=a.reader.call(t,c,e,i)),c!==void 0&&r.set(o,c)}if(!i||!i.ignoreDefaults)for(const o of Object.getOwnPropertyNames(s))n[o]||gve(t,o,r,i);r.setDefaultOrigin("user")}function yve(t,e,i,r=eq){var s;const n=he(E({},r),{messages:[]});i(n),(s=n.messages)==null||s.forEach(o=>{o.type!=="warning"||t.loaded?r&&r.messages&&r.messages.push(o):t.loadWarnings.push(o)})}const vve=le.getLogger("esri.core.accessorSupport.write");function _ve(t,e,i,r,s){var n,o;const a={};return(n=e.write)==null||(o=n.writer)==null||o.call(t,r,a,i,s),a}function iq(t,e,i,r,s,n){if(!r||!r.write)return!1;const o=t.get(i);if(!s&&r.write.overridePolicy){const a=r.write.overridePolicy.call(t,o,i,n);a!==void 0&&(s=a)}if(s||(s=r.write),!s||s.enabled===!1)return!1;if((o===null&&!s.allowNull&&!s.writerEnsuresNonNull||o===void 0)&&s.isRequired){const a=new Q("web-document-write:property-required",`Missing value for required property '${i}' on '${t.declaredClass}'`,{propertyName:i,target:t});return a&&n&&n.messages?n.messages.push(a):a&&!n&&vve.error(a.name,a.message),!1}return o===void 0||o===null&&!s.allowNull&&!s.writerEnsuresNonNull||bve(t,i,n,r,o)?!1:r.default!==void 0?!0:!(!s.ignoreOrigin&&n&&n.origin&&e.store.originOf(i)<bp(n.origin))}function bve(t,e,i,r,s){const n=r.default;if(n===void 0)return!1;if(r.defaultEquals!=null)return r.defaultEquals(s);if(typeof n=="function"){if(Array.isArray(s)){const o=n.call(t,e,i);return _p(o,s)}return!1}return n===s}function wve(t,e,i,r){const s=Ea(t),n=s.metadatas,o=QG(n[e],r);return!!o&&iq(t,s,e,o,i,r)}function rq(t,e,i){if(t&&typeof t.toJSON=="function"&&(!t.toJSON.isDefaultToJSON||!t.write))return RC(e,t.toJSON());const r=Ea(t),s=r.metadatas;for(const a in s){const l=QG(s[a],i);if(!iq(t,r,a,l,void 0,i))continue;const c=t.get(a),h=_ve(t,l,l.write&&typeof l.write.target=="string"?l.write.target:a,c,i);var n,o;Object.keys(h).length>0&&(e=RC(e,h),i!=null&&(n=i.resources)!=null&&(o=n.pendingOperations)!=null&&o.length&&Promise.all(i.resources.pendingOperations).then(()=>RC(e,h)),i&&i.writtenProperties&&i.writtenProperties.push({target:t,propName:a,oldOrigin:Xye(r.store.originOf(a)),newOrigin:i.origin}))}return e}const ix=t=>{let e=class extends t{constructor(...i){super(...i)}read(i,r){tq(this,i,r)}write(i={},r){return rq(this,i,r)}toJSON(i){return this.write({},i)}static fromJSON(i,r){return xve.call(this,i,r)}};return e=u([R("esri.core.JSONSupport")],e),e.prototype.toJSON.isDefaultToJSON=!0,e};function xve(t,e){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");const i=new this;return i.read(t,e),i}let ge=class extends ix(ve){};ge=u([R("esri.core.JSONSupport")],ge);class Sve{constructor(e){this.instance=e,this._resolver=xp(),this._status=0,this._resolvingPromises=[],this._resolver.promise.then(()=>{this._status=1,this._cleanUp()},()=>{this._status=2,this._cleanUp()})}addResolvingPromise(e){this._resolvingPromises.push(e),this._tryResolve()}isResolved(){return this._status===1}isRejected(){return this._status===2}isFulfilled(){return this._status!==0}abort(){this._resolver.reject($t())}when(e,i){return this._resolver.promise.then(e,i)}_cleanUp(){this._allPromise=this._resolvingPromises=this._allPromise=null}_tryResolve(){if(this.isFulfilled())return;const e=xp(),i=[...this._resolvingPromises,Kr(e.promise)],r=this._allPromise=Promise.all(i);r.then(()=>{this.isFulfilled()||this._allPromise!==r||this._resolver.resolve(this.instance)},s=>{this.isFulfilled()||this._allPromise!==r||bi(s)||this._resolver.reject(s)}),e.resolve()}}const rx=t=>{let e=class extends t{constructor(...i){super(...i),this._promiseProps=new Sve(this),this.addResolvingPromise(Promise.resolve())}isResolved(){return this._promiseProps.isResolved()}isRejected(){return this._promiseProps.isRejected()}isFulfilled(){return this._promiseProps.isFulfilled()}when(i,r){return new Promise((s,n)=>{this._promiseProps.when(s,n)}).then(i,r)}catch(i){return this.when(null,i)}addResolvingPromise(i){i&&!this._promiseProps.isFulfilled()&&this._promiseProps.addResolvingPromise("_promiseProps"in i?i.when():i)}};return e=u([R("esri.core.Promise")],e),e};let lM=class extends rx(ve){};lM=u([R("esri.core.Promise")],lM);const Tve="not-loaded",Cve="loading",Mve="failed",sq="loaded",nq=t=>{let e=class extends t{constructor(...i){super(...i),this._loadController=null,this.loadError=null,this.loadStatus="not-loaded",this._set("loadWarnings",[]),this.addResolvingPromise(new Promise(r=>{const s=this.load.bind(this);this.load=n=>{const o=new Promise((a,l)=>{const c=WC(n,l);this.destroyed&&l(new Q("load:instance-destroyed",`Instance of '${this.declaredClass||this.constructor.name}' is already destroyed`,{instance:this})),this._promiseProps.when(a,l).finally(()=>{c&&c.remove()})});if(this.loadStatus===Tve){this._set("loadStatus",Cve);const a=this._loadController=new AbortController;s({signal:a.signal}),ps(a.signal,()=>{this._promiseProps.abort()})}return r(),o}})),this.when(()=>{this._set("loadStatus",sq),this._loadController=null},r=>{this._set("loadStatus",Mve),this._set("loadError",r),this._loadController=null})}get loaded(){return this.loadStatus===sq}get loadWarnings(){return this._get("loadWarnings")}load(){return null}cancelLoad(){var i;return this.isFulfilled()||(this._set("loadError",new Q("load:cancelled","Cancelled")),(i=this._loadController)==null||i.abort()),this}};return u([d({readOnly:!0})],e.prototype,"loaded",null),u([d({readOnly:!0})],e.prototype,"loadError",void 0),u([d()],e.prototype,"loadStatus",void 0),u([d({type:[Go],readOnly:!0})],e.prototype,"loadWarnings",null),e=u([R("esri.core.Loadable")],e),e};let sx=class extends nq(lM){};sx=u([R("esri.core.Loadable")],sx),function(t){function e(i){return!(!i||!i.load)}t.LoadableMixin=nq,t.isLoadable=e}(sx||(sx={}));const Ph=sx;function cM(t,e,i){return En(t.map((r,s)=>e.apply(i,[r,s])))}function Pve(t,e,i){return En(t.map((r,s)=>e.apply(i,[r,s]))).then(r=>r.map(s=>s.value))}function zl(t){return A(t)?Ww():t.then(e=>({ok:!0,value:e})).catch(e=>({ok:!1,error:e}))}function tnt(t){return t.then(e=>({ok:!0,value:e})).catch(e=>(Wc(e),{ok:!1,error:e}))}function int(t){if(t.ok===!0)return t.value;throw t.error}async function oq(t,e){return await t.load(),Ave(t,e)}async function Ave(t,e){const i=[],r=(...n)=>{for(const o of n)A(o)||(Array.isArray(o)?r(...o):We.isCollection(o)?o.forEach(a=>r(a)):Ph.isLoadable(o)&&i.push(o))};e(r);let s=null;if(await Pve(i,async n=>{(await zl($ve(n)?n.loadAll():n.load())).ok!==!1||s||(s=n)}),s)throw s.loadError;return t}function $ve(t){return"loadAll"in t&&typeof t.loadAll=="function"}const Eve=le.getLogger("esri.core.urlUtils"),Hv=ei.request,aq="esri/config: esriConfig.request.proxyUrl is not set.",lq=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,cq=/^\s*http:/i,Ove=/^\s*https:/i,Rve=/^\s*file:/i,Ive=/:\d+$/,Dve=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,Fve=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),Lve=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");class Ah{constructor(e=""){this.uri=e,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let i=Kr(this.uri.match(Fve));this.scheme=i[2]||(i[1]?"":null),this.authority=i[4]||(i[3]?"":null),this.path=i[5],this.query=i[7]||(i[6]?"":null),this.fragment=i[9]||(i[8]?"":null),this.authority!=null&&(i=Kr(this.authority.match(Lve)),this.user=i[3]||null,this.password=i[4]||null,this.host=i[6]||i[7],this.port=i[9]||null)}toString(){return this.uri}}const fs=new Ah(ei.applicationUrl),uM={},uq=(()=>{const t=Kr(fs.path),e=t.substring(0,t.lastIndexOf(t.split("/")[t.split("/").length-1]));return`${`${fs.scheme}://${fs.host}${fs.port!=null?`:${fs.port}`:""}`}${e}`})();function ms(t){const e={path:null,query:null},i=new Ah(t),r=t.indexOf("?");return i.query===null?e.path=t:(e.path=t.substring(0,r),e.query=hq(i.query)),i.fragment&&(e.hash=i.fragment,i.query===null&&(e.path=e.path.substring(0,e.path.length-(i.fragment.length+1)))),e}function hq(t){const e=t.split("&"),i={};for(const r of e){if(!r)continue;const s=r.indexOf("=");let n,o;s<0?(n=decodeURIComponent(r),o=""):(n=decodeURIComponent(r.slice(0,s)),o=decodeURIComponent(r.slice(s+1)));let a=i[n];typeof a=="string"&&(a=i[n]=[a]),Array.isArray(a)?a.push(o):i[n]=o}return i}function dq(t){return t&&typeof t=="object"&&"toJSON"in t&&typeof t.toJSON=="function"}function _g(t,e){return t?e&&typeof e=="function"?Object.keys(t).map(i=>encodeURIComponent(i)+"="+encodeURIComponent(e(i,t[i]))).join("&"):Object.keys(t).map(i=>{const r=t[i];if(r==null)return"";const s=encodeURIComponent(i)+"=",n=e&&e[i];return n?s+encodeURIComponent(n(r)):Array.isArray(r)?r.map(o=>dq(o)?s+encodeURIComponent(JSON.stringify(o)):s+encodeURIComponent(o)).join("&"):dq(r)?s+encodeURIComponent(JSON.stringify(r)):s+encodeURIComponent(r)}).filter(i=>i).join("&"):""}function kve(t=!1){let e,i=Hv.proxyUrl;if(typeof t=="string"){e=jve(t);const r=hM(t);r&&(i=r.proxyUrl)}else e=!!t;if(!i)throw Eve.warn(aq),new Q("urlutils:proxy-not-set",aq);return e&&WD()&&(i=HD(i)),ms(i)}function zve(t){const e=hM(t);let i,r;if(e){const s=jD(e.proxyUrl);i=s.path,r=s.query?hq(s.query):null}if(i){const s=ms(t);t=i+"?"+s.path;const n=_g(E(E({},r),s.query));n&&(t=`${t}?${n}`)}return t}const nx={path:"",query:""};function jD(t){const e=t.indexOf("?");return e!==-1?(nx.path=t.slice(0,e),nx.query=t.slice(e+1)):(nx.path=t,nx.query=null),nx}function pq(t){return t=(t=fM(t=Zve(t=jD(t).path),!0)).toLowerCase()}function Vve(t){const e={proxyUrl:t.proxyUrl,urlPrefix:pq(t.urlPrefix)},i=Hv.proxyRules,r=e.urlPrefix;let s=i.length;for(let n=0;n<i.length;n++){const o=i[n].urlPrefix;if(r.indexOf(o)===0){if(r.length===o.length)return-1;s=n;break}o.indexOf(r)===0&&(s=n+1)}return i.splice(s,0,e),s}function hM(t){const e=Hv.proxyRules,i=pq(t);for(let r=0;r<e.length;r++)if(i.indexOf(e[r].urlPrefix)===0)return e[r]}function fq(t,e){return t=mq(t),e=mq(e),fM(t)===fM(e)}function mq(t){const e=(t=Ia(t)).indexOf("/sharing");return e>0?t.substring(0,e):t.replace(/\/+$/,"")}function gq(t){const e=r=>r==null||r instanceof RegExp&&r.test(t)||typeof r=="string"&&t.startsWith(r),i=Hv.interceptors;if(i){for(const r of i)if(Array.isArray(r.urls)){if(r.urls.some(e))return r}else if(e(r.urls))return r}return null}function dM(t,e,i=!1){const r=JD(t),s=JD(e);return!(!i&&r.scheme!==s.scheme)&&r.host!=null&&s.host!=null&&r.host.toLowerCase()===s.host.toLowerCase()&&r.port===s.port}function BD(t){if(typeof t=="string"){if(!qo(t))return!0;t=JD(t)}if(dM(t,fs))return!0;const e=Hv.trustedServers||[];for(let i=0;i<e.length;i++){const r=Nve(e[i]);for(let s=0;s<r.length;s++)if(dM(t,r[s]))return!0}return!1}function Nve(t){return uM[t]||(qD(t)||Vl(t)?uM[t]=[new Ah(Ra(t))]:uM[t]=[new Ah(`http://${t}`),new Ah(`https://${t}`)]),uM[t]}function Ra(t,e=uq,i){return Vl(t)?i&&i.preserveProtocolRelative?t:fs.scheme==="http"&&fs.authority===Wv(t).slice(2)?`http:${t}`:`https:${t}`:qD(t)?t:Kr(Mp(t[0]==="/"?Hve(e):e,t))}function GD(t,e=uq,i){if(!qo(t))return t;const r=Ia(t),s=r.toLowerCase(),n=Ia(e).toLowerCase().replace(/\/+$/,""),o=i?Ia(i).toLowerCase().replace(/\/+$/,""):null;if(o&&n.indexOf(o)!==0)return t;const a=(p,f,g)=>(g=p.indexOf(f,g))===-1?p.length:g;let l=a(s,"/",s.indexOf("//")+2),c=-1;for(;s.slice(0,l+1)===n.slice(0,l)+"/"&&(c=l+1,l!==s.length);)l=a(s,"/",l+1);if(c===-1||o&&c<o.length)return t;t=r.slice(c);const h=n.slice(c-1).replace(/[^/]+/g,"").length;if(h>0)for(let p=0;p<h;p++)t=`../${t}`;else t=`./${t}`;return t}function Ia(t){return t=Yve(t=Qve(t=Jve(t=Ra(t=t.trim()))))}function Mp(...t){const e=t.filter(_);if(!e||!e.length)return;const i=[];if(qo(e[0])){const s=e[0],n=s.indexOf("//");n!==-1&&(i.push(s.slice(0,n+1)),Gve(e[0])&&(i[0]+="/"),e[0]=s.slice(n+2))}else e[0][0]==="/"&&i.push("");const r=e.reduce((s,n)=>n?s.concat(n.split("/")):s,[]);for(let s=0;s<r.length;s++){const n=r[s];n===".."&&i.length>0&&i[i.length-1]!==".."?i.pop():(!n&&s===r.length-1||n&&(n!=="."||i.length===0))&&i.push(n)}return i.join("/")}function Wv(t,e=!1){if(Zv(t)||Jc(t))return null;let i=t.indexOf("://");if(i===-1&&Vl(t))i=2;else{if(i===-1)return null;i+=3}const r=t.indexOf("/",i);return r!==-1&&(t=t.slice(0,r)),e&&(t=fM(t,!0)),t}function qo(t){return Vl(t)||qD(t)}function Zv(t){return t!=null&&t.slice(0,5)==="blob:"}function Jc(t){return t.slice(0,5)==="data:"}function yq(t){const e=pM(t);if(!e||!e.isBase64)return null;const i=atob(e.data),r=new Uint8Array(i.length);for(let s=0;s<i.length;s++)r[s]=i.charCodeAt(s);return r.buffer}const Uve=/^data:(.*?)(;base64)?,(.*)$/;function pM(t){const e=t.match(Uve);if(!e)return null;const[,i,r,s]=e;return{mediaType:i,isBase64:!!r,data:s}}function vq(t){return t.isBase64?`data:${t.mediaType};base64,${t.data}`:`data:${t.mediaType},${t.data}`}function Vl(t){return t!=null&&t!==void 0&&t[0]==="/"&&t[1]==="/"}function qD(t){return lq.test(t)}function jve(t){return Ove.test(t)||fs.scheme==="https"&&Vl(t)}function Bve(t){return cq.test(t)||fs.scheme==="http"&&Vl(t)}function Gve(t){return Rve.test(t)}function HD(t){return Vl(t)?`https:${t}`:t.replace(cq,"https:")}function qve(){return fs.scheme==="http"}function WD(){return fs.scheme==="https"}function fM(t,e=!1){return Vl(t)?t.slice(2):(t=t.replace(lq,""),e&&t.length>1&&t[0]==="/"&&t[1]==="/"&&(t=t.slice(2)),t)}function Hve(t){const e=t.indexOf("//"),i=t.indexOf("/",e+2);return i===-1?t:t.slice(0,i)}function Wve(t){let e=0;if(qo(t)){const r=t.indexOf("//");r!==-1&&(e=r+2)}const i=t.lastIndexOf("/");return i<e?t:t.slice(0,i+1)}function rnt(t,e){if(!t)return"";const i=ms(t).path.replace(/\/+$/,""),r=i.substring(i.lastIndexOf("/")+1);if(e==null||!e.length)return r;const s=new RegExp(`.(${e.join("|")})$`,"ig");return r.replace(s,"")}function Zve(t){return t&&t[t.length-1]==="/"?t:`${t}/`}function _q(t){return t.replace(/\/+$/,"")}function Jve(t){if(/^https?:\/\//i.test(t)){const e=jD(t);t=(t=e.path.replace(/\/{2,}/g,"/")).replace("/","//"),e.query&&(t+=`?${e.query}`)}return t}function Qve(t){return t.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function Yve(t){const e=Hv.httpsDomains;if(!Bve(t))return t;const i=t.indexOf("/",7);let r;if(r=i===-1?t:t.slice(0,i),r=r.toLowerCase().slice(7),Ive.test(r)){if(!r.endsWith(":80"))return t;r=r.slice(0,-3),t=t.replace(":80","")}return qve()&&r===fs.authority&&!Dve.test(t)||(WD()&&r===fs.authority||e&&e.some(s=>r===s||r.endsWith(`.${s}`))||WD()&&!hM(t))&&(t=HD(t)),t}function ZD(t,e,i){if(!(e&&i&&t&&qo(t)))return t;const r=t.indexOf("//"),s=t.indexOf("/",r+2),n=t.indexOf(":",r+2),o=Math.min(s<0?t.length:s,n<0?t.length:n);return t.slice(r+2,o).toLowerCase()!==e.toLowerCase()?t:`${t.slice(0,r+2)}${i}${t.slice(o)}`}function JD(t){return typeof t=="string"?new Ah(Ra(t)):(t.scheme||(t.scheme=fs.scheme),t)}function QD(t){return Kve.test(t)}function bq(t,e){const i=ms(t),r=Object.keys(i.query||{});return r.length>0&&e&&e.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${r.join(", ")}.`),i.path}function wq(t,e,i){const r=ms(t),s=r.query||{};return s[e]=String(i),`${r.path}?${_g(s)}`}function xq(t,e){const i=ms(t),r=i.query||{};for(const n in e)r[n]=e[n];const s=_g(r);return s?`${i.path}?${s}`:i.path}function snt(t){if(A(t))return null;const e=t.match(Xve);return e?e[1]:null}const Xve=/.*?\.([^\/]*)$/,Kve=/(^data:image\/svg|\.svg$)/i;function Ee(t,e,i){let r,s;return e===void 0?(s=t,r=[void 0]):typeof e!="string"?(s=t,r=[void 0],i=e):(s=e,r=Array.isArray(t)?t:[t]),(n,o)=>{const a=n.constructor.prototype;for(const l of r){const c=kG(n,l,s);c.write&&typeof c.write=="object"||(c.write={}),i&&(c.write.target=i),c.write.writer=a[o]}}}let m;const I={values:[1,.3048,.3048006096012192,.3047972654,.9143917962,.201166195164,.9143984146160287,.3047994715386762,20.11676512155263,20.11678249437587,.9143985307444408,.91439523,.3047997101815088,20.1168,20.116756,5e4,15e4],units:["Meter","Foot","Foot_US","Foot_Clarke","Yard_Clarke","Link_Clarke","Yard_Sears","Foot_Sears","Chain_Sears","Chain_Benoit_1895_B","Yard_Indian","Yard_Indian_1937","Foot_Gold_Coast","Chain","Chain_Sears_1922_Truncated","50_Kilometers","150_Kilometers"],2066:5,2136:12,2155:2,2157:0,2158:0,2159:12,2160:12,2204:2,2219:0,2220:0,2254:2,2255:2,2256:1,2265:1,2266:1,2267:2,2268:2,2269:1,2270:1,2271:2,2272:2,2273:1,2294:0,2295:0,2314:3,2899:2,2900:2,2901:1,2909:1,2910:1,2911:2,2912:2,2913:1,2914:1,2992:1,2993:0,2994:1,3080:1,3089:2,3090:0,3091:2,3102:2,3141:0,3142:0,3167:14,3359:2,3360:0,3361:1,3362:0,3363:2,3364:0,3365:2,3366:3,3404:2,3405:0,3406:0,3407:3,3439:0,3440:0,3479:1,3480:0,3481:1,3482:0,3483:1,3484:0,3485:2,3486:0,3487:2,3488:0,3489:0,3490:2,3491:0,3492:2,3493:0,3494:2,3495:0,3496:2,3497:0,3498:2,3499:0,3500:2,3501:0,3502:2,3503:0,3504:2,3505:0,3506:2,3507:0,3508:2,3509:0,3510:2,3511:0,3512:2,3513:0,3514:0,3515:2,3516:0,3517:2,3518:0,3519:2,3520:0,3521:2,3522:0,3523:2,3524:0,3525:2,3526:0,3527:2,3528:0,3529:2,3530:0,3531:2,3532:0,3533:2,3534:0,3535:2,3536:0,3537:2,3538:0,3539:2,3540:0,3541:2,3542:0,3543:2,3544:0,3545:2,3546:0,3547:2,3548:0,3549:2,3550:0,3551:2,3552:0,3553:2,3582:2,3583:0,3584:2,3585:0,3586:2,3587:0,3588:1,3589:0,3590:1,3591:0,3592:0,3593:1,3598:2,3599:0,3600:2,3605:1,3606:0,3607:0,3608:2,3609:0,3610:2,3611:0,3612:2,3613:0,3614:2,3615:0,3616:2,3617:0,3618:2,3619:0,3620:2,3621:0,3622:2,3623:0,3624:2,3625:0,3626:2,3627:0,3628:2,3629:0,3630:2,3631:0,3632:2,3633:0,3634:1,3635:0,3636:1,3640:2,3641:0,3642:2,3643:0,3644:1,3645:0,3646:1,3647:0,3648:1,3649:0,3650:2,3651:0,3652:2,3653:0,3654:2,3655:0,3656:1,3657:0,3658:2,3659:0,3660:2,3661:0,3662:2,3663:0,3664:2,3668:2,3669:0,3670:2,3671:0,3672:2,3673:0,3674:2,3675:0,3676:1,3677:2,3678:0,3679:1,3680:2,3681:0,3682:1,3683:2,3684:0,3685:0,3686:2,3687:0,3688:2,3689:0,3690:2,3691:0,3692:2,3696:2,3697:0,3698:2,3699:0,3700:2,3793:0,3794:0,3812:0,3854:0,3857:0,3920:0,3978:0,3979:0,3991:2,3992:2,4026:0,4037:0,4038:0,4071:0,4082:0,4083:0,4087:0,4088:0,4217:2,4414:0,4415:0,4417:0,4434:0,4437:0,4438:2,4439:2,4462:0,4467:0,4471:0,4474:0,4559:0,4647:0,4822:0,4826:0,4839:0,5018:0,5048:0,5167:0,5168:0,5221:0,5223:0,5234:0,5235:0,5243:0,5247:0,5266:0,5316:0,5320:0,5321:0,5325:0,5337:0,5361:0,5362:0,5367:0,5382:0,5383:0,5396:0,5456:0,5457:0,5469:0,5472:4,5490:0,5513:0,5514:0,5523:0,5559:0,5588:1,5589:3,5596:0,5627:0,5629:0,5641:0,5643:0,5644:0,5646:2,5654:2,5655:2,5659:0,5700:0,5825:0,5836:0,5837:0,5839:0,5842:0,5844:0,5858:0,5879:0,5880:0,5887:0,5890:0,6128:1,6129:1,6141:1,6204:0,6210:0,6211:0,6307:0,6312:0,6316:0,6362:0,6391:1,6405:1,6406:0,6407:1,6408:0,6409:1,6410:0,6411:2,6412:0,6413:2,6414:0,6415:0,6416:2,6417:0,6418:2,6419:0,6420:2,6421:0,6422:2,6423:0,6424:2,6425:0,6426:2,6427:0,6428:2,6429:0,6430:2,6431:0,6432:2,6433:0,6434:2,6435:0,6436:2,6437:0,6438:2,6439:0,6440:0,6441:2,6442:0,6443:2,6444:0,6445:2,6446:0,6447:2,6448:0,6449:2,6450:0,6451:2,6452:0,6453:2,6454:0,6455:2,6456:0,6457:2,6458:0,6459:2,6460:0,6461:2,6462:0,6463:2,6464:0,6465:2,6466:0,6467:2,6468:0,6469:2,6470:0,6471:2,6472:0,6473:2,6474:0,6475:2,6476:0,6477:2,6478:0,6479:2,6484:2,6485:0,6486:2,6487:0,6488:2,6489:0,6490:2,6491:0,6492:2,6493:0,6494:1,6495:0,6496:1,6497:0,6498:0,6499:1,6500:0,6501:2,6502:0,6503:2,6504:0,6505:2,6506:0,6507:2,6508:0,6509:0,6510:2,6515:1,6516:0,6518:0,6519:2,6520:0,6521:2,6522:0,6523:2,6524:0,6525:2,6526:0,6527:2,6528:0,6529:2,6530:0,6531:2,6532:0,6533:2,6534:0,6535:2,6536:0,6537:2,6538:0,6539:2,6540:0,6541:2,6542:0,6543:2,6544:0,6545:1,6546:0,6547:1,6548:0,6549:2,6550:0,6551:2,6552:0,6553:2,6554:0,6555:2,6556:0,6557:1,6558:0,6559:1,6560:0,6561:1,6562:0,6563:2,6564:0,6565:2,6566:0,6567:0,6568:2,6569:0,6570:1,6571:0,6572:2,6573:0,6574:2,6575:0,6576:2,6577:0,6578:2,6582:2,6583:0,6584:2,6585:0,6586:2,6587:0,6588:2,6589:0,6590:2,6591:0,6592:0,6593:2,6594:0,6595:2,6596:0,6597:2,6598:0,6599:2,6600:0,6601:2,6602:0,6603:2,6605:2,6606:0,6607:2,6608:0,6609:2,6610:0,6611:0,6612:2,6613:0,6614:2,6615:0,6616:2,6617:0,6618:2,6633:2,6646:0,6703:0,6784:0,6785:1,6786:0,6787:1,6788:0,6789:1,6790:0,6791:1,6792:0,6793:1,6794:0,6795:1,6796:0,6797:1,6798:0,6799:1,6800:0,6801:1,6802:0,6803:1,6804:0,6805:1,6806:0,6807:1,6808:0,6809:1,6810:0,6811:1,6812:0,6813:1,6814:0,6815:1,6816:0,6817:1,6818:0,6819:1,6820:0,6821:1,6822:0,6823:1,6824:0,6825:1,6826:0,6827:1,6828:0,6829:1,6830:0,6831:1,6832:0,6833:1,6834:0,6835:1,6836:0,6837:1,6838:0,6839:1,6840:0,6841:1,6842:0,6843:1,6844:0,6845:1,6846:0,6847:1,6848:0,6849:1,6850:0,6851:1,6852:0,6853:1,6854:0,6855:1,6856:0,6857:1,6858:0,6859:1,6860:0,6861:1,6862:0,6863:1,6867:0,6868:1,6870:0,6875:0,6876:0,6879:0,6880:2,6884:0,6885:1,6886:0,6887:1,6915:0,6922:0,6923:2,6924:0,6925:2,6962:0,6984:0,6991:0,7128:2,7131:0,7132:2,7142:0,7257:0,7258:2,7259:0,7260:2,7261:0,7262:2,7263:0,7264:2,7265:0,7266:2,7267:0,7268:2,7269:0,7270:2,7271:0,7272:2,7273:0,7274:2,7275:0,7276:2,7277:0,7278:2,7279:0,7280:2,7281:0,7282:2,7283:0,7284:2,7285:0,7286:2,7287:0,7288:2,7289:0,7290:2,7291:0,7292:2,7293:0,7294:2,7295:0,7296:2,7297:0,7298:2,7299:0,7300:2,7301:0,7302:2,7303:0,7304:2,7305:0,7306:2,7307:0,7308:2,7309:0,7310:2,7311:0,7312:2,7313:0,7314:2,7315:0,7316:2,7317:0,7318:2,7319:0,7320:2,7321:0,7322:2,7323:0,7324:2,7325:0,7326:2,7327:0,7328:2,7329:0,7330:2,7331:0,7332:2,7333:0,7334:2,7335:0,7336:2,7337:0,7338:2,7339:0,7340:2,7341:0,7342:2,7343:0,7344:2,7345:0,7346:2,7347:0,7348:2,7349:0,7350:2,7351:0,7352:2,7353:0,7354:2,7355:0,7356:2,7357:0,7358:2,7359:0,7360:2,7361:0,7362:2,7363:0,7364:2,7365:0,7366:2,7367:0,7368:2,7369:0,7370:2,7877:0,7878:0,7882:0,7883:0,7887:0,7899:0,7991:0,7992:0,8035:2,8036:2,8058:0,8059:0,8082:0,8083:0,8088:0,8090:0,8091:2,8092:0,8093:2,8095:0,8096:2,8097:0,8098:2,8099:0,8100:2,8101:0,8102:2,8103:0,8104:2,8105:0,8106:2,8107:0,8108:2,8109:0,8110:2,8111:0,8112:2,8113:0,8114:2,8115:0,8116:2,8117:0,8118:2,8119:0,8120:2,8121:0,8122:2,8123:0,8124:2,8125:0,8126:2,8127:0,8128:2,8129:0,8130:2,8131:0,8132:2,8133:0,8134:2,8135:0,8136:2,8137:0,8138:2,8139:0,8140:2,8141:0,8142:2,8143:0,8144:2,8145:0,8146:2,8147:0,8148:2,8149:0,8150:2,8151:0,8152:2,8153:0,8154:2,8155:0,8156:2,8157:0,8158:2,8159:0,8160:2,8161:0,8162:2,8163:0,8164:2,8165:0,8166:2,8167:0,8168:2,8169:0,8170:2,8171:0,8172:2,8173:0,8177:2,8179:0,8180:2,8181:0,8182:2,8184:0,8185:2,8187:0,8189:2,8191:0,8193:2,8196:0,8197:2,8198:0,8200:2,8201:0,8202:2,8203:0,8204:2,8205:0,8206:2,8207:0,8208:2,8209:0,8210:2,8212:0,8213:2,8214:0,8216:2,8218:0,8220:2,8222:0,8224:2,8225:0,8226:2,8311:0,8312:1,8313:0,8314:1,8315:0,8316:1,8317:0,8318:1,8319:0,8320:1,8321:0,8322:1,8323:0,8324:1,8325:0,8326:1,8327:0,8328:1,8329:0,8330:1,8331:0,8332:1,8333:0,8334:1,8335:0,8336:1,8337:0,8338:1,8339:0,8340:1,8341:0,8342:1,8343:0,8344:1,8345:0,8346:1,8347:0,8348:1,8352:0,8353:0,8379:0,8380:2,8381:0,8382:2,8383:0,8384:2,8385:0,8387:2,8391:0,8395:0,8433:0,8441:0,8455:0,8456:0,8531:2,8682:0,8686:0,8687:0,8692:0,8693:0,8826:0,8903:0,8950:0,8951:0,9039:0,9040:0,9141:0,9149:0,9150:0,9191:0,9221:0,9222:0,9249:0,9250:0,9252:0,9254:0,9265:0,9284:0,9285:0,9300:0,9354:0,9367:0,9373:0,9377:0,9387:0,9391:0,9456:0,9473:0,9498:0,9674:0,9678:0,9680:0,9709:0,9712:0,9713:0,9716:0,9741:0,9748:2,9749:2,9761:0,9766:0,20499:0,20538:0,20539:0,20790:0,20791:0,21291:0,21292:0,21500:0,21817:0,21818:0,22032:0,22033:0,22091:0,22092:0,22332:0,22391:0,22392:0,22700:0,22770:0,22780:0,22832:0,23090:0,23095:0,23239:0,23240:0,23433:0,23700:0,24047:0,24048:0,24100:3,24200:0,24305:0,24306:0,24382:10,24383:0,24500:0,24547:0,24548:0,24571:9,24600:0,25e3:0,25231:0,25884:0,25932:0,26237:0,26331:0,26332:0,26432:0,26591:0,26592:0,26632:0,26692:0,27120:0,27200:0,27291:6,27292:6,27429:0,27492:0,27493:0,27500:0,27700:0,28232:0,28600:0,28991:0,28992:0,29100:0,29101:0,29220:0,29221:0,29333:0,29635:0,29636:0,29701:0,29738:0,29739:0,29849:0,29850:0,29871:8,29872:7,29873:0,29874:0,30200:5,30339:0,30340:0,30591:0,30592:0,30791:0,30792:0,30800:0,31028:0,31121:0,31154:0,31170:0,31171:0,31370:0,31528:0,31529:0,31600:0,31700:0,31838:0,31839:0,31900:0,31901:0,32061:0,32062:0,32098:0,32099:2,32100:0,32104:0,32161:0,32766:0,53048:0,53049:0,54090:0,54091:0,65061:2,65062:2,65161:0,65163:0,102041:2,102064:11,102068:15,102069:16,102118:2,102119:1,102120:2,102121:2,102217:2,102218:0,102219:2,102220:2,102378:1,102379:1,102380:0,102381:1,102589:2,102599:2,102600:2,102604:2,102647:0,102704:2,102705:2,102706:0,102759:1,102760:1,102761:2,102762:0,102763:2,102764:0,102765:0,102766:2,102962:0,102963:0,102970:1,102974:2,102993:0,102994:0,102995:2,102996:2,103015:0,103016:2,103017:0,103018:2,103025:0,103026:0,103027:2,103028:2,103035:0,103036:0,103037:2,103038:2,103039:0,103040:0,103041:2,103042:2,103043:0,103044:0,103045:2,103046:2,103047:0,103048:0,103049:2,103050:2,103051:0,103052:2,103053:0,103054:2,103055:0,103056:2,103057:0,103058:0,103059:2,103060:2,103061:0,103062:0,103063:2,103064:2,103069:2,103070:0,103071:0,103072:2,103073:2,103086:0,103087:0,103088:2,103089:2,103094:1,103095:0,103096:2,103103:0,103104:2,103105:0,103106:2,103121:0,103122:2,103123:0,103124:0,103125:1,103126:1,103127:0,103128:0,103129:2,103130:2,103131:0,103132:0,103133:2,103134:2,103135:0,103136:0,103137:1,103138:1,103139:0,103140:2,103141:0,103142:2,103143:0,103144:2,103145:0,103146:1,103147:0,103148:0,103149:2,103150:2,103151:0,103152:2,103172:0,103173:2,103174:0,103175:0,103176:2,103177:2,103178:0,103179:0,103180:2,103181:2,103182:0,103183:0,103184:2,103185:2,103228:0,103229:0,103230:2,103231:2,103250:0,103251:2,103252:0,103253:2,103260:0,103261:0,103262:2,103263:2,103270:0,103271:0,103272:2,103273:2,103274:0,103275:0,103276:2,103277:2,103278:0,103279:0,103280:2,103281:2,103282:0,103283:0,103284:2,103285:2,103286:0,103287:2,103288:0,103289:2,103290:0,103291:2,103292:0,103293:0,103294:2,103295:2,103296:0,103297:0,103298:2,103299:2,103376:2,103377:0,103378:0,103379:2,103380:2,103393:0,103394:0,103395:2,103396:2,103472:0,103473:1,103474:0,103475:2,103482:0,103483:2,103484:0,103485:2,103500:0,103501:2,103502:0,103503:0,103504:1,103505:1,103506:0,103507:0,103508:2,103509:2,103510:0,103511:0,103512:2,103513:2,103514:0,103515:2,103516:0,103517:2,103518:0,103519:2,103520:0,103521:1,103522:0,103523:0,103524:2,103525:2,103526:0,103527:2,103561:2,103562:2,103563:0,103564:0,103565:2,103566:2,103567:0,103568:0,103569:2,103570:2,103584:0,103585:2,103586:0,103587:2,103588:1,103589:0,103590:2,103591:1,103592:0,103593:2,103594:1,103695:2};for(m=2e3;m<=2045;m++)I[m]=0;for(m=2056;m<=2065;m++)I[m]=0;for(m=2067;m<=2135;m++)I[m]=0;for(m=2137;m<=2154;m++)I[m]=0;for(m=2161;m<=2170;m++)I[m]=0;for(m=2172;m<=2193;m++)I[m]=0;for(m=2195;m<=2198;m++)I[m]=0;for(m=2200;m<=2203;m++)I[m]=0;for(m=2205;m<=2217;m++)I[m]=0;for(m=2222;m<=2224;m++)I[m]=1;for(m=2225;m<=2250;m++)I[m]=2;for(m=2251;m<=2253;m++)I[m]=1;for(m=2257;m<=2264;m++)I[m]=2;for(m=2274;m<=2279;m++)I[m]=2;for(m=2280;m<=2282;m++)I[m]=1;for(m=2283;m<=2289;m++)I[m]=2;for(m=2290;m<=2292;m++)I[m]=0;for(m=2308;m<=2313;m++)I[m]=0;for(m=2315;m<=2491;m++)I[m]=0;for(m=2494;m<=2866;m++)I[m]=0;for(m=2867;m<=2869;m++)I[m]=1;for(m=2870;m<=2888;m++)I[m]=2;for(m=2891;m<=2895;m++)I[m]=2;for(m=2896;m<=2898;m++)I[m]=1;for(m=2902;m<=2908;m++)I[m]=2;for(m=2915;m<=2920;m++)I[m]=2;for(m=2921;m<=2923;m++)I[m]=1;for(m=2924;m<=2930;m++)I[m]=2;for(m=2931;m<=2962;m++)I[m]=0;for(m=2964;m<=2968;m++)I[m]=2;for(m=2969;m<=2973;m++)I[m]=0;for(m=2975;m<=2991;m++)I[m]=0;for(m=2995;m<=3051;m++)I[m]=0;for(m=3054;m<=3079;m++)I[m]=0;for(m=3081;m<=3088;m++)I[m]=0;for(m=3092;m<=3101;m++)I[m]=0;for(m=3106;m<=3138;m++)I[m]=0;for(m=3146;m<=3151;m++)I[m]=0;for(m=3153;m<=3166;m++)I[m]=0;for(m=3168;m<=3172;m++)I[m]=0;for(m=3174;m<=3203;m++)I[m]=0;for(m=3294;m<=3358;m++)I[m]=0;for(m=3367;m<=3403;m++)I[m]=0;for(m=3408;m<=3416;m++)I[m]=0;for(m=3417;m<=3438;m++)I[m]=2;for(m=3441;m<=3446;m++)I[m]=2;for(m=3447;m<=3450;m++)I[m]=0;for(m=3451;m<=3459;m++)I[m]=2;for(m=3460;m<=3478;m++)I[m]=0;for(m=3554;m<=3559;m++)I[m]=0;for(m=3560;m<=3570;m++)I[m]=2;for(m=3571;m<=3581;m++)I[m]=0;for(m=3594;m<=3597;m++)I[m]=0;for(m=3601;m<=3604;m++)I[m]=0;for(m=3637;m<=3639;m++)I[m]=0;for(m=3665;m<=3667;m++)I[m]=0;for(m=3693;m<=3695;m++)I[m]=0;for(m=3701;m<=3727;m++)I[m]=0;for(m=3728;m<=3739;m++)I[m]=2;for(m=3740;m<=3751;m++)I[m]=0;for(m=3753;m<=3760;m++)I[m]=2;for(m=3761;m<=3773;m++)I[m]=0;for(m=3775;m<=3777;m++)I[m]=0;for(m=3779;m<=3781;m++)I[m]=0;for(m=3783;m<=3785;m++)I[m]=0;for(m=3788;m<=3791;m++)I[m]=0;for(m=3797;m<=3802;m++)I[m]=0;for(m=3814;m<=3816;m++)I[m]=0;for(m=3825;m<=3829;m++)I[m]=0;for(m=3832;m<=3841;m++)I[m]=0;for(m=3844;m<=3852;m++)I[m]=0;for(m=3873;m<=3885;m++)I[m]=0;for(m=3890;m<=3893;m++)I[m]=0;for(m=3907;m<=3912;m++)I[m]=0;for(m=3942;m<=3950;m++)I[m]=0;for(m=3968;m<=3970;m++)I[m]=0;for(m=3973;m<=3976;m++)I[m]=0;for(m=3986;m<=3989;m++)I[m]=0;for(m=3994;m<=3997;m++)I[m]=0;for(m=4048;m<=4051;m++)I[m]=0;for(m=4056;m<=4063;m++)I[m]=0;for(m=4093;m<=4096;m++)I[m]=0;for(m=4390;m<=4398;m++)I[m]=0;for(m=4399;m<=4413;m++)I[m]=2;for(m=4418;m<=4433;m++)I[m]=2;for(m=4455;m<=4457;m++)I[m]=2;for(m=4484;m<=4489;m++)I[m]=0;for(m=4491;m<=4554;m++)I[m]=0;for(m=4568;m<=4589;m++)I[m]=0;for(m=4652;m<=4656;m++)I[m]=0;for(m=4766;m<=4800;m++)I[m]=0;for(m=5014;m<=5016;m++)I[m]=0;for(m=5069;m<=5072;m++)I[m]=0;for(m=5105;m<=5130;m++)I[m]=0;for(m=5173;m<=5188;m++)I[m]=0;for(m=5253;m<=5259;m++)I[m]=0;for(m=5269;m<=5275;m++)I[m]=0;for(m=5292;m<=5311;m++)I[m]=0;for(m=5329;m<=5331;m++)I[m]=0;for(m=5343;m<=5349;m++)I[m]=0;for(m=5355;m<=5357;m++)I[m]=0;for(m=5387;m<=5389;m++)I[m]=0;for(m=5459;m<=5463;m++)I[m]=0;for(m=5479;m<=5482;m++)I[m]=0;for(m=5518;m<=5520;m++)I[m]=0;for(m=5530;m<=5539;m++)I[m]=0;for(m=5550;m<=5552;m++)I[m]=0;for(m=5562;m<=5583;m++)I[m]=0;for(m=5623;m<=5625;m++)I[m]=2;for(m=5631;m<=5639;m++)I[m]=0;for(m=5649;m<=5653;m++)I[m]=0;for(m=5663;m<=5680;m++)I[m]=0;for(m=5682;m<=5685;m++)I[m]=0;for(m=5875;m<=5877;m++)I[m]=0;for(m=5896;m<=5899;m++)I[m]=0;for(m=5921;m<=5940;m++)I[m]=0;for(m=6050;m<=6125;m++)I[m]=0;for(m=6244;m<=6275;m++)I[m]=0;for(m=6328;m<=6348;m++)I[m]=0;for(m=6350;m<=6356;m++)I[m]=0;for(m=6366;m<=6372;m++)I[m]=0;for(m=6381;m<=6387;m++)I[m]=0;for(m=6393;m<=6404;m++)I[m]=0;for(m=6480;m<=6483;m++)I[m]=0;for(m=6511;m<=6514;m++)I[m]=0;for(m=6579;m<=6581;m++)I[m]=0;for(m=6619;m<=6624;m++)I[m]=0;for(m=6625;m<=6627;m++)I[m]=2;for(m=6628;m<=6632;m++)I[m]=0;for(m=6634;m<=6637;m++)I[m]=0;for(m=6669;m<=6692;m++)I[m]=0;for(m=6707;m<=6709;m++)I[m]=0;for(m=6720;m<=6723;m++)I[m]=0;for(m=6732;m<=6738;m++)I[m]=0;for(m=6931;m<=6933;m++)I[m]=0;for(m=6956;m<=6959;m++)I[m]=0;for(m=7005;m<=7007;m++)I[m]=0;for(m=7057;m<=7070;m++)I[m]=2;for(m=7074;m<=7082;m++)I[m]=0;for(m=7109;m<=7118;m++)I[m]=0;for(m=7119;m<=7127;m++)I[m]=1;for(m=7374;m<=7376;m++)I[m]=0;for(m=7528;m<=7586;m++)I[m]=0;for(m=7587;m<=7645;m++)I[m]=2;for(m=7692;m<=7696;m++)I[m]=0;for(m=7755;m<=7787;m++)I[m]=0;for(m=7791;m<=7795;m++)I[m]=0;for(m=7799;m<=7801;m++)I[m]=0;for(m=7803;m<=7805;m++)I[m]=0;for(m=7825;m<=7831;m++)I[m]=0;for(m=7845;m<=7859;m++)I[m]=0;for(m=8013;m<=8032;m++)I[m]=0;for(m=8065;m<=8068;m++)I[m]=1;for(m=8518;m<=8529;m++)I[m]=2;for(m=8533;m<=8536;m++)I[m]=2;for(m=8538;m<=8540;m++)I[m]=2;for(m=8677;m<=8679;m++)I[m]=0;for(m=8836;m<=8840;m++)I[m]=0;for(m=8857;m<=8859;m++)I[m]=0;for(m=8908;m<=8910;m++)I[m]=0;for(m=9154;m<=9159;m++)I[m]=0;for(m=9205;m<=9218;m++)I[m]=0;for(m=9271;m<=9273;m++)I[m]=0;for(m=9295;m<=9297;m++)I[m]=0;for(m=9356;m<=9360;m++)I[m]=0;for(m=9404;m<=9407;m++)I[m]=0;for(m=9476;m<=9482;m++)I[m]=0;for(m=9487;m<=9494;m++)I[m]=0;for(m=9697;m<=9699;m++)I[m]=0;for(m=20002;m<=20032;m++)I[m]=0;for(m=20062;m<=20092;m++)I[m]=0;for(m=20135;m<=20138;m++)I[m]=0;for(m=20248;m<=20258;m++)I[m]=0;for(m=20348;m<=20358;m++)I[m]=0;for(m=20436;m<=20440;m++)I[m]=0;for(m=20822;m<=20824;m++)I[m]=0;for(m=20904;m<=20932;m++)I[m]=0;for(m=20934;m<=20936;m++)I[m]=0;for(m=21004;m<=21032;m++)I[m]=0;for(m=21035;m<=21037;m++)I[m]=0;for(m=21095;m<=21097;m++)I[m]=0;for(m=21148;m<=21150;m++)I[m]=0;for(m=21207;m<=21264;m++)I[m]=0;for(m=21307;m<=21364;m++)I[m]=0;for(m=21413;m<=21423;m++)I[m]=0;for(m=21453;m<=21463;m++)I[m]=0;for(m=21473;m<=21483;m++)I[m]=0;for(m=21780;m<=21782;m++)I[m]=0;for(m=21891;m<=21894;m++)I[m]=0;for(m=21896;m<=21899;m++)I[m]=0;for(m=22171;m<=22177;m++)I[m]=0;for(m=22181;m<=22187;m++)I[m]=0;for(m=22191;m<=22197;m++)I[m]=0;for(m=22234;m<=22236;m++)I[m]=0;for(m=22521;m<=22525;m++)I[m]=0;for(m=22991;m<=22994;m++)I[m]=0;for(m=23028;m<=23038;m++)I[m]=0;for(m=23830;m<=23853;m++)I[m]=0;for(m=23866;m<=23872;m++)I[m]=0;for(m=23877;m<=23884;m++)I[m]=0;for(m=23886;m<=23894;m++)I[m]=0;for(m=23946;m<=23948;m++)I[m]=0;for(m=24311;m<=24313;m++)I[m]=0;for(m=24342;m<=24347;m++)I[m]=0;for(m=24370;m<=24374;m++)I[m]=10;for(m=24375;m<=24381;m++)I[m]=0;for(m=24718;m<=24721;m++)I[m]=0;for(m=24817;m<=24821;m++)I[m]=0;for(m=24877;m<=24882;m++)I[m]=0;for(m=24891;m<=24893;m++)I[m]=0;for(m=25391;m<=25395;m++)I[m]=0;for(m=25828;m<=25838;m++)I[m]=0;for(m=26191;m<=26195;m++)I[m]=0;for(m=26391;m<=26393;m++)I[m]=0;for(m=26701;m<=26722;m++)I[m]=0;for(m=26729;m<=26799;m++)I[m]=2;for(m=26801;m<=26803;m++)I[m]=2;for(m=26811;m<=26813;m++)I[m]=2;for(m=26847;m<=26870;m++)I[m]=2;for(m=26891;m<=26899;m++)I[m]=0;for(m=26901;m<=26923;m++)I[m]=0;for(m=26929;m<=26946;m++)I[m]=0;for(m=26948;m<=26998;m++)I[m]=0;for(m=27037;m<=27040;m++)I[m]=0;for(m=27205;m<=27232;m++)I[m]=0;for(m=27258;m<=27260;m++)I[m]=0;for(m=27391;m<=27398;m++)I[m]=0;for(m=27561;m<=27564;m++)I[m]=0;for(m=27571;m<=27574;m++)I[m]=0;for(m=27581;m<=27584;m++)I[m]=0;for(m=27591;m<=27594;m++)I[m]=0;for(m=28191;m<=28193;m++)I[m]=0;for(m=28348;m<=28358;m++)I[m]=0;for(m=28402;m<=28432;m++)I[m]=0;for(m=28462;m<=28492;m++)I[m]=0;for(m=29118;m<=29122;m++)I[m]=0;for(m=29168;m<=29172;m++)I[m]=0;for(m=29177;m<=29185;m++)I[m]=0;for(m=29187;m<=29195;m++)I[m]=0;for(m=29900;m<=29903;m++)I[m]=0;for(m=30161;m<=30179;m++)I[m]=0;for(m=30491;m<=30494;m++)I[m]=0;for(m=30729;m<=30732;m++)I[m]=0;for(m=31251;m<=31259;m++)I[m]=0;for(m=31265;m<=31268;m++)I[m]=0;for(m=31275;m<=31279;m++)I[m]=0;for(m=31281;m<=31297;m++)I[m]=0;for(m=31461;m<=31469;m++)I[m]=0;for(m=31491;m<=31495;m++)I[m]=0;for(m=31917;m<=31922;m++)I[m]=0;for(m=31965;m<=32e3;m++)I[m]=0;for(m=32001;m<=32003;m++)I[m]=2;for(m=32005;m<=32031;m++)I[m]=2;for(m=32033;m<=32060;m++)I[m]=2;for(m=32064;m<=32067;m++)I[m]=2;for(m=32074;m<=32077;m++)I[m]=2;for(m=32081;m<=32086;m++)I[m]=0;for(m=32107;m<=32130;m++)I[m]=0;for(m=32133;m<=32158;m++)I[m]=0;for(m=32164;m<=32167;m++)I[m]=2;for(m=32180;m<=32199;m++)I[m]=0;for(m=32201;m<=32260;m++)I[m]=0;for(m=32301;m<=32360;m++)I[m]=0;for(m=32601;m<=32662;m++)I[m]=0;for(m=32664;m<=32667;m++)I[m]=2;for(m=32701;m<=32761;m++)I[m]=0;for(m=53001;m<=53004;m++)I[m]=0;for(m=53008;m<=53019;m++)I[m]=0;for(m=53021;m<=53032;m++)I[m]=0;for(m=53034;m<=53037;m++)I[m]=0;for(m=53042;m<=53046;m++)I[m]=0;for(m=53074;m<=53080;m++)I[m]=0;for(m=54001;m<=54004;m++)I[m]=0;for(m=54008;m<=54019;m++)I[m]=0;for(m=54021;m<=54032;m++)I[m]=0;for(m=54034;m<=54037;m++)I[m]=0;for(m=54042;m<=54046;m++)I[m]=0;for(m=54048;m<=54053;m++)I[m]=0;for(m=54074;m<=54080;m++)I[m]=0;for(m=54098;m<=54101;m++)I[m]=0;for(m=102001;m<=102040;m++)I[m]=0;for(m=102042;m<=102063;m++)I[m]=0;for(m=102065;m<=102067;m++)I[m]=0;for(m=102070;m<=102117;m++)I[m]=0;for(m=102122;m<=102216;m++)I[m]=0;for(m=102221;m<=102377;m++)I[m]=0;for(m=102382;m<=102388;m++)I[m]=0;for(m=102389;m<=102398;m++)I[m]=2;for(m=102399;m<=102444;m++)I[m]=0;for(m=102445;m<=102447;m++)I[m]=2;for(m=102448;m<=102458;m++)I[m]=0;for(m=102459;m<=102468;m++)I[m]=2;for(m=102469;m<=102499;m++)I[m]=0;for(m=102500;m<=102519;m++)I[m]=1;for(m=102520;m<=102524;m++)I[m]=0;for(m=102525;m<=102529;m++)I[m]=2;for(m=102530;m<=102588;m++)I[m]=0;for(m=102590;m<=102598;m++)I[m]=0;for(m=102601;m<=102603;m++)I[m]=0;for(m=102605;m<=102628;m++)I[m]=0;for(m=102629;m<=102646;m++)I[m]=2;for(m=102648;m<=102700;m++)I[m]=2;for(m=102701;m<=102703;m++)I[m]=0;for(m=102707;m<=102730;m++)I[m]=2;for(m=102733;m<=102758;m++)I[m]=2;for(m=102767;m<=102900;m++)I[m]=0;for(m=102901;m<=102933;m++)I[m]=2;for(m=102934;m<=102950;m++)I[m]=13;for(m=102951;m<=102960;m++)I[m]=0;for(m=102965;m<=102969;m++)I[m]=0;for(m=102971;m<=102973;m++)I[m]=0;for(m=102975;m<=102989;m++)I[m]=0;for(m=102990;m<=102992;m++)I[m]=1;for(m=102997;m<=103002;m++)I[m]=0;for(m=103003;m<=103008;m++)I[m]=2;for(m=103009;m<=103011;m++)I[m]=0;for(m=103012;m<=103014;m++)I[m]=2;for(m=103019;m<=103021;m++)I[m]=0;for(m=103022;m<=103024;m++)I[m]=2;for(m=103029;m<=103031;m++)I[m]=0;for(m=103032;m<=103034;m++)I[m]=2;for(m=103065;m<=103068;m++)I[m]=0;for(m=103074;m<=103076;m++)I[m]=0;for(m=103077;m<=103079;m++)I[m]=1;for(m=103080;m<=103082;m++)I[m]=0;for(m=103083;m<=103085;m++)I[m]=2;for(m=103090;m<=103093;m++)I[m]=0;for(m=103097;m<=103099;m++)I[m]=0;for(m=103100;m<=103102;m++)I[m]=2;for(m=103107;m<=103109;m++)I[m]=0;for(m=103110;m<=103112;m++)I[m]=2;for(m=103113;m<=103116;m++)I[m]=0;for(m=103117;m<=103120;m++)I[m]=2;for(m=103153;m<=103157;m++)I[m]=0;for(m=103158;m<=103162;m++)I[m]=2;for(m=103163;m<=103165;m++)I[m]=0;for(m=103166;m<=103168;m++)I[m]=1;for(m=103169;m<=103171;m++)I[m]=2;for(m=103186;m<=103188;m++)I[m]=0;for(m=103189;m<=103191;m++)I[m]=2;for(m=103192;m<=103195;m++)I[m]=0;for(m=103196;m<=103199;m++)I[m]=2;for(m=103200;m<=103224;m++)I[m]=0;for(m=103225;m<=103227;m++)I[m]=1;for(m=103232;m<=103237;m++)I[m]=0;for(m=103238;m<=103243;m++)I[m]=2;for(m=103244;m<=103246;m++)I[m]=0;for(m=103247;m<=103249;m++)I[m]=2;for(m=103254;m<=103256;m++)I[m]=0;for(m=103257;m<=103259;m++)I[m]=2;for(m=103264;m<=103266;m++)I[m]=0;for(m=103267;m<=103269;m++)I[m]=2;for(m=103300;m<=103375;m++)I[m]=0;for(m=103381;m<=103383;m++)I[m]=0;for(m=103384;m<=103386;m++)I[m]=1;for(m=103387;m<=103389;m++)I[m]=0;for(m=103390;m<=103392;m++)I[m]=2;for(m=103397;m<=103399;m++)I[m]=0;for(m=103400;m<=103471;m++)I[m]=2;for(m=103476;m<=103478;m++)I[m]=0;for(m=103479;m<=103481;m++)I[m]=2;for(m=103486;m<=103488;m++)I[m]=0;for(m=103489;m<=103491;m++)I[m]=2;for(m=103492;m<=103495;m++)I[m]=0;for(m=103496;m<=103499;m++)I[m]=2;for(m=103528;m<=103543;m++)I[m]=0;for(m=103544;m<=103548;m++)I[m]=2;for(m=103549;m<=103551;m++)I[m]=0;for(m=103552;m<=103554;m++)I[m]=1;for(m=103555;m<=103557;m++)I[m]=2;for(m=103558;m<=103560;m++)I[m]=0;for(m=103571;m<=103573;m++)I[m]=0;for(m=103574;m<=103576;m++)I[m]=2;for(m=103577;m<=103580;m++)I[m]=0;for(m=103581;m<=103583;m++)I[m]=2;for(m=103595;m<=103694;m++)I[m]=0;for(m=103696;m<=103699;m++)I[m]=0;for(m=103700;m<=103793;m++)I[m]=2;for(m=103794;m<=103872;m++)I[m]=0;for(m=103900;m<=103971;m++)I[m]=2;const e1e={102113:!0,102100:!0,3857:!0,3785:!0},t1e={102113:!0,102100:!0,3857:!0,3785:!0,4326:!0},Sq='PROJCS["WGS_1984_Web_Mercator_Auxiliary_Sphere",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator_Auxiliary_Sphere"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],PARAMETER["Auxiliary_Sphere_Type",0.0],UNIT["Meter",1.0]]',mM=[-20037508342788905e-9,20037508342788905e-9],gM=[-20037508342787e-6,20037508342787e-6],Tq={102113:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:mM,origin:gM,dx:1e-5},102100:{wkTemplate:Sq,valid:mM,origin:gM,dx:1e-5},3785:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:mM,origin:gM,dx:1e-5},3857:{wkTemplate:Sq,valid:mM,origin:gM,dx:1e-5},4326:{wkTemplate:'GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",{Central_Meridian}],UNIT["Degree",0.0174532925199433]]',altTemplate:'PROJCS["WGS_1984_Plate_Carree",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Plate_Carree"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],UNIT["Degrees",111319.491]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104971:{wkTemplate:'GEOGCS["Mars_2000_(Sphere)",DATUM["Mars_2000_(Sphere)",SPHEROID["Mars_2000_(Sphere)",3396190.0,0.0]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104905:{wkTemplate:'GEOGCS["GCS_Mars_2000",DATUM["D_Mars_2000",SPHEROID["Mars_2000_IAU_IAG",3396190.0,169.8944472236118]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5}};function Da(t,e){return!A(t)&&!A(e)&&(t===e||(t.wkid!=null||e.wkid!=null?t.wkid===e.wkid||bg(t)&&bg(e)||e.latestWkid!=null&&t.wkid===e.latestWkid||t.latestWkid!=null&&e.wkid===t.latestWkid:!(!t.wkt||!e.wkt)&&t.wkt.toUpperCase()===e.wkt.toUpperCase()))}function Pp(t){return Ho(t)&&t.wkid?Tq[t.wkid]:null}function Cq(t){return!!Ho(t)&&(t.wkid?I[t.wkid]==null:!!t.wkt&&!!/^\s*GEOGCS/i.test(t.wkt))}function yM(t){return!($h(t)||Eh(t))}function ox(t){return Ho(t)&&t.wkid===4326}function i1e(t){return Ho(t)&&t.wkid===4490}function bg(t){return Ho(t)&&t.wkid!=null&&e1e[t.wkid]===!0}function Mq(t){return Ho(t)&&t.wkid===32662}function YD(t){return t===104971||t===104905}function $h(t){return Ho(t)&&t.wkid!=null&&YD(t.wkid)}function XD(t){return t===104903}function Eh(t){return Ho(t)&&t.wkid!=null&&XD(t.wkid)}function r1e(t){return Ho(t)&&t.wkid!=null&&t1e[t.wkid]===!0}function Ho(t){return _(t)&&(t.wkid!=null&&t.wkid>=2e3||t.wkt!=null)}const s1e={wkid:4326,wkt:Dl(Tq[4326].wkTemplate,{Central_Meridian:"0.0"})},n1e={wkid:102100,latestWkid:3857},o1e={wkid:32662};var Qc;let ui=Qc=class extends ge{constructor(t){super(t),this.latestWkid=null,this.wkid=null,this.wkt=null,this.vcsWkid=null,this.latestVcsWkid=null,this.imageCoordinateSystem=null}static fromJSON(t){if(!t)return null;if(t.wkid){if(t.wkid===102100)return Qc.WebMercator;if(t.wkid===4326)return Qc.WGS84}const e=new Qc;return e.read(t),e}normalizeCtorArgs(t){return t&&typeof t=="object"?t:{[typeof t=="string"?"wkt":"wkid"]:t}}get isWGS84(){return ox(this)}get isWebMercator(){return bg(this)}get isGeographic(){return Cq(this)}get isWrappable(){return r1e(this)}writeWkt(t,e){this.wkid||(e.wkt=t)}clone(){if(this===Qc.WGS84)return Qc.WGS84;if(this===Qc.WebMercator)return Qc.WebMercator;const t=new Qc;return this.wkid!=null?(t.wkid=this.wkid,this.latestWkid!=null&&(t.latestWkid=this.latestWkid),this.vcsWkid!=null&&(t.vcsWkid=this.vcsWkid),this.latestVcsWkid!=null&&(t.latestVcsWkid=this.latestVcsWkid)):this.wkt!=null&&(t.wkt=this.wkt),this.imageCoordinateSystem&&(t.imageCoordinateSystem=ie(this.imageCoordinateSystem)),t}equals(t){if(t==null)return!1;if(this.imageCoordinateSystem||t.imageCoordinateSystem){if(this.imageCoordinateSystem==null||t.imageCoordinateSystem==null)return!1;const{id:e,referenceServiceName:i}=t.imageCoordinateSystem,{geodataXform:r}=t.imageCoordinateSystem,s=this.imageCoordinateSystem;return e==null||r?JSON.stringify(s)===JSON.stringify(t.imageCoordinateSystem):i?s.id===e&&s.referenceServiceName===i:s.id===e}return Da(this,t)}toJSON(t){return this.write(void 0,t)}};ui.GCS_NAD_1927=null,ui.WGS84=null,ui.WebMercator=null,ui.PlateCarree=null,u([d({readOnly:!0})],ui.prototype,"isWGS84",null),u([d({readOnly:!0})],ui.prototype,"isWebMercator",null),u([d({readOnly:!0})],ui.prototype,"isGeographic",null),u([d({readOnly:!0})],ui.prototype,"isWrappable",null),u([d({type:Oi,json:{write:!0}})],ui.prototype,"latestWkid",void 0),u([d({type:Oi,json:{write:!0,origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkt===null}}}}}}})],ui.prototype,"wkid",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkid===null}}}}}}})],ui.prototype,"wkt",void 0),u([Ee("wkt"),Ee("web-scene","wkt")],ui.prototype,"writeWkt",null),u([d({type:Oi,json:{write:!0}})],ui.prototype,"vcsWkid",void 0),u([d({type:Oi,json:{write:!0}})],ui.prototype,"latestVcsWkid",void 0),u([d()],ui.prototype,"imageCoordinateSystem",void 0),ui=Qc=u([R("esri.geometry.SpatialReference")],ui),ui.prototype.toJSON.isDefaultToJSON=!0,ui.GCS_NAD_1927=new ui({wkid:4267,wkt:'GEOGCS["GCS_North_American_1927",DATUM["D_North_American_1927",SPHEROID["Clarke_1866",6378206.4,294.9786982]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]]'}),ui.WGS84=new ui(s1e),ui.WebMercator=new ui(n1e),ui.PlateCarree=new ui(o1e),Object.freeze&&(Object.freeze(ui.GCS_NAD_1927),Object.freeze(ui.WGS84),Object.freeze(ui.WebMercator));const Ue=ui,Pq="20211215",Aq="ad43611b413b1d0a625293a3ce87543dde5c1fa2",$q="4.22",a1e={async request(t,e){var i;const{default:r}=await Promise.resolve().then(function(){return w1e}),s=t.options,n=s.responseType;s.signal=e==null?void 0:e.signal,s.responseType=n==="native"||n==="native-request-init"?"native-request-init":["blob","json","text"].includes(n)&&(i=gq(t.url))!=null&&i.after?n:"array-buffer";const o=await r(t.url,s),a={data:o.data,ssl:o.ssl};switch(o.requestOptions.responseType){case"native-request-init":return delete a.data.signal,a;case"blob":a.data=await a.data.arrayBuffer();break;case"json":a.data=new TextEncoder().encode(JSON.stringify(a.data)).buffer;break;case"text":a.data=new TextEncoder().encode(a.data).buffer}return{result:a,transferList:[a.data]}}};let _r;function nnt(t){_r=t}function l1e(t){const e=_r&&_r.findCredential(t);return e&&e.token?wq(t,"token",e.token):t}ae("host-webworker")||(ae("edge")||ae("trident"))&&console.warn("Deprecated browser - see http://esriurl.com/oldbrowser");const c1e=["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"];function Eq(t){const e=Wv(t,!0);return e&&e.endsWith(".arcgis.com")&&!c1e.includes(e)&&!t.endsWith("/sharing/rest/generateToken")}function Oq(t,e,i=!1,r){return new Promise((s,n)=>{if(Ir(r))return void n(Rq());let o=()=>{c(),n(new Error(`Unable to load ${e}`))},a=()=>{const h=t;c(),s(h)},l=()=>{if(!t)return;const h=t;c(),h.src="",n(Rq())};const c=()=>{ae("esri-image-decode")||(t.removeEventListener("error",o),t.removeEventListener("load",a)),o=null,a=null,t=null,_(r)&&r.removeEventListener("abort",l),l=null,i&&URL.revokeObjectURL(e)};_(r)&&r.addEventListener("abort",l),ae("esri-image-decode")?t.decode().then(a,o):(t.addEventListener("error",o),t.addEventListener("load",a))})}function Rq(){try{return new DOMException("Aborted","AbortError")}catch{const t=new Error;return t.name="AbortError",t}}async function vt(t,e){var i;const r=Jc(t),s=Zv(t);s||r||(t=Ia(t));const n={url:t,requestOptions:E({},at(e))};let o=gq(t);if(o){const h=await y1e(o,n);if(h!=null)return{data:h,getHeader:KD,requestOptions:n.requestOptions,url:n.url};o.after||o.error||(o=null)}if(t=n.url,(e=n.requestOptions).responseType==="image"){if(ae("host-webworker")||ae("host-node"))throw Nl("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),n)}else if(r)throw Nl("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+e.responseType),n);if(e.method==="head"){if(e.body)throw Nl("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),n);if(r||s)throw Nl("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),n)}if(await f1e(),vM)return vM.execute(t,e);const a=new AbortController;ps(e,()=>a.abort());const l={controller:a,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:o,params:n,redoRequest:!1,useIdentity:Oh.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},c=await _1e(l);return(i=o)==null||i.after==null||i.after(c),c}let vM;const Oh=ei.request,Iq="FormData"in globalThis,u1e=[499,498,403,401],h1e=["COM_0056","COM_0057","SB_0008"],d1e=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],KD=()=>null,eF=Symbol();function p1e(t){const e=Wv(t);e&&!vt._corsServers.includes(e)&&vt._corsServers.push(e)}function Dq(t){const e=Wv(t);return!e||e.endsWith(".arcgis.com")||vt._corsServers.includes(e)||BD(e)}function Nl(t,e,i,r){let s="Error";const n={url:i.url,requestOptions:i.requestOptions,getHeader:KD,ssl:!1};if(e instanceof Q)return e.details?(e.details=ie(e.details),e.details.url=i.url,e.details.requestOptions=i.requestOptions):e.details=n,e;if(e){const o=r&&(c=>r.headers.get(c)),a=r&&r.status,l=e.message;l&&(s=l),o&&(n.getHeader=o),n.httpStatus=(e.httpCode!=null?e.httpCode:e.code)||a||0,n.subCode=e.subcode,n.messageCode=e.messageCode,typeof e.details=="string"?n.messages=[e.details]:n.messages=e.details,n.raw=eF in e?e[eF]:e}return bi(e)?$t():new Q(t,s,n)}async function f1e(){ae("host-webworker")?vM||(vM=await import("./request.411515bd.js")):vt._abortableFetch||(vt._abortableFetch=globalThis.fetch.bind(globalThis))}async function tF(){_r||await import("./IdentityManager.d1a5e848.js")}async function m1e(t){const e=t.params.url,i=t.params.requestOptions,r=t.controller.signal,s=i.body;let n=null,o=null,a=null;if(Iq&&"HTMLFormElement"in globalThis&&(s instanceof FormData?n=s:s instanceof HTMLFormElement&&(o=s,n=new FormData(o))),typeof s=="string"&&(a=s),t.fetchOptions={cache:i.cacheBust&&!vt._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:i.headers||{},method:i.method==="head"?"HEAD":"GET",mode:"cors",redirect:"follow",signal:r},(n||a)&&(t.fetchOptions.body=n||a),i.authMode==="anonymous"&&(t.useIdentity=!1),t.hasToken=!!(/token=/i.test(e)||i.query&&i.query.token||n&&n.get&&n.get("token")||o&&o.elements.token),!t.hasToken&&ei.apiKey&&Eq(e)&&(i.query||(i.query={}),i.query.token=ei.apiKey,t.hasToken=!0),t.useIdentity&&!t.hasToken&&!t.credentialToken&&!Fq(e)&&!Ir(r)){let l;i.authMode==="immediate"?(await tF(),l=await _r.getCredential(e,{signal:r}),t.credential=l):i.authMode==="no-prompt"?(await tF(),l=await _r.getCredential(e,{prompt:!1,signal:r}).catch(()=>{}),t.credential=l):_r&&(l=_r.findCredential(e)),l&&(t.credentialToken=l.token,t.useSSL=!!l.ssl)}}function Fq(t){return d1e.some(e=>e.test(t))}async function g1e(t){let e=t.params.url;const i=t.params.requestOptions,r=t.fetchOptions,s=Zv(e)||Jc(e),n=i.responseType||"json",o=s?0:i.timeout!=null?i.timeout:Oh.timeout;let a=!1;if(!s){t.useSSL&&(e=HD(e)),i.cacheBust&&r.cache==="default"&&(e=wq(e,"request.preventCache",Date.now()));let f=E({},i.query);t.credentialToken&&(f.token=t.credentialToken);let g=_g(f);ae("esri-url-encodes-apostrophe")&&(g=g.replace(/'/g,"%27"));const y=e.length+1+g.length;let v;a=i.method==="delete"||i.method==="post"||i.method==="put"||!!i.body||y>Oh.maxUrlLength;const b=i.useProxy||!!hM(e);if(b){const w=kve(e);v=w.path,!a&&v.length+1+y>Oh.maxUrlLength&&(a=!0),w.query&&(f=E(E({},w.query),f))}if(r.method==="HEAD"&&(a||b)){if(a)throw y>Oh.maxUrlLength?Nl("request:invalid-parameters",new Error("URL exceeds maximum length"),t.params):Nl("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),t.params);if(b)throw Nl("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),t.params)}if(a?(r.method=i.method==="delete"?"DELETE":i.method==="put"?"PUT":"POST",i.body?e=xq(e,f):(r.body=_g(f),r.headers["Content-Type"]="application/x-www-form-urlencoded")):e=xq(e,f),b&&(t.useProxy=!0,e=`${v}?${e}`),f.token&&Iq&&r.body instanceof FormData){const w=r.body;w.set?w.set("token",f.token):w.append("token",f.token)}if(i.hasOwnProperty("withCredentials"))t.withCredentials=i.withCredentials;else if(!dM(e,fs)){if(BD(e))t.withCredentials=!0;else if(_r){const w=_r.findServerInfo(e);w&&w.webTierAuth&&(t.withCredentials=!0)}}t.withCredentials&&(r.credentials="include")}let l,c,h=0,p=!1;o>0&&(h=setTimeout(()=>{p=!0,t.controller.abort()},o));try{if(i.responseType==="native-request-init")c=r,c.url=e;else if(i.responseType!=="image"||r.cache!=="default"||r.method!=="GET"||a||v1e(i.headers)||!s&&!t.useProxy&&Oh.proxyUrl&&!Dq(e)){if(l=await vt._abortableFetch(e,r),t.useProxy||p1e(e),i.responseType==="native")c=l;else if(r.method!=="HEAD")if(l.ok){switch(n){case"array-buffer":c=await l.arrayBuffer();break;case"blob":case"image":c=await l.blob();break;default:c=await l.text()}if(h&&(clearTimeout(h),h=0),n==="json"||n==="xml"||n==="document")if(c)switch(n){case"json":c=JSON.parse(c);break;case"xml":c=Lq(c,"application/xml");break;case"document":c=Lq(c,"text/html")}else c=null;if(c){if(n==="array-buffer"||n==="blob"){const f=l.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(f)&&c[n==="blob"?"size":"byteLength"]<=750)try{const g=await new Response(c).json();g.error&&(c=g)}catch{}}n==="image"&&c instanceof Blob&&(c=await kq(URL.createObjectURL(c),t,!0))}}else c=await l.text()}else c=await kq(e,t)}catch(f){if(f.name==="AbortError")throw p?new Error("Timeout exceeded"):$t("Request canceled");if(!(!l&&f instanceof TypeError&&Oh.proxyUrl)||i.body||i.method==="delete"||i.method==="head"||i.method==="post"||i.method==="put"||t.useProxy||Dq(e))throw f;t.redoRequest=!0,Vve({proxyUrl:Oh.proxyUrl,urlPrefix:Wv(e)})}finally{h&&clearTimeout(h)}return[l,c]}async function y1e(t,e){if(t.responseData!=null)return t.responseData;if(t.headers&&(e.requestOptions.headers=E(E({},e.requestOptions.headers),t.headers)),t.query&&(e.requestOptions.query=E(E({},e.requestOptions.query),t.query)),t.before){let i,r;try{r=await t.before(e)}catch(s){i=Nl("request:interceptor",s,e)}if((r instanceof Error||r instanceof Q)&&(i=Nl("request:interceptor",r,e)),i)throw t.error&&t.error(i),i;return r}}function v1e(t){if(t){for(const e of Object.getOwnPropertyNames(t))if(t[e])return!0}return!1}function Lq(t,e){let i;try{i=new DOMParser().parseFromString(t,e)}catch{}if(!i||i.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return i}async function _1e(t){var e,i;let r,s;await m1e(t);try{do[r,s]=await g1e(t);while(!await b1e(t,r,s))}catch(a){const l=Nl("request:server",a,t.params,r);throw l.details.ssl=t.useSSL,t.interceptor&&t.interceptor.error&&t.interceptor.error(l),l}const n=t.params.url;if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(n)&&!t.hasToken&&!t.credentialToken&&(e=s)!=null&&(i=e.user)!=null&&i.username&&!BD(n)){const a=Wv(n,!0);a&&Oh.trustedServers.push(a)}const o=t.credential;if(o&&_r){const a=_r.findServerInfo(o.server);let l=a&&a.owningSystemUrl;if(l){l=l.replace(/\/?$/,"/sharing");const c=_r.findCredential(l,o.userId);c&&_r._getIdenticalSvcIdx(l,c)===-1&&c.resources.unshift(l)}}return{data:s,getHeader:r?a=>r.headers.get(a):KD,requestOptions:t.params.requestOptions,ssl:t.useSSL,url:t.params.url}}async function b1e(t,e,i){if(t.redoRequest)return t.redoRequest=!1,!1;const r=t.params.requestOptions;if(!e||r.responseType==="native"||r.responseType==="native-request-init")return!0;let s,n,o,a;if(!e.ok)throw s=new Error(`Unable to load ${e.url} status: ${e.status}`),s[eF]=i,s;i!=null&&i.error&&(s=i.error),s&&(n=Number(s.code),o=s.hasOwnProperty("subcode")?Number(s.subcode):null,a=s.messageCode,a=a&&a.toUpperCase());const l=r.authMode;if(n===403&&(o===4||s.message&&s.message.toLowerCase().indexOf("ssl")>-1&&s.message.toLowerCase().indexOf("permission")===-1)){if(!t.useSSL)return t.useSSL=!0,!1}else if(!t.hasToken&&t.useIdentity&&(l!=="no-prompt"||n===498)&&u1e.indexOf(n)!==-1&&!Fq(t.params.url)&&(n!==403||h1e.indexOf(a)===-1&&(o==null||o===2&&t.credentialToken))){await tF();try{const c=await _r.getCredential(t.params.url,{error:Nl("request:server",s,t.params),prompt:l!=="no-prompt",signal:t.controller.signal,token:t.credentialToken});return t.credential=c,t.credentialToken=c.token,t.useSSL=t.useSSL||c.ssl,!1}catch(c){if(l==="no-prompt")return t.credential=null,t.credentialToken=null,!1;s=c}}if(s)throw s;return!0}function kq(t,e,i=!1){const r=e.controller.signal,s=new Image;return e.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.src=t,Oq(s,t,i,r)}vt._abortableFetch=null,vt._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];var w1e=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:vt});function Ce(t,e,i){let r,s;return e===void 0||Array.isArray(e)?(s=t,i=e,r=[void 0]):(s=e,r=Array.isArray(t)?t:[t]),(n,o)=>{const a=n.constructor.prototype;r.forEach(l=>{const c=kG(n,l,s);c.read&&typeof c.read=="object"||(c.read={}),c.read.reader=a[o],i&&(c.read.source=(c.read.source||[]).concat(i))})}}let Yc=class extends ge{constructor(...t){super(...t),this.type=null,this.hasM=!1,this.hasZ=!1,this.spatialReference=Ue.WGS84}get cache(){return this.commitProperty("spatialReference"),{}}get extent(){return null}readSpatialReference(t,e){if(t instanceof Ue)return t;if(t!=null){const i=new Ue;return i.read(t,e),i}return t}clone(){return console.warn(".clone() is not implemented for "+this.declaredClass),null}clearCache(){this.notifyChange("cache")}getCacheValue(t){return this.cache[t]}setCacheValue(t,e){this.cache[t]=e}};u([d()],Yc.prototype,"type",void 0),u([d({readOnly:!0})],Yc.prototype,"cache",null),u([d({readOnly:!0})],Yc.prototype,"extent",null),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Yc.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Yc.prototype,"hasZ",void 0),u([d({type:Ue,json:{write:!0}})],Yc.prototype,"spatialReference",void 0),u([Ce("spatialReference")],Yc.prototype,"readSpatialReference",null),Yc=u([R("esri.geometry.Geometry")],Yc);const ho=Yc,x1e=Object.prototype.toString;function S1e(t){const e="__accessorMetadata__"in t?Ni(t):t;return function(...i){if(i.push(e),typeof i[2]=="number")throw new Error("Using @cast has parameter decorator is not supported since 4.16");return T1e.apply(this,i)}}function T1e(t,e,i,r){FC(t,e).cast=r}function C1e(t){return function(e,i){FC(e,t).cast=e[i]}}function ut(...t){if(t.length!==3||typeof t[1]!="string")return t.length===1&&x1e.call(t[0])==="[object Function]"?S1e(t[0]):t.length===1&&typeof t[0]=="string"?C1e(t[0]):void 0}function M1e(t,e,i,r){var s;return t.x=t.x+e,t.y=t.y+i,r!=null&&(t.z=((s=t.z)!=null?s:0)+r),t}function P1e(t,e){const i=t.x-e.x,r=t.y-e.y,s=t.hasZ&&e.hasZ?t.z-e.z:0;return Math.sqrt(i*i+r*r+s*s)}class iF{constructor(e,i,r,s){this.semiMajorAxis=e,this.flattening=i,this.outerAtmosphereRimWidth=r;const n=1-this.flattening;this.semiMinorAxis=this.semiMajorAxis*n,this.halfSemiMajorAxis=this.semiMajorAxis/2,this.halfCircumference=Math.PI*this.semiMajorAxis,this.metersPerDegree=this.halfCircumference/180,this.inverseFlattening=1/(1-this.flattening)-1,this.eccentricitySquared=s||2*this.flattening-this.flattening*this.flattening,this.meanRadiusSemiAxes=(2*this.semiMajorAxis+this.semiMinorAxis)/3}get radius(){return this.semiMajorAxis}}const Lt=new iF(6378137,1/298.257223563,3e5,.006694379990137799),Ul=new iF(3396190,1/169.8944472236118,23e4),Xc=new iF(1737400,0,0),A1e=57.29577951308232,$1e=.017453292519943;function zq(t){return t*A1e}function Vq(t){return t*$1e}function Nq(t){return t/Lt.radius}function _M(t){return Math.PI/2-2*Math.atan(Math.exp(-t/Lt.radius))}function rF(t){return t.wkid!=null||t.wkt!=null}const sF=[0,0];function bM(t,e,i,r,s){const n=t,o=s;if(o.spatialReference=i,"x"in n&&"x"in o)[o.x,o.y]=e(n.x,n.y,sF,r);else if("xmin"in n&&"xmin"in o)[o.xmin,o.ymin]=e(n.xmin,n.ymin,sF,r),[o.xmax,o.ymax]=e(n.xmax,n.ymax,sF,r);else if("paths"in n&&"paths"in o||"rings"in n&&"rings"in o){const a="paths"in n?n.paths:n.rings,l=[];let c;for(let h=0;h<a.length;h++){const p=a[h];c=[],l.push(c);for(let f=0;f<p.length;f++)c.push(e(p[f][0],p[f][1],[0,0],r)),p[f].length>2&&c[f].push(p[f][2]),p[f].length>3&&c[f].push(p[f][3])}"paths"in o?o.paths=l:o.rings=l}else if("points"in n&&"points"in o){const a=n.points,l=[];for(let c=0;c<a.length;c++)l[c]=e(a[c][0],a[c][1],[0,0],r),a[c].length>2&&l[c].push(a[c][2]),a[c].length>3&&l[c].push(a[c][3]);o.points=l}return s}function Rh(t,e){const i=t&&(rF(t)?t:t.spatialReference),r=e&&(rF(e)?e:e.spatialReference);return!(t&&"type"in t&&t.type==="mesh"||e&&"type"in e&&e.type==="mesh"||!i||!r)&&(!!Da(r,i)||bg(r)&&ox(i)||bg(i)&&ox(r))}function wg(t,e){if(A(t))return null;const i=t.spatialReference,r=e&&(rF(e)?e:e.spatialReference);return Rh(i,r)?Da(i,r)?ie(t):bg(r)?bM(t,Jv,Ue.WebMercator,!1,ie(t)):ox(r)?bM(t,ax,Ue.WGS84,!1,ie(t)):null:null}function Jv(t,e,i=[0,0]){e>89.99999?e=89.99999:e<-89.99999&&(e=-89.99999);const r=Vq(e);return i[0]=Vq(t)*Lt.radius,i[1]=Lt.halfSemiMajorAxis*Math.log((1+Math.sin(r))/(1-Math.sin(r))),i}function ax(t,e,i=[0,0],r=!1){const s=zq(t/Lt.radius);return i[0]=r?s:s-360*Math.floor((s+180)/360),i[1]=zq(Math.PI/2-2*Math.atan(Math.exp(-e/Lt.radius))),i}function Ih(t,e=!1,i=ie(t)){return bM(t,Jv,Ue.WebMercator,e,i)}function lx(t,e=!1,i=ie(t)){return bM(t,ax,Ue.WGS84,e,i)}var wM;const cx=[0,0];function Uq(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}const xM=le.getLogger("esri.geometry.Point");let Rn=wM=class extends ho{constructor(...t){super(...t),this.x=0,this.y=0,this.z=void 0,this.m=void 0,this.type="point"}static copy(t,e){e._set("x",t._get("x")),e._set("y",t._get("y")),e._set("z",t._get("z")),e._set("m",t._get("m"));const i=t._get("spatialReference");e._set("spatialReference",Object.isFrozen(i)?i:i.clone())}normalizeCtorArgs(t,e,i,r,s){let n;if(Array.isArray(t))n=t,s=e,t=n[0],e=n[1],i=n[2],r=n[3];else if(t&&typeof t=="object"){if(n=t,t=n.x!=null?n.x:n.longitude,e=n.y!=null?n.y:n.latitude,i=n.z,r=n.m,(s=n.spatialReference)&&s.declaredClass!=="esri.geometry.SpatialReference"&&(s=new Ue(s)),n.longitude!=null||n.latitude!=null){if(n.longitude==null)xM.warn(".longitude=","Latitude was defined without longitude");else if(n.latitude==null)xM.warn(".latitude=","Longitude was defined without latitude");else if(!n.declaredClass&&s&&s.isWebMercator){const a=Jv(n.longitude,n.latitude,cx);t=a[0],e=a[1]}}}else Uq(i)?(s=i,i=null):Uq(r)&&(s=r,r=null);const o={x:t,y:e};return o.x==null&&o.y!=null?xM.warn(".y=","Y coordinate was defined without an X coordinate"):o.y==null&&o.x!=null&&xM.warn(".x=","X coordinate was defined without a Y coordinate"),s!=null&&(o.spatialReference=s),i!=null&&(o.z=i),r!=null&&(o.m=r),o}get cache(){return this.commitProperty("x"),this.commitProperty("y"),this.commitProperty("z"),this.commitProperty("m"),this.commitProperty("spatialReference"),{}}get hasM(){return this.m!==void 0}set hasM(t){t!==(this._get("m")!==void 0)&&(this._set("m",t?0:void 0),this._set("hasM",t))}get hasZ(){return this.z!==void 0}set hasZ(t){t!==(this._get("z")!==void 0)&&(this._set("z",t?0:void 0),this._set("hasZ",t))}get latitude(){const{spatialReference:t,x:e,y:i}=this;if(t){if(t.isWebMercator)return ax(e,i,cx)[1];if(t.isGeographic)return i}return null}set latitude(t){const{spatialReference:e,x:i}=this;e&&(e.isWebMercator?this._set("y",Jv(i,t,cx)[1]):e.isGeographic&&this._set("y",t),this._set("latitude",t))}get longitude(){const{x:t,y:e,spatialReference:i}=this;if(i){if(i.isWebMercator)return ax(t,e,cx)[0];if(i.isGeographic)return t}return null}set longitude(t){const{y:e,spatialReference:i}=this;i&&(i.isWebMercator?this._set("x",Jv(t,e,cx)[0]):i.isGeographic&&this._set("x",t),this._set("longitude",t))}writeX(t,e,i){e[i]=isNaN(t)?"NaN":t}readX(t){return typeof t=="string"?NaN:t}clone(){const t=new wM;return t.x=this.x,t.y=this.y,t.z=this.z,t.m=this.m,t.spatialReference=this.spatialReference,t}copy(t){return wM.copy(t,this),this}equals(t){if(A(t))return!1;const{x:e,y:i,z:r,m:s,spatialReference:n}=this,{z:o,m:a}=t;let{x:l,y:c,spatialReference:h}=t;if(!n.equals(h))if(n.isWebMercator&&h.isWGS84)[l,c]=Jv(l,c),h=n;else{if(!n.isWGS84||!h.isWebMercator)return!1;[l,c]=ax(l,c),h=n}return e===l&&i===c&&r===o&&s===a&&n.wkid===h.wkid}offset(t,e,i){return M1e(this,t,e,i)}normalize(){if(!this.spatialReference)return this;const t=Pp(this.spatialReference);if(!t)return this;let e=this.x;const[i,r]=t.valid,s=2*r;let n;return e>r?(n=Math.ceil(Math.abs(e-r)/s),e-=n*s):e<i&&(n=Math.ceil(Math.abs(e-i)/s),e+=n*s),this._set("x",e),this}distance(t){return P1e(this,t)}toArray(){const t=this.hasZ,e=this.hasM;return t&&e?[this.x,this.y,this.z,this.m]:t?[this.x,this.y,this.z]:e?[this.x,this.y,this.m]:[this.x,this.y]}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],Rn.prototype,"cache",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],Rn.prototype,"hasM",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],Rn.prototype,"hasZ",null),u([d({type:Number})],Rn.prototype,"latitude",null),u([d({type:Number})],Rn.prototype,"longitude",null),u([d({type:Number,json:{type:[Number,String],write:{isRequired:!0,allowNull:!0}}}),ut(t=>isNaN(t)?t:kl(t))],Rn.prototype,"x",void 0),u([Ee("x")],Rn.prototype,"writeX",null),u([Ce("x")],Rn.prototype,"readX",null),u([d({type:Number,json:{write:!0}})],Rn.prototype,"y",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasZ}}}}})],Rn.prototype,"z",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasM}}}}})],Rn.prototype,"m",void 0),Rn=wM=u([R("esri.geometry.Point")],Rn),Rn.prototype.toJSON.isDefaultToJSON=!0;const je=Rn,nF=[0,0];function ux(t,e){return!!_(e)&&In(t,e.x,e.y,e.z)}function ont(t,e){if(!e.points||e.points.length)return!1;for(const i of e.points)if(!Qv(t,i))return!1;return!0}function E1e(t,e){const{xmin:i,ymin:r,zmin:s,xmax:n,ymax:o,zmax:a}=e;return t.hasZ&&e.hasZ?In(t,i,r,s)&&In(t,i,o,s)&&In(t,n,o,s)&&In(t,n,r,s)&&In(t,i,r,a)&&In(t,i,o,a)&&In(t,n,o,a)&&In(t,n,r,a):In(t,i,r)&&In(t,i,o)&&In(t,n,o)&&In(t,n,r)}function Qv(t,e){return In(t,e[0],e[1])}function O1e(t,e){return In(t,e[0],e[1],e[2])}function In(t,e,i,r){return e>=t.xmin&&e<=t.xmax&&i>=t.ymin&&i<=t.ymax&&(r==null||!t.hasZ||r>=t.zmin&&r<=t.zmax)}function R1e(t,e){return nF[1]=e.y,nF[0]=e.x,jq(t,nF)}function jq(t,e){return I1e(t.rings,e)}function I1e(t,e){if(!t)return!1;if(D1e(t))return Bq(!1,t,e);let i=!1;for(let r=0,s=t.length;r<s;r++)i=Bq(i,t[r],e);return i}function D1e(t){return!Array.isArray(t[0][0])}function Bq(t,e,i){const[r,s]=i;let n=t,o=0;for(let a=0,l=e.length;a<l;a++){o++,o===l&&(o=0);const[c,h]=e[a],[p,f]=e[o];(h<s&&f>=s||f<s&&h>=s)&&c+(s-h)/(f-h)*(p-c)<r&&(n=!n)}return n}function F1e(t,e){return ux(t,e)}function L1e(t,e){const i=t.hasZ&&e.hasZ;let r,s,n;if(t.xmin<=e.xmin){if(r=e.xmin,t.xmax<r)return!1}else if(r=t.xmin,e.xmax<r)return!1;if(t.ymin<=e.ymin){if(s=e.ymin,t.ymax<s)return!1}else if(s=t.ymin,e.ymax<s)return!1;if(i&&e.hasZ){if(t.zmin<=e.zmin){if(n=e.zmin,t.zmax<n)return!1}else if(n=t.zmin,e.zmax<n)return!1}return!0}function k1e(t,e){const{points:i,hasZ:r}=e,s=r?O1e:Qv;for(const n of i)if(s(t,n))return!0;return!1}const xg=[0,0],Sg=[0,0],Tg=[0,0],Cg=[0,0],z1e=[xg,Sg,Tg,Cg],Gq=[[Tg,xg],[xg,Sg],[Sg,Cg],[Cg,Tg]];function V1e(t,e){xg[0]=t.xmin,xg[1]=t.ymax,Sg[0]=t.xmax,Sg[1]=t.ymax,Tg[0]=t.xmin,Tg[1]=t.ymin,Cg[0]=t.xmax,Cg[1]=t.ymin;for(const i of z1e)if(jq(e,i))return!0;for(const i of e.rings){if(!i.length)continue;let r=i[0];if(Qv(t,r))return!0;for(let s=1;s<i.length;s++){const n=i[s];if(Qv(t,n)||qq(r,n,Gq))return!0;r=n}}return!1}function N1e(t,e){xg[0]=t.xmin,xg[1]=t.ymax,Sg[0]=t.xmax,Sg[1]=t.ymax,Tg[0]=t.xmin,Tg[1]=t.ymin,Cg[0]=t.xmax,Cg[1]=t.ymin;const i=e.paths;for(const r of i){if(!i.length)continue;let s=r[0];if(Qv(t,s))return!0;for(let n=1;n<r.length;n++){const o=r[n];if(Qv(t,o)||qq(s,o,Gq))return!0;s=o}}return!1}const gs=[0,0];function U1e(t){for(let e=0;e<t.length;e++){const i=t[e];for(let s=0;s<i.length-1;s++){const n=i[s],o=i[s+1];for(let a=e+1;a<t.length;a++)for(let l=0;l<t[a].length-1;l++){const c=t[a][l],h=t[a][l+1];if(oF(n,o,c,h,gs)&&!(gs[0]===n[0]&&gs[1]===n[1]||gs[0]===c[0]&&gs[1]===c[1]||gs[0]===o[0]&&gs[1]===o[1]||gs[0]===h[0]&&gs[1]===h[1]))return!0}}const r=i.length;if(!(r<=4))for(let s=0;s<r-3;s++){let n=r-1;s===0&&(n=r-2);const o=i[s],a=i[s+1];for(let l=s+2;l<n;l++){const c=i[l],h=i[l+1];if(oF(o,a,c,h,gs)&&!(gs[0]===o[0]&&gs[1]===o[1]||gs[0]===c[0]&&gs[1]===c[1]||gs[0]===a[0]&&gs[1]===a[1]||gs[0]===h[0]&&gs[1]===h[1]))return!0}}}return!1}function qq(t,e,i){for(let r=0;r<i.length;r++)if(oF(t,e,i[r][0],i[r][1]))return!0;return!1}function oF(t,e,i,r,s){const[n,o]=t,[a,l]=e,[c,h]=i,[p,f]=r,g=p-c,y=n-c,v=a-n,b=f-h,w=o-h,S=l-o,T=b*v-g*S;if(T===0)return!1;const C=(g*w-b*y)/T,M=(v*w-S*y)/T;return C>=0&&C<=1&&M>=0&&M<=1&&(s&&(s[0]=n+C*(a-n),s[1]=o+C*(l-o)),!0)}function j1e(t){switch(t){case"esriGeometryEnvelope":case"extent":return L1e;case"esriGeometryMultipoint":case"multipoint":return k1e;case"esriGeometryPoint":case"point":return F1e;case"esriGeometryPolygon":case"polygon":return V1e;case"esriGeometryPolyline":case"polyline":return N1e}}var Fa;function B1e(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}function Ap(t,e,i){return e==null?i:i==null?e:t(e,i)}let es=Fa=class extends ho{constructor(...t){super(...t),this.type="extent",this.xmin=0,this.ymin=0,this.mmin=void 0,this.zmin=void 0,this.xmax=0,this.ymax=0,this.mmax=void 0,this.zmax=void 0}normalizeCtorArgs(t,e,i,r,s){return B1e(t)?{spatialReference:t,xmin:0,ymin:0,xmax:0,ymax:0}:typeof t=="object"?(t.spatialReference=t.spatialReference==null?Ue.WGS84:t.spatialReference,t):{xmin:t,ymin:e,xmax:i,ymax:r,spatialReference:s==null?Ue.WGS84:s}}static fromBounds(t,e){return new Fa({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e})}static fromPoint(t){return new Fa({xmin:t.x,ymin:t.y,zmin:t.z,xmax:t.x,ymax:t.y,zmax:t.z,spatialReference:t.spatialReference})}get cache(){return this.commitProperty("xmin"),this.commitProperty("ymin"),this.commitProperty("zmin"),this.commitProperty("mmin"),this.commitProperty("xmax"),this.commitProperty("ymax"),this.commitProperty("zmax"),this.commitProperty("mmax"),this.commitProperty("spatialReference"),{}}get center(){const t=new je({x:.5*(this.xmin+this.xmax),y:.5*(this.ymin+this.ymax),spatialReference:this.spatialReference});return this.hasZ&&(t.z=.5*(this.zmin+this.zmax)),this.hasM&&(t.m=.5*(this.mmin+this.mmax)),t}get extent(){return this.clone()}get hasM(){return this.mmin!=null&&this.mmax!=null}get hasZ(){return this.zmin!=null&&this.zmax!=null}get height(){return Math.abs(this.ymax-this.ymin)}get width(){return Math.abs(this.xmax-this.xmin)}centerAt(t){const e=this.center;return t.z!=null&&this.hasZ?this.offset(t.x-e.x,t.y-e.y,t.z-e.z):this.offset(t.x-e.x,t.y-e.y)}clone(){const t=new Fa;return t.xmin=this.xmin,t.ymin=this.ymin,t.xmax=this.xmax,t.ymax=this.ymax,t.spatialReference=this.spatialReference,this.zmin!=null&&(t.zmin=this.zmin,t.zmax=this.zmax),this.mmin!=null&&(t.mmin=this.mmin,t.mmax=this.mmax),t}contains(t){if(!t)return!1;const e=this.spatialReference,i=t.spatialReference;return e&&i&&!e.equals(i)&&Rh(e,i)&&(t=e.isWebMercator?Ih(t):lx(t,!0)),t.type==="point"?ux(this,t):t.type==="extent"&&E1e(this,t)}equals(t){if(this===t)return!0;if(A(t))return!1;const e=this.spatialReference,i=t.spatialReference;return e&&i&&!e.equals(i)&&Rh(e,i)&&(t=e.isWebMercator?Ih(t):lx(t,!0)),this.xmin===t.xmin&&this.ymin===t.ymin&&this.zmin===t.zmin&&this.mmin===t.mmin&&this.xmax===t.xmax&&this.ymax===t.ymax&&this.zmax===t.zmax&&this.mmax===t.mmax}expand(t){const e=.5*(1-t),i=this.width*e,r=this.height*e;if(this.xmin+=i,this.ymin+=r,this.xmax-=i,this.ymax-=r,this.hasZ){const s=(this.zmax-this.zmin)*e;this.zmin+=s,this.zmax-=s}if(this.hasM){const s=(this.mmax-this.mmin)*e;this.mmin+=s,this.mmax-=s}return this}intersects(t){if(A(t))return!1;t.type==="mesh"&&(t=t.extent);const e=this.spatialReference,i=t.spatialReference;return e&&i&&!e.equals(i)&&Rh(e,i)&&(t=e.isWebMercator?Ih(t):lx(t,!0)),j1e(t.type)(this,t)}normalize(){const t=this._normalize(!1,!0);return Array.isArray(t)?t:[t]}offset(t,e,i){return this.xmin+=t,this.ymin+=e,this.xmax+=t,this.ymax+=e,i!=null&&(this.zmin+=i,this.zmax+=i),this}shiftCentralMeridian(){return this._normalize(!0)}union(t){return this===t||(this.xmin=Math.min(this.xmin,t.xmin),this.ymin=Math.min(this.ymin,t.ymin),this.xmax=Math.max(this.xmax,t.xmax),this.ymax=Math.max(this.ymax,t.ymax),(this.hasZ||t.hasZ)&&(this.zmin=Ap(Math.min,this.zmin,t.zmin),this.zmax=Ap(Math.max,this.zmax,t.zmax)),(this.hasM||t.hasM)&&(this.mmin=Ap(Math.min,this.mmin,t.mmin),this.mmax=Ap(Math.max,this.mmax,t.mmax))),this}intersection(t){return this===t?this:A(t)||!this.intersects(t)?null:(this.xmin=Math.max(this.xmin,t.xmin),this.ymin=Math.max(this.ymin,t.ymin),this.xmax=Math.min(this.xmax,t.xmax),this.ymax=Math.min(this.ymax,t.ymax),(this.hasZ||t.hasZ)&&(this.zmin=Ap(Math.max,this.zmin,t.zmin),this.zmax=Ap(Math.min,this.zmax,t.zmax)),(this.hasM||t.hasM)&&(this.mmin=Ap(Math.max,this.mmin,t.mmin),this.mmax=Ap(Math.min,this.mmax,t.mmax)),this)}toJSON(t){return this.write({},t)}_shiftCM(t=Pp(this.spatialReference)){if(!t||!this.spatialReference)return this;const e=this.spatialReference,i=this._getCM(t);if(i){const r=e.isWebMercator?lx(i):i;this.xmin-=i.x,this.xmax-=i.x,e.isWebMercator||(r.x=this._normalizeX(r.x,t).x),this.spatialReference=new Ue(Dl(e.isWGS84?t.altTemplate:t.wkTemplate,{Central_Meridian:r.x}))}return this}_getCM(t){let e=null;const[i,r]=t.valid,s=this.xmin,n=this.xmax;return s>=i&&s<=r&&n>=i&&n<=r||(e=this.center),e}_normalize(t,e,i){const r=this.spatialReference;if(!r)return this;if(!(i=i||Pp(r)))return this;const s=this._getParts(i).map(a=>a.extent);if(s.length<2)return s[0]||this;if(s.length>2)return t?this._shiftCM(i):this.set({xmin:i.valid[0],xmax:i.valid[1]});if(t)return this._shiftCM(i);if(e)return s;let n=!0,o=!0;return s.forEach(a=>{a.hasZ||(n=!1),a.hasM||(o=!1)}),{rings:s.map(a=>{const l=[[a.xmin,a.ymin],[a.xmin,a.ymax],[a.xmax,a.ymax],[a.xmax,a.ymin],[a.xmin,a.ymin]];if(n){const c=(a.zmax-a.zmin)/2;for(let h=0;h<l.length;h++)l[h].push(c)}if(o){const c=(a.mmax-a.mmin)/2;for(let h=0;h<l.length;h++)l[h].push(c)}return l}),hasZ:n,hasM:o,spatialReference:r}}_getParts(t){let e=this.cache._parts;if(!e){e=[];const{ymin:s,ymax:n,spatialReference:o}=this,a=this.width,l=this.xmin,c=this.xmax;let h;t=t||Pp(o);const[p,f]=t.valid;h=this._normalizeX(this.xmin,t);const g=h.x,y=h.frameId;h=this._normalizeX(this.xmax,t);const v=h.x,b=h.frameId,w=g===v&&a>0;if(a>2*f){const S=new Fa(l<c?g:v,s,f,n,o),T=new Fa(p,s,l<c?v:g,n,o),C=new Fa(0,s,f,n,o),M=new Fa(p,s,0,n,o),P=[],F=[];S.contains(C)&&P.push(y),S.contains(M)&&F.push(y),T.contains(C)&&P.push(b),T.contains(M)&&F.push(b);for(let z=y+1;z<b;z++)P.push(z),F.push(z);e.push({extent:S,frameIds:[y]},{extent:T,frameIds:[b]},{extent:C,frameIds:P},{extent:M,frameIds:F})}else g>v||w?e.push({extent:new Fa(g,s,f,n,o),frameIds:[y]},{extent:new Fa(p,s,v,n,o),frameIds:[b]}):e.push({extent:new Fa(g,s,v,n,o),frameIds:[y]});this.cache._parts=e}const i=this.hasZ,r=this.hasM;if(i||r){const s={};i&&(s.zmin=this.zmin,s.zmax=this.zmax),r&&(s.mmin=this.mmin,s.mmax=this.mmax);for(let n=0;n<e.length;n++)e[n].extent.set(s)}return e}_normalizeX(t,e){const[i,r]=e.valid,s=2*r;let n,o=0;return t>r?(n=Math.ceil(Math.abs(t-r)/s),t-=n*s,o=n):t<i&&(n=Math.ceil(Math.abs(t-i)/s),t+=n*s,o=-n),{x:t,frameId:o}}};u([d({readOnly:!0})],es.prototype,"cache",null),u([d({readOnly:!0})],es.prototype,"center",null),u([d({readOnly:!0})],es.prototype,"extent",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],es.prototype,"hasM",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],es.prototype,"hasZ",null),u([d({readOnly:!0})],es.prototype,"height",null),u([d({readOnly:!0})],es.prototype,"width",null),u([d({type:Number,json:{type:[Number,String],write:{enabled:!0,allowNull:!0}}})],es.prototype,"xmin",void 0),u([d({type:Number,json:{write:!0}})],es.prototype,"ymin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],es.prototype,"mmin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],es.prototype,"zmin",void 0),u([d({type:Number,json:{write:!0}})],es.prototype,"xmax",void 0),u([d({type:Number,json:{write:!0}})],es.prototype,"ymax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],es.prototype,"mmax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],es.prototype,"zmax",void 0),es=Fa=u([R("esri.geometry.Extent")],es),es.prototype.toJSON.isDefaultToJSON=!0;const ht=es;var Hq,Wq,Zq;let G1e,hx;const Jq=(Hq=(Wq=globalThis.esriConfig)==null?void 0:Wq.locale)!=null?Hq:(Zq=globalThis.dojoConfig)==null?void 0:Zq.locale;function Qq(){var t,e;return(t=Jq!=null?Jq:(e=globalThis.navigator)==null?void 0:e.language)!=null?t:"en"}function La(){return hx===void 0&&(hx=Qq()),hx}const dx=[];function q1e(t){return dx.push(t),{remove(){dx.splice(dx.indexOf(t),1)}}}const aF=[];function lF(t){return aF.push(t),{remove(){dx.splice(aF.indexOf(t),1)}}}function H1e(){var t;const e=(t=G1e)!=null?t:Qq();hx!==e&&(hx=e,[...aF].forEach(i=>{i.call(null,e)}),[...dx].forEach(i=>{i.call(null,e)}))}globalThis.addEventListener==null||globalThis.addEventListener("languagechange",H1e);class wt{constructor(e,i={ignoreUnknown:!1}){this.jsonToAPI=e,this.options=i,this.apiValues=[],this.jsonValues=[],this.apiToJSON=this.invertMap(e),this.apiValues=this.getKeysSorted(this.apiToJSON),this.jsonValues=this.getKeysSorted(this.jsonToAPI),this.read=r=>this.fromJSON(r),this.write=(r,s,n)=>{const o=this.toJSON(r);o!==void 0&&Bo(n,o,s)},this.write.isJSONMapWriter=!0}toJSON(e){return this.apiToJSON.hasOwnProperty(e)?this.apiToJSON[e]:this.options.ignoreUnknown?void 0:e}fromJSON(e){return this.jsonToAPI.hasOwnProperty(e)?this.jsonToAPI[e]:this.options.ignoreUnknown?void 0:e}invertMap(e){const i={};for(const r in e)i[e[r]]=r;return i}getKeysSorted(e){const i=[];for(const r in e)i.push(r);return i.sort(),i}}function Ds(){return function(t){return new wt(t,{ignoreUnknown:!0})}}var cF;const W1e=new wt({avgRating:"avg-rating",numRatings:"num-ratings",numComments:"num-comments",numViews:"num-views"});let ka=cF=class extends ve{constructor(t){super(t),this.categories=null,this.disableExtraQuery=!1,this.extent=null,this.filter=null,this.num=10,this.query=null,this.sortField=null,this.start=1}get sortOrder(){return this._get("sortOrder")||"asc"}set sortOrder(t){t!=="asc"&&t!=="desc"||this._set("sortOrder",t)}clone(){return new cF({categories:this.categories?ie(this.categories):null,disableExtraQuery:this.disableExtraQuery,extent:this.extent?this.extent.clone():null,filter:this.filter,num:this.num,query:this.query,sortField:this.sortField,sortOrder:this.sortOrder,start:this.start})}toRequestOptions(t,e){let i,r;if(this.categories&&(i=this.categories.map(o=>Array.isArray(o)?JSON.stringify(o):o)),this.extent){const o=wg(this.extent,Ue.WGS84);_(o)&&(r=`${o.xmin},${o.ymin},${o.xmax},${o.ymax}`)}let s=this.query;!this.disableExtraQuery&&t.extraQuery&&(s="("+s+")"+t.extraQuery);const n={categories:i,bbox:r,q:s,filter:this.filter,num:this.num,sortField:null,sortOrder:null,start:this.start};return this.sortField&&(n.sortField=this.sortField.split(",").map(o=>W1e.toJSON(o.trim())).join(","),n.sortOrder=this.sortOrder),{query:E(E({},e),n)}}};u([d()],ka.prototype,"categories",void 0),u([d()],ka.prototype,"disableExtraQuery",void 0),u([d({type:ht})],ka.prototype,"extent",void 0),u([d()],ka.prototype,"filter",void 0),u([d()],ka.prototype,"num",void 0),u([d()],ka.prototype,"query",void 0),u([d()],ka.prototype,"sortField",void 0),u([d()],ka.prototype,"sortOrder",null),u([d()],ka.prototype,"start",void 0),ka=cF=u([R("esri.portal.PortalQueryParams")],ka);const Dh=ka;let Mg=class extends ve{constructor(t){super(t),this.nextQueryParams=null,this.queryParams=null,this.results=null,this.total=null}};u([d()],Mg.prototype,"nextQueryParams",void 0),u([d()],Mg.prototype,"queryParams",void 0),u([d()],Mg.prototype,"results",void 0),u([d()],Mg.prototype,"total",void 0),Mg=u([R("esri.portal.PortalQueryResult")],Mg);const Z1e=Mg;let Fh=class extends ge{constructor(t){super(t),this.created=null,this.id=null,this.portal=null,this.title=null,this.username=null}get url(){const t=this.get("portal.restUrl");return t?`${t}/content/users/${this.username}/${this.id}`:null}toJSON(){throw new Q("internal:not-yet-implemented","PortalFolder.toJSON is not yet implemented")}};u([d({type:Date})],Fh.prototype,"created",void 0),u([d()],Fh.prototype,"id",void 0),u([d()],Fh.prototype,"portal",void 0),u([d()],Fh.prototype,"title",void 0),u([d({readOnly:!0})],Fh.prototype,"url",null),u([d()],Fh.prototype,"username",void 0),Fh=u([R("esri.portal.PortalFolder")],Fh);const J1e=Fh;let ts=class extends ge{constructor(t){super(t),this.access=null,this.created=null,this.description=null,this.id=null,this.isInvitationOnly=!1,this.modified=null,this.owner=null,this.portal=null,this.snippet=null,this.sortField=null,this.sortOrder=null,this.tags=null,this.title=null}get thumbnailUrl(){const t=this.url,e=this.thumbnail;return t&&e?this.portal._normalizeUrl(`${t}/info/${e}?f=json`):null}get url(){const t=this.get("portal.restUrl");return t?t+"/community/groups/"+this.id:null}fetchCategorySchema(t){return this.portal._request(this.url+"/categorySchema",t).then(e=>{const i=e.categorySchema||[];return i.some(r=>r.source==="contentCategorySetsGroupQuery.LivingAtlas")?this._fetchCategorySchemaSet("LivingAtlas",t):i})}fetchMembers(t){return this.portal._request(this.url+"/users",t)}getThumbnailUrl(t){let e=this.thumbnailUrl;return e&&t&&(e+=`&w=${t}`),e}toJSON(){throw new Q("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}queryItems(t,e){let i=Ni(Dh,t);return parseFloat(this.portal.currentVersion)>5?(i=i||new Dh,this.portal._queryPortal(`/content/groups/${this.id}/search`,i,"PortalItem",e)):(i=i?i.clone():new Dh,i.query="group:"+this.id+(i.query?" "+i.query:""),this.portal.queryItems(i,e))}_fetchCategorySchemaSet(t,e){return this.portal._fetchSelf(this.portal.authMode,!0,e).then(i=>{const r=i.contentCategorySetsGroupQuery;if(r){const s=new Dh;return s.disableExtraQuery=!0,s.num=1,s.query=r,this.portal.queryGroups(s,e)}throw new Q("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery value not found")}).then(i=>{if(i.total){const r=i.results[0],s=new Dh;return s.num=1,s.query=`typekeywords:"${t}"`,r.queryItems(s,e)}throw new Q("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery group not found")}).then(i=>i.total?i.results[0].fetchData("json",e).then(r=>{const s=r&&r.categorySchema;return s&&s.length?s:[]}):[])}};u([d()],ts.prototype,"access",void 0),u([d({type:Date})],ts.prototype,"created",void 0),u([d()],ts.prototype,"description",void 0),u([d()],ts.prototype,"id",void 0),u([d()],ts.prototype,"isInvitationOnly",void 0),u([d({type:Date})],ts.prototype,"modified",void 0),u([d()],ts.prototype,"owner",void 0),u([d()],ts.prototype,"portal",void 0),u([d()],ts.prototype,"snippet",void 0),u([d()],ts.prototype,"sortField",void 0),u([d()],ts.prototype,"sortOrder",void 0),u([d()],ts.prototype,"tags",void 0),u([d()],ts.prototype,"thumbnail",void 0),u([d({readOnly:!0})],ts.prototype,"thumbnailUrl",null),u([d()],ts.prototype,"title",void 0),u([d({readOnly:!0})],ts.prototype,"url",null),ts=u([R("esri.portal.PortalGroup")],ts);const uF=ts;var Q1e=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:uF}),hF;let Ri=hF=class extends ge{constructor(...t){super(...t),this.access=null,this.created=null,this.culture=null,this.description=null,this.email=null,this.fullName=null,this.modified=null,this.orgId=null,this.portal=null,this.preferredView=null,this.privileges=null,this.region=null,this.role=null,this.roleId=null,this.sourceJSON=null,this.units=null,this.username=null,this.userType=null}get thumbnailUrl(){const t=this.url,e=this.thumbnail;return t&&e?this.portal._normalizeUrl(`${t}/info/${e}?f=json`):null}get userContentUrl(){const t=this.get("portal.restUrl");return t?`${t}/content/users/${this.username}`:null}get url(){const t=this.get("portal.restUrl");return t?`${t}/community/users/${this.username}`:null}addItem(t){const e=t&&t.item,i=t&&t.data,r=t&&t.folder,s={method:"post"};e&&(s.query=e.createPostQuery(),i!=null&&(typeof i=="string"?s.query.text=i:typeof i=="object"&&(s.query.text=JSON.stringify(i))));let n=this.userContentUrl;return r&&(n+="/"+(typeof r=="string"?r:r.id)),this.portal._request(n+"/addItem",s).then(o=>(e.id=o.id,e.portal=this.portal,e.loaded?e.reload():e.load()))}deleteItem(t){let e=this.userContentUrl;return t.ownerFolder&&(e+="/"+t.ownerFolder),this.portal._request(e+`/items/${t.id}/delete`,{method:"post"}).then(()=>{t.id=null,t.portal=null})}deleteItems(t){const e=this.userContentUrl+"/deleteItems",i=t.map(r=>r.id);if(i.length){const r={method:"post",query:{items:i.join(",")}};return this.portal._request(e,r).then(()=>{t.forEach(s=>{s.id=null,s.portal=null})})}return Promise.resolve(void 0)}fetchFolders(){const t={query:{num:1}};return this.portal._request(this.userContentUrl,t).then(e=>{let i;return i=e&&e.folders?e.folders.map(r=>{const s=J1e.fromJSON(r);return s.portal=this.portal,s}):[],i})}fetchGroups(){return this.portal._request(this.url).then(t=>{let e;return e=t&&t.groups?t.groups.map(i=>{const r=uF.fromJSON(i);return r.portal=this.portal,r}):[],e})}fetchItems(t){t||(t={});let e,i=this.userContentUrl;return t.folder&&(i+="/"+t.folder.id),Promise.resolve().then(function(){return Xq}).then(({default:r})=>{e=r;const s={folders:!1,num:t.num||10,start:t.start||1,sortField:t.sortField||"created",sortOrder:t.sortOrder||"asc"};return this.portal._request(i,{query:s})}).then(r=>{let s;return r&&r.items?(s=r.items.map(n=>{const o=e.fromJSON(n);return o.portal=this.portal,o}),Promise.all(s.map(n=>n.load())).catch(n=>n).then(()=>({items:s,nextStart:r.nextStart,total:r.total}))):{items:[],nextStart:-1,total:0}})}fetchTags(){return this.portal._request(this.url+"/tags").then(t=>t.tags)}getThumbnailUrl(t){let e=this.thumbnailUrl;return e&&t&&(e+=`&w=${t}`),e}queryFavorites(t){return this.favGroupId?(this._favGroup||(this._favGroup=new uF({id:this.favGroupId,portal:this.portal})),this._favGroup.queryItems(t)):Promise.reject(new Q("internal:unknown","Unknown internal error",{internalError:"Unknown favGroupId"}))}toJSON(){throw new Q("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");const e=new hF;return e.sourceJSON=t,e.read(t),e}};u([d()],Ri.prototype,"access",void 0),u([d({type:Date})],Ri.prototype,"created",void 0),u([d()],Ri.prototype,"culture",void 0),u([d()],Ri.prototype,"description",void 0),u([d()],Ri.prototype,"email",void 0),u([d()],Ri.prototype,"favGroupId",void 0),u([d()],Ri.prototype,"fullName",void 0),u([d({type:Date})],Ri.prototype,"modified",void 0),u([d()],Ri.prototype,"orgId",void 0),u([d()],Ri.prototype,"portal",void 0),u([d()],Ri.prototype,"preferredView",void 0),u([d()],Ri.prototype,"privileges",void 0),u([d()],Ri.prototype,"region",void 0),u([d()],Ri.prototype,"role",void 0),u([d()],Ri.prototype,"roleId",void 0),u([d()],Ri.prototype,"sourceJSON",void 0),u([d()],Ri.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Ri.prototype,"thumbnailUrl",null),u([d()],Ri.prototype,"units",void 0),u([d({readOnly:!0})],Ri.prototype,"userContentUrl",null),u([d({readOnly:!0})],Ri.prototype,"url",null),u([d()],Ri.prototype,"username",void 0),u([d()],Ri.prototype,"userType",void 0),Ri=hF=u([R("esri.portal.PortalUser")],Ri);const dF=Ri;var Y1e=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:dF}),Wo;let pF;const Yq={PortalGroup:()=>Promise.resolve().then(function(){return Q1e}),PortalItem:()=>Promise.resolve().then(function(){return Xq}),PortalUser:()=>Promise.resolve().then(function(){return Y1e})};let Pe=Wo=class extends ix(Ph){constructor(t){super(t),this.access=null,this.allSSL=!1,this.authMode="auto",this.authorizedCrossOriginDomains=null,this.basemapGalleryGroupQuery=null,this.bingKey=null,this.canListApps=!1,this.canListData=!1,this.canListPreProvisionedItems=!1,this.canProvisionDirectPurchase=!1,this.canSearchPublic=!0,this.canShareBingPublic=!1,this.canSharePublic=!1,this.canSignInArcGIS=!1,this.canSignInIDP=!1,this.colorSetsGroupQuery=null,this.commentsEnabled=!1,this.created=null,this.culture=null,this.customBaseUrl=null,this.defaultBasemap=null,this.defaultDevBasemap=null,this.defaultExtent=null,this.defaultVectorBasemap=null,this.description=null,this.devBasemapGalleryGroupQuery=null,this.eueiEnabled=null,this.featuredGroups=null,this.featuredItemsGroupQuery=null,this.galleryTemplatesGroupQuery=null,this.livingAtlasGroupQuery=null,this.hasCategorySchema=!1,this.helperServices=null,this.homePageFeaturedContent=null,this.homePageFeaturedContentCount=null,this.httpPort=null,this.httpsPort=null,this.id=null,this.ipCntryCode=null,this.isPortal=!1,this.isReadOnly=!1,this.layerTemplatesGroupQuery=null,this.maxTokenExpirationMinutes=null,this.modified=null,this.name=null,this.portalHostname=null,this.portalMode=null,this.portalProperties=null,this.region=null,this.rotatorPanels=null,this.showHomePageDescription=!1,this.sourceJSON=null,this.supportsHostedServices=!1,this.symbolSetsGroupQuery=null,this.templatesGroupQuery=null,this.units=null,this.url=ei.portalUrl,this.urlKey=null,this.user=null,this.useStandardizedQuery=!1,this.useVectorBasemaps=!1,this.vectorBasemapGalleryGroupQuery=null}normalizeCtorArgs(t){return typeof t=="string"?{url:t}:t}destroy(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)}readAuthorizedCrossOriginDomains(t){if(t)for(const e of t)ei.request.trustedServers.indexOf(e)===-1&&ei.request.trustedServers.push(e);return t}readDefaultBasemap(t){return this._readBasemap(t)}readDefaultDevBasemap(t){return this._readBasemap(t)}readDefaultVectorBasemap(t){return this._readBasemap(t)}get extraQuery(){const t=!(this.user&&this.user.orgId)||this.canSearchPublic;return this.id&&!t?` AND orgid:${this.id}`:null}get isOrganization(){return!!this.access}get restUrl(){let t=this.url;if(t){const e=t.indexOf("/sharing");t=e>0?t.substring(0,e):this.url.replace(/\/+$/,""),t+="/sharing/rest"}return t}get stylesGroupQuery(){return rD(le.getLogger(this.declaredClass),"stylesGroupQuery",{replacement:"stylesGroupQuery3d",version:"4.21"}),this.stylesGroupQuery3d}get thumbnailUrl(){const t=this.restUrl,e=this.thumbnail;return t&&e?this._normalizeSSL(t+"/portals/self/resources/"+e):null}readUrlKey(t){return t&&t.toLowerCase()}readUser(t){let e=null;return t&&(e=dF.fromJSON(t),e.portal=this),e}load(t){const e=Promise.resolve().then(function(){return m_e}).then(({default:i})=>{Dt(t),pF=i}).then(()=>this.sourceJSON?this.sourceJSON:this._fetchSelf(this.authMode,!1,t)).then(i=>{if(_r){const r=_r;this.credential=r.findCredential(this.restUrl),this.credential||this.authMode!==Wo.AUTH_MODE_AUTO||(this._esriId_credentialCreateHandle=r.on("credential-create",()=>{r.findCredential(this.restUrl)&&this._signIn()}))}this.sourceJSON=i,this.read(i)});return this.addResolvingPromise(e),Promise.resolve(this)}async createClosestFacilityTask(){kv(le.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/closestFacility",version:"4.21"}),await this.load();const t=this._getHelperServiceUrl("closestFacility");return new(await import("./ClosestFacilityTask.097eb295.js")).default(t)}async createElevationLayers(){await this.load();const t=this._getHelperService("defaultElevationLayers"),e=(await Promise.resolve().then(function(){return Mst})).default;return t?t.map(i=>new e({id:i.id,url:i.url})):[]}async createGeometryService(){kv(le.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/geometryService",version:"4.21"}),await this.load();const t=this._getHelperServiceUrl("geometry");return new(await import("./GeometryService.f2404cc9.js")).default({url:t})}async createPrintTask(){kv(le.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/print",version:"4.21"}),await this.load();const t=this._getHelperServiceUrl("printTask");return new(await import("./PrintTask.09115a35.js")).default(t)}async createRouteTask(){kv(le.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/route",version:"4.21"}),await this.load();const t=this._getHelperServiceUrl("route");return new(await import("./RouteTask.7069e383.js")).default(t)}async createServiceAreaTask(){kv(le.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/serviceArea",version:"4.21"}),await this.load();const t=this._getHelperServiceUrl("serviceArea");return new(await import("./ServiceAreaTask.2b817ec7.js")).default(t)}fetchBasemaps(t,e){const i=new Dh;return i.query=t||(ei.apiKey&&Eq(this.url)?this.devBasemapGalleryGroupQuery:this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),i.disableExtraQuery=!0,this.queryGroups(i,e).then(r=>{if(i.num=100,i.query='type:"Web Map" -type:"Web Application"',r.total){const s=r.results[0];return i.sortField=s.sortField||"name",i.sortOrder=s.sortOrder||"desc",s.queryItems(i,e)}return null}).then(r=>{let s;return s=r&&r.total?r.results.filter(n=>n.type==="Web Map").map(n=>new pF({portalItem:n})):[],s})}fetchCategorySchema(t){return this.hasCategorySchema?this._request(this.restUrl+"/portals/self/categorySchema",t).then(e=>e.categorySchema):Ir(t)?Promise.reject($t()):Promise.resolve([])}fetchFeaturedGroups(t){const e=this.featuredGroups,i=new Dh;if(i.num=100,i.sortField="title",e&&e.length){const r=[];for(const s of e)r.push(`(title:"${s.title}" AND owner:${s.owner})`);return i.query=r.join(" OR "),this.queryGroups(i,t).then(s=>s.results)}return Ir(t)?Promise.reject($t()):Promise.resolve([])}fetchRegions(t){const e=this.user&&this.user.culture||this.culture||La();return this._request(this.restUrl+"/portals/regions",he(E({},t),{query:{culture:e}}))}static getDefault(){return Wo._default&&!Wo._default.destroyed||(Wo._default=new Wo),Wo._default}queryGroups(t,e){return this._queryPortal("/community/groups",t,"PortalGroup",e)}queryItems(t,e){return this._queryPortal("/search",t,"PortalItem",e)}queryUsers(t,e){return t.sortField||(t.sortField="username"),this._queryPortal("/community/users",t,"PortalUser",e)}toJSON(){throw new Q("internal:not-yet-implemented","Portal.toJSON is not yet implemented")}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");return new Wo({sourceJSON:t})}_getHelperService(t){const e=this.helperServices&&this.helperServices[t];if(!e)throw new Q("portal:service-not-found",`The \`helperServices\` do not include an entry named "${t}"`);return e}_getHelperServiceUrl(t){const e=this._getHelperService(t);if(!e.url)throw new Q("portal:service-url-not-found",`The \`helperServices\` entry "${t}" does not include a \`url\` value`);return e.url}_fetchSelf(t=this.authMode,e=!1,i){const r=this.restUrl+"/portals/self",s=E({authMode:t,query:{culture:La().toLowerCase()}},i);return s.authMode==="auto"&&(s.authMode="no-prompt"),e&&(s.query.default=!0),this._request(r,s)}_queryPortal(t,e,i,r){const s=Ni(Dh,e),n=o=>this._request(this.restUrl+t,E(E({},s.toRequestOptions(this)),r)).then(a=>{const l=s.clone();return l.start=a.nextStart,new Z1e({nextQueryParams:l,queryParams:s,total:a.total,results:Wo._resultsToTypedArray(o,{portal:this},a,r)})}).then(a=>Promise.all(a.results.map(l=>typeof l.when=="function"?l.when():a)).then(()=>a,l=>(Wc(l),a)));return i&&Yq[i]?Yq[i]().then(({default:o})=>(Dt(r),n(o))):n()}_signIn(){if(this.authMode===Wo.AUTH_MODE_ANONYMOUS)return Promise.reject(new Q("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));if(this.loadStatus==="failed")return Promise.reject(this.loadError);const t=e=>Promise.resolve().then(()=>this.loadStatus==="not-loaded"?(e||(this.authMode="immediate"),this.load().then(()=>null)):this.loadStatus==="loading"?this.load().then(()=>this.credential?null:(this.credential=e,this._fetchSelf("immediate"))):this.user&&this.credential===e?null:(this.credential=e,this._fetchSelf("immediate"))).then(i=>{i&&(this.sourceJSON=i,this.read(i))});return _r?_r.getCredential(this.restUrl).then(e=>t(e)):t(this.credential)}_normalizeSSL(t){return t.replace(/^http:/i,"https:").replace(":7080",":7443")}_normalizeUrl(t){const e=this.credential&&this.credential.token;return this._normalizeSSL(e?t+(t.indexOf("?")>-1?"&":"?")+"token="+e:t)}_requestToTypedArray(t,e,i){return this._request(t,e).then(r=>{const s=Wo._resultsToTypedArray(i,{portal:this},r);return Promise.all(s.map(n=>typeof n.when=="function"?n.when():r)).then(()=>s,()=>s)})}_readBasemap(t){if(t){const e=pF.fromJSON(t);return e.portalItem={portal:this},e}return null}_request(t,e={}){const i=E({f:"json"},e.query),{authMode:r=this.authMode===Wo.AUTH_MODE_ANONYMOUS?"anonymous":"auto",body:s=null,cacheBust:n=!1,method:o="auto",responseType:a="json",signal:l}=e,c={authMode:r,body:s,cacheBust:n,method:o,query:i,responseType:a,timeout:0,signal:l};return vt(this._normalizeSSL(t),c).then(h=>h.data)}static _resultsToTypedArray(t,e,i,r){let s;if(i){const n=_(r)?r.signal:null;s=i.listings||i.notifications||i.userInvitations||i.tags||i.items||i.groups||i.comments||i.provisions||i.results||i.relatedItems||i,(t||e)&&(s=s.map(o=>{const a=Object.assign(t?t.fromJSON(o):o,e);return typeof a.load=="function"&&a.load(n),a}))}else s=[];return s}};Pe.AUTH_MODE_ANONYMOUS="anonymous",Pe.AUTH_MODE_AUTO="auto",Pe.AUTH_MODE_IMMEDIATE="immediate",u([d()],Pe.prototype,"access",void 0),u([d()],Pe.prototype,"allSSL",void 0),u([d()],Pe.prototype,"authMode",void 0),u([d()],Pe.prototype,"authorizedCrossOriginDomains",void 0),u([Ce("authorizedCrossOriginDomains")],Pe.prototype,"readAuthorizedCrossOriginDomains",null),u([d()],Pe.prototype,"basemapGalleryGroupQuery",void 0),u([d()],Pe.prototype,"bingKey",void 0),u([d()],Pe.prototype,"canListApps",void 0),u([d()],Pe.prototype,"canListData",void 0),u([d()],Pe.prototype,"canListPreProvisionedItems",void 0),u([d()],Pe.prototype,"canProvisionDirectPurchase",void 0),u([d()],Pe.prototype,"canSearchPublic",void 0),u([d()],Pe.prototype,"canShareBingPublic",void 0),u([d()],Pe.prototype,"canSharePublic",void 0),u([d()],Pe.prototype,"canSignInArcGIS",void 0),u([d()],Pe.prototype,"canSignInIDP",void 0),u([d()],Pe.prototype,"colorSetsGroupQuery",void 0),u([d()],Pe.prototype,"commentsEnabled",void 0),u([d({type:Date})],Pe.prototype,"created",void 0),u([d()],Pe.prototype,"credential",void 0),u([d()],Pe.prototype,"culture",void 0),u([d()],Pe.prototype,"currentVersion",void 0),u([d()],Pe.prototype,"customBaseUrl",void 0),u([d()],Pe.prototype,"defaultBasemap",void 0),u([Ce("defaultBasemap")],Pe.prototype,"readDefaultBasemap",null),u([d()],Pe.prototype,"defaultDevBasemap",void 0),u([Ce("defaultDevBasemap")],Pe.prototype,"readDefaultDevBasemap",null),u([d({type:ht})],Pe.prototype,"defaultExtent",void 0),u([d()],Pe.prototype,"defaultVectorBasemap",void 0),u([Ce("defaultVectorBasemap")],Pe.prototype,"readDefaultVectorBasemap",null),u([d()],Pe.prototype,"description",void 0),u([d()],Pe.prototype,"devBasemapGalleryGroupQuery",void 0),u([d()],Pe.prototype,"eueiEnabled",void 0),u([d({readOnly:!0})],Pe.prototype,"extraQuery",null),u([d()],Pe.prototype,"featuredGroups",void 0),u([d()],Pe.prototype,"featuredItemsGroupQuery",void 0),u([d()],Pe.prototype,"galleryTemplatesGroupQuery",void 0),u([d()],Pe.prototype,"livingAtlasGroupQuery",void 0),u([d()],Pe.prototype,"hasCategorySchema",void 0),u([d()],Pe.prototype,"helpBase",void 0),u([d()],Pe.prototype,"helperServices",void 0),u([d()],Pe.prototype,"helpMap",void 0),u([d()],Pe.prototype,"homePageFeaturedContent",void 0),u([d()],Pe.prototype,"homePageFeaturedContentCount",void 0),u([d()],Pe.prototype,"httpPort",void 0),u([d()],Pe.prototype,"httpsPort",void 0),u([d()],Pe.prototype,"id",void 0),u([d()],Pe.prototype,"ipCntryCode",void 0),u([d({readOnly:!0})],Pe.prototype,"isOrganization",null),u([d()],Pe.prototype,"isPortal",void 0),u([d()],Pe.prototype,"isReadOnly",void 0),u([d()],Pe.prototype,"layerTemplatesGroupQuery",void 0),u([d()],Pe.prototype,"maxTokenExpirationMinutes",void 0),u([d({type:Date})],Pe.prototype,"modified",void 0),u([d()],Pe.prototype,"name",void 0),u([d()],Pe.prototype,"portalHostname",void 0),u([d()],Pe.prototype,"portalMode",void 0),u([d()],Pe.prototype,"portalProperties",void 0),u([d()],Pe.prototype,"region",void 0),u([d({readOnly:!0})],Pe.prototype,"restUrl",null),u([d()],Pe.prototype,"rotatorPanels",void 0),u([d()],Pe.prototype,"showHomePageDescription",void 0),u([d()],Pe.prototype,"sourceJSON",void 0),u([d()],Pe.prototype,"staticImagesUrl",void 0),u([d({readOnly:!0,json:{read:!1}})],Pe.prototype,"stylesGroupQuery",null),u([d({json:{name:"2DStylesGroupQuery"}})],Pe.prototype,"stylesGroupQuery2d",void 0),u([d({json:{name:"stylesGroupQuery"}})],Pe.prototype,"stylesGroupQuery3d",void 0),u([d()],Pe.prototype,"supportsHostedServices",void 0),u([d()],Pe.prototype,"symbolSetsGroupQuery",void 0),u([d()],Pe.prototype,"templatesGroupQuery",void 0),u([d()],Pe.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Pe.prototype,"thumbnailUrl",null),u([d()],Pe.prototype,"units",void 0),u([d()],Pe.prototype,"url",void 0),u([d()],Pe.prototype,"urlKey",void 0),u([Ce("urlKey")],Pe.prototype,"readUrlKey",null),u([d()],Pe.prototype,"user",void 0),u([Ce("user")],Pe.prototype,"readUser",null),u([d()],Pe.prototype,"useStandardizedQuery",void 0),u([d()],Pe.prototype,"useVectorBasemaps",void 0),u([d()],Pe.prototype,"vectorBasemapGalleryGroupQuery",void 0),Pe=Wo=u([R("esri.portal.Portal")],Pe);const po=Pe,X1e=le.getLogger("esri.assets");function K1e(t,e){return vt(kt(t),e)}function kt(t){if(!ei.assetsPath)throw X1e.errorOnce("The API assets location needs to be set using config.assetsPath. More information: https://arcg.is/1OzLe50"),new Q("assets:path-not-set","config.assetsPath is not set");return Mp(ei.assetsPath,t)}const e_e=le.getLogger("esri.portal.PortalItemResource");let $p=class extends ve{constructor(t){super(t),this.portalItem=null}normalizeCtorArgs(t){return t&&t.portalItem&&t.path?he(E({},t),{path:this.normalizePath(t.path,t.portalItem)}):t}set path(t){_(t)&&qo(t)?e_e.error("portalitemresource:invalid-path","A portal item resource path must be relative"):this._set("path",t)}_castPath(t){return this.normalizePath(t,this.portalItem)}get url(){return this.portalItem&&this.path?`${this.portalItem.itemUrl}/resources/${this.path}`:null}get itemRelativeUrl(){return this.portalItem&&this.path?`./resources/${this.path}`:null}fetch(t="json",e){const i=this.url;if(A(i))throw new Q("portal-item-resource:fetch","Portal item resource does not refer to a valid item or path");return this.portalItem.portal._request(i,{responseType:t,query:{token:this.portalItem.apiKey},signal:or(e,"signal")})}async update(t,e){return(await import("./resourceUtils.a20a4920.js")).addOrUpdateResource(this,"update",t,e)}hasPath(){return _(this.path)}normalizePath(t,e){return A(t)?t:(t=t.replace(/^\/+/,""),_(e)&&qo(t)&&(t=GD(t,e.itemUrl)),t.replace(/^\/+/,"").replace(/^(\.\/)?resources\//,""))}};u([d()],$p.prototype,"portalItem",void 0),u([d({type:String,value:null})],$p.prototype,"path",null),u([ut("path")],$p.prototype,"_castPath",null),u([d({type:String,readOnly:!0})],$p.prototype,"url",null),u([d({type:String,readOnly:!0})],$p.prototype,"itemRelativeUrl",null),$p=u([R("esri.portal.PortalItemResource")],$p);const t_e=$p;let px=class extends ve{constructor(t){super(t),this.created=null,this.rating=null}};u([d()],px.prototype,"created",void 0),u([d()],px.prototype,"rating",void 0),px=u([R("esri.portal.PortalRating")],px);const fF=px;var Yv;let St=Yv=class extends ix(Ph){constructor(t){super(t),this.access=null,this.accessInformation=null,this.apiKey=null,this.applicationProxies=null,this.avgRating=null,this.categories=null,this.created=null,this.culture=null,this.description=null,this.extent=null,this.groupCategories=null,this.id=null,this.itemControl=null,this.licenseInfo=null,this.modified=null,this.name=null,this.numComments=null,this.numRatings=null,this.numViews=null,this.owner=null,this.ownerFolder=null,this.portal=null,this.screenshots=null,this.size=null,this.snippet=null,this.sourceJSON=null,this.tags=null,this.title=null,this.type=null,this.typeKeywords=null,this.url=null}static from(t){return Bv(Yv,t)}destroy(){this.portal=null}get displayName(){const t=this.type,e=this.typeKeywords||[];let i=t;return t==="Feature Service"||t==="Feature Collection"?i=e.indexOf("Table")>-1?"Table":e.indexOf("Route Layer")>-1?"Route Layer":e.indexOf("Markup")>-1?"Markup":"Feature Layer":t==="Image Service"?i=e.indexOf("Elevation 3D Layer")>-1?"Elevation Layer":e.indexOf("Tiled Imagery")>-1?"Tiled Imagery Layer":"Imagery Layer":t==="Scene Service"?i="Scene Layer":t==="Scene Package"?i="Scene Layer Package":t==="Stream Service"?i="Feature Layer":t==="Geoprocessing Service"&&this.portal&&this.portal.isPortal?i=e.indexOf("Web Tool")>-1?"Tool":"Geoprocessing Service":t==="Geocoding Service"?i="Locator":t==="Geoenrichment Service"?i="GeoEnrichment Service":t==="Microsoft Powerpoint"?i="Microsoft PowerPoint":t==="GeoJson"?i="GeoJSON":t==="Globe Service"?i="Globe Layer":t==="Vector Tile Service"?i="Tile Layer":t==="netCDF"?i="NetCDF":t==="Map Service"?i=e.indexOf("Spatiotemporal")===-1&&(e.indexOf("Hosted Service")>-1||e.indexOf("Tiled")>-1)&&e.indexOf("Relational")===-1?"Tile Layer":"Map Image Layer":t&&t.toLowerCase().indexOf("add in")>-1?i=t.replace(/(add in)/gi,"Add-In"):t==="datastore catalog service"?i="Big Data File Share":t==="Compact Tile Package"?i="Tile Package (tpkx)":t==="OGCFeatureServer"?i="OGC Feature Layer":t==="web mapping application"&&e.indexOf("configurableApp")>-1&&(i="Instant App"),i}readExtent(t){return t&&t.length?new ht(t[0][0],t[0][1],t[1][0],t[1][1]):null}get iconUrl(){const t=this.type&&this.type.toLowerCase()||"",e=this.typeKeywords||[],i="esri/images/portal/",r="16";let s,n=!1,o=!1,a=!1,l=!1,c=!1,h=!1;return t.indexOf("service")>0||t==="feature collection"||t==="kml"||t==="wms"||t==="wmts"||t==="wfs"?(n=e.indexOf("Hosted Service")>-1,t==="feature service"||t==="feature collection"||t==="kml"||t==="wfs"?(o=e.indexOf("Table")>-1,a=e.indexOf("Route Layer")>-1,l=e.indexOf("Markup")>-1,c=e.indexOf("Spatiotemporal")!==-1,h=e.indexOf("UtilityNetwork")!==-1,s=c&&o?"spatiotemporaltable":o?"table":a?"routelayer":l?"markup":c?"spatiotemporal":n?"featureshosted":h?"utilitynetwork":"features"):s=t==="map service"||t==="wms"||t==="wmts"?n||e.indexOf("Tiled")>-1||t==="wmts"?"maptiles":"mapimages":t==="scene service"?e.indexOf("Line")>-1?"sceneweblayerline":e.indexOf("3DObject")>-1?"sceneweblayermultipatch":e.indexOf("Point")>-1?"sceneweblayerpoint":e.indexOf("IntegratedMesh")>-1?"sceneweblayermesh":e.indexOf("PointCloud")>-1?"sceneweblayerpointcloud":e.indexOf("Polygon")>-1?"sceneweblayerpolygon":e.indexOf("Building")>-1?"sceneweblayerbuilding":e.indexOf("Voxel")>-1?"sceneweblayervoxel":"sceneweblayer":t==="image service"?e.indexOf("Elevation 3D Layer")>-1?"elevationlayer":e.indexOf("Tiled Imagery")>-1?"tiledimagerylayer":"imagery":t==="stream service"?"streamlayer":t==="vector tile service"?"vectortile":t==="datastore catalog service"?"datastorecollection":t==="geocoding service"?"geocodeservice":t==="geoprocessing service"&&e.indexOf("Web Tool")>-1&&this.portal&&this.portal.isPortal?"tool":"layers"):s=t==="web map"||t==="cityengine web scene"?"maps":t==="web scene"?e.indexOf("ViewingMode-Local")>-1?"webscenelocal":"websceneglobal":t==="web mapping application"&&e.indexOf("configurableApp")>-1?"instantapps":t==="web mapping application"||t==="mobile application"||t==="application"||t==="operation view"||t==="desktop application"?"apps":t==="map document"||t==="map package"||t==="published map"||t==="scene document"||t==="globe document"||t==="basemap package"||t==="mobile basemap package"||t==="mobile map package"||t==="project package"||t==="project template"||t==="pro map"||t==="layout"||t==="layer"&&e.indexOf("ArcGIS Pro")>-1||t==="explorer map"&&e.indexOf("Explorer Document")?"mapsgray":t==="service definition"||t==="csv"||t==="shapefile"||t==="cad drawing"||t==="geojson"||t==="360 vr experience"||t==="netcdf"||t==="administrative report"?"datafiles":t==="explorer add in"||t==="desktop add in"||t==="windows viewer add in"||t==="windows viewer configuration"?"appsgray":t==="arcgis pro add in"||t==="arcgis pro configuration"?"addindesktop":t==="rule package"||t==="file geodatabase"||t==="sqlite geodatabase"||t==="csv collection"||t==="kml collection"||t==="windows mobile package"||t==="map template"||t==="desktop application template"||t==="gml"||t==="arcpad package"||t==="code sample"||t==="form"||t==="document link"||t==="earth configuration"||t==="operations dashboard add in"||t==="rules package"||t==="image"||t==="workflow manager package"||t==="explorer map"&&e.indexOf("Explorer Mapping Application")>-1||e.indexOf("Document")>-1?"datafilesgray":t==="network analysis service"||t==="geoprocessing service"||t==="geodata service"||t==="geometry service"||t==="geoprocessing package"||t==="locator package"||t==="geoprocessing sample"||t==="workflow manager service"?"toolsgray":t==="layer"||t==="layer package"||t==="explorer layer"?"layersgray":t==="scene package"?"scenepackage":t==="mobile scene package"?"mobilescenepackage":t==="tile package"||t==="compact tile package"?"tilepackage":t==="task file"?"taskfile":t==="report template"?"report-template":t==="statistical data collection"?"statisticaldatacollection":t==="insights workbook"?"workbook":t==="insights model"?"insightsmodel":t==="insights page"?"insightspage":t==="insights theme"?"insightstheme":t==="hub initiative"?"hubinitiative":t==="hubpage"?"hubpage":t==="hub event"?"hubevent":t==="hub site application"?"hubsite":t==="relational database connection"?"relationaldatabaseconnection":t==="big data file share"?"datastorecollection":t==="image collection"?"imagecollection":t==="style"?"style":t==="desktop style"?"desktopstyle":t==="dashboard"?"dashboard":t==="raster function template"?"rasterprocessingtemplate":t==="vector tile package"?"vectortilepackage":t==="ortho mapping project"?"orthomappingproject":t==="ortho mapping template"?"orthomappingtemplate":t==="solution"?"solutions":t==="geopackage"?"geopackage":t==="deep learning package"?"deeplearningpackage":t==="real time analytic"?"realtimeanalytics":t==="big data analytic"?"bigdataanalytics":t==="feed"?"feed":t==="excalibur imagery project"?"excaliburimageryproject":t==="notebook"?"notebook":t==="storymap"?"storymap":t==="survey123 add in"?"survey123addin":t==="mission"?"mission":t==="mission report"?"missionreport":t==="quickcapture project"?"quickcaptureproject":t==="pro report"?"proreport":t==="urban model"?"urbanmodel":t==="web experience"?"experiencebuilder":t==="web experience template"?"webexperiencetemplate":t==="workflow"?"workflow":t==="insights script"?"insightsscript":t==="kernel gateway connection"?"kernelgatewayconnection":t==="hub initiative template"?"hubinitiativetemplate":t==="storymap theme"?"storymaptheme":t==="knowledge graph"?"knowledgegraph":t==="native application"?"nativeapp":t==="native application installer"?"nativeappinstaller":t==="link chart"?"linkchart":t==="investigation"?"investigation":t==="ogcfeatureserver"?"features":t==="pro project"?"proproject":t==="insights workbook package"?"insightsworkbookpackage":t==="apache parquet"?"apacheparquet":"maps",s?kt(i+s+r+".png"):null}get isLayer(){return["Map Service","Feature Service","Feature Collection","Scene Service","Image Service","Stream Service","Vector Tile Service","WMTS","WMS"].indexOf(this.type)>-1}get itemUrl(){const t=this.get("portal.restUrl");return t?t+"/content/items/"+this.id:null}get thumbnailUrl(){const t=this.itemUrl,e=this.thumbnail;return t&&e?this.portal._normalizeUrl(`${t}/info/${e}?f=json`):null}get userItemUrl(){const t=this.get("portal.restUrl");if(!t)return null;const e=this.owner||this.get("portal.user.username");return e?`${t}/content/users/${this.ownerFolder?`${e}/${this.ownerFolder}`:e}/items/${this.id}`:null}load(t){this.portal||(this.portal=po.getDefault());const e=this.portal.load(t).then(()=>this.sourceJSON?this.sourceJSON:this.id&&this.itemUrl?this.portal._request(this.itemUrl,{signal:_(t)?t.signal:null,query:{token:this.apiKey}}):{}).then(i=>{this.sourceJSON=i,this.read(i)});return this.addResolvingPromise(e),Promise.resolve(this)}addRating(t){const e={method:"post",query:{}};return t instanceof fF&&(t=t.rating),isNaN(t)||typeof t!="number"||(e.query.rating=t),this.portal._request(this.itemUrl+"/addRating",e).then(()=>new fF({rating:t,created:new Date}))}clone(){const t={access:this.access,accessInformation:this.accessInformation,applicationProxies:ie(this.applicationProxies),avgRating:this.avgRating,categories:ie(this.categories),created:ie(this.created),culture:this.culture,description:this.description,extent:ie(this.extent),groupCategories:ie(this.groupCategories),id:this.id,itemControl:this.itemControl,licenseInfo:this.licenseInfo,modified:ie(this.modified),name:this.name,numComments:this.numComments,numRatings:this.numRatings,numViews:this.numViews,owner:this.owner,ownerFolder:this.ownerFolder,portal:this.portal,screenshots:ie(this.screenshots),size:this.size,snippet:this.snippet,tags:ie(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:ie(this.typeKeywords),url:this.url};return this.loaded&&(t.loadStatus="loaded"),new Yv({sourceJSON:this.sourceJSON}).set(t)}createPostQuery(){const t=this.toJSON();for(const e in t)e==="tags"&&t[e]!==null&&(t[e]=t[e].join(", ")),e==="typeKeywords"&&t[e]!==null&&(t[e]=t[e].join(", ")),e==="extent"&&t[e]&&(t[e]=JSON.stringify(t[e]));return t}deleteRating(){return this.portal._request(this.itemUrl+"/deleteRating",{method:"post"}).then(()=>{})}fetchData(t="json",e){return this.portal._request(this.itemUrl+"/data",he(E({responseType:t},e),{query:{token:this.apiKey}}))}fetchRating(t){return this.portal._request(this.itemUrl+"/rating",E({query:{token:this.apiKey}},t)).then(e=>e.rating!=null?(e.created=new Date(e.created),new fF(e)):null)}fetchRelatedItems(t,e){return this.portal._requestToTypedArray(this.itemUrl+"/relatedItems",E({query:he(E({},t),{token:this.apiKey})},e),Yv)}getThumbnailUrl(t){let e=this.thumbnailUrl;return e&&t&&(e+=`&w=${t}`),e}reload(){return this.portal._request(this.itemUrl,{cacheBust:!0,query:{token:this.apiKey}}).then(t=>(this.sourceJSON=t,this.read(t),this))}update(t){return this.id?this.load().then(()=>this.portal._signIn()).then(()=>{const e=t&&t.data,i={method:"post"};i.query=this.createPostQuery();for(const r in i.query)i.query[r]===null&&(i.query[r]="");return i.query.clearEmptyFields=!0,e!=null&&(typeof e=="string"?i.query.text=e:typeof e=="object"&&(i.query.text=JSON.stringify(e))),this.portal._request(`${this.userItemUrl}/update`,i).then(()=>this.reload())}):Promise.reject(new Q("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}updateThumbnail(t){return this.id?this.load().then(()=>this.portal._signIn()).then(()=>{const e=t.thumbnail,i=t.filename,r={method:"post"};if(typeof e=="string")Jc(e)?r.query={data:e}:r.query={url:Ra(e)},_(i)&&(r.query.filename=i);else{const s=new FormData;_(i)?s.append("file",e,i):s.append("file",e),r.body=s}return this.portal._request(`${this.userItemUrl}/updateThumbnail`,r).then(()=>this.reload())}):Promise.reject(new Q("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}async fetchResources(t={},e){return(await import("./resourceUtils.a20a4920.js")).fetchResources(this,t,e)}async addResource(t,e,i){const r=await import("./resourceUtils.a20a4920.js");return t.portalItem=this,r.addOrUpdateResource(t,"add",e,i)}async removeResource(t,e){const i=await import("./resourceUtils.a20a4920.js");if(t.portalItem&&t.portalItem.itemUrl!==this.itemUrl)throw new Q("removeresource:portal-item-mismatch","The portal item associated with the provided resource does not match the item");return i.removeResource(this,t,e)}async removeAllResources(t){return(await import("./resourceUtils.a20a4920.js")).removeAllResources(this,t)}resourceFromPath(t){return new t_e({portalItem:this,path:t})}toJSON(){const t=this.extent,e={created:this.created&&this.created.getTime(),description:this.description,extent:t&&[[t.xmin,t.ymin],[t.xmax,t.ymax]],id:this.id,modified:this.modified&&this.modified.getTime(),name:this.name,owner:this.owner,ownerFolder:this.ownerFolder,snippet:this.snippet,tags:this.tags,thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:this.typeKeywords,url:this.url};return BB(e)}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");return new Yv({sourceJSON:t})}_getPostQuery(){const t=this.toJSON();for(const e in t)e==="tags"&&t[e]!==null&&(t[e]=t[e].join(", ")),e==="typeKeywords"&&t[e]!==null&&(t[e]=t[e].join(", ")),e==="extent"&&t[e]&&(t[e]=JSON.stringify(t[e]));return t}};u([d({type:["private","shared","org","public"]})],St.prototype,"access",void 0),u([d()],St.prototype,"accessInformation",void 0),u([d({type:String})],St.prototype,"apiKey",void 0),u([d({json:{read:{source:"appProxies"}}})],St.prototype,"applicationProxies",void 0),u([d()],St.prototype,"avgRating",void 0),u([d()],St.prototype,"categories",void 0),u([d({type:Date})],St.prototype,"created",void 0),u([d()],St.prototype,"culture",void 0),u([d()],St.prototype,"description",void 0),u([d({readOnly:!0})],St.prototype,"displayName",null),u([d({type:ht})],St.prototype,"extent",void 0),u([Ce("extent")],St.prototype,"readExtent",null),u([d()],St.prototype,"groupCategories",void 0),u([d({readOnly:!0})],St.prototype,"iconUrl",null),u([d()],St.prototype,"id",void 0),u([d({readOnly:!0})],St.prototype,"isLayer",null),u([d()],St.prototype,"itemControl",void 0),u([d({readOnly:!0})],St.prototype,"itemUrl",null),u([d()],St.prototype,"licenseInfo",void 0),u([d({type:Date})],St.prototype,"modified",void 0),u([d()],St.prototype,"name",void 0),u([d()],St.prototype,"numComments",void 0),u([d()],St.prototype,"numRatings",void 0),u([d()],St.prototype,"numViews",void 0),u([d()],St.prototype,"owner",void 0),u([d()],St.prototype,"ownerFolder",void 0),u([d({type:po})],St.prototype,"portal",void 0),u([d()],St.prototype,"screenshots",void 0),u([d()],St.prototype,"size",void 0),u([d()],St.prototype,"snippet",void 0),u([d()],St.prototype,"sourceJSON",void 0),u([d()],St.prototype,"tags",void 0),u([d()],St.prototype,"thumbnail",void 0),u([d({readOnly:!0})],St.prototype,"thumbnailUrl",null),u([d()],St.prototype,"title",void 0),u([d()],St.prototype,"type",void 0),u([d()],St.prototype,"typeKeywords",void 0),u([d()],St.prototype,"url",void 0),u([d({readOnly:!0})],St.prototype,"userItemUrl",null),St=Yv=u([R("esri.portal.PortalItem")],St);const SM=St;var Xq=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:SM});const Kq=/^([a-z]{2})(?:[-_]([A-Za-z]{2}))?$/,i_e={ar:!0,bg:!0,bs:!0,ca:!0,cs:!0,da:!0,de:!0,el:!0,en:!0,es:!0,et:!0,fi:!0,fr:!0,he:!0,hr:!0,hu:!0,id:!0,it:!0,ja:!0,ko:!0,lt:!0,lv:!0,nb:!0,nl:!0,pl:!0,"pt-BR":!0,"pt-PT":!0,ro:!0,ru:!0,sk:!0,sl:!0,sr:!0,sv:!0,th:!0,tr:!0,uk:!0,vi:!0,"zh-CN":!0,"zh-HK":!0,"zh-TW":!0};function eH(t){var e;return(e=i_e[t])!=null&&e}const fx=[],Xv=new Map;function tH(t){for(const e of Xv.keys())rH(t.pattern,e)&&Xv.delete(e)}function r_e(t){return fx.includes(t)||(tH(t),fx.unshift(t)),{remove(){const e=fx.indexOf(t);e>-1&&(fx.splice(e,1),tH(t))}}}async function iH(t){const e=La();Xv.has(t)||Xv.set(t,n_e(t,e));const i=Xv.get(t);return await o_e.add(i),i}function s_e(t){if(!Kq.test(t))return null;const[,e,i]=Kq.exec(t),r=e+(i?"-"+i.toUpperCase():"");return eH(r)?r:eH(e)?e:null}async function n_e(t,e){const i=[];for(const r of fx)if(rH(r.pattern,t))try{return await r.fetchMessageBundle(t,e)}catch(s){i.push(s)}throw i.length?new Q("intl:message-bundle-error",`Errors occurred while loading "${t}"`,{errors:i}):new Q("intl:no-message-bundle-loader",`No loader found for message bundle "${t}"`)}function rH(t,e){return typeof t=="string"?e.startsWith(t):t.test(e)}lF(()=>{Xv.clear()});const o_e=new class{constructor(){this._numLoading=0}async waitForAll(){this._dfd&&await this._dfd.promise}add(t){return this._increase(),t.then(()=>this._decrease(),()=>this._decrease()),this.waitForAll()}_increase(){this._numLoading++,this._dfd||(this._dfd=xp())}_decrease(){this._numLoading=Math.max(this._numLoading-1,0),this._dfd&&this._numLoading===0&&(this._dfd.resolve(),this._dfd=null)}};async function a_e(t){if(!t)return;const e=t.indexOf("-vector")>-1?t.slice(0,t.indexOf("-vector")):t,i=await iH("esri/t9n/basemaps");return i[t]||i[e]}const mF={streets:{id:"streets",classic:!0,deprecated:!0,get thumbnailUrl(){return kt("esri/images/basemap/streets.jpg")},baseMapLayers:[{id:"streets-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Street Map",showLegend:!1,visibility:!0,opacity:1}]},satellite:{id:"satellite",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/satellite.jpg")},baseMapLayers:[{id:"satellite-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1}]},hybrid:{id:"hybrid",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/hybrid.jpg")},baseMapLayers:[{id:"hybrid-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1},{id:"hybrid-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Boundaries and Places",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},terrain:{id:"terrain",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/terrain.jpg")},baseMapLayers:[{id:"terrain-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Terrain Base",showLegend:!1,visibility:!0,opacity:1},{id:"terrain-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Reference Overlay",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},topo:{id:"topo",classic:!0,deprecated:!0,get thumbnailUrl(){return kt("esri/images/basemap/topo.jpg")},baseMapLayers:[{id:"topo-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Topo Map",showLegend:!1,visibility:!0,opacity:1}]},gray:{id:"gray",classic:!0,deprecated:!0,get thumbnailUrl(){return kt("esri/images/basemap/gray.jpg")},baseMapLayers:[{id:"gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"dark-gray":{id:"dark-gray",classic:!0,deprecated:!0,get thumbnailUrl(){return kt("esri/images/basemap/dark-gray.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"dark-gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},oceans:{id:"oceans",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/oceans.jpg")},baseMapLayers:[{id:"oceans-base-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Base",showLegend:!1,visibility:!0,opacity:1},{id:"oceans-reference-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"national-geographic":{id:"national-geographic",classic:!0,deprecated:!0,get thumbnailUrl(){return kt("esri/images/basemap/national-geographic.jpg")},baseMapLayers:[{id:"national-geographic-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer",title:"NatGeo World Map",showLegend:!1,layerType:"ArcGISTiledMapServiceLayer",visibility:!0,opacity:1}]},osm:{id:"osm",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/osm.jpg")},baseMapLayers:[{id:"osm-base-layer",layerType:"OpenStreetMap",title:"Open Street Map",showLegend:!1,visibility:!0,opacity:1}]},"dark-gray-vector":{id:"dark-gray-vector",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/dark-gray-vector.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/5e9b3685f4c24d8781073dd928ebda50/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Base",visibility:!0,opacity:1},{id:"dark-gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/747cb7a5329c478cbe6981076cc879c5/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"gray-vector":{id:"gray-vector",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/gray-vector.jpg")},baseMapLayers:[{id:"gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/291da5eab3a0412593b66d384379f89f/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Base",visibility:!0,opacity:1},{id:"gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/1768e8369a214dfab4e2167d5c5f2454/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"streets-vector":{id:"streets-vector",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/streets-vector.jpg")},baseMapLayers:[{id:"streets-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/de26a3cf4cc9451298ea173c4b324736/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets",visibility:!0,opacity:1}]},"topo-vector":{id:"topo-vector",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/topo-vector.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"topo-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/7dc6cea0b1764a1f9af2e679f642f0f5/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Topo",visibility:!0,opacity:1}]},"streets-night-vector":{id:"streets-night-vector",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/streets-night.jpg")},baseMapLayers:[{id:"streets-night-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/86f556a2d1fd468181855a35e344567f/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Night",visibility:!0,opacity:1}]},"streets-relief-vector":{id:"streets-relief-vector",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/streets-relief.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"streets-relief-vector-base-layer",styleUrl:"//www.arcgis.com/sharing/rest/content/items/b266e6d17fc345b498345613930fbd76/resources/styles/root.json",title:"World Streets Relief",layerType:"VectorTileLayer",visibility:!0,opacity:1}]},"streets-navigation-vector":{id:"streets-navigation-vector",classic:!0,get thumbnailUrl(){return kt("esri/images/basemap/streets-navigation.jpg")},baseMapLayers:[{id:"streets-navigation-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/63c47b7177f946b49902c24129b87252/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Navigation",visibility:!0,opacity:1}]},"arcgis-imagery":{get thumbnailUrl(){return kt("esri/images/basemap/hybrid.jpg")},title:"Imagery Hybrid",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-imagery-standard":{get thumbnailUrl(){return kt("esri/images/basemap/satellite.jpg")},title:"Imagery",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"}]},"arcgis-imagery-labels":{title:"Hybrid [Reference]",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-light-gray":{get thumbnailUrl(){return kt("esri/images/basemap/gray-vector.jpg")},title:"Light Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Base",title:"Light Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Labels",title:"Light Gray Canvas Labels",isReference:!0}]},"arcgis-dark-gray":{get thumbnailUrl(){return kt("esri/images/basemap/dark-gray.jpg")},title:"Dark Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Base",title:"Dark Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Labels",title:"Dark Gray Canvas Labels",isReference:!0}]},"arcgis-navigation":{get thumbnailUrl(){return kt("esri/images/basemap/streets-navigation.jpg")},title:"Navigation",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Navigation",title:"World Navigation Map"}]},"arcgis-navigation-night":{title:"Navigation (Dark Mode)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:NavigationNight",title:"World Navigation Map (Dark Mode)"}]},"arcgis-streets":{get thumbnailUrl(){return kt("esri/images/basemap/streets-vector.jpg")},title:"Streets",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Streets",title:"World Street Map"}]},"arcgis-streets-night":{get thumbnailUrl(){return kt("esri/images/basemap/streets-night.jpg")},title:"Streets (Night)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsNight",title:"World Street Map (Night)"}]},"arcgis-streets-relief":{get thumbnailUrl(){return kt("esri/images/basemap/streets-relief.jpg")},title:"Streets (with Relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsRelief:Base",title:"World Street Map (with Relief)"}]},"arcgis-topographic":{get thumbnailUrl(){return kt("esri/images/basemap/topo.jpg")},title:"Topographic",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Topographic:Base",title:"World Topographic Map"}]},"arcgis-oceans":{get thumbnailUrl(){return kt("esri/images/basemap/oceans.jpg")},title:"Oceans",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Ocean Base",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Oceans:Labels",title:"World Ocean Reference",isReference:!0}]},"osm-standard":{title:"OpenStreetMap",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Standard",title:"OpenStreetMap"}]},"osm-standard-relief":{title:"OpenStreetMap (with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StandardRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-streets":{title:"OpenStreetMap (Streets)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Streets",title:"OpenStreetMap (Streets)"}]},"osm-streets-relief":{title:"OpenStreetMap (Streets with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StreetsRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-light-gray":{title:"OpenStreetMap (Light Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Base",title:"OSM (Light Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Labels",title:"OSM (Light Gray Reference)",isReference:!0}]},"osm-dark-gray":{title:"OpenStreetMap (Dark Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Base",title:"OSM (Dark Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Labels",title:"OSM (Dark Gray Reference)",isReference:!0}]},"arcgis-terrain":{title:"Terrain with Labels",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Base",title:"World Terrain Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Detail",title:"World Terrain Reference",isReference:!0}]},"arcgis-community":{title:"Community",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Community",title:"Community"}]},"arcgis-charted-territory":{title:"Charted Territory",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ChartedTerritory:Base",title:"Charted Territory"}]},"arcgis-colored-pencil":{title:"Colored Pencil",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ColoredPencil",title:"Colored Pencil"}]},"arcgis-nova":{title:"Nova",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Nova",title:"Nova"}]},"arcgis-modern-antique":{title:"Modern Antique",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ModernAntique:Base",title:"Modern Antique"}]},"arcgis-midcentury":{title:"Mid-Century",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Midcentury",title:"Mid-Century"}]},"arcgis-newspaper":{title:"Newspaper",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Newspaper",title:"Newspaper"}]},"arcgis-hillshade-light":{title:"Hillshade",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"}]},"arcgis-hillshade-dark":{title:"Hillshade (Dark)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade (Dark)",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade_Dark/MapServer"}]}},l_e=new Set(["bing-maps","imagery","imagery-tile","map-image","open-street-map","tile","unknown","unsupported","vector-tile","web-tile","wms","wmts"]),c_e=new Set(["csv","feature","geo-rss","geojson","group","imagery","imagery-tile","kml","map-image","map-notes","ogc-feature","tile","unknown","unsupported","vector-tile","web-tile","wfs","wms","wmts"]);function u_e(t){return t.layerContainerType==="basemap"?l_e:t.layerContainerType==="operational-layers"?c_e:null}function gF(t){return!(t.type!=="feature"||t.url||!t.source||t.source.type!=="memory")}function h_e(t,e){if(e.restrictedWebMapWriting){const i=u_e(e);return!_(i)||i.has(t.type)&&!gF(t)}return!0}function d_e(t,e){if(gF(t)){const i=zv("featureCollection.layers",e),r=i&&i[0]&&i[0].layerDefinition;r&&yF(t,r)}else t.type==="stream"?yF(t,e.layerDefinition=e.layerDefinition||{}):t.type!=="group"&&yF(t,e)}function yF(t,e){"maxScale"in t&&(e.maxScale=aM(t.maxScale)),"minScale"in t&&(e.minScale=aM(t.minScale))}function p_e(t,e){if(d_e(t,e),"blendMode"in t&&(e.blendMode=t.blendMode,e.blendMode==="normal"&&delete e.blendMode),e.opacity=aM(t.opacity),e.title=t.title||"Layer",e.visibility=t.visible,"legendEnabled"in t&&t.type!=="wmts")if(gF(t)){const i=e.featureCollection;i&&(i.showLegend=t.legendEnabled)}else e.showLegend=t.legendEnabled}function sH(t,e,i){if(!("write"in t)||!t.write)return i&&i.messages&&i.messages.push(new Q("layer:unsupported",`Layers (${t.title}, ${t.id}) of type '${t.declaredClass}' cannot be persisted`,{layer:t})),null;if(h_e(t,i)){const r={};return t.write(r,i)?r:null}return _(e)&&p_e(t,e=ie(e)),e}var TM;let f_e=0;const vF=le.getLogger("esri.Basemap");let za=TM=class extends ix(Ph){constructor(t){super(t),this.id=null,this.portalItem=null,this.spatialReference=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+f_e++,this.baseLayers=new We,this.referenceLayers=new We;const e=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,r.type==="elevation"&&vF.error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a basemap layer and will therefore be ignored.`)},i=r=>{r.parent=null};this.baseLayers.on("after-add",r=>e(r.item)),this.referenceLayers.on("after-add",r=>e(r.item)),this.baseLayers.on("after-remove",r=>i(r.item)),this.referenceLayers.on("after-remove",r=>i(r.item))}initialize(){this.when().catch(t=>{vF.error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,t)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){var t;const e=this.baseLayers.removeAll();for(const r of e)r.destroy();const i=this.referenceLayers.removeAll();for(const r of i)r.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),(t=this.portalItem)==null||t.destroy(),this.portalItem=null}normalizeCtorArgs(t){return t&&"resourceInfo"in t&&(this._set("resourceInfo",t.resourceInfo),delete(t=E({},t)).resourceInfo),t}set baseLayers(t){this._set("baseLayers",vg(t,this._get("baseLayers")))}_writeBaseLayers(t,e,i){const r=[];t&&(i=he(E({},i),{layerContainerType:"basemap"}),this.baseLayers.forEach(s=>{const n=sH(s,i.webmap?i.webmap.getLayerJSONFromResourceInfo(s):null,i);_(n)&&r.push(n)}),this.referenceLayers.forEach(s=>{const n=sH(s,i.webmap?i.webmap.getLayerJSONFromResourceInfo(s):null,i);_(n)&&(n.isReference=!0,r.push(n))})),e.baseMapLayers=r}set referenceLayers(t){this._set("referenceLayers",vg(t,this._get("referenceLayers")))}writeTitle(t,e){e.title=t||"Basemap"}load(t){return this.addResolvingPromise(this._loadFromSource(t)),Promise.resolve(this)}loadAll(){return oq(this,t=>{t(this.baseLayers,this.referenceLayers)})}clone(){const t={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.slice(),referenceLayers:this.referenceLayers.slice()};return this.loaded&&(t.loadStatus="loaded"),new TM({resourceInfo:this.resourceInfo}).set(t)}read(t,e){this.resourceInfo||this._set("resourceInfo",{data:t,context:e}),super.read(t,e)}write(t,e){return t=t||{},e&&e.origin||(e=E({origin:"web-map"},e)),super.write(t,e),!this.loaded&&this.resourceInfo&&this.resourceInfo.data.baseMapLayers&&(t.baseMapLayers=this.resourceInfo.data.baseMapLayers.map(i=>{const r=ie(i);return r.url&&Vl(r.url)&&(r.url=`https:${r.url}`),r.templateUrl&&Vl(r.templateUrl)&&(r.templateUrl=`https:${r.templateUrl}`),r})),t}async _loadFromSource(t){const{resourceInfo:e,portalItem:i}=this;Dt(t);const r=[];if(e){const s=e.context?e.context.url:null;if(r.push(this._loadLayersFromJSON(e.data,s,t)),e.data.id&&!e.data.title){const n=e.data.id;r.push(a_e(n).then(o=>{o&&this.read({title:o},e.context)}))}}else i&&r.push(this._loadFromItem(i,t));await Promise.all(r)}async _loadLayersFromJSON(t,e,i){const r=this.resourceInfo&&this.resourceInfo.context,s=this.portalItem&&this.portalItem.portal||r&&r.portal||null,n=r&&r.origin==="web-scene"?"web-scene":"web-map",{populateOperationalLayers:o}=await import("./layersCreator.0cde4d2d.js"),a=[];if(Dt(i),t.baseMapLayers&&Array.isArray(t.baseMapLayers)){const l={context:{origin:n,url:e,portal:s,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},c=o(this.baseLayers,t.baseMapLayers.filter(p=>!p.isReference),l);a.push(c);const h=o(this.referenceLayers,t.baseMapLayers.filter(p=>p.isReference),l);a.push(h)}await En(a)}async _loadFromItem(t,e){const i=await t.load(e),r=await i.fetchData("json",e),s=ms(t.itemUrl);return this._set("resourceInfo",{data:r.baseMap,context:{origin:"web-map",portal:t.portal||po.getDefault(),url:s}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:r.spatialReference},this.resourceInfo.context),this.read({title:t.title,thumbnailUrl:t.thumbnailUrl},{origin:"portal-item",portal:t.portal||po.getDefault(),url:s}),this._loadLayersFromJSON(this.resourceInfo.data,s,e)}static fromId(t){const e=mF[t];if(e){if(e.deprecated){let i=null;t==="dark-gray"?i="dark-gray-vector":t==="gray"?i="gray-vector":t==="streets"?i="streets-vector":t==="topo"&&(i="topo-vector"),hg(vF,`The ${t} basemap has entered mature support and is no longer being updated.`,{replacement:i,see:"https://arcg.is/1iq8aD",warnOnce:!0})}return TM.fromJSON(e)}return null}};u([d({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(t,e,i,r){this._writeBaseLayers(t,e,r)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:We}},writer(t,e,i,r){this._writeBaseLayers(t,e,r)}}}}}})],za.prototype,"baseLayers",null),u([d({type:String,json:{origins:{"web-scene":{write:!0}}}})],za.prototype,"id",void 0),u([d({type:SM})],za.prototype,"portalItem",void 0),u([d()],za.prototype,"referenceLayers",null),u([d({readOnly:!0})],za.prototype,"resourceInfo",void 0),u([d({type:Ue})],za.prototype,"spatialReference",void 0),u([d()],za.prototype,"thumbnailUrl",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],za.prototype,"title",void 0),u([Ee("title")],za.prototype,"writeTitle",null),za=TM=u([R("esri.Basemap")],za);const CM=za;var m_e=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:CM});const MM={transparent:[0,0,0,0],black:[0,0,0,1],silver:[192,192,192,1],gray:[128,128,128,1],white:[255,255,255,1],maroon:[128,0,0,1],red:[255,0,0,1],purple:[128,0,128,1],fuchsia:[255,0,255,1],green:[0,128,0,1],lime:[0,255,0,1],olive:[128,128,0,1],yellow:[255,255,0,1],navy:[0,0,128,1],blue:[0,0,255,1],teal:[0,128,128,1],aqua:[0,255,255,1],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],blanchedalmond:[255,235,205,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],oldlace:[253,245,230,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],rebeccapurple:[102,51,153,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],whitesmoke:[245,245,245,1],yellowgreen:[154,205,50,1]};function nH(t){return MM[t]||MM[t.toLowerCase()]}function _F(t){var e;return(e=MM[t])!=null?e:MM[t.toLowerCase()]}function g_e(t){return[..._F(t)]}function bF(t,e,i){i<0&&++i,i>1&&--i;const r=6*i;return r<1?t+(e-t)*r:2*i<1?e:3*i<2?t+(e-t)*(2/3-i)*6:t}function oH(t,e,i,r=1){const s=(t%360+360)%360/360,n=i<=.5?i*(e+1):i+e-i*e,o=2*i-n;return[Math.round(255*bF(o,n,s+1/3)),Math.round(255*bF(o,n,s)),Math.round(255*bF(o,n,s-1/3)),r]}function y_e(t){const e=t.length>5,i=e?8:4,r=(1<<i)-1,s=e?1:17,n=e?t.length===9:t.length===5;let o=Number("0x"+t.substr(1));if(isNaN(o))return null;const a=[0,0,0,1];let l;return n&&(l=o&r,o>>=i,a[3]=s*l/255),l=o&r,o>>=i,a[2]=s*l,l=o&r,o>>=i,a[1]=s*l,l=o&r,o>>=i,a[0]=s*l,a}function $(){return[0,0,0]}function br(t){return[t[0],t[1],t[2]]}function De(t,e,i){return[t,e,i]}function Dn(t){const e=$(),i=Math.min(3,t.length);for(let r=0;r<i;++r)e[r]=t[r];return e}function wF(t,e){return new Float64Array(t,e,3)}function aH(){return $()}function lH(){return De(1,1,1)}function cH(){return De(1,0,0)}function uH(){return De(0,1,0)}function xF(){return De(0,0,1)}const Fn=aH(),Kc=lH(),v_e=cH(),__e=uH(),hH=xF();Object.freeze({__proto__:null,create:$,clone:br,fromValues:De,fromArray:Dn,createView:wF,zeros:aH,ones:lH,unitX:cH,unitY:uH,unitZ:xF,ZEROS:Fn,ONES:Kc,UNIT_X:v_e,UNIT_Y:__e,UNIT_Z:hH});const it=1e-6,jl=Math.random,b_e=Math.PI/180,w_e=180/Math.PI;function PM(t){return t*b_e}function x_e(t){return t*w_e}function S_e(t,e){return Math.abs(t-e)<=it*Math.max(1,Math.abs(t),Math.abs(e))}Object.freeze({__proto__:null,EPSILON:it,RANDOM:jl,toRadian:PM,toDegree:x_e,equals:S_e});function Te(t){const e=t[0],i=t[1],r=t[2];return Math.sqrt(e*e+i*i+r*r)}function re(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function ne(t,e,i,r){return t[0]=e,t[1]=i,t[2]=r,t}function de(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t}function ue(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function SF(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t}function AM(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t}function T_e(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t}function C_e(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t}function dH(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t}function pH(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t}function M_e(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t}function se(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function TF(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t}function qt(t,e){const i=e[0]-t[0],r=e[1]-t[1],s=e[2]-t[2];return Math.sqrt(i*i+r*r+s*s)}function cn(t,e){const i=e[0]-t[0],r=e[1]-t[1],s=e[2]-t[2];return i*i+r*r+s*s}function un(t){const e=t[0],i=t[1],r=t[2];return e*e+i*i+r*r}function Fs(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function P_e(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t}function _e(t,e){const i=e[0],r=e[1],s=e[2];let n=i*i+r*r+s*s;return n>0&&(n=1/Math.sqrt(n),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n),t}function ye(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Ye(t,e,i){const r=e[0],s=e[1],n=e[2],o=i[0],a=i[1],l=i[2];return t[0]=s*l-n*a,t[1]=n*o-r*l,t[2]=r*a-s*o,t}function jr(t,e,i,r){const s=e[0],n=e[1],o=e[2];return t[0]=s+r*(i[0]-s),t[1]=n+r*(i[1]-n),t[2]=o+r*(i[2]-o),t}function A_e(t,e,i,r,s,n){const o=n*n,a=o*(2*n-3)+1,l=o*(n-2)+n,c=o*(n-1),h=o*(3-2*n);return t[0]=e[0]*a+i[0]*l+r[0]*c+s[0]*h,t[1]=e[1]*a+i[1]*l+r[1]*c+s[1]*h,t[2]=e[2]*a+i[2]*l+r[2]*c+s[2]*h,t}function $_e(t,e,i,r,s,n){const o=1-n,a=o*o,l=n*n,c=a*o,h=3*n*a,p=3*l*o,f=l*n;return t[0]=e[0]*c+i[0]*h+r[0]*p+s[0]*f,t[1]=e[1]*c+i[1]*h+r[1]*p+s[1]*f,t[2]=e[2]*c+i[2]*h+r[2]*p+s[2]*f,t}function E_e(t,e){e=e||1;const i=2*jl()*Math.PI,r=2*jl()-1,s=Math.sqrt(1-r*r)*e;return t[0]=Math.cos(i)*s,t[1]=Math.sin(i)*s,t[2]=r*e,t}function Oe(t,e,i){const r=e[0],s=e[1],n=e[2];return t[0]=i[0]*r+i[4]*s+i[8]*n+i[12],t[1]=i[1]*r+i[5]*s+i[9]*n+i[13],t[2]=i[2]*r+i[6]*s+i[10]*n+i[14],t}function fo(t,e,i){const r=e[0],s=e[1],n=e[2];return t[0]=r*i[0]+s*i[3]+n*i[6],t[1]=r*i[1]+s*i[4]+n*i[7],t[2]=r*i[2]+s*i[5]+n*i[8],t}function Ep(t,e,i){const r=i[0],s=i[1],n=i[2],o=i[3],a=e[0],l=e[1],c=e[2];let h=s*c-n*l,p=n*a-r*c,f=r*l-s*a,g=s*f-n*p,y=n*h-r*f,v=r*p-s*h;const b=2*o;return h*=b,p*=b,f*=b,g*=2,y*=2,v*=2,t[0]=a+h+g,t[1]=l+p+y,t[2]=c+f+v,t}function O_e(t,e,i,r){const s=[],n=[];return s[0]=e[0]-i[0],s[1]=e[1]-i[1],s[2]=e[2]-i[2],n[0]=s[0],n[1]=s[1]*Math.cos(r)-s[2]*Math.sin(r),n[2]=s[1]*Math.sin(r)+s[2]*Math.cos(r),t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t}function R_e(t,e,i,r){const s=[],n=[];return s[0]=e[0]-i[0],s[1]=e[1]-i[1],s[2]=e[2]-i[2],n[0]=s[2]*Math.sin(r)+s[0]*Math.cos(r),n[1]=s[1],n[2]=s[2]*Math.cos(r)-s[0]*Math.sin(r),t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t}function I_e(t,e,i,r){const s=[],n=[];return s[0]=e[0]-i[0],s[1]=e[1]-i[1],s[2]=e[2]-i[2],n[0]=s[0]*Math.cos(r)-s[1]*Math.sin(r),n[1]=s[0]*Math.sin(r)+s[1]*Math.cos(r),n[2]=s[2],t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t}function D_e(t,e){re($M,t),re(EM,e),_e($M,$M),_e(EM,EM);const i=ye($M,EM);return i>1?0:i<-1?Math.PI:Math.acos(i)}const $M=$(),EM=$();function F_e(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"}function mo(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function mx(t,e){if(t===e)return!0;const i=t[0],r=t[1],s=t[2],n=e[0],o=e[1],a=e[2];return Math.abs(i-n)<=it*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(r-o)<=it*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-a)<=it*Math.max(1,Math.abs(s),Math.abs(a))}function Lh(t,e,i){const r=i[0]-e[0],s=i[1]-e[1],n=i[2]-e[2];let o=r*r+s*s+n*n;return o>0?(o=1/Math.sqrt(o),t[0]=r*o,t[1]=s*o,t[2]=n*o,t):(t[0]=0,t[1]=0,t[2]=0,t)}const eu=ue,L_e=SF,k_e=AM,CF=qt,MF=cn,PF=Te,AF=un,fH=Object.freeze({__proto__:null,length:Te,copy:re,set:ne,add:de,subtract:ue,multiply:SF,divide:AM,ceil:T_e,floor:C_e,min:dH,max:pH,round:M_e,scale:se,scaleAndAdd:TF,distance:qt,squaredDistance:cn,squaredLength:un,negate:Fs,inverse:P_e,normalize:_e,dot:ye,cross:Ye,lerp:jr,hermite:A_e,bezier:$_e,random:E_e,transformMat4:Oe,transformMat3:fo,transformQuat:Ep,rotateX:O_e,rotateY:R_e,rotateZ:I_e,angle:D_e,str:F_e,exactEquals:mo,equals:mx,direction:Lh,sub:eu,mul:L_e,div:k_e,dist:CF,sqrDist:MF,len:PF,sqrLen:AF});function Ln(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function Ls(t,e,i,r,s){return t[0]=e,t[1]=i,t[2]=r,t[3]=s,t}function $F(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t}function mH(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t}function gH(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t[3]=e[3]*i[3],t}function yH(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t[3]=e[3]/i[3],t}function z_e(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t}function V_e(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t}function N_e(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t[3]=Math.min(e[3],i[3]),t}function U_e(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t[3]=Math.max(e[3],i[3]),t}function j_e(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t}function gx(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t}function B_e(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t}function vH(t,e){const i=e[0]-t[0],r=e[1]-t[1],s=e[2]-t[2],n=e[3]-t[3];return Math.sqrt(i*i+r*r+s*s+n*n)}function OM(t,e){const i=e[0]-t[0],r=e[1]-t[1],s=e[2]-t[2],n=e[3]-t[3];return i*i+r*r+s*s+n*n}function EF(t){const e=t[0],i=t[1],r=t[2],s=t[3];return Math.sqrt(e*e+i*i+r*r+s*s)}function OF(t){const e=t[0],i=t[1],r=t[2],s=t[3];return e*e+i*i+r*r+s*s}function G_e(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function q_e(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t}function _H(t,e){const i=e[0],r=e[1],s=e[2],n=e[3];let o=i*i+r*r+s*s+n*n;return o>0&&(o=1/Math.sqrt(o),t[0]=i*o,t[1]=r*o,t[2]=s*o,t[3]=n*o),t}function bH(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function RF(t,e,i,r){const s=e[0],n=e[1],o=e[2],a=e[3];return t[0]=s+r*(i[0]-s),t[1]=n+r*(i[1]-n),t[2]=o+r*(i[2]-o),t[3]=a+r*(i[3]-a),t}function H_e(t,e){let i,r,s,n,o,a;e=e||1;do i=2*jl()-1,r=2*jl()-1,o=i*i+r*r;while(o>=1);do s=2*jl()-1,n=2*jl()-1,a=s*s+n*n;while(a>=1);const l=Math.sqrt((1-o)/a);return t[0]=e*i,t[1]=e*r,t[2]=e*s*l,t[3]=e*n*l,t}function Va(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3];return t[0]=i[0]*r+i[4]*s+i[8]*n+i[12]*o,t[1]=i[1]*r+i[5]*s+i[9]*n+i[13]*o,t[2]=i[2]*r+i[6]*s+i[10]*n+i[14]*o,t[3]=i[3]*r+i[7]*s+i[11]*n+i[15]*o,t}function W_e(t,e,i){const r=e[0],s=e[1],n=e[2],o=i[0],a=i[1],l=i[2],c=i[3],h=c*r+a*n-l*s,p=c*s+l*r-o*n,f=c*n+o*s-a*r,g=-o*r-a*s-l*n;return t[0]=h*c+g*-o+p*-l-f*-a,t[1]=p*c+g*-a+f*-o-h*-l,t[2]=f*c+g*-l+h*-a-p*-o,t[3]=e[3],t}function Z_e(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function Pg(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function wH(t,e){const i=t[0],r=t[1],s=t[2],n=t[3],o=e[0],a=e[1],l=e[2],c=e[3];return Math.abs(i-o)<=it*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-a)<=it*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(s-l)<=it*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=it*Math.max(1,Math.abs(n),Math.abs(c))}const J_e=mH,Q_e=gH,Y_e=yH,X_e=vH,K_e=OM,ebe=EF,tbe=OF,xH=Object.freeze({__proto__:null,copy:Ln,set:Ls,add:$F,subtract:mH,multiply:gH,divide:yH,ceil:z_e,floor:V_e,min:N_e,max:U_e,round:j_e,scale:gx,scaleAndAdd:B_e,distance:vH,squaredDistance:OM,length:EF,squaredLength:OF,negate:G_e,inverse:q_e,normalize:_H,dot:bH,lerp:RF,random:H_e,transformMat4:Va,transformQuat:W_e,str:Z_e,exactEquals:Pg,equals:wH,sub:J_e,mul:Q_e,div:Y_e,dist:X_e,sqrDist:K_e,len:ebe,sqrLen:tbe}),SH=new Float32Array(1);function Op(t){--t;for(let e=1;e<32;e<<=1)t|=t>>e;return t+1}function Re(t,e,i){return Math.min(Math.max(t,e),i)}function Kv(t){return(t&t-1)==0}function ant(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function lnt(t){return 10**Math.ceil(Math.LOG10E*Math.log(t))}function Et(t,e,i){return t+(e-t)*i}function nt(t){return t*Math.PI/180}function go(t){return 180*t/Math.PI}function IF(t,e=1e-6){return(t<0?-1:1)/Math.max(Math.abs(t),e)}function ar(t){return Math.acos(Re(t,-1,1))}function Bl(t){return Math.asin(Re(t,-1,1))}function ibe(t,e,i=1e-6){if(isNaN(t)||isNaN(e))return!1;if(t===e)return!0;const r=Math.abs(t-e),s=Math.abs(t),n=Math.abs(e);if(t===0||e===0||s<1e-12&&n<1e-12){if(r>.01*i)return!1}else if(r/(s+n)>i)return!1;return!0}function DF(t,e,i=1e-6){return isNaN(t)||isNaN(e)?!1:(t>e?t-e:e-t)<=i}function rbe(t){return TH(Math.max(-FF,Math.min(t,FF)))}function TH(t){return SH[0]=t,SH[0]}function Ag(t,e,i){const r=Re((i-t)/(e-t),0,1);return r*r*(3-2*r)}function CH(t,e){const i=Te(t),r=Bl(t[2]/i),s=Math.atan2(t[1]/i,t[0]/i);return ne(e,i,r,s),e}function cnt(t,e,i){return Ls(t,e[0],e[1],e[2],e[3]*i)}const FF=TH(34028234663852886e22);function RM(t){return Re(CD(t),0,255)}function IM(t,e,i){return t=Number(t),isNaN(t)?i:t<e?e:t>i?i:t}class Ae{constructor(e){this.r=255,this.g=255,this.b=255,this.a=1,e&&this.setColor(e)}static blendColors(e,i,r,s=new Ae){return s.r=Math.round(e.r+(i.r-e.r)*r),s.g=Math.round(e.g+(i.g-e.g)*r),s.b=Math.round(e.b+(i.b-e.b)*r),s.a=e.a+(i.a-e.a)*r,s._sanitize()}static fromRgb(e,i){const r=e.toLowerCase().match(/^(rgba?|hsla?)\(([\s\.\-,%0-9]+)\)/);if(r){const s=r[2].split(/\s*,\s*/),n=r[1];if(n==="rgb"&&s.length===3||n==="rgba"&&s.length===4){const o=s[0];if(o.charAt(o.length-1)==="%"){const a=s.map(l=>2.56*parseFloat(l));return s.length===4&&(a[3]=parseFloat(s[3])),Ae.fromArray(a,i)}return Ae.fromArray(s.map(a=>parseFloat(a)),i)}if(n==="hsl"&&s.length===3||n==="hsla"&&s.length===4)return Ae.fromArray(oH(parseFloat(s[0]),parseFloat(s[1])/100,parseFloat(s[2])/100,parseFloat(s[3])),i)}return null}static fromHex(e,i=new Ae){if(e.length!==4&&e.length!==7||e[0]!=="#")return null;const r=e.length===4?4:8,s=(1<<r)-1;let n=Number("0x"+e.substr(1));return isNaN(n)?null:(["b","g","r"].forEach(o=>{const a=n&s;n>>=r,i[o]=r===4?17*a:a}),i.a=1,i)}static fromArray(e,i=new Ae){return i._set(Number(e[0]),Number(e[1]),Number(e[2]),Number(e[3])),isNaN(i.a)&&(i.a=1),i._sanitize()}static fromString(e,i){const r=nH(e)?_F(e):null;return r&&Ae.fromArray(r,i)||Ae.fromRgb(e,i)||Ae.fromHex(e,i)}static fromJSON(e){return e&&new Ae([e[0],e[1],e[2],e[3]/255])}static toUnitRGB(e){return _(e)?[e.r/255,e.g/255,e.b/255]:null}static toUnitRGBA(e){return _(e)?[e.r/255,e.g/255,e.b/255,e.a!=null?e.a:1]:null}get isBright(){return .299*this.r+.587*this.g+.114*this.b>=127}setColor(e){if(typeof e=="string")Ae.fromString(e,this);else if(Array.isArray(e))Ae.fromArray(e,this);else{var i,r,s,n;this._set((i=e.r)!=null?i:0,(r=e.g)!=null?r:0,(s=e.b)!=null?s:0,(n=e.a)!=null?n:1),e instanceof Ae||this._sanitize()}return this}toRgb(){return[this.r,this.g,this.b]}toRgba(){return[this.r,this.g,this.b,this.a]}toHex(){const e=this.r.toString(16),i=this.g.toString(16),r=this.b.toString(16);return`#${e.length<2?"0"+e:e}${i.length<2?"0"+i:i}${r.length<2?"0"+r:r}`}toCss(e=!1){const i=this.r+", "+this.g+", "+this.b;return e?`rgba(${i}, ${this.a})`:`rgb(${i})`}toString(){return this.toCss(!0)}toJSON(){return this.toArray()}toArray(e=0){const i=RM(this.r),r=RM(this.g),s=RM(this.b);return e===0||this.a!==1?[i,r,s,RM(255*this.a)]:[i,r,s]}clone(){return new Ae(this.toRgba())}hash(){return this.r<<24|this.g<<16|this.b<<8|255*this.a}_sanitize(){return this.r=Math.round(IM(this.r,0,255)),this.g=Math.round(IM(this.g,0,255)),this.b=Math.round(IM(this.b,0,255)),this.a=IM(this.a,0,1),this}_set(e,i,r,s){this.r=e,this.g=i,this.b=r,this.a=s}}Ae.prototype.declaredClass="esri.Color";function kn(t){}function sbe(t){return()=>t}function Xe(t,e={}){var i;const r=t instanceof wt?t:new wt(t,e),s={type:(i=e==null?void 0:e.ignoreUnknown)==null||i?r.apiValues:String,readOnly:e==null?void 0:e.readOnly,json:{type:r.jsonValues,read:(e==null||!e.readOnly)&&{reader:r.read},write:{writer:r.write}}};return(e==null?void 0:e.default)!==void 0&&(s.json.default=e.default),(e==null?void 0:e.name)!==void 0&&(s.json.name=e.name),d(s)}var LF;let DM=LF=class extends ge{constructor(t){super(t),this.type="none"}clone(){return new LF({type:this.type})}};u([Xe({none:"none",stayAbove:"stay-above"})],DM.prototype,"type",void 0),DM=LF=u([R("esri.ground.NavigationConstraint")],DM);function kF(t){const e=CD(100*(1-t));return Math.max(0,Math.min(e,100))}function yx(t){const e=1-t/100;return Math.max(0,Math.min(e,1))}var zF;const MH=le.getLogger("esri.Ground");let kh=zF=class extends ix(Ph){constructor(t){super(t),this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new We;const e=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,r.type!=="elevation"&&r.type!=="base-elevation"&&MH.error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},i=r=>{r.parent=null};this.layers.on("after-add",r=>e(r.item)),this.layers.on("after-remove",r=>i(r.item))}initialize(){this.when().catch(t=>{MH.error("#load()","Failed to load ground",t)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const t=this.layers.removeAll();for(const e of t)e.destroy();this.layers.destroy()}normalizeCtorArgs(t){return t&&"resourceInfo"in t&&(this._set("resourceInfo",t.resourceInfo),delete(t=E({},t)).resourceInfo),t}set layers(t){this._set("layers",vg(t,this._get("layers")))}writeLayers(t,e,i,r){const s=[];t&&(r=he(E({},r),{layerContainerType:"ground"}),t.forEach(n=>{if("write"in n){const o={};sbe(n)().write(o,r)&&s.push(o)}else r&&r.messages&&r.messages.push(new Q("layer:unsupported",`Layers (${n.title}, ${n.id}) of type '${n.declaredClass}' cannot be persisted in the ground`,{layer:n}))})),e.layers=s}load(t){return this.addResolvingPromise(this._loadFromSource(t)),Promise.resolve(this)}loadAll(){return oq(this,t=>{t(this.layers)})}async queryElevation(t,e){await this.load({signal:e==null?void 0:e.signal});const{ElevationQuery:i}=await import("./ElevationQuery.e16dbd5e.js");Dt(e);const r=new i,s=this.layers.filter(PH).toArray();return r.queryAll(s,t,e)}async createElevationSampler(t,e){await this.load({signal:e==null?void 0:e.signal});const{ElevationQuery:i}=await import("./ElevationQuery.e16dbd5e.js");Dt(e);const r=new i,s=this.layers.filter(PH).toArray();return r.createSamplerAll(s,t,e)}clone(){const t={opacity:this.opacity,surfaceColor:ie(this.surfaceColor),navigationConstraint:ie(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(t.loadStatus="loaded"),new zF({resourceInfo:this.resourceInfo}).set(t)}read(t,e){this.resourceInfo||this._set("resourceInfo",{data:t,context:e}),super.read(t,e)}_loadFromSource(t){const e=this.resourceInfo;return e?this._loadLayersFromJSON(e.data,e.context,t):Promise.resolve(null)}_loadLayersFromJSON(t,e,i){const r=e&&e.origin||"web-scene",s=e&&e.portal||null,n=e&&e.url||null;return import("./layersCreator.0cde4d2d.js").then(({populateOperationalLayers:o})=>{Dt(i);const a=[];if(t.layers&&Array.isArray(t.layers)){const l={context:{origin:r,url:n,portal:s,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};a.push(o(this.layers,t.layers,l))}return En(a)}).then(()=>{})}};function nbe(t){return t&&"createElevationSampler"in t}function PH(t){return t.type==="elevation"||nbe(t)}u([d({json:{read:!1}})],kh.prototype,"layers",null),u([Ee("layers")],kh.prototype,"writeLayers",null),u([d({readOnly:!0})],kh.prototype,"resourceInfo",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:Oi,read:{reader:yx,source:"transparency"},write:{writer:(t,e)=>{e.transparency=kF(t)},target:"transparency"}}})],kh.prototype,"opacity",void 0),u([d({type:Ae,json:{type:[Oi],write:(t,e)=>{e.surfaceColor=t.toJSON().slice(0,3)}}})],kh.prototype,"surfaceColor",void 0),u([d({type:DM,json:{write:!0}})],kh.prototype,"navigationConstraint",void 0),kh=zF=u([R("esri.Ground")],kh);const vx=kh;let FM=class extends ve{constructor(t){super(t),this._groups=new Map}destroy(){this.removeAll()}get size(){let t=0;return this._groups.forEach(e=>{t+=e.length}),t}add(t,e){if(!this._isHandle(t)&&!Array.isArray(t)&&!We.isCollection(t))return this;const i=this._getOrCreateGroup(e);return Array.isArray(t)||We.isCollection(t)?t.forEach(r=>this._isHandle(r)&&i.push(r)):i.push(t),this.notifyChange("size"),this}forEach(t,e){if(typeof t=="function")this._groups.forEach(i=>i.forEach(t));else{const i=this._getGroup(t);i&&e&&i.forEach(e)}}has(t){return this._groups.has(this._ensureGroupKey(t))}remove(t){if(Array.isArray(t)||We.isCollection(t))return t.forEach(this.remove,this),this;if(!this.has(t))return this;const e=this._getGroup(t);for(let i=0;i<e.length;i++)e[i].remove();return this._deleteGroup(t),this.notifyChange("size"),this}removeAll(){return this._groups.forEach(t=>{for(let e=0;e<t.length;e++)t[e].remove()}),this._groups.clear(),this.notifyChange("size"),this}_isHandle(t){return t&&!!t.remove}_getOrCreateGroup(t){if(this.has(t))return this._getGroup(t);const e=[];return this._groups.set(this._ensureGroupKey(t),e),e}_getGroup(t){return Kr(this._groups.get(this._ensureGroupKey(t)))}_deleteGroup(t){return this._groups.delete(this._ensureGroupKey(t))}_ensureGroupKey(t){return t||"_default_"}};u([d({readOnly:!0})],FM.prototype,"size",null),FM=u([R("esri.core.Handles")],FM);const dt=FM;function hn(t,e,i={}){return AH(t,e,i,abe)}function obe(t,e,i={}){return AH(t,e,i,lbe)}function AH(t,e,i={},r){let s=null;const n=i.once?(o,a)=>{r(o)&&(ln(s),e(o,a))}:(o,a)=>{r(o)&&e(o,a)};if(s=E0e(t,n,i.sync,i.equals),i.initial){const o=t();n(o,o)}return s}function abe(t){return!0}function lbe(t){return!!t}const cbe={sync:!0},unt={initial:!0},VF={sync:!0,initial:!0},ube=/\?(\.|$)/g;function Ke(t,e,i,r){const s=Array.isArray(e)?e:e.indexOf(",")>-1?e.split(","):[e],n=gi(t,e,i,r);for(const o of s){const a=o.trim().replace(ube,"$1"),l=t.get(a);i.call(t,l,l,a,t)}return n}function gi(t,e,i,r){return t.watch(e,i,r)}function hbe(t,e,i,r){return wx(t,e,null,i,r)}function NF(t,e,i,r){return kM(t,e,EH,i,r)}function _x(t,e,i,r){return wx(t,e,EH,i,r)}function hnt(t,e,i,r){return wx(t,e,fbe,i,r)}function dbe(t,e,i,r){return kM(t,e,OH,i,r)}function bx(t,e,i,r){return wx(t,e,OH,i,r)}function LM(t,e,i,r){return kM(t,e,RH,i,r)}function pbe(t,e,i,r){return wx(t,e,RH,i,r)}function $H(t,e,i,r){let s=!1;const n=t.watch(e,(o,a,l,c)=>{s||i.call(t,o,a,l,c)},r);return{remove(){n.remove()},pause(){s=!0},resume(){s=!1}}}function ks(t,e,i,r,s,n,o){const a={};function l(h){const p=a[h];p&&(n&&n(p.target,h,t,i),p.handle.remove(),delete a[h])}const c=Ke(t,e,(h,p,f)=>{l(f),fD(h)&&(a[f]={handle:qC(h,i,r),target:h},s&&s(h,f,t,i))},o);return{remove(){c.remove();for(const h in a)l(h)}}}function kM(t,e,i,r,s){const n=t.watch(e,(o,a,l,c)=>{i&&!i(o)||r==null||r.call(t,o,a,l,c)},s);if(Array.isArray(e))for(const o of e){const a=t.get(o);i&&i(a)&&(r==null||r.call(t,a,a,e,t))}else{const o=t.get(e);i&&i(o)&&(r==null||r.call(t,o,o,e,t))}return n}function wx(t,e,i,r,s){const n=typeof r=="function"?r:null,o=typeof r=="object"?r:null;typeof r=="boolean"&&(s=r);let a,l=!1;function c(){a&&(a.remove(),a=null)}const h=xp();ps(o,()=>{c(),h.reject($t())});const p={then:h.promise.then.bind(h.promise),catch:h.promise.catch.bind(h.promise),remove:c};return Object.freeze(p),a=kM(t,e,i,(f,g,y,v)=>{l=!0,c(),n&&n.call(t,f,g,y,v),h.resolve({value:f,oldValue:g,propertyName:y,target:v})},s),l&&c(),p}function EH(t){return!!t}function fbe(t){return!t}function OH(t){return t===!0}function RH(t){return t===!1}let zh=class extends ve{constructor(){super(...arguments),this.updating=!1,this.handleId=0,this.handles=new dt,this.scheduleHandleId=0,this.pendingPromises=new Set}destroy(){this.removeAll(),this.handles.destroy()}add(t,e,i,r=0){const s=(1&r)!=0,n=++this.handleId;s||this.installSyncUpdatingWatch(t,e,n);const o=(2&r)!=0?Ke(t,e,i,s):t.watch(e,i,s);return this.handles.add(o,n),{remove:()=>this.handles.remove(n)}}addOnCollectionPropertyChange(t,e,i,r=0){const s=(2&r)!=0,n=++this.handleId;return this.handles.add([ks(t,e,"after-changes",this.createSyncUpdatingCallback()),ks(t,e,"change",i,s?o=>{i({added:o.items,removed:[],moved:[],target:o})}:void 0)],n),{remove:()=>{this.handles.remove(n)}}}addOnCollectionChange(t,e,i=0){const r=(2&i)!=0,s=++this.handleId;return this.handles.add([t.on("after-changes",this.createSyncUpdatingCallback()),t.on("change",e)],s),r&&e({added:t.items,removed:[],moved:[],target:t}),{remove:()=>{this.handles.remove(s)}}}addPromise(t){if(A(t))return t;const e=++this.handleId;this.handles.add({remove:()=>{this.pendingPromises.delete(t)&&(this.pendingPromises.size!==0||this.handles.has(zM)||this._set("updating",!1))}},e),this.pendingPromises.add(t),this._set("updating",!0);const i=()=>this.handles.remove(e);return t.then(i,i),t}removeAll(){this.pendingPromises.clear(),this.handles.removeAll(),this._set("updating",!1)}installSyncUpdatingWatch(t,e,i){const r=this.createSyncUpdatingCallback(),s=hn(()=>Vv(t,e),r,{sync:!0,equals:()=>!1});return this.handles.add(s,i),s}createSyncUpdatingCallback(){return()=>{this.handles.remove(zM),++this.scheduleHandleId;const t=this.scheduleHandleId;this._get("updating")||this._set("updating",!0),this.handles.add(Yw(()=>{t===this.scheduleHandleId&&(this._set("updating",this.pendingPromises.size>0),this.handles.remove(zM))}),zM)}}};u([d({readOnly:!0})],zh.prototype,"updating",void 0),zh=u([R("esri.views.support.WatchUpdatingTracking")],zh);const zM=-42,tu=t=>{let e=class extends t{destroy(){var i,r;this.destroyed||((i=this._get("handles"))==null||i.destroy(),(r=this._get("updatingHandles"))==null||r.destroy())}get handles(){return this._get("handles")||new dt}get updatingHandles(){return this._get("updatingHandles")||new zh}};return u([d({readOnly:!0})],e.prototype,"handles",null),u([d({readOnly:!0})],e.prototype,"updatingHandles",null),e=u([R("esri.core.HandleOwner")],e),e};let e1=class extends tu(ve){};e1=u([R("esri.core.HandleOwner")],e1);let t1=class extends tu(We){constructor(t){super(t),this.getCollections=null}initialize(){this.handles.add(CG(()=>this.refresh()))}destroy(){this.getCollections=null}refresh(){const t=_(this.getCollections)?this.getCollections():null;if(A(t))return void this.removeAll();let e=0;for(const i of t)_(i)&&(e=this._processCollection(e,i));this.splice(e,this.length)}_createNewInstance(t){return new We(t)}_processCollection(t,e){if(!e)return t;const i=this.itemFilterFunction?this.itemFilterFunction:r=>!!r;for(const r of e)if(r){if(i(r)){const s=this.indexOf(r,t);s>=0?s!==t&&this.reorder(r,t):this.add(r,t),++t}if(this.getChildrenFunction){const s=this.getChildrenFunction(r);if(Array.isArray(s))for(const n of s)t=this._processCollection(t,n);else t=this._processCollection(t,s)}}return t}};u([d()],t1.prototype,"getCollections",void 0),u([d()],t1.prototype,"getChildrenFunction",void 0),u([d()],t1.prototype,"itemFilterFunction",void 0),t1=u([R("esri.core.CollectionFlattener")],t1);const i1=t1;function mbe(t){var e;return!!(t&&t.loaded&&"capabilities"in t&&t!=null&&(e=t.capabilities)!=null&&e.operations&&"supportsEditing"in t.capabilities.operations&&t.capabilities.operations.supportsEditing===!0)&&!("editingEnabled"in t&&!t.editingEnabled)}const IH=le.getLogger("esri.support.basemapUtils");function gbe(){return{}}function ybe(t){for(const e in t){const i=t[e];(i==null?void 0:i.destroyed)===!1&&i.destroy(),delete t[e]}}function vbe(t,e){var i;let r;if(typeof t=="string"){if(!(t in mF)){const s=Object.entries(mF).filter(([n,o])=>ei.apiKey&&!o.classic||!ei.apiKey&&o.classic&&!o.deprecated).map(([n])=>`"${n}"`).join(", ");return IH.warn(`Unable to find basemap definition for: ${t}. Try one of these: ${s}`),null}e&&(r=e[t]),r||(r=CM.fromId(t),e&&(e[t]=r))}else r=Ni(CM,t);return(i=r)!=null&&i.destroyed&&(IH.warn("The provided basemap is already destroyed",{basemap:r}),r=null),r}const _be=le.getLogger("esri.support.groundUtils"),DH={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};function bbe(t){let e=null;if(typeof t=="string")if(t in DH){const i=DH[t];e=new vx({resourceInfo:{data:{layers:[i]}}})}else _be.warn(`Unable to find ground definition for: ${t}. Try "world-elevation"`);else e=Ni(vx,t);return e}function r1(t,e,i=!1){let{hasM:r,hasZ:s}=t;Array.isArray(e)?e.length!==4||r||s?e.length===3&&i&&!r?(s=!0,r=!1):e.length===3&&r&&s&&(r=!1,s=!1):(r=!0,s=!0):(s=!s&&e.hasZ&&(!r||e.hasM),r=!r&&e.hasM&&(!s||e.hasZ)),t.hasZ=s,t.hasM=r}var UF;function FH(t){return(e,i)=>e==null?i:i==null?e:t(e,i)}function wbe(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}let Rp=UF=class extends ho{constructor(...t){super(...t),this.points=[],this.type="multipoint"}normalizeCtorArgs(t,e){if(!t&&!e)return null;const i={};Array.isArray(t)?(i.points=t,i.spatialReference=e):wbe(t)?i.spatialReference=t:(t.points&&(i.points=t.points),t.spatialReference&&(i.spatialReference=t.spatialReference),t.hasZ&&(i.hasZ=t.hasZ),t.hasM&&(i.hasM=t.hasM));const r=i.points&&i.points[0];return r&&(i.hasZ===void 0&&i.hasM===void 0?(i.hasZ=r.length>2,i.hasM=!1):i.hasZ===void 0?i.hasZ=r.length>3:i.hasM===void 0&&(i.hasM=r.length>3)),i}get cache(){return this.commitProperty("points"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const t=this.points;if(!t.length)return null;const e=new ht,i=this.hasZ,r=this.hasM,s=i?3:2,n=t[0],o=FH(Math.min),a=FH(Math.max);let l,c,h,p,[f,g]=n,[y,v]=n;for(let b=0,w=t.length;b<w;b++){const S=t[b],[T,C]=S;if(f=o(f,T),g=o(g,C),y=a(y,T),v=a(v,C),i&&S.length>2){const M=S[2];l=o(l,M),h=a(h,M)}if(r&&S.length>s){const M=S[s];c=o(c,M),p=a(p,M)}}return e.xmin=f,e.ymin=g,e.xmax=y,e.ymax=v,e.spatialReference=this.spatialReference,i?(e.zmin=l,e.zmax=h):(e.zmin=null,e.zmax=null),r?(e.mmin=c,e.mmax=p):(e.mmin=null,e.mmax=null),e}writePoints(t,e){e.points=ie(this.points)}addPoint(t){return r1(this,t),Array.isArray(t)?this.points.push(t):this.points.push(t.toArray()),this.notifyChange("points"),this}clone(){const t={points:ie(this.points),spatialReference:this.spatialReference};return this.hasZ&&(t.hasZ=!0),this.hasM&&(t.hasM=!0),new UF(t)}getPoint(t){if(!this._validateInputs(t))return null;const e=this.points[t],i={x:e[0],y:e[1],spatialReference:this.spatialReference};let r=2;return this.hasZ&&(i.z=e[2],r=3),this.hasM&&(i.m=e[r]),new je(i)}removePoint(t){if(!this._validateInputs(t))return null;const e=new je(this.points.splice(t,1)[0],this.spatialReference);return this.notifyChange("points"),e}setPoint(t,e){return this._validateInputs(t)?(r1(this,e),Array.isArray(e)||(e=e.toArray()),this.points[t]=e,this.notifyChange("points"),this):this}toJSON(t){return this.write({},t)}_validateInputs(t){return t!=null&&t>=0&&t<this.points.length}};u([d({readOnly:!0})],Rp.prototype,"cache",null),u([d()],Rp.prototype,"extent",null),u([d({type:[[Number]],json:{write:{isRequired:!0}}})],Rp.prototype,"points",void 0),u([Ee("points")],Rp.prototype,"writePoints",null),Rp=UF=u([R("esri.geometry.Multipoint")],Rp),Rp.prototype.toJSON.isDefaultToJSON=!0;const $g=Rp;function jF(t,e){const i=e[0]-t[0],r=e[1]-t[1];if(t.length>2&&e.length>2){const s=t[2]-e[2];return Math.sqrt(i*i+r*r+s*s)}return Math.sqrt(i*i+r*r)}function LH(t,e,i){const r=t[0]+i*(e[0]-t[0]),s=t[1]+i*(e[1]-t[1]);return t.length>2&&e.length>2?[r,s,t[2]+i*(e[2]-t[2])]:[r,s]}function xbe(t,e){return LH(t,e,.5)}function kH(t){const e=t.length;let i=0;for(let r=0;r<e-1;++r)i+=jF(t[r],t[r+1]);return i}function zH(t,e){if(e<=0)return t[0];const i=t.length;let r=0;for(let s=0;s<i-1;++s){const n=jF(t[s],t[s+1]);if(e-r<n){const o=(e-r)/n;return LH(t[s],t[s+1],o)}r+=n}return t[i-1]}function BF(t,e,i){const r=t.length;let s=0,n=0,o=0;for(let a=0;a<r;a++){const l=t[a],c=t[(a+1)%r];let h=2;s+=l[0]*c[1]-c[0]*l[1],l.length>2&&c.length>2&&i&&(n+=l[0]*c[2]-c[0]*l[2],h=3),l.length>h&&c.length>h&&e&&(o+=l[0]*c[h]-c[0]*l[h])}return s<=0&&n<=0&&o<=0}function Sbe(t){return t?VH(t.rings,t.hasZ):null}function VH(t,e){if(!t||!t.length)return null;const i=[],r=[],s=e?[1/0,-1/0,1/0,-1/0,1/0,-1/0]:[1/0,-1/0,1/0,-1/0];for(let n=0,o=t.length;n<o;n++){const a=Tbe(t[n],e,s);a&&r.push(a)}if(r.sort((n,o)=>{let a=n[2]-o[2];return a===0&&e&&(a=n[4]-o[4]),a}),r.length&&(i[0]=r[0][0],i[1]=r[0][1],e&&(i[2]=r[0][3]),(i[0]<s[0]||i[0]>s[1]||i[1]<s[2]||i[1]>s[3]||e&&(i[2]<s[4]||i[2]>s[5]))&&(i.length=0)),!i.length){const n=t[0]&&t[0].length?Cbe(t[0],e):null;if(!n)return null;i[0]=n[0],i[1]=n[1],e&&n.length>2&&(i[2]=n[2])}return i}function Tbe(t,e,i){let r=0,s=0,n=0,o=0,a=0;const l=t.length?t[0][0]:0,c=t.length?t[0][1]:0,h=t.length&&e?t[0][2]:0;for(let f=0;f<t.length;f++){const g=t[f],y=t[(f+1)%t.length],[v,b,w]=g,S=v-l,T=b-c,C=e?w-h:void 0,[M,P,F]=y,z=M-l,D=P-c,U=e?F-h:void 0,G=S*D-z*T;if(o+=G,r+=(S+z)*G,s+=(T+D)*G,e&&g.length>2&&y.length>2){const k=S*U-z*C;n+=(C+U)*k,a+=k}v<i[0]&&(i[0]=v),v>i[1]&&(i[1]=v),b<i[2]&&(i[2]=b),b>i[3]&&(i[3]=b),e&&(w<i[4]&&(i[4]=w),w>i[5]&&(i[5]=w))}if(o>0&&(o*=-1),a>0&&(a*=-1),!o)return null;o*=.5,a*=.5;const p=[r/(6*o)+l,s/(6*o)+c,o];return e&&(i[4]===i[5]||a===0?(p[3]=(i[4]+i[5])/2,p[4]=0):(p[3]=n/(6*a)+h,p[4]=a)),p}function Cbe(t,e){const i=e?[0,0,0]:[0,0],r=e?[0,0,0]:[0,0];let s=0,n=0,o=0,a=0;for(let l=0,c=t.length;l<c-1;l++){const h=t[l],p=t[l+1];if(h&&p){i[0]=h[0],i[1]=h[1],r[0]=p[0],r[1]=p[1],e&&h.length>2&&p.length>2&&(i[2]=h[2],r[2]=p[2]);const f=jF(i,r);if(f){s+=f;const g=xbe(h,p);n+=f*g[0],o+=f*g[1],e&&g.length>2&&(a+=f*g[2])}}}return s>0?e?[n/s,o/s,a/s]:[n/s,o/s]:t.length?t[0]:null}function NH(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function UH(t){return t.points!==void 0}function jH(t){return t.x!==void 0&&t.y!==void 0}function BH(t){return t.paths!==void 0}function GH(t){return t.rings!==void 0}function qH(t){return(e,i)=>e==null?i:i==null?e:t(e,i)}const Ip=qH(Math.min),Dp=qH(Math.max);function dnt(t,e){return BH(e)?s1(t,e.paths,!1,!1):GH(e)?s1(t,e.rings,!1,!1):UH(e)?GF(t,e.points,!1,!1,!1,!1):NH(e)?HH(t,e):(jH(e)&&(t[0]=e.x,t[1]=e.y,t[2]=e.x,t[3]=e.y),t)}function pnt(t,e){return BH(e)?s1(t,e.paths,!0,!1):GH(e)?s1(t,e.rings,!0,!1):UH(e)?GF(t,e.points,!0,!1,!0,!1):NH(e)?HH(t,e,!0,!1,!0,!1):(jH(e)&&(t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.x,t[4]=e.y,t[5]=e.z),t)}function s1(t,e,i,r){const s=i?3:2;if(!e.length||!e[0].length)return null;let n,o,a,l,[c,h]=e[0][0],[p,f]=e[0][0];for(let g=0;g<e.length;g++){const y=e[g];for(let v=0;v<y.length;v++){const b=y[v],[w,S]=b;if(c=Ip(c,w),h=Ip(h,S),p=Dp(p,w),f=Dp(f,S),i&&b.length>2){const T=b[2];n=Ip(n,T),o=Dp(o,T)}if(r&&b.length>s){const T=b[s];a=Ip(n,T),l=Dp(o,T)}}}return i?r?(t[0]=c,t[1]=h,t[2]=n,t[3]=a,t[4]=p,t[5]=f,t[6]=o,t[7]=l,t.length=8,t):(t[0]=c,t[1]=h,t[2]=n,t[3]=p,t[4]=f,t[5]=o,t.length=6,t):r?(t[0]=c,t[1]=h,t[2]=a,t[3]=p,t[4]=f,t[5]=l,t.length=6,t):(t[0]=c,t[1]=h,t[2]=p,t[3]=f,t.length=4,t)}function HH(t,e,i,r,s,n){const o=e.xmin,a=e.xmax,l=e.ymin,c=e.ymax;let h=e.zmin,p=e.zmax,f=e.mmin,g=e.mmax;return s?(h=h||0,p=p||0,n?(f=f||0,g=g||0,t[0]=o,t[1]=l,t[2]=h,t[3]=f,t[4]=a,t[5]=c,t[6]=p,t[7]=g,t):(t[0]=o,t[1]=l,t[2]=h,t[3]=a,t[4]=c,t[5]=p,t)):n?(f=f||0,g=g||0,t[0]=o,t[1]=l,t[2]=f,t[3]=a,t[4]=c,t[5]=g,t):(t[0]=o,t[1]=l,t[2]=a,t[3]=c,t)}function GF(t,e,i,r,s,n){const o=i?3:2,a=r&&n,l=i&&s;if(!e.length||!e[0].length)return null;let c,h,p,f,[g,y]=e[0],[v,b]=e[0];for(let w=0;w<e.length;w++){const S=e[w],[T,C]=S;if(g=Ip(g,T),y=Ip(y,C),v=Dp(v,T),b=Dp(b,C),l&&S.length>2){const M=S[2];c=Ip(c,M),h=Dp(h,M)}if(a&&S.length>o){const M=S[o];p=Ip(c,M),f=Dp(h,M)}}return s?(c=c||0,h=h||0,n?(p=p||0,f=f||0,t[0]=g,t[1]=y,t[2]=c,t[3]=p,t[4]=v,t[5]=b,t[6]=h,t[7]=f,t):(t[0]=g,t[1]=y,t[2]=c,t[3]=v,t[4]=b,t[5]=h,t)):n?(p=p||0,f=f||0,t[0]=g,t[1]=y,t[2]=p,t[3]=v,t[4]=b,t[5]=f,t):(t[0]=g,t[1]=y,t[2]=v,t[3]=b,t)}function Mbe(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function Pbe(t){return t.points!==void 0}function Abe(t){return t.x!==void 0&&t.y!==void 0}function $be(t){return t.paths!==void 0}function Ebe(t){return t.rings!==void 0}const qF=[];function WH(t,e,i,r){return{xmin:t,ymin:e,xmax:i,ymax:r}}function ZH(t,e,i,r,s,n){return{xmin:t,ymin:e,zmin:i,xmax:r,ymax:s,zmax:n}}function JH(t,e,i,r,s,n){return{xmin:t,ymin:e,mmin:i,xmax:r,ymax:s,mmax:n}}function QH(t,e,i,r,s,n,o,a){return{xmin:t,ymin:e,zmin:i,mmin:r,xmax:s,ymax:n,zmax:o,mmax:a}}function HF(t,e=!1,i=!1){return e?i?QH(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]):ZH(t[0],t[1],t[2],t[3],t[4],t[5]):i?JH(t[0],t[1],t[2],t[3],t[4],t[5]):WH(t[0],t[1],t[2],t[3])}function fnt(t){return t?Mbe(t)?t:Abe(t)?Rbe(t):Ebe(t)?YH(t):$be(t)?XH(t):Pbe(t)?Obe(t):null:null}function Obe(t){const{hasZ:e,hasM:i,points:r}=t;return HF(GF(qF,r,e,i),e,i)}function Rbe(t){const{x:e,y:i,z:r,m:s}=t,n=s!=null;return r!=null?n?QH(e,i,r,s,e,i,r,s):ZH(e,i,r,e,i,r):n?JH(e,i,s,e,i,s):WH(e,i,e,i)}function YH(t){const{hasZ:e,hasM:i,rings:r}=t,s=s1(qF,r,e,i);return s?HF(s,e,i):null}function XH(t){const{hasZ:e,hasM:i,paths:r}=t,s=s1(qF,r,e,i);return s?HF(s,e,i):null}var VM;function KH(t){return!Array.isArray(t[0])}let iu=VM=class extends ho{constructor(...t){super(...t),this.rings=[],this.type="polygon"}static fromExtent(t){const e=t.clone().normalize(),i=t.spatialReference;let r=!1,s=!1;for(const o of e)o.hasZ&&(r=!0),o.hasM&&(s=!0);const n={rings:e.map(function(o){const a=[[o.xmin,o.ymin],[o.xmin,o.ymax],[o.xmax,o.ymax],[o.xmax,o.ymin],[o.xmin,o.ymin]];if(r&&o.hasZ){const l=o.zmin+.5*(o.zmax-o.zmin);for(let c=0;c<a.length;c++)a[c].push(l)}if(s&&o.hasM){const l=o.mmin+.5*(o.mmax-o.mmin);for(let c=0;c<a.length;c++)a[c].push(l)}return a}),spatialReference:i};return r&&(n.hasZ=!0),s&&(n.hasM=!0),new VM(n)}normalizeCtorArgs(t,e){let i,r,s=null,n=null;return t&&!Array.isArray(t)?(s=t.rings?t.rings:null,e||(t.spatialReference?e=t.spatialReference:t.rings||(e=t)),i=t.hasZ,r=t.hasM):s=t,s=s||[],e=e||Ue.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(i===void 0&&r===void 0?(i=n.length>2,r=n.length>3):i===void 0?i=r?n.length>3:n.length>2:r===void 0&&(r=i?n.length>3:n.length>2)),{rings:s,spatialReference:e,hasZ:i,hasM:r}}get cache(){return this.commitProperty("rings"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get centroid(){const t=Sbe(this);if(!t||isNaN(t[0])||isNaN(t[1])||this.hasZ&&isNaN(t[2]))return null;const e=new je;return e.x=t[0],e.y=t[1],e.spatialReference=this.spatialReference,this.hasZ&&(e.z=t[2]),e}get extent(){const{spatialReference:t}=this,e=YH(this);if(!e)return null;const i=new ht(e);return i.spatialReference=t,i}get isSelfIntersecting(){return U1e(this.rings)}writeRings(t,e){e.rings=ie(this.rings)}addRing(t){if(!t)return;const e=this.rings,i=e.length;if(KH(t)){const r=[];for(let s=0,n=t.length;s<n;s++)r[s]=t[s].toArray();e[i]=r}else e[i]=t.concat();return this.notifyChange("rings"),this}clone(){const t=new VM;return t.spatialReference=this.spatialReference,t.rings=ie(this.rings),t.hasZ=this.hasZ,t.hasM=this.hasM,t}equals(t){if(this===t)return!0;if(A(t))return!1;const e=this.spatialReference,i=t.spatialReference;if(_(e)!==_(i)||_(e)&&_(i)&&!e.equals(i)||this.rings.length!==t.rings.length)return!1;const r=([s,n,o,a],[l,c,h,p])=>s===l&&n===c&&(o==null&&h==null||o===h)&&(a==null&&p==null||a===p);for(let s=0;s<this.rings.length;s++){const n=this.rings[s],o=t.rings[s];if(!_p(n,o,r))return!1}return!0}contains(t){if(!t)return!1;const e=wg(t,this.spatialReference);return R1e(this,_(e)?e:t)}isClockwise(t){let e;return e=KH(t)?t.map(i=>this.hasZ?this.hasM?[i.x,i.y,i.z,i.m]:[i.x,i.y,i.z]:[i.x,i.y]):t,BF(e,this.hasM,this.hasZ)}getPoint(t,e){if(!this._validateInputs(t,e))return null;const i=this.rings[t][e],r=this.hasZ,s=this.hasM;return r&&!s?new je(i[0],i[1],i[2],void 0,this.spatialReference):s&&!r?new je(i[0],i[1],void 0,i[2],this.spatialReference):r&&s?new je(i[0],i[1],i[2],i[3],this.spatialReference):new je(i[0],i[1],this.spatialReference)}insertPoint(t,e,i){return this._validateInputs(t,e,!0)?(r1(this,i),Array.isArray(i)||(i=i.toArray()),this.rings[t].splice(e,0,i),this.notifyChange("rings"),this):this}removePoint(t,e){if(!this._validateInputs(t,e))return null;const i=new je(this.rings[t].splice(e,1)[0],this.spatialReference);return this.notifyChange("rings"),i}removeRing(t){if(!this._validateInputs(t,null))return null;const e=this.rings.splice(t,1)[0],i=this.spatialReference,r=e.map(s=>new je(s,i));return this.notifyChange("rings"),r}setPoint(t,e,i){return this._validateInputs(t,e)?(r1(this,i),Array.isArray(i)||(i=i.toArray()),this.rings[t][e]=i,this.notifyChange("rings"),this):this}_validateInputs(t,e,i=!1){if(t==null||t<0||t>=this.rings.length)return!1;if(e!=null){const r=this.rings[t];if(i&&(e<0||e>r.length)||!i&&(e<0||e>=r.length))return!1}return!0}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],iu.prototype,"cache",null),u([d({readOnly:!0})],iu.prototype,"centroid",null),u([d({readOnly:!0})],iu.prototype,"extent",null),u([d({readOnly:!0})],iu.prototype,"isSelfIntersecting",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],iu.prototype,"rings",void 0),u([Ee("rings")],iu.prototype,"writeRings",null),iu=VM=u([R("esri.geometry.Polygon")],iu),iu.prototype.toJSON.isDefaultToJSON=!0;const Zo=iu;var WF;function Ibe(t){return!Array.isArray(t[0])}let Fp=WF=class extends ho{constructor(...t){super(...t),this.paths=[],this.type="polyline"}normalizeCtorArgs(t,e){let i,r,s=null,n=null;return t&&!Array.isArray(t)?(s=t.paths?t.paths:null,e||(t.spatialReference?e=t.spatialReference:t.paths||(e=t)),i=t.hasZ,r=t.hasM):s=t,s=s||[],e=e||Ue.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(i===void 0&&r===void 0?(i=n.length>2,r=!1):i===void 0?i=!r&&n.length>3:r===void 0&&(r=!i&&n.length>3)),{paths:s,spatialReference:e,hasZ:i,hasM:r}}get cache(){return this.commitProperty("paths"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const{spatialReference:t}=this,e=XH(this);if(!e)return null;const i=new ht(e);return i.spatialReference=t,i}writePaths(t,e){e.paths=ie(this.paths)}addPath(t){if(!t)return;const e=this.paths,i=e.length;if(Ibe(t)){const r=[];for(let s=0,n=t.length;s<n;s++)r[s]=t[s].toArray();e[i]=r}else e[i]=t.concat();return this.notifyChange("paths"),this}clone(){const t=new WF;return t.spatialReference=this.spatialReference,t.paths=ie(this.paths),t.hasZ=this.hasZ,t.hasM=this.hasM,t}getPoint(t,e){if(!this._validateInputs(t,e))return null;const i=this.paths[t][e],r=this.hasZ,s=this.hasM;return r&&!s?new je(i[0],i[1],i[2],void 0,this.spatialReference):s&&!r?new je(i[0],i[1],void 0,i[2],this.spatialReference):r&&s?new je(i[0],i[1],i[2],i[3],this.spatialReference):new je(i[0],i[1],this.spatialReference)}insertPoint(t,e,i){return this._validateInputs(t,e,!0)?(r1(this,i),Array.isArray(i)||(i=i.toArray()),this.paths[t].splice(e,0,i),this.notifyChange("paths"),this):this}removePath(t){if(!this._validateInputs(t,null))return null;const e=this.paths.splice(t,1)[0],i=this.spatialReference,r=e.map(s=>new je(s,i));return this.notifyChange("paths"),r}removePoint(t,e){if(!this._validateInputs(t,e))return null;const i=new je(this.paths[t].splice(e,1)[0],this.spatialReference);return this.notifyChange("paths"),i}setPoint(t,e,i){return this._validateInputs(t,e)?(r1(this,i),Array.isArray(i)||(i=i.toArray()),this.paths[t][e]=i,this.notifyChange("paths"),this):this}_validateInputs(t,e,i=!1){if(t==null||t<0||t>=this.paths.length)return!1;if(e!=null){const r=this.paths[t];if(i&&(e<0||e>r.length)||!i&&(e<0||e>=r.length))return!1}return!0}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],Fp.prototype,"cache",null),u([d({readOnly:!0})],Fp.prototype,"extent",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],Fp.prototype,"paths",void 0),u([Ee("paths")],Fp.prototype,"writePaths",null),Fp=WF=u([R("esri.geometry.Polyline")],Fp),Fp.prototype.toJSON.isDefaultToJSON=!0;const Jo=Fp,eW=Ds()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon"}),tW=Ds()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh"});function iW(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function ZF(t){return t.points!==void 0}function JF(t){return t.x!==void 0&&t.y!==void 0}function QF(t){return t.paths!==void 0}function Eg(t){return t.rings!==void 0}function Lp(t){return A(t)?null:t instanceof ho?t:JF(t)?je.fromJSON(t):QF(t)?Jo.fromJSON(t):Eg(t)?Zo.fromJSON(t):ZF(t)?$g.fromJSON(t):iW(t)?ht.fromJSON(t):null}function kp(t){return t?JF(t)?"esriGeometryPoint":QF(t)?"esriGeometryPolyline":Eg(t)?"esriGeometryPolygon":iW(t)?"esriGeometryEnvelope":ZF(t)?"esriGeometryMultipoint":null:null}const Dbe={esriGeometryPoint:je,esriGeometryPolyline:Jo,esriGeometryPolygon:Zo,esriGeometryEnvelope:ht,esriGeometryMultipoint:$g};function rW(t){return t&&Dbe[t]||null}const Og={base:ho,key:"type",typeMap:{extent:ht,multipoint:$g,point:je,polyline:Jo,polygon:Zo}};Zc(Og);let Fbe=0;const NM=t=>{let e=class extends t{constructor(...i){super(...i),Object.defineProperty(this,"uid",{writable:!1,configurable:!1,value:Date.now().toString(16)+"-object-"+Fbe++})}};return e=u([R("esri.core.Identifiable")],e),e};let sW=class extends NM(class{}){};sW=u([R("esri.core.Identifiable")],sW);let Lbe=0;const nW=le.getLogger("esri.layers.Layer");let is=class extends Ci.EventedMixin(NM(Ph)){constructor(){super(...arguments),this.attributionDataUrl=null,this.fullExtent=new ht(-180,-90,180,90,Ue.WGS84),this.id=Date.now().toString(16)+"-layer-"+Lbe++,this.legendEnabled=!0,this.listMode="show",this.opacity=1,this.parent=null,this.popupEnabled=!0,this.attributionVisible=!0,this.spatialReference=Ue.WGS84,this.title=null,this.type=null,this.url=null,this.visible=!0}static async fromArcGISServerUrl(t){const e=typeof t=="string"?{url:t}:t,i=await import("./arcgisLayers.610bd706.js");try{return await i.fromUrl(e)}catch(r){throw nW.error("#fromArcGISServerUrl({ url: '"+e.url+"'})","Failed to create layer from arcgis server url",r),r}}static async fromPortalItem(t){const e="portalItem"in t?t:{portalItem:t},i=await import("./portalLayers.cf4065fd.js").then(function(r){return r.p});try{return await i.fromItem(e)}catch(r){const s=e&&e.portalItem,n=s&&s.id||"unset",o=s&&s.portal&&s.portal.url||ei.portalUrl;throw nW.error("#fromPortalItem()","Failed to create layer from portal item (portal: '"+o+"', id: '"+n+"')",r),r}}initialize(){this.when().catch(t=>{var e,i;bi(t)||le.getLogger(this.declaredClass).error("#load()",`Failed to load layer (title: '${(e=this.title)!=null?e:"no title"}', id: '${(i=this.id)!=null?i:"no id"}')`,{error:t})})}destroy(){if(this.parent){const t=this,e=this.parent;"layers"in e&&e.layers.includes(t)?e.layers.remove(t):"tables"in e&&e.tables.includes(t)?e.tables.remove(t):"baseLayers"in e&&e.baseLayers.includes(t)?e.baseLayers.remove(t):"baseLayers"in e&&e.referenceLayers.includes(t)&&e.referenceLayers.remove(t)}}get hasAttributionData(){return this.attributionDataUrl!=null}get parsedUrl(){const t=this.url;return t?ms(t):null}async fetchAttributionData(){const t=this.attributionDataUrl;if(this.hasAttributionData&&t)return(await vt(t,{query:{f:"json"},responseType:"json"})).data;throw new Q("layer:no-attribution-data","Layer does not have attribution data")}};u([d({type:String})],is.prototype,"attributionDataUrl",void 0),u([d({type:ht})],is.prototype,"fullExtent",void 0),u([d({readOnly:!0})],is.prototype,"hasAttributionData",null),u([d({type:String})],is.prototype,"id",void 0),u([d({type:Boolean,nonNullable:!0})],is.prototype,"legendEnabled",void 0),u([d({type:["show","hide","hide-children"]})],is.prototype,"listMode",void 0),u([d({type:Number,range:{min:0,max:1},nonNullable:!0})],is.prototype,"opacity",void 0),u([d()],is.prototype,"parent",void 0),u([d({readOnly:!0})],is.prototype,"parsedUrl",null),u([d({type:Boolean})],is.prototype,"popupEnabled",void 0),u([d({type:Boolean})],is.prototype,"attributionVisible",void 0),u([d({type:Ue})],is.prototype,"spatialReference",void 0),u([d({type:String})],is.prototype,"title",void 0),u([d({type:String,readOnly:!0,json:{read:!1}})],is.prototype,"type",void 0),u([d()],is.prototype,"url",void 0),u([d({type:Boolean,nonNullable:!0})],is.prototype,"visible",void 0),is=u([R("esri.layers.Layer")],is);const n1=is;function kbe(t){return t&&t.type==="group"}function YF(t,e,i){let r,s;if(t)for(let n=0,o=t.length;n<o;n++){if(r=t.getItemAt(n),r[e]===i)return r;if(kbe(r)&&(s=YF(r.layers,e,i),s))return s}}const oW=le.getLogger("esri.support.LayersMixin"),zbe=t=>{let e=class extends t{constructor(...i){super(...i),this.layers=new We;const r=o=>{o.parent&&"remove"in o.parent&&o.parent.remove(o)},s=o=>{o.parent=this,this.layerAdded(o),o.type!=="elevation"&&o.type!=="base-elevation"||oW.error(`Layer 'title:${o.title}, id:${o.id}' of type '${o.type}' is not supported as an operational layer and will therefore be ignored.`)},n=o=>{o.parent=null,this.layerRemoved(o)};this.layers.on("before-add",o=>r(o.item)),this.layers.on("after-add",o=>s(o.item)),this.layers.on("after-remove",o=>n(o.item))}destroy(){const i=this.layers.removeAll();for(const r of i)this.layerRemoved(r),r.destroy();this.layers.destroy()}set layers(i){this._set("layers",vg(i,this._get("layers")))}add(i,r){const s=this.layers;if(r=s.getNextIndex(r),i instanceof n1){const n=i;n.parent===this?this.reorder(n,r):s.add(n,r)}else fg(i)?i.then(n=>{this.destroyed||this.add(n,r)}):oW.error("#add()","The item being added is not a Layer or a Promise that resolves to a Layer.")}addMany(i,r){const s=this.layers;r=s.getNextIndex(r),i.slice().forEach(n=>{n.parent!==this?(s.add(n,r),r+=1):this.reorder(n,r)})}findLayerById(i){return YF(this.layers,"id",i)}findLayerByUid(i){return YF(this.layers,"uid",i)}remove(i){return this.layers.remove(i)}removeMany(i){return this.layers.removeMany(i)}removeAll(){return this.layers.removeAll()}reorder(i,r){return this.layers.reorder(i,r)}layerAdded(i){}layerRemoved(i){}};return u([d()],e.prototype,"layers",null),e=u([R("esri.support.LayersMixin")],e),e},aW="esri.support.TablesMixin",Vbe=le.getLogger(aW);function Nbe(t){return t&&t.type==="group"}function XF(t,e,i){if(t)for(let r=0,s=t.length;r<s;r++){const n=t.getItemAt(r);if(n[e]===i)return n;if(Nbe(n)){const o=XF(n.tables,e,i);if(o)return o}}}const Ube=t=>{let e=class extends t{constructor(...i){super(...i),this.tables=new We,this.tables.on("after-add",r=>{const s=r.item;s.parent&&s.parent!==this&&"tables"in s.parent&&s.parent.tables.remove(s),s.parent=this,s.type!=="feature"&&Vbe.error(`Layer 'title:${s.title}, id:${s.id}' of type '${s.type}' is not supported as a table and will therefore be ignored.`)}),this.tables.on("after-remove",r=>{r.item.parent=null})}destroy(){const i=this.tables.removeAll();for(const r of i)r.destroy();this.tables.destroy()}set tables(i){this._set("tables",vg(i,this._get("tables")))}findTableById(i){return XF(this.tables,"id",i)}findTableByUid(i){return XF(this.tables,"uid",i)}};return u([d()],e.prototype,"tables",null),e=u([R(aW)],e),e};let ru=class extends Ube(zbe(Ci.EventedMixin(ve))){constructor(t){super(t),this.allLayers=new i1({getCollections:()=>{var e,i,r;return[(e=this.basemap)==null?void 0:e.baseLayers,(i=this.ground)==null?void 0:i.layers,this.layers,(r=this.basemap)==null?void 0:r.referenceLayers]},getChildrenFunction:e=>"layers"in e?e.layers:null}),this.allTables=new i1({getCollections:()=>[this.tables,this.layers],getChildrenFunction:e=>{const i=[];return"tables"in e&&i.push(e.tables),"layers"in e&&i.push(e.layers),i},itemFilterFunction:e=>{const i=e.parent;return i&&"tables"in i&&i.tables.includes(e)}}),this.basemap=null,this.editableLayers=new i1({getCollections:()=>[this.allLayers],itemFilterFunction:mbe}),this.ground=new vx,this._basemapCache=gbe()}destroy(){var t,e;this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),(t=this.ground)==null||t.destroy(),(e=this.basemap)==null||e.destroy(),ybe(this._basemapCache),this._basemapCache=null}castBasemap(t){return vbe(t,this._basemapCache)}castGround(t){const e=bbe(t);return A(e)?this._get("ground"):e}findLayerById(t){return this.allLayers.find(e=>e.id===t)}findTableById(t){return this.allTables.find(e=>e.id===t)}};u([d({readOnly:!0,dependsOn:[]})],ru.prototype,"allLayers",void 0),u([d({readOnly:!0})],ru.prototype,"allTables",void 0),u([d({type:CM})],ru.prototype,"basemap",void 0),u([ut("basemap")],ru.prototype,"castBasemap",null),u([d({readOnly:!0})],ru.prototype,"editableLayers",void 0),u([d({type:vx,nonNullable:!0})],ru.prototype,"ground",void 0),u([ut("ground")],ru.prototype,"castGround",null),ru=u([R("esri.Map")],ru);const jbe=ru;function Rg(t){const e=t[0]*t[0]+t[4]*t[4]+t[8]*t[8],i=t[1]*t[1]+t[5]*t[5]+t[9]*t[9],r=t[2]*t[2]+t[6]*t[6]+t[10]*t[10];return Math.sqrt(Math.max(e,i,r))}function Bbe(t,e){const i=Math.sqrt(e[0]*e[0]+e[4]*e[4]+e[8]*e[8]),r=Math.sqrt(e[1]*e[1]+e[5]*e[5]+e[9]*e[9]),s=Math.sqrt(e[2]*e[2]+e[6]*e[6]+e[10]*e[10]);return ne(t,i,r,s),t}function mnt(t,e,i){i=i||t;const r=ye(t,e);ne(i,t[0]-r*e[0],t[1]-r*e[1],t[2]-r*e[2]),_e(i,i)}function gnt(t,e,i){Math.abs(t[0])>Math.abs(t[1])?ne(e,0,1,0):ne(e,1,0,0),Ye(i,t,e),_e(e,e),Ye(e,i,t),_e(i,i)}function UM(t,e,i,r,s,n){const o=t+(e-t)*s;return o+(i+(r-i)*s-o)*n}function Gbe(t,e,i,r=$()){const s=Te(t),n=Te(e),o=ye(t,e)/(s*n);if(o<.9999999999999999){const a=Math.acos(o),l=((1-i)*s+i*n)/Math.sin(a),c=l/s*Math.sin((1-i)*a),h=l/n*Math.sin(i*a);return se(Ig,t,c),se(Dg,e,h),de(r,Ig,Dg)}return jr(r,t,e,i)}function ynt(t,e,i,r=$(),s=$()){const n=Te(t),o=Te(e),a=ye(t,e)/(n*o);if(a<.9999999999999999){const l=Math.acos(a),c=Math.sin(l),h=Math.sin(i*l),p=Math.sin((1-i)*l),f=(1-i)*n+i*o;{const g=f/c,y=g/o*h;se(Ig,t,g/n*p),se(Dg,e,y),de(r,Ig,Dg)}{const g=1/n*(-Math.cos((1-i)*l)*l*f+p*(-n+o));se(Ig,t,g);const y=1/o*(Math.cos(i*l)*l*f+h*(-n+o));se(Dg,e,y),de(s,Ig,Dg),se(s,s,1/c)}return s}return jr(r,t,e,i),ue(s,e,t),_e(s,s),s}function KF(t,e,i){t=_e(Ig,t),e=_e(Dg,e);const r=ar(ye(t,e));if(i){const s=Ye(Hbe,t,e);if(ye(s,i)<0)return-r}return r}function jM(t){const e=t.length;return function(i){if(i<=t[0][0])return t[0][1];if(i>=t[e-1][0])return t[e-1][1];let r=1;for(;i>t[r][0];)r++;const s=t[r-1][0],n=t[r][0],o=(n-i)/(n-s);return o*t[r-1][1]+(1-o)*t[r][1]}}class zp{constructor(e,i){this.min=e,this.max=i,this.range=i-e}ndiff(e,i=0){return Math.ceil((e-i)/this.range)*this.range+i}_normalize(e,i,r,s=0,n=!1){return(r-=s)<e?r+=this.ndiff(e-r):r>i&&(r-=this.ndiff(r-i)),n&&r===i&&(r=e),r+s}normalize(e,i=0,r=!1){return this._normalize(this.min,this.max,e,i,r)}clamp(e,i=0){return Re(e-i,this.min,this.max)+i}monotonic(e,i,r){return e<i?i:i+this.ndiff(e-i,r)}minimalMonotonic(e,i,r){return this._normalize(e,e+this.range,i,r)}center(e,i,r){return i=this.monotonic(e,i,r),this.normalize((e+i)/2,r)}diff(e,i,r){return this.monotonic(e,i,r)-e}shortestSignedDiff(e,i){e=this.normalize(e);const r=(i=this.normalize(i))-e,s=i<e?this.minimalMonotonic(e,i)-e:i-this.minimalMonotonic(i,e);return Math.abs(r)<Math.abs(s)?r:s}contains(e,i,r){return i=this.minimalMonotonic(e,i),(r=this.minimalMonotonic(e,r))>e&&r<i}}function vnt(t,e,i,r){ue(lW,e,t),ue(cW,i,t),Ye(r,lW,cW),_e(r,r),r[3]=-ye(t,r)}const lW=$(),cW=$();function e5(t){for(const e in t){const i=t[e];i instanceof Function&&(t[e]=i.bind(t))}return t}const qbe=e5(new zp(0,2*Math.PI)),Vp=e5(new zp(-Math.PI,Math.PI)),t5=e5(new zp(0,360)),Hbe=$(),Ig=$(),Dg=$();var i5;let Vh=i5=class extends ge{constructor(...t){super(...t),this.position=new je([0,0,0]),this.heading=0,this.tilt=0,this.fov=55}normalizeCtorArgs(t,e,i,r){if(t&&typeof t=="object"&&("x"in t||Array.isArray(t))){const s={position:t};return e!=null&&(s.heading=e),i!=null&&(s.tilt=i),r!=null&&(s.fov=r),s}return t}writePosition(t,e,i,r){const s=t.clone();s.x=kl(t.x||0),s.y=kl(t.y||0),s.z=t.hasZ?kl(t.z||0):t.z,e[i]=s.write({},r)}readPosition(t,e){const i=new je;return i.read(t,e),i.x=kl(i.x||0),i.y=kl(i.y||0),i.z=i.hasZ?kl(i.z||0):i.z,i}equals(t){return!!t&&this.tilt===t.tilt&&this.heading===t.heading&&this.fov===t.fov&&this.position.equals(t.position)}clone(){return new i5({position:this.position.clone(),heading:this.heading,tilt:this.tilt,fov:this.fov})}};u([d({type:je,json:{write:{isRequired:!0}}})],Vh.prototype,"position",void 0),u([Ee("position")],Vh.prototype,"writePosition",null),u([Ce("position")],Vh.prototype,"readPosition",null),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),ut(t=>t5.normalize(kl(t)))],Vh.prototype,"heading",void 0),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),ut(t=>Re(kl(t),-180,180))],Vh.prototype,"tilt",void 0),u([d({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],Vh.prototype,"fov",void 0),Vh=i5=u([R("esri.Camera")],Vh);const yo=Vh;var o1;function Wbe(t,e){switch(t.type){case"range":{const i="range"in t?t.range[0]:t.minValue,r="range"in t?t.range[1]:t.maxValue;if(+e<i||+e>r)return o1.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(t.codedValues==null||t.codedValues.every(i=>i==null||i.code!==e))return o1.INVALID_CODED_VALUE}return null}(function(t){t.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",t.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"})(o1||(o1={}));let r5;function su(){return r5||(r5=(async()=>{const t=await import("./arcadeUtils.af7f668d.js").then(function(e){return e.Q});return{arcade:t.arcade,arcadeUtils:t,Dictionary:t.Dictionary,Feature:t.arcadeFeature}})()),r5}const Zbe=(t,e,i)=>xx.create(t,e,i,null,["$feature"]),Jbe=(t,e,i)=>xx.create(t,e,i,null,["$feature","$view"]),Qbe=(t,e,i,r)=>xx.create(t,e,i,r,["$feature","$view"]);class xx{constructor(e,i,r,s,n,o,a,l){this.script=e,this.evaluate=n;const c=Array.isArray(a)?a:a.fields;this.fields=c,this._syntaxTree=s,this._arcade=i,this._arcadeDictionary=r,this._arcadeFeature=o,this._spatialReference=l,this._referencesGeometry=i.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(e,i,r,s,n,o){const{arcade:a,Feature:l,Dictionary:c}=await su(),h=Ue.fromJSON(i),p=a.parseScript(e,o),f=n.reduce((M,P)=>he(E({},M),{[P]:null}),{});let g=null;_(s)&&(g=new c(s),g.immutable=!0,f.$config=null);const y=a.scriptUsesGeometryEngine(p)&&a.enableGeometrySupport(),v=a.scriptUsesFeatureSet(p)&&a.enableFeatureSetSupport(),b=a.scriptIsAsync(p)&&a.enableAsyncSupport(),w={vars:f,spatialReference:h,useAsync:!!b},S=new c;S.immutable=!1,S.setField("scale",0);const T=a.compileScript(p,w),C=M=>("$view"in M&&M.$view&&(S.setField("scale",M.$view.scale),M.$view=S),g&&(M.$config=g),T({vars:M,spatialReference:h}));return await Promise.all([y,v,b]),new xx(e,a,c,p,C,new l,r,h)}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}repurposeAdapter(e){return this._arcadeFeature.repurposeFromAdapter(e,{fields:this.fields}),this._arcadeFeature}createDictionary(){return new this._arcadeDictionary}referencesMember(e){return this._arcade.referencesMember(this._syntaxTree,e)}referencesFunction(e){return this._arcade.referencesFunction(this._syntaxTree,e)}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}extractFieldLiterals(){return this._arcade.extractExpectedFieldLiterals(this._syntaxTree)}}const Ybe=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],Xbe=["field","normalizationField"];function uW(t,e){if(t!=null&&e!=null){for(const i of Array.isArray(t)?t:[t])if(hW(Ybe,i,e),"visualVariables"in i&&i.visualVariables)for(const r of i.visualVariables)hW(Xbe,r,e)}}function hW(t,e,i){if(t)for(const r of t){const s=zv(r,e),n=s&&typeof s!="function"&&i.get(s);n&&Bo(r,n.name,e)}}function dW(t,e){if(t!=null&&e!=null&&e.fields.length)if("startField"in t){const i=e.get(t.startField),r=e.get(t.endField);t.startField=i&&i.name||null,t.endField=r&&r.name||null}else{const i=e.get(t.startTimeField),r=e.get(t.endTimeField);t.startTimeField=i&&i.name||null,t.endTimeField=r&&r.name||null}}const s5=new Set;function pW(t,e){return t&&e?(s5.clear(),Sx(s5,t,e),Array.from(s5).sort()):[]}function Sx(t,e,i){var r;if(i)if(e!=null&&(r=e.fields)!=null&&r.length)if(i.includes("*"))for(const{name:s}of e.fields)t.add(s);else for(const s of i)Na(t,e,s);else{if(i.includes("*"))return t.clear(),void t.add("*");for(const s of i)t.add(s)}}function Na(t,e,i){if(typeof i=="string")if(e){const r=e.get(i);r&&t.add(r.name)}else t.add(i)}function _nt(t,e){return A(e)||A(t)?[]:e.includes("*")?t.fields.map(i=>i.name):e}async function Qo(t,e,i){var r;if(!i)return;const{arcadeUtils:s}=await su(),n=s.extractFieldNames(i,e==null||(r=e.fields)==null?void 0:r.map(o=>o.name));for(const o of n)Na(t,e,o)}async function fW(t,e,i){if(i&&i!=="1=1"){const r=(await import("./WhereClause.34680e97.js")).WhereClause.create(i,e);if(!r.isStandardized)throw new Q("fieldUtils:collectFilterFields","Where clause is not standardized");Sx(t,e,r.fieldNames)}}function Kbe({displayField:t,fields:e}){return t||(e&&e.length?n5(e,"name-or-title")||n5(e,"unique-identifier")||n5(e,"type-or-category")||ewe(e):null)}function ewe(t){for(const e of t){if(!e||!e.name)continue;const i=e.name.toLowerCase();if(i.indexOf("name")>-1||i.indexOf("title")>-1)return e.name}return null}function n5(t,e){for(const i of t)if(i&&i.valueType&&i.valueType===e)return i.name;return null}async function bnt(t,e){if(!e)return;const i=zv("elevationInfo.featureExpressionInfo",e);return i?i.collectRequiredFields(t,e.fieldsIndex):void 0}async function twe(t,e,i){i.outStatistic.onStatisticValueExpression?Qo(t,e,i.outStatistic.onStatisticValueExpression):t.add(i.outStatistic.onStatisticField)}async function wnt(t,e,i){var r,s;if(!e||!i||i.type!=="cluster")return;const n=[];if((r=i.popupTemplate)!=null&&r.expressionInfos&&n.push(...i.popupTemplate.expressionInfos.map(o=>Qo(t,e.fieldsIndex,o.expression))),Array.isArray((s=i.popupTemplate)==null?void 0:s.content)){const o=i.popupTemplate.content;for(const a of o)a.type==="expression"&&a.expressionInfo&&n.push(Qo(t,e.fieldsIndex,a.expressionInfo.expression))}i.fields&&n.push(...i.fields.map(o=>twe(t,e.fieldsIndex,o))),await Promise.all(n)}async function xnt(t,e,i){e&&(e.timeInfo&&_(i)&&i.timeExtent&&Sx(t,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),e.floorInfo&&Sx(t,e.fieldsIndex,[e.floorInfo.floorField]),_(i)&&_(i.where)&&await fW(t,e.fieldsIndex,i.where))}async function Snt(t,e,i){e&&i&&await Promise.all(i.map(r=>iwe(t,e,r)))}async function iwe(t,e,i){e&&i&&(i.valueExpression?await Qo(t,e.fieldsIndex,i.valueExpression):i.field&&Na(t,e.fieldsIndex,i.field))}function Tnt(t){if(!t)return[];const e="editFieldsInfo"in t&&t.editFieldsInfo;return e?pW(t.fieldsIndex,[e&&e.creatorField,e&&e.creationDateField,e&&e.editorField,e&&e.editDateField]):[]}async function Cnt(t,e){const{labelingInfo:i,fieldsIndex:r}=e;i&&i.length&&await Promise.all(i.map(s=>rwe(t,r,s)))}async function rwe(t,e,i){if(!i)return;const r=i.getLabelExpression(),s=i.where;if(r.type==="arcade")await Qo(t,e,r.expression);else{const n=r.expression.match(/{[^}]*}/g);n&&n.forEach(o=>{Na(t,e,o.slice(1,-1))})}await fW(t,e,s)}function swe(t){const e=t.defaultValue;return e!==void 0&&yW(t,e)?e:t.nullable?null:void 0}function mW(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)}function nwe(t){return t===null||mW(t)}const o5="isInteger"in Number?Number.isInteger:t=>typeof t=="number"&&isFinite(t)&&Math.floor(t)===t;function owe(t){return t===null||o5(t)}function gW(t){return t!=null&&typeof t=="string"}function awe(t){return t===null||gW(t)}function lwe(){return!0}function yW(t,e){let i;switch(t.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=t.nullable?owe:o5;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=t.nullable?nwe:mW;break;case"string":case"esriFieldTypeString":i=t.nullable?awe:gW;break;default:i=lwe}return arguments.length===1?i:i(e)}const cwe=["integer","small-integer","single","double"],uwe=new Set([...cwe,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function BM(t){return t!=null&&uwe.has(t.type)}function Mnt(t){return t!=null&&(t.type==="string"||t.type==="esriFieldTypeString")}var GM,qM;function Pnt(t){return t==null||typeof t=="number"&&isNaN(t)?null:t}function Ant(t,e){return t.nullable&&e===null?null:BM(t)&&!hwe(t.type,Number(e))?GM.OUT_OF_RANGE:yW(t,e)?t.domain?Wbe(t.domain,e):null:qM.INVALID_TYPE}function hwe(t,e){const i=typeof t=="string"?vW(t):t;return!!i&&(i.isInteger?o5(e)&&e>=i.min&&e<=i.max:e>=i.min&&e<=i.max)}function vW(t){switch(t){case"esriFieldTypeSmallInteger":case"small-integer":return dwe;case"esriFieldTypeInteger":case"integer":return pwe;case"esriFieldTypeSingle":case"single":return fwe;case"esriFieldTypeDouble":case"double":return mwe}}(function(t){t.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"})(GM||(GM={})),function(t){t.INVALID_TYPE="type-validation-error::invalid-type"}(qM||(qM={}));const dwe={min:-32768,max:32767,isInteger:!0},pwe={min:-2147483648,max:2147483647,isInteger:!0},fwe={min:-34e37,max:12e37,isInteger:!1},mwe={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function $nt(t,e,i){switch(t){case o1.INVALID_CODED_VALUE:return`Value ${i} is not in the coded domain - field: ${e.name}, domain: ${JSON.stringify(e.domain)}`;case o1.VALUE_OUT_OF_RANGE:return`Value ${i} is out of the range of valid values - field: ${e.name}, domain: ${JSON.stringify(e.domain)}`;case qM.INVALID_TYPE:return`Value ${i} is not a valid value for the field type - field: ${e.name}, type: ${e.type}, nullable: ${e.nullable}`;case GM.OUT_OF_RANGE:{const{min:r,max:s}=vW(e.type);return`Value ${i} is out of range for the number type - field: ${e.name}, type: ${e.type}, value range is ${r} to ${s}`}}}function gwe(t,e){return!ywe(t,e,null)}function ywe(t,e,i){if(!e||!e.attributes||!t){if(_(i))for(const n of t)i.add(n);return!0}const r=e.attributes;let s=!1;for(const n of t)if(!(n in r)){if(s=!0,!_(i))break;i.add(n)}return s}let HM=class extends ge{constructor(t){super(t),this.type=null}};u([d({type:["attachments","custom","fields","media","text","expression"],readOnly:!0,json:{read:!1,write:!0}})],HM.prototype,"type",void 0),HM=u([R("esri.popup.content.Content")],HM);const Fg=HM;var a5;let Lg=a5=class extends Fg{constructor(t){super(t),this.description=null,this.displayType=null,this.title=null,this.type="attachments"}clone(){return new a5({description:this.description,displayType:this.displayType,title:this.title})}};u([d({type:String,json:{write:!0}})],Lg.prototype,"description",void 0),u([d({type:["auto","preview","list"],json:{write:!0}})],Lg.prototype,"displayType",void 0),u([d({type:String,json:{write:!0}})],Lg.prototype,"title",void 0),u([d({type:["attachments"],readOnly:!0,json:{read:!1,write:!0}})],Lg.prototype,"type",void 0),Lg=a5=u([R("esri.popup.content.AttachmentsContent")],Lg);const Tx=Lg;var l5;let kg=l5=class extends Fg{constructor(t){super(t),this.creator=null,this.destroyer=null,this.outFields=null,this.type="custom"}clone(){return new l5({creator:this.creator,destroyer:this.destroyer,outFields:Array.isArray(this.outFields)?ie(this.outFields):null})}};u([d()],kg.prototype,"creator",void 0),u([d()],kg.prototype,"destroyer",void 0),u([d()],kg.prototype,"outFields",void 0),u([d({type:["custom"],readOnly:!0})],kg.prototype,"type",void 0),kg=l5=u([R("esri.popup.content.CustomContent")],kg);const vwe=kg;var c5;let a1=c5=class extends ge{constructor(t){super(t),this.title=null,this.expression=null,this.returnType="dictionary"}clone(){return new c5({title:this.title,expression:this.expression})}};u([d({type:String,json:{write:!0}})],a1.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],a1.prototype,"expression",void 0),u([d({type:["dictionary"],readOnly:!0,json:{read:!1,write:!0}})],a1.prototype,"returnType",void 0),a1=c5=u([R("esri.popup.ElementExpressionInfo")],a1);const _W=a1;var u5;let Cx=u5=class extends Fg{constructor(t){super(t),this.expressionInfo=null,this.type="expression"}clone(){var t;return new u5({expressionInfo:(t=this.expressionInfo)==null?void 0:t.clone()})}};u([d({type:_W,json:{write:!0}})],Cx.prototype,"expressionInfo",void 0),u([d({type:["expression"],readOnly:!0,json:{read:!1,write:!0}})],Cx.prototype,"type",void 0),Cx=u5=u([R("esri.popup.content.ExpressionContent")],Cx);const h5=Cx,Mx=Ds()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});Mx.toJSON.bind(Mx);Mx.fromJSON.bind(Mx);const nu={year:"numeric",month:"numeric",day:"numeric"},Px={year:"numeric",month:"long",day:"numeric"},Ax={year:"numeric",month:"short",day:"numeric"},$x={year:"numeric",month:"long",weekday:"long",day:"numeric"},Ua={hour:"numeric",minute:"numeric"},Gl=he(E({},Ua),{second:"numeric"}),d5={"short-date":nu,"short-date-short-time":E(E({},nu),Ua),"short-date-short-time-24":he(E(E({},nu),Ua),{hour12:!1}),"short-date-long-time":E(E({},nu),Gl),"short-date-long-time-24":he(E(E({},nu),Gl),{hour12:!1}),"short-date-le":nu,"short-date-le-short-time":E(E({},nu),Ua),"short-date-le-short-time-24":he(E(E({},nu),Ua),{hour12:!1}),"short-date-le-long-time":E(E({},nu),Gl),"short-date-le-long-time-24":he(E(E({},nu),Gl),{hour12:!1}),"long-month-day-year":Px,"long-month-day-year-short-time":E(E({},Px),Ua),"long-month-day-year-short-time-24":he(E(E({},Px),Ua),{hour12:!1}),"long-month-day-year-long-time":E(E({},Px),Gl),"long-month-day-year-long-time-24":he(E(E({},Px),Gl),{hour12:!1}),"day-short-month-year":Ax,"day-short-month-year-short-time":E(E({},Ax),Ua),"day-short-month-year-short-time-24":he(E(E({},Ax),Ua),{hour12:!1}),"day-short-month-year-long-time":E(E({},Ax),Gl),"day-short-month-year-long-time-24":he(E(E({},Ax),Gl),{hour12:!1}),"long-date":$x,"long-date-short-time":E(E({},$x),Ua),"long-date-short-time-24":he(E(E({},$x),Ua),{hour12:!1}),"long-date-long-time":E(E({},$x),Gl),"long-date-long-time-24":he(E(E({},$x),Gl),{hour12:!1}),"long-month-year":{month:"long",year:"numeric"},"short-month-year":{month:"short",year:"numeric"},year:{year:"numeric"},"short-time":Ua,"long-time":Gl},Ex=Ds()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});Ex.apiValues;Ex.toJSON.bind(Ex);Ex.fromJSON.bind(Ex);const _we={ar:"ar-u-nu-latn-ca-gregory"};let WM=new WeakMap,bW=d5["short-date-short-time"];function bwe(t){const e=t||bW;if(!WM.has(e)){const i=La(),r=_we[La()]||i;WM.set(e,new Intl.DateTimeFormat(r,e))}return WM.get(e)}function p5(t){return d5[t]||null}function Nh(t,e){return bwe(e).format(t)}lF(()=>{WM=new WeakMap,bW=d5["short-date-short-time"]});const wwe={ar:"ar-u-nu-latn"};let ZM=new WeakMap,wW={};function xwe(t){const e=t||wW;if(!ZM.has(e)){const i=La(),r=wwe[La()]||i;ZM.set(e,new Intl.NumberFormat(r,t))}return Kr(ZM.get(e))}function xW(t={}){const e={};return t.digitSeparator!=null&&(e.useGrouping=t.digitSeparator),t.places!=null&&(e.minimumFractionDigits=e.maximumFractionDigits=t.places),e}function Uh(t,e){return xwe(e).format(t)}lF(()=>{ZM=new WeakMap,wW={}});var f5;let zg=f5=class extends ge{constructor(t){super(t),this.dateFormat=null,this.dateTimeFormatOptions=null,this.digitSeparator=!1,this.places=null}clone(){return new f5({dateFormat:this.dateFormat,digitSeparator:this.digitSeparator,places:this.places})}format(t){return this.dateFormat?Nh(t,E(E({},p5(this.dateFormat)),this.dateTimeFormatOptions)):Uh(t,xW(this))}};u([Xe(Mx)],zg.prototype,"dateFormat",void 0),u([d({type:Object,json:{read:!1}})],zg.prototype,"dateTimeFormatOptions",void 0),u([d({type:Boolean,json:{write:!0}})],zg.prototype,"digitSeparator",void 0),u([d({type:Oi,json:{write:!0}})],zg.prototype,"places",void 0),zg=f5=u([R("esri.popup.support.FieldInfoFormat")],zg);const Ox=zg;var m5;let ql=m5=class extends ge{constructor(t){super(t),this.fieldName=null,this.format=null,this.isEditable=!1,this.label=null,this.stringFieldOption="text-box",this.statisticType=null,this.tooltip=null,this.visible=!0}clone(){return new m5({fieldName:this.fieldName,format:this.format?ie(this.format):null,isEditable:this.isEditable,label:this.label,stringFieldOption:this.stringFieldOption,statisticType:this.statisticType,tooltip:this.tooltip,visible:this.visible})}};u([d({type:String,json:{write:!0}})],ql.prototype,"fieldName",void 0),u([d({type:Ox,json:{write:!0}})],ql.prototype,"format",void 0),u([d({type:Boolean,json:{write:!0,default:!1}})],ql.prototype,"isEditable",void 0),u([d({type:String,json:{write:!0}})],ql.prototype,"label",void 0),u([Xe(new wt({richtext:"rich-text",textarea:"text-area",textbox:"text-box"}),{default:"text-box"})],ql.prototype,"stringFieldOption",void 0),u([d({type:["count","sum","min","max","avg","stddev","var"],json:{write:!0}})],ql.prototype,"statisticType",void 0),u([d({type:String,json:{write:!0}})],ql.prototype,"tooltip",void 0),u([d({type:Boolean,json:{write:!0}})],ql.prototype,"visible",void 0),ql=m5=u([R("esri.popup.FieldInfo")],ql);const Rx=ql;var g5;let jh=g5=class extends Fg{constructor(t){super(t),this.attributes=null,this.description=null,this.fieldInfos=null,this.title=null,this.type="fields"}writeFieldInfos(t,e){e.fieldInfos=t&&t.map(i=>i.toJSON())}clone(){return new g5(ie({attributes:this.attributes,description:this.description,fieldInfos:this.fieldInfos,title:this.title}))}};u([d({type:Object,json:{write:!0}})],jh.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],jh.prototype,"description",void 0),u([d({type:[Rx]})],jh.prototype,"fieldInfos",void 0),u([Ee("fieldInfos")],jh.prototype,"writeFieldInfos",null),u([d({type:String,json:{write:!0}})],jh.prototype,"title",void 0),u([d({type:["fields"],readOnly:!0,json:{read:!1,write:!0}})],jh.prototype,"type",void 0),jh=g5=u([R("esri.popup.content.FieldsContent")],jh);const l1=jh;let Vg=class extends ge{constructor(t){super(t),this.altText=null,this.caption="",this.title="",this.type=null}};u([d({type:String,json:{write:!0}})],Vg.prototype,"altText",void 0),u([d({type:String,json:{write:!0}})],Vg.prototype,"caption",void 0),u([d({type:String,json:{write:!0}})],Vg.prototype,"title",void 0),u([d({type:["image","bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],Vg.prototype,"type",void 0),Vg=u([R("esri.popup.content.mixins.MediaInfo")],Vg);const y5=Vg;var v5;let Ix=v5=class extends ve{constructor(t){super(t),this.tooltip=null,this.value=null}clone(){return new v5({tooltip:this.tooltip,value:this.value})}};u([d()],Ix.prototype,"tooltip",void 0),u([d()],Ix.prototype,"value",void 0),Ix=v5=u([R("esri.popup.content.support.ChartMediaInfoValueSeries")],Ix);const SW=Ix;var _5;let Ng=_5=class extends ge{constructor(t){super(t),this.fields=[],this.normalizeField=null,this.series=[],this.tooltipField=null}clone(){return new _5({fields:ie(this.fields),normalizeField:this.normalizeField,tooltipField:this.tooltipField})}};u([d({type:[String],json:{write:!0}})],Ng.prototype,"fields",void 0),u([d({type:String,json:{write:!0}})],Ng.prototype,"normalizeField",void 0),u([d({type:[SW],json:{read:!1}})],Ng.prototype,"series",void 0),u([d({type:String,json:{write:!0}})],Ng.prototype,"tooltipField",void 0),Ng=_5=u([R("esri.popup.content.support.ChartMediaInfoValue")],Ng);const Swe=Ng;let Dx=class extends y5{constructor(t){super(t),this.type=null,this.value=null}};u([d({type:["bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],Dx.prototype,"type",void 0),u([d({type:Swe,json:{write:!0}})],Dx.prototype,"value",void 0),Dx=u([R("esri.popup.content.mixins.ChartMediaInfo")],Dx);const JM=Dx,QM=Ds()({barchart:"bar-chart",columnchart:"column-chart",linechart:"line-chart",piechart:"pie-chart"});var b5;let YM=b5=class extends JM{constructor(t){super(t),this.type="bar-chart"}clone(){return new b5({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["bar-chart"],readOnly:!0,json:{type:["barchart"],read:!1,write:QM.write}})],YM.prototype,"type",void 0),YM=b5=u([R("esri.popup.content.BarChartMediaInfo")],YM);const TW=YM;var w5;let XM=w5=class extends JM{constructor(t){super(t),this.type="column-chart"}clone(){return new w5({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["column-chart"],readOnly:!0,json:{type:["columnchart"],read:!1,write:QM.write}})],XM.prototype,"type",void 0),XM=w5=u([R("esri.popup.content.ColumnChartMediaInfo")],XM);const CW=XM;var x5;let Fx=x5=class extends ge{constructor(t){super(t),this.linkURL=null,this.sourceURL=null}clone(){return new x5({linkURL:this.linkURL,sourceURL:this.sourceURL})}};u([d({type:String,json:{write:!0}})],Fx.prototype,"linkURL",void 0),u([d({type:String,json:{write:!0}})],Fx.prototype,"sourceURL",void 0),Fx=x5=u([R("esri.popup.content.support.ImageMediaInfoValue")],Fx);const Twe=Fx;var S5;let c1=S5=class extends y5{constructor(t){super(t),this.refreshInterval=null,this.type="image",this.value=null}clone(){return new S5({altText:this.altText,title:this.title,caption:this.caption,refreshInterval:this.refreshInterval,value:this.value?this.value.clone():null})}};u([d({type:Number,json:{write:!0}})],c1.prototype,"refreshInterval",void 0),u([d({type:["image"],readOnly:!0,json:{read:!1,write:!0}})],c1.prototype,"type",void 0),u([d({type:Twe,json:{write:!0}})],c1.prototype,"value",void 0),c1=S5=u([R("esri.popup.content.ImageMediaInfo")],c1);const MW=c1;var T5;let KM=T5=class extends JM{constructor(t){super(t),this.type="line-chart"}clone(){return new T5({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["line-chart"],readOnly:!0,json:{type:["linechart"],read:!1,write:QM.write}})],KM.prototype,"type",void 0),KM=T5=u([R("esri.popup.content.LineChartMediaInfo")],KM);const PW=KM;var C5;let eP=C5=class extends JM{constructor(t){super(t),this.type="pie-chart"}clone(){return new C5({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["pie-chart"],readOnly:!0,json:{type:["piechart"],read:!1,write:QM.write}})],eP.prototype,"type",void 0),eP=C5=u([R("esri.popup.content.PieChartMediaInfo")],eP);const AW=eP,$W={base:y5,key:"type",defaultKeyValue:"image",typeMap:{"bar-chart":TW,"column-chart":CW,"line-chart":PW,"pie-chart":AW,image:MW}};var M5;let Hl=M5=class extends Fg{constructor(t){super(t),this.activeMediaInfoIndex=null,this.attributes=null,this.description=null,this.mediaInfos=null,this.title=null,this.type="media"}readMediaInfos(t){return t&&t.map(e=>e.type==="image"?MW.fromJSON(e):e.type==="barchart"?TW.fromJSON(e):e.type==="columnchart"?CW.fromJSON(e):e.type==="linechart"?PW.fromJSON(e):e.type==="piechart"?AW.fromJSON(e):void 0).filter(Boolean)}writeMediaInfos(t,e){e.mediaInfos=t&&t.map(i=>i.toJSON())}clone(){return new M5(ie({activeMediaInfoIndex:this.activeMediaInfoIndex,attributes:this.attributes,description:this.description,mediaInfos:this.mediaInfos,title:this.title}))}};u([d()],Hl.prototype,"activeMediaInfoIndex",void 0),u([d({type:Object,json:{write:!0}})],Hl.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],Hl.prototype,"description",void 0),u([d({types:[$W]})],Hl.prototype,"mediaInfos",void 0),u([Ce("mediaInfos")],Hl.prototype,"readMediaInfos",null),u([Ee("mediaInfos")],Hl.prototype,"writeMediaInfos",null),u([d({type:String,json:{write:!0}})],Hl.prototype,"title",void 0),u([d({type:["media"],readOnly:!0,json:{read:!1,write:!0}})],Hl.prototype,"type",void 0),Hl=M5=u([R("esri.popup.content.MediaContent")],Hl);const Lx=Hl;var P5;let kx=P5=class extends Fg{constructor(t){super(t),this.text=null,this.type="text"}clone(){return new P5({text:this.text})}};u([d({type:String,json:{write:!0}})],kx.prototype,"text",void 0),u([d({type:["text"],readOnly:!0,json:{read:!1,write:!0}})],kx.prototype,"type",void 0),kx=P5=u([R("esri.popup.content.TextContent")],kx);const u1=kx,Cwe={base:null,key:"type",typeMap:{attachment:Tx,media:Lx,text:u1,expression:h5,field:l1}};var A5;let Ug=A5=class extends ge{constructor(t){super(t),this.name=null,this.title=null,this.expression=null,this.returnType=null}clone(){return new A5({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],Ug.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],Ug.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],Ug.prototype,"expression",void 0),u([d({type:["string","number"],json:{write:!0}})],Ug.prototype,"returnType",void 0),Ug=A5=u([R("esri.popup.ExpressionInfo")],Ug);const EW=Ug;var $5;let zx=$5=class extends ge{constructor(t){super(t),this.returnTopmostRaster=null,this.showNoDataRecords=null}clone(){return new $5({showNoDataRecords:this.showNoDataRecords,returnTopmostRaster:this.returnTopmostRaster})}};u([d({type:Boolean,json:{write:!0}})],zx.prototype,"returnTopmostRaster",void 0),u([d({type:Boolean,json:{write:!0}})],zx.prototype,"showNoDataRecords",void 0),zx=$5=u([R("esri.popup.LayerOptions")],zx);const Mwe=zx;var E5;let Vx=E5=class extends ge{constructor(t){super(t),this.field=null,this.order=null}clone(){return new E5({field:this.field,order:this.order})}};u([d({type:String,json:{write:!0}})],Vx.prototype,"field",void 0),u([d({type:["asc","desc"],json:{write:!0}})],Vx.prototype,"order",void 0),Vx=E5=u([R("esri.popup.support.RelatedRecordsInfoFieldOrder")],Vx);const OW=Vx;var O5;let Nx=O5=class extends ge{constructor(t){super(t),this.showRelatedRecords=null,this.orderByFields=null}clone(){return new O5({showRelatedRecords:this.showRelatedRecords,orderByFields:this.orderByFields?ie(this.orderByFields):null})}};u([d({type:Boolean,json:{write:!0}})],Nx.prototype,"showRelatedRecords",void 0),u([d({type:[OW],json:{write:!0}})],Nx.prototype,"orderByFields",void 0),Nx=O5=u([R("esri.popup.RelatedRecordsInfo")],Nx);const Pwe=Nx;var R5;let Wl=R5=class extends NM(ve){constructor(t){super(t),this.active=!1,this.className=null,this.disabled=!1,this.id=null,this.indicator=!1,this.title=null,this.type=null,this.visible=!0}clone(){return new R5({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible})}};u([d()],Wl.prototype,"active",void 0),u([d()],Wl.prototype,"className",void 0),u([d()],Wl.prototype,"disabled",void 0),u([d()],Wl.prototype,"id",void 0),u([d()],Wl.prototype,"indicator",void 0),u([d()],Wl.prototype,"title",void 0),u([d()],Wl.prototype,"type",void 0),u([d()],Wl.prototype,"visible",void 0),Wl=R5=u([R("esri.support.actions.ActionBase")],Wl);const tP=Wl;var I5;let iP=I5=class extends tP{constructor(t){super(t),this.image=null,this.type="button"}clone(){return new I5({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image})}};u([d()],iP.prototype,"image",void 0),iP=I5=u([R("esri.support.Action.ActionButton")],iP);const h1=iP;var D5;let Ux=D5=class extends tP{constructor(t){super(t),this.image=null,this.type="toggle",this.value=!1}clone(){return new D5({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image,value:this.value})}};u([d()],Ux.prototype,"image",void 0),u([d()],Ux.prototype,"value",void 0),Ux=D5=u([R("esri.support.Action.ActionToggle")],Ux);const RW=Ux;var F5;const Awe=We.ofType({key:"type",defaultKeyValue:"button",base:tP,typeMap:{button:h1,toggle:RW}}),$we={base:Fg,key:"type",typeMap:{media:Lx,custom:vwe,text:u1,attachments:Tx,fields:l1,expression:h5}},IW="esri.PopupTemplate",Ewe=le.getLogger(IW),Owe=["attachments","fields","media","text","expression"];let Br=F5=class extends ge{constructor(){super(...arguments),this.actions=null,this.content="",this.expressionInfos=null,this.fieldInfos=null,this.layerOptions=null,this.lastEditInfoEnabled=!0,this.outFields=null,this.overwriteActions=!1,this.returnGeometry=!1,this.title="",this.relatedRecordsInfo=null}castContent(t){return Array.isArray(t)?t.map(e=>Zc($we,e)):typeof t=="string"||typeof t=="function"||t instanceof HTMLElement||fg(t)?t:(Ewe.error("content error","unsupported content value",{value:t}),null)}readContent(t,e){const{popupElements:i}=e;return Array.isArray(i)&&i.length>0?this._readPopupInfoElements(e):this._readPopupInfo(e)}writeContent(t,e,i,r){typeof t!="string"?Array.isArray(t)&&(e.popupElements=t.filter(s=>Owe.indexOf(s.type)!==-1).map(s=>s&&s.toJSON(r)),e.popupElements.forEach(s=>{s.type==="attachments"?this._writeAttachmentContent(e):s.type==="media"?this._writeMediaContent(s,e):s.type==="text"&&this._writeTextContent(s,e)})):e.description=t}writeFieldInfos(t,e,i,r){const{content:s}=this,n=Array.isArray(s)?s:null;if(t){const o=n?n.filter(l=>l.type==="fields"):[],a=o.length&&o.every(l=>{var c;return(c=l.fieldInfos)==null?void 0:c.length});e.fieldInfos=t.filter(Boolean).map(l=>{const c=l.toJSON(r);return a&&(c.visible=!1),c})}if(n)for(const o of n)o.type==="fields"&&this._writeFieldsContent(o,e)}writeLayerOptions(t,e,i,r){e[i]=!t||t.showNoDataRecords===null&&t.returnTopmostRaster===null?null:t.toJSON(r)}writeTitle(t,e){e.title=t||""}clone(){const{actions:t}=this,e=t?ie(t.toArray()):[];return new F5({actions:e,content:Array.isArray(this.content)?ie(this.content):this.content,expressionInfos:Array.isArray(this.expressionInfos)?ie(this.expressionInfos):null,fieldInfos:Array.isArray(this.fieldInfos)?ie(this.fieldInfos):null,layerOptions:this.layerOptions?ie(this.layerOptions):null,lastEditInfoEnabled:this.lastEditInfoEnabled,outFields:Array.isArray(this.outFields)?ie(this.outFields):null,overwriteActions:this.overwriteActions,returnGeometry:this.returnGeometry,title:this.title,relatedRecordsInfo:this.relatedRecordsInfo?ie(this.relatedRecordsInfo):null})}async collectRequiredFields(t,e){await this._collectExpressionInfoFields(t,e,this._getContentExpressionInfos(this.content,this.expressionInfos)),Sx(t,e,[...this.outFields||[],...this._getActionsFields(this.actions),...this._getTitleFields(this.title),...this._getContentFields(this.content)])}async getRequiredFields(t){const e=new Set;return await this.collectRequiredFields(e,t),[...e].sort()}_writeFieldsContent(t,e){if(!Array.isArray(t.fieldInfos)||!t.fieldInfos.length)return;const i=ie(t.fieldInfos);Array.isArray(e.fieldInfos)?i.forEach(r=>{const s=e.fieldInfos.find(n=>n.fieldName.toLowerCase()===r.fieldName.toLowerCase());s?s.visible=!0:e.fieldInfos.push(r)}):e.fieldInfos=i}_writeAttachmentContent(t){t.showAttachments||(t.showAttachments=!0)}_writeTextContent(t,e){!e.description&&t.text&&(e.description=t.text)}_writeMediaContent(t,e){if(!Array.isArray(t.mediaInfos)||!t.mediaInfos.length)return;const i=ie(t.mediaInfos);Array.isArray(e.mediaInfos)?e.mediaInfos=[...e.mediaInfos,...i]:e.mediaInfos=i}_readPopupInfoElements({description:t,mediaInfos:e,popupElements:i}){const r={description:!1,mediaInfos:!1};return i.map(s=>s.type==="media"?(s.mediaInfos||!e||r.mediaInfos||(s.mediaInfos=e,r.mediaInfos=!0),Lx.fromJSON(s)):s.type==="text"?(s.text||!t||r.description||(s.text=t,r.description=!0),u1.fromJSON(s)):s.type==="attachments"?Tx.fromJSON(s):s.type==="fields"?l1.fromJSON(s):s.type==="expression"?h5.fromJSON(s):void 0).filter(Boolean)}_readPopupInfo({description:t,mediaInfos:e,showAttachments:i}){const r=[];return t?r.push(new u1({text:t})):r.push(new l1),Array.isArray(e)&&e.length&&r.push(Lx.fromJSON({mediaInfos:e})),i&&r.push(Tx.fromJSON({displayType:"auto"})),r.length?r:t}_getContentElementFields(t){const e=t==null?void 0:t.type;if(e==="attachments")return[...this._extractFieldNames(t.title),...this._extractFieldNames(t.description)];if(e==="custom")return t.outFields||[];if(e==="fields")return[...this._extractFieldNames(t.title),...this._extractFieldNames(t.description),...this._getFieldInfoFields(t.fieldInfos||this.fieldInfos)];if(e==="media"){const i=t.mediaInfos||[];return[...this._extractFieldNames(t.title),...this._extractFieldNames(t.description),...i.reduce((r,s)=>[...r,...this._getMediaInfoFields(s)],[])]}return e==="text"?this._extractFieldNames(t.text):[]}_getMediaInfoFields(t){const{caption:e,title:i,value:r}=t,s=r||{},{fields:n=[],normalizeField:o,tooltipField:a,sourceURL:l,linkURL:c}=s,h=[...this._extractFieldNames(i),...this._extractFieldNames(e),...this._extractFieldNames(l),...this._extractFieldNames(c),...n];return o&&h.push(o),a&&h.push(a),h}_getContentExpressionInfos(t,e){return Array.isArray(t)?t.reduce((i,r)=>[...i,...r.type==="expression"&&r.expressionInfo?[r.expressionInfo]:[]],e||[]):[]}_getContentFields(t){return typeof t=="string"?this._extractFieldNames(t):Array.isArray(t)?t.reduce((e,i)=>[...e,...this._getContentElementFields(i)],[]):[]}async _collectExpressionInfoFields(t,e,i){i&&await Promise.all(i.map(r=>Qo(t,e,r.expression)))}_getFieldInfoFields(t){return t?t.filter(e=>e.visible===void 0||!!e.visible).map(e=>e.fieldName).filter(e=>e.indexOf("relationships/")===-1&&e.indexOf("expression/")===-1):[]}_getActionsFields(t){return t?t.toArray().reduce((e,i)=>[...e,...this._getActionFields(i)],[]):[]}_getActionFields(t){const{className:e,title:i,type:r}=t,s=r==="button"||r==="toggle"?t.image:"";return[...this._extractFieldNames(i),...this._extractFieldNames(e),...this._extractFieldNames(s)]}_getTitleFields(t){return typeof t=="string"?this._extractFieldNames(t):[]}_extractFieldNames(t){if(!t||typeof t!="string")return[];const e=/{[^}]*}/g,i=t.match(e);if(!i)return[];const r=/\{(\w+):.+\}/,s=i.filter(n=>!(n.indexOf("{relationships/")===0||n.indexOf("{expression/")===0)).map(n=>n.replace(r,"{$1}"));return s?s.map(n=>n.slice(1,-1)):[]}};u([d({type:Awe})],Br.prototype,"actions",void 0),u([d()],Br.prototype,"content",void 0),u([ut("content")],Br.prototype,"castContent",null),u([Ce("content",["description","fieldInfos","popupElements","mediaInfos","showAttachments"])],Br.prototype,"readContent",null),u([Ee("content",{popupElements:{type:We.ofType(Cwe)},showAttachments:{type:Boolean},mediaInfos:{type:We.ofType($W)},description:{type:String}})],Br.prototype,"writeContent",null),u([d({type:[EW],json:{write:!0}})],Br.prototype,"expressionInfos",void 0),u([d({type:[Rx]})],Br.prototype,"fieldInfos",void 0),u([Ee("fieldInfos")],Br.prototype,"writeFieldInfos",null),u([d({type:Mwe})],Br.prototype,"layerOptions",void 0),u([Ee("layerOptions")],Br.prototype,"writeLayerOptions",null),u([d({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],Br.prototype,"lastEditInfoEnabled",void 0),u([d()],Br.prototype,"outFields",void 0),u([d()],Br.prototype,"overwriteActions",void 0),u([d()],Br.prototype,"returnGeometry",void 0),u([d({json:{type:String}})],Br.prototype,"title",void 0),u([Ee("title")],Br.prototype,"writeTitle",null),u([d({type:Pwe,json:{write:!0}})],Br.prototype,"relatedRecordsInfo",void 0),Br=F5=u([R(IW)],Br);const rP=Br,DW=new wt({esriSMS:"simple-marker",esriPMS:"picture-marker",esriSLS:"simple-line",esriSFS:"simple-fill",esriPFS:"picture-fill",esriTS:"text",esriSHD:"shield-label-symbol",PointSymbol3D:"point-3d",LineSymbol3D:"line-3d",PolygonSymbol3D:"polygon-3d",WebStyleSymbol:"web-style",MeshSymbol3D:"mesh-3d",LabelSymbol3D:"label-3d",CIMSymbolReference:"cim"});let Rwe=0,d1=class extends ge{constructor(t){super(t),this.id="sym"+Rwe++,this.type=null}set color(t){this._set("color",t)}readColor(t){return t&&t[0]!=null?[t[0],t[1],t[2],t[3]/255]:t}async collectRequiredFields(t,e){}hash(){return JSON.stringify(this.toJSON())}clone(){}};u([d({type:DW.apiValues,readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0,writer:DW.write}}})],d1.prototype,"type",void 0),u([d({type:Ae,value:new Ae([0,0,0,1]),json:{write:{allowNull:!0}}})],d1.prototype,"color",null),u([Ce("color")],d1.prototype,"readColor",null),d1=u([R("esri.symbols.Symbol")],d1);const vo=d1;var L5;let Np=L5=class extends vo{constructor(t){super(t),this.data=null,this.type="cim"}readData(t,e){return e}writeData(t,e){if(t)for(const i in t)e[i]=t[i]}async collectRequiredFields(t,e){if(this.data.type==="CIMSymbolReference"){const i=this.data.primitiveOverrides;if(i){const r=i.map(s=>{const n=s.valueExpressionInfo;return Qo(t,e,n.expression)});await Promise.all(r)}}}clone(){return new L5({data:ie(this.data)})}hash(){return aD(JSON.stringify(this.data)).toString()}};u([d({json:{write:!1}})],Np.prototype,"color",void 0),u([d({json:{write:!0}})],Np.prototype,"data",void 0),u([Ce("data",["symbol"])],Np.prototype,"readData",null),u([Ee("data",{})],Np.prototype,"writeData",null),u([Xe({CIMSymbolReference:"cim"},{readOnly:!0})],Np.prototype,"type",void 0),Np=L5=u([R("esri.symbols.CIMSymbol")],Np);const p1=Np;let f1=class extends ge{constructor(t){super(t),this.enabled=!0,this.type=null}writeEnabled(t,e,i){t||(e[i]=t)}};u([d({type:Boolean,json:{read:{source:"enable"},write:{target:"enable"}}})],f1.prototype,"enabled",void 0),u([Ee("enabled")],f1.prototype,"writeEnabled",null),u([d({type:["icon","object","line","path","fill","water","extrude","text"],readOnly:!0})],f1.prototype,"type",void 0),f1=u([R("esri.symbols.Symbol3DLayer")],f1);const ou=f1,Iwe=/^-?(\d+(\.\d+)?)\s*((px)|(pt))?$/i,Dwe="screenUtils.toPt: input not recognized!",FW=96;function zs(t){return t?t/72*FW:0}function au(t){return t?72*t/FW:0}function ti(t){if(typeof t=="string"){const e=t.match(Iwe);if(e){const i=Number(e[1]),r=e[3]&&e[3].toLowerCase(),s=t.charAt(0)==="-",n=r==="px"?au(i):i;return s?-n:n}return console.warn(Dwe),null}return t}function Zl(t=0,e=0){return{x:t,y:e}}function Ii(t=0,e=0){return[t,e]}function Fwe(t=0,e=0){return Lwe([t,e])}function ys(t=0,e=0,i=0){return Bh([t,e,i])}function Lwe(t){return t}function Bh(t){return t}function Gh(t,e){return e?(e[0]=t.x,e[1]=t.y,e.length>2&&(e[2]=0),e):[t.x,t.y]}function kwe(t,e){const i=e.transparency!=null?yx(e.transparency):1,r=e.color;return r&&Array.isArray(r)?new Ae([r[0]||0,r[1]||0,r[2]||0,i]):null}function zwe(t,e){e.color=t.toJSON().slice(0,3);const i=kF(t.a);i!==0&&(e.transparency=i)}const Up={type:Ae,json:{type:[Oi],default:null,read:{source:["color","transparency"],reader:kwe},write:{target:{color:{type:[Oi]},transparency:{type:Oi}},writer:zwe}}},lu={type:Number,cast:ti,json:{write:!0}};let jg=class extends ge{constructor(t){super(t),this.color=new Ae([0,0,0,1]),this.extensionLength=0,this.size=au(1)}clone(){}cloneProperties(){return{color:ie(this.color),size:this.size,extensionLength:this.extensionLength}}};u([d({type:["solid","sketch"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],jg.prototype,"type",void 0),u([d(Up)],jg.prototype,"color",void 0),u([d(he(E({},lu),{json:{write:{overridePolicy:t=>({enabled:!!t})}}}))],jg.prototype,"extensionLength",void 0),u([d(lu)],jg.prototype,"size",void 0),jg=u([R("esri.symbols.edges.Edges3D")],jg);const k5=jg;var z5;let sP=z5=class extends k5{constructor(t){super(t),this.type="sketch"}clone(){return new z5(this.cloneProperties())}};u([Xe({sketch:"sketch"},{readOnly:!0})],sP.prototype,"type",void 0),sP=z5=u([R("esri.symbols.edges.SketchEdges3D")],sP);const Vwe=sP;var V5;let nP=V5=class extends k5{constructor(t){super(t),this.type="solid"}clone(){return new V5(this.cloneProperties())}};u([Xe({solid:"solid"},{readOnly:!0})],nP.prototype,"type",void 0),nP=V5=u([R("esri.symbols.support.SolidEdges3D")],nP);const Nwe=nP,LW={types:{key:"type",base:k5,typeMap:{solid:Nwe,sketch:Vwe}},json:{write:!0}};var N5;let Bg=N5=class extends ge{constructor(t){super(t),this.color=null}clone(){const t={color:_(this.color)?this.color.clone():null};return new N5(t)}};u([d(Up)],Bg.prototype,"color",void 0),Bg=N5=u([R("esri.symbols.support.Symbol3DMaterial")],Bg);const m1=Bg;var U5;let jp=U5=class extends ou{constructor(t){super(t),this.type="extrude",this.size=1,this.material=null,this.castShadows=!0,this.edges=null}clone(){return new U5({edges:this.edges&&this.edges.clone(),enabled:this.enabled,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,size:this.size})}};u([Xe({Extrude:"extrude"},{readOnly:!0})],jp.prototype,"type",void 0),u([d({type:Number,json:{write:{enabled:!0,isRequired:!0}},nonNullable:!0})],jp.prototype,"size",void 0),u([d({type:m1,json:{write:!0}})],jp.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],jp.prototype,"castShadows",void 0),u([d(LW)],jp.prototype,"edges",void 0),jp=U5=u([R("esri.symbols.ExtrudeSymbol3DLayer")],jp);const j5=jp;let jx=class extends vo{constructor(t){super(t),this.type="simple-line",this.width=.75}hash(){return`${this.type}.${this.width}`}};u([Xe({esriSLS:"simple-line"},{readOnly:!0})],jx.prototype,"type",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],jx.prototype,"width",void 0),jx=u([R("esri.symbols.LineSymbol")],jx);const Uwe=jx;var B5;let cu=B5=class extends ge{constructor(t){super(t),this.placement="begin-end",this.type="line-marker",this.style="arrow"}writeStyle(t,e,i,r){(r==null?void 0:r.origin)==="web-map"?e[i]="arrow":e[i]=t}set color(t){this._set("color",t)}readColor(t){return t&&t[0]!=null?[t[0],t[1],t[2],t[3]/255]:t}writeColor(t,e,i,r){(r==null?void 0:r.origin)==="web-map"||(e[i]=t)}clone(){return new B5({color:ie(this.color),placement:this.placement,style:this.style})}hash(){var t;return`${this.placement}.${(t=this.color)==null?void 0:t.hash()}.${this.style}`}};u([d({type:["begin","end","begin-end"],json:{write:!0}})],cu.prototype,"placement",void 0),u([Xe({"line-marker":"line-marker"},{readOnly:!0}),d({json:{origins:{"web-map":{write:!1}}}})],cu.prototype,"type",void 0),u([d({type:["arrow","circle","square","diamond","cross","x"]})],cu.prototype,"style",void 0),u([Ee("style")],cu.prototype,"writeStyle",null),u([d({type:Ae,value:null,json:{write:{allowNull:!0}}})],cu.prototype,"color",null),u([Ce("color")],cu.prototype,"readColor",null),u([Ee("color")],cu.prototype,"writeColor",null),cu=B5=u([R("esri.symbols.LineSymbolMarker")],cu);const jwe=cu;var G5;const q5=new wt({esriSLSSolid:"solid",esriSLSDash:"dash",esriSLSDot:"dot",esriSLSDashDot:"dash-dot",esriSLSDashDotDot:"long-dash-dot-dot",esriSLSNull:"none",esriSLSInsideFrame:"inside-frame",esriSLSShortDash:"short-dash",esriSLSShortDot:"short-dot",esriSLSShortDashDot:"short-dash-dot",esriSLSShortDashDotDot:"short-dash-dot-dot",esriSLSLongDash:"long-dash",esriSLSLongDashDot:"long-dash-dot"});let qh=G5=class extends Uwe{constructor(...t){super(...t),this.type="simple-line",this.style="solid",this.cap="round",this.join="round",this.marker=null,this.miterLimit=2}normalizeCtorArgs(t,e,i,r,s,n){if(t&&typeof t!="string")return t;const o={};return t!=null&&(o.style=t),e!=null&&(o.color=e),i!=null&&(o.width=ti(i)),r!=null&&(o.cap=r),s!=null&&(o.join=s),n!=null&&(o.miterLimit=ti(n)),o}clone(){var t;return new G5({color:ie(this.color),style:this.style,width:this.width,cap:this.cap,join:this.join,miterLimit:this.miterLimit,marker:(t=this.marker)==null?void 0:t.clone()})}hash(){var t,e;return`${super.hash()}.${(t=this.color)==null?void 0:t.hash()}.${this.style}.${this.cap}.${this.join}.${this.miterLimit}.${(e=this.marker)==null?void 0:e.hash()}`}};u([Xe({esriSLS:"simple-line"},{readOnly:!0})],qh.prototype,"type",void 0),u([d({type:q5.apiValues,json:{read:q5.read,write:q5.write}})],qh.prototype,"style",void 0),u([d({type:["butt","round","square"],json:{write:{overridePolicy:(t,e,i)=>({enabled:t!=="round"&&(i==null||i.origin==null)})}}})],qh.prototype,"cap",void 0),u([d({type:["miter","round","bevel"],json:{write:{overridePolicy:(t,e,i)=>({enabled:t!=="round"&&(i==null||i.origin==null)})}}})],qh.prototype,"join",void 0),u([d({types:{key:"type",base:null,defaultKeyValue:"line-marker",typeMap:{"line-marker":jwe}},json:{write:!0,origins:{"web-scene":{write:!1}}}})],qh.prototype,"marker",void 0),u([d({type:Number,json:{read:!1,write:!1}})],qh.prototype,"miterLimit",void 0),qh=G5=u([R("esri.symbols.SimpleLineSymbol")],qh);const Jl=qh;let Bx=class extends vo{constructor(t){super(t),this.outline=null,this.type=null}hash(){return`${this.type}.${this.outline&&this.outline.hash()}`}};u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":Jl}},json:{default:null,write:!0}})],Bx.prototype,"outline",void 0),u([d({type:["simple-fill","picture-fill"],readOnly:!0})],Bx.prototype,"type",void 0),Bx=u([R("esri.symbols.FillSymbol")],Bx);const kW=Bx;let oP=class extends ge{constructor(t){super(t)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],oP.prototype,"type",void 0),oP=u([R("esri.symbols.patterns.LinePattern3D")],oP);const zW=oP,Bwe=["dash","dash-dot","dot","long-dash","long-dash-dot","long-dash-dot-dot","none","short-dash","short-dash-dot","short-dash-dot-dot","short-dot","solid"];var H5;const Gwe=Ds()({dash:"dash","dash-dot":"dash-dot","dash-dot-dot":"long-dash-dot-dot",dot:"dot","long-dash":"long-dash","long-dash-dot":"long-dash-dot",null:"none","short-dash":"short-dash","short-dash-dot":"short-dash-dot","short-dash-dot-dot":"short-dash-dot-dot","short-dot":"short-dot",solid:"solid"});let Gx=H5=class extends zW{constructor(t){super(t),this.type="style",this.style="solid"}clone(){const t={style:this.style};return new H5(t)}};u([d({type:["style"]})],Gx.prototype,"type",void 0),u([Xe(Gwe),d({type:Bwe})],Gx.prototype,"style",void 0),Gx=H5=u([R("esri.symbols.patterns.LineStylePattern3D")],Gx);const W5=Gx;let aP=class extends ge{constructor(t){super(t)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],aP.prototype,"type",void 0),aP=u([R("esri.symbols.patterns.Pattern3D")],aP);const VW=aP,qwe=["backward-diagonal","cross","diagonal-cross","forward-diagonal","horizontal","none","solid","vertical"];var Z5;let qx=Z5=class extends VW{constructor(t){super(t),this.type="style",this.style="solid"}clone(){const t={style:this.style};return new Z5(t)}};u([d({type:["style"]})],qx.prototype,"type",void 0),u([d({type:qwe,json:{read:!0,write:!0}})],qx.prototype,"style",void 0),qx=Z5=u([R("esri.symbols.patterns.StylePattern3D")],qx);const NW=qx,Hwe={types:{key:"type",base:VW,typeMap:{style:NW}},json:{write:!0}},UW={types:{key:"type",base:zW,typeMap:{style:W5}},json:{write:!0}},Hx=new Ae("white");new Ae("black");const Wwe=new Ae([255,255,255,0]);function Zwe(t){return t.r===0&&t.g===0&&t.b===0}var J5;let Wx=J5=class extends Bg{constructor(t){super(t),this.colorMixMode=null}clone(){const t={color:_(this.color)?this.color.clone():null,colorMixMode:this.colorMixMode};return new J5(t)}};u([Xe({multiply:"multiply",replace:"replace",tint:"tint"})],Wx.prototype,"colorMixMode",void 0),Wx=J5=u([R("esri.symbols.support.Symbol3DFillMaterial")],Wx);function Zx(t){return t}function pt(t=exe){return Zx([t[0],t[1],t[2],t[3]])}function Ent(t){return Zx([t[0],t[1],t[2],t[3]])}function Bp(t,e){return t!==e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]),t}function Jwe(t,e,i,r,s=pt()){return s[0]=t,s[1]=e,s[2]=i,s[3]=r,s}function jW(t,e=pt()){return e[0]=t.xmin,e[1]=t.ymin,e[2]=t.xmax,e[3]=t.ymax,e}function lP(t,e){return new ht({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e})}function BW(t,e){e[0]<t[0]&&(t[0]=e[0]),e[0]>t[2]&&(t[2]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[1]>t[3]&&(t[3]=e[1])}function Gp(t,e,i){if(A(e))Bp(i,t);else if("length"in e)eL(e)?(i[0]=Math.min(t[0],e[0]),i[1]=Math.min(t[1],e[1]),i[2]=Math.max(t[2],e[2]),i[3]=Math.max(t[3],e[3])):e.length!==2&&e.length!==3||(i[0]=Math.min(t[0],e[0]),i[1]=Math.min(t[1],e[1]),i[2]=Math.max(t[2],e[0]),i[3]=Math.max(t[3],e[1]));else switch(e.type){case"extent":i[0]=Math.min(t[0],e.xmin),i[1]=Math.min(t[1],e.ymin),i[2]=Math.max(t[2],e.xmax),i[3]=Math.max(t[3],e.ymax);break;case"point":i[0]=Math.min(t[0],e.x),i[1]=Math.min(t[1],e.y),i[2]=Math.max(t[2],e.x),i[3]=Math.max(t[3],e.y)}}function Q5(t,e,i=t){const r=e.length;let s=t[0],n=t[1],o=t[2],a=t[3];for(let l=0;l<r;l++){const c=e[l];s=Math.min(s,c[0]),n=Math.min(n,c[1]),o=Math.max(o,c[0]),a=Math.max(a,c[1])}return i[0]=s,i[1]=n,i[2]=o,i[3]=a,i}function Y5(t){for(let e=0;e<4;e++)if(!isFinite(t[e]))return!1;return!0}function Hh(t){return A(t)||t[0]>=t[2]?0:t[2]-t[0]}function Gg(t){return t[1]>=t[3]?0:t[3]-t[1]}function Ont(t){return Hh(t)*Gg(t)}function X5(t,e=[0,0]){return e[0]=(t[0]+t[2])/2,e[1]=(t[1]+t[3])/2,e}function K5(t,e){return GW(t,e[0],e[1])}function Qwe(t,e){const i=e[3],r=.5*(t[0]+t[2]),s=Math.abs(e[0]-r),n=.5*(t[2]-t[0]);if(s>i+n)return!1;const o=.5*(t[1]+t[3]),a=.5*(t[3]-t[1]),l=Math.abs(e[1]-o);if(l>i+a)return!1;if(s<n||l<a)return!0;const c=s-n,h=l-a;return c*c+h*h<=i*i}function Rnt(t,e){return GW(t,e.x,e.y)}function GW(t,e,i){return e>=t[0]&&i>=t[1]&&e<=t[2]&&i<=t[3]}function Ywe(t,e,i){return e[0]>=t[0]-i&&e[1]>=t[1]-i&&e[0]<=t[2]+i&&e[1]<=t[3]+i}function cP(t,e){return Math.max(e[0],t[0])<=Math.min(e[2],t[2])&&Math.max(e[1],t[1])<=Math.min(e[3],t[3])}function qW(t,e){return e[0]>=t[0]&&e[2]<=t[2]&&e[1]>=t[1]&&e[3]<=t[3]}function uP(t,e,i){if(A(e))return Bp(i,t);const r=e[0],s=e[1],n=e[2],o=e[3];return i[0]=Re(t[0],r,n),i[1]=Re(t[1],s,o),i[2]=Re(t[2],r,n),i[3]=Re(t[3],s,o),i}function Xwe(t,e){const i=(t[0]+t[2])/2,r=(t[1]+t[3])/2,s=Math.max(Math.abs(e[0]-i)-Hh(t)/2,0),n=Math.max(Math.abs(e[1]-r)-Gg(t)/2,0);return Math.sqrt(s*s+n*n)}function hP(t,e,i,r=t){return r[0]=t[0]+e,r[1]=t[1]+i,r[2]=t[2]+e,r[3]=t[3]+i,r}function ja(t){return t?Bp(t,HW):pt(HW)}function eL(t){return t!=null&&t.length===4}function Kwe(t){return!(Hh(t)!==0&&isFinite(t[0])||Gg(t)!==0&&isFinite(t[1]))}function qg(t,e){return eL(t)&&eL(e)?t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]:t===e}const Int=Zx([-1/0,-1/0,1/0,1/0]),HW=Zx([1/0,1/0,-1/0,-1/0]),exe=Zx([0,0,0,0]);function dP(t){return t}function lr(t=XW){return dP([t[0],t[1],t[2],t[3],t[4],t[5]])}function Hg(t,e,i,r,s,n,o=lr()){return o[0]=t,o[1]=e,o[2]=i,o[3]=r,o[4]=s,o[5]=n,o}function g1(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2]),t[3]=Math.max(t[3],e[3]),t[4]=Math.max(t[4],e[4]),t[5]=Math.max(t[5],e[5])}function txe(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[3]=Math.max(t[3],e[2]),t[4]=Math.max(t[4],e[3])}function uu(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2]),t[3]=Math.max(t[3],e[0]),t[4]=Math.max(t[4],e[1]),t[5]=Math.max(t[5],e[2])}function Ql(t,e,i=0,r=e.length/3){let s=t[0],n=t[1],o=t[2],a=t[3],l=t[4],c=t[5];for(let h=0;h<r;h++)s=Math.min(s,e[i+3*h]),n=Math.min(n,e[i+3*h+1]),o=Math.min(o,e[i+3*h+2]),a=Math.max(a,e[i+3*h]),l=Math.max(l,e[i+3*h+1]),c=Math.max(c,e[i+3*h+2]);t[0]=s,t[1]=n,t[2]=o,t[3]=a,t[4]=l,t[5]=c}function ixe(t,e,i,r){t[0]=Math.min(t[0],t[0]+e),t[3]=Math.max(t[3],t[3]+e),t[1]=Math.min(t[1],t[1]+i),t[4]=Math.max(t[4],t[4]+i),t[2]=Math.min(t[2],t[2]+r),t[5]=Math.max(t[5],t[5]+r)}function tL(t,e,i){const r=e.length;let s=t[0],n=t[1],o=t[2],a=t[3],l=t[4],c=t[5];if(i)for(let h=0;h<r;h++){const p=e[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),o=Math.min(o,p[2]),a=Math.max(a,p[0]),l=Math.max(l,p[1]),c=Math.max(c,p[2])}else for(let h=0;h<r;h++){const p=e[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),a=Math.max(a,p[0]),l=Math.max(l,p[1])}t[0]=s,t[1]=n,t[2]=o,t[3]=a,t[4]=l,t[5]=c}function rxe(t){for(let e=0;e<6;e++)if(!isFinite(t[e]))return!1;return!0}function y1(t){return t[0]>=t[3]?0:t[3]-t[0]}function v1(t){return t[1]>=t[4]?0:t[4]-t[1]}function Wg(t){return t[2]>=t[5]?0:t[5]-t[2]}function sxe(t){const e=y1(t),i=Wg(t),r=v1(t);return Math.sqrt(e*e+i*i+r*r)}function Yl(t,e=[0,0,0]){return e[0]=t[0]+y1(t)/2,e[1]=t[1]+v1(t)/2,e[2]=t[2]+Wg(t)/2,e}function pP(t,e=[0,0,0]){return e[0]=y1(t),e[1]=v1(t),e[2]=Wg(t),e}function nxe(t){return Math.max(y1(t),Wg(t),v1(t))}function iL(t,e){return e[0]>=t[0]&&e[1]>=t[1]&&e[2]>=t[2]&&e[0]<=t[3]&&e[1]<=t[4]&&e[2]<=t[5]}function Dnt(t,e){return e[0]>=t[0]&&e[1]>=t[1]&&e[2]>=t[2]&&e[3]<=t[3]&&e[4]<=t[4]&&e[5]<=t[5]}function oxe(t,e){return Math.max(e[0],t[0])<=Math.min(e[3],t[3])&&Math.max(e[1],t[1])<=Math.min(e[4],t[4])&&Math.max(e[2],t[2])<=Math.min(e[5],t[5])}function Xl(t,e){return!!A(e)||oxe(t,e)}function WW(t,e,i,r,s=t){return s[0]=t[0]+e,s[1]=t[1]+i,s[2]=t[2]+r,s[3]=t[3]+e,s[4]=t[4]+i,s[5]=t[5]+r,s}function ZW(t,e,i=t){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i!==t&&(i[3]=t[3],i[4]=t[4],i[5]=t[5]),i}function JW(t,e,i=t){return i[3]=e[0],i[4]=e[1],i[5]=e[2],i!==t&&(i[0]=t[0],i[1]=t[1],i[2]=t[2]),t}function fP(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function ii(t){return t?fP(t,YW):lr(YW)}function rL(t,e){return e||(e=pt()),e[0]=t[0],e[1]=t[1],e[2]=t[3],e[3]=t[4],e}function Fnt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=Number.NEGATIVE_INFINITY,t[3]=e[2],t[4]=e[3],t[5]=Number.POSITIVE_INFINITY,t}function QW(t){return t.length===6}function mP(t){return y1(t)===0&&v1(t)===0&&Wg(t)===0}function Lnt(t,e,i){if(A(t)||A(e))return t===e;if(!QW(t)||!QW(e))return!1;if(i){for(let r=0;r<t.length;r++)if(!i(t[r],e[r]))return!1}else for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}function axe(t,e,i,r,s,n){return Hg(t,e,i,r,s,n,lxe)}const knt=dP([-1/0,-1/0,-1/0,1/0,1/0,1/0]),YW=dP([1/0,1/0,1/0,-1/0,-1/0,-1/0]),XW=dP([0,0,0,0,0,0]),lxe=lr();function sL(t,{isPrimitive:e,width:i,depth:r,height:s}){const n=e?10:1;if(i==null&&s==null&&r==null)return[n*t[0],n*t[1],n*t[2]];const o=De(i,r,s);let a;for(let l=0;l<3;l++){const c=o[l];if(c!=null){a=c/t[l];break}}for(let l=0;l<3;l++)o[l]==null&&(o[l]=t[l]*a);return o}const cxe=Hg(-.5,-.5,-.5,.5,.5,.5),uxe=Hg(-.5,-.5,0,.5,.5,1),hxe=Hg(-.5,-.5,0,.5,.5,.5);function dxe(t){switch(t){case"sphere":case"cube":case"diamond":return cxe;case"cylinder":case"cone":case"inverted-cone":return uxe;case"tetrahedron":return hxe;default:return}}const nL=["butt","square","round"],pxe=[...nL,"none"],KW=["miter","bevel","round"];var oL;let Zg=oL=class extends ge{constructor(t){super(t),this.color=new Ae([0,0,0,1]),this.size=au(1),this.pattern=null,this.patternCap="butt"}clone(){const t={color:_(this.color)?this.color.clone():null,size:this.size,pattern:_(this.pattern)?this.pattern.clone():null,patternCap:this.patternCap};return new oL(t)}};u([d(Up)],Zg.prototype,"color",void 0),u([d(lu)],Zg.prototype,"size",void 0),u([d(UW)],Zg.prototype,"pattern",void 0),u([d({type:nL,json:{default:"butt",write:{overridePolicy(){return{enabled:_(this.pattern)}}}}})],Zg.prototype,"patternCap",void 0),Zg=oL=u([R("esri.symbols.support.Symbol3DOutline")],Zg);const fxe=Zg;var gP;let Wh=gP=class extends ou{constructor(t){super(t),this.type="fill",this.material=null,this.pattern=null,this.castShadows=!0,this.outline=null,this.edges=null}clone(){const t={edges:_(this.edges)?this.edges.clone():null,enabled:this.enabled,material:_(this.material)?this.material.clone():null,pattern:_(this.pattern)?this.pattern.clone():null,castShadows:this.castShadows,outline:_(this.outline)?this.outline.clone():null};return new gP(t)}static fromSimpleFillSymbol(t){var e,i,r,s,n,o;const a=t.outline&&t.outline.style&&t.outline.style!=="inside-frame"&&t.outline.style!=="solid"?new W5({style:t.outline.style}):null,l={size:(e=(i=t.outline)==null?void 0:i.width)!=null?e:0,color:((r=(s=t.outline)==null?void 0:s.color)!=null?r:Hx).clone(),pattern:a};return a&&(n=t.outline)!=null&&n.cap&&(l.patternCap=t.outline.cap),new gP({material:new Wx({color:((o=t.color)!=null?o:Wwe).clone()}),pattern:t.style&&t.style!=="solid"?new NW({style:t.style}):null,outline:l})}};u([Xe({Fill:"fill"},{readOnly:!0})],Wh.prototype,"type",void 0),u([d({type:Wx,json:{write:!0}})],Wh.prototype,"material",void 0),u([d(Hwe)],Wh.prototype,"pattern",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],Wh.prototype,"castShadows",void 0),u([d({type:fxe,json:{write:!0}})],Wh.prototype,"outline",void 0),u([d(LW)],Wh.prototype,"edges",void 0),Wh=gP=u([R("esri.symbols.FillSymbol3DLayer")],Wh);const Jx=Wh;var aL;let Zh=aL=class extends ge{constructor(t){super(t),this.decoration="none",this.family="sans-serif",this.size=9,this.style="normal",this.weight="normal"}castSize(t){return ti(t)}clone(){return new aL({decoration:this.decoration,family:this.family,size:this.size,style:this.style,weight:this.weight})}hash(){return`${this.decoration}.${this.family}.${this.size}.${this.style}.${this.weight}`}};u([d({type:["underline","line-through","none"],json:{default:"none",write:!0}})],Zh.prototype,"decoration",void 0),u([d({type:String,json:{write:!0}})],Zh.prototype,"family",void 0),u([d({type:Number,json:{write:{overridePolicy:(t,e,i)=>({enabled:!i||!i.textSymbol3D})}}})],Zh.prototype,"size",void 0),u([ut("size")],Zh.prototype,"castSize",null),u([d({type:["normal","italic","oblique"],json:{default:"normal",write:!0}})],Zh.prototype,"style",void 0),u([d({type:["normal","bold","bolder","lighter"],json:{default:"normal",write:!0}})],Zh.prototype,"weight",void 0),Zh=aL=u([R("esri.symbols.Font")],Zh);const yP=Zh;function _1(t,e){const i=e&&e.url&&e.url.path;if(t&&i&&(t=Ra(t,i,{preserveProtocolRelative:!0}),e.portalItem&&e.readResourcePaths)){const r=GD(t,e.portalItem.itemUrl);gxe.test(r)&&e.readResourcePaths.push(e.portalItem.resourceFromPath(r).path)}return cL(t,e&&e.portal)}function Jg(t,e,i=0){if(!t)return t;!qo(t)&&e&&e.blockedRelativeUrls&&e.blockedRelativeUrls.push(t);let r=Ra(t);if(e){const s=e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.rootPath||e.url&&e.url.path;if(s){const n=cL(s,e.portal);r=GD(cL(r,e.portal),n,n),r!==t&&e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.push(r)}}return r=vxe(r,e&&e.portal),qo(r)&&(r=Ia(r)),e!=null&&e.resources&&e!=null&&e.portalItem&&!qo(r)&&!Jc(r)&&i===0&&e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(r)}),r}function lL(t,e,i){return _1(t,i)}function qp(t,e,i,r){const s=Jg(t,r);s!==void 0&&(e[i]=s)}const mxe=/\/items\/([^\/]+)\/resources\//,gxe=/^\.\/resources\//;function yxe(t){const e=_(t)?t.match(mxe):null;return _(e)?e[1]:null}function vxe(t,e){return e&&!e.isPortal&&e.urlKey&&e.customBaseUrl?ZD(t,`${e.urlKey}.${e.customBaseUrl}`,e.portalHostname):t}function cL(t,e){if(!e||e.isPortal||!e.urlKey||!e.customBaseUrl)return t;const i=`${e.urlKey}.${e.customBaseUrl}`;return dM(fs,`${fs.scheme}://${i}`)?ZD(t,e.portalHostname,i):ZD(t,i,e.portalHostname)}const znt=Object.freeze({__proto__:null,fromJSON:_1,toJSON:Jg,read:lL,write:qp,itemIdFromResourceUrl:yxe});var uL;const _xe=Ds()({circle:"circle",square:"square",cross:"cross",x:"x",kite:"kite",triangle:"triangle"});let Qg=uL=class extends ge{constructor(t){super(t)}readHref(t,e,i){return t?_1(t,i):e.dataURI}writeHref(t,e,i,r){t&&(Jc(t)?e.dataURI=t:(e.href=Jg(t,r),qo(e.href)&&(e.href=Ia(e.href))))}clone(){return new uL({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{write:!0,read:{source:["href","dataURI"]}}})],Qg.prototype,"href",void 0),u([Ce("href")],Qg.prototype,"readHref",null),u([Ee("href",{href:{type:String},dataURI:{type:String}})],Qg.prototype,"writeHref",null),u([Xe(_xe)],Qg.prototype,"primitive",void 0),Qg=uL=u([R("esri.symbols.support.IconSymbol3DLayerResource")],Qg);const bxe="circle",wxe=Qg;var hL;let Yg=hL=class extends ve{constructor(){super(...arguments),this.x=0,this.y=0}clone(){return new hL({x:this.x,y:this.y})}};u([d({type:Number})],Yg.prototype,"x",void 0),u([d({type:Number})],Yg.prototype,"y",void 0),Yg=hL=u([R("esri.symbols.support.Symbol3DAnchorPosition2D")],Yg);const Vnt=Yg;var dL;let Qx=dL=class extends ge{constructor(t){super(t),this.color=new Ae([0,0,0,1]),this.size=au(1)}clone(){const t={color:_(this.color)?this.color.clone():null,size:this.size};return new dL(t)}};u([d(Up)],Qx.prototype,"color",void 0),u([d(lu)],Qx.prototype,"size",void 0),Qx=dL=u([R("esri.symbols.support.Symbol3DIconOutline")],Qx);const xxe=Qx;var b1;const Sxe=le.getLogger("esri.symbols.IconSymbol3DLayer");let hu=b1=class extends ou{constructor(t){super(t),this.material=null,this.resource=null,this.type="icon",this.size=12,this.anchor="center",this.anchorPosition=void 0,this.outline=void 0}clone(){return new b1({anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),enabled:this.enabled,material:_(this.material)?this.material.clone():null,outline:_(this.outline)?this.outline.clone():null,resource:this.resource&&this.resource.clone(),size:this.size})}static fromSimpleMarkerSymbol(t){const e=t.color||Hx,i=eZ(t),r=t.outline&&t.outline.width>0?{size:t.outline.width,color:(t.outline.color||Hx).clone()}:null;return new b1({size:t.size,resource:{primitive:Cxe(t.style)},material:{color:e},outline:r,anchor:i?"relative":void 0,anchorPosition:i})}static fromPictureMarkerSymbol(t){const e=!t.color||Zwe(t.color)?Hx:t.color,i=eZ(t);return new b1({size:t.width<=t.height?t.height:t.width,resource:{href:t.url},material:{color:e.clone()},anchor:i?"relative":void 0,anchorPosition:i})}static fromCIMSymbol(t){return new b1({resource:{href:vq({mediaType:"application/json",data:JSON.stringify(t.data)})}})}};function eZ(t){const e="width"in t?t.width:t.size,i="height"in t?t.height:t.size,r=tZ(t.xoffset),s=tZ(t.yoffset);return(r||s)&&e&&i?{x:-r/e,y:s/i}:null}function tZ(t){return isFinite(t)?t:0}u([d({type:m1,json:{write:!0}})],hu.prototype,"material",void 0),u([d({type:wxe,json:{write:!0}})],hu.prototype,"resource",void 0),u([Xe({Icon:"icon"},{readOnly:!0})],hu.prototype,"type",void 0),u([d(lu)],hu.prototype,"size",void 0),u([Xe({center:"center",left:"left",right:"right",top:"top",bottom:"bottom",topLeft:"top-left",topRight:"top-right",bottomLeft:"bottom-left",bottomRight:"bottom-right",relative:"relative"}),d({json:{default:"center"}})],hu.prototype,"anchor",void 0),u([d({type:Yg,json:{type:[Number],read:{reader:t=>new Yg({x:t[0],y:t[1]})},write:{writer:(t,e)=>{e.anchorPosition=[t.x,t.y]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],hu.prototype,"anchorPosition",void 0),u([d({type:xxe,json:{write:!0}})],hu.prototype,"outline",void 0),hu=b1=u([R("esri.symbols.IconSymbol3DLayer")],hu);const Txe={circle:"circle",cross:"cross",diamond:"kite",square:"square",x:"x",triangle:"triangle",path:null};function Cxe(t){return Txe[t]||(Sxe.warn(`${t} cannot be mapped to Icon symbol. Fallback to "circle"`),"circle")}const du=hu;var vP;let Jh=vP=class extends ou{constructor(t){super(t),this.material=null,this.type="line",this.join="miter",this.cap="butt",this.size=au(1),this.pattern=null}clone(){const t={enabled:this.enabled,material:_(this.material)?this.material.clone():null,size:this.size,join:this.join,cap:this.cap,pattern:_(this.pattern)?this.pattern.clone():null};return new vP(t)}static fromSimpleLineSymbol(t){const e={enabled:!0,size:t.width||1,cap:t.cap||"butt",join:t.join||"miter",pattern:t.style&&t.style!=="inside-frame"?new W5({style:t.style}):null,material:new Bg({color:(t.color||Hx).clone()})};return new vP(e)}};u([d({type:Bg,json:{write:!0}})],Jh.prototype,"material",void 0),u([Xe({Line:"line"},{readOnly:!0})],Jh.prototype,"type",void 0),u([d({type:KW,json:{write:!0,default:"miter"}})],Jh.prototype,"join",void 0),u([d({type:nL,json:{write:!0,default:"butt"}})],Jh.prototype,"cap",void 0),u([d(lu)],Jh.prototype,"size",void 0),u([d(UW)],Jh.prototype,"pattern",void 0),Jh=vP=u([R("esri.symbols.LineSymbol3DLayer")],Jh);const w1=Jh;var pL;const Mxe=Ds()({sphere:"sphere",cylinder:"cylinder",cube:"cube",cone:"cone",diamond:"diamond",tetrahedron:"tetrahedron",invertedCone:"inverted-cone"});let Yx=pL=class extends ge{clone(){return new pL({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{read:lL,write:qp}})],Yx.prototype,"href",void 0),u([Xe(Mxe)],Yx.prototype,"primitive",void 0),Yx=pL=u([R("esri.symbols.support.ObjectSymbol3DLayerResource")],Yx);const iZ="sphere",Pxe=Yx;var fL;let Xg=fL=class extends ve{constructor(){super(...arguments),this.x=0,this.y=0,this.z=0}clone(){return new fL({x:this.x,y:this.y,z:this.z})}};u([d({type:Number})],Xg.prototype,"x",void 0),u([d({type:Number})],Xg.prototype,"y",void 0),u([d({type:Number})],Xg.prototype,"z",void 0),Xg=fL=u([R("esri.symbols.support.Symbol3DAnchorPosition3D")],Xg);var mL;let dn=mL=class extends ou{constructor(t){super(t),this.material=null,this.castShadows=!0,this.resource=null,this.type="object",this.width=void 0,this.height=void 0,this.depth=void 0,this.anchor=void 0,this.anchorPosition=void 0,this.heading=void 0,this.tilt=void 0,this.roll=void 0}clone(){return new mL({heading:this.heading,tilt:this.tilt,roll:this.roll,anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),depth:this.depth,enabled:this.enabled,height:this.height,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,resource:this.resource&&this.resource.clone(),width:this.width})}get isPrimitive(){return!this.resource||typeof this.resource.href!="string"}};u([d({type:m1,json:{write:!0}})],dn.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],dn.prototype,"castShadows",void 0),u([d({type:Pxe,json:{write:!0}})],dn.prototype,"resource",void 0),u([Xe({Object:"object"},{readOnly:!0})],dn.prototype,"type",void 0),u([d({type:Number,json:{write:!0}})],dn.prototype,"width",void 0),u([d({type:Number,json:{write:!0}})],dn.prototype,"height",void 0),u([d({type:Number,json:{write:!0}})],dn.prototype,"depth",void 0),u([Xe({center:"center",top:"top",bottom:"bottom",origin:"origin",relative:"relative"}),d({json:{default:"origin"}})],dn.prototype,"anchor",void 0),u([d({type:Xg,json:{type:[Number],read:{reader:t=>new Xg({x:t[0],y:t[1],z:t[2]})},write:{writer:(t,e)=>{e.anchorPosition=[t.x,t.y,t.z]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],dn.prototype,"anchorPosition",void 0),u([d({type:Number,json:{write:!0}})],dn.prototype,"heading",void 0),u([d({type:Number,json:{write:!0}})],dn.prototype,"tilt",void 0),u([d({type:Number,json:{write:!0}})],dn.prototype,"roll",void 0),u([d({readOnly:!0})],dn.prototype,"isPrimitive",null),dn=mL=u([R("esri.symbols.ObjectSymbol3DLayer")],dn);const Xx=dn;var gL;let zn=gL=class extends ou{constructor(t){super(t),this.material=null,this.castShadows=!0,this.type="path",this.profile="circle",this.join="miter",this.cap="butt",this.width=void 0,this.height=void 0,this.anchor="center",this.profileRotation="all"}readWidth(t,e){return t!=null?t:e.height==null&&e.size!=null?e.size:void 0}readHeight(t,e){return t!=null?t:e.width==null&&e.size!=null?e.size:void 0}clone(){return new gL({enabled:this.enabled,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,profile:this.profile,join:this.join,cap:this.cap,width:this.width,height:this.height,profileRotation:this.profileRotation,anchor:this.anchor})}};u([d({type:m1,json:{write:!0}})],zn.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],zn.prototype,"castShadows",void 0),u([Xe({Path:"path"},{readOnly:!0})],zn.prototype,"type",void 0),u([d({type:["circle","quad"],json:{write:!0,default:"circle"}})],zn.prototype,"profile",void 0),u([d({type:KW,json:{write:!0,default:"miter"}})],zn.prototype,"join",void 0),u([d({type:pxe,json:{write:!0,default:"butt"}})],zn.prototype,"cap",void 0),u([d({type:Number,json:{write:{enabled:!0,target:{width:{type:Number},size:{type:Number}}}}})],zn.prototype,"width",void 0),u([Ce("width",["width","size","height"])],zn.prototype,"readWidth",null),u([d({type:Number,json:{write:!0}})],zn.prototype,"height",void 0),u([Ce("height",["height","size","width"])],zn.prototype,"readHeight",null),u([d({type:["center","bottom","top"],json:{write:!0,default:"center"}})],zn.prototype,"anchor",void 0),u([d({type:["heading","all"],json:{write:!0,default:"all"}})],zn.prototype,"profileRotation",void 0),zn=gL=u([R("esri.symbols.PathSymbol3DLayer")],zn);const yL=zn;var vL;let Kx=vL=class extends ge{constructor(){super(...arguments),this.color=new Ae([0,0,0,1]),this.size=0}clone(){return new vL({color:ie(this.color),size:this.size})}};u([d(Up)],Kx.prototype,"color",void 0),u([d(lu)],Kx.prototype,"size",void 0),Kx=vL=u([R("esri.symbols.support.Symbol3DHalo")],Kx);const Axe=Kx;var _P;let pu=_P=class extends ou{constructor(t){super(t),this._userSize=void 0,this.halo=null,this.material=null,this.text=void 0,this.type="text"}get font(){return this._get("font")||null}set font(t){t&&this._userSize&&(t.size=this._userSize),this._set("font",t)}writeFont(t,e,i,r){const s=he(E({},r),{textSymbol3D:!0});e.font=t.write({},s),delete e.font.size}get size(){return this._userSize!=null?this._userSize:this.font&&this.font.size!=null?this.font.size:9}set size(t){this._userSize=t,this.font&&(this.font.size=this._userSize),this.notifyChange("size")}clone(){return new _P({enabled:this.enabled,font:this.font&&ie(this.font),halo:this.halo&&ie(this.halo),material:_(this.material)?this.material.clone():null,size:this.size,text:this.text})}static fromTextSymbol(t){const e=$xe(t.haloColor,t.haloSize),i=t.font?t.font.clone():new yP;return new _P({size:i.size,font:i,halo:e,material:t.color?{color:t.color.clone()}:null,text:t.text})}};function $xe(t,e){return t&&e>0?{color:ie(t),size:e}:null}u([d({type:yP,json:{write:!0}})],pu.prototype,"font",null),u([Ee("font")],pu.prototype,"writeFont",null),u([d({type:Axe,json:{write:!0}})],pu.prototype,"halo",void 0),u([d({type:m1,json:{write:!0}})],pu.prototype,"material",void 0),u([d(lu),d()],pu.prototype,"size",null),u([d({type:String,json:{write:!0}})],pu.prototype,"text",void 0),u([Xe({Text:"text"},{readOnly:!0})],pu.prototype,"type",void 0),pu=_P=u([R("esri.symbols.TextSymbol3DLayer")],pu);const Kg=pu;var _L;let Hp=_L=class extends ou{constructor(t){super(t),this.color=bL.clone(),this.type="water",this.waterbodySize="medium",this.waveDirection=null,this.waveStrength="moderate"}clone(){return new _L({color:ie(this.color),waterbodySize:this.waterbodySize,waveDirection:this.waveDirection,waveStrength:this.waveStrength})}};u([d({type:Ae,nonNullable:!0,json:{type:[Oi],write:(t,e,i)=>e[i]=t.toArray(1),default:()=>bL.clone(),defaultEquals:t=>t.toCss(!0)===bL.toCss(!0)}})],Hp.prototype,"color",void 0),u([Xe({Water:"water"},{readOnly:!0})],Hp.prototype,"type",void 0),u([d({type:["small","medium","large"],json:{write:!0,default:"medium"}})],Hp.prototype,"waterbodySize",void 0),u([d({type:Number,json:{write:!0,default:null}})],Hp.prototype,"waveDirection",void 0),u([d({type:["calm","rippled","slight","moderate"],json:{write:!0,default:"moderate"}})],Hp.prototype,"waveStrength",void 0),Hp=_L=u([R("esri.symbols.WaterSymbol3DLayer")],Hp);const bL=new Ae([0,119,190]),wL=Hp;var xL;let ey=xL=class extends ve{constructor(){super(...arguments),this.portal=null}clone(){return new xL({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}};u([d({type:String})],ey.prototype,"name",void 0),u([d({type:String})],ey.prototype,"styleUrl",void 0),u([d({type:String})],ey.prototype,"styleName",void 0),u([d({type:po})],ey.prototype,"portal",void 0),ey=xL=u([R("esri.symbols.support.StyleOrigin")],ey);const SL=ey;var TL;let bP=TL=class extends ve{clone(){return new TL({url:this.url})}};u([d({type:String})],bP.prototype,"url",void 0),bP=TL=u([R("esri.symbols.support.Thumbnail")],bP);const rZ=bP,sZ={icon:du,object:Xx,line:w1,path:yL,fill:Jx,extrude:j5,text:Kg,water:wL},Exe=We.ofType({base:ou,key:"type",typeMap:sZ,errorContext:"symbol-layer"}),Oxe=le.getLogger("esri.symbols.Symbol3D");let fu=class extends vo{constructor(t){super(t),this.styleOrigin=null,this.thumbnail=null,this.type=null;const e=this.__accessor__&&this.__accessor__.metadatas&&this.__accessor__.metadatas.symbolLayers,i=e&&e.type||We;this._set("symbolLayers",new i)}get color(){return null}set color(t){Oxe.error("Symbol3D does not support colors on the symbol level. Colors may be set on individual symbol layer materials instead.")}set symbolLayers(t){vg(t,this._get("symbolLayers"))}readStyleOrigin(t,e,i){if(t.styleUrl&&t.name){const r=_1(t.styleUrl,i);return new SL({styleUrl:r,name:t.name})}if(t.styleName&&t.name)return new SL({portal:i&&i.portal||po.getDefault(),styleName:t.styleName,name:t.name});i&&i.messages&&i.messages.push(new Go("symbol3d:incomplete-style-origin","Style origin requires either a 'styleUrl' or 'styleName' and a 'name' property",{context:i,definition:t}))}writeStyleOrigin(t,e,i,r){if(t.styleUrl&&t.name){let s=Jg(t.styleUrl,r);qo(s)&&(s=Ia(s)),e.styleOrigin={styleUrl:s,name:t.name}}else t.styleName&&t.name&&(t.portal&&r&&r.portal&&!fq(t.portal.restUrl,r.portal.restUrl)?r&&r.messages&&r.messages.push(new Go("symbol:cross-portal","The symbol style origin cannot be persisted because it refers to an item on a different portal than the one being saved to.",{symbol:this})):e.styleOrigin={styleName:t.styleName,name:t.name})}normalizeCtorArgs(t){return t instanceof ou||t&&sZ[t.type]?{symbolLayers:[t]}:Array.isArray(t)?{symbolLayers:t}:t}};u([d({json:{read:!1,write:!1}})],fu.prototype,"color",null),u([d({type:Exe,nonNullable:!0,json:{write:!0}}),ut(KG)],fu.prototype,"symbolLayers",null),u([d({type:SL})],fu.prototype,"styleOrigin",void 0),u([Ce("styleOrigin")],fu.prototype,"readStyleOrigin",null),u([Ee("styleOrigin",{"styleOrigin.styleUrl":{type:String},"styleOrigin.styleName":{type:String},"styleOrigin.name":{type:String}})],fu.prototype,"writeStyleOrigin",null),u([d({type:rZ,json:{read:!1}})],fu.prototype,"thumbnail",void 0),u([d({type:["point-3d","line-3d","polygon-3d","mesh-3d","label-3d"],readOnly:!0})],fu.prototype,"type",void 0),fu=u([R("esri.symbols.Symbol3D")],fu);const x1=fu;let e2=class extends ge{constructor(t){super(t),this.visible=!0}clone(){}};u([d({type:["line"],readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],e2.prototype,"type",void 0),u([d({readOnly:!0})],e2.prototype,"visible",void 0),e2=u([R("esri.symbols.callouts.Callout3D")],e2);const nZ=e2;var CL;let t2=CL=class extends ge{constructor(){super(...arguments),this.color=new Ae("white")}clone(){return new CL({color:ie(this.color)})}};u([d(Up)],t2.prototype,"color",void 0),t2=CL=u([R("esri.symbols.callouts.LineCallout3DBorder")],t2);const oZ=t2;Object.freeze({__proto__:null,get LineCallout3DBorder(){return t2},default:oZ});var ML;let Wp=ML=class extends nZ{constructor(t){super(t),this.type="line",this.color=new Ae([0,0,0,1]),this.size=au(1),this.border=null}get visible(){return this.size>0&&_(this.color)&&this.color.a>0}clone(){return new ML({color:ie(this.color),size:this.size,border:ie(this.border)})}};u([Xe({line:"line"},{readOnly:!0})],Wp.prototype,"type",void 0),u([d(Up)],Wp.prototype,"color",void 0),u([d(lu)],Wp.prototype,"size",void 0),u([d({type:oZ,json:{write:!0}})],Wp.prototype,"border",void 0),u([d({readOnly:!0})],Wp.prototype,"visible",null),Wp=ML=u([R("esri.symbols.callouts.LineCallout3D")],Wp);const Rxe=Wp;function PL(t){if(!t)return!1;const e=t.verticalOffset;return!!e&&!(e.screenLength<=0||e.maxWorldLength<=0)}function aZ(t){if(!t||!t.supportsCallout||!t.supportsCallout())return!1;const e=t.callout;return!!e&&!!e.visible&&!!PL(t)}function AL(t){return t.type==="point-3d"||t.type==="label-3d"}const lZ={types:{key:"type",base:nZ,typeMap:{line:Rxe}},json:{write:!0}};var $L;let S1=$L=class extends ge{constructor(){super(...arguments),this.screenLength=0,this.minWorldLength=0}clone(){return new $L({screenLength:this.screenLength,minWorldLength:this.minWorldLength,maxWorldLength:this.maxWorldLength})}};u([d(lu)],S1.prototype,"screenLength",void 0),u([d({type:Number,json:{write:!0,default:0}})],S1.prototype,"minWorldLength",void 0),u([d({type:Number,json:{write:!0}})],S1.prototype,"maxWorldLength",void 0),S1=$L=u([R("esri.symbols.support.Symbol3DVerticalOffset")],S1);const cZ=S1;var wP;const uZ=We.ofType({base:null,key:"type",typeMap:{text:Kg}});let Zp=wP=class extends x1{constructor(t){super(t),this.verticalOffset=null,this.callout=null,this.styleOrigin=null,this.symbolLayers=new uZ,this.type="label-3d"}supportsCallout(){return!0}hasVisibleCallout(){return aZ(this)}hasVisibleVerticalOffset(){return PL(this)}clone(){return new wP({styleOrigin:ie(this.styleOrigin),symbolLayers:ie(this.symbolLayers),thumbnail:ie(this.thumbnail),callout:ie(this.callout),verticalOffset:ie(this.verticalOffset)})}static fromTextSymbol(t){return new wP({symbolLayers:[Kg.fromTextSymbol(t)]})}};u([d({type:cZ,json:{write:!0}})],Zp.prototype,"verticalOffset",void 0),u([d(lZ)],Zp.prototype,"callout",void 0),u([d({json:{read:!1,write:!1}})],Zp.prototype,"styleOrigin",void 0),u([d({type:uZ})],Zp.prototype,"symbolLayers",void 0),u([Xe({LabelSymbol3D:"label-3d"},{readOnly:!0})],Zp.prototype,"type",void 0),Zp=wP=u([R("esri.symbols.LabelSymbol3D")],Zp);const xP=Zp;var SP;const hZ=We.ofType({base:null,key:"type",typeMap:{line:w1,path:yL}}),Ixe=We.ofType({base:null,key:"type",typeMap:{line:w1,path:yL}});let i2=SP=class extends x1{constructor(t){super(t),this.symbolLayers=new hZ,this.type="line-3d"}clone(){return new SP({styleOrigin:ie(this.styleOrigin),symbolLayers:ie(this.symbolLayers),thumbnail:ie(this.thumbnail)})}static fromSimpleLineSymbol(t){return new SP({symbolLayers:[w1.fromSimpleLineSymbol(t)]})}};u([d({type:hZ,json:{type:Ixe}})],i2.prototype,"symbolLayers",void 0),u([Xe({LineSymbol3D:"line-3d"},{readOnly:!0})],i2.prototype,"type",void 0),i2=SP=u([R("esri.symbols.LineSymbol3D")],i2);const TP=i2;let Jp=class extends vo{constructor(t){super(t),this.angle=0,this.type=null,this.xoffset=0,this.yoffset=0,this.size=9}hash(){return`${this.type}.${this.angle}.${this.size}.${this.xoffset}.${this.yoffset}`}};u([d({type:Number,json:{read:t=>t&&-1*t,write:(t,e)=>e.angle=t&&-1*t}})],Jp.prototype,"angle",void 0),u([d({type:["simple-marker","picture-marker"],readOnly:!0})],Jp.prototype,"type",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],Jp.prototype,"xoffset",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],Jp.prototype,"yoffset",void 0),u([d({type:Number,cast:t=>t==="auto"?t:ti(t),json:{write:!0}})],Jp.prototype,"size",void 0),Jp=u([R("esri.symbols.MarkerSymbol")],Jp);const dZ=Jp;var EL;const pZ=We.ofType({base:null,key:"type",typeMap:{fill:Jx}});let r2=EL=class extends x1{constructor(t){super(t),this.symbolLayers=new pZ,this.type="mesh-3d"}clone(){return new EL({styleOrigin:ie(this.styleOrigin),symbolLayers:ie(this.symbolLayers),thumbnail:ie(this.thumbnail)})}};u([d({type:pZ})],r2.prototype,"symbolLayers",void 0),u([Xe({MeshSymbol3D:"mesh-3d"},{readOnly:!0})],r2.prototype,"type",void 0),r2=EL=u([R("esri.symbols.MeshSymbol3D")],r2);const OL=r2;function Dxe(t,e,i){return e.imageData?vq({mediaType:e.contentType||"image/png",isBase64:!0,data:e.imageData}):fZ(e.url,i)}function fZ(t,e){return Lxe(e)&&!qo(t)&&e.layer.parsedUrl?Mp(e.layer.parsedUrl.path,"images",t):_1(t,e)}function Fxe(t,e,i,r){if(Jc(t)){const s=pM(t);e.contentType=s.mediaType,e.imageData=s.data,i&&i.imageData===e.imageData&&i.url&&qp(i.url,e,"url",r)}else qp(t,e,"url",r)}const mZ={json:{read:{source:["imageData","url"],reader:Dxe},write:{writer(t,e,i,r){Fxe(t,e,this.source,r)}}}},gZ={readOnly:!0,json:{read:{source:["imageData","url"],reader(t,e,i){const r={};return e.imageData&&(r.imageData=e.imageData),e.contentType&&(r.contentType=e.contentType),e.url&&(r.url=fZ(e.url,i)),r}}}};function Lxe(t){return t&&(t.origin==="service"||t.origin==="portal-item")&&t.layer&&(t.layer.type==="feature"||t.layer.type==="stream")}var RL;let Ba=RL=class extends kW{constructor(...t){super(...t),this.type="picture-fill",this.url=null,this.xscale=1,this.yscale=1,this.width=12,this.height=12,this.xoffset=0,this.yoffset=0,this.source=null}normalizeCtorArgs(t,e,i,r){if(t&&typeof t!="string"&&t.imageData==null)return t;const s={};return t&&(s.url=t),e&&(s.outline=e),i!=null&&(s.width=ti(i)),r!=null&&(s.height=ti(r)),s}clone(){const t=new RL({color:ie(this.color),height:this.height,outline:this.outline&&this.outline.clone(),url:this.url,width:this.width,xoffset:this.xoffset,xscale:this.xscale,yoffset:this.yoffset,yscale:this.yscale});return t._set("source",ie(this.source)),t}hash(){var t;return`${super.hash()}.${(t=this.color)==null?void 0:t.hash()}.${this.height}.${this.url}.${this.width}.${this.xoffset}.${this.xscale}.${this.yoffset}.${this.yscale}`}};u([Xe({esriPFS:"picture-fill"},{readOnly:!0})],Ba.prototype,"type",void 0),u([d(mZ)],Ba.prototype,"url",void 0),u([d({type:Number,json:{write:!0}})],Ba.prototype,"xscale",void 0),u([d({type:Number,json:{write:!0}})],Ba.prototype,"yscale",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],Ba.prototype,"width",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],Ba.prototype,"height",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],Ba.prototype,"xoffset",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],Ba.prototype,"yoffset",void 0),u([d(gZ)],Ba.prototype,"source",void 0),Ba=RL=u([R("esri.symbols.PictureFillSymbol")],Ba);const yZ=Ba;var IL;let Kl=IL=class extends dZ{constructor(...t){super(...t),this.color=null,this.type="picture-marker",this.url=null,this.source=null,this.height=12,this.width=12,this.size=null}normalizeCtorArgs(t,e,i){if(t&&typeof t!="string"&&t.imageData==null)return t;const r={};return t&&(r.url=t),e!=null&&(r.width=ti(e)),i!=null&&(r.height=ti(i)),r}readHeight(t,e){return e.size||t}readWidth(t,e){return e.size||t}clone(){const t=new IL({angle:this.angle,height:this.height,url:this.url,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset});return t._set("source",ie(this.source)),t}hash(){return`${super.hash()}.${this.height}.${this.url}.${this.width}`}};u([d({json:{write:!1}})],Kl.prototype,"color",void 0),u([Xe({esriPMS:"picture-marker"},{readOnly:!0})],Kl.prototype,"type",void 0),u([d(mZ)],Kl.prototype,"url",void 0),u([d(gZ)],Kl.prototype,"source",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],Kl.prototype,"height",void 0),u([Ce("height",["height","size"])],Kl.prototype,"readHeight",null),u([d({type:Number,cast:ti,json:{write:!0}})],Kl.prototype,"width",void 0),u([d({json:{write:!1}})],Kl.prototype,"size",void 0),Kl=IL=u([R("esri.symbols.PictureMarkerSymbol")],Kl);const CP=Kl;var Qp;const vZ=We.ofType({base:null,key:"type",typeMap:{icon:du,object:Xx,text:Kg}}),_Z=We.ofType({base:null,key:"type",typeMap:{icon:du,object:Xx}});let Yp=Qp=class extends x1{constructor(t){super(t),this.verticalOffset=null,this.callout=null,this.symbolLayers=new vZ,this.type="point-3d"}writeSymbolLayers(t,e,i,r){const s=t.filter(n=>n.type!=="text");if(r&&r.messages&&s.length<t.length){const n=t.find(o=>o.type==="text");r.messages.push(new Q("symbol-layer:unsupported","Symbol layers of type 'text' cannot be persisted in PointSymbol3D",{symbolLayer:n}))}e[i]=s.map(n=>n.write({},r)).toArray()}supportsCallout(){if((this.symbolLayers?this.symbolLayers.length:0)<1)return!1;for(const t of this.symbolLayers.items)switch(t.type){case"icon":case"text":case"object":continue;default:return!1}return!0}hasVisibleCallout(){return aZ(this)}hasVisibleVerticalOffset(){return PL(this)}clone(){return new Qp({verticalOffset:ie(this.verticalOffset),callout:ie(this.callout),styleOrigin:ie(this.styleOrigin),symbolLayers:ie(this.symbolLayers),thumbnail:ie(this.thumbnail)})}static fromSimpleMarkerSymbol(t){return new Qp({symbolLayers:[du.fromSimpleMarkerSymbol(t)]})}static fromPictureMarkerSymbol(t){return new Qp({symbolLayers:[du.fromPictureMarkerSymbol(t)]})}static fromCIMSymbol(t){var e,i;return((e=t.data)==null||(i=e.symbol)==null?void 0:i.type)!=="CIMPointSymbol"?null:t.data.symbol.callout?new Qp({symbolLayers:[du.fromCIMSymbol(t)],callout:{type:"line",size:.5,color:[0,0,0]},verticalOffset:{screenLength:40}}):new Qp({symbolLayers:[du.fromCIMSymbol(t)]})}static fromTextSymbol(t){return new Qp({symbolLayers:[Kg.fromTextSymbol(t)]})}};u([d({type:cZ,json:{write:!0}})],Yp.prototype,"verticalOffset",void 0),u([d(lZ)],Yp.prototype,"callout",void 0),u([d({type:vZ,json:{type:_Z,origins:{"web-scene":{type:_Z}}}})],Yp.prototype,"symbolLayers",void 0),u([Ee("web-scene","symbolLayers")],Yp.prototype,"writeSymbolLayers",null),u([Xe({PointSymbol3D:"point-3d"},{readOnly:!0})],Yp.prototype,"type",void 0),Yp=Qp=u([R("esri.symbols.PointSymbol3D")],Yp);const Xp=Yp;var s2;const bZ=We.ofType({base:null,key:"type",typeMap:{extrude:j5,fill:Jx,icon:du,line:w1,object:Xx,text:Kg,water:wL}}),kxe=We.ofType({base:null,key:"type",typeMap:{extrude:j5,fill:Jx,icon:du,line:w1,object:Xx,water:wL}});let T1=s2=class extends x1{constructor(t){super(t),this.symbolLayers=new bZ,this.type="polygon-3d"}writeSymbolLayers(t,e,i,r){const s=t.filter(n=>n.type!=="text");if(r&&r.messages&&s.length<t.length){const n=t.find(o=>o.type==="text");r.messages.push(new Q("symbol-layer:unsupported","Symbol layers of type 'text' cannot be persisted in PolygonSymbol3D",{symbolLayer:n}))}e[i]=s.map(n=>n.write({},r)).toArray()}clone(){return new s2({styleOrigin:ie(this.styleOrigin),symbolLayers:ie(this.symbolLayers),thumbnail:ie(this.thumbnail)})}static fromJSON(t){const e=new s2;if(e.read(t),e.symbolLayers.length===2&&e.symbolLayers.getItemAt(0).type==="fill"&&e.symbolLayers.getItemAt(1).type==="line"){const i=e.symbolLayers.getItemAt(0),r=e.symbolLayers.getItemAt(1);!r.enabled||t.symbolLayers&&t.symbolLayers[1]&&t.symbolLayers[1].enable===!1||(i.outline={size:r.size,color:_(r.material)?r.material.color:null}),e.symbolLayers.removeAt(1)}return e}static fromSimpleFillSymbol(t){return new s2({symbolLayers:[Jx.fromSimpleFillSymbol(t)]})}};u([d({type:bZ,json:{type:kxe}})],T1.prototype,"symbolLayers",void 0),u([Ee("web-scene","symbolLayers")],T1.prototype,"writeSymbolLayers",null),u([Xe({PolygonSymbol3D:"polygon-3d"},{readOnly:!0})],T1.prototype,"type",void 0),T1=s2=u([R("esri.symbols.PolygonSymbol3D")],T1);const n2=T1;var DL;const FL=new wt({esriSFSSolid:"solid",esriSFSNull:"none",esriSFSHorizontal:"horizontal",esriSFSVertical:"vertical",esriSFSForwardDiagonal:"forward-diagonal",esriSFSBackwardDiagonal:"backward-diagonal",esriSFSCross:"cross",esriSFSDiagonalCross:"diagonal-cross"});let ty=DL=class extends kW{constructor(...t){super(...t),this.color=new Ae([0,0,0,.25]),this.outline=new Jl,this.type="simple-fill",this.style="solid"}normalizeCtorArgs(t,e,i){if(t&&typeof t!="string")return t;const r={};return t&&(r.style=t),e&&(r.outline=e),i&&(r.color=i),r}clone(){return new DL({color:ie(this.color),outline:this.outline&&this.outline.clone(),style:this.style})}hash(){return`${super.hash()}${this.style}.${this.color&&this.color.hash()}`}};u([d()],ty.prototype,"color",void 0),u([d()],ty.prototype,"outline",void 0),u([Xe({esriSFS:"simple-fill"},{readOnly:!0})],ty.prototype,"type",void 0),u([d({type:FL.apiValues,json:{read:FL.read,write:FL.write}})],ty.prototype,"style",void 0),ty=DL=u([R("esri.symbols.SimpleFillSymbol")],ty);const iy=ty;var LL;const kL=new wt({esriSMSCircle:"circle",esriSMSSquare:"square",esriSMSCross:"cross",esriSMSX:"x",esriSMSDiamond:"diamond",esriSMSTriangle:"triangle",esriSMSPath:"path"});let mu=LL=class extends dZ{constructor(...t){super(...t),this.color=new Ae([255,255,255,.25]),this.type="simple-marker",this.size=12,this.style="circle",this.outline=new Jl}normalizeCtorArgs(t,e,i,r){if(t&&typeof t!="string")return t;const s={};return t&&(s.style=t),e!=null&&(s.size=ti(e)),i&&(s.outline=i),r&&(s.color=r),s}writeColor(t,e){t&&this.style!=="x"&&this.style!=="cross"&&(e.color=t.toJSON()),t===null&&(e.color=null)}set path(t){this.style="path",this._set("path",t)}clone(){return new LL({angle:this.angle,color:ie(this.color),outline:this.outline&&this.outline.clone(),path:this.path,size:this.size,style:this.style,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){var t;return`${super.hash()}.${this.color&&this.color.hash()}.${this.path}.${this.style}.${(t=this.outline)==null?void 0:t.hash()}`}};u([d()],mu.prototype,"color",void 0),u([Ee("color")],mu.prototype,"writeColor",null),u([Xe({esriSMS:"simple-marker"},{readOnly:!0})],mu.prototype,"type",void 0),u([d()],mu.prototype,"size",void 0),u([d({type:kL.apiValues,json:{read:kL.read,write:kL.write}})],mu.prototype,"style",void 0),u([d({type:String,json:{write:!0}})],mu.prototype,"path",null),u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":Jl}},json:{default:null,write:!0}})],mu.prototype,"outline",void 0),mu=LL=u([R("esri.symbols.SimpleMarkerSymbol")],mu);const C1=mu;var zL;let Ui=zL=class extends vo{constructor(...t){super(...t),this.backgroundColor=null,this.borderLineColor=null,this.borderLineSize=null,this.font=new yP,this.horizontalAlignment="center",this.kerning=!0,this.haloColor=null,this.haloSize=null,this.rightToLeft=null,this.rotated=!1,this.text="",this.type="text",this.verticalAlignment=null,this.xoffset=0,this.yoffset=0,this.angle=0,this.width=null,this.lineWidth=192,this.lineHeight=1}normalizeCtorArgs(t,e,i){if(t&&typeof t!="string")return t;const r={};return t&&(r.text=t),e&&(r.font=e),i&&(r.color=i),r}writeLineWidth(t,e,i,r){r&&typeof r!="string"?r.origin:e[i]=t}castLineWidth(t){return ti(t)}writeLineHeight(t,e,i,r){r&&typeof r!="string"?r.origin:e[i]=t}clone(){return new zL({angle:this.angle,backgroundColor:ie(this.backgroundColor),borderLineColor:ie(this.borderLineColor),borderLineSize:this.borderLineSize,color:ie(this.color),font:this.font&&this.font.clone(),haloColor:ie(this.haloColor),haloSize:this.haloSize,horizontalAlignment:this.horizontalAlignment,kerning:this.kerning,lineHeight:this.lineHeight,lineWidth:this.lineWidth,rightToLeft:this.rightToLeft,rotated:this.rotated,text:this.text,verticalAlignment:this.verticalAlignment,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){return`${this.backgroundColor&&this.backgroundColor.hash()}.${this.borderLineColor}.${this.borderLineSize}.${this.color.hash()}.${this.font&&this.font.hash()}.${this.haloColor&&this.haloColor.hash()}.${this.haloSize}.${this.horizontalAlignment}.${this.kerning}.${this.rightToLeft}.${this.rotated}.${this.text}.${this.verticalAlignment}.${this.width}.${this.xoffset}.${this.yoffset}.${this.lineHeight}.${this.lineWidth}.${this.angle}`}};u([d({type:Ae,json:{write:!0}})],Ui.prototype,"backgroundColor",void 0),u([d({type:Ae,json:{write:!0}})],Ui.prototype,"borderLineColor",void 0),u([d({type:Number,json:{write:!0}})],Ui.prototype,"borderLineSize",void 0),u([d({type:yP,json:{write:!0}})],Ui.prototype,"font",void 0),u([d({type:["left","right","center","justify"],json:{write:!0}})],Ui.prototype,"horizontalAlignment",void 0),u([d({type:Boolean,json:{write:!0}})],Ui.prototype,"kerning",void 0),u([d({type:Ae,json:{write:!0}})],Ui.prototype,"haloColor",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],Ui.prototype,"haloSize",void 0),u([d({type:Boolean,json:{write:!0}})],Ui.prototype,"rightToLeft",void 0),u([d({type:Boolean,json:{write:!0}})],Ui.prototype,"rotated",void 0),u([d({type:String,json:{write:!0}})],Ui.prototype,"text",void 0),u([Xe({esriTS:"text"},{readOnly:!0})],Ui.prototype,"type",void 0),u([d({type:["baseline","top","middle","bottom"],json:{write:!0}})],Ui.prototype,"verticalAlignment",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],Ui.prototype,"xoffset",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],Ui.prototype,"yoffset",void 0),u([d({type:Number,json:{read:t=>t&&-1*t,write:(t,e)=>e.angle=t&&-1*t}})],Ui.prototype,"angle",void 0),u([d({type:Number,json:{write:!0}})],Ui.prototype,"width",void 0),u([d({type:Number})],Ui.prototype,"lineWidth",void 0),u([Ee("lineWidth")],Ui.prototype,"writeLineWidth",null),u([ut("lineWidth")],Ui.prototype,"castLineWidth",null),u([d({type:Number})],Ui.prototype,"lineHeight",void 0),u([Ee("lineHeight")],Ui.prototype,"writeLineHeight",null),Ui=zL=u([R("esri.symbols.TextSymbol")],Ui);const M1=Ui;var VL;const zxe=le.getLogger("esri.symbols.WebStyleSymbol");let gu=VL=class extends vo{constructor(t){super(t),this.styleName=null,this.portal=null,this.styleUrl=null,this.thumbnail=null,this.name=null,this.type="web-style"}read(t,e){this.portal=e?e.portal:void 0,super.read(t,e)}clone(){return new VL({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}fetchSymbol(t){return this._fetchSymbol("webRef",t)}fetchCIMSymbol(t){return this._fetchSymbol("cimRef",t)}async _fetchSymbol(t,e){const i=await Vxe();Dt(e);const r=i.resolveWebStyleSymbol(this,{portal:this.portal},t,e);return r.catch(s=>{zxe.error("#fetchSymbol()","Failed to create symbol from style",s)}),r}};function Vxe(){return import("./webStyleSymbolUtils.3838d892.js")}u([d({json:{write:!1}})],gu.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],gu.prototype,"styleName",void 0),u([d({type:po,json:{write:!1}})],gu.prototype,"portal",void 0),u([d({type:String,json:{read:lL,write:qp}})],gu.prototype,"styleUrl",void 0),u([d({type:rZ,json:{read:!1}})],gu.prototype,"thumbnail",void 0),u([d({type:String,json:{write:!0}})],gu.prototype,"name",void 0),u([Xe({styleSymbolReference:"web-style"},{readOnly:!0})],gu.prototype,"type",void 0),gu=VL=u([R("esri.symbols.WebStyleSymbol")],gu);const ry=gu;function NL(t){if(!t)return!1;switch(t.type){case"picture-fill":case"picture-marker":case"simple-fill":case"simple-line":case"simple-marker":case"text":case"cim":return!0;default:return!1}}function o2(t){if(!t)return!1;switch(t.type){case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":return!0;default:return!1}}const sy={base:vo,key:"type",typeMap:{"simple-fill":iy,"picture-fill":yZ,"picture-marker":CP,"simple-line":Jl,"simple-marker":C1,text:M1,"label-3d":xP,"line-3d":TP,"mesh-3d":OL,"point-3d":Xp,"polygon-3d":n2,"web-style":ry,cim:p1},errorContext:"symbol"},Nxe={base:vo,key:"type",typeMap:{"picture-marker":CP,"simple-marker":C1,text:M1,"web-style":ry,cim:p1},errorContext:"symbol"},Uxe=Gv({types:sy}),wZ={base:vo,key:"type",typeMap:{"simple-fill":iy,"picture-fill":yZ,"picture-marker":CP,"simple-line":Jl,"simple-marker":C1,text:M1,"line-3d":TP,"mesh-3d":OL,"point-3d":Xp,"polygon-3d":n2,"web-style":ry,cim:p1},errorContext:"symbol"},jxe={base:vo,key:"type",typeMap:{text:M1,"label-3d":xP},errorContext:"symbol"},xZ={base:vo,key:"type",typeMap:{"line-3d":TP,"mesh-3d":OL,"point-3d":Xp,"polygon-3d":n2,"web-style":ry,cim:p1},errorContext:"symbol"},Bxe={base:vo,key:"type",typeMap:{"label-3d":xP},errorContext:"symbol"},SZ=Zc(sy);var UL;let Yo=UL=class extends ge{constructor(...t){super(...t),this.isAggregate=!1,this.layer=null,this.popupTemplate=null,this.sourceLayer=null,Object.defineProperty(this,"uid",{value:On(),configurable:!0})}normalizeCtorArgs(t,e,i,r){return t&&!t.declaredClass?t:{geometry:t,symbol:e,attributes:i,popupTemplate:r}}set attributes(t){const e=this._get("attributes");e!==t&&(this._set("attributes",t),this._notifyLayer("attributes",e,t))}set geometry(t){const e=this._get("geometry");e!==t&&(this._set("geometry",t),this._notifyLayer("geometry",e,t))}set symbol(t){const e=this._get("symbol");e!==t&&(this._set("symbol",t),this._notifyLayer("symbol",e,t))}set visible(t){const e=this._get("visible");e!==t&&(this._set("visible",t),this._notifyLayer("visible",e,t))}getEffectivePopupTemplate(t=!1){if(this.popupTemplate)return this.popupTemplate;for(const e of[this.sourceLayer,this.layer])if(e){if("popupTemplate"in e&&e.popupTemplate)return e.popupTemplate;if(t&&"defaultPopupTemplate"in e&&_(e.defaultPopupTemplate))return e.defaultPopupTemplate}return null}getAttribute(t){return this.attributes&&this.attributes[t]}setAttribute(t,e){if(this.attributes){const i=this.getAttribute(t);this.attributes[t]=e,this._notifyLayer("attributes",i,e,t)}else this.attributes={[t]:e},this._notifyLayer("attributes",void 0,e,t)}getObjectId(){return this.sourceLayer&&"objectIdField"in this.sourceLayer&&this.sourceLayer.objectIdField?this.getAttribute(this.sourceLayer.objectIdField):null}toJSON(){return{geometry:_(this.geometry)?this.geometry.toJSON():null,symbol:_(this.symbol)?this.symbol.toJSON():null,attributes:E({},this.attributes),popupTemplate:this.popupTemplate&&this.popupTemplate.toJSON()}}clone(){return new UL(this.cloneProperties())}notifyGeometryChanged(){this._notifyLayer("geometry",this.geometry,this.geometry)}cloneProperties(){return{attributes:ie(this.attributes),geometry:ie(this.geometry),layer:this.layer,popupTemplate:this.popupTemplate&&this.popupTemplate.clone(),sourceLayer:this.sourceLayer,symbol:ie(this.symbol),visible:this.visible}}_notifyLayer(t,e,i,r){if(!this.layer||!("graphicChanged"in this.layer))return;const s={graphic:this,property:t,oldValue:e,newValue:i};t==="attributes"&&(s.attributeName=r),this.layer.graphicChanged(s)}};u([d({value:null})],Yo.prototype,"attributes",null),u([d({value:null,types:Og,json:{read:Lp}})],Yo.prototype,"geometry",null),u([d({type:Boolean})],Yo.prototype,"isAggregate",void 0),u([d()],Yo.prototype,"layer",void 0),u([d({type:rP})],Yo.prototype,"popupTemplate",void 0),u([d()],Yo.prototype,"sourceLayer",void 0),u([d({value:null,types:sy})],Yo.prototype,"symbol",null),u([d({type:Boolean,value:!0})],Yo.prototype,"visible",null),Yo=UL=u([R("esri.Graphic")],Yo),function(t){t.generateUID=On}(Yo||(Yo={}));const pn=Yo;var jL;let Kp=jL=class extends ge{constructor(t){super(t),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(t){return(t%=360)<0&&(t+=360),t}clone(){return new jL({rotation:this.rotation,scale:this.scale,targetGeometry:_(this.targetGeometry)?this.targetGeometry.clone():null,camera:_(this.camera)?this.camera.clone():null})}};function BL(){return{enabled:!this.camera}}u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:BL}}}}})],Kp.prototype,"rotation",void 0),u([ut("rotation")],Kp.prototype,"castRotation",null),u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:BL}}}}})],Kp.prototype,"scale",void 0),u([d({types:Og,json:{read:Lp,write:!0,origins:{"web-scene":{read:Lp,write:{overridePolicy:BL}}}}})],Kp.prototype,"targetGeometry",void 0),u([d({type:yo,json:{write:!0}})],Kp.prototype,"camera",void 0),Kp=jL=u([R("esri.Viewpoint")],Kp);const ec=Kp;function MP(t){return typeof t=="string"?document.getElementById(t):t}function TZ(t){for(;t.hasChildNodes();)t.removeChild(t.firstChild)}function CZ(t,e){const i=e.parentNode;i&&i.insertBefore(t,e)}function MZ(t,e){for(;;){const i=t.firstChild;if(!i)break;e.appendChild(i)}}function Nnt(t){const e=[];return function*(){yield*e;for(const i of t)e.push(i),yield i}}function Unt(t,e){for(const i of t)if(i!=null&&e(i))return i}function Gxe(t){return t!=null&&typeof t[Symbol.iterator]=="function"}var Vn;(function(t){t[t.HANDSHAKE=0]="HANDSHAKE",t[t.OPEN=1]="OPEN",t[t.OPENED=2]="OPENED",t[t.RESPONSE=3]="RESPONSE",t[t.INVOKE=4]="INVOKE",t[t.ABORT=5]="ABORT",t[t.CLOSE=6]="CLOSE",t[t.OPEN_PORT=7]="OPEN_PORT",t[t.ON=8]="ON"})(Vn||(Vn={}));let qxe=0;function PZ(){return qxe++}function Hxe(t){return t&&typeof t=="object"&&("result"in t||"transferList"in t)}function PP(t){return t?typeof t=="string"?JSON.stringify({name:"message",message:t}):t.toJSON?JSON.stringify(t):JSON.stringify({name:t.name,message:t.message,details:t.details||{stack:t.stack}}):null}function AZ(t,e,i,r){if(e.type===Vn.OPEN_PORT)return void t.postMessage(e,[e.port]);if(e.type!==Vn.INVOKE&&e.type!==Vn.RESPONSE)return void t.postMessage(e);let s;Hxe(i)?(s=$Z(i.transferList),e.data=i.result):(s=$Z(r),e.data=i),s?t.postMessage(e,s):t.postMessage(e)}function a2(t){if(!t)return null;const e=t.data;return e?typeof e=="string"?JSON.parse(e):e:null}function $Z(t){if(!t||!t.length)return null;if(ae("esri-workers-arraybuffer-transfer"))return t;const e=t.filter(i=>!Wxe(i));return e.length?e:null}function Wxe(t){return t instanceof ArrayBuffer||t&&t.constructor&&t.constructor.name==="ArrayBuffer"}const Zxe={statsWorker:()=>import("./statsWorker.a69d74b4.js"),geometryEngineWorker:()=>import("./geometryEngineWorker.b847d5da.js"),CSVSourceWorker:()=>import("./CSVSourceWorker.13b2b19d.js"),EdgeProcessingWorker:()=>Promise.resolve().then(function(){return nrt}),ElevationSamplerWorker:()=>import("./ElevationSamplerWorker.bfdf9428.js"),FeatureServiceSnappingSourceWorker:()=>import("./FeatureServiceSnappingSourceWorker.be4db3be.js"),GeoJSONSourceWorker:()=>import("./GeoJSONSourceWorker.dea14e78.js"),LercWorker:()=>import("./LercWorker.a27f3f15.js"),MemorySourceWorker:()=>import("./MemorySourceWorker.a086dffd.js"),PBFDecoderWorker:()=>import("./PBFDecoderWorker.6730576e.js"),Pipeline:()=>import("./Pipeline.b8c395b5.js").then(function(t){return t.P}),PointCloudWorker:()=>import("./PointCloudWorker.48c19055.js"),RasterWorker:()=>import("./RasterWorker.9316311c.js"),SceneLayerWorker:()=>import("./SceneLayerWorker.94ac04c2.js"),WFSSourceWorker:()=>import("./WFSSourceWorker.d938b9e9.js"),WorkerTileHandler:()=>import("./WorkerTileHandler.c65dad92.js")},{CLOSE:EZ,ABORT:OZ,INVOKE:RZ,RESPONSE:l2,OPEN_PORT:IZ,ON:Jxe}=Vn;class Qxe{constructor(e){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=e,this._timer=null,this._process=this._process.bind(this)}push(e){e.type===Vn.ABORT?this._cancelledJobIds.add(e.jobId):(this._invokeMessages.push(e),this._timer===null&&(this._timer=setTimeout(this._process,0)))}clear(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null}_process(){this._timer=null;for(const e of this._invokeMessages)this._cancelledJobIds.has(e.jobId)||this._invoke(e);this._cancelledJobIds.clear(),this._invokeMessages.length=0}}class _o{constructor(e,i){this._port=e,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new Qxe(r=>this._onInvokeMessage(r)),this._client=i.client,this._onMessage=this._onMessage.bind(this),this._channel=i.channel,this._schedule=i.schedule,this._port.addEventListener("message",this._onMessage),this._port.start()}static connect(e){const i=new MessageChannel;let r;r=typeof e=="function"?new e:"default"in e&&typeof e.default=="function"?new e.default:e;const s=new _o(i.port1,{channel:i,client:r});return typeof r=="object"&&"remoteClient"in r&&(r.remoteClient=s),_o.clients.set(s,r),i.port2}static loadWorker(e){const i=Zxe[e];return i?i():Promise.resolve(null)}close(){this._post({type:EZ}),this._close()}isBusy(){return this._outJobs.size>0}invoke(e,i,r){const s=r&&r.signal,n=r&&r.transferList;if(!this._port)return Promise.reject(new Q("worker:port-closed",`Cannot call invoke('${e}'), port is closed`,{methodName:e,data:i}));const o=PZ();return new Promise((a,l)=>{const c=WC(s,()=>{var p;const f=this._outJobs.get(o);f&&(this._outJobs.delete(o),(p=f.abortHandle)==null||p.remove(),this._post({type:OZ,jobId:o}),l($t()))}),h={resolve:a,reject:l,abortHandle:c,debugInfo:e};this._outJobs.set(o,h),this._post({type:RZ,jobId:o,methodName:e,abortable:s!=null},i,n)})}on(e,i){const r=new MessageChannel;function s(n){i(n.data)}return this._port.postMessage({type:Vn.ON,eventType:e,port:r.port2},[r.port2]),r.port1.addEventListener("message",s),r.port1.start(),{remove(){r.port1.postMessage({type:Vn.CLOSE}),r.port1.close(),r.port1.removeEventListener("message",s)}}}openPort(){const e=new MessageChannel;return this._post({type:IZ,port:e.port2}),e.port1}_close(){this._channel&&(this._channel=null),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach(e=>{var i;(i=e.abortHandle)==null||i.remove(),e.reject($t(`Worker closing, aborting job calling '${e.debugInfo}'`))}),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=this._client=this._schedule=null}_onMessage(e){_(this._schedule)?this._schedule(()=>this._processMessage(e)):this._processMessage(e)}_processMessage(e){const i=a2(e);if(i)switch(i.type){case l2:this._onResponseMessage(i);break;case RZ:this._invokeQueue.push(i);break;case OZ:this._onAbortMessage(i);break;case EZ:this._onCloseMessage();break;case IZ:this._onOpenPortMessage(i);break;case Jxe:this._onOnMessage(i)}}_onAbortMessage(e){const i=this._inJobs,r=e.jobId,s=i.get(r);this._invokeQueue.push(e),s&&(s.controller&&s.controller.abort(),i.delete(r))}_onCloseMessage(){const e=this._client;this._close(),e&&"destroy"in e&&_o.clients.get(this)===e&&e.destroy(),_o.clients.delete(this),e&&e.remoteClient&&(e.remoteClient=null)}_onInvokeMessage(e){const{methodName:i,jobId:r,data:s,abortable:n}=e,o=n?new AbortController:null,a=this._inJobs;let l,c=this._client,h=c[i];try{if(!h&&i&&i.indexOf(".")!==-1){const p=i.split(".");for(let f=0;f<p.length-1;f++)c=c[p[f]],h=c[p[f+1]]}if(typeof h!="function")throw new TypeError(`${i} is not a function`);l=h.call(c,s,{client:this,signal:o?o.signal:null})}catch(p){return void this._post({type:l2,jobId:r,error:PP(p)})}fg(l)?(a.set(r,{controller:o,promise:l}),l.then(p=>{a.has(r)&&(a.delete(r),this._post({type:l2,jobId:r},p))},p=>{a.has(r)&&(a.delete(r),bi(p)||this._post({type:l2,jobId:r,error:PP(p||{message:`Error encountered at method ${i}`})}))})):this._post({type:l2,jobId:r},l)}_onOpenPortMessage(e){new _o(e.port,{client:this._client})}_onOnMessage(e){const{port:i}=e,r=this._client.on(e.eventType,n=>{i.postMessage(n)}),s=qC(e.port,"message",n=>{a2(n).type===Vn.CLOSE&&(s.remove(),r.remove(),i.close())})}_onResponseMessage(e){var i;const{jobId:r,error:s,data:n}=e,o=this._outJobs;if(!o.has(r))return;const a=o.get(r);o.delete(r),(i=a.abortHandle)==null||i.remove(),s?a.reject(Q.fromJSON(JSON.parse(s))):a.resolve(n)}_post(e,i,r){return AZ(this._port,e,i,r)}}_o.kernelInfo={revision:Aq,version:$q,buildDate:Pq},_o.clients=new Map;const Yxe=le.getLogger("esri.core.workers.Connection");class Xxe{constructor(){this._clients=new Array,this._clientPromises=new Array,this._clientIdx=0}destroy(){this.close()}get closed(){return!this._clients||!this._clients.length}open(e,i){return new Promise((r,s)=>{let n=!0;const o=a=>{Dt(i.signal),n&&(n=!1,a())};this._clients.length=e.length,this._clientPromises.length=e.length;for(let a=0;a<e.length;++a){const l=e[a];fg(l)?this._clientPromises[a]=l.then(c=>(this._clients[a]=new _o(c,i),o(r),this._clients[a]),()=>(o(s),null)):(this._clients[a]=new _o(l,i),this._clientPromises[a]=Promise.resolve(this._clients[a]),o(r))}})}broadcast(e,i,r){const s=new Array(this._clientPromises.length);for(let n=0;n<this._clientPromises.length;++n){const o=this._clientPromises[n];s[n]=o.then(a=>a.invoke(e,i,r))}return s}close(){for(const e of this._clientPromises)e.then(i=>i.close());this._clients.length=0,this._clientPromises.length=0}getAvailableClient(){let e;for(let i=0;i<this._clients.length;++i){const r=this._clients[i];if(r){if(!r.isBusy())return Promise.resolve(r)}else e=e||[],e.push(this._clientPromises[i])}return e?Promise.race(e):(this._clientIdx=(this._clientIdx+1)%this._clients.length,Promise.resolve(this._clients[this._clientIdx]))}invoke(e,i,r){let s=null;return Array.isArray(r)?(Yxe.warn("invoke()","The transferList parameter is deprecated, use the options object instead"),s={transferList:r}):s=r,this.closed?Promise.reject(new Error("Connection closed")):this.getAvailableClient().then(n=>n.invoke(e,i,s))}on(e,i){return Promise.all(this._clientPromises).then(()=>Gw(this._clients.map(r=>r.on(e,i))))}openPorts(){return new Promise(e=>{const i=new Array(this._clientPromises.length);let r=i.length;for(let s=0;s<this._clientPromises.length;++s)this._clientPromises[s].then(n=>{i[s]=n.openPort(),--r==0&&e(i)})})}get test(){return{numClients:this._clients.length}}}const DZ=le.getLogger("esri.intl");function yu(t,e,i={}){const{format:r={}}=i;return Dl(t,s=>Kxe(s,e,r))}function Kxe(t,e,i){let r,s;const n=t.indexOf(":");if(n===-1?r=t.trim():(r=t.slice(0,n).trim(),s=t.slice(n+1).trim()),!r)return"";const o=zv(r,e);if(o==null)return"";const a=i[s]||i[r];return a?e2e(o,a):s?t2e(o,s):GL(o)}function e2e(t,e){switch(e.type){case"date":return Nh(t,e.intlOptions);case"number":return Uh(t,e.intlOptions);default:return DZ.warn("missing format descriptor for key {key}"),GL(t)}}function t2e(t,e){switch(e.toLowerCase()){case"dateformat":return Nh(t);case"numberformat":return Uh(t);default:return DZ.warn(`inline format is unsupported since 4.12: ${e}`),/^(dateformat|datestring)/i.test(e)?Nh(t):/^numberformat/i.test(e)?Uh(t):GL(t)}}function GL(t){switch(typeof t){case"string":return t;case"number":return Uh(t);case"boolean":return""+t;default:return t instanceof Date?Nh(t):""}}async function i2e(t,e,i,r){const s=e.exec(i);if(!s)throw new Q("esri-intl:invalid-bundle",`Bundle id "${i}" is not compatible with the pattern "${e}"`);const n=s[1]?`${s[1]}/`:"",o=s[2],a=s_e(r),l=`${n}${o}.json`,c=a?`${n}${o}_${a}.json`:l;let h;try{h=await FZ(t(c))}catch(p){if(c===l)throw new Q("intl:unknown-bundle",`Bundle "${i}" cannot be loaded`,{error:p});try{h=await FZ(t(l))}catch(f){throw new Q("intl:unknown-bundle",`Bundle "${i}" cannot be loaded`,{error:f})}}return h}async function FZ(t){if(_(LZ.fetchBundleAsset))return LZ.fetchBundleAsset(t);const e=await vt(t,{responseType:"text"});return JSON.parse(e.data)}class r2e{constructor({base:e="",pattern:i,location:r=new URL(window.location.href)}){let s;s=typeof r=="string"?n=>new URL(n,new URL(r,window.location.href)).href:r instanceof URL?n=>new URL(n,r).href:r,this.pattern=typeof i=="string"?new RegExp(`^${i}`):i,this.getAssetUrl=s,e=e?e.endsWith("/")?e:e+"/":"",this.matcher=new RegExp(`^${e}(?:(.*)/)?(.*)$`)}fetchMessageBundle(e,i){return i2e(this.getAssetUrl,this.matcher,e,i)}}function s2e(t){return new r2e(t)}const LZ={};r_e(s2e({pattern:"esri/",location:kt}));const kZ={};function n2e(t,e){for(const i of t)if(i.name===e.name)return;t.push(e)}function o2e(t){var e;const i={async:t.async,isDebug:t.isDebug,locale:t.locale,baseUrl:t.baseUrl,has:E({},t.has),map:E({},t.map),packages:t.packages&&t.packages.concat()||[],paths:E({},t.paths)};return t.hasOwnProperty("async")||(i.async=!0),t.hasOwnProperty("isDebug")||(i.isDebug=!1),t.baseUrl||(i.baseUrl=kZ.baseUrl),(e=kZ.packages)==null||e.forEach(r=>{n2e(i.packages,r)}),i}class a2e{constructor(){const e=document.createDocumentFragment();["addEventListener","dispatchEvent","removeEventListener"].forEach(i=>{this[i]=(...r)=>e[i](...r)})}}class AP{constructor(){this._dispatcher=new a2e,this._workerPostMessage({type:Vn.HANDSHAKE})}terminate(){}get onmessage(){return this._onmessageHandler}set onmessage(e){this._onmessageHandler&&this.removeEventListener("message",this._onmessageHandler),this._onmessageHandler=e,e&&this.addEventListener("message",e)}get onmessageerror(){return this._onmessageerrorHandler}set onmessageerror(e){this._onmessageerrorHandler&&this.removeEventListener("messageerror",this._onmessageerrorHandler),this._onmessageerrorHandler=e,e&&this.addEventListener("messageerror",e)}get onerror(){return this._onerrorHandler}set onerror(e){this._onerrorHandler&&this.removeEventListener("error",this._onerrorHandler),this._onerrorHandler=e,e&&this.addEventListener("error",e)}postMessage(e){Nv(()=>{this._workerMessageHandler(new MessageEvent("message",{data:e}))})}dispatchEvent(e){return this._dispatcher.dispatchEvent(e)}addEventListener(e,i,r){this._dispatcher.addEventListener(e,i,r)}removeEventListener(e,i,r){this._dispatcher.removeEventListener(e,i,r)}_workerPostMessage(e){Nv(()=>{this.dispatchEvent(new MessageEvent("message",{data:e}))})}async _workerMessageHandler(e){const i=a2(e);if(i&&i.type===Vn.OPEN){const{modulePath:r,jobId:s}=i;let n=await _o.loadWorker(r);n||(n=await import(r));const o=_o.connect(n);this._workerPostMessage({type:Vn.OPENED,jobId:s,data:o})}}}const qL=le.getLogger("esri.core.workers"),{HANDSHAKE:l2e}=Vn,c2e='let globalId=0;const outgoing=new Map,configuration=JSON.parse("{CONFIGURATION}");self.esriConfig=configuration.esriConfig;const workerPath=self.esriConfig.workers.workerPath,HANDSHAKE=0,OPEN=1,OPENED=2,RESPONSE=3,INVOKE=4,ABORT=5;function createAbortError(){const e=new Error("Aborted");return e.name="AbortError",e}function receiveMessage(e){return e&&e.data?"string"==typeof e.data?JSON.parse(e.data):e.data:null}function invokeStaticMessage(e,o,r){const t=r&&r.signal,n=globalId++;return new Promise(((r,i)=>{if(t){if(t.aborted)return i(createAbortError());t.addEventListener("abort",(()=>{outgoing.get(n)&&(outgoing.delete(n),self.postMessage({type:5,jobId:n}),i(createAbortError()))}))}outgoing.set(n,{resolve:r,reject:i}),self.postMessage({type:4,jobId:n,methodName:e,abortable:null!=t,data:o})}))}let workerRevisionChecked=!1;function checkWorkerRevision(e){if(!workerRevisionChecked&&e.kernelInfo){workerRevisionChecked=!0;const{revision:o,buildDate:r,version:t}=configuration.kernelInfo,{revision:n,buildDate:i,version:s}=e.kernelInfo;o!==n&&console.warn(`[esri.core.workers] Version mismatch detected between ArcGIS API for JavaScript and assets:\nAPI version: ${t} [Date: ${r}, Revision: ${o.slice(0,8)}]\nAssets version: ${s} [Date: ${i}, Revision: ${n.slice(0,8)}]`)}}function messageHandler(e){const o=receiveMessage(e);if(!o)return;const r=o.jobId;switch(o.type){case 1:let e;function t(o){const t=e.connect(o);self.postMessage({type:2,jobId:r,data:t},[t])}"function"==typeof define&&define.amd?require([workerPath],(r=>{e=r.default||r,checkWorkerRevision(e),e.loadWorker(o.modulePath).then((e=>e||new Promise((e=>{require([o.modulePath],e)})))).then(t)})):"System"in self&&"function"==typeof System.import?System.import(workerPath).then((r=>(e=r.default,checkWorkerRevision(e),e.loadWorker(o.modulePath)))).then((e=>e||System.import(o.modulePath))).then(t):(self.RemoteClient||importScripts(workerPath),e=self.RemoteClient.default||self.RemoteClient,checkWorkerRevision(e),e.loadWorker(o.modulePath).then(t));break;case 3:if(outgoing.has(r)){const e=outgoing.get(r);outgoing.delete(r),o.error?e.reject(JSON.parse(o.error)):e.resolve(o.data)}}}self.dojoConfig=configuration.loaderConfig,esriConfig.workers.loaderUrl&&(self.importScripts(esriConfig.workers.loaderUrl),"function"==typeof require&&"function"==typeof require.config&&require.config(configuration.loaderConfig)),self.addEventListener("message",messageHandler),self.postMessage({type:0});';let $P,EP;const zZ="Failed to create Worker. Fallback to execute module in main thread";async function u2e(){if(!ae("esri-workers"))return VZ(new AP);if(!$P&&!EP)try{const e=c2e.replace('"{CONFIGURATION}"',`'${h2e()}'`);$P=URL.createObjectURL(new Blob([e],{type:"text/javascript"}))}catch(e){EP=e||{}}let t;if($P)try{t=new Worker($P,{name:"esri-worker-"+d2e++})}catch{qL.warn(zZ,EP),t=new AP}else qL.warn(zZ,EP),t=new AP;return VZ(t)}async function VZ(t){return new Promise(e=>{function i(s){const n=a2(s);n&&n.type===l2e&&(t.removeEventListener("message",i),t.removeEventListener("error",r),e(t))}function r(s){s.preventDefault(),t.removeEventListener("message",i),t.removeEventListener("error",r),qL.warn("Failed to create Worker. Fallback to execute module in main thread",s),(t=new AP).addEventListener("message",i),t.addEventListener("error",r)}t.addEventListener("message",i),t.addEventListener("error",r)})}function h2e(){let t;if(ei.default!=null){const s=E({},ei);delete s.default,t=JSON.parse(JSON.stringify(s))}else t=JSON.parse(JSON.stringify(ei));t.assetsPath=Ra(t.assetsPath),t.request.interceptors=[],t.log.interceptors=[],t.locale=La(),t.has={"esri-csp-restrictions":ae("esri-csp-restrictions"),"esri-2d-debug":!1,"esri-2d-update-debug":ae("esri-2d-update-debug"),"esri-2d-query-centroid-enabled":ae("esri-2d-query-centroid-enabled"),"featurelayer-pbf":ae("featurelayer-pbf"),"featurelayer-simplify-thresholds":ae("featurelayer-simplify-thresholds"),"featurelayer-simplify-payload-size-factors":ae("featurelayer-simplify-payload-size-factors"),"featurelayer-simplify-mobile-factor":ae("featurelayer-simplify-mobile-factor"),"esri-atomics":ae("esri-atomics"),"esri-shared-array-buffer":ae("esri-shared-array-buffer"),"esri-tiles-debug":ae("esri-tiles-debug"),"esri-workers-arraybuffer-transfer":ae("esri-workers-arraybuffer-transfer"),"host-webworker":1},t.workers.loaderUrl&&(t.workers.loaderUrl=Ra(t.workers.loaderUrl)),t.workers.workerPath?t.workers.workerPath=Ra(t.workers.workerPath):t.workers.workerPath=Ra(kt("esri/core/workers/RemoteClient.js"));const e=ei.workers.loaderConfig,i=o2e({baseUrl:e==null?void 0:e.baseUrl,locale:La(),has:E({"csp-restrictions":1,"dojo-test-sniff":0,"host-webworker":1},e==null?void 0:e.has),map:E({},e==null?void 0:e.map),paths:E({},e==null?void 0:e.paths),packages:(e==null?void 0:e.packages)||[]}),r={version:$q,buildDate:Pq,revision:Aq};return JSON.stringify({esriConfig:t,loaderConfig:i,kernelInfo:r})}let d2e=0;const p2e=le.getLogger("esri.core.workers"),{ABORT:NZ,INVOKE:f2e,OPEN:m2e,OPENED:g2e,RESPONSE:c2}=Vn;class HL{constructor(e,i){this._outJobs=new Map,this._inJobs=new Map,this.worker=e,this.id=i,e.addEventListener("message",this._onMessage.bind(this)),e.addEventListener("error",r=>{r.preventDefault(),p2e.error(r)})}static async create(e){const i=await u2e();return new HL(i,e)}terminate(){this.worker.terminate()}async open(e,i={}){const{signal:r}=i,s=PZ();return new Promise((n,o)=>{const a={resolve:n,reject:o,abortHandle:WC(r,()=>{this._outJobs.delete(s),this._post({type:NZ,jobId:s})})};this._outJobs.set(s,a),this._post({type:m2e,jobId:s,modulePath:e})})}_onMessage(e){const i=a2(e);if(i)switch(i.type){case g2e:this._onOpenedMessage(i);break;case c2:this._onResponseMessage(i);break;case NZ:this._onAbortMessage(i);break;case f2e:this._onInvokeMessage(i)}}_onAbortMessage(e){const i=this._inJobs,r=e.jobId,s=i.get(r);s&&(s.controller&&s.controller.abort(),i.delete(r))}_onInvokeMessage(e){const{methodName:i,jobId:r,data:s,abortable:n}=e,o=n?new AbortController:null,a=this._inJobs,l=a1e[i];let c;try{if(typeof l!="function")throw new TypeError(`${i} is not a function`);c=l.call(null,s,{signal:o?o.signal:null})}catch(h){return void this._post({type:c2,jobId:r,error:PP(h)})}fg(c)?(a.set(r,{controller:o,promise:c}),c.then(h=>{a.has(r)&&(a.delete(r),this._post({type:c2,jobId:r},h))},h=>{a.has(r)&&(a.delete(r),h||(h={message:"Error encountered at method"+i}),bi(h)||this._post({type:c2,jobId:r,error:PP(h||{message:`Error encountered at method ${i}`})}))})):this._post({type:c2,jobId:r},c)}_onOpenedMessage(e){var i;const{jobId:r,data:s}=e,n=this._outJobs.get(r);n&&(this._outJobs.delete(r),(i=n.abortHandle)==null||i.remove(),n.resolve(s))}_onResponseMessage(e){var i;const{jobId:r,error:s,data:n}=e,o=this._outJobs.get(r);o&&(this._outJobs.delete(r),(i=o.abortHandle)==null||i.remove(),s?o.reject(Q.fromJSON(JSON.parse(s))):o.resolve(n))}_post(e,i,r){return AZ(this.worker,e,i,r)}}let ny=ae("esri-workers-debug")?1:ae("host-browser")?navigator.hardwareConcurrency-1:0;ny||(ny=ae("safari")&&ae("mac")||ae("trident")?7:2);let UZ=0;const OP=[];function y2e(){BZ()}async function RP(t,e){const i=new Xxe;return await i.open(t,e),i}async function jZ(t,e={}){if(typeof t!="string")throw new Q("workers:undefined-module","modulePath is missing");let i=e.strategy||"distributed";if(ae("host-webworker")&&!ae("esri-workers")&&(i="local"),i==="local"){let r=await _o.loadWorker(t);r||(r=await import(t)),Dt(e.signal);const s=e.client||r;return RP([_o.connect(r)],he(E({},e),{client:s}))}if(await BZ(),Dt(e.signal),i==="dedicated"){const r=UZ++%ny;return RP([await OP[r].open(t,e)],e)}if(e.maxNumWorkers&&e.maxNumWorkers>0){const r=Math.min(e.maxNumWorkers,ny);if(r<ny){const s=new Array(r);for(let n=0;n<r;++n){const o=UZ++%ny;s[n]=OP[o].open(t,e)}return RP(s,e)}}return RP(OP.map(r=>r.open(t,e)),e)}let IP=null;async function BZ(){if(IP)return IP;new AbortController;const t=[];for(let e=0;e<ny;e++){const i=HL.create(e).then(r=>(OP[e]=r,r));t.push(i)}return IP=Promise.all(t),IP}function WL(t){return new Ue({wkt:`GEOCCS["Spherical geocentric",
    DATUM["Not specified",
      SPHEROID["Sphere",${t.radius},0]],
    PRIMEM["Greenwich",0.0,
      AUTHORITY["EPSG","8901"]],
    UNIT["m",1.0],
    AXIS["Geocentric X",OTHER],
    AXIS["Geocentric Y",EAST],
    AXIS["Geocentric Z",NORTH]
  ]`})}const ZL=WL(Lt),u2=WL(Ul),h2=WL(Xc),v2e=new Ue({wkt:`GEOCCS["WGS 84",
  DATUM["WGS_1984",
    SPHEROID["WGS 84",${Lt.radius},298.257223563,
      AUTHORITY["EPSG","7030"]],
    AUTHORITY["EPSG","6326"]],
  PRIMEM["Greenwich",0,
    AUTHORITY["EPSG","8901"]],
  UNIT["m",1.0,
    AUTHORITY["EPSG","9001"]],
  AXIS["Geocentric X",OTHER],
  AXIS["Geocentric Y",OTHER],
  AXIS["Geocentric Z",NORTH],
  AUTHORITY["EPSG","4978"]
]`});function jnt(t){return t&&t===Ul?u2:t&&t===Xc?h2:ZL}function DP(t){return t&&($h(t)||t===u2)?u2:t&&(Eh(t)||t===h2)?h2:ZL}function Ut(t){return t&&($h(t)||t===u2)?Ul:t&&(Eh(t)||t===h2)?Xc:Lt}function Bnt(t){return YD(t)?Ul:XD(t)?Xc:Lt}const GZ=39.37,_2e=Lt.radius*Math.PI/200,qZ=/UNIT\[([^\]]+)\]\]$/i,oy=I,HZ=/UNIT\[([^\]]+)\]/i,b2e=new Set([4261,4305,4807,4810,4811,4812,4816,4819,4821,4901,4902,37225,104139,104140]),w2e=Ds()({meter:"meters",foot:"feet",foot_us:"us-feet",foot_clarke:"clarke-feet",yard_clarke:"clarke-yards",link_clarke:"clarke-links",yard_sears:"sears-yards",foot_sears:"sears-feet",chain_sears:"sears-chains",chain_benoit_1895_b:"benoit-1895-b-chains",yard_indian:"indian-yards",yard_indian_1937:"indian-1937-yards",foot_gold_coast:"gold-coast-feet",chain_sears_1922_truncated:"sears-1922-truncated-chains","50_kilometers":"50-kilometers","150_kilometers":"150-kilometers"}),vu=t=>t*t,ef=t=>t*t*t,P1={length:{baseUnit:"meters",units:{millimeters:{inBaseUnits:.001},centimeters:{inBaseUnits:.01},decimeters:{inBaseUnits:.1},meters:{inBaseUnits:1},kilometers:{inBaseUnits:1e3},inches:{inBaseUnits:.0254},feet:{inBaseUnits:.3048},yards:{inBaseUnits:.9144},miles:{inBaseUnits:1609.344},"nautical-miles":{inBaseUnits:1852},"us-feet":{inBaseUnits:1200/3937}}},area:{baseUnit:"square-meters",units:{"square-millimeters":{inBaseUnits:vu(.001)},"square-centimeters":{inBaseUnits:vu(.01)},"square-decimeters":{inBaseUnits:vu(.1)},"square-meters":{inBaseUnits:1},"square-kilometers":{inBaseUnits:vu(1e3)},"square-inches":{inBaseUnits:vu(.0254)},"square-feet":{inBaseUnits:vu(.3048)},"square-yards":{inBaseUnits:vu(.9144)},"square-miles":{inBaseUnits:vu(1609.344)},"square-us-feet":{inBaseUnits:vu(1200/3937)},acres:{inBaseUnits:.0015625*vu(1609.344)},ares:{inBaseUnits:100},hectares:{inBaseUnits:1e4}}},volume:{baseUnit:"liters",units:{liters:{inBaseUnits:1},"cubic-millimeters":{inBaseUnits:1e3*ef(.001)},"cubic-centimeters":{inBaseUnits:1e3*ef(.01)},"cubic-decimeters":{inBaseUnits:1e3*ef(.1)},"cubic-meters":{inBaseUnits:1e3},"cubic-kilometers":{inBaseUnits:1e3*ef(1e3)},"cubic-inches":{inBaseUnits:1e3*ef(.0254)},"cubic-feet":{inBaseUnits:1e3*ef(.3048)},"cubic-yards":{inBaseUnits:1e3*ef(.9144)},"cubic-miles":{inBaseUnits:1e3*ef(1609.344)}}},angle:{baseUnit:"radians",units:{radians:{inBaseUnits:1},degrees:{inBaseUnits:Math.PI/180}}}},x2e=function(){const t={};for(const e in P1)for(const i in P1[e].units)t[i]=e;return t}();function S2e(t,e,i){return t*P1[i].units[e].inBaseUnits}function T2e(t,e,i){return t/P1[i].units[e].inBaseUnits}function FP(t){const e=x2e[t];if(e)return e;throw new Error("unknown measure")}function C2e(t){return P1[t].baseUnit}function Gnt(t){return C2e(FP(t))}function WZ(t,e=null){return e=e||FP(t),P1[e].baseUnit===t}function cr(t,e,i){if(e===i)return t;const r=FP(e);if(r!==FP(i))throw new Error("incompatible units");const s=WZ(e,r)?t:S2e(t,e,r);return WZ(i,r)?s:T2e(s,i,r)}function M2e(t,e){return cr(t,e,"meters")<3e3?"meters":"kilometers"}function P2e(t,e){return cr(t,e,"meters")<1e5?"meters":"kilometers"}function A2e(t,e){return cr(t,e,"feet")<1e3?"feet":"miles"}function $2e(t,e){return cr(t,e,"feet")<1e5?"feet":"miles"}function qnt(t,e){return cr(t,e,"square-meters")<3e6?"square-meters":"square-kilometers"}function Hnt(t,e){return cr(t,e,"square-feet")<1e6?"square-feet":"square-miles"}function E2e(t,e,i){return cr(t,e,"meters")/(i*Math.PI/180)}function ZZ(t){return w2e.fromJSON(t.toLowerCase())||null}function A1(t){if(t&&typeof t=="object"&&!yM(t))return 1;const e=bo(t);return e>1e5?1:e}function O2e(t){return bo(t)>=(t instanceof Ue?Ut(t).metersPerDegree:1e5)?"meters":YZ(t)}function bo(t,e=Lt.metersPerDegree){return R2e(t,!0)||e}function R2e(t,e=!1){let i,r,s=null;if(t!=null&&(typeof t=="object"?(i=t.wkid,r=t.wkt):typeof t=="number"?i=t:typeof t=="string"&&(r=t)),i){if(YD(i))return Ul.metersPerDegree;if(XD(i))return Xc.metersPerDegree;s=oy.values[oy[i]],!s&&e&&b2e.has(i)&&(s=_2e)}else r&&(KZ(r)?s=JZ(qZ.exec(r),s):XZ(r)&&(s=JZ(HZ.exec(r),s)));return s}function JZ(t,e){return t&&t[1]?QZ(t[1]):e}function QZ(t){return parseFloat(t.split(",")[1])}function YZ(t){let e,i,r=null;if(t!=null&&(typeof t=="object"?(e=t.wkid,i=t.wkt):typeof t=="number"?e=t:typeof t=="string"&&(i=t)),e)r=oy.units[oy[e]];else if(i){const s=KZ(i)?qZ:XZ(i)?HZ:null;if(s){const n=s.exec(i);n&&n[1]&&(r=D2e(n[1]))}}return _(r)?ZZ(r):null}function XZ(t){return/^GEOCCS/i.test(t)}function KZ(t){return/^PROJCS/i.test(t)}const I2e=1e-7;function D2e(t){const e=/[\\"\\']{1}([^\\"\\']+)/.exec(t);let i=e&&e[1];if(!i||oy.units.indexOf(i)===-1){const r=QZ(t);i=null;const s=oy.values;for(let n=0;n<s.length;++n)if(Math.abs(r-s[n])<I2e){i=oy.units[n];break}}return i}function Wnt(t){if(!t)return null;switch(YZ(t)){case"feet":case"us-feet":case"clarke-feet":case"clarke-yards":case"clarke-links":case"sears-yards":case"sears-feet":case"sears-chains":case"benoit-1895-b-chains":case"indian-yards":case"indian-1937-yards":case"gold-coast-feet":case"sears-1922-truncated-chains":return"imperial";case"50-kilometers":case"150-kilometers":case"meters":return"metric";case null:case void 0:return null}return null}const eJ={esriAcres:"acres",esriAres:"ares",esriHectares:"hectares",esriSquareCentimeters:"square-centimeters",esriSquareDecimeters:"square-decimeters",esriSquareFeet:"square-feet",esriSquareInches:"square-inches",esriSquareKilometers:"square-kilometers",esriSquareMeters:"square-meters",esriSquareMiles:"square-miles",esriSquareMillimeters:"square-millimeters",esriSquareUsFeet:"square-us-feet",esriSquareYards:"square-yards"},tJ={esriCentimeters:"centimeters",esriDecimeters:"decimeters",esriFeet:"feet",esriInches:"inches",esriKilometers:"kilometers",esriMeters:"meters",esriMiles:"miles",esriMillimeters:"millimeters",esriNauticalMiles:"nautical-miles",esriYards:"yards"},F2e=Ds()(eJ),L2e=Ds()(tJ);Ds()(E(E({},eJ),tJ));var d2;const LP=Ds()({orthometric:"gravity-related-height",gravity_related_height:"gravity-related-height",ellipsoidal:"ellipsoidal"}),iJ=LP.jsonValues.slice();PC(iJ,"orthometric");const p2=Ds()({meter:"meters",foot:"feet","us-foot":"us-feet","clarke-foot":"clarke-feet","clarke-yard":"clarke-yards","clarke-link":"clarke-links","sears-yard":"sears-yards","sears-foot":"sears-feet","sears-chain":"sears-chains","benoit-1895-b-chain":"benoit-1895-b-chains","indian-yard":"indian-yards","indian-1937-yard":"indian-1937-yards","gold-coast-foot":"gold-coast-feet","sears-1922-truncated-chain":"sears-1922-truncated-chains","50-kilometers":"50-kilometers","150-kilometers":"150-kilometers"});let tc=d2=class extends ge{constructor(t){super(t),this.heightModel="gravity-related-height",this.heightUnit="meters",this.vertCRS=null}writeHeightModel(t,e,i){return LP.write(t,e,i)}readHeightModel(t,e,i){return LP.read(t)||(i&&i.messages&&i.messages.push(k2e(t,{context:i})),null)}readHeightUnit(t,e,i){return p2.read(t)||(i&&i.messages&&i.messages.push(rJ(t,{context:i})),null)}readHeightUnitService(t,e,i){return ZZ(t)||p2.read(t)||(i&&i.messages&&i.messages.push(rJ(t,{context:i})),null)}readVertCRS(t,e){return e.vertCRS||e.ellipsoid||e.geoid}clone(){return new d2({heightModel:this.heightModel,heightUnit:this.heightUnit,vertCRS:this.vertCRS})}equals(t){return!!t&&(this===t||this.heightModel===t.heightModel&&this.heightUnit===t.heightUnit&&this.vertCRS===t.vertCRS)}static deriveUnitFromSR(t,e){const i=O2e(e);return new d2({heightModel:t.heightModel,heightUnit:i,vertCRS:t.vertCRS})}write(t,e){return e=E({origin:"web-scene"},e),super.write(t,e)}static fromJSON(t){if(!t)return null;const e=new d2;return e.read(t,{origin:"web-scene"}),e}};function rJ(t,e){return new Go("height-unit:unsupported",`Height unit of value '${t}' is not supported`,e)}function k2e(t,e){return new Go("height-model:unsupported",`Height model of value '${t}' is not supported`,e)}u([d({type:LP.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:iJ,default:"ellipsoidal"}}}})],tc.prototype,"heightModel",void 0),u([Ee("web-scene","heightModel")],tc.prototype,"writeHeightModel",null),u([Ce(["web-scene","service"],"heightModel")],tc.prototype,"readHeightModel",null),u([d({type:p2.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:p2.jsonValues,write:p2.write}}}})],tc.prototype,"heightUnit",void 0),u([Ce("web-scene","heightUnit")],tc.prototype,"readHeightUnit",null),u([Ce("service","heightUnit")],tc.prototype,"readHeightUnitService",null),u([d({type:String,constructOnly:!0,json:{origins:{"web-scene":{write:!0}}}})],tc.prototype,"vertCRS",void 0),u([Ce("service","vertCRS",["vertCRS","ellipsoid","geoid"])],tc.prototype,"readVertCRS",null),tc=d2=u([R("esri.geometry.HeightModelInfo")],tc);const ay=tc;function ji(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function _u(t,e,i,r,s,n,o,a,l,c,h,p,f,g,y,v,b){return t[0]=e,t[1]=i,t[2]=r,t[3]=s,t[4]=n,t[5]=o,t[6]=a,t[7]=l,t[8]=c,t[9]=h,t[10]=p,t[11]=f,t[12]=g,t[13]=y,t[14]=v,t[15]=b,t}function Di(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Nn(t,e){if(t===e){const i=e[1],r=e[2],s=e[3],n=e[6],o=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=i,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=n,t[11]=e[14],t[12]=s,t[13]=o,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function Fi(t,e){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],g=e[11],y=e[12],v=e[13],b=e[14],w=e[15],S=i*a-r*o,T=i*l-s*o,C=i*c-n*o,M=r*l-s*a,P=r*c-n*a,F=s*c-n*l,z=h*v-p*y,D=h*b-f*y,U=h*w-g*y,G=p*b-f*v,k=p*w-g*v,j=f*w-g*b;let V=S*j-T*k+C*G+M*U-P*D+F*z;return V?(V=1/V,t[0]=(a*j-l*k+c*G)*V,t[1]=(s*k-r*j-n*G)*V,t[2]=(v*F-b*P+w*M)*V,t[3]=(f*P-p*F-g*M)*V,t[4]=(l*U-o*j-c*D)*V,t[5]=(i*j-s*U+n*D)*V,t[6]=(b*C-y*F-w*T)*V,t[7]=(h*F-f*C+g*T)*V,t[8]=(o*k-a*U+c*z)*V,t[9]=(r*U-i*k-n*z)*V,t[10]=(y*P-v*C+w*S)*V,t[11]=(p*C-h*P-g*S)*V,t[12]=(a*D-o*G-l*z)*V,t[13]=(i*G-r*D+s*z)*V,t[14]=(v*T-y*M-b*S)*V,t[15]=(h*M-p*T+f*S)*V,t):null}function z2e(t,e){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],g=e[11],y=e[12],v=e[13],b=e[14],w=e[15];return t[0]=a*(f*w-g*b)-p*(l*w-c*b)+v*(l*g-c*f),t[1]=-(r*(f*w-g*b)-p*(s*w-n*b)+v*(s*g-n*f)),t[2]=r*(l*w-c*b)-a*(s*w-n*b)+v*(s*c-n*l),t[3]=-(r*(l*g-c*f)-a*(s*g-n*f)+p*(s*c-n*l)),t[4]=-(o*(f*w-g*b)-h*(l*w-c*b)+y*(l*g-c*f)),t[5]=i*(f*w-g*b)-h*(s*w-n*b)+y*(s*g-n*f),t[6]=-(i*(l*w-c*b)-o*(s*w-n*b)+y*(s*c-n*l)),t[7]=i*(l*g-c*f)-o*(s*g-n*f)+h*(s*c-n*l),t[8]=o*(p*w-g*v)-h*(a*w-c*v)+y*(a*g-c*p),t[9]=-(i*(p*w-g*v)-h*(r*w-n*v)+y*(r*g-n*p)),t[10]=i*(a*w-c*v)-o*(r*w-n*v)+y*(r*c-n*a),t[11]=-(i*(a*g-c*p)-o*(r*g-n*p)+h*(r*c-n*a)),t[12]=-(o*(p*b-f*v)-h*(a*b-l*v)+y*(a*f-l*p)),t[13]=i*(p*b-f*v)-h*(r*b-s*v)+y*(r*f-s*p),t[14]=-(i*(a*b-l*v)-o*(r*b-s*v)+y*(r*l-s*a)),t[15]=i*(a*f-l*p)-o*(r*f-s*p)+h*(r*l-s*a),t}function V2e(t){const e=t[0],i=t[1],r=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=t[9],p=t[10],f=t[11],g=t[12],y=t[13],v=t[14],b=t[15];return(e*o-i*n)*(p*b-f*v)-(e*a-r*n)*(h*b-f*y)+(e*l-s*n)*(h*v-p*y)+(i*a-r*o)*(c*b-f*g)-(i*l-s*o)*(c*v-p*g)+(r*l-s*a)*(c*y-h*g)}function wi(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=e[9],g=e[10],y=e[11],v=e[12],b=e[13],w=e[14],S=e[15];let T=i[0],C=i[1],M=i[2],P=i[3];return t[0]=T*r+C*a+M*p+P*v,t[1]=T*s+C*l+M*f+P*b,t[2]=T*n+C*c+M*g+P*w,t[3]=T*o+C*h+M*y+P*S,T=i[4],C=i[5],M=i[6],P=i[7],t[4]=T*r+C*a+M*p+P*v,t[5]=T*s+C*l+M*f+P*b,t[6]=T*n+C*c+M*g+P*w,t[7]=T*o+C*h+M*y+P*S,T=i[8],C=i[9],M=i[10],P=i[11],t[8]=T*r+C*a+M*p+P*v,t[9]=T*s+C*l+M*f+P*b,t[10]=T*n+C*c+M*g+P*w,t[11]=T*o+C*h+M*y+P*S,T=i[12],C=i[13],M=i[14],P=i[15],t[12]=T*r+C*a+M*p+P*v,t[13]=T*s+C*l+M*f+P*b,t[14]=T*n+C*c+M*g+P*w,t[15]=T*o+C*h+M*y+P*S,t}function Vs(t,e,i){const r=i[0],s=i[1],n=i[2];let o,a,l,c,h,p,f,g,y,v,b,w;return e===t?(t[12]=e[0]*r+e[4]*s+e[8]*n+e[12],t[13]=e[1]*r+e[5]*s+e[9]*n+e[13],t[14]=e[2]*r+e[6]*s+e[10]*n+e[14],t[15]=e[3]*r+e[7]*s+e[11]*n+e[15]):(o=e[0],a=e[1],l=e[2],c=e[3],h=e[4],p=e[5],f=e[6],g=e[7],y=e[8],v=e[9],b=e[10],w=e[11],t[0]=o,t[1]=a,t[2]=l,t[3]=c,t[4]=h,t[5]=p,t[6]=f,t[7]=g,t[8]=y,t[9]=v,t[10]=b,t[11]=w,t[12]=o*r+h*s+y*n+e[12],t[13]=a*r+p*s+v*n+e[13],t[14]=l*r+f*s+b*n+e[14],t[15]=c*r+g*s+w*n+e[15]),t}function kP(t,e,i){const r=i[0],s=i[1],n=i[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Bi(t,e,i,r){let s,n,o,a,l,c,h,p,f,g,y,v,b,w,S,T,C,M,P,F,z,D,U,G,k=r[0],j=r[1],V=r[2],q=Math.sqrt(k*k+j*j+V*V);return q<it?null:(q=1/q,k*=q,j*=q,V*=q,s=Math.sin(i),n=Math.cos(i),o=1-n,a=e[0],l=e[1],c=e[2],h=e[3],p=e[4],f=e[5],g=e[6],y=e[7],v=e[8],b=e[9],w=e[10],S=e[11],T=k*k*o+n,C=j*k*o+V*s,M=V*k*o-j*s,P=k*j*o-V*s,F=j*j*o+n,z=V*j*o+k*s,D=k*V*o+j*s,U=j*V*o-k*s,G=V*V*o+n,t[0]=a*T+p*C+v*M,t[1]=l*T+f*C+b*M,t[2]=c*T+g*C+w*M,t[3]=h*T+y*C+S*M,t[4]=a*P+p*F+v*z,t[5]=l*P+f*F+b*z,t[6]=c*P+g*F+w*z,t[7]=h*P+y*F+S*z,t[8]=a*D+p*U+v*G,t[9]=l*D+f*U+b*G,t[10]=c*D+g*U+w*G,t[11]=h*D+y*U+S*G,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function $1(t,e,i){const r=Math.sin(i),s=Math.cos(i),n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=e[9],p=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*s+c*r,t[5]=o*s+h*r,t[6]=a*s+p*r,t[7]=l*s+f*r,t[8]=c*s-n*r,t[9]=h*s-o*r,t[10]=p*s-a*r,t[11]=f*s-l*r,t}function zP(t,e,i){const r=Math.sin(i),s=Math.cos(i),n=e[0],o=e[1],a=e[2],l=e[3],c=e[8],h=e[9],p=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*s-c*r,t[1]=o*s-h*r,t[2]=a*s-p*r,t[3]=l*s-f*r,t[8]=n*r+c*s,t[9]=o*r+h*s,t[10]=a*r+p*s,t[11]=l*r+f*s,t}function ly(t,e,i){const r=Math.sin(i),s=Math.cos(i),n=e[0],o=e[1],a=e[2],l=e[3],c=e[4],h=e[5],p=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*s+c*r,t[1]=o*s+h*r,t[2]=a*s+p*r,t[3]=l*s+f*r,t[4]=c*s-n*r,t[5]=h*s-o*r,t[6]=p*s-a*r,t[7]=f*s-l*r,t}function sJ(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function N2e(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function U2e(t,e,i){let r,s,n,o=i[0],a=i[1],l=i[2],c=Math.sqrt(o*o+a*a+l*l);return c<it?null:(c=1/c,o*=c,a*=c,l*=c,r=Math.sin(e),s=Math.cos(e),n=1-s,t[0]=o*o*n+s,t[1]=a*o*n+l*r,t[2]=l*o*n-a*r,t[3]=0,t[4]=o*a*n-l*r,t[5]=a*a*n+s,t[6]=l*a*n+o*r,t[7]=0,t[8]=o*l*n+a*r,t[9]=a*l*n-o*r,t[10]=l*l*n+s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function nJ(t,e){const i=Math.sin(e),r=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=i,t[7]=0,t[8]=0,t[9]=-i,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function j2e(t,e){const i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=0,t[2]=-i,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=i,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function B2e(t,e){const i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=i,t[2]=0,t[3]=0,t[4]=-i,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function oJ(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=r+r,l=s+s,c=n+n,h=r*a,p=r*l,f=r*c,g=s*l,y=s*c,v=n*c,b=o*a,w=o*l,S=o*c;return t[0]=1-(g+v),t[1]=p+S,t[2]=f-w,t[3]=0,t[4]=p-S,t[5]=1-(h+v),t[6]=y+b,t[7]=0,t[8]=f+w,t[9]=y-b,t[10]=1-(h+g),t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}function G2e(t,e){const i=q2e,r=-e[0],s=-e[1],n=-e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=r*r+s*s+n*n+o*o;return p>0?(i[0]=2*(a*o+h*r+l*n-c*s)/p,i[1]=2*(l*o+h*s+c*r-a*n)/p,i[2]=2*(c*o+h*n+a*s-l*r)/p):(i[0]=2*(a*o+h*r+l*n-c*s),i[1]=2*(l*o+h*s+c*r-a*n),i[2]=2*(c*o+h*n+a*s-l*r)),oJ(t,e,i),t}const q2e=$();function H2e(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function W2e(t,e){const i=e[0],r=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],c=e[9],h=e[10];return t[0]=Math.sqrt(i*i+r*r+s*s),t[1]=Math.sqrt(n*n+o*o+a*a),t[2]=Math.sqrt(l*l+c*c+h*h),t}function Z2e(t,e){const i=e[0]+e[5]+e[10];let r=0;return i>0?(r=2*Math.sqrt(i+1),t[3]=.25*r,t[0]=(e[6]-e[9])/r,t[1]=(e[8]-e[2])/r,t[2]=(e[1]-e[4])/r):e[0]>e[5]&&e[0]>e[10]?(r=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/r,t[0]=.25*r,t[1]=(e[1]+e[4])/r,t[2]=(e[8]+e[2])/r):e[5]>e[10]?(r=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/r,t[0]=(e[1]+e[4])/r,t[1]=.25*r,t[2]=(e[6]+e[9])/r):(r=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/r,t[0]=(e[8]+e[2])/r,t[1]=(e[6]+e[9])/r,t[2]=.25*r),t}function J2e(t,e,i,r){const s=e[0],n=e[1],o=e[2],a=e[3],l=s+s,c=n+n,h=o+o,p=s*l,f=s*c,g=s*h,y=n*c,v=n*h,b=o*h,w=a*l,S=a*c,T=a*h,C=r[0],M=r[1],P=r[2];return t[0]=(1-(y+b))*C,t[1]=(f+T)*C,t[2]=(g-S)*C,t[3]=0,t[4]=(f-T)*M,t[5]=(1-(p+b))*M,t[6]=(v+w)*M,t[7]=0,t[8]=(g+S)*P,t[9]=(v-w)*P,t[10]=(1-(p+y))*P,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}function Q2e(t,e,i,r,s){const n=e[0],o=e[1],a=e[2],l=e[3],c=n+n,h=o+o,p=a+a,f=n*c,g=n*h,y=n*p,v=o*h,b=o*p,w=a*p,S=l*c,T=l*h,C=l*p,M=r[0],P=r[1],F=r[2],z=s[0],D=s[1],U=s[2],G=(1-(v+w))*M,k=(g+C)*M,j=(y-T)*M,V=(g-C)*P,q=(1-(f+w))*P,J=(b+S)*P,O=(y+T)*F,L=(b-S)*F,N=(1-(f+v))*F;return t[0]=G,t[1]=k,t[2]=j,t[3]=0,t[4]=V,t[5]=q,t[6]=J,t[7]=0,t[8]=O,t[9]=L,t[10]=N,t[11]=0,t[12]=i[0]+z-(G*z+V*D+O*U),t[13]=i[1]+D-(k*z+q*D+L*U),t[14]=i[2]+U-(j*z+J*D+N*U),t[15]=1,t}function Y2e(t,e){const i=e[0],r=e[1],s=e[2],n=e[3],o=i+i,a=r+r,l=s+s,c=i*o,h=r*o,p=r*a,f=s*o,g=s*a,y=s*l,v=n*o,b=n*a,w=n*l;return t[0]=1-p-y,t[1]=h+w,t[2]=f-b,t[3]=0,t[4]=h-w,t[5]=1-c-y,t[6]=g+v,t[7]=0,t[8]=f+b,t[9]=g-v,t[10]=1-c-p,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function aJ(t,e,i,r,s,n,o){const a=1/(i-e),l=1/(s-r),c=1/(n-o);return t[0]=2*n*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*l,t[6]=0,t[7]=0,t[8]=(i+e)*a,t[9]=(s+r)*l,t[10]=(o+n)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*n*2*c,t[15]=0,t}function X2e(t,e,i,r,s){const n=1/Math.tan(e/2);let o;return t[0]=n/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,s!=null&&s!==1/0?(o=1/(r-s),t[10]=(s+r)*o,t[14]=2*s*r*o):(t[10]=-1,t[14]=-2*r),t}function K2e(t,e,i,r){const s=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),l=2/(o+a),c=2/(s+n);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=-(o-a)*l*.5,t[9]=(s-n)*c*.5,t[10]=r/(i-r),t[11]=-1,t[12]=0,t[13]=0,t[14]=r*i/(i-r),t[15]=0,t}function JL(t,e,i,r,s,n,o){const a=1/(e-i),l=1/(r-s),c=1/(n-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+i)*a,t[13]=(s+r)*l,t[14]=(o+n)*c,t[15]=1,t}function VP(t,e,i,r){let s,n,o,a,l,c,h,p,f,g;const y=e[0],v=e[1],b=e[2],w=r[0],S=r[1],T=r[2],C=i[0],M=i[1],P=i[2];return Math.abs(y-C)<it&&Math.abs(v-M)<it&&Math.abs(b-P)<it?Di(t):(h=y-C,p=v-M,f=b-P,g=1/Math.sqrt(h*h+p*p+f*f),h*=g,p*=g,f*=g,s=S*f-T*p,n=T*h-w*f,o=w*p-S*h,g=Math.sqrt(s*s+n*n+o*o),g?(g=1/g,s*=g,n*=g,o*=g):(s=0,n=0,o=0),a=p*o-f*n,l=f*s-h*o,c=h*n-p*s,g=Math.sqrt(a*a+l*l+c*c),g?(g=1/g,a*=g,l*=g,c*=g):(a=0,l=0,c=0),t[0]=s,t[1]=a,t[2]=h,t[3]=0,t[4]=n,t[5]=l,t[6]=p,t[7]=0,t[8]=o,t[9]=c,t[10]=f,t[11]=0,t[12]=-(s*y+n*v+o*b),t[13]=-(a*y+l*v+c*b),t[14]=-(h*y+p*v+f*b),t[15]=1,t)}function lJ(t,e,i,r){const s=e[0],n=e[1],o=e[2],a=r[0],l=r[1],c=r[2];let h=s-i[0],p=n-i[1],f=o-i[2],g=h*h+p*p+f*f;g>0&&(g=1/Math.sqrt(g),h*=g,p*=g,f*=g);let y=l*f-c*p,v=c*h-a*f,b=a*p-l*h;return g=y*y+v*v+b*b,g>0&&(g=1/Math.sqrt(g),y*=g,v*=g,b*=g),t[0]=y,t[1]=v,t[2]=b,t[3]=0,t[4]=p*b-f*v,t[5]=f*y-h*b,t[6]=h*v-p*y,t[7]=0,t[8]=h,t[9]=p,t[10]=f,t[11]=0,t[12]=s,t[13]=n,t[14]=o,t[15]=1,t}function eSe(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function tSe(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+t[6]**2+t[7]**2+t[8]**2+t[9]**2+t[10]**2+t[11]**2+t[12]**2+t[13]**2+t[14]**2+t[15]**2)}function iSe(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t[8]=e[8]+i[8],t[9]=e[9]+i[9],t[10]=e[10]+i[10],t[11]=e[11]+i[11],t[12]=e[12]+i[12],t[13]=e[13]+i[13],t[14]=e[14]+i[14],t[15]=e[15]+i[15],t}function cJ(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t[6]=e[6]-i[6],t[7]=e[7]-i[7],t[8]=e[8]-i[8],t[9]=e[9]-i[9],t[10]=e[10]-i[10],t[11]=e[11]-i[11],t[12]=e[12]-i[12],t[13]=e[13]-i[13],t[14]=e[14]-i[14],t[15]=e[15]-i[15],t}function rSe(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12]*i,t[13]=e[13]*i,t[14]=e[14]*i,t[15]=e[15]*i,t}function sSe(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t[4]=e[4]+i[4]*r,t[5]=e[5]+i[5]*r,t[6]=e[6]+i[6]*r,t[7]=e[7]+i[7]*r,t[8]=e[8]+i[8]*r,t[9]=e[9]+i[9]*r,t[10]=e[10]+i[10]*r,t[11]=e[11]+i[11]*r,t[12]=e[12]+i[12]*r,t[13]=e[13]+i[13]*r,t[14]=e[14]+i[14]*r,t[15]=e[15]+i[15]*r,t}function nSe(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function QL(t,e){if(t===e)return!0;const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],g=t[11],y=t[12],v=t[13],b=t[14],w=t[15],S=e[0],T=e[1],C=e[2],M=e[3],P=e[4],F=e[5],z=e[6],D=e[7],U=e[8],G=e[9],k=e[10],j=e[11],V=e[12],q=e[13],J=e[14],O=e[15];return Math.abs(i-S)<=it*Math.max(1,Math.abs(i),Math.abs(S))&&Math.abs(r-T)<=it*Math.max(1,Math.abs(r),Math.abs(T))&&Math.abs(s-C)<=it*Math.max(1,Math.abs(s),Math.abs(C))&&Math.abs(n-M)<=it*Math.max(1,Math.abs(n),Math.abs(M))&&Math.abs(o-P)<=it*Math.max(1,Math.abs(o),Math.abs(P))&&Math.abs(a-F)<=it*Math.max(1,Math.abs(a),Math.abs(F))&&Math.abs(l-z)<=it*Math.max(1,Math.abs(l),Math.abs(z))&&Math.abs(c-D)<=it*Math.max(1,Math.abs(c),Math.abs(D))&&Math.abs(h-U)<=it*Math.max(1,Math.abs(h),Math.abs(U))&&Math.abs(p-G)<=it*Math.max(1,Math.abs(p),Math.abs(G))&&Math.abs(f-k)<=it*Math.max(1,Math.abs(f),Math.abs(k))&&Math.abs(g-j)<=it*Math.max(1,Math.abs(g),Math.abs(j))&&Math.abs(y-V)<=it*Math.max(1,Math.abs(y),Math.abs(V))&&Math.abs(v-q)<=it*Math.max(1,Math.abs(v),Math.abs(q))&&Math.abs(b-J)<=it*Math.max(1,Math.abs(b),Math.abs(J))&&Math.abs(w-O)<=it*Math.max(1,Math.abs(w),Math.abs(O))}function YL(t){const e=it,i=t[0],r=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],h=t[10];return Math.abs(1-(i*i+n*n+l*l))<=e&&Math.abs(1-(r*r+o*o+c*c))<=e&&Math.abs(1-(s*s+a*a+h*h))<=e}const oSe=wi,aSe=cJ;Object.freeze({__proto__:null,copy:ji,set:_u,identity:Di,transpose:Nn,invert:Fi,adjoint:z2e,determinant:V2e,multiply:wi,translate:Vs,scale:kP,rotate:Bi,rotateX:$1,rotateY:zP,rotateZ:ly,fromTranslation:sJ,fromScaling:N2e,fromRotation:U2e,fromXRotation:nJ,fromYRotation:j2e,fromZRotation:B2e,fromRotationTranslation:oJ,fromQuat2:G2e,getTranslation:H2e,getScaling:W2e,getRotation:Z2e,fromRotationTranslationScale:J2e,fromRotationTranslationScaleOrigin:Q2e,fromQuat:Y2e,frustum:aJ,perspective:X2e,perspectiveFromFieldOfView:K2e,ortho:JL,lookAt:VP,targetTo:lJ,str:eSe,frob:tSe,add:iSe,subtract:cJ,multiplyScalar:rSe,multiplyScalarAndAdd:sSe,exactEquals:nSe,equals:QL,isOrthoNormal:YL,mul:oSe,sub:aSe});let XL,te=null;function uJ(){return!!te}function lSe(){return!!ae("esri-wasm")}function hJ(){return XL||(XL=import("./pe-wasm.bbd7a0c0.js").then(t=>t.p).then(({default:t})=>t({locateFile:e=>kt(`esri/geometry/support/${e}`)})).then(t=>{pJ(t)}),XL)}var KL,Gi,e6;(function(t){function e(n,o,a){te.ensureCache.prepare();const l=cy(a),c=a===l,h=te.ensureFloat64(l),p=te._pe_geog_to_proj(te.getPointer(n),o,h);return p&&tf(a,o,h,c),p}function i(n,o,a,l){switch(l){case Gi.PE_TRANSFORM_P_TO_G:return r(n,o,a);case Gi.PE_TRANSFORM_G_TO_P:return e(n,o,a)}return 0}function r(n,o,a){return s(n,o,a,0)}function s(n,o,a,l){te.ensureCache.prepare();const c=cy(a),h=a===c,p=te.ensureFloat64(c),f=te._pe_proj_to_geog_center(te.getPointer(n),o,p,l);return f&&tf(a,o,p,h),f}t.geogToProj=e,t.projGeog=i,t.projToGeog=r,t.projToGeogCenter=s})(KL||(KL={})),function(t){function e(){t.PE_BUFFER_MAX=te.PeDefs.prototype.PE_BUFFER_MAX,t.PE_NAME_MAX=te.PeDefs.prototype.PE_NAME_MAX,t.PE_MGRS_MAX=te.PeDefs.prototype.PE_MGRS_MAX,t.PE_USNG_MAX=te.PeDefs.prototype.PE_USNG_MAX,t.PE_DD_MAX=te.PeDefs.prototype.PE_DD_MAX,t.PE_DDM_MAX=te.PeDefs.prototype.PE_DDM_MAX,t.PE_DMS_MAX=te.PeDefs.prototype.PE_DMS_MAX,t.PE_UTM_MAX=te.PeDefs.prototype.PE_UTM_MAX,t.PE_PARM_MAX=te.PeDefs.prototype.PE_PARM_MAX,t.PE_TYPE_NONE=te.PeDefs.prototype.PE_TYPE_NONE,t.PE_TYPE_GEOGCS=te.PeDefs.prototype.PE_TYPE_GEOGCS,t.PE_TYPE_PROJCS=te.PeDefs.prototype.PE_TYPE_PROJCS,t.PE_TYPE_GEOGTRAN=te.PeDefs.prototype.PE_TYPE_GEOGTRAN,t.PE_TYPE_COORDSYS=te.PeDefs.prototype.PE_TYPE_COORDSYS,t.PE_TYPE_UNIT=te.PeDefs.prototype.PE_TYPE_UNIT,t.PE_TYPE_LINUNIT=te.PeDefs.prototype.PE_TYPE_LINUNIT,t.PE_STR_OPTS_NONE=te.PeDefs.prototype.PE_STR_OPTS_NONE,t.PE_STR_AUTH_NONE=te.PeDefs.prototype.PE_STR_AUTH_NONE,t.PE_STR_AUTH_TOP=te.PeDefs.prototype.PE_STR_AUTH_TOP,t.PE_STR_NAME_CANON=te.PeDefs.prototype.PE_STR_NAME_CANON,t.PE_PARM_X0=te.PeDefs.prototype.PE_PARM_X0,t.PE_PARM_ND=te.PeDefs.prototype.PE_PARM_ND,t.PE_TRANSFORM_1_TO_2=te.PeDefs.prototype.PE_TRANSFORM_1_TO_2,t.PE_TRANSFORM_2_TO_1=te.PeDefs.prototype.PE_TRANSFORM_2_TO_1,t.PE_TRANSFORM_P_TO_G=te.PeDefs.prototype.PE_TRANSFORM_P_TO_G,t.PE_TRANSFORM_G_TO_P=te.PeDefs.prototype.PE_TRANSFORM_G_TO_P,t.PE_HORIZON_RECT=te.PeDefs.prototype.PE_HORIZON_RECT,t.PE_HORIZON_POLY=te.PeDefs.prototype.PE_HORIZON_POLY,t.PE_HORIZON_LINE=te.PeDefs.prototype.PE_HORIZON_LINE,t.PE_HORIZON_DELTA=te.PeDefs.prototype.PE_HORIZON_DELTA}t.init=e}(Gi||(Gi={})),function(t){const e={},i={},r=g=>{if(g){const y=g.getType();switch(y){case Gi.PE_TYPE_GEOGCS:g=te.castObject(g,te.PeGeogcs);break;case Gi.PE_TYPE_PROJCS:g=te.castObject(g,te.PeProjcs);break;case Gi.PE_TYPE_GEOGTRAN:g=te.castObject(g,te.PeGeogtran);break;default:y&Gi.PE_TYPE_UNIT&&(g=te.castObject(g,te.PeUnit))}}return g};function s(){te.PeFactory.prototype.initialize(null)}function n(g){return o(Gi.PE_TYPE_COORDSYS,g)}function o(g,y){let v=null,b=e[g];if(b||(b={},e[g]=b),b.hasOwnProperty(String(y)))v=b[y];else{const w=te.PeFactory.prototype.factoryByType(g,y);te.compare(w,te.NULL)||(v=w,b[y]=v)}return v=r(v),v}function a(g,y){let v=null,b=i[g];if(b||(b={},i[g]=b),b.hasOwnProperty(y))v=b[y];else{const w=te.PeFactory.prototype.fromString(g,y);te.compare(w,te.NULL)||(v=w,b[y]=v)}return v=r(v),v}function l(g){return o(Gi.PE_TYPE_GEOGCS,g)}function c(g){return o(Gi.PE_TYPE_GEOGTRAN,g)}function h(g){return te.PeFactory.prototype.getCode(g)}function p(g){return o(Gi.PE_TYPE_PROJCS,g)}function f(g){return o(Gi.PE_TYPE_UNIT,g)}t.initialize=s,t.coordsys=n,t.factoryByType=o,t.fromString=a,t.geogcs=l,t.geogtran=c,t.getCode=h,t.projcs=p,t.unit=f}(e6||(e6={}));let dJ=null;var NP,t6,i6,r6,UP,s6,jP,BP,n6;function pJ(t){function e(n,o,a){n[o]=a(n[o])}te=t,Gi.init(),NP.init(),UP.init(),jP.init(),BP.init(),dJ=class extends te.PeGCSExtent{destroy(){te.destroy(this)}};const i=[te.PeDatum,te.PeGeogcs,te.PeGeogtran,te.PeObject,te.PeParameter,te.PePrimem,te.PeProjcs,te.PeSpheroid,te.PeUnit];for(const n of i)e(n.prototype,"getName",o=>function(){return o.call(this,new Array(Gi.PE_NAME_MAX))});for(const n of[te.PeGeogtran,te.PeProjcs])e(n.prototype,"getParameters",o=>function(){const a=new Array(Gi.PE_PARM_MAX);let l=o.call(this);for(let c=0;c<a.length;c++){const h=te.getValue(l,"*");a[c]=h?te.wrapPointer(h,te.PeParameter):null,l+=Int32Array.BYTES_PER_ELEMENT}return a});e(te.PeHorizon.prototype,"getCoord",n=>function(){const o=this.getSize();if(!o)return null;const a=[];return tf(a,o,n.call(this)),a}),e(te.PeGTlistExtendedEntry.prototype,"getEntries",n=>{const o=te._pe_getPeGTlistExtendedGTsSize();return function(){let a=null;const l=n.call(this);if(!te.compare(l,te.NULL)){a=[l];const c=this.getSteps();if(c>1){const h=te.getPointer(l);for(let p=1;p<c;p++)a.push(te.wrapPointer(h+o*p,te.PeGTlistExtendedGTs))}}return a}});const r=te._pe_getPeHorizonSize(),s=n=>function(){let o=this._cache;if(o||(o=new Map,this._cache=o),o.has(n))return o.get(n);let a=null;const l=n.call(this);if(!te.compare(l,te.NULL)){a=[l];const c=l.getNump();if(c>1){const h=te.getPointer(l);for(let p=1;p<c;p++)a.push(te.wrapPointer(h+r*p,te.PeHorizon))}}return o.set(n,a),a};e(te.PeProjcs.prototype,"horizonGcsGenerate",s),e(te.PeProjcs.prototype,"horizonPcsGenerate",s),te.PeObject.prototype.toString=function(n=Gi.PE_STR_OPTS_NONE){te.ensureCache.prepare();const o=te.getPointer(this),a=te.ensureInt8(new Array(Gi.PE_BUFFER_MAX));return te.UTF8ToString(te._pe_object_to_string_ext(o,n,a))}}function Qh(t){if(!t)return;const e=te.getClass(t);if(!e)return;const i=te.getCache(e);if(!i)return;const r=te.getPointer(t);r&&delete i[r]}function GP(t,e){const i=[],r=new Array(e);for(let s=0;s<t;s++)i.push(te.ensureInt8(r));return i}function cy(t){let e;return Array.isArray(t[0])?(e=[],t.forEach(i=>{e.push(i[0],i[1])})):e=t,e}function tf(t,e,i,r=!1){if(r)for(let s=0;s<2*e;s++)t[s]=te.getValue(i+s*Float64Array.BYTES_PER_ELEMENT,"double");else{const s=t.length===0;for(let n=0;n<e;n++)s&&(t[n]=new Array(2)),t[n][0]=te.getValue(i,"double"),t[n][1]=te.getValue(i+Float64Array.BYTES_PER_ELEMENT,"double"),i+=2*Float64Array.BYTES_PER_ELEMENT}}(function(t){let e;function i(){t.PE_GTLIST_OPTS_COMMON=te.PeGTlistExtended.prototype.PE_GTLIST_OPTS_COMMON,e=te._pe_getPeGTlistExtendedEntrySize()}function r(s,n,o,a,l,c){let h=null;const p=new te.PeInteger(c);try{const f=te.PeGTlistExtended.prototype.getGTlist(s,n,o,a,l,p);if((c=p.val)&&(h=[f],c>1)){const g=te.getPointer(f);for(let y=1;y<c;y++)h.push(te.wrapPointer(g+e*y,te.PeGTlistExtendedEntry))}}finally{te.destroy(p)}return h}t.init=i,t.getGTlist=r})(NP||(NP={})),function(t){function e(i){if(i&&i.length){for(const r of i)Qh(r),r.getEntries().forEach(s=>{Qh(s);const n=s.getGeogtran();Qh(n),n.getParameters().forEach(Qh),[n.getGeogcs1(),n.getGeogcs2()].forEach(o=>{Qh(o);const a=o.getDatum();Qh(a),Qh(a.getSpheroid()),Qh(o.getPrimem()),Qh(o.getUnit())})});te.PeGTlistExtendedEntry.prototype.Delete(i[0])}}t.destroy=e}(t6||(t6={})),function(t){function e(i,r,s,n,o){te.ensureCache.prepare();const a=cy(s),l=s===a,c=te.ensureFloat64(a);let h=0;n&&(h=te.ensureFloat64(n));const p=te._pe_geog_to_geog(te.getPointer(i),r,c,h,o);return p&&tf(s,r,c,l),p}t.geogToGeog=e}(i6||(i6={})),function(t){const e=(c,h,p,f,g,y)=>{let v,b;switch(te.ensureCache.prepare(),c){case"dd":v=te._pe_geog_to_dd,b=Gi.PE_DD_MAX;break;case"ddm":v=te._pe_geog_to_ddm,b=Gi.PE_DDM_MAX;break;case"dms":v=te._pe_geog_to_dms,b=Gi.PE_DMS_MAX}let w=0;h&&(w=te.getPointer(h));const S=cy(f),T=te.ensureFloat64(S),C=GP(p,b),M=v(w,p,T,g,te.ensureInt32(C));if(M)for(let P=0;P<p;P++)y[P]=te.UTF8ToString(C[P]);return M},i=(c,h,p,f,g)=>{let y;switch(te.ensureCache.prepare(),c){case"dd":y=te._pe_dd_to_geog;break;case"ddm":y=te._pe_ddm_to_geog;break;case"dms":y=te._pe_dms_to_geog}let v=0;h&&(v=te.getPointer(h));const b=f.map(C=>te.ensureString(C)),w=te.ensureInt32(b),S=te.ensureFloat64(new Array(2*p)),T=y(v,p,w,S);return T&&tf(g,p,S),T};function r(c,h,p,f,g){return e("dms",c,h,p,f,g)}function s(c,h,p,f){return i("dms",c,h,p,f)}function n(c,h,p,f,g){return e("ddm",c,h,p,f,g)}function o(c,h,p,f){return i("ddm",c,h,p,f)}function a(c,h,p,f,g){return e("dd",c,h,p,f,g)}function l(c,h,p,f){return i("dd",c,h,p,f)}t.geog_to_dms=r,t.dms_to_geog=s,t.geog_to_ddm=n,t.ddm_to_geog=o,t.geog_to_dd=a,t.dd_to_geog=l}(r6||(r6={})),function(t){function e(){t.PE_MGRS_STYLE_NEW=te.PeNotationMgrs.prototype.PE_MGRS_STYLE_NEW,t.PE_MGRS_STYLE_OLD=te.PeNotationMgrs.prototype.PE_MGRS_STYLE_OLD,t.PE_MGRS_STYLE_AUTO=te.PeNotationMgrs.prototype.PE_MGRS_STYLE_AUTO,t.PE_MGRS_180_ZONE_1_PLUS=te.PeNotationMgrs.prototype.PE_MGRS_180_ZONE_1_PLUS,t.PE_MGRS_ADD_SPACES=te.PeNotationMgrs.prototype.PE_MGRS_ADD_SPACES}function i(s,n,o,a,l,c,h){te.ensureCache.prepare();let p=0;s&&(p=te.getPointer(s));const f=cy(o),g=te.ensureFloat64(f),y=GP(n,Gi.PE_MGRS_MAX),v=te.ensureInt32(y),b=te._pe_geog_to_mgrs_extended(p,n,g,a,l,c,v);if(b)for(let w=0;w<n;w++)h[w]=te.UTF8ToString(y[w]);return b}function r(s,n,o,a,l){te.ensureCache.prepare();let c=0;s&&(c=te.getPointer(s));const h=o.map(y=>te.ensureString(y)),p=te.ensureInt32(h),f=te.ensureFloat64(new Array(2*n)),g=te._pe_mgrs_to_geog_extended(c,n,p,a,f);return g&&tf(l,n,f),g}t.init=e,t.geog_to_mgrs_extended=i,t.mgrs_to_geog_extended=r}(UP||(UP={})),function(t){function e(r,s,n,o,a,l,c){te.ensureCache.prepare();let h=0;r&&(h=te.getPointer(r));const p=cy(n),f=te.ensureFloat64(p),g=GP(s,Gi.PE_MGRS_MAX),y=te.ensureInt32(g),v=te._pe_geog_to_usng(h,s,f,o,a,l,y);if(v)for(let b=0;b<s;b++)c[b]=te.UTF8ToString(g[b]);return v}function i(r,s,n,o){te.ensureCache.prepare();let a=0;r&&(a=te.getPointer(r));const l=n.map(f=>te.ensureString(f)),c=te.ensureInt32(l),h=te.ensureFloat64(new Array(2*s)),p=te._pe_usng_to_geog(a,s,c,h);return p&&tf(o,s,h),p}t.geog_to_usng=e,t.usng_to_geog=i}(s6||(s6={})),function(t){function e(){t.PE_UTM_OPTS_NONE=te.PeNotationUtm.prototype.PE_UTM_OPTS_NONE,t.PE_UTM_OPTS_ADD_SPACES=te.PeNotationUtm.prototype.PE_UTM_OPTS_ADD_SPACES,t.PE_UTM_OPTS_NS=te.PeNotationUtm.prototype.PE_UTM_OPTS_NS}function i(s,n,o,a,l){te.ensureCache.prepare();let c=0;s&&(c=te.getPointer(s));const h=cy(o),p=te.ensureFloat64(h),f=GP(n,Gi.PE_UTM_MAX),g=te.ensureInt32(f),y=te._pe_geog_to_utm(c,n,p,a,g);if(y)for(let v=0;v<n;v++)l[v]=te.UTF8ToString(f[v]);return y}function r(s,n,o,a,l){te.ensureCache.prepare();let c=0;s&&(c=te.getPointer(s));const h=o.map(y=>te.ensureString(y)),p=te.ensureInt32(h),f=te.ensureFloat64(new Array(2*n)),g=te._pe_utm_to_geog(c,n,p,a,f);return g&&tf(l,n,f),g}t.init=e,t.geog_to_utm=i,t.utm_to_geog=r}(jP||(jP={})),function(t){const e=new Map;function i(){t.PE_PCSINFO_OPTION_NONE=te.PePCSInfo.prototype.PE_PCSINFO_OPTION_NONE,t.PE_PCSINFO_OPTION_DOMAIN=te.PePCSInfo.prototype.PE_PCSINFO_OPTION_DOMAIN,t.PE_POLE_OUTSIDE_BOUNDARY=te.PePCSInfo.prototype.PE_POLE_OUTSIDE_BOUNDARY,t.PE_POLE_POINT=te.PePCSInfo.prototype.PE_POLE_POINT}function r(s,n=t.PE_PCSINFO_OPTION_DOMAIN){let o,a;return e.has(s)&&(a=e.get(s),a[n]&&(o=a[n])),o||(o=te.PePCSInfo.prototype.generate(s,n),a||(a=[],e.set(s,a)),a[n]=o),o}t.init=i,t.generate=r}(BP||(BP={})),function(t){function e(){return te.PeVersion.prototype.version_string()}t.version_string=e}(n6||(n6={}));const cSe=Object.freeze({__proto__:null,get _pe(){return te},isLoaded:uJ,isSupported:lSe,load:hJ,get PeCSTransformations(){return KL},get PeDefs(){return Gi},get PeFactory(){return e6},get PeGCSExtent(){return dJ},get PeGTlistExtended(){return NP},get PeGTlistExtendedEntry(){return t6},get PeGTTransformations(){return i6},get PeNotationDms(){return r6},get PeNotationMgrs(){return UP},get PeNotationUsng(){return s6},get PeNotationUtm(){return jP},get PePCSInfo(){return BP},get PeVersion(){return n6},_init:pJ}),Znt=Math.PI/180,Jnt=/SPHEROID\[([^\]]+)]/i,rf=Lt.radius,ic=Lt.eccentricitySquared,uSe={a1:rf*ic,a2:rf*ic*rf*ic,a3:rf*ic*ic/2,a4:rf*ic*rf*ic*2.5,a5:rf*ic+rf*ic*ic/2,a6:1-ic},Qnt={4267:{a:63782064e-1,f:1/294.9786982},4269:{a:6378137,f:1/298.257222101},4326:{a:Lt.radius,f:Lt.flattening},104900:{a:2439700,f:0},104901:{a:6051e3,f:0},104902:{a:6051800,f:0},104903:{a:Xc.radius,f:Xc.flattening},104904:{a:3393400,f:1/192.0430107526882},104905:{a:Ul.radius,f:Ul.flattening},104906:{a:6200,f:0},104907:{a:11100,f:0},104908:{a:71492e3,f:.06487439154031222},104909:{a:8200,f:0},104910:{a:83500,f:0},104911:{a:1e4,f:0},104912:{a:2409300,f:0},104913:{a:15e3,f:0},104914:{a:4e4,f:0},104915:{a:1562090,f:0},104916:{a:2632345,f:0},104917:{a:85e3,f:0},104918:{a:1821460,f:0},104919:{a:5e3,f:0},104920:{a:12e3,f:0},104921:{a:3e4,f:3},104922:{a:18e3,f:0},104923:{a:14e3,f:0},104924:{a:49300,f:0},104925:{a:60268e3,f:1/10.2079945799458},104926:{a:16e3,f:0},104927:{a:9500,f:0},104928:{a:56e4,f:0},104929:{a:249400,f:0},104930:{a:59500,f:0},104931:{a:16e3,f:0},104932:{a:133e3,f:0},104933:{a:718e3,f:0},104934:{a:888e3,f:0},104935:{a:1986300,f:0},104936:{a:1e4,f:0},104937:{a:41900,f:0},104938:{a:11e4,f:0},104939:{a:50100,f:0},104940:{a:764e3,f:0},104941:{a:11e3,f:0},104942:{a:529800,f:0},104943:{a:2575e3,f:0},104944:{a:25559e3,f:1/43.61604095563141},104945:{a:578900,f:0},104946:{a:33e3,f:0},104947:{a:21e3,f:0},104948:{a:13e3,f:0},104949:{a:31e3,f:0},104950:{a:27e3,f:0},104951:{a:42e3,f:0},104952:{a:235800,f:0},104953:{a:761400,f:0},104954:{a:15e3,f:0},104955:{a:54e3,f:0},104956:{a:77e3,f:0},104957:{a:27e3,f:0},104958:{a:788900,f:0},104959:{a:584700,f:0},104960:{a:24764e3,f:.01708124697141011},104961:{a:74e3,f:0},104962:{a:79e3,f:0},104963:{a:104e3,f:.14423076923076922},104964:{a:29e3,f:0},104965:{a:17e4,f:0},104966:{a:208e3,f:0},104967:{a:4e4,f:0},104968:{a:1352600,f:0},104969:{a:1195e3,f:0},104970:{a:593e3,f:0},104971:{a:Ul.radius,f:0},104972:{a:47e4,f:0},104973:{a:255e3,f:0},104974:{a:2439400,f:0}};let qP=0;class E1{constructor(e=null){this.uid=qP++,e?(this._wkt=e.wkt!==void 0?e.wkt:null,this._wkid=e.wkid!==void 0?e.wkid:-1,this._isInverse=e.isInverse!==void 0&&e.isInverse===!0):(this._wkt=null,this._wkid=-1,this._isInverse=!1)}static fromGE(e){const i=new E1;return i._wkt=e.wkt,i._wkid=e.wkid,i._isInverse=e.isInverse,i}get wkt(){return this._wkt}set wkt(e){this._wkt=e,this.uid=qP++}get wkid(){return this._wkid}set wkid(e){this._wkid=e,this.uid=qP++}get isInverse(){return this._isInverse}set isInverse(e){this._isInverse=e,this.uid=qP++}getInverse(){const e=new E1;return e._wkt=this.wkt,e._wkid=this._wkid,e._isInverse=!this.isInverse,e}}class sf{constructor(e){if(this.steps=[],this._cached_projection={},this._chain="",this._gtlistentry=null,e&&e.steps)for(const i of e.steps)i instanceof E1?this.steps.push(i):this.steps.push(new E1({wkid:i.wkid,wkt:i.wkt,isInverse:i.isInverse}))}static cacheKey(e,i){return[e.wkid!==void 0&&e.wkid!==null?e.wkid.toString():"-1",e.wkt!==void 0&&e.wkt!==null?e.wkt.toString():"",i.wkid!==void 0&&i.wkid!==null?i.wkid.toString():"-1",i.wkt!==void 0&&i.wkt!==null?i.wkt.toString():""].join(",")}static fromGE(e){const i=new sf;let r="";for(const s of e.steps){const n=E1.fromGE(s);i.steps.push(n),r+=n.uid.toString()+","}return i._cached_projection={},i._gtlistentry=null,i._chain=r,i}getInverse(){const e=new sf;e.steps=[];for(let i=this.steps.length-1;i>=0;i--){const r=this.steps[i];e.steps.push(r.getInverse())}return e}getGTListEntry(){let e="";for(const i of this.steps)e+=i.uid.toString()+",";return e!==this._chain&&(this._gtlistentry=null,this._cached_projection={},this._chain=e),this._gtlistentry}assignCachedGe(e,i,r){this._cached_projection[sf.cacheKey(e,i)]=r}getCachedGeTransformation(e,i){let r="";for(const n of this.steps)r+=n.uid.toString()+",";r!==this._chain&&(this._gtlistentry=null,this._cached_projection={},this._chain=r);const s=this._cached_projection[sf.cacheKey(e,i)];return s===void 0?null:s}}function o6(t,e,i){if(A(e)||A(i)||i.vcsWkid||Da(e,i))return null;const r=A1(e)/A1(i);if(r===1)return null;switch(t){case"point":case"esriGeometryPoint":return s=>hSe(s,r);case"polyline":case"esriGeometryPolyline":return s=>pSe(s,r);case"polygon":case"esriGeometryPolygon":return s=>dSe(s,r);case"multipoint":case"esriGeometryMultipoint":return s=>fSe(s,r);case"extent":case"esriGeometryExtent":return s=>mSe(s,r);default:return null}}function hSe(t,e){t&&t.z!=null&&(t.z*=e)}function dSe(t,e){if(t)for(const i of t.rings)for(const r of i)r.length>2&&(r[2]*=e)}function pSe(t,e){if(t)for(const i of t.paths)for(const r of i)r.length>2&&(r[2]*=e)}function fSe(t,e){if(t)for(const i of t.points)i.length>2&&(i[2]*=e)}function mSe(t,e){t&&t.zmin!=null&&t.zmax!=null&&(t.zmin*=e,t.zmax*=e)}let uy=null,HP=null,a6=null,l6={};function fJ(){return!!uy&&uJ()}function mJ(t){return A(a6)&&(a6=Promise.all([hJ(),import("./geometryEngineBase.fd888c07.js").then(e=>e.g),import("./hydrated.e993e387.js")])),a6.then(([,e,{hydratedAdapter:i}])=>{Dt(t),HP=i,uy=e.default,uy._enableProjection(cSe)})}function f2(t,e,i=null){return Array.isArray(t)?t.length===0?[]:gJ(HP,t,t[0].spatialReference,e,i):gJ(HP,[t],t.spatialReference,e,i)[0]}function gJ(t,e,i,r,s=null){if(A(i)||A(r))return e;if(O1(i,r,s))return e.map(n=>at(yJ(n,i,r)));if(A(s)){const n=sf.cacheKey(i,r);l6[n]!==void 0?s=l6[n]:(s=gSe(i,r,null),A(s)&&(s=new sf),l6[n]=s)}if(A(uy))throw new c6;return uy._project(t,e,i,r,s)}function gSe(t,e,i=null){if(A(uy))throw new c6;if(A(t)||A(e))return null;const r=uy._getTransformation(HP,t,e,i,i==null?void 0:i.spatialReference);return r!==null?sf.fromGE(r):null}class c6 extends Q{constructor(){super("projection:not-loaded","projection engine not fully loaded yet, please call load()")}}function Ynt(t,e){try{const i=f2(t,e);if(i==null)return null;"xmin"in t&&"xmin"in i&&(i.zmin=t.zmin,i.zmax=t.zmax);const r=o6(i.type,t.spatialReference,e);return _(r)&&r(i),i}catch(i){if(!(i instanceof c6))throw i;return null}}function O1(t,e,i){return!i&&(!!Da(t,e)||Ho(t)&&Ho(e)&&!!y6(t,e,_6))}async function Xnt(t,e,i,r){if(!fJ()){if(Array.isArray(t)){for(const{source:s,dest:n,geographicTransformation:o}of t)if(!O1(s,n,o))return mJ(r)}else if(!O1(t,e,i))return mJ(r)}}function Knt(t,e){switch(y6(t,e,_6)){case oi:return"copy3";case lf:return"wgs84ToSphericalECEF";case dy:return"wgs84ToWebMercator";case af:return"wgs84ToPlateCarree";case uf:return"wgs84ToWGS84ECEF";case hy:return"webMercatorToWGS84";case MJ:return"webMercatorToSphericalECEF";case PJ:return"webMercatorToWGS84ECEF";case $J:return"webMercatorToPlateCarree";case hf:return"wgs84ECEFToWGS84";case RJ:return"wgs84ECEFToSphericalECEF";case IJ:return"wgs84ECEFToWebMercator";case cf:return"sphericalECEFToWGS84";case EJ:return"sphericalECEFToWebMercator";case g6:return"sphericalMarsPCPFToMars2000";case m6:return"sphericalMoonPCPFToMoon2000";case OJ:return"sphericalECEFToWGS84ECEF";case p6:return"mars2000ToSphericalPCPF";case d6:return"moon2000ToSphericalPCPF";default:return null}}function yJ(t,e,i){return t?"x"in t?vJ(t,e,new je,i,0):"xmin"in t?bSe(t,e,new ht,i,0):"rings"in t?_J(t,e,new Zo,i,0):"paths"in t?_Se(t,e,new Jo,i,0):"points"in t?vSe(t,e,new $g,i,0):null:null}function ySe(t,e,i=e.spatialReference,r=0){return!A(i)&&_(vJ(t,t.spatialReference,e,i,r))}function vJ(t,e,i,r,s){jt[0]=t.x,jt[1]=t.y;const n=t.z;return jt[2]=n!==void 0?n:s,Mi(jt,e,0,jt,r,0,1)?(i.x=jt[0],i.y=jt[1],i.spatialReference=r,n===void 0?(i.z=void 0,i.hasZ=!1):(i.z=jt[2],i.hasZ=!0),t.m===void 0?(i.m=void 0,i.hasM=!1):(i.m=t.m,i.hasM=!0),i):null}function vSe(t,e,i,r,s){const{points:n,hasZ:o,hasM:a}=t,l=[],c=n.length,h=[];for(const p of n)h.push(p[0],p[1],o?p[2]:s);if(!Mi(h,e,0,h,r,0,c))return null;for(let p=0;p<c;++p){const f=3*p,g=h[f],y=h[f+1];o&&a?l.push([g,y,h[f+2],n[p][3]]):o?l.push([g,y,h[f+2]]):a?l.push([g,y,n[p][2]]):l.push([g,y])}return i.points=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i}function _Se(t,e,i,r,s){const{paths:n,hasZ:o,hasM:a}=t,l=[];return xJ(n,o,a,e,l,r,s)?(i.paths=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i):null}function eot(t,e,i=e.spatialReference,r=0){return _(i)&&_(_J(t,t.spatialReference,e,i,r))}function _J(t,e,i,r,s){const{rings:n,hasZ:o,hasM:a}=t,l=[];return xJ(n,o,a,e,l,r,s)?(i.rings=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i):null}function bSe(t,e,i,r,s){const{xmin:n,ymin:o,xmax:a,ymax:l,hasZ:c,hasM:h}=t;return wJ(n,o,c?t.zmin:s,e,jt,r)?(i.xmin=jt[0],i.ymin=jt[1],c&&(i.zmin=jt[2]),wJ(a,l,c?t.zmax:s,e,jt,r)?(i.xmax=jt[0],i.ymax=jt[1],c&&(i.zmax=jt[2]),h&&(i.mmin=t.mmin,i.mmax=t.mmax),i.spatialReference=r,i):null):null}function nf(t,e,i){if(A(e)||A(i))return null;const r=new je({spatialReference:i});return Mi(t,e,0,jt,i,0,1)?(r.x=jt[0],r.y=jt[1],r.z=jt[2],r):null}function bJ(t,e,i){return Mi(t,e,0,jt,i.spatialReference,0,1)?(i.x=jt[0],i.y=jt[1],i.z=jt[2],i):null}function Gr(t,e,i,r=0){jt[0]=t.x,jt[1]=t.y;const s=t.z;return jt[2]=s!==void 0?s:r,Mi(jt,t.spatialReference,0,e,i,0,1)}function wJ(t,e,i,r,s,n){return Pi[0]=t,Pi[1]=e,Pi[2]=i,Mi(Pi,r,0,s,n,0,1)}function Ns(t,e,i,r){return!(A(e)||A(r)||t.length<2)&&(t.length===2&&(Pi[0]=t[0],Pi[1]=t[1],Pi[2]=0,t=Pi),Mi(t,e,0,i,r,0,1))}function wSe(t,e){jt[0]=t.x,jt[1]=t.y;const i=t.z;return jt[2]=i!==void 0?i:0,xSe(jt,t.spatialReference,e)}function xSe(t,e,i){return SSe(t,e,i)}function SSe(t,e,i){if(A(e))return!1;const r=of(e,JP),s=bu[r][6];return!A(s)&&(s(t,0,Pi,0),i!==Pi&&(i[0]=Pi[0],i[1]=Pi[1],i.length>2&&(i[2]=Pi[2])),!0)}function Mi(t,e,i,r,s,n,o=1){const a=y6(e,s,_6);if(A(a))return!1;if(a===oi){if(t===r&&i===n)return!0;const c=i+3*o;for(let h=i,p=n;h<c;h++,p++)r[p]=t[h];return!0}const l=i+3*o;for(let c=i,h=n;c<l;c+=3,h+=3)a(t,c,r,h);return!0}function tot(t,e,i,r,s){re(jt,t),de(QP,t,e),Ns(jt,i,jt,s),Ns(QP,i,QP,s),ue(r,QP,jt),_e(r,r)}function xJ(t,e,i,r,s,n,o=0){const a=new Array;for(const c of t)for(const h of c)a.push(h[0],h[1],e?h[2]:o);if(!Mi(a,r,0,a,n,0,a.length/3))return!1;let l=0;s.length=0;for(const c of t){const h=new Array;for(const p of c)e&&i?h.push([a[l++],a[l++],a[l++],p[3]]):e?h.push([a[l++],a[l++],a[l++]]):i?(h.push([a[l++],a[l++],p[2]]),l++):(h.push([a[l++],a[l++]]),l++);s.push(h)}return!0}function iot(t,e,i,r){if(A(e)||A(r))return!1;const s=DJ(e,r,OSe);if(s.projector===oi)return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],!0;if(A(s.projector))return!1;const{source:n,dest:o}=s;if(o.spatialReferenceId===3){const a=bu[n.spatialReferenceId][2];return!A(a)&&(a(t,0,nc,0),dy(nc,0,i,0),i[3]=SJ(nc[1],t[2],t[3],Lt.radius),!0)}if(n.spatialReferenceId!==2&&n.spatialReferenceId!==5||o.spatialReferenceId!==12)s.projector(t,0,i,0),i[3]=t[3]*n.metersPerUnit/o.metersPerUnit;else{const a=bu[n.spatialReferenceId][1],l=bu[1][12];let c=t[3];_(a)&&_(l)&&(c=SJ(t[1],t[2],t[3],Lt.radius)),s.projector(t,0,i,0),i[3]=c}return!0}function SJ(t,e,i,r){const s=Math.abs(sc*t)+Math.asin(i/(r+e));return s>=Math.PI/2?Number.MAX_VALUE:i/Math.cos(s)}function WP(t,e,i,r){return t!=null&&(Da(e,r)?(Bp(i,t),!0):(Pi[0]=t[0],Pi[1]=t[1],Pi[2]=0,!!Mi(Pi,e,0,Pi,r,0,1)&&(i[0]=Pi[0],i[1]=Pi[1],Pi[0]=t[2],Pi[1]=t[3],Pi[2]=0,!!Mi(Pi,e,0,Pi,r,0,1)&&(i[2]=Pi[0],i[3]=Pi[1],!0))))}function rot(t,e,i,r){if(A(e)||A(r))return!1;const s=of(e,JP),n=of(r,FJ);if(s===n&&s!==0||Da(e,r))return i[0]=1,i[1]=1,i[2]=1,!0;if(s===1){const o=Te(t),a=o/Math.sqrt(t[0]*t[0]+t[1]*t[1]),l=o/Lt.radius;if(n===3)return i[0]=a*l,i[1]=a*l,i[2]=1,!0;if(n===2||n===5){const c=180/(Lt.radius*Math.PI);return i[0]=c*a*l,i[1]=c*l,i[2]=1,!0}}else if(s===12&&(n===2||n===5))return i[0]=ZP,i[1]=ZP,i[2]=1,!0;return!1}function rc(t,e,i,r){if(A(t)||A(r))return!1;const s=of(t,JP),n=of(r,FJ);if(s===n&&!TJ(n)&&(s!==0||Da(t,r)))return Di(i),Vs(i,i,e),!0;if(TJ(n)){const o=bu[s][11],a=bu[11][n];return!A(o)&&!A(a)&&(o(e,0,nc,0),a(nc,0,df,0),CJ(sc*nc[0],sc*nc[1],i),i[12]=df[0],i[13]=df[1],i[14]=df[2],!0)}if(!(n!==3&&n!==12||s!==2&&s!==1&&s!==3)){const o=bu[s][11],a=bu[11][n];return!A(o)&&!A(a)&&(o(e,0,nc,0),a(nc,0,df,0),s===1?TSe(sc*nc[0],sc*nc[1],i):Di(i),i[12]=df[0],i[13]=df[1],i[14]=df[2],!0)}return!1}function TJ(t){return t===1||t===7||t===9}function CJ(t,e,i){const r=Math.sin(t),s=Math.cos(t),n=Math.sin(e),o=Math.cos(e),a=i;return a[0]=-r,a[4]=-n*s,a[8]=o*s,a[12]=0,a[1]=s,a[5]=-n*r,a[9]=o*r,a[13]=0,a[2]=0,a[6]=o,a[10]=n,a[14]=0,a[3]=0,a[7]=0,a[11]=0,a[15]=1,a}function TSe(t,e,i){return CJ(t,e,i),Nn(i,i),i}function of(t,e){return e.spatialReference===t?e.spatialReferenceId:(e.spatialReference=t,"metersPerUnit"in e&&(e.metersPerUnit=bo(t,1)),t.wkt===ZL.wkt?e.spatialReferenceId=1:ox(t)?e.spatialReferenceId=2:bg(t)?e.spatialReferenceId=3:Mq(t)?e.spatialReferenceId=12:t.wkt===v2e.wkt?e.spatialReferenceId=4:t.wkid===4490?e.spatialReferenceId=5:t.wkt===u2.wkt?e.spatialReferenceId=7:t.wkt===h2.wkt?e.spatialReferenceId=9:$h(t)?e.spatialReferenceId=8:Eh(t)?e.spatialReferenceId=10:e.spatialReferenceId=0)}function oi(t,e,i,r){t!==i&&(i[r++]=t[e++],i[r++]=t[e++],i[r]=t[e])}function hy(t,e,i,r){i[r++]=R1*(t[e++]/Lt.radius),i[r++]=R1*(Math.PI/2-2*Math.atan(Math.exp(-t[e++]/Lt.radius))),i[r]=t[e]}function MJ(t,e,i,r){hy(t,e,i,r),lf(i,r,i,r)}function PJ(t,e,i,r){hy(t,e,i,r),uf(i,r,i,r)}function u6(t,e,i,r,s){const n=.4999999*Math.PI,o=Re(sc*t[e+1],-n,n),a=Math.sin(o);i[r++]=sc*t[e]*s.radius,i[r++]=s.halfSemiMajorAxis*Math.log((1+a)/(1-a)),i[r]=t[e+2]}function dy(t,e,i,r){u6(t,e,i,r,Lt)}const AJ=Lt.radius*Math.PI/180,ZP=180/(Lt.radius*Math.PI);function af(t,e,i,r){i[r]=t[e]*AJ,i[r+1]=t[e+1]*AJ,i[r+2]=t[e+2]}function py(t,e,i,r){i[r]=t[e]*ZP,i[r+1]=t[e+1]*ZP,i[r+2]=t[e+2]}function $J(t,e,i,r){hy(t,e,i,r),af(i,r,i,r)}function CSe(t,e,i,r){hf(t,e,i,r),af(i,r,i,r)}function MSe(t,e,i,r){cf(t,e,i,r),af(i,r,i,r)}function PSe(t,e,i,r){py(t,e,i,r),lf(i,r,i,r)}function ASe(t,e,i,r){py(t,e,i,r),dy(i,r,i,r)}function $Se(t,e,i,r){py(t,e,i,r),uf(i,r,i,r)}function fy(t){if(A(t))return!1;const e=of(t,JP);return!!bu[e][6]}function m2(t,e,i,r,s=0){const n=r+s,o=Math.cos(i);t[0]=Math.cos(e)*o*n,t[1]=Math.sin(e)*o*n,t[2]=Math.sin(i)*n}function h6(t,e,i,r,s){const n=s+t[e+2],o=sc*t[e+1],a=sc*t[e],l=Math.cos(o);i[r++]=Math.cos(a)*l*n,i[r++]=Math.sin(a)*l*n,i[r]=Math.sin(o)*n}function d6(t,e,i,r){h6(t,e,i,r,Xc.radius)}function p6(t,e,i,r){h6(t,e,i,r,Ul.radius)}function lf(t,e,i,r){h6(t,e,i,r,Lt.radius)}function f6(t,e,i,r,s){const n=t[e],o=t[e+1],a=t[e+2],l=Math.sqrt(n*n+o*o+a*a),c=Bl(a/(l===0?1:l)),h=Math.atan2(o,n);i[r++]=R1*h,i[r++]=R1*c,i[r]=l-s}function m6(t,e,i,r){f6(t,e,i,r,Xc.radius)}function g6(t,e,i,r){f6(t,e,i,r,Ul.radius)}function cf(t,e,i,r){f6(t,e,i,r,Lt.radius)}function EJ(t,e,i,r){cf(t,e,i,r),dy(i,r,i,r)}function OJ(t,e,i,r){cf(t,e,i,r),uf(i,r,i,r)}function ESe(t,e,i,r,s){const n=sc*t[e],o=sc*t[e+1],a=t[e+2],l=Math.sin(o),c=Math.cos(o),h=s.radius/Math.sqrt(1-s.eccentricitySquared*l*l);i[r++]=(h+a)*c*Math.cos(n),i[r++]=(h+a)*c*Math.sin(n),i[r++]=(h*(1-s.eccentricitySquared)+a)*l}function uf(t,e,i,r){ESe(t,e,i,r,Lt)}function hf(t,e,i,r){const s=uSe,n=t[e],o=t[e+1],a=t[e+2];let l,c,h,p,f,g,y,v,b,w,S,T,C,M,P,F,z,D,U,G,k;l=Math.abs(a),c=n*n+o*o,h=Math.sqrt(c),p=c+a*a,f=Math.sqrt(p),G=Math.atan2(o,n),g=a*a/p,y=c/p,M=s.a2/f,P=s.a3-s.a4/f,y>.3?(v=l/f*(1+y*(s.a1+M+g*P)/f),U=Math.asin(v),w=v*v,b=Math.sqrt(1-w)):(b=h/f*(1-g*(s.a5-M-y*P)/f),U=Math.acos(b),w=1-b*b,v=Math.sqrt(w)),S=1-Lt.eccentricitySquared*w,T=Lt.radius/Math.sqrt(S),C=s.a6*T,M=h-T*b,P=l-C*v,z=b*M+v*P,F=b*P-v*M,D=F/(C/S+z),U+=D,k=z+F*D/2,a<0&&(U=-U),i[r++]=R1*G,i[r++]=R1*U,i[r]=k}function RJ(t,e,i,r){hf(t,e,i,r),lf(i,r,i,r)}function IJ(t,e,i,r){hf(t,e,i,r),dy(i,r,i,r)}const bu={2:{5:null,8:null,10:null,11:oi,6:oi,1:lf,7:null,9:null,0:null,3:dy,12:af,2:oi,4:uf},5:{5:oi,8:null,10:null,11:oi,6:oi,1:lf,7:null,9:null,0:null,3:null,12:af,2:null,4:uf},8:{5:null,8:oi,10:null,11:oi,6:null,1:null,7:p6,9:null,0:null,3:null,12:null,2:null,4:null},10:{5:null,8:null,10:oi,11:oi,6:null,1:null,7:null,9:d6,0:null,3:null,12:null,2:null,4:null},3:{5:null,8:null,10:null,11:hy,6:hy,1:MJ,7:null,9:null,0:null,3:oi,12:$J,2:hy,4:PJ},4:{5:hf,8:null,10:null,11:hf,6:hf,1:RJ,7:null,9:null,0:null,3:IJ,12:CSe,2:hf,4:oi},1:{5:cf,8:null,10:null,11:cf,6:cf,1:oi,7:null,9:null,0:null,3:EJ,12:MSe,2:cf,4:OJ},7:{5:null,8:g6,10:null,11:g6,6:null,1:null,7:oi,9:null,0:null,3:null,12:null,2:null,4:null},9:{5:null,8:null,10:m6,11:m6,6:null,1:null,7:null,9:oi,0:null,3:null,12:null,2:null,4:null},0:{5:null,8:null,10:null,11:null,6:null,1:null,7:null,9:null,0:oi,3:null,12:null,2:null,4:null},11:{5:oi,8:oi,10:oi,11:oi,6:oi,1:lf,7:p6,9:d6,0:null,3:dy,12:af,2:oi,4:uf},6:{5:null,8:null,10:null,11:oi,6:oi,1:lf,7:null,9:null,0:null,3:null,12:af,2:oi,4:uf},12:{5:py,8:null,10:null,11:py,6:py,1:PSe,7:null,9:null,0:null,3:ASe,12:oi,2:py,4:$Se}};function y6(t,e,i=v6()){return A(t)||A(e)?null:DJ(t,e,i).projector}function DJ(t,e,i){if(A(t)||A(e)||i.source.spatialReference===t&&i.dest.spatialReference===e)return i;const r=of(t,i.source),s=of(e,i.dest);return r===0&&s===0?Da(t,e)?i.projector=oi:i.projector=null:i.projector=bu[r][s],i}function v6(){return{source:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},projector:oi}}const JP={spatialReference:null,spatialReferenceId:0},FJ={spatialReference:null,spatialReferenceId:0},_6=v6(),OSe=v6(),sc=nt(1),R1=go(1),Pi=$(),nc=$(),df=$(),jt=$(),QP=$();class Yh{constructor(e){this.allocator=e,this._items=[],this._itemsPtr=0,this.grow()}get(){return this._itemsPtr===0&&Nv(()=>this.reset()),this._itemsPtr===this._items.length&&this.grow(),this._items[this._itemsPtr++]}reset(){const e=Math.min(3*Math.max(8,this._itemsPtr),this._itemsPtr+3*LJ);this._items.length=Math.min(e,this._items.length),this._itemsPtr=0}grow(){for(let e=0;e<Math.max(8,Math.min(this._items.length,LJ));e++)this._items.push(this.allocator())}}const LJ=1024;function be(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function my(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]}function b6(t,e,i,r,s,n,o,a,l,c,h,p,f,g,y,v){return[t,e,i,r,s,n,o,a,l,c,h,p,f,g,y,v]}function kJ(t,e){return new Float64Array(t,e,16)}const Dr=be();Object.freeze({__proto__:null,create:be,clone:my,fromValues:b6,createView:kJ,IDENTITY:Dr});function Ai(){return[1,0,0,0,1,0,0,0,1]}function RSe(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]}function ISe(t,e,i,r,s,n,o,a,l){return[t,e,i,r,s,n,o,a,l]}function zJ(t,e){return new Float64Array(t,e,9)}Object.freeze({__proto__:null,create:Ai,clone:RSe,fromValues:ISe,createView:zJ});function pf(){return[0,0,0,1]}function DSe(t){return[t[0],t[1],t[2],t[3]]}function FSe(t,e,i,r){return[t,e,i,r]}function VJ(t,e){return new Float64Array(t,e,4)}const LSe=pf();Object.freeze({__proto__:null,create:pf,clone:DSe,fromValues:FSe,createView:VJ,IDENTITY:LSe});function ke(){return[0,0]}function g2(t){return[t[0],t[1]]}function Qt(t,e){return[t,e]}function kSe(t){const e=ke(),i=Math.min(2,t.length);for(let r=0;r<i;++r)e[r]=t[r];return e}function NJ(t,e){return new Float64Array(t,e,2)}function UJ(){return ke()}function jJ(){return Qt(1,1)}function BJ(){return Qt(1,0)}function GJ(){return Qt(0,1)}const w6=UJ(),zSe=jJ(),VSe=BJ(),NSe=GJ();Object.freeze({__proto__:null,create:ke,clone:g2,fromValues:Qt,fromArray:kSe,createView:NJ,zeros:UJ,ones:jJ,unitX:BJ,unitY:GJ,ZEROS:w6,ONES:zSe,UNIT_X:VSe,UNIT_Y:NSe});function Ot(){return[0,0,0,0]}function x6(t){return[t[0],t[1],t[2],t[3]]}function Bt(t,e,i,r){return[t,e,i,r]}function S6(t){const e=Ot(),i=Math.min(4,t.length);for(let r=0;r<i;++r)e[r]=t[r];return e}function qJ(t,e){return new Float64Array(t,e,4)}function HJ(){return Ot()}function WJ(){return Bt(1,1,1,1)}function ZJ(){return Bt(1,0,0,0)}function JJ(){return Bt(0,1,0,0)}function QJ(){return Bt(0,0,1,0)}function YJ(){return Bt(0,0,0,1)}const I1=HJ(),wu=WJ(),USe=ZJ(),jSe=JJ(),BSe=QJ(),GSe=YJ();Object.freeze({__proto__:null,create:Ot,clone:x6,fromValues:Bt,fromArray:S6,createView:qJ,zeros:HJ,ones:WJ,unitX:ZJ,unitY:JJ,unitZ:QJ,unitW:YJ,ZEROS:I1,ONES:wu,UNIT_X:USe,UNIT_Y:jSe,UNIT_Z:BSe,UNIT_W:GSe});class Xo{constructor(e,i,r){this.itemByteSize=e,this.itemCreate=i,this._buffers=new Array,this._items=new Array,this._itemsPtr=0,this._itemsPerBuffer=Math.ceil(r/this.itemByteSize)}get(){this._itemsPtr===0&&Nv(()=>this.reset());const e=Math.floor(this._itemsPtr/this._itemsPerBuffer);for(;this._buffers.length<=e;){const i=new ArrayBuffer(this._itemsPerBuffer*this.itemByteSize);for(let r=0;r<this._itemsPerBuffer;++r)this._items.push(this.itemCreate(i,r*this.itemByteSize));this._buffers.push(i)}return this._items[this._itemsPtr++]}reset(){const e=2*(Math.floor(this._itemsPtr/this._itemsPerBuffer)+1);for(;this._buffers.length>e;)this._buffers.pop(),this._items.length=this._buffers.length*this._itemsPerBuffer;this._itemsPtr=0}static createVec2f64(e=D1){return new Xo(16,NJ,e)}static createVec3f64(e=D1){return new Xo(24,wF,e)}static createVec4f64(e=D1){return new Xo(32,qJ,e)}static createMat3f64(e=D1){return new Xo(72,zJ,e)}static createMat4f64(e=D1){return new Xo(128,kJ,e)}static createQuatf64(e=D1){return new Xo(32,VJ,e)}get test(){return{size:this._buffers.length*this._itemsPerBuffer*this.itemByteSize}}}const D1=4096,sot=Xo.createVec2f64(),Me=Xo.createVec3f64(),T6=Xo.createVec4f64();Xo.createMat3f64();const C6=Xo.createMat4f64();Xo.createQuatf64();function ff(t){return t?{origin:br(t.origin),vector:br(t.vector)}:{origin:$(),vector:$()}}function gy(t,e,i=ff()){return re(i.origin,t),ue(i.vector,e,t),i}function M6(t,e){const i=ue(Me.get(),e,t.origin),r=ye(t.vector,i),s=ye(t.vector,t.vector),n=Re(r/s,0,1),o=ue(Me.get(),se(Me.get(),t.vector,n),i);return ye(o,o)}function XJ(t,e,i,r,s){const{vector:n,origin:o}=t,a=ue(Me.get(),e,o),l=ye(n,a)/un(n);return se(s,n,Re(l,i,r)),de(s,s,t.origin)}function KJ(t,e,i){return!!qSe(t,e,!0,eQ)&&(re(i,eQ.pA),!0)}function qSe(t,e,i,r){const s=1e-6,n=t.origin,o=de(Me.get(),n,t.vector),a=e.origin,l=de(Me.get(),a,e.vector),c=Me.get(),h=Me.get();if(c[0]=n[0]-a[0],c[1]=n[1]-a[1],c[2]=n[2]-a[2],h[0]=l[0]-a[0],h[1]=l[1]-a[1],h[2]=l[2]-a[2],Math.abs(h[0])<s&&Math.abs(h[1])<s&&Math.abs(h[2])<s)return!1;const p=Me.get();if(p[0]=o[0]-n[0],p[1]=o[1]-n[1],p[2]=o[2]-n[2],Math.abs(p[0])<s&&Math.abs(p[1])<s&&Math.abs(p[2])<s)return!1;const f=c[0]*h[0]+c[1]*h[1]+c[2]*h[2],g=h[0]*p[0]+h[1]*p[1]+h[2]*p[2],y=c[0]*p[0]+c[1]*p[1]+c[2]*p[2],v=h[0]*h[0]+h[1]*h[1]+h[2]*h[2],b=(p[0]*p[0]+p[1]*p[1]+p[2]*p[2])*v-g*g;if(Math.abs(b)<s)return!1;let w=(f*g-y*v)/b,S=(f+g*w)/v;i&&(w=Re(w,0,1),S=Re(S,0,1));const T=Me.get(),C=Me.get();return T[0]=n[0]+w*p[0],T[1]=n[1]+w*p[1],T[2]=n[2]+w*p[2],C[0]=a[0]+S*h[0],C[1]=a[1]+S*h[1],C[2]=a[2]+S*h[2],r.tA=w,r.tB=S,r.pA=T,r.pB=C,r.distance2=cn(T,C),!0}const eQ={tA:0,tB:0,pA:$(),pB:$(),distance2:0};new Yh(()=>({origin:null,vector:null}));function vs(t){return t?{origin:br(t.origin),direction:br(t.direction)}:{origin:$(),direction:$()}}function not(t,e){return _p(t.origin,e.origin)&&_p(t.direction,e.direction)}function Ko(t,e){const i=QSe.get();return i.origin=t,i.direction=e,i}function YP(t,e=vs()){return tQ(t.origin,t.direction,e)}function HSe(t,e,i=vs()){return re(i.origin,t),ue(i.direction,e,t),i}function tQ(t,e,i=vs()){return re(i.origin,t),re(i.direction,e),i}function WSe(t,e){const i=Ye(Me.get(),_e(Me.get(),t.direction),ue(Me.get(),e,t.origin));return ye(i,i)}function ZSe(t,e,i){const r=ye(t.direction,ue(i,e,t.origin));return de(i,t.origin,se(i,t.direction,r)),i}function JSe(){return{origin:null,direction:null}}const QSe=new Yh(JSe);function y2(t,e){return ye(t,e)/Te(t)}function P6(t,e){const i=ye(t,e)/(Te(t)*Te(e));return-ar(i)}function YSe(t,e,i){_e(XP,t),_e(A6,e);const r=ye(XP,A6),s=ar(r),n=Ye(XP,XP,A6);return ye(n,i)<0?2*Math.PI-s:s}const XP=$(),A6=$(),XSe=le.getLogger("esri.geometry.support.sphere");function rs(){return Ot()}function F1(t,e=rs()){return Ln(e,t)}function iQ(t,e){return Bt(t[0],t[1],t[2],e)}function rQ(t){return t}function sQ(t){t[0]=t[1]=t[2]=t[3]=0}function KP(t){return t}function eA(t){return Array.isArray(t)?t[3]:t}function ea(t){return Array.isArray(t)?t:nTe}function nQ(t,e,i,r){return Bt(t,e,i,r)}function KSe(t,e,i){return t!==i&&re(i,t),i[3]=t[3]+e,i}function eTe(t,e,i){return XSe.error("sphere.setExtent is not yet supported"),t===i?i:F1(t,i)}function mf(t,e,i){if(A(e))return!1;const{origin:r,direction:s}=e,n=tTe;n[0]=r[0]-t[0],n[1]=r[1]-t[1],n[2]=r[2]-t[2];const o=s[0]*s[0]+s[1]*s[1]+s[2]*s[2],a=2*(s[0]*n[0]+s[1]*n[1]+s[2]*n[2]),l=a*a-4*o*(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]-t[3]*t[3]);if(l<0)return!1;const c=Math.sqrt(l);let h=(-a-c)/(2*o);const p=(-a+c)/(2*o);return(h<0||p<h&&p>0)&&(h=p),!(h<0)&&(i&&(i[0]=r[0]+s[0]*h,i[1]=r[1]+s[1]*h,i[2]=r[2]+s[2]*h),!0)}const tTe=$();function $6(t,e){return mf(t,e,null)}function iTe(t,e,i){if(mf(t,e,i))return i;const r=L1(t,e,Me.get());return de(i,e.origin,se(Me.get(),e.direction,qt(e.origin,r)/Te(e.direction))),i}function L1(t,e,i){const r=Me.get(),s=C6.get();Ye(r,e.origin,e.direction);const n=eA(t);Ye(i,r,e.origin),se(i,i,1/Te(i)*n);const o=lQ(t,e.origin),a=P6(e.origin,i);return Di(s),Bi(s,s,a+o,r),Oe(i,i,s),i}function rTe(t,e,i){return mf(t,e,i)?i:(ZSe(e,ea(t),i),oQ(t,i,i))}function oQ(t,e,i){const r=ue(Me.get(),e,ea(t)),s=se(Me.get(),r,t[3]/Te(r));return de(i,s,ea(t))}function aQ(t,e){const i=ue(Me.get(),e,ea(t)),r=un(i),s=t[3]*t[3];return Math.sqrt(Math.abs(r-s))}function lQ(t,e){const i=ue(Me.get(),e,ea(t)),r=Te(i),s=eA(t),n=s+Math.abs(s-r);return ar(s/n)}const E6=$();function cQ(t,e,i,r){const s=ue(E6,e,ea(t));switch(i){case 0:{const n=CH(s,E6)[2];return ne(r,-Math.sin(n),Math.cos(n),0)}case 1:{const n=CH(s,E6),o=n[1],a=n[2],l=Math.sin(o);return ne(r,-l*Math.cos(a),-l*Math.sin(a),Math.cos(o))}case 2:return _e(r,s);default:return}}function uQ(t,e){const i=ue(O6,e,ea(t));return Te(i)-t[3]}function sTe(t,e,i,r){const s=uQ(t,e),n=cQ(t,e,2,O6),o=se(O6,n,i-s);return de(r,e,o)}const nTe=$(),O6=$(),oTe=Object.freeze({__proto__:null,create:rs,copy:F1,fromCenterAndRadius:iQ,wrap:rQ,clear:sQ,fromRadius:KP,getRadius:eA,getCenter:ea,fromValues:nQ,elevate:KSe,setExtent:eTe,intersectRay:mf,intersectsRay:$6,intersectRayClosestSilhouette:iTe,closestPointOnSilhouette:L1,closestPoint:rTe,projectPoint:oQ,distanceToSilhouette:aQ,angleToSilhouette:lQ,axisAt:cQ,altitudeAt:uQ,setAltitudeAt:sTe});function Mt(t=fTe){return[t[0],t[1],t[2],t[3]]}function aTe(t,e,i,r){return R6(t,e,i,r,T6.get())}function tA(t,e=Mt()){return R6(t[0],t[1],t[2],t[3],e)}function R6(t,e,i,r,s=Mt()){return s[0]=t,s[1]=e,s[2]=i,s[3]=r,s}function hQ(t,e,i){return re(i,t),i[3]=e,i}function k1(t,e,i){const r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],s=Math.abs(r-1)>1e-5&&r>1e-12?1/Math.sqrt(r):1;return i[0]=e[0]*s,i[1]=e[1]*s,i[2]=e[2]*s,i[3]=-(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]),i}function Us(t,e,i,r=Mt()){const s=i[0]-e[0],n=i[1]-e[1],o=i[2]-e[2],a=t[0]-e[0],l=t[1]-e[1],c=t[2]-e[2],h=n*c-o*l,p=o*a-s*c,f=s*l-n*a,g=h*h+p*p+f*f,y=Math.abs(g-1)>1e-5&&g>1e-12?1/Math.sqrt(g):1;r[0]=h*y,r[1]=p*y,r[2]=f*y,r[3]=-(r[0]*t[0]+r[1]*t[1]+r[2]*t[2])}function dQ(t,e,i,r,s){if(t.count<3)return!1;t.getVec(i,v2);let n=r,o=!1;for(;n<t.count-1&&!o;)t.getVec(n,z1),n++,o=!mo(v2,z1);if(!o)return!1;for(n=Math.max(n,s),o=!1;n<t.count&&!o;)t.getVec(n,yy),n++,ue(iA,v2,z1),_e(iA,iA),ue(rA,z1,yy),_e(rA,rA),o=!mo(v2,yy)&&!mo(z1,yy)&&Math.abs(ye(iA,rA))<lTe;return o?(Us(v2,z1,yy,e),!0):(i!==0||r!==1||s!==2)&&dQ(t,e,0,1,2)}const lTe=.99619469809,v2=$(),z1=$(),yy=$(),iA=$(),rA=$();function I6(t,e,i){return t!==i&&tA(t,i),i[3]=-ye(Li(i),e),i}function D6(t,e){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function _2(t,e,i,r){return Ye(yy,e,t),k1(i,yy,r)}function oot(t,e,i,r){return sA(t,e,ue(Me.get(),i,e),mTe,r)}function vy(t,e,i){return!!_(e)&&sA(t,e.origin,e.direction,gTe,i)}function cTe(t,e,i){return sA(t,e.origin,e.vector,0,i)}function uTe(t,e,i){return sA(t,e.origin,e.vector,1,i)}function pQ(t,e){return hi(t,e)>=0}function hTe(t,e){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5];return t[0]*(t[0]>0?i:n)+t[1]*(t[1]>0?r:o)+t[2]*(t[2]>0?s:a)+t[3]>=0}function dTe(t,e){const i=ye(Li(t),e.ray.direction),r=-hi(t,e.ray.origin);if(r<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return r>0;if((r<0||i<0)&&!(r<0&&i<0))return!0;const s=r/i;return i>0?s<e.c1&&(e.c1=s):s>e.c0&&(e.c0=s),e.c0<=e.c1}function pTe(t,e,i){const r=se(Me.get(),Li(t),-t[3]),s=F6(t,ue(Me.get(),e,r),Me.get());return de(i,s,r),i}function F6(t,e,i){const r=se(Me.get(),Li(t),ye(Li(t),e));return ue(i,e,r),i}function hi(t,e){return ye(Li(t),e)+t[3]}function sA(t,e,i,r,s){const n=ye(Li(t),i);if(n===0)return!1;let o=-(ye(Li(t),e)+t[3])/n;return 1&r&&(o=Re(o,0,1)),!(!(4&r)&&o<0||!(8&r)&&o>1)&&(de(s,e,se(s,i,o)),!0)}function Li(t){return t}const fTe=[0,0,1,0],mTe=12,gTe=8,L6=le.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");class fQ{constructor(){this.plane=Mt(),this.origin=$(),this.basis1=$(),this.basis2=$()}}function _y(t=MQ){return{plane:Mt(t.plane),origin:br(t.origin),basis1:br(t.basis1),basis2:br(t.basis2)}}function yTe(t,e,i){const r=$Te.get();return r.origin=t,r.basis1=e,r.basis2=i,r.plane=aTe(0,0,0,0),nA(r),r}function V1(t,e=_y()){return k6(t.origin,t.basis1,t.basis2,e)}function mQ(t,e){re(e.origin,t.origin),re(e.basis1,t.basis1),re(e.basis2,t.basis2),tA(t.plane,e.plane)}function k6(t,e,i,r=_y()){return re(r.origin,t),re(r.basis1,e),re(r.basis2,i),nA(r),PTe(r,"fromValues()"),r}function nA(t){_2(t.basis2,t.basis1,t.origin,t.plane)}function gQ(t,e,i){t!==i&&V1(t,i);const r=se(Me.get(),Xh(t),e);return de(i.origin,i.origin,r),i.plane[3]-=e,i}function vTe(t,e,i){return yQ(e,i),gQ(i,U6(t,t.origin),i),i}function yQ(t,e=_y()){const i=(t[2]-t[0])/2,r=(t[3]-t[1])/2;return ne(e.origin,t[0]+i,t[1]+r,0),ne(e.basis1,i,0,0),ne(e.basis2,0,r,0),R6(0,0,1,0,e.plane),e}function z6(t,e,i){return!!vy(t.plane,e,i)&&SQ(t,i)}function _Te(t,e,i){if(z6(t,e,i))return i;const r=vQ(t,e,Me.get());return de(i,e.origin,se(Me.get(),e.direction,qt(e.origin,r)/Te(e.direction))),i}function vQ(t,e,i){const r=oA.get();CQ(t,e,r,oA.get());let s=Number.POSITIVE_INFINITY;for(const n of B6){const o=j6(t,n,aA.get()),a=Me.get();if(cTe(r,o,a)){const l=Lh(Me.get(),e.origin,a),c=Math.abs(ar(ye(e.direction,l)));c<s&&(s=c,re(i,a))}}return s===Number.POSITIVE_INFINITY?_Q(t,e,i):i}function _Q(t,e,i){if(z6(t,e,i))return i;const r=oA.get(),s=oA.get();CQ(t,e,r,s);let n=Number.POSITIVE_INFINITY;for(const o of B6){const a=j6(t,o,aA.get()),l=Me.get();if(uTe(r,a,l)){const c=WSe(e,l);if(!pQ(s,l))continue;c<n&&(n=c,re(i,l))}}return V6(t,e.origin)<n&&bQ(t,e.origin,i),i}function bQ(t,e,i){const r=pTe(t.plane,e,Me.get()),s=XJ(TQ(t,t.basis1),r,-1,1,Me.get()),n=XJ(TQ(t,t.basis2),r,-1,1,Me.get());return ue(i,de(Me.get(),s,n),t.origin),i}function wQ(t,e,i){const{origin:r,basis1:s,basis2:n}=t,o=ue(Me.get(),e,r),a=y2(s,o),l=y2(n,o),c=y2(Xh(t),o);return ne(i,a,l,c)}function V6(t,e){const i=wQ(t,e,Me.get()),{basis1:r,basis2:s}=t,n=Te(r),o=Te(s),a=Math.max(Math.abs(i[0])-n,0),l=Math.max(Math.abs(i[1])-o,0),c=i[2];return a*a+l*l+c*c}function bTe(t,e){return Math.sqrt(V6(t,e))}function wTe(t,e){let i=Number.NEGATIVE_INFINITY;for(const r of B6){const s=j6(t,r,aA.get()),n=M6(s,e);n>i&&(i=n)}return Math.sqrt(i)}function N6(t,e){return pQ(t.plane,e)&&SQ(t,e)}function xTe(t,e,i,r){return MTe(t,i,r)}function U6(t,e){const i=-t.plane[3];return y2(Xh(t),e)-i}function STe(t,e,i,r){const s=U6(t,e),n=se(ATe,Xh(t),i-s);return de(r,e,n),r}function TTe(t,e){return mo(t.basis1,e.basis1)&&mo(t.basis2,e.basis2)&&mo(t.origin,e.origin)}function xQ(t,e,i){return t!==i&&V1(t,i),Fi(N1,e),Nn(N1,N1),Oe(i.basis1,t.basis1,N1),Oe(i.basis2,t.basis2,N1),Oe(Li(i.plane),Li(t.plane),N1),Oe(i.origin,t.origin,e),I6(i.plane,i.origin,i.plane),i}function CTe(t,e,i,r){return t!==r&&V1(t,r),Bi(lA,Di(lA),e,i),Oe(r.basis1,t.basis1,lA),Oe(r.basis2,t.basis2,lA),nA(r),r}function Xh(t){return Li(t.plane)}function MTe(t,e,i){switch(e){case 0:re(i,t.basis1),_e(i,i);break;case 1:re(i,t.basis2),_e(i,i);break;case 2:re(i,Xh(t))}return i}function SQ(t,e){const i=ue(Me.get(),e,t.origin),r=un(t.basis1),s=un(t.basis2),n=ye(t.basis1,i),o=ye(t.basis2,i);return-n-r<0&&n-r<0&&-o-s<0&&o-s<0}function TQ(t,e){const i=aA.get();return re(i.origin,t.origin),re(i.vector,e),i}function j6(t,e,i){const{basis1:r,basis2:s,origin:n}=t,o=se(Me.get(),r,e.origin[0]),a=se(Me.get(),s,e.origin[1]);de(i.origin,o,a),de(i.origin,i.origin,n);const l=se(Me.get(),r,e.direction[0]),c=se(Me.get(),s,e.direction[1]);return se(i.vector,de(l,l,c),2),i}function PTe(t,e){Math.abs(ye(t.basis1,t.basis2)/(Te(t.basis1)*Te(t.basis2)))>1e-6&&L6.warn(e,"Provided basis vectors are not perpendicular"),Math.abs(ye(t.basis1,Xh(t)))>1e-6&&L6.warn(e,"Basis vectors and plane normal are not perpendicular"),Math.abs(-ye(Xh(t),t.origin)-t.plane[3])>1e-6&&L6.warn(e,"Plane offset is not consistent with plane origin")}function CQ(t,e,i,r){const s=Xh(t);_2(s,e.direction,e.origin,i),_2(Li(i),s,e.origin,r)}const MQ={plane:Mt(),origin:De(0,0,0),basis1:De(1,0,0),basis2:De(0,1,0)},oA=new Yh(Mt),aA=new Yh(ff),ATe=$(),$Te=new Yh(()=>({origin:null,basis1:null,basis2:null,plane:null})),B6=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],N1=be(),lA=be(),ETe=Object.freeze({__proto__:null,BoundedPlaneClass:fQ,create:_y,wrap:yTe,copy:V1,copyWithoutVerify:mQ,fromValues:k6,updateUnboundedPlane:nA,elevate:gQ,setExtent:vTe,fromAABoundingRect:yQ,intersectRay:z6,intersectRayClosestSilhouette:_Te,closestPointOnSilhouette:vQ,closestPoint:_Q,projectPoint:bQ,projectPointLocal:wQ,distance2:V6,distance:bTe,distanceToSilhouette:wTe,extrusionContainsPoint:N6,axisAt:xTe,altitudeAt:U6,setAltitudeAt:STe,equals:TTe,transform:xQ,rotate:CTe,normal:Xh,UP:MQ});function OTe(t){const{value:e,operations:i}=t;return{operations:i,value:i.create(e)}}function RTe(t,e,i){return t.operations.setExtent(t.value,e,i.value),i}function ITe(t){return{operations:t,value:t.create()}}function PQ(t,e,i=ITe(t)){return i.operations=t,t.copy(e,i.value),i}function DTe(t){return PQ(oTe,nQ(0,0,0,Ut(t).radius))}const AQ=2**50;function FTe(){return PQ(ETe,k6([0,0,0],[AQ,0,0],[0,AQ,0]))}function LTe(t,e,i){return t.operations.axisAt(t.value,e,2,i)}function kTe(t,e,i,r){return t.operations.axisAt(t.value,e,i,r)}function zTe(t,e,i){return t.operations.intersectRay(t.value,e,i)}function VTe(t,e,i){return t.operations.intersectRayClosestSilhouette(t.value,e,i)}function NTe(t,e){return t.operations.altitudeAt(t.value,e)}function $Q(t,e,i,r){return t.operations.setAltitudeAt(t.value,e,i,r)}function UTe(t,e,i,r){return e!==r&&ji(r,e),ne(U1,r[12],r[13],r[14]),$Q(t,U1,i,U1),r[12]=U1[0],r[13]=U1[1],r[14]=U1[2],r}function G6(t,e,i){return t.operations.elevate(t.value,e,i.value)}const U1=$();function EQ(t,e,i,r,s){return s[0]=ye(t,e),s[1]=ye(t,i),s[2]=ye(t,r),s}function q6(t,e,i,r,s){re(i,t),re(cA,e),_e(cA,cA),Ye(r,cA,i),Ye(s,r,i)}function OQ(t,e){return t?DP(e):e.isGeographic?Ue.PlateCarree:e}const cA=$(),RQ=96;function aot(t,e){const i=e||t.extent,r=t.width,s=bo(i&&i.spatialReference);return i&&r?i.width/r*s*GZ*RQ:0}function IQ(t,e){return t/(bo(e)*GZ*RQ)}function jTe(t){return new Promise(e=>import("./vxlLayer.f4e70b2f.js").then(i=>i.v).then(({default:i})=>{const r=i({locateFile:BTe,preinitializedWebGLContext:t,onRuntimeInitialized:()=>e(r)})})).catch(e=>Promise.reject(e))}function BTe(t){return kt(`esri/libs/vxl/${t}`)}const uA=le.getLogger("esri.layers.VoxelWasmPerScene");class GTe{constructor(e){this._halfIntTexturesAvailable=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=0,this._renderSlot=22,this._rctx=null,this._renderTargetToRestore=null,this._lastFrameWasStationary=!1,this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536],this._wasmMemBlocks=new Map,this._dbgFlags=new Set,this._view=e,this.initialize()}get canRender(){return!!this._vxl&&this._view.viewingMode==="local"}dbg(e,i){this._dbgFlags.has(e)&&(e===4?uA.error(i):uA.warn(i))}removeRenderPlugin(){this._pluginIsActive&&this._view._stage&&(this.dbg(1,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}initialize(){this.dbg(1,"--initialize--");for(const e of this._wasmMemBlockSizes)this._wasmMemBlocks.set(e,0);this._readyWatchHandle=hn(()=>this._view.ready,e=>{e&&this._view.viewingMode==="local"?(this.dbg(1,"view ready status changed to ready on a local view, calling addRenderPlugin"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this.dbg(1,"view ready status changed, not ready or not a local view!"),this.removeRenderPlugin())},{initial:!0}),this._qualityWatchHandle=hn(()=>{var e;return(e=this._view)==null?void 0:e.qualityProfile},e=>{this.dbg(3,"qualityProfile changed to "+e),this._vxl&&this._vxl.set_quality(this.toWasmQuality(e))},{initial:!0}),this._timeExtentWatchHandle=hn(()=>{var e;return(e=this._view)==null?void 0:e.timeExtent},()=>{if(this._vxl){var e;const i=this._getTimeArgs((e=this._view)==null?void 0:e.timeExtent);this.dbg(3,"sceneView timeExtent changed to useTime="+i.useTime+" st="+i.startTime+" et="+i.endTime),this._vxl.set_scene_time_extent(i.startTime,i.endTime,i.useTime),this._renderPluginContext.requestRender()}},{initial:!0}),this._stationaryWatchHandle=hn(()=>{var e;return(e=this._view)==null?void 0:e.stationary},e=>{this._vxl&&e&&!this._lastFrameWasStationary&&this._renderPluginContext.requestRender()})}initializeRenderContext(e){this.dbg(1,"--initializeRenderContext--");const i=e.renderContext.rctx;i.webglVersion==="webgl2"?(this._renderPluginContext=e,this._rctx=e.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this.initializeWasm(i.gl)):this.dbg(4,"WebGL 1 context only!")}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this.dbg(1,"--uninitializeRenderContext--")}restoreFramebuffer(){if(!this._renderTargetToRestore)return;const e=this._renderTargetToRestore.fbo;if(!this._rctx)return void this.dbg(4,"no context in restoreFramebuffer!");this._rctx.bindFramebuffer(e,!0);const i=this._renderTargetToRestore.viewport;this._rctx.setViewport(i.x,i.y,i.width,i.height)}bindPreviousDepthToSlot(e,i){const r=!!this._rctx,s=!!this._renderTargetToRestore;if(!r||!s)return 0;const n=this._renderTargetToRestore.fbo.depthStencilTexture;return n?(i===0?this._rctx.bindTexture(null,e,!0):this._rctx.bindTexture(n,e,!0),1):(this.dbg(4,"no depth/stencil texture exists!"),0)}setBlendState(e,i,r,s){this._rctx?(this._rctx.setBlendingEnabled(e===1),this._rctx.setBlendFunction(i,r),this._rctx.setBlendEquation(s)):this.dbg(4,"setBlendState callback has no rendering context!")}setFrontFace(e){this._rctx?this._rctx.setFrontFace(e):this.dbg(4,"setFrontFace callback has no rendering context!")}setDepthStencilStateFunction(e,i,r){this._rctx?(this._rctx.setDepthFunction(r),this._rctx.setDepthTestEnabled(e===1),this._rctx.setDepthWriteEnabled(i===1),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(519,0,255),this._rctx.setStencilOpSeparate(1028,7680,7682,7680),this._rctx.setStencilOpSeparate(1029,7680,7683,7680)):this.dbg(4,"setDepthStencilStateFunction callback has no rendering context!")}setRasterizerState(e){if(this._rctx)switch(e){case 1:this._rctx.setFaceCullingEnabled(!1);break;case 3:this._rctx.setCullFace(1029),this._rctx.setFaceCullingEnabled(!0);break;case 2:this._rctx.setCullFace(1028),this._rctx.setFaceCullingEnabled(!0)}else this.dbg(4,"setRasterizerState callback has no rendering context!")}setViewport(e,i,r,s){this._rctx?this._rctx.setViewport(e,i,r,s):this.dbg(4,"setViewport callback has no rendering context!")}_syncRequestsResponses(){this._layers.forEach((e,i)=>{const r=[];e.responses.forEach((a,l)=>{r.push(l),this.dbg(2,"responding for requestID:"+l+" size:"+a.size),this._vxl.respond(i,l,a)});const s=e.responses;for(const a of r)s.delete(a);const n=this._vxl.get_new_requests(i),o=e.abortController.signal;for(const a in n){e.outstandingRequestCount+=1,e.outstandingRequestCount===1&&e.layerView.updatingFlagChanged();const l=n[a],c={responseType:"array-buffer",signal:o};this.dbg(2,"making requestID:"+a+" url:"+l.url),vt(l.url,c).then(h=>{e.outstandingRequestCount-=1,e.outstandingRequestCount===0&&e.layerView.updatingFlagChanged(),this.dbg(2,"have response for requestID:"+a);let p=0;if(h.data.byteLength>0){p=this._vxl._malloc(h.data.byteLength);const f=new Uint8Array(this._vxl.HEAPU8.buffer,p,h.data.byteLength),g=new Uint8Array(h.data);for(let y=0;y<h.data.byteLength;++y)f[y]=g[y]}s.set(+a,{type:l.type,ptr:p,size:h.data.byteLength,success:!0})}).catch(h=>{e.outstandingRequestCount-=1,e.outstandingRequestCount===0&&e.layerView.updatingFlagChanged(),bi(h)||(this.dbg(4,`requestID:${a} failed, error=${h.toString()}`),s.set(+a,{type:l.type,ptr:0,size:0,success:!1}))})}})}updateWasmCamera(e){this._vxl.set_projection_matrix.apply(this._vxl,e.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,e.viewMatrix),this._vxl.set_near_far(e.near,e.far)}isUpdating(e){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(e)&&this._layers.get(e).outstandingRequestCount>0}setEnabled(e,i){this._layers.forEach((r,s)=>{r.layerView===e&&(this._vxl.set_enabled(s,i),this._renderPluginContext.requestRender())})}setSlices(e,i){const r={mask:2,slices:{planes:i,currentEditPlane:-1}};return this._doMaskedUIUpdate(e,r,!0)}setDynamicSections(e,i){const r={mask:4,dynamicSections:{planes:i,currentEditPlane:-1}};return this._doMaskedUIUpdate(e,r,!0)}setStaticSections(e,i){const r={mask:1,staticSections:i};return this._doMaskedUIUpdate(e,r,!0)}setCurrentVariable(e,i){const r={mask:1024,currentVariable:i};return this._doMaskedUIUpdate(e,r,!0)}setRenderMode(e,i){const r={mask:8192,renderMode:i};return this._doMaskedUIUpdate(e,r,!0)}_doMaskedUIUpdate(e,i,r){if(!this._vxl)return!1;let s=!1;return this._layers.forEach((n,o)=>{if(n.layerView===e){const a={str:JSON.stringify(i),byteCount:0,ptr:0,isReusable:!1};this._AllocateBlock(a)&&(s=this._vxl.handle_masked_ui_update(o,a.ptr,a.byteCount)===1,a.isReusable||this._vxl._free(a.ptr))}}),s&&r&&this._renderPluginContext.requestRender(),s}addVoxelLayer(e){if(!this._vxl){const r={layerView:e,resolveCallback:null,rejectCallback:null},s=new Promise((n,o)=>{r.resolveCallback=n,r.rejectCallback=o});return this._newLayers.push(r),s}const i=this._addVoxelLayer(e);return i<0?Promise.reject(-1):Promise.resolve(i)}removeVoxelLayer(e){if(!this._vxl){const s=this._newLayers.findIndex(o=>e===o.layerView);s>=0&&(this._newLayers[s].resolveCallback(-1),this._newLayers.splice(s,1));const n=this._newLayers.length;return n===0&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),n}let i=-1;this._layers.forEach((s,n)=>{s.layerView===e&&(i=n,s.abortController.abort(),this._vxl.remove_layer(i))}),i>=0&&this._layers.delete(i);const r=this._layers.size;return r===0&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),r}_getBlockSize(e){for(const i of this._wasmMemBlockSizes)if(e<i)return i;return-1}_AllocateBlock(e){e.byteCount=this._vxl.lengthBytesUTF8(e.str)+1;const i=this._getBlockSize(e.byteCount);return i<0?(e.isReusable=!1,e.ptr=this._vxl._malloc(e.byteCount)):(e.isReusable=!0,e.ptr=this._wasmMemBlocks.get(i),e.ptr===0&&(e.ptr=this._vxl._malloc(i),this._wasmMemBlocks.set(i,e.ptr))),e.ptr!==0&&(this._vxl.stringToUTF8(e.str,e.ptr,e.byteCount),!0)}_getTimeArgs(e){let i=-Number.MAX_VALUE,r=Number.MAX_VALUE,s=!1;return _(e)&&(e.isAllTime?s=!0:(_(e.start)&&(s=!0,i=e.start.getTime()/1e3),_(e.end)&&(s=!0,r=e.end.getTime()/1e3))),{startTime:i,endTime:r,useTime:s}}_addVoxelLayer(e){var i;const r=e.layer;let s=-1;const n=r.getConfiguration();if(n.length<1)return-1;const o={str:n,byteCount:0,ptr:0,isReusable:!1};if(!this._AllocateBlock(o))return-1;const a=this._getTimeArgs((i=this._view)==null?void 0:i.timeExtent),l=this._view.spatialReference.isWGS84&&r.spatialReference.isWGS84?111319.49079327357:1;if(s=this._vxl.add_layer(r.serviceRoot,o.ptr,o.byteCount,l,l,a.startTime,a.endTime,a.useTime,this.toWasmQuality(this._view.qualityProfile)),o.isReusable||this._vxl._free(o.ptr),s>=0){const c=new AbortController;if(this._layers.set(s,{layerView:e,responses:new Map,outstandingRequestCount:0,abortController:c}),!this._halfIntTexturesAvailable){const h=[];let p="";for(const f of e.layer.variables)f.renderingFormat.type!=="Int16"&&f.renderingFormat.type!=="UInt16"||(h.push(f.name),f.id===e.layer.style.currentVariableId&&(p=f.name));p!==""&&uA.error("#addVoxelLayer_error()",e.layer,`The voxel layer '${e.layer.title}' cannot render the current variable '${p}' in this browser`),h.length>0&&uA.warn("#addVoxelLayer_warning()",e.layer,`The voxel layer '${e.layer.title}' cannot render the variables '${h.toString()}' in this browser`)}return s}return-1}prepareRender(e){if(!this._vxl)return;const i=e.viewForward,r=e.eye;this._vxl.update_camera_pos_and_direction(r[0],r[1],r[2],i[0],i[1],i[2]);const s=this._vxl.cull();this.dbg(2,"missingResourceCount="+s),this._moreToLoad=s>0,this._havePreparedWithAllLayers=this._newLayers.length===0}render(e){if(!this._vxl||e.pass!==this._renderPass||e.slot!==this._renderSlot)return!1;for(const r of this._newLayers){const s=this._addVoxelLayer(r.layerView);s===-1?r.rejectCallback(-1):r.resolveCallback(s)}if(this._newLayers=[],this._layers.size===0)return this.dbg(4,"No voxel layers but RenderPlugin instance is being asked to render!"),!1;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this._syncRequestsResponses(),this._lastFrameWasStationary=this._view.stationary,this._vxl.begin_color_frame(!this._view.stationary||this._moreToLoad,e.scenelightingData.lightingMainDirection[0],e.scenelightingData.lightingMainDirection[1],e.scenelightingData.lightingMainDirection[2]);const i=this._renderTargetToRestore.viewport;return i.width===this._viewportWidth&&i.height===this._viewportHeight||(this._viewportWidth=i.width,this._viewportHeight=i.height,this._vxl.set_viewport(i.width,i.height)),i.x===0&&i.y===0||this.dbg(4,"Unsupported viewport parameters detected!"),this.updateWasmCamera(e.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,e.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),e.rctx.externalVertexArrayObjectUpdate(),e.rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender(),!0}destroy(){this.dbg(1,"--destroy--"),this.removeRenderPlugin(),this._readyWatchHandle=ln(this._readyWatchHandle),this._qualityWatchHandle=ln(this._qualityWatchHandle),this._timeExtentWatchHandle=ln(this._timeExtentWatchHandle),this._stationaryWatchHandle=ln(this._stationaryWatchHandle),this._vxl&&(this._layers.forEach(e=>{e.abortController.abort()}),this._wasmMemBlocks.forEach(e=>{e!==0&&this._vxl._free(e)}),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}initializeWasm(e){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=jTe(e).then(i=>{var r;if(this._vxl=i,this._vxlPromise=null,this._newLayers.length<=0)return this.dbg(1," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void this.destroy();const s=this._getTimeArgs((r=this._view)==null?void 0:r.timeExtent),n=this._vxl.addFunction(this.restoreFramebuffer.bind(this),"v"),o=this._vxl.addFunction(this.setBlendState.bind(this),"viiii"),a=this._vxl.addFunction(this.setFrontFace.bind(this),"vi"),l=this._vxl.addFunction(this.setRasterizerState.bind(this),"vi"),c=this._vxl.addFunction(this.setDepthStencilStateFunction.bind(this),"viii"),h=this._vxl.addFunction(this.setViewport.bind(this),"viiii"),p=this._vxl.addFunction(this.bindPreviousDepthToSlot.bind(this),"iii");this._vxl.initialize_voxel_wasm(n,o,a,l,c,h,p,s.startTime,s.endTime,s.useTime),this._renderPluginContext&&this._renderPluginContext.requestRender()}).catch(()=>{for(const i of this._newLayers)i.rejectCallback(-2);this.dbg(4," WASM failed to download, removing RenderPlugin and destroying"),this.destroy()})),this._vxlPromise)}pickDepth(e,i,r){if(!this._vxl||!this._rctx||this._layers.size===0)return null;const s=r.viewport[3]-i;if(e<0||e>r.viewport[2]||i<0||i>r.viewport[3])return this.dbg(4,`pickDepth: outOfRange, screenXY=[${e}, ${s}], vp=[${r.viewport.toString()}]`),null;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const n=r.viewForward,o=r.eye;this._vxl.update_camera_pos_and_direction(o[0],o[1],o[2],n[0],n[1],n[2]),this.updateWasmCamera(r),this._vxl.begin_frame();const a=this._vxl.pick_depth(e,s);return this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate(),a.success?a.distanceToCamera:null}toWasmQuality(e){switch(e){case"low":return 0;case"medium":return 1;case"high":return 2}}}class j1{constructor(){this.view2WASM=new Map}static getInstance(){return j1.instance||(j1.instance=new j1),j1.instance}getVoxelWasmPerSceneView(e){return this.view2WASM.has(e)?this.view2WASM.get(e):null}isUpdating(e,i){return!!this.view2WASM.has(e)&&this.view2WASM.get(e).isUpdating(i)}addLayer(e,i){return this.view2WASM.has(e)||this.view2WASM.set(e,new GTe(e)),this.view2WASM.get(e).addVoxelLayer(i)}removeLayer(e,i){this.view2WASM.has(e)&&this.view2WASM.get(e).removeVoxelLayer(i)<1&&this.view2WASM.delete(e)}setLayerEnabled(e,i,r){this.view2WASM.has(e)&&this.view2WASM.get(e).setEnabled(i,r)}setLayerSlices(e,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===e&&(r=s.setSlices(o,i))})}),r}setLayerDynamicSections(e,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===e&&(r=s.setDynamicSections(o,i))})}),r}setLayerCurrentVariable(e,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===e&&(r=s.setCurrentVariable(o,i))})}),r}setLayerRenderMode(e,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===e&&(r=s.setRenderMode(o,i))})}),r}setLayerStaticSections(e,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===e&&(r=s.setStaticSections(o,i))})}),r}}function hA(t){return t&&t.type==="base-tile"||t.type==="tile"||t.type==="elevation"||t.type==="imagery-tile"||t.type==="base-elevation"||t.type==="open-street-map"||t.type==="wcs"||t.type==="web-tile"||t.type==="wmts"||t.type==="vector-tile"}function DQ(t){return t.parent&&t.parent.declaredClass==="esri.Basemap"&&t.parent.baseLayers.indexOf(t)>-1}function H6(t){return t.labelsVisible===!0&&t.labelingInfo!=null&&t.labelingInfo.length>0}const dA={widthBreakpoint:{getValue(t){const e=t.viewSize[0],i=t.breakpoints,r=this.values;return e<=i.xsmall?r.xsmall:e<=i.small?r.small:e<=i.medium?r.medium:e<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(t){const e=t.viewSize[1],i=t.breakpoints,r=this.values;return e<=i.xsmall?r.xsmall:e<=i.small?r.small:e<=i.medium?r.medium:e<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(t){const e=t.viewSize,i=e[0],r=e[1],s=this.values;return r>=i?s.portrait:s.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},W6={xsmall:544,small:768,medium:992,large:1200};function qTe(t){const e=t;return e&&e.xsmall<e.small&&e.small<e.medium&&e.medium<e.large}function Z6(t,e){return e?dA[t].valueToClassName[e].split(" "):[]}const HTe=t=>{let e=class extends t{constructor(...i){super(...i),this._breakpointsHandles=new dt,this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=W6}initialize(){this._breakpointsHandles.add(Ke(this,["breakpoints","size"],this._updateClassNames))}destroy(){this.destroyed||(this._removeActiveClassNames(),this._breakpointsHandles.destroy(),this._breakpointsHandles=null)}set breakpoints(i){if(i===this._get("breakpoints"))return;const r=qTe(i);if(!r){const s=JSON.stringify(W6,null,2);console.warn("provided breakpoints are not valid, using defaults:"+s)}i=r?i:W6,this._set("breakpoints",E({},i))}_updateClassNames(){if(!this.container)return;const i=uo.acquire(),r=uo.acquire();let s,n=!1;for(s in dA){const o=this[s],a=dA[s].getValue({viewSize:this.size,breakpoints:this.breakpoints});o!==a&&(n=!0,this[s]=a,Z6(s,o).forEach(l=>r.push(l)),Z6(s,a).forEach(l=>i.push(l)))}n&&(this._applyClassNameChanges(i,r),uo.release(i),uo.release(r))}_applyClassNameChanges(i,r){const s=this.container;s&&(r.forEach(n=>s.classList.remove(n)),i.forEach(n=>s.classList.add(n)))}_removeActiveClassNames(){const i=this.container;if(!i)return;let r;for(r in dA)Z6(r,this[r]).forEach(s=>i.classList.remove(s))}};return u([d()],e.prototype,"breakpoints",null),u([d()],e.prototype,"orientation",void 0),u([d()],e.prototype,"widthBreakpoint",void 0),u([d()],e.prototype,"heightBreakpoint",void 0),e=u([R("esri.views.BreakpointsOwner")],e),e};/*!
 * @esri/arcgis-html-sanitizer - v2.9.0 - Mon Dec 13 2021 15:07:01 GMT-0500 (Eastern Standard Time)
 * Copyright (c) 2021 - Environmental Systems Research Institute, Inc.
 * Apache-2.0
 * 
 * js-xss
 * Copyright (c) 2012-2017 Zongmin Lei(雷宗民) <leizongmin@gmail.com>
 * http://ucdok.com
 * MIT License, see https://github.com/leizongmin/js-xss/blob/master/LICENSE for details
 * 
 * Lodash/isPlainObject
 * Copyright (c) JS Foundation and other contributors <https://js.foundation/>
 * MIT License, see https://raw.githubusercontent.com/lodash/lodash/4.17.10-npm/LICENSE for details
 */var WTe="[object Object]";function ZTe(t){var e=!1;if(t!=null&&typeof t.toString!="function")try{e=!!(t+"")}catch{}return e}function JTe(t,e){return function(i){return t(e(i))}}var QTe=Function.prototype,FQ=Object.prototype,LQ=QTe.toString,YTe=FQ.hasOwnProperty,XTe=LQ.call(Object),KTe=FQ.toString,e3e=JTe(Object.getPrototypeOf,Object);function t3e(t){return!!t&&typeof t=="object"}function i3e(t){if(!t3e(t)||KTe.call(t)!=WTe||ZTe(t))return!1;var e=e3e(t);if(e===null)return!0;var i=YTe.call(e,"constructor")&&e.constructor;return typeof i=="function"&&i instanceof i&&LQ.call(i)==XTe}var r3e=i3e,B1={exports:{}},ur={},b2={exports:{}},by={};function kQ(){var t={};return t["align-content"]=!1,t["align-items"]=!1,t["align-self"]=!1,t["alignment-adjust"]=!1,t["alignment-baseline"]=!1,t.all=!1,t["anchor-point"]=!1,t.animation=!1,t["animation-delay"]=!1,t["animation-direction"]=!1,t["animation-duration"]=!1,t["animation-fill-mode"]=!1,t["animation-iteration-count"]=!1,t["animation-name"]=!1,t["animation-play-state"]=!1,t["animation-timing-function"]=!1,t.azimuth=!1,t["backface-visibility"]=!1,t.background=!0,t["background-attachment"]=!0,t["background-clip"]=!0,t["background-color"]=!0,t["background-image"]=!0,t["background-origin"]=!0,t["background-position"]=!0,t["background-repeat"]=!0,t["background-size"]=!0,t["baseline-shift"]=!1,t.binding=!1,t.bleed=!1,t["bookmark-label"]=!1,t["bookmark-level"]=!1,t["bookmark-state"]=!1,t.border=!0,t["border-bottom"]=!0,t["border-bottom-color"]=!0,t["border-bottom-left-radius"]=!0,t["border-bottom-right-radius"]=!0,t["border-bottom-style"]=!0,t["border-bottom-width"]=!0,t["border-collapse"]=!0,t["border-color"]=!0,t["border-image"]=!0,t["border-image-outset"]=!0,t["border-image-repeat"]=!0,t["border-image-slice"]=!0,t["border-image-source"]=!0,t["border-image-width"]=!0,t["border-left"]=!0,t["border-left-color"]=!0,t["border-left-style"]=!0,t["border-left-width"]=!0,t["border-radius"]=!0,t["border-right"]=!0,t["border-right-color"]=!0,t["border-right-style"]=!0,t["border-right-width"]=!0,t["border-spacing"]=!0,t["border-style"]=!0,t["border-top"]=!0,t["border-top-color"]=!0,t["border-top-left-radius"]=!0,t["border-top-right-radius"]=!0,t["border-top-style"]=!0,t["border-top-width"]=!0,t["border-width"]=!0,t.bottom=!1,t["box-decoration-break"]=!0,t["box-shadow"]=!0,t["box-sizing"]=!0,t["box-snap"]=!0,t["box-suppress"]=!0,t["break-after"]=!0,t["break-before"]=!0,t["break-inside"]=!0,t["caption-side"]=!1,t.chains=!1,t.clear=!0,t.clip=!1,t["clip-path"]=!1,t["clip-rule"]=!1,t.color=!0,t["color-interpolation-filters"]=!0,t["column-count"]=!1,t["column-fill"]=!1,t["column-gap"]=!1,t["column-rule"]=!1,t["column-rule-color"]=!1,t["column-rule-style"]=!1,t["column-rule-width"]=!1,t["column-span"]=!1,t["column-width"]=!1,t.columns=!1,t.contain=!1,t.content=!1,t["counter-increment"]=!1,t["counter-reset"]=!1,t["counter-set"]=!1,t.crop=!1,t.cue=!1,t["cue-after"]=!1,t["cue-before"]=!1,t.cursor=!1,t.direction=!1,t.display=!0,t["display-inside"]=!0,t["display-list"]=!0,t["display-outside"]=!0,t["dominant-baseline"]=!1,t.elevation=!1,t["empty-cells"]=!1,t.filter=!1,t.flex=!1,t["flex-basis"]=!1,t["flex-direction"]=!1,t["flex-flow"]=!1,t["flex-grow"]=!1,t["flex-shrink"]=!1,t["flex-wrap"]=!1,t.float=!1,t["float-offset"]=!1,t["flood-color"]=!1,t["flood-opacity"]=!1,t["flow-from"]=!1,t["flow-into"]=!1,t.font=!0,t["font-family"]=!0,t["font-feature-settings"]=!0,t["font-kerning"]=!0,t["font-language-override"]=!0,t["font-size"]=!0,t["font-size-adjust"]=!0,t["font-stretch"]=!0,t["font-style"]=!0,t["font-synthesis"]=!0,t["font-variant"]=!0,t["font-variant-alternates"]=!0,t["font-variant-caps"]=!0,t["font-variant-east-asian"]=!0,t["font-variant-ligatures"]=!0,t["font-variant-numeric"]=!0,t["font-variant-position"]=!0,t["font-weight"]=!0,t.grid=!1,t["grid-area"]=!1,t["grid-auto-columns"]=!1,t["grid-auto-flow"]=!1,t["grid-auto-rows"]=!1,t["grid-column"]=!1,t["grid-column-end"]=!1,t["grid-column-start"]=!1,t["grid-row"]=!1,t["grid-row-end"]=!1,t["grid-row-start"]=!1,t["grid-template"]=!1,t["grid-template-areas"]=!1,t["grid-template-columns"]=!1,t["grid-template-rows"]=!1,t["hanging-punctuation"]=!1,t.height=!0,t.hyphens=!1,t.icon=!1,t["image-orientation"]=!1,t["image-resolution"]=!1,t["ime-mode"]=!1,t["initial-letters"]=!1,t["inline-box-align"]=!1,t["justify-content"]=!1,t["justify-items"]=!1,t["justify-self"]=!1,t.left=!1,t["letter-spacing"]=!0,t["lighting-color"]=!0,t["line-box-contain"]=!1,t["line-break"]=!1,t["line-grid"]=!1,t["line-height"]=!1,t["line-snap"]=!1,t["line-stacking"]=!1,t["line-stacking-ruby"]=!1,t["line-stacking-shift"]=!1,t["line-stacking-strategy"]=!1,t["list-style"]=!0,t["list-style-image"]=!0,t["list-style-position"]=!0,t["list-style-type"]=!0,t.margin=!0,t["margin-bottom"]=!0,t["margin-left"]=!0,t["margin-right"]=!0,t["margin-top"]=!0,t["marker-offset"]=!1,t["marker-side"]=!1,t.marks=!1,t.mask=!1,t["mask-box"]=!1,t["mask-box-outset"]=!1,t["mask-box-repeat"]=!1,t["mask-box-slice"]=!1,t["mask-box-source"]=!1,t["mask-box-width"]=!1,t["mask-clip"]=!1,t["mask-image"]=!1,t["mask-origin"]=!1,t["mask-position"]=!1,t["mask-repeat"]=!1,t["mask-size"]=!1,t["mask-source-type"]=!1,t["mask-type"]=!1,t["max-height"]=!0,t["max-lines"]=!1,t["max-width"]=!0,t["min-height"]=!0,t["min-width"]=!0,t["move-to"]=!1,t["nav-down"]=!1,t["nav-index"]=!1,t["nav-left"]=!1,t["nav-right"]=!1,t["nav-up"]=!1,t["object-fit"]=!1,t["object-position"]=!1,t.opacity=!1,t.order=!1,t.orphans=!1,t.outline=!1,t["outline-color"]=!1,t["outline-offset"]=!1,t["outline-style"]=!1,t["outline-width"]=!1,t.overflow=!1,t["overflow-wrap"]=!1,t["overflow-x"]=!1,t["overflow-y"]=!1,t.padding=!0,t["padding-bottom"]=!0,t["padding-left"]=!0,t["padding-right"]=!0,t["padding-top"]=!0,t.page=!1,t["page-break-after"]=!1,t["page-break-before"]=!1,t["page-break-inside"]=!1,t["page-policy"]=!1,t.pause=!1,t["pause-after"]=!1,t["pause-before"]=!1,t.perspective=!1,t["perspective-origin"]=!1,t.pitch=!1,t["pitch-range"]=!1,t["play-during"]=!1,t.position=!1,t["presentation-level"]=!1,t.quotes=!1,t["region-fragment"]=!1,t.resize=!1,t.rest=!1,t["rest-after"]=!1,t["rest-before"]=!1,t.richness=!1,t.right=!1,t.rotation=!1,t["rotation-point"]=!1,t["ruby-align"]=!1,t["ruby-merge"]=!1,t["ruby-position"]=!1,t["shape-image-threshold"]=!1,t["shape-outside"]=!1,t["shape-margin"]=!1,t.size=!1,t.speak=!1,t["speak-as"]=!1,t["speak-header"]=!1,t["speak-numeral"]=!1,t["speak-punctuation"]=!1,t["speech-rate"]=!1,t.stress=!1,t["string-set"]=!1,t["tab-size"]=!1,t["table-layout"]=!1,t["text-align"]=!0,t["text-align-last"]=!0,t["text-combine-upright"]=!0,t["text-decoration"]=!0,t["text-decoration-color"]=!0,t["text-decoration-line"]=!0,t["text-decoration-skip"]=!0,t["text-decoration-style"]=!0,t["text-emphasis"]=!0,t["text-emphasis-color"]=!0,t["text-emphasis-position"]=!0,t["text-emphasis-style"]=!0,t["text-height"]=!0,t["text-indent"]=!0,t["text-justify"]=!0,t["text-orientation"]=!0,t["text-overflow"]=!0,t["text-shadow"]=!0,t["text-space-collapse"]=!0,t["text-transform"]=!0,t["text-underline-position"]=!0,t["text-wrap"]=!0,t.top=!1,t.transform=!1,t["transform-origin"]=!1,t["transform-style"]=!1,t.transition=!1,t["transition-delay"]=!1,t["transition-duration"]=!1,t["transition-property"]=!1,t["transition-timing-function"]=!1,t["unicode-bidi"]=!1,t["vertical-align"]=!1,t.visibility=!1,t["voice-balance"]=!1,t["voice-duration"]=!1,t["voice-family"]=!1,t["voice-pitch"]=!1,t["voice-range"]=!1,t["voice-rate"]=!1,t["voice-stress"]=!1,t["voice-volume"]=!1,t.volume=!1,t["white-space"]=!1,t.widows=!1,t.width=!0,t["will-change"]=!1,t["word-break"]=!0,t["word-spacing"]=!0,t["word-wrap"]=!0,t["wrap-flow"]=!1,t["wrap-through"]=!1,t["writing-mode"]=!1,t["z-index"]=!1,t}function s3e(t,e,i){}function n3e(t,e,i){}var o3e=/javascript\s*\:/img;function a3e(t,e){return o3e.test(e)?"":e}by.whiteList=kQ();by.getDefaultWhiteList=kQ;by.onAttr=s3e;by.onIgnoreAttr=n3e;by.safeAttrValue=a3e;var l3e={indexOf:function(t,e){var i,r;if(Array.prototype.indexOf)return t.indexOf(e);for(i=0,r=t.length;i<r;i++)if(t[i]===e)return i;return-1},forEach:function(t,e,i){var r,s;if(Array.prototype.forEach)return t.forEach(e,i);for(r=0,s=t.length;r<s;r++)e.call(i,t[r],r,t)},trim:function(t){return String.prototype.trim?t.trim():t.replace(/(^\s*)|(\s*$)/g,"")},trimRight:function(t){return String.prototype.trimRight?t.trimRight():t.replace(/(\s*$)/g,"")}},w2=l3e;function c3e(t,e){t=w2.trimRight(t),t[t.length-1]!==";"&&(t+=";");var i=t.length,r=!1,s=0,n=0,o="";function a(){if(!r){var h=w2.trim(t.slice(s,n)),p=h.indexOf(":");if(p!==-1){var f=w2.trim(h.slice(0,p)),g=w2.trim(h.slice(p+1));if(f){var y=e(s,o.length,f,g,h);y&&(o+=y+"; ")}}}s=n+1}for(;n<i;n++){var l=t[n];if(l==="/"&&t[n+1]==="*"){var c=t.indexOf("*/",n+2);if(c===-1)break;n=c+1,s=n+1,r=!1}else l==="("?r=!0:l===")"?r=!1:l===";"?r||a():l===`
`&&a()}return w2.trim(o)}var u3e=c3e,pA=by,h3e=u3e;function zQ(t){return t==null}function d3e(t){var e={};for(var i in t)e[i]=t[i];return e}function VQ(t){t=d3e(t||{}),t.whiteList=t.whiteList||pA.whiteList,t.onAttr=t.onAttr||pA.onAttr,t.onIgnoreAttr=t.onIgnoreAttr||pA.onIgnoreAttr,t.safeAttrValue=t.safeAttrValue||pA.safeAttrValue,this.options=t}VQ.prototype.process=function(t){if(t=t||"",t=t.toString(),!t)return"";var e=this,i=e.options,r=i.whiteList,s=i.onAttr,n=i.onIgnoreAttr,o=i.safeAttrValue,a=h3e(t,function(l,c,h,p,f){var g=r[h],y=!1;if(g===!0?y=g:typeof g=="function"?y=g(p):g instanceof RegExp&&(y=g.test(p)),y!==!0&&(y=!1),p=o(h,p),!!p){var v={position:c,sourcePosition:l,source:f,isWhite:y};if(y){var b=s(h,p,v);return zQ(b)?h+":"+p:b}else{var b=n(h,p,v);if(!zQ(b))return b}}});return a};var p3e=VQ;(function(t,e){var i=by,r=p3e;function s(o,a){var l=new r(a);return l.process(o)}e=t.exports=s,e.FilterCSS=r;for(var n in i)e[n]=i[n]})(b2,b2.exports);var J6={indexOf:function(t,e){var i,r;if(Array.prototype.indexOf)return t.indexOf(e);for(i=0,r=t.length;i<r;i++)if(t[i]===e)return i;return-1},forEach:function(t,e,i){var r,s;if(Array.prototype.forEach)return t.forEach(e,i);for(r=0,s=t.length;r<s;r++)e.call(i,t[r],r,t)},trim:function(t){return String.prototype.trim?t.trim():t.replace(/(^\s*)|(\s*$)/g,"")},spaceIndex:function(t){var e=/\s|\n|\t/,i=e.exec(t);return i?i.index:-1}},f3e=b2.exports.FilterCSS,m3e=b2.exports.getDefaultWhiteList,fA=J6;function NQ(){return{a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height"],ins:["datetime"],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}}var UQ=new f3e;function g3e(t,e,i){}function y3e(t,e,i){}function v3e(t,e,i){}function _3e(t,e,i){}function jQ(t){return t.replace(w3e,"&lt;").replace(x3e,"&gt;")}function b3e(t,e,i,r){if(i=QQ(i),e==="href"||e==="src"){if(i=fA.trim(i),i==="#")return"#";if(!(i.substr(0,7)==="http://"||i.substr(0,8)==="https://"||i.substr(0,7)==="mailto:"||i.substr(0,4)==="tel:"||i.substr(0,11)==="data:image/"||i.substr(0,6)==="ftp://"||i.substr(0,2)==="./"||i.substr(0,3)==="../"||i[0]==="#"||i[0]==="/"))return""}else if(e==="background"){if(mA.lastIndex=0,mA.test(i))return""}else if(e==="style"){if(BQ.lastIndex=0,BQ.test(i)||(GQ.lastIndex=0,GQ.test(i)&&(mA.lastIndex=0,mA.test(i))))return"";r!==!1&&(r=r||UQ,i=r.process(i))}return i=YQ(i),i}var w3e=/</g,x3e=/>/g,S3e=/"/g,T3e=/&quot;/g,C3e=/&#([a-zA-Z0-9]*);?/gim,M3e=/&colon;?/gim,P3e=/&newline;?/gim,mA=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a)\:/gi,BQ=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,GQ=/u\s*r\s*l\s*\(.*/gi;function qQ(t){return t.replace(S3e,"&quot;")}function HQ(t){return t.replace(T3e,'"')}function WQ(t){return t.replace(C3e,function(i,r){return r[0]==="x"||r[0]==="X"?String.fromCharCode(parseInt(r.substr(1),16)):String.fromCharCode(parseInt(r,10))})}function ZQ(t){return t.replace(M3e,":").replace(P3e," ")}function JQ(t){for(var e="",i=0,r=t.length;i<r;i++)e+=t.charCodeAt(i)<32?" ":t.charAt(i);return fA.trim(e)}function QQ(t){return t=HQ(t),t=WQ(t),t=ZQ(t),t=JQ(t),t}function YQ(t){return t=qQ(t),t=jQ(t),t}function A3e(){return""}function $3e(t,e){typeof e!="function"&&(e=function(){});var i=!Array.isArray(t);function r(o){return i?!0:fA.indexOf(t,o)!==-1}var s=[],n=!1;return{onIgnoreTag:function(o,a,l){if(r(o))if(l.isClosing){var c="[/removed]",h=l.position+c.length;return s.push([n!==!1?n:l.position,h]),n=!1,c}else return n||(n=l.position),"[removed]";else return e(o,a,l)},remove:function(o){var a="",l=0;return fA.forEach(s,function(c){a+=o.slice(l,c[0]),l=c[1]}),a+=o.slice(l),a}}}function E3e(t){for(var e="",i=0;i<t.length;){var r=t.indexOf("<!--",i);if(r===-1){e+=t.slice(i);break}e+=t.slice(i,r);var s=t.indexOf("-->",r);if(s===-1)break;i=s+3}return e}function O3e(t){var e=t.split("");return e=e.filter(function(i){var r=i.charCodeAt(0);return r===127?!1:r<=31?r===10||r===13:!0}),e.join("")}ur.whiteList=NQ();ur.getDefaultWhiteList=NQ;ur.onTag=g3e;ur.onIgnoreTag=y3e;ur.onTagAttr=v3e;ur.onIgnoreTagAttr=_3e;ur.safeAttrValue=b3e;ur.escapeHtml=jQ;ur.escapeQuote=qQ;ur.unescapeQuote=HQ;ur.escapeHtmlEntities=WQ;ur.escapeDangerHtml5Entities=ZQ;ur.clearNonPrintableCharacter=JQ;ur.friendlyAttrValue=QQ;ur.escapeAttrValue=YQ;ur.onIgnoreTagStripAll=A3e;ur.StripTagBody=$3e;ur.stripCommentTag=E3e;ur.stripBlankChar=O3e;ur.cssFilter=UQ;ur.getDefaultCSSWhiteList=m3e;var gA={},gf=J6;function R3e(t){var e=gf.spaceIndex(t);if(e===-1)var i=t.slice(1,-1);else var i=t.slice(1,e+1);return i=gf.trim(i).toLowerCase(),i.slice(0,1)==="/"&&(i=i.slice(1)),i.slice(-1)==="/"&&(i=i.slice(0,-1)),i}function I3e(t){return t.slice(0,2)==="</"}function D3e(t,e,i){var r="",s=0,n=!1,o=!1,a=0,l=t.length,c="",h="";e:for(a=0;a<l;a++){var p=t.charAt(a);if(n===!1){if(p==="<"){n=a;continue}}else if(o===!1){if(p==="<"){r+=i(t.slice(s,a)),n=a,s=a;continue}if(p===">"){r+=i(t.slice(s,n)),h=t.slice(n,a+1),c=R3e(h),r+=e(n,r.length,c,h,I3e(h)),s=a+1,n=!1;continue}if(p==='"'||p==="'")for(var f=1,g=t.charAt(a-f);g.trim()===""||g==="=";){if(g==="="){o=p;continue e}g=t.charAt(a-++f)}}else if(p===o){o=!1;continue}}return s<t.length&&(r+=i(t.substr(s))),r}var F3e=/[^a-zA-Z0-9_:\.\-]/gim;function L3e(t,e){var i=0,r=[],s=!1,n=t.length;function o(p,f){if(p=gf.trim(p),p=p.replace(F3e,"").toLowerCase(),!(p.length<1)){var g=e(p,f||"");g&&r.push(g)}}for(var a=0;a<n;a++){var l=t.charAt(a),c,h;if(s===!1&&l==="="){s=t.slice(i,a),i=a+1;continue}if(s!==!1&&a===i&&(l==='"'||l==="'")&&t.charAt(a-1)==="="){if(h=t.indexOf(l,a+1),h===-1)break;c=gf.trim(t.slice(i+1,h)),o(s,c),s=!1,a=h,i=a+1;continue}if(/\s|\n|\t/.test(l))if(t=t.replace(/\s|\n|\t/g," "),s===!1)if(h=k3e(t,a),h===-1){c=gf.trim(t.slice(i,a)),o(c),s=!1,i=a+1;continue}else{a=h-1;continue}else if(h=z3e(t,a-1),h===-1){c=gf.trim(t.slice(i,a)),c=XQ(c),o(s,c),s=!1,i=a+1;continue}else continue}return i<t.length&&(s===!1?o(t.slice(i)):o(s,XQ(gf.trim(t.slice(i))))),gf.trim(r.join(" "))}function k3e(t,e){for(;e<t.length;e++){var i=t[e];if(i!==" ")return i==="="?e:-1}}function z3e(t,e){for(;e>0;e--){var i=t[e];if(i!==" ")return i==="="?e:-1}}function V3e(t){return t[0]==='"'&&t[t.length-1]==='"'||t[0]==="'"&&t[t.length-1]==="'"}function XQ(t){return V3e(t)?t.substr(1,t.length-2):t}gA.parseTag=D3e;gA.parseAttr=L3e;var N3e=b2.exports.FilterCSS,oc=ur,KQ=gA,U3e=KQ.parseTag,j3e=KQ.parseAttr,yA=J6;function vA(t){return t==null}function B3e(t){var e=yA.spaceIndex(t);if(e===-1)return{html:"",closing:t[t.length-2]==="/"};t=yA.trim(t.slice(e+1,-1));var i=t[t.length-1]==="/";return i&&(t=yA.trim(t.slice(0,-1))),{html:t,closing:i}}function G3e(t){var e={};for(var i in t)e[i]=t[i];return e}function eY(t){t=G3e(t||{}),t.stripIgnoreTag&&(t.onIgnoreTag&&console.error('Notes: cannot use these two options "stripIgnoreTag" and "onIgnoreTag" at the same time'),t.onIgnoreTag=oc.onIgnoreTagStripAll),t.whiteList=t.whiteList||oc.whiteList,t.onTag=t.onTag||oc.onTag,t.onTagAttr=t.onTagAttr||oc.onTagAttr,t.onIgnoreTag=t.onIgnoreTag||oc.onIgnoreTag,t.onIgnoreTagAttr=t.onIgnoreTagAttr||oc.onIgnoreTagAttr,t.safeAttrValue=t.safeAttrValue||oc.safeAttrValue,t.escapeHtml=t.escapeHtml||oc.escapeHtml,this.options=t,t.css===!1?this.cssFilter=!1:(t.css=t.css||{},this.cssFilter=new N3e(t.css))}eY.prototype.process=function(t){if(t=t||"",t=t.toString(),!t)return"";var e=this,i=e.options,r=i.whiteList,s=i.onTag,n=i.onIgnoreTag,o=i.onTagAttr,a=i.onIgnoreTagAttr,l=i.safeAttrValue,c=i.escapeHtml,h=e.cssFilter;i.stripBlankChar&&(t=oc.stripBlankChar(t)),i.allowCommentTag||(t=oc.stripCommentTag(t));var p=!1;if(i.stripIgnoreTagBody){var p=oc.StripTagBody(i.stripIgnoreTagBody,n);n=p.onIgnoreTag}var f=U3e(t,function(g,y,v,b,w){var S={sourcePosition:g,position:y,isClosing:w,isWhite:r.hasOwnProperty(v)},T=s(v,b,S);if(!vA(T))return T;if(S.isWhite){if(S.isClosing)return"</"+v+">";var C=B3e(b),M=r[v],P=j3e(C.html,function(z,D){var U=yA.indexOf(M,z)!==-1,G=o(v,z,D,U);if(!vA(G))return G;if(U)return D=l(v,z,D,h),D?z+'="'+D+'"':z;var G=a(v,z,D,U);return vA(G)?void 0:G}),b="<"+v;return P&&(b+=" "+P),C.closing&&(b+=" /"),b+=">",b}else{var T=n(v,b,S);return vA(T)?c(b):T}},c);return p&&(f=p.remove(f)),f};var q3e=eY;(function(t,e){var i=ur,r=gA,s=q3e;function n(l,c){var h=new s(c);return h.process(l)}e=t.exports=n,e.filterXSS=n,e.FilterXSS=s;for(var o in i)e[o]=i[o];for(var o in r)e[o]=r[o];function a(){return typeof self!="undefined"&&typeof DedicatedWorkerGlobalScope!="undefined"&&self instanceof DedicatedWorkerGlobalScope}a()&&(self.filterXSS=t.exports)})(B1,B1.exports);var H3e=function(){function t(e,i){var r=this;this.arcgisWhiteList={a:["href","style","target"],abbr:["title"],audio:["autoplay","controls","loop","muted","preload"],b:[],br:[],dd:["style"],div:["align","style"],dl:["style"],dt:["style"],em:[],figcaption:["style"],figure:["style"],font:["color","face","size","style"],h1:["style"],h2:["style"],h3:["style"],h4:["style"],h5:["style"],h6:["style"],hr:[],i:[],img:["alt","border","height","src","style","width"],li:[],ol:[],p:["style"],source:["media","src","type"],span:["style"],strong:[],sub:["style"],sup:["style"],table:["border","cellpadding","cellspacing","height","style","width"],tbody:[],tr:["align","height","style","valign"],td:["align","colspan","height","nowrap","rowspan","style","valign","width"],th:["align","colspan","height","nowrap","rowspan","style","valign","width"],u:[],ul:[],video:["autoplay","controls","height","loop","muted","poster","preload","width"]},this.allowedProtocols=["http","https","mailto","iform","tel","flow","lfmobile","arcgis-navigator","arcgis-appstudio-player","arcgis-survey123","arcgis-collector","arcgis-workforce","arcgis-explorer","arcgis-trek2there","arcgis-quickcapture","mspbi","comgooglemaps","pdfefile","pdfehttp","pdfehttps","boxapp","boxemm","awb","awbs","gropen","radarscope"],this.arcgisFilterOptions={allowCommentTag:!0,safeAttrValue:function(n,o,a,l){return n==="a"&&o==="href"||(n==="img"||n==="source")&&o==="src"?r.sanitizeUrl(a):B1.exports.safeAttrValue(n,o,a,l)}};var s;e&&!i?s=e:e&&i?(s=Object.create(this.arcgisFilterOptions),Object.keys(e).forEach(function(n){n==="whiteList"?s.whiteList=r._extendObjectOfArrays([r.arcgisWhiteList,e.whiteList||{}]):s[n]=e[n]})):(s=Object.create(this.arcgisFilterOptions),s.whiteList=this.arcgisWhiteList),this.xssFilterOptions=s,this._xssFilter=new B1.exports.FilterXSS(s)}return t.prototype.sanitize=function(e,i){switch(i===void 0&&(i={}),typeof e){case"number":return isNaN(e)||!isFinite(e)?null:e;case"boolean":return e;case"string":return this._xssFilter.process(e);case"object":return this._iterateOverObject(e,i);default:return i.allowUndefined&&typeof e=="undefined"?void 0:null}},t.prototype.sanitizeUrl=function(e){var i=this._trim(e.substring(0,e.indexOf(":")));return e==="/"||e==="#"||e[0]==="#"||this.allowedProtocols.indexOf(i.toLowerCase())>-1?B1.exports.escapeAttrValue(e):""},t.prototype.sanitizeHTMLAttribute=function(e,i,r,s){return typeof this.xssFilterOptions.safeAttrValue=="function"?this.xssFilterOptions.safeAttrValue(e,i,r,s):B1.exports.safeAttrValue(e,i,r,s)},t.prototype.validate=function(e,i){i===void 0&&(i={});var r=this.sanitize(e,i);return{isValid:e===r,sanitized:r}},t.prototype._extendObjectOfArrays=function(e){var i={};return e.forEach(function(r){Object.keys(r).forEach(function(s){Array.isArray(r[s])&&Array.isArray(i[s])?i[s]=i[s].concat(r[s]):i[s]=r[s]})}),i},t.prototype._iterateOverObject=function(e,i){var r=this;i===void 0&&(i={});try{var s=!1,n=void 0;if(Array.isArray(e))n=e.reduce(function(a,l){var c=r.validate(l,i);return c.isValid?a.concat([l]):(s=!0,a.concat([c.sanitized]))},[]);else if(r3e(e)){var o=Object.keys(e);n=o.reduce(function(a,l){var c=e[l],h=r.validate(c,i);return h.isValid?a[l]=c:(s=!0,a[l]=h.sanitized),a},{})}else return i.allowUndefined&&typeof e=="undefined"?void 0:null;return s?n:e}catch{return null}},t.prototype._trim=function(e){return String.prototype.trim?e.trim():e.replace(/(^\s*)|(\s*$)/g,"")},t}(),wy,G1,W3e=function(t){if("WebkitTransition"in t.style)wy="webkitTransitionEnd",G1="webkitAnimationEnd";else{if(!("transition"in t.style))throw new Error("Your browser is not supported!");wy="transitionend",G1="animationend"}},tY=function(t){wy||W3e(t)},Z3e=function(t,e){return e===void 0&&(e=t+"-active"),function(i){tY(i);var r=!1,s=function(n){r||(r=!0,i.removeEventListener(wy,s),i.removeEventListener(G1,s),i.classList.remove(t),i.classList.remove(e))};i.classList.add(t),i.addEventListener(wy,s),i.addEventListener(G1,s),requestAnimationFrame(function(){i.classList.add(e)})}},J3e=function(t,e){return e===void 0&&(e=t+"-active"),function(i,r){tY(i);var s=!1,n=function(o){s||(s=!0,i.removeEventListener(wy,n),i.removeEventListener(G1,n),r())};i.classList.add(t),i.addEventListener(wy,n),i.addEventListener(G1,n),requestAnimationFrame(function(){i.classList.add(e)})}};function iY(t){const e=uo.acquire();for(let r=0;r<arguments.length;r++){const s=arguments[r],n=typeof s;if(n==="string")e.push(s);else if(Array.isArray(s))e.push.apply(e,s);else if(n==="object")for(const o in s)s[o]&&e.push(o)}const i=e.join(" ");return uo.release(e),i}function yf(t){const e=t==null?void 0:t.closest("[dir]");return e!==null&&e instanceof HTMLElement&&e.dir==="rtl"||document.dir==="rtl"}function rY(t){const e="data-node-ref";this[t.getAttribute(e)]=null}function Q6(t){const e="data-node-ref";this[t.getAttribute(e)]=t}function Q3e(t,e){return(t==="enter"?Z3e:J3e)(e)}le.getLogger("esri.widgets.support.widgetUtils");const Y3e=["dd","dl","dt","h1","h2","h3","h4","h5","h6","sub","sup","animate","animatetransform","circle","clippath","defs","ellipse","g","image","line","lineargradient","marker","mask","path","pattern","polygon","polyline","radialgradient","rect","stop","svg","switch","symbol","text","textpath","tspan","use"],X3e=Y3e.reduce((t,e)=>(t[e]=[],t),{}),K3e=["align","alink","alt","bgcolor","border","cellpadding","cellspacing","class","color","cols","colspan","coords","d","dir","face","height","hspace","ismap","lang","marginheight","marginwidth","multiple","nohref","noresize","noshade","nowrap","ref","rel","rev","rows","rowspan","scrolling","shape","span","summary","tabindex","title","usemap","valign","value","vlink","vspace","width"],sY=new H3e({whiteList:X3e,onTagAttr:(t,e,i)=>{const r=`${e}="${i}"`;if(K3e.includes(e))return r},stripIgnoreTag:!0,stripIgnoreTagBody:["script","style"]},!0);function eCe(t){return t==="Enter"||t===" "}function nY(){return getComputedStyle(document.body).getPropertyValue("--esri-calcite-theme-name").replace(/\s|'|"/g,"")}function oY(){return nY().startsWith("dark")}function tCe(){return"calcite-theme-"+(oY()?"dark":"light")}const aY="http://www.w3.org/",_A=`${aY}2000/svg`,lY=`${aY}1999/xlink`;let bA,cY=[],Y6=(t,e)=>{let i={};return Object.keys(t).forEach(r=>{i[r]=t[r]}),e&&Object.keys(e).forEach(r=>{i[r]=e[r]}),i},X6=(t,e)=>t.vnodeSelector===e.vnodeSelector&&(t.properties&&e.properties?t.properties.key===e.properties.key&&t.properties.bind===e.properties.bind:!t.properties&&!e.properties),uY=t=>{if(typeof t!="string")throw new Error("Style values must be strings")},iCe=(t,e,i)=>{if(e.vnodeSelector!==""){for(let r=i;r<t.length;r++)if(X6(t[r],e))return r}return-1},K6=(t,e,i,r)=>{let s=t[e];if(s.vnodeSelector==="")return;let n=s.properties;if(!(n?n.key===void 0?n.bind:n.key:void 0)){for(let o=0;o<t.length;o++)if(o!==e){let a=t[o];if(X6(a,s))throw new Error(`${i.vnodeSelector} had a ${s.vnodeSelector} child ${r==="added"?r:"removed"}, but there is now more than one. You must add unique key properties to make them distinguishable.`)}}},rCe=t=>{if(t.properties){let e=t.properties.enterAnimation;e&&e(t.domNode,t.properties)}},ek=[],tk=!1,hY=t=>{(t.children||[]).forEach(hY),t.properties&&t.properties.afterRemoved&&t.properties.afterRemoved.apply(t.properties.bind||t.properties,[t.domNode])},dY=()=>{tk=!1,ek.forEach(hY),ek.length=0},pY=t=>{ek.push(t),tk||(tk=!0,typeof window!="undefined"&&"requestIdleCallback"in window?window.requestIdleCallback(dY,{timeout:16}):setTimeout(dY,16))},fY=t=>{let e=t.domNode;if(t.properties){let i=t.properties.exitAnimation;if(i)return e.style.pointerEvents="none",void i(e,()=>{e.parentNode&&(e.parentNode.removeChild(e),pY(t))},t.properties)}e.parentNode&&(e.parentNode.removeChild(e),pY(t))},sCe=(t,e,i)=>{if(!e)return;let r=i.eventHandlerInterceptor,s=Object.keys(e),n=s.length;for(let o=0;o<n;o++){let a=s[o],l=e[a];if(a==="className")throw new Error('Property "className" is not supported, use "class".');if(a==="class")ik(t,l,!0);else if(a==="classes"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p];l[f]&&t.classList.add(f)}}else if(a==="styles"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p],g=l[f];g&&(uY(g),i.styleApplyer(t,f,g))}}else if(a!=="key"&&l!=null){let c=typeof l;c==="function"?(a.lastIndexOf("on",0)===0&&(r&&(l=r(a,l,t,e)),a==="oninput"&&function(){let h=l;l=function(p){h.apply(this,[p]),p.target["oninput-value"]=p.target.value}}()),t[a]=l):i.namespace===_A?a==="href"?t.setAttributeNS(lY,a,l):t.setAttribute(a,l):c==="string"&&a!=="value"?a==="innerHTML"?t[a]=sY.sanitize(l):t.setAttribute(a,l):t[a]=l}}},nCe=(t,e,i)=>{if(e)for(let r of e)q1(r,t,void 0,i)},mY=(t,e,i)=>{nCe(t,e.children,i),e.text&&(t.textContent=e.text),sCe(t,e.properties,i),e.properties&&e.properties.afterCreate&&e.properties.afterCreate.apply(e.properties.bind||e.properties,[t,i,e.vnodeSelector,e.properties,e.children])},q1=(t,e,i,r)=>{let s,n=0,o=t.vnodeSelector,a=e.ownerDocument;if(o==="")s=t.domNode=a.createTextNode(t.text),i!==void 0?e.insertBefore(s,i):e.appendChild(s);else{for(let l=0;l<=o.length;++l){let c=o.charAt(l);if(l===o.length||c==="."||c==="#"){let h=o.charAt(n-1),p=o.slice(n,l);h==="."?s.classList.add(p):h==="#"?s.id=p:(p==="svg"&&(r=Y6(r,{namespace:_A})),r.namespace!==void 0?s=t.domNode=a.createElementNS(r.namespace,p):(s=t.domNode=t.domNode||a.createElement(p),p==="input"&&t.properties&&t.properties.type!==void 0&&s.setAttribute("type",t.properties.type)),i!==void 0?e.insertBefore(s,i):s.parentNode!==e&&e.appendChild(s)),n=l+1}}mY(s,t,r)}},ik=(t,e,i)=>{e&&e.split(" ").forEach(r=>{r&&t.classList.toggle(r,i)})},oCe=(t,e,i,r)=>{if(!i)return;let s=!1,n=Object.keys(i),o=n.length;for(let a=0;a<o;a++){let l=n[a],c=i[l],h=e[l];if(l==="class")h!==c&&(ik(t,h,!1),ik(t,c,!0));else if(l==="classes"){let p=t.classList,f=Object.keys(c),g=f.length;for(let y=0;y<g;y++){let v=f[y],b=!!c[v];b!==!!h[v]&&(s=!0,b?p.add(v):p.remove(v))}}else if(l==="styles"){let p=Object.keys(c),f=p.length;for(let g=0;g<f;g++){let y=p[g],v=c[y];v!==h[y]&&(s=!0,v?(uY(v),r.styleApplyer(t,y,v)):r.styleApplyer(t,y,""))}}else if(c||typeof h!="string"||(c=""),l==="value"){let p=t[l];p!==c&&(t["oninput-value"]?p===t["oninput-value"]:c!==h)&&(t[l]=c,t["oninput-value"]=void 0),c!==h&&(s=!0)}else if(c!==h){let p=typeof c;p==="function"&&r.eventHandlerInterceptor||(r.namespace===_A?l==="href"?t.setAttributeNS(lY,l,c):t.setAttribute(l,c):p==="string"?l==="innerHTML"?t[l]=sY.sanitize(c):l==="role"&&c===""?t.removeAttribute(l):t.setAttribute(l,c):t[l]!==c&&(t[l]=c),s=!0)}}return s},aCe=(t,e,i,r,s)=>{if(i===r)return!1;r=r||cY;let n,o=(i=i||cY).length,a=r.length,l=0,c=0,h=!1;for(;c<a;){let p=l<o?i[l]:void 0,f=r[c];if(p!==void 0&&X6(p,f))h=bA(p,f,s)||h,l++;else{let g=iCe(i,f,l+1);if(g>=0){for(n=l;n<g;n++)fY(i[n]),K6(i,n,t,"removed");h=bA(i[g],f,s)||h,l=g+1}else q1(f,e,l<o?i[l].domNode:void 0,s),rCe(f),K6(r,c,t,"added")}c++}if(o>l)for(n=l;n<o;n++)fY(i[n]),K6(i,n,t,"removed");return h};bA=(t,e,i)=>{let r=t.domNode,s=!1;if(t===e)return!1;let n=!1;if(e.vnodeSelector===""){if(e.text!==t.text){let o=r.ownerDocument.createTextNode(e.text);return r.parentNode.replaceChild(o,r),e.domNode=o,s=!0,s}e.domNode=r}else e.vnodeSelector.lastIndexOf("svg",0)===0&&(i=Y6(i,{namespace:_A})),t.text!==e.text&&(n=!0,e.text===void 0?r.removeChild(r.firstChild):r.textContent=e.text),e.domNode=r,n=aCe(e,r,t.children,e.children,i)||n,n=oCe(r,t.properties,e.properties,i)||n,e.properties&&e.properties.afterUpdate&&e.properties.afterUpdate.apply(e.properties.bind||e.properties,[r,i,e.vnodeSelector,e.properties,e.children]);return n&&e.properties&&e.properties.updateAnimation&&e.properties.updateAnimation(r,e.properties,t.properties),s};let x2=(t,e)=>({getLastRender:()=>t,update:i=>{if(t.vnodeSelector!==i.vnodeSelector)throw new Error("The selector for the root VNode may not be changed. (consider using dom.merge and add one extra level to the virtual DOM)");let r=t;t=i,bA(r,i,e)},domNode:t.domNode});const lCe={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(t,e,i)=>{e.charAt(0)==="-"?t.style.setProperty(e,i):t.style[e]=i}};let H1=t=>Y6(lCe,t),vf={create:(t,e)=>(e=H1(e),q1(t,document.createElement("div"),void 0,e),x2(t,e)),append:(t,e,i)=>(i=H1(i),q1(e,t,void 0,i),x2(e,i)),insertBefore:(t,e,i)=>(i=H1(i),q1(e,t.parentNode,t,i),x2(e,i)),merge:(t,e,i)=>(i=H1(i),e.domNode=t,mY(t,e,i),x2(e,i)),replace:(t,e,i)=>(i=H1(i),q1(e,t.parentNode,t,i),t.parentNode.removeChild(t),x2(e,i))},gY,cCe=(t,e)=>{let i=[];for(;t&&t!==e;)i.push(t),t=t.parentNode;return i};gY=Array.prototype.find?(t,e)=>t.find(e):(t,e)=>t.filter(e)[0];let uCe=(t,e)=>{let i=t;return e.forEach(r=>{i=i&&i.children?gY(i.children,s=>s.domNode===r):void 0}),i},hCe=(t,e,i)=>{let r=function(s){i("domEvent",s);let n=e(),o=cCe(s.currentTarget,n.domNode);o.reverse();let a,l=uCe(n.getLastRender(),o);return t.scheduleRender(),l&&(a=l.properties[`on${s.type}`].apply(l.properties.bind||this,arguments)),i("domEventProcessed",s),a};return(s,n,o,a)=>r},yY=t=>{let e,i,r=H1(t),s=r.performanceLogger,n=!0,o=!1,a=[],l=[],c=(p,f,g)=>{let y,v=()=>y;r.eventHandlerInterceptor=hCe(e,v,s),y=p(f,g(),r),a.push(y),l.push(g)},h=()=>{if(i=void 0,n){n=!1,s("renderStart",void 0);for(let p=0;p<a.length;p++){let f=l[p]();s("rendered",void 0),a[p].update(f),s("patched",void 0)}s("renderDone",void 0),n=!0}};return e={renderNow:h,scheduleRender:()=>{i||o||(i=requestAnimationFrame(h))},stop:()=>{i&&(cancelAnimationFrame(i),i=void 0),o=!0},resume:()=>{o=!1,n=!0,e.scheduleRender()},append:(p,f)=>{c(vf.append,p,f)},insertBefore:(p,f)=>{c(vf.insertBefore,p,f)},merge:(p,f)=>{c(vf.merge,p,f)},replace:(p,f)=>{c(vf.replace,p,f)},detach:p=>{for(let f=0;f<l.length;f++)if(l[f]===p)return l.splice(f,1),a.splice(f,1)[0];throw new Error("renderFunction was not found")}},e},_f=class extends ve{constructor(){super(...arguments),this.items=new We,this._watchUpdatingTracking=new zh,this._callbacks=new Map,this._projector=yY(),this._hiddenProjector=yY()}get needsRender(){return this.items.length>0}initialize(){const t=document.createElement("div");t.className="esri-overlay-surface",this._set("surface",t),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),t.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(this.items,e=>{for(const i of e.added){const r=()=>i.render();this._callbacks.set(i,r),this._projector.append(this.surface,r)}for(const i of e.removed){const r=this._projector.detach(this._callbacks.get(i));this.surface.removeChild(r.domNode),this._callbacks.delete(i)}})}addItem(t){this.items.add(t)}removeItem(t){this.items.remove(t)}destroy(){this.items.removeAll(),this._callbacks.forEach(t=>this._projector.detach(t)),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(t){const e=this._hiddenSurface,i=this._hiddenProjector;let r=null;const s=()=>(r=t.render(),r);i.append(e,s),i.renderNow();const n={left:0,top:0,right:0,bottom:0};if(r&&r.domNode){const o=r.domNode.getBoundingClientRect();n.left=o.left,n.top=o.top,n.right=o.right,n.bottom=o.bottom}for(i.detach(s);e.firstChild;)e.removeChild(e.firstChild);return n}overlaps(t,e){const i=this.computeBoundingRect(t),r=this.computeBoundingRect(e);return Math.max(i.left,r.left)<=Math.min(i.right,r.right)&&Math.max(i.top,r.top)<=Math.min(i.bottom,r.bottom)}get hasVisibleItems(){return this.items.some(t=>t.visible)}renderCanvas(t){if(!this.items.some(i=>i.visible))return;const e=t.getContext("2d");e.save(),e.font=`10px ${getComputedStyle(this.surface).fontFamily}`,this.items.forEach(i=>{e.save(),i.renderCanvas(e),e.restore()}),e.restore()}};u([d({readOnly:!0})],_f.prototype,"surface",void 0),u([d({readOnly:!0})],_f.prototype,"items",void 0),u([d({readOnly:!0})],_f.prototype,"needsRender",null),u([d({readOnly:!0})],_f.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0,aliasOf:"_watchUpdatingTracking.updating"})],_f.prototype,"updating",void 0),_f=u([R("esri.views.overlay.ViewOverlay")],_f);const vY=_f;function rk(t,e,i,r){let s=null,n=1e3;typeof e=="number"?(n=e,r=i):(s=e!=null?e:null,n=i);let o,a=0;const l=()=>{a=0,t.apply(r,o)},c=(...h)=>{s&&s.apply(r,h),o=h,n?a||(a=setTimeout(l,n)):l()};return c.remove=()=>{a&&(clearTimeout(a),a=0)},c.forceUpdate=()=>{a&&(clearTimeout(a),l())},c.hasPendingUpdates=()=>!!a,c}function Ve(t,e){const i=e?he(E({},e),{source:t}):t;return d({aliasOf:i})}function dCe(){const t=crypto.getRandomValues(new Uint16Array(8));t[3]=4095&t[3]|16384,t[4]=16383&t[4]|32768;const e=i=>t[i].toString(16);return e(0)+e(1)+"-"+e(2)+"-"+e(3)+"-"+e(4)+"-"+e(5)+e(6)+e(7)}const pCe={handleInterceptedEvent:(t,e,i,r)=>(t.scheduleRender(),e.properties[`on${r.type}`].apply(e.properties.bind||i,[r]))},fCe={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(t,e,i)=>{t.style[e]=i}},mCe=t=>E(E({},fCe),t),gCe=(t,e)=>{const i=[];for(;t&&t!==e;)i.push(t),t=t.parentNode;return i},yCe=(t,e)=>t.find(e),_Y=(t,e,i=!1)=>{let r=t;return e.forEach((s,n)=>{var o;const a=(o=r)!=null&&o.children?yCe(r.children,l=>l.domNode===s):void 0;i&&!a&&n!==e.length-1||(r=a)}),r},vCe=t=>{let e;const i=E(E({},pCe),t),r=mCe(i),s=r.performanceLogger;let n,o=!0,a=!1;const l=[],c=[],h=(f,g,y)=>{let v;r.eventHandlerInterceptor=(w,S,T,C)=>function(M){let P;s("domEvent",M);const F=gCe(M.currentTarget,v.domNode),z=F.some(U=>{var G;return customElements.get(U==null||(G=U.tagName)==null?void 0:G.toLowerCase())});if(M.eventPhase===Event.CAPTURING_PHASE||!z)F.reverse(),P=_Y(v.getLastRender(),F);else{const U=M.composedPath(),G=U.slice(U.indexOf(M.currentTarget),U.indexOf(v.domNode)).filter(k=>k.getRootNode()===k.ownerDocument).reverse();P=_Y(v.getLastRender(),G,!0)}let D;return P&&(D=i.handleInterceptedEvent(e,P,this,M)),s("domEventProcessed",M),D},i.postProcessProjectionOptions==null||i.postProcessProjectionOptions(r);const b=y();v=f(g,b,r),l.push(v),c.push(y),i.afterFirstVNodeRendered&&i.afterFirstVNodeRendered(v,b)};let p=()=>{if(n=void 0,o){o=!1,s("renderStart",void 0);for(let f=0;f<l.length;f++){const g=c[f]();s("rendered",void 0),l[f].update(g),s("patched",void 0)}s("renderDone",void 0),o=!0}};return i.modifyDoRenderImplementation&&(p=i.modifyDoRenderImplementation(p,l,c)),e={renderNow:p,scheduleRender:()=>{n||a||(n=requestAnimationFrame(p))},stop:()=>{n&&(cancelAnimationFrame(n),n=void 0),a=!0},resume:()=>{a=!1,o=!0,e.scheduleRender()},append:(f,g)=>{h(vf.append,f,g)},insertBefore:(f,g)=>{h(vf.insertBefore,f,g)},merge:(f,g)=>{h(vf.merge,f,g)},replace:(f,g)=>{h(vf.replace,f,g)},detach:f=>{for(let g=0;g<c.length;g++)if(c[g]===f)return c.splice(g,1),l.splice(g,1)[0];throw new Error("renderFunction was not found")}},e},zt={allRenderFn:!1,cmpDidLoad:!0,cmpDidUnload:!1,cmpDidUpdate:!0,cmpDidRender:!0,cmpWillLoad:!0,cmpWillUpdate:!0,cmpWillRender:!0,connectedCallback:!0,disconnectedCallback:!0,element:!0,event:!0,hasRenderFn:!0,lifecycle:!0,hostListener:!0,hostListenerTargetWindow:!0,hostListenerTargetDocument:!0,hostListenerTargetBody:!0,hostListenerTargetParent:!1,hostListenerTarget:!0,member:!0,method:!0,mode:!0,observeAttribute:!0,prop:!0,propMutable:!0,reflect:!0,scoped:!0,shadowDom:!0,slot:!0,cssAnnotations:!0,state:!0,style:!0,svg:!0,updatable:!0,vdomAttribute:!0,vdomXlink:!0,vdomClass:!0,vdomFunctional:!0,vdomKey:!0,vdomListener:!0,vdomRef:!0,vdomPropOrAttr:!0,vdomRender:!0,vdomStyle:!0,vdomText:!0,watchCallback:!0,taskQueue:!0,hotModuleReplacement:!1,isDebug:!1,isDev:!1,isTesting:!1,hydrateServerSide:!1,hydrateClientSide:!1,lifecycleDOMEvents:!1,lazyLoad:!1,profile:!1,slotRelocation:!0,appendChildSlotFix:!1,cloneNodeFix:!1,hydratedAttribute:!1,hydratedClass:!0,safari10:!1,scriptDataOpts:!1,scopedSlotTextContentFix:!1,shadowDomShim:!1,slotChildNodesFix:!1,invisiblePrehydration:!0,propBoolean:!0,propNumber:!0,propString:!0,cssVarShim:!1,constructableCSS:!0,cmpShouldUpdate:!0,devTools:!1,dynamicImportShim:!1,shadowDelegatesFocus:!0,initializeNextTick:!1,asyncLoading:!1,asyncQueue:!1,transformTagName:!1,attachStyles:!0};let W1,bY,wA,wY=!1,xA=!1,sk=!1,ta=!1,xY=null,nk=!1;const Z1=typeof window!="undefined"?window:{};zt.cssVarShim&&Z1.CSS;const ac=Z1.document||{head:{}};Z1.HTMLElement||class{};const js={$flags$:0,$resourcesUrl$:"",jmp:t=>t(),raf:t=>requestAnimationFrame(t),ael:(t,e,i,r)=>t.addEventListener(e,i,r),rel:(t,e,i,r)=>t.removeEventListener(e,i,r),ce:(t,e)=>new CustomEvent(t,e)},SA=zt.shadowDomShim&&zt.shadowDom?(()=>(ac.head.attachShadow+"").indexOf("[native")>-1)():!0,_Ce=(()=>{let t=!1;try{ac.addEventListener("e",null,Object.defineProperty({},"passive",{get(){t=!0}}))}catch{}return t})(),bCe=t=>Promise.resolve(t),wCe=zt.constructableCSS?(()=>{try{return new CSSStyleSheet,typeof new CSSStyleSheet().replace=="function"}catch{}return!1})():!1,SY=(t,e,i,r)=>{i&&i.map(([s,n,o])=>{const a=SCe(t,s),l=xCe(e,o),c=TCe(s);js.ael(a,n,l,c),(e.$rmListeners$=e.$rmListeners$||[]).push(()=>js.rel(a,n,l,c))})},xCe=(t,e)=>i=>{try{zt.lazyLoad||t.$hostElement$[e](i)}catch(r){C2(r)}},SCe=(t,e)=>e&4?ac:e&8?Z1:e&16?ac.body:t,TCe=t=>_Ce?{passive:(t&1)!=0,capture:(t&2)!=0}:(t&2)!=0,TY="http://www.w3.org/1999/xlink",xy=(t,e="")=>()=>{},CY=new WeakMap,CCe=(t,e,i)=>{let r=PA.get(t);wCe&&i?(r=r||new CSSStyleSheet,r.replace(e)):r=e,PA.set(t,r)},MCe=(t,e,i,r)=>{let s=MY(e,i),n=PA.get(s);if(t=t.nodeType===11?t:ac,n)if(typeof n=="string"){t=t.head||t;let o=CY.get(t),a;o||CY.set(t,o=new Set),o.has(s)||(a=ac.createElement("style"),a.innerHTML=n,t.insertBefore(a,t.querySelector("link")),o&&o.add(s))}else t.adoptedStyleSheets.includes(n)||(t.adoptedStyleSheets=[...t.adoptedStyleSheets,n]);return s},PCe=t=>{const e=t.$cmpMeta$,i=t.$hostElement$,r=e.$flags$,s=xy("attachStyles",e.$tagName$),n=MCe(SA&&i.shadowRoot?i.shadowRoot:i.getRootNode(),e,t.$modeName$);r&10&&(i["s-sc"]=n,i.classList.add(n+"-h"),r&2&&i.classList.add(n+"-s")),s()},MY=(t,e)=>"sc-"+(e&&t.$flags$&32?t.$tagName$+"-"+e:t.$tagName$),ACe=t=>sMe.map(e=>e(t)).find(e=>!!e),PY={},$Ce="http://www.w3.org/2000/svg",ECe="http://www.w3.org/1999/xhtml",OCe=t=>t!=null,ok=t=>(t=typeof t,t==="object"||t==="function"),AY=(t,e,...i)=>{let r=null,s=null,n=null,o=!1,a=!1,l=[];const c=p=>{for(let f=0;f<p.length;f++)r=p[f],Array.isArray(r)?c(r):r!=null&&typeof r!="boolean"&&((o=typeof t!="function"&&!ok(r))&&(r=String(r)),o&&a?l[l.length-1].$text$+=r:l.push(o?TA(null,r):r),a=o)};if(c(i),e&&(zt.isDev&&t==="input"&&FCe(e),zt.vdomKey&&e.key&&(s=e.key),zt.slotRelocation&&e.name&&(n=e.name),zt.vdomClass)){const p=e.className||e.class;p&&(e.class=typeof p!="object"?p:Object.keys(p).filter(f=>p[f]).join(" "))}if(zt.isDev&&l.some($Y)&&rMe(`The <Host> must be the single root component. Make sure:
- You are NOT using hostData() and <Host> in the same component.
- <Host> is used once, and it's the single root component of the render() function.`),zt.vdomFunctional&&typeof t=="function")return t(e===null?{}:e,l,ICe);const h=TA(t,null);return h.$attrs$=e,l.length>0&&(h.$children$=l),zt.vdomKey&&(h.$key$=s),zt.slotRelocation&&(h.$name$=n),h},TA=(t,e)=>{const i={$flags$:0,$tag$:t,$text$:e,$elm$:null,$children$:null};return zt.vdomAttribute&&(i.$attrs$=null),zt.vdomKey&&(i.$key$=null),zt.slotRelocation&&(i.$name$=null),i},RCe={},$Y=t=>t&&t.$tag$===RCe,ICe={forEach:(t,e)=>t.map(EY).forEach(e),map:(t,e)=>t.map(EY).map(e).map(DCe)},EY=t=>({vattrs:t.$attrs$,vchildren:t.$children$,vkey:t.$key$,vname:t.$name$,vtag:t.$tag$,vtext:t.$text$}),DCe=t=>{if(typeof t.vtag=="function"){const i=Object.assign({},t.vattrs);return t.vkey&&(i.key=t.vkey),t.vname&&(i.name=t.vname),AY(t.vtag,i,...t.vchildren||[])}const e=TA(t.vtag,t.vtext);return e.$attrs$=t.vattrs,e.$children$=t.vchildren,e.$key$=t.vkey,e.$name$=t.vname,e},FCe=t=>{const e=Object.keys(t),i=e.indexOf("type"),r=e.indexOf("min"),s=e.indexOf("max"),n=e.indexOf("min"),o=e.indexOf("value");o!==-1&&(o<i||o<r||o<s||o<n)&&HY('The "value" prop of <input> should be set after "min", "max", "type" and "step"')},OY=(t,e,i,r,s,n)=>{if(i!==r){let o=GY(t,e),a=e.toLowerCase();if(e==="class"){const l=t.classList,c=RY(i),h=RY(r);l.remove(...c.filter(p=>p&&!h.includes(p))),l.add(...h.filter(p=>p&&!c.includes(p)))}else if(e==="style"){for(const l in i)(!r||r[l]==null)&&(l.includes("-")?t.style.removeProperty(l):t.style[l]="");for(const l in r)(!i||r[l]!==i[l])&&(l.includes("-")?t.style.setProperty(l,r[l]):t.style[l]=r[l])}else if(e!=="key")if(e==="ref")r&&r(t);else if(!t.__lookupSetter__(e)&&e[0]==="o"&&e[1]==="n")e[2]==="-"?e=e.slice(3):GY(Z1,a)?e=a.slice(2):e=a[2]+e.slice(3),i&&js.rel(t,e,i,!1),r&&js.ael(t,e,r,!1);else{const l=ok(r);if((o||l&&r!==null)&&!s)try{if(t.tagName.includes("-"))t[e]=r;else{let h=r==null?"":r;e==="list"?o=!1:(i==null||t[e]!=h)&&(t[e]=h)}}catch{}let c=!1;a!==(a=a.replace(/^xlink\:?/,""))&&(e=a,c=!0),r==null||r===!1?(r!==!1||t.getAttribute(e)==="")&&(c?t.removeAttributeNS(TY,e):t.removeAttribute(e)):(!o||n&4||s)&&!l&&(r=r===!0?"":r,c?t.setAttributeNS(TY,e,r):t.setAttribute(e,r))}}},LCe=/\s/,RY=t=>t?t.split(LCe):[],IY=(t,e,i,r)=>{const s=e.$elm$.nodeType===11&&e.$elm$.host?e.$elm$.host:e.$elm$,n=t&&t.$attrs$||PY,o=e.$attrs$||PY;for(r in n)r in o||OY(s,r,n[r],void 0,i,e.$flags$);for(r in o)OY(s,r,n[r],o[r],i,e.$flags$)},CA=(t,e,i,r)=>{let s=e.$children$[i],n=0,o,a,l;if(wY||(sk=!0,s.$tag$==="slot"&&(W1&&r.classList.add(W1+"-s"),s.$flags$|=s.$children$?2:1)),s.$text$!==null)o=s.$elm$=ac.createTextNode(s.$text$);else if(s.$flags$&1)o=s.$elm$=ac.createTextNode("");else{if(ta||(ta=s.$tag$==="svg"),o=s.$elm$=ac.createElementNS(ta?$Ce:ECe,s.$flags$&2?"slot-fb":s.$tag$),ta&&s.$tag$==="foreignObject"&&(ta=!1),IY(null,s,ta),OCe(W1)&&o["s-si"]!==W1&&o.classList.add(o["s-si"]=W1),s.$children$)for(n=0;n<s.$children$.length;++n)a=CA(t,s,n,o),a&&o.appendChild(a);s.$tag$==="svg"?ta=!1:o.tagName==="foreignObject"&&(ta=!0)}return o["s-hn"]=wA,s.$flags$&(2|1)&&(o["s-sr"]=!0,o["s-cr"]=bY,o["s-sn"]=s.$name$||"",l=t&&t.$children$&&t.$children$[i],l&&l.$tag$===s.$tag$&&t.$elm$&&S2(t.$elm$,!1)),o},S2=(t,e)=>{js.$flags$|=1;const i=t.childNodes;for(let r=i.length-1;r>=0;r--){const s=i[r];s["s-hn"]!==wA&&s["s-ol"]&&(LY(s).insertBefore(s,ak(s)),s["s-ol"].remove(),s["s-ol"]=void 0,sk=!0),e&&S2(s,e)}js.$flags$&=~1},DY=(t,e,i,r,s,n)=>{let o=t["s-cr"]&&t["s-cr"].parentNode||t,a;for(o.shadowRoot&&o.tagName===wA&&(o=o.shadowRoot);s<=n;++s)r[s]&&(a=CA(null,i,s,t),a&&(r[s].$elm$=a,o.insertBefore(a,ak(e))))},FY=(t,e,i,r,s)=>{for(;e<=i;++e)(r=t[e])&&(s=r.$elm$,NY(r),xA=!0,s["s-ol"]?s["s-ol"].remove():S2(s,!0),s.remove())},kCe=(t,e,i,r)=>{let s=0,n=0,o=0,a=0,l=e.length-1,c=e[0],h=e[l],p=r.length-1,f=r[0],g=r[p],y,v;for(;s<=l&&n<=p;)if(c==null)c=e[++s];else if(h==null)h=e[--l];else if(f==null)f=r[++n];else if(g==null)g=r[--p];else if(MA(c,f))J1(c,f),c=e[++s],f=r[++n];else if(MA(h,g))J1(h,g),h=e[--l],g=r[--p];else if(MA(c,g))(c.$tag$==="slot"||g.$tag$==="slot")&&S2(c.$elm$.parentNode,!1),J1(c,g),t.insertBefore(c.$elm$,h.$elm$.nextSibling),c=e[++s],g=r[--p];else if(MA(h,f))(c.$tag$==="slot"||g.$tag$==="slot")&&S2(h.$elm$.parentNode,!1),J1(h,f),t.insertBefore(h.$elm$,c.$elm$),h=e[--l],f=r[++n];else{for(o=-1,a=s;a<=l;++a)if(e[a]&&e[a].$key$!==null&&e[a].$key$===f.$key$){o=a;break}o>=0?(v=e[o],v.$tag$!==f.$tag$?y=CA(e&&e[n],i,o,t):(J1(v,f),e[o]=void 0,y=v.$elm$),f=r[++n]):(y=CA(e&&e[n],i,n,t),f=r[++n]),y&&LY(c.$elm$).insertBefore(y,ak(c.$elm$))}s>l?DY(t,r[p+1]==null?null:r[p+1].$elm$,i,r,n,p):n>p&&FY(e,s,l)},MA=(t,e)=>t.$tag$===e.$tag$?t.$tag$==="slot"?t.$name$===e.$name$:t.$key$===e.$key$:!1,ak=t=>t&&t["s-ol"]||t,LY=t=>(t["s-ol"]?t["s-ol"]:t).parentNode,J1=(t,e)=>{const i=e.$elm$=t.$elm$,r=t.$children$,s=e.$children$,n=e.$tag$,o=e.$text$;let a;o===null?(ta=n==="svg"?!0:n==="foreignObject"?!1:ta,n==="slot"||IY(t,e,ta),r!==null&&s!==null?kCe(i,r,e,s):s!==null?(t.$text$!==null&&(i.textContent=""),DY(i,null,e,s,0,s.length-1)):r!==null&&FY(r,0,r.length-1),ta&&n==="svg"&&(ta=!1)):(a=i["s-cr"])?a.parentNode.textContent=o:t.$text$!==o&&(i.data=o)},kY=t=>{let e=t.childNodes,i,r,s,n,o,a;for(r=0,s=e.length;r<s;r++)if(i=e[r],i.nodeType===1){if(i["s-sr"]){for(o=i["s-sn"],i.hidden=!1,n=0;n<s;n++)if(a=e[n].nodeType,e[n]["s-hn"]!==i["s-hn"]||o!==""){if(a===1&&o===e[n].getAttribute("slot")){i.hidden=!0;break}}else if(a===1||a===3&&e[n].textContent.trim()!==""){i.hidden=!0;break}}kY(i)}},lc=[],zY=t=>{let e,i,r,s,n,o,a=0,l=t.childNodes,c=l.length;for(;a<c;a++){if(e=l[a],e["s-sr"]&&(i=e["s-cr"])&&i.parentNode)for(r=i.parentNode.childNodes,s=e["s-sn"],o=r.length-1;o>=0;o--)i=r[o],!i["s-cn"]&&!i["s-nr"]&&i["s-hn"]!==e["s-hn"]&&(VY(i,s)?(n=lc.find(h=>h.$nodeToRelocate$===i),xA=!0,i["s-sn"]=i["s-sn"]||s,n?n.$slotRefNode$=e:lc.push({$slotRefNode$:e,$nodeToRelocate$:i}),i["s-sr"]&&lc.map(h=>{VY(h.$nodeToRelocate$,i["s-sn"])&&(n=lc.find(p=>p.$nodeToRelocate$===i),n&&!h.$slotRefNode$&&(h.$slotRefNode$=n.$slotRefNode$))})):lc.some(h=>h.$nodeToRelocate$===i)||lc.push({$nodeToRelocate$:i}));e.nodeType===1&&zY(e)}},VY=(t,e)=>t.nodeType===1?t.getAttribute("slot")===null&&e===""||t.getAttribute("slot")===e:t["s-sn"]===e?!0:e==="",NY=t=>{t.$attrs$&&t.$attrs$.ref&&t.$attrs$.ref(null),t.$children$&&t.$children$.map(NY)},zCe=(t,e)=>{const i=t.$hostElement$,r=t.$cmpMeta$,s=t.$vnode$||TA(null,null),n=$Y(e)?e:AY(null,null,e);wA=i.tagName,r.$attrsToReflect$&&(n.$attrs$=n.$attrs$||{},r.$attrsToReflect$.map(([o,a])=>n.$attrs$[a]=i[o])),n.$tag$=null,n.$flags$|=4,t.$vnode$=n,n.$elm$=s.$elm$=i.shadowRoot||i,W1=i["s-sc"],bY=i["s-cr"],wY=SA&&(r.$flags$&1)!=0,xA=!1,J1(s,n);{if(js.$flags$|=1,sk){zY(n.$elm$);let o,a,l,c,h,p,f=0;for(;f<lc.length;f++)o=lc[f],a=o.$nodeToRelocate$,a["s-ol"]||(l=ac.createTextNode(""),l["s-nr"]=a,a.parentNode.insertBefore(a["s-ol"]=l,a));for(f=0;f<lc.length;f++)if(o=lc[f],a=o.$nodeToRelocate$,o.$slotRefNode$){for(c=o.$slotRefNode$.parentNode,h=o.$slotRefNode$.nextSibling,l=a["s-ol"];l=l.previousSibling;)if(p=l["s-nr"],p&&p["s-sn"]===a["s-sn"]&&c===p.parentNode&&(p=p.nextSibling,!p||!p["s-nr"])){h=p;break}(!h&&c!==a.parentNode||a.nextSibling!==h)&&a!==h&&(!a["s-hn"]&&a["s-ol"]&&(a["s-hn"]=a["s-ol"].parentNode.nodeName),c.insertBefore(a,h))}else a.nodeType===1&&(a.hidden=!0)}xA&&kY(n.$elm$),js.$flags$&=~1,lc.length=0}},VCe=t=>zt.lazyLoad?T2(t).$hostElement$:t,lot=(t,e,i)=>{const r=VCe(t);return{emit:s=>(zt.isDev&&!r.isConnected&&HY(`The "${e}" event was emitted, but the dispatcher node is no longer connected to the dom.`),NCe(r,e,{bubbles:!!(i&4),composed:!!(i&2),cancelable:!!(i&1),detail:s}))}},NCe=(t,e,i)=>{const r=js.ce(e,i);return t.dispatchEvent(r),r},UCe=(t,e)=>{},UY=(t,e)=>(t.$flags$|=16,UCe(t,t.$ancestorComponent$),aMe(()=>jCe(t,e))),jCe=(t,e)=>{const i=t.$hostElement$,r=xy("scheduleUpdate",t.$cmpMeta$.$tagName$),s=i;let n;return e?n=Q1(s,"componentWillLoad"):n=Q1(s,"componentWillUpdate"),n=jY(n,()=>Q1(s,"componentWillRender")),r(),jY(n,()=>BCe(t,s,e))},BCe=async(t,e,i)=>{const r=t.$hostElement$,s=xy("update",t.$cmpMeta$.$tagName$);r["s-rc"],i&&PCe(t);const n=xy("render",t.$cmpMeta$.$tagName$);GCe(t,e,r),n(),s(),qCe(t)},GCe=(t,e,i)=>{const r=!1,s=!1,n=!0,o=!0;try{xY=e,e=(r||e.render)&&e.render(),o&&n&&(t.$flags$&=~16),(o||s)&&(t.$flags$|=2),(zt.hasRenderFn||zt.reflect)&&(zt.vdomRender||zt.reflect)&&(zt.hydrateServerSide||zCe(t,e))}catch(a){C2(a,t.$hostElement$)}return xY=null,null},qCe=t=>{const e=t.$cmpMeta$.$tagName$,i=t.$hostElement$,r=xy("postUpdate",e),s=i;t.$ancestorComponent$,Q1(s,"componentDidRender"),t.$flags$&64?(Q1(s,"componentDidUpdate"),r()):(t.$flags$|=64,Q1(s,"componentDidLoad"),r())},Q1=(t,e,i)=>{if(t&&t[e])try{return t[e](i)}catch(r){C2(r)}},jY=(t,e)=>t&&t.then?t.then(e):e(),HCe=(t,e)=>t!=null&&!ok(t)?e&4?t==="false"?!1:t===""||!!t:e&2?parseFloat(t):e&1?String(t):t:t,WCe=(t,e)=>T2(t).$instanceValues$.get(e),ZCe=(t,e,i,r)=>{const s=T2(t),n=t,o=s.$instanceValues$.get(e),a=s.$flags$,l=n;if(i=HCe(i,r.$members$[e][0]),i!==o){s.$instanceValues$.set(e,i);{if(r.$watchers$&&a&128){const c=r.$watchers$[e];c&&c.map(h=>{try{l[h](i,o,e)}catch(p){C2(p,n)}})}if((a&(2|16))==2){if(l.componentShouldUpdate&&l.componentShouldUpdate(i,o,e)===!1)return;UY(s,!1)}}}},JCe=(t,e,i)=>{if(e.$members$){t.watchers&&(e.$watchers$=t.watchers);const r=Object.entries(e.$members$),s=t.prototype;r.map(([n,[o]])=>{(o&31||o&32)&&Object.defineProperty(s,n,{get(){return WCe(this,n)},set(a){ZCe(this,n,a,e)},configurable:!0,enumerable:!0})});{const n=new Map;s.attributeChangedCallback=function(o,a,l){js.jmp(()=>{const c=n.get(o);if(this.hasOwnProperty(c))l=this[c],delete this[c];else if(s.hasOwnProperty(c)&&typeof this[c]=="number"&&this[c]==l)return;this[c]=l===null&&typeof this[c]=="boolean"?!1:l})},t.observedAttributes=r.filter(([o,a])=>a[0]&15).map(([o,a])=>{const l=a[1]||o;return n.set(l,o),a[0]&512&&e.$attrsToReflect$.push([o,l]),l})}}return t},QCe=async(t,e,i,r,s)=>{if((e.$flags$&32)==0&&(s=t.constructor,e.$flags$|=32,customElements.whenDefined(i.$tagName$).then(()=>e.$flags$|=128),s.style)){let o=s.style;typeof o!="string"&&(o=o[e.$modeName$=ACe(t)]);const a=MY(i,e.$modeName$);if(!PA.has(a)){const l=xy("registerStyles",i.$tagName$);CCe(a,o,!!(i.$flags$&1)),l()}}e.$ancestorComponent$,(()=>UY(e,!0))()},YCe=t=>{},XCe=t=>{if((js.$flags$&1)==0){const e=T2(t),i=e.$cmpMeta$,r=xy("connectedCallback",i.$tagName$);e.$flags$&1?(SY(t,e,i.$listeners$),YCe(e.$lazyInstance$)):(e.$flags$|=1,i.$flags$&(4|8)&&KCe(t),i.$members$&&Object.entries(i.$members$).map(([s,[n]])=>{if(n&31&&t.hasOwnProperty(s)){const o=t[s];delete t[s],t[s]=o}}),QCe(t,e,i)),r()}},KCe=t=>{const e=t["s-cr"]=ac.createComment("");e["s-cn"]=!0,t.insertBefore(e,t.firstChild)},eMe=t=>{if((js.$flags$&1)==0){const e=T2(t);e.$rmListeners$&&(e.$rmListeners$.map(i=>i()),e.$rmListeners$=void 0)}},cot=(t,e)=>{const i={$flags$:e[0],$tagName$:e[1]};zt.member&&(i.$members$=e[2]),zt.hostListener&&(i.$listeners$=e[3]),zt.watchCallback&&(i.$watchers$=t.$watchers$),zt.reflect&&(i.$attrsToReflect$=[]),zt.shadowDom&&!SA&&i.$flags$&1&&(i.$flags$|=8);const r=t.prototype.connectedCallback,s=t.prototype.disconnectedCallback;return Object.assign(t.prototype,{__registerHost(){iMe(this,i)},connectedCallback(){XCe(this),zt.connectedCallback&&r&&r.call(this)},disconnectedCallback(){eMe(this),zt.disconnectedCallback&&s&&s.call(this)},__attachShadow(){SA?zt.shadowDelegatesFocus?this.attachShadow({mode:"open",delegatesFocus:!!(i.$flags$&16)}):this.attachShadow({mode:"open"}):this.shadowRoot=this}}),t.is=i.$tagName$,JCe(t,i)},uot=t=>{const e=new URL(t,js.$resourcesUrl$);return e.origin!==Z1.location.origin?e.href:e.pathname},tMe=t=>js.$resourcesUrl$=t,BY=new WeakMap,T2=t=>BY.get(t),iMe=(t,e)=>{const i={$flags$:0,$hostElement$:t,$cmpMeta$:e,$instanceValues$:new Map};return zt.isDev&&(i.$renderCount$=0),zt.method&&zt.lazyLoad&&(i.$onInstancePromise$=new Promise(r=>i.$onInstanceResolve$=r)),zt.asyncLoading&&(i.$onReadyPromise$=new Promise(r=>i.$onReadyResolve$=r),t["s-p"]=[],t["s-rc"]=[]),SY(t,i,e.$listeners$),BY.set(t,i)},GY=(t,e)=>e in t,C2=(t,e)=>(0,console.error)(t,e),qY=zt.isTesting?["STENCIL:"]:["%cstencil","color: white;background:#4c47ff;font-weight: bold; font-size:10px; padding:2px 6px; border-radius: 5px"],rMe=(...t)=>console.error(...qY,...t),HY=(...t)=>console.warn(...qY,...t),PA=new Map,sMe=[],WY=[],ZY=[],nMe=(t,e)=>i=>{t.push(i),nk||(nk=!0,e&&js.$flags$&4?oMe(lk):js.raf(lk))},JY=t=>{for(let e=0;e<t.length;e++)try{t[e](performance.now())}catch(i){C2(i)}t.length=0},lk=()=>{JY(WY),JY(ZY),(nk=WY.length>0)&&js.raf(lk)},oMe=t=>bCe().then(t),aMe=nMe(ZY,!0);zt.isDev,zt.isTesting;let QY;function lMe(){tMe(Ra(kt(QY)))}QY="components/assets";const YY=Symbol("widget"),cMe=[],uMe={},AA=new WeakMap;function XY(t,e){let i=e.children;if(i&&i.length)for(let s=0;s<i.length;++s)i[s]=XY(t,i[s]);else i=cMe;const r=e.vnodeSelector;if(ck(r)){const s=e.properties||uMe,n=s.key||r;return{vnodeSelector:"div",properties:{key:n,afterCreate:hMe,afterUpdate:dMe,afterRemoved:KY,parentWidget:t,widgetConstructor:r,widgetProperties:he(E({},s),{key:n,children:i})},children:void 0,text:void 0,domNode:null}}return e}function hMe(t,e,i,{parentWidget:r,widgetConstructor:s,widgetProperties:n}){const o=new s(n);o.container=t,AA.set(t,o),o.afterCreate==null||o.afterCreate(o,t),r._internalHandles.add(pg(()=>KY(t)))}function dMe(t,e,i,{widgetProperties:r}){const s=AA.get(t);s&&(s.set(r),s.afterUpdate==null||s.afterUpdate(s,t))}function KY(t){const e=AA.get(t);e&&(e.destroy(),AA.delete(t))}function ck(t){return typeof t=="function"&&t[YY]}const eX="esri.widgets.Widget",tX=le.getLogger(eX);let pMe=0;const Y1=new Map,fMe={widgetIcon:"esri-icon-checkbox-unchecked"};function iX(t,e){for(const i in e)t[i]!=null&&(typeof t[i]=="object"&&typeof e[i]=="object"?iX(t[i],e[i]):t[i]=e[i]);return t}const mMe=vCe({postProcessProjectionOptions(t){const e=t.eventHandlerInterceptor,i=/capture$/i;t.eventHandlerInterceptor=(r,s,n,o)=>{const a=e(r,s,n,o),l=i.test(r);if(!((r=r.replace(i,"")).toLowerCase()in n)||l){const c=r[2].toLowerCase()+r.slice(3),h=g=>a.call(n,g);n.addEventListener(c,h,l);const p=()=>n.removeEventListener(c,h,l),f=o.afterRemoved;o.afterRemoved=g=>{f==null||f(g),p()}}return a}},handleInterceptedEvent(t,e,i,r){const{eventPhase:s,type:n}=r,o=s===Event.CAPTURING_PHASE;let a=`on${n}${o?"capture":""}`;const l=e.properties;(a in l||(a=`on${n[0].toUpperCase()}${n.slice(1)}${o?"Capture":""}`,a in l))&&(Y1.clear(),t.scheduleRender(),l[a].call(l.bind||i,r))}});let uk=!1,qr=class extends rx(Ci.EventedAccessor){constructor(t,e){super(t,e),this._attached=!1,this._internalHandles=new dt,this._projector=mMe,this._readyForTrueRender=!1,this.domNode=null,this.iconClass=fMe.widgetIcon,this.label=this.declaredClass.split(".").pop(),this.visible=!0,this.key=this,this._loadLocale=yG(async()=>{if(this._messageBundleProps&&this._messageBundleProps.length){const a=await En(this._messageBundleProps.map(async({bundlePath:l,propertyName:c})=>{let h=await iH(l);this.uiStrings&&Object.keys(this.uiStrings)&&(h=iX(ie(h),this.uiStrings)),this[c]=h}));for(const l of a)l.error&&tX.error("widget-intl:locale-error",this.declaredClass,l.error)}await this.loadLocale()}),lMe();const i=["light","dark"],r=nY()||"light";i.includes(r)||hg(tX,"The following themes are deprecated: light-blue, dark-blue, light-green, dark-green, light-purple, dark-purple, light-red, and dark-red.",{version:"4.19",warnOnce:!0,see:"https://developers.arcgis.com/javascript/latest/styling/"});const s="esri-widget-uid-"+dCe(),n=this.render.bind(this);this._trackingTarget=new XC(()=>this.scheduleRender());const o=()=>{var a;if(!this._readyForTrueRender||this.destroyed)return null;if(!this.visible)return{vnodeSelector:"div",properties:{key:s,class:"",styles:{display:"none"}},domNode:void 0,children:void 0,text:void 0};const l=n();let{properties:c}=l;c||(l.properties=c={});let{key:h,styles:p}=c;h||(c.key=s),p||(c.styles=p={}),p.display||(p.display="");let f=0;return(a=l.children)==null||a.forEach(g=>{if(ck(g.vnodeSelector))return;let{properties:y}=g;y||(g.properties=y={}),y.key||(y.key=`${this.id}--${f++}`)}),XY(this,l)};this.render=()=>{if(uk)return o();let a=Y1.get(this);if(a)return a;this._trackingTarget.clear(),uk=!0;try{a=Sh(this._trackingTarget,o)}finally{uk=!1}return Y1.set(this,a),a},this.addResolvingPromise(this._resourcesFetch=this.beforeFirstRender().then(()=>{this._readyForTrueRender=!0,this._postInitialize()}))}normalizeCtorArgs(t,e){const i=E({},t);return e&&(i.container=e),i}postInitialize(){}beforeFirstRender(){return Promise.all([this.loadDependencies(),this._loadLocale()]).then(()=>{}).catch(gD)}async loadDependencies(){}async loadLocale(){}destroy(){this.destroyed||(this._trackingTarget=tt(this._trackingTarget),this.viewModel=tt(this.viewModel),this._detach(this.container),this._set("container",null),this._internalHandles.destroy(),this._emitter.clear(),this.render=()=>null,this._projector=null,Y1.delete(this))}set container(t){this._get("container")||this._set("container",t)}castContainer(t){return MP(t)}get id(){return this._get("id")||this.get("container.id")||Date.now().toString(16)+"-widget-"+pMe++}set id(t){t&&this._set("id",t)}get renderable(){return this._resourcesFetch}get test(){return{projector:this._projector,handles:this._internalHandles}}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(Y1.delete(this),this._projector.scheduleRender())}classes(...t){return iY.apply(this,t)}own(t){arguments.length>1&&(t=Array.prototype.slice.call(arguments)),this._internalHandles.add(t)}renderNow(){Y1.delete(this),this._projector.renderNow()}_postInitialize(){var t;if(this.destroyed)return;this.scheduleRender(),(t=this._delegatedEventNames)!=null&&t.length&&this._internalHandles.add(Ke(this,"viewModel",(i,r)=>{r&&this._internalHandles.remove("delegated-events"),i&&this._internalHandles.add(this._delegatedEventNames.map(s=>i.on(s,n=>{this.emit(s,n)})),"delegated-events")})),this.postInitialize();const e=async()=>{await this._loadLocale().catch(gD),this.scheduleRender()};this._internalHandles.add([q1e(e),this.watch("uiStrings",e),_x(this,"container",async i=>{this.destroyed||this._attach(i)})])}_attach(t){t&&(this._projector.merge(t,this.render),this._attached=!0)}_detach(t){t&&this._attached&&(this._projector.detach(this.render),t.parentNode&&t.parentNode.removeChild(t),this._attached=!1)}};qr[YY]=!0,u([d()],qr.prototype,"_readyForTrueRender",void 0),u([d({value:null})],qr.prototype,"container",null),u([ut("container")],qr.prototype,"castContainer",null),u([d({aliasOf:"container"})],qr.prototype,"domNode",void 0),u([d()],qr.prototype,"iconClass",void 0),u([d()],qr.prototype,"id",null),u([d()],qr.prototype,"label",void 0),u([d()],qr.prototype,"renderable",null),u([d()],qr.prototype,"uiStrings",void 0),u([d()],qr.prototype,"viewModel",void 0),u([d()],qr.prototype,"visible",void 0),u([d()],qr.prototype,"key",void 0),u([d()],qr.prototype,"children",void 0),u([d()],qr.prototype,"afterCreate",void 0),u([d()],qr.prototype,"afterUpdate",void 0),u([d()],qr.prototype,"afterRemoved",void 0),qr=u([R(eX)],qr);const Bs=qr;function gMe(t,e,i){return t.units[e][i]}function $A(t,e,i,r=2,s="abbr"){return`${Uh(e,{minimumFractionDigits:r,maximumFractionDigits:r})} ${gMe(t,i,s)}`}function hot(t,e,i,r=2,s="abbr"){const n=M2e(e,i);return $A(t,cr(e,i,n),n,r,s)}function dot(t,e,i,r=2,s="abbr"){const n=P2e(e,i);return $A(t,cr(e,i,n),n,r,s)}function pot(t,e,i,r=2,s="abbr"){const n=A2e(e,i);return $A(t,cr(e,i,n),n,r,s)}function fot(t,e,i,r=2,s="abbr"){const n=$2e(e,i);return $A(t,cr(e,i,n),n,r,s)}function mot(t,e,i=2){let r=cr(t,e,"degrees"),s=r-Math.floor(r);r-=s,s*=60;let n=s-Math.floor(s);return s-=n,n*=60,`${r.toFixed()}\xB0 ${s.toFixed()}' ${n.toFixed(i)}"`}const rX=["B","kB","MB","GB","TB"];function yMe(t,e){let i=e===0?0:Math.floor(Math.log(e)/Math.log(1024));i=Re(i,0,rX.length-1);const r=Uh(e/1024**i,{maximumFractionDigits:2});return Dl(t.units.bytes[rX[i]],{fileSize:r})}function vMe(t){const{exifInfo:e,exifName:i,tagName:r}=t;if(!e||!i||!r)return null;const s=e.find(n=>n.name===i);return s?_Me({tagName:r,tags:s.tags}):null}function _Me(t){const{tagName:e,tags:i}=t;if(!i||!e)return null;const r=i.find(s=>s.name===e);return r&&r.value||null}var hk;const bMe={1:{id:1,rotation:0,mirrored:!1},2:{id:2,rotation:0,mirrored:!0},3:{id:3,rotation:180,mirrored:!1},4:{id:4,rotation:180,mirrored:!0},5:{id:5,rotation:-90,mirrored:!0},6:{id:6,rotation:90,mirrored:!1},7:{id:7,rotation:90,mirrored:!0},8:{id:8,rotation:-90,mirrored:!1}};let wo=hk=class extends ge{constructor(t){super(t),this.contentType=null,this.exifInfo=null,this.id=null,this.globalId=null,this.keywords=null,this.name=null,this.parentGlobalId=null,this.parentObjectId=null,this.size=null,this.url=null}get orientationInfo(){const{exifInfo:t}=this,e=vMe({exifName:"Exif IFD0",tagName:"Orientation",exifInfo:t});return bMe[e]||null}clone(){return new hk({contentType:this.contentType,exifInfo:this.exifInfo,id:this.id,globalId:this.globalId,keywords:this.keywords,name:this.name,parentGlobalId:this.parentGlobalId,parentObjectId:this.parentObjectId,size:this.size,url:this.url})}};u([d({type:String})],wo.prototype,"contentType",void 0),u([d()],wo.prototype,"exifInfo",void 0),u([d({readOnly:!0})],wo.prototype,"orientationInfo",null),u([d({type:Oi})],wo.prototype,"id",void 0),u([d({type:String})],wo.prototype,"globalId",void 0),u([d({type:String})],wo.prototype,"keywords",void 0),u([d({type:String})],wo.prototype,"name",void 0),u([d({json:{read:!1}})],wo.prototype,"parentGlobalId",void 0),u([d({json:{read:!1}})],wo.prototype,"parentObjectId",void 0),u([d({type:Oi})],wo.prototype,"size",void 0),u([d({json:{read:!1}})],wo.prototype,"url",void 0),wo=hk=u([R("esri.layers.support.AttachmentInfo")],wo);const sX=wo;var dk;let Gs=dk=class extends ge{constructor(t){super(t),this.attachmentTypes=null,this.attachmentsWhere=null,this.keywords=null,this.globalIds=null,this.name=null,this.num=null,this.objectIds=null,this.returnMetadata=!1,this.size=null,this.start=null,this.where=null}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10}clone(){return new dk(ie({attachmentTypes:this.attachmentTypes,attachmentsWhere:this.attachmentsWhere,keywords:this.keywords,where:this.where,globalIds:this.globalIds,name:this.name,num:this.num,objectIds:this.objectIds,returnMetadata:this.returnMetadata,size:this.size,start:this.start}))}};u([d({type:[String],json:{write:!0}})],Gs.prototype,"attachmentTypes",void 0),u([d({type:String,json:{read:{source:"attachmentsDefinitionExpression"},write:{target:"attachmentsDefinitionExpression"}}})],Gs.prototype,"attachmentsWhere",void 0),u([d({type:[String],json:{write:!0}})],Gs.prototype,"keywords",void 0),u([d({type:[Number],json:{write:!0}})],Gs.prototype,"globalIds",void 0),u([d({json:{write:!0}})],Gs.prototype,"name",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Gs.prototype,"num",void 0),u([d({type:[Number],json:{write:!0}})],Gs.prototype,"objectIds",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Gs.prototype,"returnMetadata",void 0),u([d({type:[Number],json:{write:!0}})],Gs.prototype,"size",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Gs.prototype,"start",void 0),u([Ee("start"),Ee("num")],Gs.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],Gs.prototype,"where",void 0),Gs=dk=u([R("esri.rest.support.AttachmentQuery")],Gs),Gs.from=Ni(Gs);const EA=Gs,wMe="esri.widgets.Feature.support.featureUtils",nX=le.getLogger(wMe),xMe=/href=(""|'')/gi,SMe=/(\{([^\{\r\n]+)\})/g,TMe=/\'/g,oX=/^\s*expression\//i,CMe=/(\n)/gi,MMe=/[\u00A0-\u9999<>\&]/gim,PMe=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,AMe=/^(?:mailto:|tel:)/,aX="relationships/",pk=p5("short-date-short-time");function lX(t){if(!A(t))return t.get("sourceLayer")||t.get("layer")}async function OA(t,e){return typeof t=="function"?t.call(null,e):t}function cX(t=""){if(t)return!AMe.test(t.trim().toLowerCase())}function uX(t){return!!t&&oX.test(t)}function $Me(t,e){if(!uX(e)||!t)return null;const i=e.replace(oX,"").toLowerCase();let r;return t.some(s=>s.name.toLowerCase()===i&&(r=s,!0)),r}function hX(t,e){const i=$Me(e,t==null?void 0:t.fieldName);return i?i.title||null:t?t.label||t.fieldName:null}function EMe(t,e){const i=e.get(t.toLowerCase());return`{${i&&i.fieldName||t}}`}function OMe(t){return t.replace(xMe,"")}function RA(t,e){const i=fk(e,t);return i?i.name:t}function RMe(t,e){return t&&t.map(i=>RA(i,e))}function fk(t,e){return t&&typeof t.getField=="function"?t.getField(e):null}function dX(t){return`${t}`.trim()}function Sy({attributes:t,globalAttributes:e,layer:i,text:r,expressionAttributes:s,fieldInfoMap:n}){return r?mk({formattedAttributes:e,template:LMe(r,E(E(E({},e),s),t),i),fieldInfoMap:n}):""}function mk({formattedAttributes:t,template:e,fieldInfoMap:i}){return dX(OMe(Dl(Dl(e,r=>EMe(r,i)),t)))}function IMe(t,e,i=!1){const r=e[t];if(typeof r=="string"){const s="%27",n=(i?encodeURIComponent(r):r).replace(TMe,s);e[t]=n}}function DMe(t,e=!1){const i=E({},t);return Object.keys(i).forEach(r=>IMe(r,i,e)),i}function FMe(t,e,i){const r=(e=dX(e))&&e[0]!=="{";return Dl(t,DMe(i,r))}function gk(t,e){return t.replace(SMe,(i,r,s)=>{const n=fk(e,s);return n?`{${n.name}}`:r})}function LMe(t,e,i){const r=gk(t,i);return r&&r.replace(PMe,(s,n,o)=>FMe(s,n||o,e))}function kMe(t,e){if(typeof t=="string"&&e&&e.dateFormat==null&&(e.places!=null||e.digitSeparator!=null)){const i=Number(t);if(!isNaN(i))return i}return t}function zMe(t){return(t==null?void 0:t.type)==="feature"}function VMe(t){return(t==null?void 0:t.type)==="map-image"}function NMe(t){return!(t==null||!t.layer)}function pX(t,e){const i=e.fieldInfos,r=e.fieldName,s=fX(i,r),n=s==null?void 0:s.clone(),o=e.preventPlacesFormatting,a=e.layer,l=fk(a,r);if(n&&(l==null?void 0:l.type)==="date"){const h=n.format||new Ox;h.dateFormat=h.dateFormat||"short-date-short-time",h.dateTimeFormatOptions=zMe(a)&&a.datesInUnknownTimezone||NMe(a)&&VMe(a.layer)&&a.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null,n.format=h}const c=n&&n.format;return typeof(t=kMe(t,c))=="string"||t==null||c==null?M2(t):o?Uh(t,he(E({},xW(c)),{minimumFractionDigits:0,maximumFractionDigits:20})):c.format(t)}function fX(t,e){if(!t||!t.length||!e)return;const i=e.toLowerCase();let r;return t.some(s=>!(!s.fieldName||s.fieldName.toLowerCase()!==i)&&(r=s,!0)),r}function UMe({fieldName:t,graphic:e,layer:i}){if(Kh(t)||!i||typeof i.getFeatureType!="function")return null;const{typeIdField:r}=i;if(!r||t!==r)return null;const s=i.getFeatureType(e);return s?s.name:null}function jMe({fieldName:t,value:e,graphic:i,layer:r}){if(Kh(t)||!r||typeof r.getFieldDomain!="function")return null;const s=r.getFieldDomain(t,{feature:i});return s&&s.type==="coded-value"?s.getName(e):null}function BMe(t,e){const{creatorField:i,creationDateField:r,editorField:s,editDateField:n}=t;if(!e)return;const o=e[n];if(typeof o=="number"){const l=e[s];return{type:"edit",date:Nh(o,pk),user:l}}const a=e[r];if(typeof a=="number"){const l=e[i];return{type:"create",date:Nh(a,pk),user:l}}return null}function GMe(t,e){const i=new Map;return t&&t.forEach(r=>{const s=RA(r.fieldName,e);r.fieldName=s,i.set(s.toLowerCase(),r)}),i}function mX(t){const e=[];if(!t)return e;const{fieldInfos:i,content:r}=t;return i&&e.push(...i),r&&Array.isArray(r)&&r.forEach(s=>{if(s.type==="fields"){const n=s&&s.fieldInfos;n&&e.push(...n)}}),e}function yk(t){return t.replace(MMe,e=>`&#${e.charCodeAt(0)};`)}function M2(t){return typeof t=="string"?t.replace(CMe,'<br class="esri-text-new-line" />'):t}function qMe(t){const{value:e,fieldName:i,fieldInfos:r,fieldInfoMap:s,layer:n,graphic:o}=t;if(e==null)return"";const a=jMe({fieldName:i,value:e,graphic:o,layer:n});if(a)return a;const l=UMe({fieldName:i,graphic:o,layer:n});if(l)return l;if(s.get(i.toLowerCase()))return pX(e,{fieldInfos:r,fieldName:i,layer:n});const c=n&&n.fieldsIndex;return c&&c.isDateField(i)?Nh(e,pk):M2(e)}function vk({fieldInfos:t,attributes:e,layer:i,graphic:r,fieldInfoMap:s,relatedInfos:n}){const o={};return n==null||n.forEach(a=>QMe(o,a)),Object.keys(e).forEach(a=>{const l=e[a];o[a]=qMe({fieldName:a,fieldInfos:t,fieldInfoMap:s,layer:i,value:l,graphic:r})}),o}async function HMe(t,e){var i,r;const{layer:s,graphic:n,outFields:o,objectIds:a,returnGeometry:l,spatialReference:c}=t,h=a[0];if(typeof h!="number"&&typeof h!="string"){const f="Could not query required fields for the specified feature. The feature's ID is invalid.",g={layer:s,graphic:n,objectId:h,requiredFields:o};return nX.warn(f,g),null}if((i=s.capabilities)==null||(r=i.operations)==null||!r.supportsQuery){const f="The specified layer cannot be queried. The following fields will not be available.",g={layer:s,graphic:n,requiredFields:o,returnGeometry:l};return nX.warn(f,g),null}const p=s.createQuery();return p.objectIds=a,p.outFields=o!=null&&o.length?o:[s.objectIdField],p.returnGeometry=!!l,p.returnZ=!!l,p.returnM=!!l,p.outSpatialReference=c,(await s.queryFeatures(p,e)).features[0]}async function WMe(t){var e;if((e=t.expressionInfos)==null||!e.length)return!1;const i=await su(),{arcadeUtils:{hasGeometryFunctions:r}}=i;return r(t)}async function ZMe({graphic:t,popupTemplate:e,layer:i,spatialReference:r},s){if(!i||!e||(typeof i.load=="function"&&await i.load(s),!t.attributes))return;const n=t.attributes[i.objectIdField];if(n==null)return;const o=[n],a=await e.getRequiredFields(i.fieldsIndex),l=gwe(a,t),c=l?[]:a,h=e.returnGeometry||await WMe(e);if(l&&!h)return;const p=await HMe({layer:i,graphic:t,outFields:c,objectIds:o,returnGeometry:h,spatialReference:r},s);p&&(p.geometry&&(t.geometry=p.geometry),p.attributes&&(t.attributes=E(E({},t.attributes),p.attributes)))}function Kh(t=""){return!!t&&t.indexOf(aX)!==-1}function JMe(t){return t?`${aX}${t.layerId}/${t.fieldName}`:""}function gX({attributes:t,graphic:e,relatedInfo:i}){t&&e&&i&&Object.keys(e.attributes).forEach(r=>{const s=JMe({layerId:i.relation.id.toString(),fieldName:r});t[s]=e.attributes[r]})}function QMe(t,e){t&&e&&(e.relatedFeatures&&e.relatedFeatures&&e.relatedFeatures.forEach(i=>gX({attributes:t,graphic:i,relatedInfo:e})),e.relatedStatsFeatures&&e.relatedStatsFeatures&&e.relatedStatsFeatures.forEach(i=>gX({attributes:t,graphic:i,relatedInfo:e})))}const yX=t=>{if(!t)return!1;const e=t.toUpperCase();return e.indexOf("CURRENT_TIMESTAMP")>-1||e.indexOf("CURRENT_DATE")>-1||e.indexOf("CURRENT_TIME")>-1},vX=({layer:t,method:e,query:i,definitionExpression:r})=>{var s,n;if((s=t.capabilities)==null||(n=s.query)==null||!n.supportsCacheHint||e==="attachments")return;const o=_(i.where)&&i.where,a=_(i.geometry)&&i.geometry;yX(r)||yX(o)||(a==null?void 0:a.type)==="extent"||i.resultType==="tile"||(i.cacheHint=!0)},YMe=({query:t,layer:e,method:i})=>{vX({layer:e,method:i,query:t,definitionExpression:`${e.definitionExpression} ${e.serviceDefinitionExpression}`})},XMe=({queryPayload:t,layer:e,method:i})=>{vX({layer:e,method:i,query:t,definitionExpression:`${e.definitionExpression} ${e.serviceDefinitionExpression}`})},_X={editing:!1,operations:{add:!0,update:!0,delete:!0}},bX=We.ofType(sX),KMe="graphic.layer.capabilities.operations.supportsResizeAttachments";let cc=class extends e1{constructor(t){super(t),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.abilities=E({},_X),this.activeAttachmentInfo=null,this.attachmentInfos=new bX,this.graphic=null,this.mode="view",this.handles.add([Ke(this,"graphic",()=>this._graphicChanged())])}destroy(){this._attachmentLayer=null,this.graphic=null}castAbilities(t){return E(E({},_X),t)}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){return this.get(KMe)||!1}async getAttachments(){const{_attachmentLayer:t,attachmentInfos:e}=this;if(!t||typeof t.queryAttachments!="function")throw new Q("invalid-layer","getAttachments(): A valid layer is required.");const i=this._getFeatureId(),r=new EA({objectIds:[i],returnMetadata:!0}),s=[],n=t.queryAttachments(r).then(a=>a[i]||s).catch(()=>s);this._getAttachmentsPromise=n,this.notifyChange("state");const o=await n;return e.removeAll(),o.length&&e.addMany(o),this._getAttachmentsPromise=null,this.notifyChange("state"),o}async addAttachment(t){const{_attachmentLayer:e,attachmentInfos:i,graphic:r,abilities:s}=this;if(!t)throw new Q("invalid-attachment","addAttachment(): An attachment is required.",{attachment:t});if(!s.operations.add)throw new Q("invalid-abilities","addAttachment(): add abilities are required.");if(!e||typeof e.addAttachment!="function")throw new Q("invalid-layer","addAttachment(): A valid layer is required.");const n=e.addAttachment(r,t).then(a=>this._queryAttachment(a.objectId)),o=await n;return i.add(o),o}async deleteAttachment(t){const{_attachmentLayer:e,attachmentInfos:i,graphic:r,abilities:s}=this;if(!t)throw new Q("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!s.operations.delete)throw new Q("invalid-abilities","deleteAttachment(): delete abilities are required.");if(!e||typeof e.deleteAttachments!="function")throw new Q("invalid-layer","deleteAttachment(): A valid layer is required.");const n=e.deleteAttachments(r,[t.id]).then(()=>t),o=await n;return i.remove(o),o}async updateAttachment(t,e=this.activeAttachmentInfo){const{_attachmentLayer:i,attachmentInfos:r,graphic:s,abilities:n}=this;if(!t)throw new Q("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:t});if(!e)throw new Q("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!n.operations.update)throw new Q("invalid-abilities","updateAttachment(): Update abilities are required.");const o=r.findIndex(c=>c===e);if(!i||typeof i.updateAttachment!="function")throw new Q("invalid-layer","updateAttachment(): A valid layer is required.");const a=i.updateAttachment(s,e.id,t).then(c=>this._queryAttachment(c.objectId)),l=await a;return r.splice(o,1,l),l}async _queryAttachment(t){if(!t)throw new Q("invalid-attachment-id","Could not query attachment.");const{_attachmentLayer:e}=this,i=this._getFeatureId(),r=new EA({objectIds:[i],attachmentsWhere:`AttachmentId=${t}`,returnMetadata:!0});return e.queryAttachments(r).then(s=>s[i][0])}_getFeatureId(){const{_attachmentLayer:t,graphic:e}=this;if(!t||!e)return null;const{objectIdField:i}=t,{attributes:r}=e;return r&&r[i]}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(()=>{}))}_setAttachmentLayer(){const{graphic:t}=this,e=lX(t);this._attachmentLayer=e?e.type==="scene"&&_(e.associatedLayer)?e.associatedLayer:e:null}};u([d()],cc.prototype,"abilities",void 0),u([ut("abilities")],cc.prototype,"castAbilities",null),u([d()],cc.prototype,"activeAttachmentInfo",void 0),u([d({readOnly:!0,type:bX})],cc.prototype,"attachmentInfos",void 0),u([d({type:pn})],cc.prototype,"graphic",void 0),u([d()],cc.prototype,"mode",void 0),u([d({readOnly:!0})],cc.prototype,"state",null),u([d({readOnly:!0})],cc.prototype,"supportsResizeAttachments",null),cc=u([R("esri.widgets.Attachments.AttachmentsViewModel")],cc);const _k=cc;function ePe(t){const e=t.toLowerCase();return e==="image/bmp"||e==="image/emf"||e==="image/exif"||e==="image/gif"||e==="image/x-icon"||e==="image/jpeg"||e==="image/png"||e==="image/tiff"||e==="image/x-wmf"}function tPe(t){const e=kt("esri/themes/base/images/files/");return t?t==="text/plain"?`${e}text-32.svg`:t==="application/pdf"?`${e}pdf-32.svg`:t==="text/csv"?`${e}csv-32.svg`:t==="application/gpx+xml"?`${e}gpx-32.svg`:t==="application/x-dwf"?`${e}cad-32.svg`:t==="application/postscript"||t==="application/json"||t==="text/xml"||t==="model/vrml"?`${e}code-32.svg`:t==="application/x-zip-compressed"||t==="application/x-7z-compressed"||t==="application/x-gzip"||t==="application/x-tar"||t==="application/x-gtar"||t==="application/x-bzip2"||t==="application/gzip"||t==="application/x-compress"||t==="application/x-apple-diskimage"||t==="application/x-rar-compressed"||t==="application/zip"?`${e}zip-32.svg`:t.indexOf("image/")!==-1?`${e}image-32.svg`:t.indexOf("audio/")!==-1?`${e}sound-32.svg`:t.indexOf("video/")!==-1?`${e}video-32.svg`:t.indexOf("msexcel")!==-1||t.indexOf("ms-excel")!==-1||t.indexOf("spreadsheetml")!==-1?`${e}excel-32.svg`:t.indexOf("msword")!==-1||t.indexOf("ms-word")!==-1||t.indexOf("wordprocessingml")!==-1?`${e}word-32.svg`:t.indexOf("powerpoint")!==-1||t.indexOf("presentationml")!==-1?`${e}report-32.svg`:`${e}generic-32.svg`:`${e}generic-32.svg`}function qs(t){return function(e,i){e.hasOwnProperty("_messageBundleProps")||(e._messageBundleProps=e._messageBundleProps?e._messageBundleProps.slice():[]),e._messageBundleProps.push({bundlePath:t,propertyName:i})}}var iPe=function(t){return{vnodeSelector:"",properties:void 0,children:void 0,text:t.toString(),domNode:null}},wX=function(t,e){for(var i=0,r=t.length;i<r;i++){var s=t[i];Array.isArray(s)?wX(s,e):s!=null&&s!==!1&&(s.hasOwnProperty("vnodeSelector")||(s=iPe(s)),e.push(s))}},rPe=function(t,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];if(i.length===1&&typeof i[0]=="string")return{vnodeSelector:t,properties:e||void 0,children:void 0,text:i[0],domNode:null};var s=[];return wX(i,s),{vnodeSelector:t,properties:e||void 0,children:s,text:void 0,domNode:null}};function ee(t,e,...i){return typeof t!="function"||ck(t)?rPe(t,e,...i):t(e,...i)}const xX={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},Ne={base:"esri-attachments",loaderContainer:"esri-attachments__loader-container",loader:"esri-attachments__loader",fadeIn:"esri-attachments--fade-in",container:"esri-attachments__container",containerList:"esri-attachments__container--list",containerPreview:"esri-attachments__container--preview",actions:"esri-attachments__actions",deleteButton:"esri-attachments__delete-button",addAttachmentButton:"esri-attachments__add-attachment-button",errorMessage:"esri-attachments__error-message",items:"esri-attachments__items",item:"esri-attachments__item",itemButton:"esri-attachments__item-button",itemMask:"esri-attachments__item-mask",itemMaskIcon:"esri-attachments__item-mask--icon",itemImage:"esri-attachments__image",itemImageResizable:"esri-attachments__image--resizable",itemLabel:"esri-attachments__label",itemFilename:"esri-attachments__filename",itemChevronIcon:"esri-attachments__item-chevron-icon",itemLink:"esri-attachments__item-link",itemLinkOverlay:"esri-attachments__item-link-overlay",itemLinkOverlayIcon:"esri-attachments__item-link-overlay-icon",itemEditIcon:"esri-attachments__item-edit-icon",itemAddIcon:"esri-attachments__item-add-icon",itemAddButton:"esri-attachments__item-add-button",formNode:"esri-attachments__form-node",fileFieldset:"esri-attachments__file-fieldset",fileLabel:"esri-attachments__file-label",fileName:"esri-attachments__file-name",fileInput:"esri-attachments__file-input",metadata:"esri-attachments__metadata",metadataFieldset:"esri-attachments__metadata-fieldset",progressBar:"esri-attachments__progress-bar",esriWidget:"esri-widget",esriButton:"esri-button",buttonDisabled:"esri-button--disabled",esriButtonSecondary:"esri-button--secondary",esriButtonTertiary:"esri-button--tertiary",esriButtonThird:"esri-button--third",esriButtonSmall:"esri-button--small",esriButtonHalf:"esri-button--half",empty:"esri-widget__content--empty",iconExternalLink:"esri-icon-link-external",iconEdit:"esri-icon-edit",iconRight:"esri-icon-right",iconLeft:"esri-icon-left",iconPlus:"esri-icon-plus"},bk=window.CSS;let fn=class extends Bs{constructor(t,e){super(t,e),this.abilities=null,this.displayType="auto",this.graphic=null,this.label=void 0,this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=new _k,this.visibleElements=E({},xX),this._supportsImageOrientation=bk&&bk.supports&&bk.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}initialize(){this.own(ks(this,"viewModel.attachmentInfos","change",()=>this.scheduleRender()),Ke(this,"viewModel.mode",()=>this._modeChanged()))}get effectiveDisplayType(){return this.displayType==="auto"?this.viewModel.supportsResizeAttachments?"preview":"list":this.displayType}castVisibleElements(t){return E(E({},xX),t)}addAttachment(){const{_addAttachmentForm:t,viewModel:e}=this;return this._set("submitting",!0),this._set("error",null),e.addAttachment(t).then(i=>(this._set("submitting",!1),this._set("error",null),e.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new Q("attachments:add-attachment",this.messages.addErrorMessage,i)),i})}deleteAttachment(t){const{viewModel:e}=this;return this._set("submitting",!0),this._set("error",null),e.deleteAttachment(t).then(i=>(this._set("submitting",!1),this._set("error",null),e.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new Q("attachments:delete-attachment",this.messages.deleteErrorMessage,i)),i})}updateAttachment(){const{viewModel:t}=this,{_updateAttachmentForm:e}=this;return this._set("submitting",!0),this._set("error",null),t.updateAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),t.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new Q("attachments:update-attachment",this.messages.updateErrorMessage,i)),i})}render(){const{submitting:t,viewModel:e}=this,{state:i}=e;return ee("div",{class:this.classes(Ne.base,Ne.esriWidget)},t?this.renderProgressBar():null,i==="loading"?this.renderLoading():this.renderAttachments(),this.renderErrorMessage())}renderErrorMessage(){const{error:t,visibleElements:e}=this;return t&&e.errorMessage?ee("div",{key:"error-message",class:Ne.errorMessage},t.message):null}renderAttachments(){const{mode:t,activeAttachmentInfo:e}=this.viewModel;return t==="add"?this.renderAddForm():t==="edit"?this.renderDetailsForm(e):this.renderAttachmentContainer()}renderLoading(){return ee("div",{class:Ne.loaderContainer,key:"loader"},ee("div",{class:Ne.loader}))}renderProgressBar(){return this.visibleElements.progressBar?ee("div",{class:Ne.progressBar,key:"progress-bar"}):null}renderAddForm(){const{submitting:t,selectedFile:e}=this,i=t||!e,r=this.visibleElements.cancelAddButton?ee("button",{type:"button",bind:this,disabled:t,onclick:this._cancelForm,class:this.classes(Ne.esriButton,Ne.esriButtonTertiary,Ne.esriButtonSmall,Ne.esriButtonHalf,t&&Ne.buttonDisabled)},this.messages.cancel):null,s=this.visibleElements.addSubmitButton?ee("button",{type:"submit",disabled:i,class:this.classes(Ne.esriButton,Ne.esriButtonSecondary,Ne.esriButtonSmall,Ne.esriButtonHalf,{[Ne.buttonDisabled]:i})},this.messages.add):null,n=e?ee("span",{key:"file-name",class:Ne.fileName},e.name):null,o=ee("form",{bind:this,afterCreate:Q6,afterRemoved:rY,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},ee("fieldset",{class:Ne.fileFieldset},n,ee("label",{class:this.classes(Ne.fileLabel,Ne.esriButton,Ne.esriButtonSecondary)},e?this.messages.changeFile:this.messages.selectFile,ee("input",{class:Ne.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))),s,r);return ee("div",{key:"add-form-container",class:Ne.formNode},o)}renderDetailsForm(t){const{visibleElements:e,viewModel:i,selectedFile:r,submitting:s}=this,{contentType:n,size:o,url:a}=t,{abilities:l}=i,c=s||!r,h=l.editing&&l.operations.delete&&e.deleteButton?ee("button",{key:"delete-button",type:"button",disabled:s,bind:this,onclick:S=>this._submitDeleteAttachment(S,t),class:this.classes(Ne.esriButton,Ne.esriButtonSmall,Ne.esriButtonTertiary,Ne.deleteButton,{[Ne.buttonDisabled]:s})},this.messages.delete):null,p=l.editing&&l.operations.update&&e.updateButton?ee("button",{disabled:c,key:"update-button",type:"submit",class:this.classes(Ne.esriButton,Ne.esriButtonSmall,Ne.esriButtonThird,{[Ne.buttonDisabled]:c})},this.messages.update):null,f=this.visibleElements.cancelUpdateButton?ee("button",{disabled:s,key:"cancel-button",type:"button",bind:this,onclick:this._cancelForm,class:this.classes(Ne.esriButton,Ne.esriButtonSmall,Ne.esriButtonTertiary,Ne.esriButtonThird,{[Ne.buttonDisabled]:s})},this.messages.cancel):null,g=r?ee("span",{key:"file-name",class:Ne.fileName},r.name):null,y=l.editing&&l.operations.update?ee("fieldset",{key:"file",class:Ne.fileFieldset},g,ee("label",{class:this.classes(Ne.fileLabel,Ne.esriButton,Ne.esriButtonSecondary)},this.messages.changeFile,ee("input",{class:Ne.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))):null,v=ee("fieldset",{key:"size",class:Ne.metadataFieldset},ee("label",null,yMe(this.messagesUnits,o))),b=ee("fieldset",{key:"content-type",class:Ne.metadataFieldset},ee("label",null,n)),w=ee("form",{bind:this,afterCreate:Q6,afterRemoved:rY,"data-node-ref":"_updateAttachmentForm",onsubmit:this._submitUpdateAttachment},ee("div",{class:Ne.metadata},v,b),y,ee("div",{class:Ne.actions},h,f,p));return ee("div",{key:"edit-form-container",class:Ne.formNode},ee("a",{class:Ne.itemLink,href:a,rel:"noreferrer",target:"_blank"},this.renderImageMask({attachmentInfo:t,size:400}),ee("div",{class:Ne.itemLinkOverlay},ee("span",{class:Ne.itemLinkOverlayIcon},ee("svg",{xmlns:"http://www.w3.org/2000/svg",width:"32",height:"32",viewBox:"0 0 32 32"},ee("path",{d:"M28 13h1v16H3V3h16v1H4v24h24zm-5-9h4.293L15.646 15.638l.707.707L28 4.707V9h1V3h-6z"}),ee("path",{fill:"none",d:"M0 0h32v32H0z"}))))),w)}renderImageMask({attachmentInfo:t,size:e}){const{supportsResizeAttachments:i}=this.viewModel,{contentType:r,name:s,url:n}=t,o=i&&ePe(r),a=this._getCSSTransform(t,o),l=a?{transform:a,"image-orientation":"none"}:{},c=n.indexOf("?")===-1?"?":"&",h=o?`${n}${c}w=${e}`:tPe(r),p={[Ne.itemMaskIcon]:!o},f={[Ne.itemImageResizable]:i};return ee("div",{class:this.classes(p,Ne.itemMask)},ee("img",{styles:l,alt:s,src:h,class:this.classes(f,Ne.itemImage)}))}renderAttachmentInfo({attachmentInfo:t,displayType:e}){const{viewModel:i}=this,{abilities:r}=i,{name:s,url:n}=t,o=this.renderImageMask({attachmentInfo:t,size:e==="list"?48:400}),a=r.editing?ee("span",{"aria-hidden":"true",class:this.classes(Ne.itemChevronIcon,yf(this.container)?Ne.iconLeft:Ne.iconRight)}):null,l=[o,ee("label",{class:Ne.itemLabel},ee("span",{class:Ne.itemFilename},s||this.messages.noTitle),a)],c=r.editing?ee("button",{key:"details-button",bind:this,class:Ne.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,"data-attachment-info-id":t.id,onclick:()=>this._startEditAttachment(t),type:"button"},l):ee("a",{key:"details-link",class:Ne.itemButton,href:n,target:"_blank"},l);return ee("li",{class:Ne.item,key:t},c)}renderAttachmentContainer(){const{effectiveDisplayType:t,viewModel:e,visibleElements:i}=this,{attachmentInfos:r,abilities:s}=e,n=r&&r.length,o={[Ne.containerList]:t!=="preview",[Ne.containerPreview]:t==="preview"},a=s.editing&&s.operations.add&&i.addButton?ee("button",{bind:this,onclick:()=>this._startAddAttachment(),class:this.classes(Ne.esriButton,Ne.esriButtonTertiary,Ne.addAttachmentButton),type:"button"},ee("span",{"aria-hidden":"true",class:this.classes(Ne.itemAddIcon,Ne.iconPlus)}),this.messages.add):null,l=n?ee("ul",{class:Ne.items},r.toArray().map(c=>this.renderAttachmentInfo({attachmentInfo:c,displayType:t}))):ee("div",{class:Ne.empty},this.messages.noAttachments);return ee("div",{key:"attachments-container",class:this.classes(Ne.container,o)},l,a)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(t){const e=t.target,i=e&&e.files&&e.files.item(0);this._set("selectedFile",i)}_submitDeleteAttachment(t,e){t.preventDefault(),this.deleteAttachment(e)}_submitAddAttachment(t){t.preventDefault(),this.addAttachment()}_submitUpdateAttachment(t){t.preventDefault(),this.updateAttachment()}_startEditAttachment(t){const{viewModel:e}=this;e.activeAttachmentInfo=t,e.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(t){t.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(t,e){const{orientationInfo:i}=t;return!this._supportsImageOrientation&&e&&i?[i.rotation?`rotate(${i.rotation}deg)`:"",i.mirrored?"scaleX(-1)":""].join(" "):""}};u([Ve("viewModel.abilities")],fn.prototype,"abilities",void 0),u([d()],fn.prototype,"displayType",void 0),u([d({readOnly:!0})],fn.prototype,"effectiveDisplayType",null),u([Ve("viewModel.graphic")],fn.prototype,"graphic",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],fn.prototype,"label",void 0),u([d(),qs("esri/widgets/Attachments/t9n/Attachments")],fn.prototype,"messages",void 0),u([d(),qs("esri/core/t9n/Units")],fn.prototype,"messagesUnits",void 0),u([d({readOnly:!0})],fn.prototype,"selectedFile",void 0),u([d({readOnly:!0})],fn.prototype,"submitting",void 0),u([d({readOnly:!0})],fn.prototype,"error",void 0),u([d({type:_k})],fn.prototype,"viewModel",void 0),u([d()],fn.prototype,"visibleElements",void 0),u([ut("visibleElements")],fn.prototype,"castVisibleElements",null),fn=u([R("esri.widgets.Attachments")],fn);const sPe=fn;let P2=class extends _k{constructor(t){super(t),this.description=null,this.title=null}};u([d()],P2.prototype,"description",void 0),u([d()],P2.prototype,"title",void 0),P2=u([R("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],P2);const wk=P2,nPe={heading:"esri-widget__heading"};function xk(t,e){const i=`h${Re(Math.ceil(t.level),1,6)}`;return delete t.level,ee(i,he(E({},t),{class:iY(nPe.heading,t.class)}),e)}const Sk={base:"esri-feature-element-info",title:"esri-feature-element-info__title",description:"esri-feature-element-info__description"};let X1=class extends Bs{constructor(t,e){super(t,e),this.description=null,this.headingLevel=2,this.title=null}render(){return ee("div",{class:Sk.base},this.renderTitle(),this.renderDescription())}renderTitle(){const{title:t}=this;return t?ee(xk,{level:this.headingLevel,class:Sk.title},t):null}renderDescription(){const{description:t}=this;return t?ee("div",{key:"description",class:Sk.description},t):null}};u([d()],X1.prototype,"description",void 0),u([d()],X1.prototype,"headingLevel",void 0),u([d()],X1.prototype,"title",void 0),X1=u([R("esri.widgets.Feature.support.FeatureElementInfo")],X1);const Tk=X1,oPe={base:"esri-feature-attachments"};let xu=class extends Bs{constructor(t,e){super(t,e),this._featureElementInfo=null,this.attachmentsWidget=new sPe,this.description=null,this.displayType=null,this.graphic=null,this.headingLevel=2,this.title=null,this.viewModel=new wk}initialize(){this._featureElementInfo=new Tk,Ke(this,["viewModel.description","viewModel.title","headingLevel"],()=>this._setupFeatureElementInfo()),Ke(this,"viewModel.graphic",t=>this.attachmentsWidget.graphic=t)}destroy(){this.attachmentsWidget.destroy(),this._featureElementInfo.destroy()}render(){var t;const{attachmentsWidget:e}=this;return ee("div",{class:oPe.base},(t=this._featureElementInfo)==null?void 0:t.render(),e==null?void 0:e.render())}_setupFeatureElementInfo(){const{description:t,title:e,headingLevel:i}=this;this._featureElementInfo.set({description:t,title:e,headingLevel:i})}};u([d({readOnly:!0})],xu.prototype,"attachmentsWidget",void 0),u([Ve("viewModel.description")],xu.prototype,"description",void 0),u([Ve("attachmentsWidget.displayType")],xu.prototype,"displayType",void 0),u([Ve("viewModel.graphic")],xu.prototype,"graphic",void 0),u([d()],xu.prototype,"headingLevel",void 0),u([Ve("viewModel.title")],xu.prototype,"title",void 0),u([d({type:wk})],xu.prototype,"viewModel",void 0),xu=u([R("esri.widgets.Feature.FeatureAttachments")],xu);const aPe=xu;let bf=class extends tu(ve){constructor(t){super(t),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.handles.add(Ke(this,"creator",e=>{this._destroyContent(),this._createContent(e)}))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:t,graphic:e,destroyer:i}=this;t&&(OA(i,{graphic:e}).catch(()=>null),this._set("created",null))}async _createContent(t){const{graphic:e}=this,i=OA(t,{graphic:e}).catch(()=>null);this._loadingPromise=i,this.notifyChange("state");const r=await i;i===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",r))}};u([d({readOnly:!0})],bf.prototype,"created",void 0),u([d()],bf.prototype,"creator",void 0),u([d()],bf.prototype,"destroyer",void 0),u([d({type:pn})],bf.prototype,"graphic",void 0),u([d({readOnly:!0})],bf.prototype,"state",null),bf=u([R("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],bf);const IA=bf;function ia(){return function(t,e){if(!t[e])throw new TypeError(`Cannot auto bind undefined function '${e}'`);return{value:cPe(t[e])}}}function lPe(t){const{type:e}=t;return t instanceof KeyboardEvent||e==="keyup"||e==="keydown"||e==="keypress"}function cPe(t){return function(e,...i){lPe(e)?eCe(e.key)&&(e.preventDefault(),e.stopPropagation(),e.target.click()):t.call(this,e,...i)}}function uPe(t){return t.split(",").map(e=>e.trim())}function hPe(t){return e=>{e.hasOwnProperty("_delegatedEventNames")||(e._delegatedEventNames=e._delegatedEventNames?e._delegatedEventNames.slice():[]);const i=e._delegatedEventNames,r=Array.isArray(t)?t:uPe(t);i.push(...r)}}function DA(t){return t&&typeof t.render=="function"}function SX(t){return t&&typeof t.postMixInProperties=="function"&&typeof t.buildRendering=="function"&&typeof t.postCreate=="function"&&typeof t.startup=="function"}const Ck={base:"esri-feature-content",loaderContainer:"esri-feature-content__loader-container",loader:"esri-feature-content__loader"};let K1=class extends Bs{constructor(t,e){super(t,e),this.creator=null,this.graphic=null,this.viewModel=null,this._addTargetToAnchors=i=>{Array.from(i.querySelectorAll("a")).forEach(r=>{cX(r.href)&&!r.hasAttribute("target")&&r.setAttribute("target","_blank")})}}renderLoading(){return ee("div",{class:Ck.loaderContainer,key:"loader"},ee("div",{class:Ck.loader}))}renderCreated(){var t;const e=(t=this.viewModel)==null?void 0:t.created;return e?e instanceof HTMLElement?ee("div",{key:e,bind:e,afterCreate:this._attachToNode}):DA(e)?ee("div",{key:e},!e.destroyed&&e.render()):ee("div",{key:e,innerHTML:e,afterCreate:this._addTargetToAnchors}):null}render(){var t;const e=(t=this.viewModel)==null?void 0:t.state;return ee("div",{class:Ck.base},e==="loading"?this.renderLoading():this.renderCreated())}_attachToNode(t){const e=this;t.appendChild(e)}};u([Ve("viewModel.creator")],K1.prototype,"creator",void 0),u([Ve("viewModel.graphic")],K1.prototype,"graphic",void 0),u([d({type:IA})],K1.prototype,"viewModel",void 0),K1=u([R("esri.widgets.Feature.FeatureContent")],K1);const FA=K1;let ed=class extends ve{constructor(t){super(t),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:t,fieldInfos:e}=this,i=[];return e==null||e.forEach(r=>{if(!(!r.hasOwnProperty("visible")||r.visible))return;const s=r.clone();s.label=hX(s,t),i.push(s)}),i}};u([d()],ed.prototype,"attributes",void 0),u([d({type:[EW]})],ed.prototype,"expressionInfos",void 0),u([d()],ed.prototype,"description",void 0),u([d({type:[Rx]})],ed.prototype,"fieldInfos",void 0),u([d({readOnly:!0})],ed.prototype,"formattedFieldInfos",null),u([d()],ed.prototype,"title",void 0),ed=u([R("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],ed);const LA=ed,dPe=[{pattern:/^\s*(https?:\/\/([^\s]+))\s*$/i,target:"_blank",label:"{messages.view}"},{pattern:/^\s*(tel:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(mailto:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(arcgis-appstudio-player:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"App Studio Player"},{pattern:/^\s*(arcgis-collector:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Collector"},{pattern:/^\s*(arcgis-explorer:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Explorer"},{pattern:/^\s*(arcgis-navigator:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Navigator"},{pattern:/^\s*(arcgis-survey123:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Survey123"},{pattern:/^\s*(arcgis-trek2there:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Trek2There"},{pattern:/^\s*(arcgis-workforce:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Workforce"},{pattern:/^\s*(iform:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"iForm"},{pattern:/^\s*(flow:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"FlowFinity"},{pattern:/^\s*(lfmobile:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Laserfische"},{pattern:/^\s*(mspbi:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Microsoft Power Bi"}];function pPe(t){let e=null;return dPe.some(i=>(i.pattern.test(t)&&(e=i),!!e)),e}function fPe(t,e){if(typeof e!="string"||!e)return e;const i=pPe(e);if(!i)return e;const r=e.match(i.pattern),s=r&&r[2],n=Dl(Dl(i.label,{messages:t,hierPart:s}),{appName:i.appName}),o=i.target?` target="${i.target}"`:"",a=i.target==="_blank"?' rel="noreferrer"':"";return e.replace(i.pattern,`<a${o} href="$1"${a}>${n}</a>`)}const A2={base:"esri-feature-fields",fieldHeader:"esri-feature-fields__field-header",fieldData:"esri-feature-fields__field-data",fieldDataDate:"esri-feature-fields__field-data--date",esriTable:"esri-widget__table"};let uc=class extends Bs{constructor(t,e){super(t,e),this._featureElementInfo=null,this.attributes=null,this.description=null,this.expressionInfos=null,this.fieldInfos=null,this.title=null,this.viewModel=new LA,this.messages=null,this.messagesURIUtils=null}initialize(){this._featureElementInfo=new Tk,Ke(this,["viewModel.description","viewModel.title"],()=>this._setupFeatureElementInfo())}destroy(){this._featureElementInfo.destroy()}renderFieldInfo(t,e){const{attributes:i}=this.viewModel,r=t.fieldName,s=t.label||r,n=i?i[r]==null?"":i[r]:"",o=!(!t.format||!t.format.dateFormat),a=typeof n=="number"&&!o?this._forceLTR(n):fPe(this.messagesURIUtils,n),l={[A2.fieldDataDate]:o};return ee("tr",{key:`fields-element-info-row-${r}-${e}`},ee("th",{key:`fields-element-info-row-header-${r}-${e}`,class:A2.fieldHeader,innerHTML:s}),ee("td",{key:`fields-element-info-row-data-${r}-${e}`,class:this.classes(A2.fieldData,l),innerHTML:a}))}renderFields(){const{formattedFieldInfos:t}=this.viewModel;return t!=null&&t.length?ee("table",{class:A2.esriTable,summary:this.messages.fieldsSummary},ee("tbody",null,t.map((e,i)=>this.renderFieldInfo(e,i)))):null}render(){var t;return ee("div",{class:A2.base},(t=this._featureElementInfo)==null?void 0:t.render(),this.renderFields())}_setupFeatureElementInfo(){const{description:t,title:e}=this;this._featureElementInfo.set({description:t,title:e})}_forceLTR(t){return`&lrm;${t}`}};u([Ve("viewModel.attributes")],uc.prototype,"attributes",void 0),u([Ve("viewModel.description")],uc.prototype,"description",void 0),u([Ve("viewModel.expressionInfos")],uc.prototype,"expressionInfos",void 0),u([Ve("viewModel.fieldInfos")],uc.prototype,"fieldInfos",void 0),u([Ve("viewModel.title")],uc.prototype,"title",void 0),u([d({type:LA})],uc.prototype,"viewModel",void 0),u([d(),qs("esri/widgets/Feature/t9n/Feature")],uc.prototype,"messages",void 0),u([d(),qs("esri/widgets/support/t9n/uriUtils")],uc.prototype,"messagesURIUtils",void 0),uc=u([R("esri.widgets.Feature.FeatureFields")],uc);const TX=uc,CX={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5,weeks:6048e5,months:26784e5,years:31536e6,decades:31536e7,centuries:31536e8},mPe={milliseconds:{getter:"getMilliseconds",setter:"setMilliseconds",multiplier:1},seconds:{getter:"getSeconds",setter:"setSeconds",multiplier:1},minutes:{getter:"getMinutes",setter:"setMinutes",multiplier:1},hours:{getter:"getHours",setter:"setHours",multiplier:1},days:{getter:"getDate",setter:"setDate",multiplier:1},weeks:{getter:"getDate",setter:"setDate",multiplier:7},months:{getter:"getMonth",setter:"setMonth",multiplier:1},years:{getter:"getFullYear",setter:"setFullYear",multiplier:1},decades:{getter:"getFullYear",setter:"setFullYear",multiplier:10},centuries:{getter:"getFullYear",setter:"setFullYear",multiplier:100}};function Ty(t,e,i){const r=new Date(t.getTime());if(e&&i){const s=mPe[i],{getter:n,setter:o,multiplier:a}=s;r[o](r[n]()+e*a)}return r}function MX(t,e){switch(e){case"milliseconds":return new Date(t.getTime());case"seconds":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds());case"minutes":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes());case"hours":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());case"days":return new Date(t.getFullYear(),t.getMonth(),t.getDate());case"weeks":return new Date(t.getFullYear(),t.getMonth(),t.getDate()-t.getDay());case"months":return new Date(t.getFullYear(),t.getMonth(),1);case"years":return new Date(t.getFullYear(),0,1);case"decades":return new Date(t.getFullYear()-t.getFullYear()%10,0,1);case"centuries":return new Date(t.getFullYear()-t.getFullYear()%100,0,1);default:return new Date}}function gPe(t,e,i){return t===0?0:t*CX[e]/CX[i]}var hc;let ra=hc=class extends ge{constructor(t){super(t),this.end=null,this.start=null}static get allTime(){return PX}static get empty(){return yPe}readEnd(t,e){return e.end!=null?new Date(e.end):null}writeEnd(t,e){e.end=t?t.getTime():null}get isAllTime(){return this.equals(hc.allTime)}get isEmpty(){return this.equals(hc.empty)}readStart(t,e){return e.start!=null?new Date(e.start):null}writeStart(t,e){e.start=t?t.getTime():null}clone(){return new hc({end:this.end,start:this.start})}equals(t){if(!t)return!1;const e=_(this.start)?this.start.getTime():this.start,i=_(this.end)?this.end.getTime():this.end,r=_(t.start)?t.start.getTime():t.start,s=_(t.end)?t.end.getTime():t.end;return e===r&&i===s}expandTo(t){if(this.isEmpty||this.isAllTime)return this.clone();const e=LB(this.start,r=>MX(r,t)),i=LB(this.end,r=>Ty(MX(r,t),1,t));return new hc({start:e,end:i})}intersection(t){if(!t)return this.clone();if(this.isEmpty||t.isEmpty)return hc.empty;if(this.isAllTime)return t.clone();if(t.isAllTime)return this.clone();const e=xh(this.start,-1/0,a=>a.getTime()),i=xh(this.end,1/0,a=>a.getTime()),r=xh(t.start,-1/0,a=>a.getTime()),s=xh(t.end,1/0,a=>a.getTime());let n,o;if(r>=e&&r<=i?n=r:e>=r&&e<=s&&(n=e),i>=r&&i<=s?o=i:s>=e&&s<=i&&(o=s),!isNaN(n)&&!isNaN(o)){const a=new hc;return a.start=n===-1/0?null:new Date(n),a.end=o===1/0?null:new Date(o),a}return hc.empty}offset(t,e){if(this.isEmpty||this.isAllTime)return this.clone();const i=new hc,{start:r,end:s}=this;return _(r)&&(i.start=Ty(r,t,e)),_(s)&&(i.end=Ty(s,t,e)),i}union(t){if(!t||t.isEmpty)return this.clone();if(this.isEmpty)return t.clone();if(this.isAllTime||t.isAllTime)return PX.clone();const e=_(this.start)&&_(t.start)?new Date(Math.min(this.start.getTime(),t.start.getTime())):null,i=_(this.end)&&_(t.end)?new Date(Math.max(this.end.getTime(),t.end.getTime())):null;return new hc({start:e,end:i})}};u([d({type:Date,json:{write:{allowNull:!0}}})],ra.prototype,"end",void 0),u([Ce("end")],ra.prototype,"readEnd",null),u([Ee("end")],ra.prototype,"writeEnd",null),u([d({readOnly:!0,json:{read:!1}})],ra.prototype,"isAllTime",null),u([d({readOnly:!0,json:{read:!1}})],ra.prototype,"isEmpty",null),u([d({type:Date,json:{write:{allowNull:!0}}})],ra.prototype,"start",void 0),u([Ce("start")],ra.prototype,"readStart",null),u([Ee("start")],ra.prototype,"writeStart",null),ra=hc=u([R("esri.TimeExtent")],ra);const PX=new ra,yPe=new ra({start:void 0,end:void 0}),Su=ra;var Mk;let $2=Mk=class extends ge{constructor(t){super(t),this.name=null,this.code=null}clone(){return new Mk({name:this.name,code:this.code})}};u([d({type:String,json:{write:!0}})],$2.prototype,"name",void 0),u([d({type:[String,Number],json:{write:!0}})],$2.prototype,"code",void 0),$2=Mk=u([R("esri.layers.support.CodedValue")],$2);const vPe=$2,_Pe=new wt({inherited:"inherited",codedValue:"coded-value",range:"range"});let E2=class extends ge{constructor(t){super(t),this.name=null,this.type=null}};u([d({type:String,json:{write:!0}})],E2.prototype,"name",void 0),u([Xe(_Pe)],E2.prototype,"type",void 0),E2=u([R("esri.layers.support.Domain")],E2);const kA=E2;var Pk;let O2=Pk=class extends kA{constructor(t){super(t),this.codedValues=null,this.type="coded-value"}getName(t){let e=null;if(this.codedValues){const i=String(t);this.codedValues.some(r=>(String(r.code)===i&&(e=r.name),!!e))}return e}clone(){return new Pk({codedValues:ie(this.codedValues),name:this.name})}};u([d({type:[vPe],json:{write:!0}})],O2.prototype,"codedValues",void 0),u([Xe({codedValue:"coded-value"})],O2.prototype,"type",void 0),O2=Pk=u([R("esri.layers.support.CodedValueDomain")],O2);const AX=O2;var Ak;let zA=Ak=class extends kA{constructor(t){super(t),this.type="inherited"}clone(){return new Ak}};u([Xe({inherited:"inherited"})],zA.prototype,"type",void 0),zA=Ak=u([R("esri.layers.support.InheritedDomain")],zA);const $X=zA;var $k;let e_=$k=class extends kA{constructor(t){super(t),this.maxValue=null,this.minValue=null,this.type="range"}clone(){return new $k({maxValue:this.maxValue,minValue:this.minValue,name:this.name})}};u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(t,e)=>e.range&&e.range[1]},write:{enabled:!1,overridePolicy(){return{enabled:this.maxValue!=null&&this.minValue==null}},target:"range",writer(t,e,i){e[i]=[this.minValue||0,t]}}}})],e_.prototype,"maxValue",void 0),u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(t,e)=>e.range&&e.range[0]},write:{target:"range",writer(t,e,i){e[i]=[t,this.maxValue||0]}}}})],e_.prototype,"minValue",void 0),u([Xe({range:"range"})],e_.prototype,"type",void 0),e_=$k=u([R("esri.layers.support.RangeDomain")],e_);const EX=e_,OX={key:"type",base:kA,typeMap:{range:EX,"coded-value":AX,inherited:$X}};function Ek(t){if(!t||!t.type)return null;switch(t.type){case"range":return EX.fromJSON(t);case"codedValue":return AX.fromJSON(t);case"inherited":return $X.fromJSON(t)}return null}const bPe=new wt({esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"oid",esriFieldTypeGeometry:"geometry",esriFieldTypeBlob:"blob",esriFieldTypeRaster:"raster",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"global-id",esriFieldTypeXML:"xml"});var Ok;const wPe=new wt({binary:"binary",coordinate:"coordinate",countOrAmount:"count-or-amount",dateAndTime:"date-and-time",description:"description",locationOrPlaceName:"location-or-place-name",measurement:"measurement",nameOrTitle:"name-or-title",none:"none",orderedOrRanked:"ordered-or-ranked",percentageOrRatio:"percentage-or-ratio",typeOrCategory:"type-or-category",uniqueIdentifier:"unique-identifier"});let Un=Ok=class extends ge{constructor(t){super(t),this.alias=null,this.defaultValue=void 0,this.description=null,this.domain=null,this.editable=!0,this.length=-1,this.name=null,this.nullable=!0,this.type=null,this.valueType=null}readDescription(t,{description:e}){let i;try{i=JSON.parse(e)}catch{}return i?i.value:null}readValueType(t,{description:e}){let i;try{i=JSON.parse(e)}catch{}return i?wPe.fromJSON(i.fieldValueType):null}clone(){return new Ok({alias:this.alias,defaultValue:this.defaultValue,description:this.description,domain:this.domain&&this.domain.clone()||null,editable:this.editable,length:this.length,name:this.name,nullable:this.nullable,type:this.type,valueType:this.valueType})}};u([d({type:String,json:{write:!0}})],Un.prototype,"alias",void 0),u([d({type:[String,Number],json:{write:{allowNull:!0}}})],Un.prototype,"defaultValue",void 0),u([d()],Un.prototype,"description",void 0),u([Ce("description")],Un.prototype,"readDescription",null),u([d({types:OX,json:{read:{reader:Ek},write:!0}})],Un.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],Un.prototype,"editable",void 0),u([d({type:Oi,json:{write:!0}})],Un.prototype,"length",void 0),u([d({type:String,json:{write:!0}})],Un.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0}})],Un.prototype,"nullable",void 0),u([Xe(bPe)],Un.prototype,"type",void 0),u([d()],Un.prototype,"valueType",void 0),u([Ce("valueType",["description"])],Un.prototype,"readValueType",null),Un=Ok=u([R("esri.layers.support.Field")],Un);const t_=Un;var Rk;let i_=Rk=class extends ge{constructor(t){super(t),this.type="map-layer"}clone(){const{mapLayerId:t,gdbVersion:e}=this;return new Rk({mapLayerId:t,gdbVersion:e})}};u([Xe({mapLayer:"map-layer"})],i_.prototype,"type",void 0),u([d({type:Oi,json:{write:!0}})],i_.prototype,"mapLayerId",void 0),u([d({type:String,json:{write:!0}})],i_.prototype,"gdbVersion",void 0),i_=Rk=u([R("esri.layers.support.source.MapLayerSource")],i_);var Ik;let td=Ik=class extends ge{constructor(t){super(t),this.type="query-table"}clone(){var t;const{workspaceId:e,query:i,oidFields:r,spatialReference:s,geometryType:n}=this,o={workspaceId:e,query:i,oidFields:r,spatialReference:(t=s==null?void 0:s.clone())!=null?t:void 0,geometryType:n};return new Ik(o)}};u([Xe({queryTable:"query-table"})],td.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],td.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],td.prototype,"query",void 0),u([d({type:String,json:{write:!0}})],td.prototype,"oidFields",void 0),u([d({type:Ue,json:{write:!0}})],td.prototype,"spatialReference",void 0),u([Xe(eW)],td.prototype,"geometryType",void 0),td=Ik=u([R("esri.layers.support.source.QueryTableDataSource")],td);var Dk;let r_=Dk=class extends ge{constructor(t){super(t),this.type="raster"}clone(){const{workspaceId:t,dataSourceName:e}=this;return new Dk({workspaceId:t,dataSourceName:e})}};u([Xe({raster:"raster"})],r_.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],r_.prototype,"dataSourceName",void 0),u([d({type:String,json:{write:!0}})],r_.prototype,"workspaceId",void 0),r_=Dk=u([R("esri.layers.support.source.RasterDataSource")],r_);var Fk;let Cy=Fk=class extends ge{constructor(t){super(t),this.type="table"}clone(){const{workspaceId:t,gdbVersion:e,dataSourceName:i}=this;return new Fk({workspaceId:t,gdbVersion:e,dataSourceName:i})}};u([Xe({table:"table"})],Cy.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Cy.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],Cy.prototype,"gdbVersion",void 0),u([d({type:String,json:{write:!0}})],Cy.prototype,"dataSourceName",void 0),Cy=Fk=u([R("esri.layers.support.source.TableDataSource")],Cy);var Lk,kk;const xPe=Ds()({esriLeftInnerJoin:"left-inner-join",esriLeftOuterJoin:"left-outer-join"});let sa=Lk=class extends ge{constructor(t){super(t),this.type="join-table"}readLeftTableSource(t,e,i){return RX()(t,e,i)}castLeftTableSource(t){return Zc(Nk(),t)}readRightTableSource(t,e,i){return RX()(t,e,i)}castRightTableSource(t){return Zc(Nk(),t)}clone(){var t,e;const{leftTableKey:i,rightTableKey:r,leftTableSource:s,rightTableSource:n,joinType:o}=this,a={leftTableKey:i,rightTableKey:r,leftTableSource:(t=s==null?void 0:s.clone())!=null?t:void 0,rightTableSource:(e=n==null?void 0:n.clone())!=null?e:void 0,joinType:o};return new Lk(a)}};u([Xe({joinTable:"join-table"})],sa.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],sa.prototype,"leftTableKey",void 0),u([d({type:String,json:{write:!0}})],sa.prototype,"rightTableKey",void 0),u([d({json:{write:!0}})],sa.prototype,"leftTableSource",void 0),u([Ce("leftTableSource")],sa.prototype,"readLeftTableSource",null),u([ut("leftTableSource")],sa.prototype,"castLeftTableSource",null),u([d({json:{write:!0}})],sa.prototype,"rightTableSource",void 0),u([Ce("rightTableSource")],sa.prototype,"readRightTableSource",null),u([ut("rightTableSource")],sa.prototype,"castRightTableSource",null),u([Xe(xPe)],sa.prototype,"joinType",void 0),sa=Lk=u([R("esri.layers.support.source.JoinTableDataSource")],sa);let zk=null;function RX(){return zk||(zk=Gv({types:Nk()})),zk}let Vk=null;function Nk(){return Vk||(Vk={key:"type",base:null,typeMap:{"data-layer":na,"map-layer":i_}}),Vk}const SPe={key:"type",base:null,typeMap:{"join-table":sa,"query-table":td,raster:r_,table:Cy}};let na=kk=class extends ge{constructor(t){super(t),this.type="data-layer"}clone(){const{fields:t,dataSource:e}=this;return new kk({fields:t,dataSource:e})}};u([Xe({dataLayer:"data-layer"})],na.prototype,"type",void 0),u([d({type:[t_],json:{write:!0}})],na.prototype,"fields",void 0),u([d({types:SPe,json:{write:!0}})],na.prototype,"dataSource",void 0),na=kk=u([R("esri.layers.support.source.DataLayerSource")],na),na.from=Ni(na);var Uk;const IX=new wt({upperLeft:"upper-left",lowerLeft:"lower-left"});let My=Uk=class extends ge{constructor(t){super(t),this.extent=null,this.mode="view",this.originPosition="upper-left",this.tolerance=1}clone(){return new Uk(ie({extent:this.extent,mode:this.mode,originPosition:this.originPosition,tolerance:this.tolerance}))}};u([d({type:ht,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],My.prototype,"extent",void 0),u([d({type:["view","edit"],json:{write:!0}})],My.prototype,"mode",void 0),u([d({type:String,json:{read:IX.read,write:IX.write}})],My.prototype,"originPosition",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],My.prototype,"tolerance",void 0),My=Uk=u([R("esri.rest.support.QuantizationParameters")],My);const TPe=My;var jk;const DX=new wt({count:"count",sum:"sum",min:"min",max:"max",avg:"avg",stddev:"stddev",var:"var",exceedslimit:"exceedslimit",percentile_cont:"percentile-continuous",percentile_disc:"percentile-discrete"});let dc=jk=class extends ge{constructor(t){super(t),this.maxPointCount=void 0,this.maxRecordCount=void 0,this.maxVertexCount=void 0,this.onStatisticField=null,this.outStatisticFieldName=null,this.statisticType=null,this.statisticParameters=null}writeStatisticParameters(t,e){this.statisticType!=="percentile-continuous"&&this.statisticType!=="percentile-discrete"||(e.statisticParameters=ie(t))}clone(){return new jk({maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,statisticType:this.statisticType,statisticParameters:ie(this.statisticParameters)})}};u([d({type:Number,json:{write:!0}})],dc.prototype,"maxPointCount",void 0),u([d({type:Number,json:{write:!0}})],dc.prototype,"maxRecordCount",void 0),u([d({type:Number,json:{write:!0}})],dc.prototype,"maxVertexCount",void 0),u([d({type:String,json:{write:!0}})],dc.prototype,"onStatisticField",void 0),u([d({type:String,json:{write:!0}})],dc.prototype,"outStatisticFieldName",void 0),u([d({type:String,json:{read:{source:"statisticType",reader:DX.read},write:{target:"statisticType",writer:DX.write}}})],dc.prototype,"statisticType",void 0),u([d({type:Object})],dc.prototype,"statisticParameters",void 0),u([Ee("statisticParameters")],dc.prototype,"writeStatisticParameters",null),dc=jk=u([R("esri.rest.support.StatisticDefinition")],dc);const FX=dc;var s_;const CPe=new wt({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),MPe=new wt({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let ot=s_=class extends ge{constructor(t){super(t),this.aggregateIds=null,this.cacheHint=void 0,this.datumTransformation=null,this.distance=void 0,this.dynamicDataSource=void 0,this.formatOf3DObjects=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=void 0,this.groupByFieldsForStatistics=null,this.having=null,this.historicMoment=null,this.maxAllowableOffset=void 0,this.maxRecordCountFactor=1,this.multipatchOption=null,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.outStatistics=null,this.parameterValues=null,this.pixelSize=null,this.quantizationParameters=null,this.rangeValues=null,this.relationParameter=null,this.resultType=null,this.returnCentroid=!1,this.returnDistinctValues=!1,this.returnExceededLimitFeatures=!0,this.returnGeometry=!1,this.returnQueryGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.sourceSpatialReference=null,this.spatialRelationship="intersects",this.start=void 0,this.sqlFormat=null,this.text=null,this.timeExtent=null,this.timeReferenceUnknownClient=!1,this.units=null,this.where=null}static from(t){return Bv(s_,t)}castDatumTransformation(t){return typeof t=="number"||typeof t=="object"?t:null}writeHistoricMoment(t,e){e.historicMoment=t&&t.getTime()}writeParameterValues(t,e){if(t){const i={};for(const r in t){const s=t[r];Array.isArray(s)?i[r]=s.map(n=>n instanceof Date?n.getTime():n):s instanceof Date?i[r]=s.getTime():i[r]=s}e.parameterValues=i}}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10,e.where="1=1"}writeWhere(t,e){e.where=t||"1=1"}clone(){return new s_(ie({aggregateIds:this.aggregateIds,cacheHint:this.cacheHint,datumTransformation:this.datumTransformation,distance:this.distance,gdbVersion:this.gdbVersion,geometry:this.geometry,geometryPrecision:this.geometryPrecision,groupByFieldsForStatistics:this.groupByFieldsForStatistics,having:this.having,historicMoment:_(this.historicMoment)?new Date(this.historicMoment.getTime()):null,maxAllowableOffset:this.maxAllowableOffset,maxRecordCountFactor:this.maxRecordCountFactor,multipatchOption:this.multipatchOption,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,outStatistics:this.outStatistics,parameterValues:this.parameterValues,pixelSize:this.pixelSize,quantizationParameters:this.quantizationParameters,rangeValues:this.rangeValues,relationParameter:this.relationParameter,resultType:this.resultType,returnDistinctValues:this.returnDistinctValues,returnGeometry:this.returnGeometry,returnCentroid:this.returnCentroid,returnExceededLimitFeatures:this.returnExceededLimitFeatures,returnQueryGeometry:this.returnQueryGeometry,returnM:this.returnM,returnZ:this.returnZ,dynamicDataSource:this.dynamicDataSource,sourceSpatialReference:this.sourceSpatialReference,spatialRelationship:this.spatialRelationship,start:this.start,sqlFormat:this.sqlFormat,text:this.text,timeExtent:this.timeExtent,timeReferenceUnknownClient:this.timeReferenceUnknownClient,units:this.units,where:this.where}))}};ot.MAX_MAX_RECORD_COUNT_FACTOR=5,u([d({json:{write:!0}})],ot.prototype,"aggregateIds",void 0),u([d({type:Boolean,json:{write:!0}})],ot.prototype,"cacheHint",void 0),u([d({json:{write:!0}})],ot.prototype,"datumTransformation",void 0),u([ut("datumTransformation")],ot.prototype,"castDatumTransformation",null),u([d({type:Number,json:{write:{overridePolicy:t=>({enabled:t>0})}}})],ot.prototype,"distance",void 0),u([d({type:na,json:{write:!0}})],ot.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],ot.prototype,"formatOf3DObjects",void 0),u([d({type:String,json:{write:!0}})],ot.prototype,"gdbVersion",void 0),u([d({types:Og,json:{read:Lp,write:!0}})],ot.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],ot.prototype,"geometryPrecision",void 0),u([d({type:[String],json:{write:!0}})],ot.prototype,"groupByFieldsForStatistics",void 0),u([d({type:String,json:{write:!0}})],ot.prototype,"having",void 0),u([d({type:Date})],ot.prototype,"historicMoment",void 0),u([Ee("historicMoment")],ot.prototype,"writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],ot.prototype,"maxAllowableOffset",void 0),u([d({type:Number,cast:t=>t<1?1:t>s_.MAX_MAX_RECORD_COUNT_FACTOR?s_.MAX_MAX_RECORD_COUNT_FACTOR:t,json:{write:{overridePolicy:t=>({enabled:t>1})}}})],ot.prototype,"maxRecordCountFactor",void 0),u([d({type:["xyFootprint"],json:{write:!0}})],ot.prototype,"multipatchOption",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],ot.prototype,"num",void 0),u([d({json:{write:!0}})],ot.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],ot.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],ot.prototype,"outFields",void 0),u([d({type:Ue,json:{name:"outSR",write:!0}})],ot.prototype,"outSpatialReference",void 0),u([d({type:[FX],json:{write:{enabled:!0,overridePolicy(){return{enabled:_(this.outStatistics)&&this.outStatistics.length>0}}}}})],ot.prototype,"outStatistics",void 0),u([d({json:{write:!0}})],ot.prototype,"parameterValues",void 0),u([Ee("parameterValues")],ot.prototype,"writeParameterValues",null),u([d({type:je,json:{write:!0}})],ot.prototype,"pixelSize",void 0),u([d({type:TPe,json:{write:!0}})],ot.prototype,"quantizationParameters",void 0),u([d({type:[Object],json:{write:!0}})],ot.prototype,"rangeValues",void 0),u([d({type:String,json:{read:{source:"relationParam"},write:{target:"relationParam",overridePolicy(){return{enabled:this.spatialRelationship==="relation"}}}}})],ot.prototype,"relationParameter",void 0),u([d({type:String,json:{write:!0}})],ot.prototype,"resultType",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],ot.prototype,"returnCentroid",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],ot.prototype,"returnDistinctValues",void 0),u([d({type:Boolean,json:{default:!0,write:!0}})],ot.prototype,"returnExceededLimitFeatures",void 0),u([d({type:Boolean,json:{write:!0}})],ot.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],ot.prototype,"returnQueryGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],ot.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],ot.prototype,"returnZ",void 0),u([d({type:Ue,json:{write:!0}})],ot.prototype,"sourceSpatialReference",void 0),u([Xe(CPe,{ignoreUnknown:!1,name:"spatialRel"})],ot.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],ot.prototype,"start",void 0),u([Ee("start"),Ee("num")],ot.prototype,"writeStart",null),u([d({type:String,json:{write:!0}})],ot.prototype,"sqlFormat",void 0),u([d({type:String,json:{write:!0}})],ot.prototype,"text",void 0),u([d({type:Su,json:{write:!0}})],ot.prototype,"timeExtent",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],ot.prototype,"timeReferenceUnknownClient",void 0),u([Xe(MPe,{ignoreUnknown:!1}),d({json:{write:{overridePolicy(t){return{enabled:t&&this.distance>0}}}}})],ot.prototype,"units",void 0),u([d({type:String,json:{write:{overridePolicy(t){return{enabled:t!=null||this.start>0}}}}})],ot.prototype,"where",void 0),u([Ee("where")],ot.prototype,"writeWhere",null),ot=s_=u([R("esri.rest.support.Query")],ot);const jn=ot;var Bk;let hr=Bk=class extends ge{constructor(t){super(t),this.dynamicDataSource=void 0,this.gdbVersion=null,this.geometryPrecision=void 0,this.historicMoment=null,this.maxAllowableOffset=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.relationshipId=void 0,this.start=void 0,this.num=void 0,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.where=null}_writeHistoricMoment(t,e){e.historicMoment=t&&t.getTime()}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10,this.start>0&&this.where==null&&(e.definitionExpression="1=1")}clone(){return new Bk(ie({dynamicDataSource:this.dynamicDataSource,gdbVersion:this.gdbVersion,geometryPrecision:this.geometryPrecision,historicMoment:this.historicMoment&&new Date(this.historicMoment.getTime()),maxAllowableOffset:this.maxAllowableOffset,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,relationshipId:this.relationshipId,start:this.start,num:this.num,returnGeometry:this.returnGeometry,where:this.where,returnZ:this.returnZ,returnM:this.returnM}))}};u([d({type:na,json:{write:!0}})],hr.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],hr.prototype,"gdbVersion",void 0),u([d({type:Number,json:{write:!0}})],hr.prototype,"geometryPrecision",void 0),u([d({type:Date})],hr.prototype,"historicMoment",void 0),u([Ee("historicMoment")],hr.prototype,"_writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],hr.prototype,"maxAllowableOffset",void 0),u([d({type:[Number],json:{write:!0}})],hr.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],hr.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],hr.prototype,"outFields",void 0),u([d({type:Ue,json:{read:{source:"outSR"},write:{target:"outSR"}}})],hr.prototype,"outSpatialReference",void 0),u([d({json:{write:!0}})],hr.prototype,"relationshipId",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],hr.prototype,"start",void 0),u([Ee("start"),Ee("num")],hr.prototype,"writeStart",null),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],hr.prototype,"num",void 0),u([d({json:{write:!0}})],hr.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],hr.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],hr.prototype,"returnZ",void 0),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],hr.prototype,"where",void 0),hr=Bk=u([R("esri.rest.support.RelationshipQuery")],hr),hr.from=Ni(hr);const Py=hr;function got(t){var e;const i=t.layer;return"floorInfo"in i&&(e=i.floorInfo)!=null&&e.floorField&&"floors"in t.view?LX(t.view.floors,i.floorInfo.floorField):null}function yot(t,e){var i;return"floorInfo"in e&&(i=e.floorInfo)!=null&&i.floorField?LX(t,e.floorInfo.floorField):null}function vot(t,e){const{definitionExpression:i}=e;return t?i?`(${i}) AND (${t})`:t:i}function LX(t,e){if(t==null||!t.length)return null;const i=t.filter(r=>r!=="").map(r=>`'${r}'`);return i.push("''"),`${e} IN (${i.join(",")}) OR ${e} IS NULL`}function PPe(t,e){return e?he(E({},e),{query:E(E({},t),e.query)}):{query:t}}function ss(t){return typeof t=="string"?ms(t):t}function kX(t,e,i){const r={};for(const s in t){if(s==="declaredClass")continue;const n=t[s];if(n!=null&&typeof n!="function")if(Array.isArray(n)){r[s]=[];for(let o=0;o<n.length;o++)r[s][o]=kX(n[o])}else if(typeof n=="object")if(n.toJSON){const o=n.toJSON(i&&i[s]);r[s]=e?o:JSON.stringify(o)}else r[s]=e?n:JSON.stringify(n);else r[s]=n}return r}function R2(t){const e={};for(const i in t){if(i==="declaredClass")continue;const r=t[i];if(r!=null&&typeof r!="function")if(Array.isArray(r)){e[i]=[];for(let s=0;s<r.length;s++)e[i][s]=R2(r[s])}else typeof r=="object"?r.toJSON&&(e[i]=JSON.stringify(r)):e[i]=r}return e}function APe(t){const e=t.toJSON();return e.attachmentTypes&&(e.attachmentTypes=e.attachmentTypes.join(",")),e.keywords&&(e.keywords=e.keywords.join(",")),e.globalIds&&(e.globalIds=e.globalIds.join(",")),e.objectIds&&(e.objectIds=e.objectIds.join(",")),e.size&&(e.size=e.size.join(",")),e}function $Pe(t,e){const i={};for(const r of t){const{parentObjectId:s,parentGlobalId:n,attachmentInfos:o}=r;for(const a of o){const{id:l}=a,c=zve(l1e(`${e}/${s}/attachments/${l}`)),h=sX.fromJSON(a);h.set({url:c,parentObjectId:s,parentGlobalId:n}),i[s]?i[s].push(h):i[s]=[h]}}return i}function EPe(t,e,i){let r={query:R2(E(he(E({},t.query),{f:"json"}),APe(e)))};return i&&(r=he(E(E({},i),r),{query:E(E({},i.query),r.query)})),vt(t.path+"/queryAttachments",r)}async function OPe(t,e,i){const r=ss(t);return EPe(r,EA.from(e),E({},i)).then(s=>$Pe(s.data.attachmentGroups,r.path))}const VA={102100:{maxX:20037508342788905e-9,minX:-20037508342788905e-9,plus180Line:new Jo({paths:[[[20037508342788905e-9,-20037508342788905e-9],[20037508342788905e-9,20037508342788905e-9]]],spatialReference:Ue.WebMercator}),minus180Line:new Jo({paths:[[[-20037508342788905e-9,-20037508342788905e-9],[-20037508342788905e-9,20037508342788905e-9]]],spatialReference:Ue.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new Jo({paths:[[[180,-180],[180,180]]],spatialReference:Ue.WGS84}),minus180Line:new Jo({paths:[[[-180,-180],[-180,180]]],spatialReference:Ue.WGS84})}};function Ay(t,e){return Math.ceil((t-e)/(2*e))}function zX(t,e){const i=I2(t);for(const r of i)for(const s of r)s[0]+=e;return t}function I2(t){return Eg(t)?t.rings:t.paths}async function RPe(t,e,i,r){const s=typeof t=="string"?ms(t):t,n=e[0].spatialReference,o=he(E({},r),{query:he(E({},s.query),{f:"json",sr:JSON.stringify(n),target:JSON.stringify({geometryType:kp(e[0]),geometries:e}),cutter:JSON.stringify(i)})}),a=await vt(s.path+"/cut",o),{cutIndexes:l,geometries:c=[]}=a.data;return{cutIndexes:l,geometries:c.map(h=>{const p=Lp(h);return p.spatialReference=n,p})}}async function IPe(t,e,i){const r=typeof t=="string"?ms(t):t,s=e[0].spatialReference,n=kp(e[0]),o=he(E({},i),{query:he(E({},r.query),{f:"json",sr:s.wkid?s.wkid:JSON.stringify(s),geometries:JSON.stringify(DPe(e))})});return FPe((await vt(r.path+"/simplify",o)).data,n,s)}function DPe(t){return{geometryType:kp(t[0]),geometries:t.map(e=>e.toJSON())}}function FPe(t,e,i){const r=rW(e);return t.map(s=>{const n=r.fromJSON(s);return n.spatialReference=i,n})}const LPe=le.getLogger("esri.geometry.support.normalizeUtils");function kPe(t){return t.type==="polygon"}function zPe(t){return t[0].type==="polygon"}function VPe(t){return t[0].type==="polyline"}function NPe(t,e){if(!(t instanceof Jo||t instanceof Zo)){const s="straightLineDensify: the input geometry is neither polyline nor polygon";throw LPe.error(s),new Q(s)}const i=I2(t),r=[];for(const s of i){const n=[];r.push(n),n.push([s[0][0],s[0][1]]);for(let o=0;o<s.length-1;o++){const a=s[o][0],l=s[o][1],c=s[o+1][0],h=s[o+1][1],p=Math.sqrt((c-a)*(c-a)+(h-l)*(h-l)),f=(h-l)/p,g=(c-a)/p,y=p/e;if(y>1){for(let S=1;S<=y-1;S++){const T=S*e,C=g*T+a,M=f*T+l;n.push([C,M])}const v=(p+Math.floor(y-1)*e)/2,b=g*v+a,w=f*v+l;n.push([b,w])}n.push([c,h])}}return kPe(t)?new Zo({rings:r,spatialReference:t.spatialReference}):new Jo({paths:r,spatialReference:t.spatialReference})}function VX(t,e,i){if(e){const r=NPe(t,1e6);t=lx(r,!0)}return i&&(t=zX(t,i)),t}function NX(t,e,i){if(Array.isArray(t)){const r=t[0];if(r>e){const s=Ay(r,e);t[0]=r+s*(-2*e)}else if(r<i){const s=Ay(r,i);t[0]=r+s*(-2*i)}}else{const r=t.x;if(r>e){const s=Ay(r,e);t=t.clone().offset(s*(-2*e),0)}else if(r<i){const s=Ay(r,i);t=t.clone().offset(s*(-2*i),0)}}return t}function UPe(t,e){let i=-1;for(let r=0;r<e.cutIndexes.length;r++){const s=e.cutIndexes[r],n=e.geometries[r],o=I2(n);for(let a=0;a<o.length;a++){const l=o[a];l.some(c=>{if(c[0]<180)return!0;{let h=0;for(let f=0;f<l.length;f++){const g=l[f][0];h=g>h?g:h}h=Number(h.toFixed(9));const p=-360*Ay(h,180);for(let f=0;f<l.length;f++){const g=n.getPoint(a,f);n.setPoint(a,f,g.clone().offset(p,0))}return!0}})}if(s===i){if(zPe(t))for(const a of I2(n))t[s]=t[s].addRing(a);else if(VPe(t))for(const a of I2(n))t[s]=t[s].addPath(a)}else i=s,t[s]=n}return t}async function NA(t,e,i){var r;if(!Array.isArray(t))return NA([t],e);const s=(r=e==null?void 0:e.url)!=null?r:ei.geometryServiceUrl;let n,o,a,l,c,h,p,f,g=0;const y=[],v=[];for(const M of t)if(A(M))v.push(M);else if(n||(n=M.spatialReference,o=Pp(n),a=n.isWebMercator,h=a?102100:4326,l=VA[h].maxX,c=VA[h].minX,p=VA[h].plus180Line,f=VA[h].minus180Line),o)if(M.type==="mesh")v.push(M);else if(M.type==="point")v.push(NX(M.clone(),l,c));else if(M.type==="multipoint"){const P=M.clone();P.points=P.points.map(F=>NX(F,l,c)),v.push(P)}else if(M.type==="extent"){const P=M.clone()._normalize(!1,!1,o);v.push(P.rings?new Zo(P):P)}else if(M.extent){const P=M.extent,F=Ay(P.xmin,c)*(2*l);let z=F===0?M.clone():zX(M.clone(),F);P.offset(F,0),P.intersects(p)&&P.xmax!==l?(g=P.xmax>g?P.xmax:g,z=VX(z,a),y.push(z),v.push("cut")):P.intersects(f)&&P.xmin!==c?(g=P.xmax*(2*l)>g?P.xmax*(2*l):g,z=VX(z,a,360),y.push(z),v.push("cut")):v.push(z)}else v.push(M.clone());else v.push(M);let b=Ay(g,l),w=-90;const S=b,T=new Jo;for(;b>0;){const M=360*b-180;T.addPath([[M,w],[M,-1*w]]),w*=-1,b--}if(y.length>0&&S>0){const M=UPe(y,await RPe(s,y,T,i)),P=[],F=[];for(let U=0;U<v.length;U++){const G=v[U];if(G!=="cut")F.push(G);else{const k=M.shift(),j=t[U];_(j)&&j.type==="polygon"&&j.rings&&j.rings.length>1&&k.rings.length>=j.rings.length?(P.push(k),F.push("simplify")):F.push(a?Ih(k):k)}}if(!P.length)return F;const z=await IPe(s,P,i),D=[];for(let U=0;U<F.length;U++){const G=F[U];G!=="simplify"?D.push(G):D.push(a?Ih(z.shift()):z.shift())}return D}const C=[];for(let M=0;M<v.length;M++){const P=v[M];if(P!=="cut")C.push(P);else{const F=y.shift();C.push(a===!0?Ih(F):F)}}return Promise.resolve(C)}const UX={mapserver:"MapServer",imageserver:"ImageServer",featureserver:"FeatureServer",sceneserver:"SceneServer",streamserver:"StreamServer",vectortileserver:"VectorTileServer"},jX=Object.values(UX),BX=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/rest\\/services\\/(.+?)\\/(${jX.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),jPe=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/([^\\/\\n]+)\\/(${jX.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),BPe=/(.*?)\/(?:layers\/)?(\d+)\/?$/i;function _ot(t){return!!BX.test(t)}function D2(t){const e=ms(t),i=e.path.match(BX)||e.path.match(jPe);if(!i)return null;const[,r,s,n,o]=i,a=s.indexOf("/");return{title:Gk(a!==-1?s.slice(a+1):s),serverType:UX[n.toLowerCase()],sublayer:o!=null&&o!==""?parseInt(o,10):null,url:{path:r}}}function GPe(t){const e=ms(t).path.match(BPe);return e?{serviceUrl:e[1],sublayerId:Number(e[2])}:null}function Gk(t){return(t=t.replace(/\s*[/_]+\s*/g," "))[0].toUpperCase()+t.slice(1)}function qPe(t,e){const i=[];if(t){const r=D2(t);_(r)&&r.title&&i.push(r.title)}if(e){const r=Gk(e);i.push(r)}if(i.length===2){if(i[0].toLowerCase().indexOf(i[1].toLowerCase())!==-1)return i[0];if(i[1].toLowerCase().indexOf(i[0].toLowerCase())!==-1)return i[1]}return i.join(" - ")}function HPe(t){if(!t)return!1;const e=".arcgis.com/",i="//services",r="//tiles",s="//features",n=(t=t.toLowerCase()).indexOf(e)!==-1,o=t.indexOf(i)!==-1||t.indexOf(r)!==-1||t.indexOf(s)!==-1;return n&&o}function WPe(t,e){return t&&_q(bq(t,e))}function ZPe(t){let{url:e}=t;if(!e)return{url:e};e=bq(e,t.logger);const i=ms(e),r=D2(i.path);let s;if(_(r))r.sublayer!=null&&t.layer.layerId==null&&(s=r.sublayer),e=r.url.path;else if(t.nonStandardUrlAllowed){const n=GPe(i.path);_(n)&&(e=n.serviceUrl,s=n.sublayerId)}return{url:_q(e),layerId:s}}function JPe(t,e,i,r,s){qp(e,r,"url",s),r.url&&t.layerId!=null&&(r.url=Mp(r.url,i,t.layerId.toString()))}function bot(t){if(!t)return!1;const e=t.toLowerCase(),i=e.indexOf("/services/")!==-1,r=e.indexOf("/mapserver/wmsserver")!==-1,s=e.indexOf("/imageserver/wmsserver")!==-1,n=e.indexOf("/wmsserver")!==-1;return i&&(r||s||n)}const GX=4294967296,qX=ae("esri-text-decoder")?new TextDecoder("utf-8"):null,QPe=ae("safari")||ae("ios")?6:ae("ff")?12:32;class $y{constructor(e,i,r=0,s=e?e.byteLength:0){this._tag=0,this._dataType=99,this.init(e,i,r,s)}init(e,i,r,s){this._data=e,this._dataView=i,this._pos=r,this._end=s}clone(){return new $y(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(e){this._pos=e}nextTag(e){for(;;){if(this._pos===this._end)return!1;const i=this._decodeVarint();if(this._tag=i>>3,this._dataType=7&i,!e||e===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const e=this._decodeVarint();return this._tag=e>>3,this._dataType=7&e,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let e=4294967295;return e=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128?e:(e=(e|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128?e:void 0))))}getUInt64(){return this._decodeVarint()}getSInt32(){const e=this.getUInt32();return e>>>1^-(1&e)|0}getSInt64(){return this._decodeSVarint()}getBool(){const e=this._data[this._pos]!==0;return this._skip(1),e}getEnum(){return this._decodeVarint()}getFixed64(){const e=this._dataView,i=this._pos,r=e.getUint32(i,!0)+e.getUint32(i+4,!0)*GX;return this._skip(8),r}getSFixed64(){const e=this._dataView,i=this._pos,r=e.getUint32(i,!0)+e.getInt32(i+4,!0)*GX;return this._skip(8),r}getDouble(){const e=this._dataView.getFloat64(this._pos,!0);return this._skip(8),e}getFixed32(){const e=this._dataView.getUint32(this._pos,!0);return this._skip(4),e}getSFixed32(){const e=this._dataView.getInt32(this._pos,!0);return this._skip(4),e}getFloat(){const e=this._dataView.getFloat32(this._pos,!0);return this._skip(4),e}getString(){const e=this._getLength(),i=this._pos,r=this._toString(this._data,i,i+e);return this._skip(e),r}getBytes(){const e=this._getLength(),i=this._pos,r=this._toBytes(this._data,i,i+e);return this._skip(e),r}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(e,i,r,s){const n=this.getMessage(),o=e(n,i,r,s);return n.release(),o}processMessage(e){const i=this.getMessage(),r=e(i);return i.release(),r}getMessage(){const e=this._getLength(),i=$y.pool.acquire();return i.init(this._data,this._dataView,this._pos,this._pos+e),this._skip(e),i}release(){$y.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case 0:this._decodeVarint();break;case 1:this._skip(8);break;case 2:this._skip(this._getLength());break;case 5:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(e){this._skip(e)}_skip(e){if(this._pos+e>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=e}_decodeVarint(){const e=this._data;let i,r=this._pos,s=0;if(this._end-r>=10)do{if(i=e[r++],s|=127&i,(128&i)==0||(i=e[r++],s|=(127&i)<<7,(128&i)==0)||(i=e[r++],s|=(127&i)<<14,(128&i)==0)||(i=e[r++],s|=(127&i)<<21,(128&i)==0)||(i=e[r++],s+=268435456*(127&i),(128&i)==0)||(i=e[r++],s+=34359738368*(127&i),(128&i)==0)||(i=e[r++],s+=4398046511104*(127&i),(128&i)==0)||(i=e[r++],s+=562949953421312*(127&i),(128&i)==0)||(i=e[r++],s+=72057594037927940*(127&i),(128&i)==0)||(i=e[r++],s+=9223372036854776e3*(127&i),(128&i)==0))break;throw new Error("Varint too long!")}while(0);else{let n=1;for(;r!==this._end&&(i=e[r],(128&i)!=0);)++r,s+=(127&i)*n,n*=128;if(r===this._end)throw new Error("Varint overrun!");++r,s+=i*n}return this._pos=r,s}_decodeSVarint(){const e=this._decodeVarint();return e%2?-(e+1)/2:e/2}_getLength(){if(this._dataType!==2)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(e,i,r){if((r=Math.min(this._end,r))-i>QPe&&qX){const o=e.subarray(i,r);return qX.decode(o)}let s="",n="";for(let o=i;o<r;++o){const a=e[o];128&a?n+="%"+a.toString(16):(s+=decodeURIComponent(n)+String.fromCharCode(a),n="")}return n.length&&(s+=decodeURIComponent(n)),s}_toBytes(e,i,r){return r=Math.min(this._end,r),new Uint8Array(e.buffer,i,r-i)}}$y.pool=new Xi($y,null,t=>{t._data=null,t._dataView=null});class xo{constructor(e=[],i=[],r=!1){this.lengths=e!=null?e:[],this.coords=i!=null?i:[],this.hasIndeterminateRingOrder=r}get isPoint(){return this.lengths.length===0}get maxLength(){return Math.max(...this.lengths)}get size(){return this.lengths.reduce((e,i)=>e+i)}forEachVertex(e){let i=0;this.lengths.length||e(this.coords[0],this.coords[1]);for(let r=0;r<this.lengths.length;r++){const s=this.lengths[r];for(let n=0;n<s;n++)e(this.coords[2*(n+i)],this.coords[2*(n+i)+1]);i+=s}}clone(e){return e?(e.set(this.coords),new xo(this.lengths.slice(),e,this.hasIndeterminateRingOrder)):new xo(this.lengths.slice(),this.coords.slice(),this.hasIndeterminateRingOrder)}}class Tu{constructor(e=null,i={},r,s){this.geometry=e,this.attributes=i,this.centroid=r,this.objectId=s,this.displayId=0,this.geohashX=0,this.geohashY=0}weakClone(){const e=new Tu(this.geometry,this.attributes,this.centroid,this.objectId);return e.displayId=this.displayId,e.geohashX=this.geohashX,e.geohashY=this.geohashY,e}}function YPe(t){return!(A(t.geometry)||!t.geometry.coords||!t.geometry.coords.length)}class wot extends Tu{}class UA{constructor(){this.objectIdFieldName=null,this.globalIdFieldName=null,this.geohashFieldName=null,this.geometryProperties=null,this.geometryType=null,this.spatialReference=null,this.hasZ=!1,this.hasM=!1,this.features=[],this.fields=[],this.transform=null,this.exceededTransferLimit=!1,this.uniqueIdField=null,this.queryGeometryType=null,this.queryGeometry=null}weakClone(){const e=new UA;return e.objectIdFieldName=this.objectIdFieldName,e.globalIdFieldName=this.globalIdFieldName,e.geohashFieldName=this.geohashFieldName,e.geometryProperties=this.geometryProperties,e.geometryType=this.geometryType,e.spatialReference=this.spatialReference,e.hasZ=this.hasZ,e.hasM=this.hasM,e.features=this.features,e.fields=this.fields,e.transform=this.transform,e.exceededTransferLimit=this.exceededTransferLimit,e.uniqueIdField=this.uniqueIdField,e.queryGeometry=this.queryGeometry,e.queryGeometryType=this.queryGeometryType,e}}const HX=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"];class xot{constructor(e){this.options=e,this.geometryTypes=HX,this._coordinatePtr=0,this._vertexDimension=0}createFeatureResult(){return new UA}prepareFeatures(e){this._vertexDimension=2,e.hasZ&&this._vertexDimension++,e.hasM&&this._vertexDimension++}finishFeatureResult(e){if(!e||!e.features||!e.hasZ||!this.options.sourceSpatialReference||!e.spatialReference||Da(e.spatialReference,this.options.sourceSpatialReference)||e.spatialReference.vcsWkid)return;const i=A1(this.options.sourceSpatialReference)/A1(e.spatialReference);if(i!==1)for(const r of e.features){if(!YPe(r))continue;const s=r.geometry.coords;for(let n=2;n<s.length;n+=3)s[n]*=i}}addFeature(e,i){e.features.push(i)}createFeature(){return new Tu}createSpatialReference(){return{wkid:0}}createGeometry(){return new xo}addField(e,i){e.fields.push(i)}allocateCoordinates(e){e.coords.length=e.lengths.reduce((i,r)=>i+r,0)*this._vertexDimension,this._coordinatePtr=0}addCoordinate(e,i){e.coords[this._coordinatePtr++]=i}addCoordinatePoint(e,i){e.coords.push(i)}addLength(e,i){e.lengths.push(i)}addQueryGeometry(e,i){e.queryGeometry=i.queryGeometry,e.queryGeometryType=i.queryGeometryType}createPointGeometry(){return new xo}}const WX=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],ZX=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],JX=["upperLeft","lowerLeft"];function QX(t){return t>=WX.length?null:WX[t]}function XPe(t){return t>=ZX.length?null:ZX[t]}function YX(t){return t>=JX.length?null:JX[t]}function XX(t,e){return e>=t.geometryTypes.length?null:t.geometryTypes[e]}function KPe(t,e,i){const r=3,s=e.createPointGeometry(i);for(;t.next();)switch(t.tag()){case r:{const n=t.getUInt32(),o=t.pos()+n;let a=0;for(;t.pos()<o;)e.addCoordinatePoint(s,t.getSInt64(),a++);break}default:t.skip()}return s}function eAe(t,e,i){const r=2,s=3,n=e.createGeometry(i),o=2+(i.hasZ?1:0)+(i.hasM?1:0);for(;t.next();)switch(t.tag()){case r:{const a=t.getUInt32(),l=t.pos()+a;let c=0;for(;t.pos()<l;)e.addLength(n,t.getUInt32(),c++);break}case s:{const a=t.getUInt32(),l=t.pos()+a;let c=0;for(e.allocateCoordinates(n);t.pos()<l;)e.addCoordinate(n,t.getSInt64(),c),c++,c===o&&(c=0);break}default:t.skip()}return n}function tAe(t){const e=1,i=2,r=3,s=new xo;let n="esriGeometryPoint";for(;t.next();)switch(t.tag()){case i:{const o=t.getUInt32(),a=t.pos()+o;for(;t.pos()<a;)s.lengths.push(t.getUInt32());break}case r:{const o=t.getUInt32(),a=t.pos()+o;for(;t.pos()<a;)s.coords.push(t.getSInt64());break}case e:n=HX[t.getEnum()];break;default:t.skip()}return{queryGeometry:s,queryGeometryType:n}}function iAe(t){const e=1,i=2,r=3,s=4,n=5,o=6,a=7,l=8,c=9;for(;t.next();)switch(t.tag()){case e:return t.getString();case i:return t.getFloat();case r:return t.getDouble();case s:return t.getSInt32();case n:return t.getUInt32();case o:return t.getInt64();case a:return t.getUInt64();case l:return t.getSInt64();case c:return t.getBool();default:return t.skip(),null}return null}function rAe(t){const e=1,i=2,r=3,s=4,n=5,o=6,a={type:QX(0)};for(;t.next();)switch(t.tag()){case e:a.name=t.getString();break;case i:a.type=QX(t.getEnum());break;case r:a.alias=t.getString();break;case s:a.sqlType=XPe(t.getEnum());break;case n:t.skip();break;case o:a.defaultValue=t.getString();break;default:t.skip()}return a}function sAe(t){const e=1,i=2,r={};for(;t.next();)switch(t.tag()){case e:r.name=t.getString();break;case i:r.isSystemMaintained=t.getBool();break;default:t.skip()}return r}function nAe(t,e,i,r){const s=1,n=2,o=4,a=e.createFeature(i);let l=0;for(;t.next();)switch(t.tag()){case s:{const c=r[l++].name;a.attributes[c]=t.processMessage(iAe);break}case n:a.geometry=t.processMessageWithArgs(eAe,e,i);break;case o:a.centroid=t.processMessageWithArgs(KPe,e,i);break;default:t.skip()}return a}function oAe(t){const e=1,i=2,r=3,s=4,n=[1,1,1,1];for(;t.next();)switch(t.tag()){case e:n[0]=t.getDouble();break;case i:n[1]=t.getDouble();break;case s:n[2]=t.getDouble();break;case r:n[3]=t.getDouble();break;default:t.skip()}return n}function aAe(t){const e=1,i=2,r=3,s=4,n=[0,0,0,0];for(;t.next();)switch(t.tag()){case e:n[0]=t.getDouble();break;case i:n[1]=t.getDouble();break;case s:n[2]=t.getDouble();break;case r:n[3]=t.getDouble();break;default:t.skip()}return n}function lAe(t){const e=1,i=2,r=3,s={originPosition:YX(0)};for(;t.next();)switch(t.tag()){case e:s.originPosition=YX(t.getEnum());break;case i:s.scale=t.processMessage(oAe);break;case r:s.translate=t.processMessage(aAe);break;default:t.skip()}return s}function cAe(t){const e=1,i=2,r=3,s={};for(;t.next();)switch(t.tag()){case e:s.shapeAreaFieldName=t.getString();break;case i:s.shapeLengthFieldName=t.getString();break;case r:s.units=t.getString();break;default:t.skip()}return s}function uAe(t,e){const i=1,r=2,s=3,n=4,o=5,a=e.createSpatialReference();for(;t.next();)switch(t.tag()){case i:a.wkid=t.getUInt32();break;case o:a.wkt=t.getString();break;case r:a.latestWkid=t.getUInt32();break;case s:a.vcsWkid=t.getUInt32();break;case n:a.latestVcsWkid=t.getUInt32();break;default:t.skip()}return a}function hAe(t,e){const i=1,r=2,s=3,n=4,o=5,a=7,l=8,c=9,h=10,p=11,f=12,g=13,y=15,v=e.createFeatureResult();v.geometryType=XX(e,0);let b=!1;for(;t.next();)switch(t.tag()){case i:v.objectIdFieldName=t.getString();break;case s:v.globalIdFieldName=t.getString();break;case n:v.geohashFieldName=t.getString();break;case o:v.geometryProperties=t.processMessage(cAe);break;case a:v.geometryType=XX(e,t.getEnum());break;case l:v.spatialReference=t.processMessageWithArgs(uAe,e);break;case h:v.hasZ=t.getBool();break;case p:v.hasM=t.getBool();break;case f:v.transform=t.processMessage(lAe);break;case c:{const w=t.getBool();v.exceededTransferLimit=w;break}case g:e.addField(v,t.processMessage(rAe));break;case y:b||(e.prepareFeatures(v),b=!0),e.addFeature(v,t.processMessageWithArgs(nAe,e,v,v.fields));break;case r:v.uniqueIdField=t.processMessage(sAe);break;default:t.skip()}return e.finishFeatureResult(v),v}function dAe(t,e){const i=1,r=4,s={};let n=null;for(;t.next();)switch(t.tag()){case r:n=t.processMessageWithArgs(tAe);break;case i:s.featureResult=t.processMessageWithArgs(hAe,e);break;default:t.skip()}return _(n)&&s.featureResult&&e.addQueryGeometry(s,n),s}function pAe(t,e){try{const i=2,r=new $y(new Uint8Array(t),new DataView(t)),s={};for(;r.next();)r.tag()===i?s.queryResult=r.processMessageWithArgs(dAe,e):r.skip();return s}catch(i){throw new Q("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:i})}}function fAe(t,e){const i=pAe(t,e),r=i.queryResult.featureResult,s=i.queryResult.queryGeometry,n=i.queryResult.queryGeometryType;if(r&&r.features&&r.features.length&&r.objectIdFieldName){const o=r.objectIdFieldName;for(const a of r.features)a.attributes&&(a.objectId=a.attributes[o])}return r&&(r.queryGeometry=s,r.queryGeometryType=n),r}function jA(t,e,i){if(!i||!i.features||!i.hasZ)return;const r=o6(i.geometryType,e,t.outSpatialReference);if(!A(r))for(const s of i.features)r(s.geometry)}const KX="Layer does not support extent calculation.";function eK(t,e,i=!1){const r=t.geometry,s=t.toJSON(),n=s,o=t.outSpatialReference;let a,l;if(_(r)){if(a=r.spatialReference,l=r.spatialReference.wkid||JSON.stringify(r.spatialReference),n.geometryType=kp(r),i&&r.type==="extent")n.geometry=`${r.xmin},${r.ymin},${r.xmax},${r.ymax}`;else if(i&&r.type==="point")n.geometry=`${r.x},${r.y}`;else{const c=r.toJSON();delete c.spatialReference,n.geometry=JSON.stringify(c)}n.inSR=l}if(a||(a=o),s.groupByFieldsForStatistics&&(n.groupByFieldsForStatistics=s.groupByFieldsForStatistics.join(",")),s.objectIds&&(n.objectIds=s.objectIds.join(",")),s.orderByFields&&(n.orderByFields=s.orderByFields.join(",")),!s.outFields||!s.returnDistinctValues&&(e!=null&&e.returnCountOnly||e!=null&&e.returnExtentOnly||e!=null&&e.returnIdsOnly)?delete n.outFields:s.outFields.indexOf("*")!==-1?n.outFields="*":n.outFields=s.outFields.join(","),s.outSR?n.outSR=s.outSR.wkid||JSON.stringify(s.outSR):r&&(s.returnGeometry||s.returnCentroid)&&(n.outSR=n.inSR),s.returnGeometry&&delete s.returnGeometry,s.outStatistics&&(n.outStatistics=JSON.stringify(s.outStatistics)),s.pixelSize&&(n.pixelSize=JSON.stringify(s.pixelSize)),s.quantizationParameters&&(i&&_(a)&&_(t.quantizationParameters)&&_(t.quantizationParameters.extent)&&a.equals(t.quantizationParameters.extent.spatialReference)&&delete s.quantizationParameters.extent.spatialReference,n.quantizationParameters=JSON.stringify(s.quantizationParameters)),s.parameterValues&&(n.parameterValues=JSON.stringify(s.parameterValues)),s.rangeValues&&(n.rangeValues=JSON.stringify(s.rangeValues)),s.dynamicDataSource&&(n.layer=JSON.stringify({source:s.dynamicDataSource}),delete s.dynamicDataSource),s.timeExtent){const c=s.timeExtent,{start:h,end:p}=c;h==null&&p==null||(n.time=h===p?h:`${h==null?"null":h},${p==null?"null":p}`),delete s.timeExtent}return n}async function tK(t,e,i,r){const s=_(e.timeExtent)&&e.timeExtent.isEmpty?{data:{features:[]}}:await n_(t,e,"json",r);return jA(e,i,s.data),s}async function iK(t,e,i,r){if(_(e.timeExtent)&&e.timeExtent.isEmpty)return Promise.resolve({data:i.createFeatureResult()});const s=await rK(t,e,r),n=s;return n.data=fAe(s.data,i),n}function rK(t,e,i){return n_(t,e,"pbf",i)}function sK(t,e,i){return _(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):n_(t,e,"json",i,{returnIdsOnly:!0})}function nK(t,e,i){return _(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):n_(t,e,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}function oK(t,e,i){return _(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):n_(t,e,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}).then(r=>{const s=r.data;if(s.hasOwnProperty("extent"))return r;if(s.features)throw new Error(KX);if(s.hasOwnProperty("count"))throw new Error(KX);return r})}function n_(t,e,i,r={},s={}){const n=typeof t=="string"?ms(t):t,o=e.geometry?[e.geometry]:[];return r.responseType=i==="pbf"?"array-buffer":"json",NA(o,null,r).then(a=>{const l=a&&a[0];_(l)&&((e=e.clone()).geometry=l);const c=HPe(n.path),h=R2(E(E(he(E({},n.query),{f:i}),s),eK(e,s,c)));return vt(Mp(n.path,"query"),he(E({},r),{query:E(E({},h),r.query)}))})}var Sot=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",executeQuery:tK,executeQueryForCount:nK,executeQueryForExtent:oK,executeQueryForIds:sK,executeQueryPBF:iK,executeQueryPBFBuffer:rK,queryToQueryStringParameters:eK,runQuery:n_});async function mAe(t,e,i){const r=ss(t);return nK(r,jn.from(e),E({},i)).then(s=>s.data.count)}async function gAe(t,e,i){const r=ss(t);return oK(r,jn.from(e),E({},i)).then(s=>({count:s.data.count,extent:ht.fromJSON(s.data.extent)}))}async function yAe(t,e,i){const r=ss(t);return sK(r,jn.from(e),E({},i)).then(s=>s.data.objectIds)}const qk=new wt({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh","":null});let _s=class extends ge{constructor(t){super(t),this.displayFieldName=null,this.exceededTransferLimit=!1,this.features=[],this.fields=null,this.geometryType=null,this.hasM=!1,this.hasZ=!1,this.queryGeometry=null,this.spatialReference=null}readFeatures(t,e){const i=Ue.fromJSON(e.spatialReference),r=[];for(let s=0;s<t.length;s++){const n=t[s],o=pn.fromJSON(n),a=n.geometry&&n.geometry.spatialReference;_(o.geometry)&&!a&&(o.geometry.spatialReference=i),r.push(o)}return r}writeGeometryType(t,e,i,r){if(t)return void qk.write(t,e,i,r);const{features:s}=this;if(s){for(const n of s)if(n&&_(n.geometry))return void qk.write(n.geometry.type,e,i,r)}}readQueryGeometry(t,e){if(!t)return null;const i=!!t.spatialReference,r=Lp(t);return!i&&e.spatialReference&&(r.spatialReference=Ue.fromJSON(e.spatialReference)),r}writeSpatialReference(t,e){if(t)return void(e.spatialReference=t.toJSON());const{features:i}=this;if(i){for(const r of i)if(r&&_(r.geometry)&&r.geometry.spatialReference)return void(e.spatialReference=r.geometry.spatialReference.toJSON())}}toJSON(t){const e=this.write();if(e.features&&Array.isArray(t)&&t.length>0)for(let i=0;i<e.features.length;i++){const r=e.features[i];if(r.geometry){const s=t&&t[i];r.geometry=s&&s.toJSON()||r.geometry}}return e}quantize(t){const{scale:[e,i],translate:[r,s]}=t,n=c=>Math.round((c-r)/e),o=c=>Math.round((s-c)/i),a=this.features,l=this._getQuantizationFunction(this.geometryType,n,o);for(let c=0,h=a.length;c<h;c++)l(at(a[c].geometry))||(a.splice(c,1),c--,h--);return this.transform=t,this}unquantize(){const{geometryType:t,features:e,transform:i}=this;if(!i)return this;const{translate:[r,s],scale:[n,o]}=i,a=h=>h*n+r,l=h=>s-h*o,c=this._getHydrationFunction(t,a,l);for(const{geometry:h}of e)_(h)&&c(h);return this.transform=null,this}_quantizePoints(t,e,i){let r,s;const n=[];for(let o=0,a=t.length;o<a;o++){const l=t[o];if(o>0){const c=e(l[0]),h=i(l[1]);c===r&&h===s||(n.push([c-r,h-s]),r=c,s=h)}else r=e(l[0]),s=i(l[1]),n.push([r,s])}return n.length>0?n:null}_getQuantizationFunction(t,e,i){return t==="point"?r=>(r.x=e(r.x),r.y=i(r.y),r):t==="polyline"||t==="polygon"?r=>{const s=Eg(r)?r.rings:r.paths,n=[];for(let o=0,a=s.length;o<a;o++){const l=s[o],c=this._quantizePoints(l,e,i);c&&n.push(c)}return n.length>0?(Eg(r)?r.rings=n:r.paths=n,r):null}:t==="multipoint"?r=>{const s=this._quantizePoints(r.points,e,i);return s.length>0?(r.points=s,r):null}:t==="extent"?r=>r:null}_getHydrationFunction(t,e,i){return t==="point"?r=>{r.x=e(r.x),r.y=i(r.y)}:t==="polyline"||t==="polygon"?r=>{const s=Eg(r)?r.rings:r.paths;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];for(let h=0,p=c.length;h<p;h++){const f=c[h];h>0?(n+=f[0],o+=f[1]):(n=f[0],o=f[1]),f[0]=e(n),f[1]=i(o)}}}:t==="extent"?r=>{r.xmin=e(r.xmin),r.ymin=i(r.ymin),r.xmax=e(r.xmax),r.ymax=i(r.ymax)}:t==="multipoint"?r=>{const s=r.points;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];a>0?(n+=c[0],o+=c[1]):(n=c[0],o=c[1]),c[0]=e(n),c[1]=i(o)}}:void 0}};u([d({type:String,json:{write:!0}})],_s.prototype,"displayFieldName",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],_s.prototype,"exceededTransferLimit",void 0),u([d({type:[pn],json:{write:!0}})],_s.prototype,"features",void 0),u([Ce("features")],_s.prototype,"readFeatures",null),u([d({type:[t_],json:{write:!0}})],_s.prototype,"fields",void 0),u([d({type:["point","multipoint","polyline","polygon","extent","mesh"],json:{read:{reader:qk.read}}})],_s.prototype,"geometryType",void 0),u([Ee("geometryType")],_s.prototype,"writeGeometryType",null),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],_s.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],_s.prototype,"hasZ",void 0),u([d({types:Og,json:{write:!0}})],_s.prototype,"queryGeometry",void 0),u([Ce("queryGeometry")],_s.prototype,"readQueryGeometry",null),u([d({type:Ue,json:{write:!0}})],_s.prototype,"spatialReference",void 0),u([Ee("spatialReference")],_s.prototype,"writeSpatialReference",null),u([d({json:{write:!0}})],_s.prototype,"transform",void 0),_s=u([R("esri.rest.support.FeatureSet")],_s),_s.prototype.toJSON.isDefaultToJSON=!0;const Cu=_s;var Tot=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Cu});async function Cot(t,e,i){const r=await aK(t,e,i);return Cu.fromJSON(r)}async function aK(t,e,i){const r=ss(t),s=E({},i),n=jn.from(e),{data:o}=await tK(r,n,n.sourceSpatialReference,s);return o}function Hs(t,e){return t?e?4:3:e?3:2}const F2=le.getLogger("esri.tasks.support.optimizedFeatureSet"),lK={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},cK=(t,e,i,r,s,n)=>{t[i]=s,t[i+1]=n},BA=(t,e,i,r,s,n)=>{t[i]=s,t[i+1]=n,t[i+2]=e[r+2]},vAe=(t,e,i,r,s,n)=>{t[i]=s,t[i+1]=n,t[i+2]=e[r+3]},uK=(t,e,i,r,s,n)=>{t[i]=s,t[i+1]=n,t[i+2]=e[r+2],t[i+3]=e[r+3]};function Hk(t,e,i,r){if(t){if(i)return e&&r?uK:BA;if(e&&r)return vAe}else if(e&&r)return BA;return cK}function Wk({scale:t,translate:e},i){return Math.round((i-e[0])/t[0])}function Zk({scale:t,translate:e},i){return Math.round((e[1]-i)/t[1])}function hK({scale:t,translate:e},i){return i*t[0]+e[0]}function dK({scale:t,translate:e},i){return e[1]-i*t[1]}function Mot(t,e,i){return t?e?i?Yk(t):Jk(t):i?Qk(t):GA(t):null}function GA(t){const e=t.coords;return{x:e[0],y:e[1]}}function pK(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t}function Jk(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2]}}function _Ae(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t}function Qk(t){const e=t.coords;return{x:e[0],y:e[1],m:e[2]}}function bAe(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.m,t}function Yk(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2],m:e[3]}}function wAe(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t.coords[3]=e.m,t}function xAe(t,e,i,r){let s=GA;i&&r?s=Yk:i?s=Jk:r&&(s=Qk);for(const n of e){const{geometry:o,attributes:a}=n,l=_(o)?s(o):null;t.push({attributes:a,geometry:l})}return t}function fK(t,e){return t&&e?wAe:t?_Ae:e?bAe:pK}function SAe(t,e,i,r,s){const n=fK(i,r);for(const o of e){const{geometry:a,attributes:l}=o;let c;a&&(c=n(new xo,a)),t.push(new Tu(c,l,null,l[s]))}return t}function TAe(t,e,i,r){for(const s of e){const{geometry:n,attributes:o}=s;let a;n&&(a=mK(n,i,r)),t.push({attributes:o,geometry:a})}return t}function mK(t,e,i){if(A(t))return null;const r=Hs(e,i),s=[];for(let n=0;n<t.coords.length;n+=r){const o=[];for(let a=0;a<r;a++)o.push(t.coords[n+a]);s.push(o)}return e?i?{points:s,hasZ:e,hasM:i}:{points:s,hasZ:e}:i?{points:s,hasM:i}:{points:s}}function CAe(t,e,i,r,s){const n=Hs(i,r);for(const o of e){const a=o.geometry,l=o.attributes;let c;a&&(c=gK(new xo,a,n)),t.push(new Tu(c,l,null,l[s]))}return t}function gK(t,e,i=Hs(e.hasZ,e.hasM)){t.lengths[0]=e.points.length;const r=t.coords;let s=0;for(const n of e.points)for(let o=0;o<i;o++)r[s++]=n[o];return t}function MAe(t,e,i,r){for(const s of e){const{geometry:n,attributes:o}=s;let a;_(n)&&(a=yK(n,i,r)),t.push({attributes:o,geometry:a})}return t}function yK(t,e,i){if(!t)return null;const r=Hs(e,i),{coords:s,lengths:n}=t,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<r;f++)p.push(s[a++]);c.push(p)}o.push(c)}return e?i?{paths:o,hasZ:e,hasM:i}:{paths:o,hasZ:e}:i?{paths:o,hasM:i}:{paths:o}}function PAe(t,e,i,r,s){const n=Hs(i,r);for(const o of e){const a=o.geometry,l=o.attributes;let c;a&&(c=vK(new xo,a,n)),t.push(new Tu(c,l,null,l[s]))}return t}function vK(t,e,i=Hs(e.hasZ,e.hasM)){const{lengths:r,coords:s}=t;let n=0;for(const o of e.paths){for(const a of o)for(let l=0;l<i;l++)s[n++]=a[l];r.push(o.length)}return t}function AAe(t,e,i,r){for(const s of e){const{geometry:n,attributes:o,centroid:a}=s;let l;if(_(n)&&(l=_K(n,i,r)),a){const c=GA(a);t.push({attributes:o,centroid:c,geometry:l})}else t.push({attributes:o,geometry:l})}return t}function _K(t,e,i){if(!t)return null;const r=Hs(e,i),{coords:s,lengths:n}=t,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<r;f++)p.push(s[a++]);c.push(p)}o.push(c)}return e?i?{rings:o,hasZ:e,hasM:i}:{rings:o,hasZ:e}:i?{rings:o,hasM:i}:{rings:o}}function $Ae(t,e,i,r,s){for(const n of e){const o=n.geometry,a=n.centroid,l=n.attributes;let c;o&&(c=bK(new xo,o,i,r)),_(a)?t.push(new Tu(c,l,pK(new xo,a),l[s])):t.push(new Tu(c,l,null,l[s]))}return t}function bK(t,e,i=e.hasZ,r=e.hasM){return EAe(t,e.rings,i,r),t}function EAe(t,e,i,r){const s=Hs(i,r),{lengths:n,coords:o}=t;let a=0;n.length=o.length=0;for(const l of e){for(const c of l)for(let h=0;h<s;h++)o[a++]=c[h];n.push(l.length)}return t}const o_=[],L2=[];function Pot(t,e,i,r,s){o_[0]=t;const[n]=wK(L2,o_,e,i,r,s);return o_.length=L2.length=0,n}function wK(t,e,i,r,s,n){if(t.length=0,!i){for(const o of e){const a=o.attributes[n];t.push(new Tu(null,o.attributes,null,a))}return t}switch(i){case"esriGeometryPoint":return SAe(t,e,r,s,n);case"esriGeometryMultipoint":return CAe(t,e,r,s,n);case"esriGeometryPolyline":return PAe(t,e,r,s,n);case"esriGeometryPolygon":return $Ae(t,e,r,s,n);default:F2.error("convertToFeatureSet:unknown-geometry",new Q(`Unable to parse unknown geometry type '${i}'`)),t.length=0}return t}function Aot(t,e,i,r){L2[0]=t,SK(o_,L2,e,i,r);const s=o_[0];return o_.length=L2.length=0,s}function OAe(t,e,i){if(A(t))return null;const r=new xo;return"hasZ"in t&&e==null&&(e=t.hasZ),"hasM"in t&&i==null&&(i=t.hasM),JF(t)?fK(e!=null?e:t.z!=null,i!=null?i:t.m!=null)(r,t):Eg(t)?bK(r,t,e,i):QF(t)?vK(r,t,Hs(e,i)):ZF(t)?gK(r,t,Hs(e,i)):void F2.error("convertFromGeometry:unknown-geometry",new Q(`Unable to parse unknown geometry type '${t}'`))}function xK(t,e,i,r){const s=t&&("coords"in t?t:t.geometry);if(A(s))return null;switch(e){case"esriGeometryPoint":{let n=GA;return i&&r?n=Yk:i?n=Jk:r&&(n=Qk),n(s)}case"esriGeometryMultipoint":return mK(s,i,r);case"esriGeometryPolyline":return yK(s,i,r);case"esriGeometryPolygon":return _K(s,i,r);default:return void F2.error("convertToGeometry:unknown-geometry",new Q(`Unable to parse unknown geometry type '${e}'`))}}function RAe(t,e){for(const i of e)t.push({attributes:i.attributes});return t}function SK(t,e,i,r,s){if(t.length=0,A(i))return RAe(t,e);switch(i){case"esriGeometryPoint":return xAe(t,e,r,s);case"esriGeometryMultipoint":return TAe(t,e,r,s);case"esriGeometryPolyline":return MAe(t,e,r,s);case"esriGeometryPolygon":return AAe(t,e,r,s);default:F2.error("convertToFeatureSet:unknown-geometry",new Q(`Unable to parse unknown geometry type '${i}'`))}return t}function $ot(t){const{objectIdFieldName:e,spatialReference:i,transform:r,fields:s,hasM:n,hasZ:o,features:a,geometryType:l,exceededTransferLimit:c,uniqueIdField:h,queryGeometry:p,queryGeometryType:f}=t,g={features:SK([],a,l,o,n),fields:s,geometryType:l,objectIdFieldName:e,spatialReference:i,uniqueIdField:h,queryGeometry:xK(p,f,!1,!1)};return r&&(g.transform=r),c&&(g.exceededTransferLimit=c),n&&(g.hasM=n),o&&(g.hasZ=o),g}function Eot(t,e){const i=new UA,{hasM:r,hasZ:s,features:n,objectIdFieldName:o,spatialReference:a,geometryType:l,exceededTransferLimit:c,transform:h,fields:p}=t;return p&&(i.fields=p),i.geometryType=l,i.objectIdFieldName=o||e,i.spatialReference=a,i.objectIdFieldName?(n&&wK(i.features,n,l,s,r,i.objectIdFieldName),c&&(i.exceededTransferLimit=c),r&&(i.hasM=r),s&&(i.hasZ=s),h&&(i.transform=h),i):(F2.error(new Q("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),i)}function Oot(t){const{transform:e,features:i,hasM:r,hasZ:s}=t;if(!e)return t;for(const n of i)_(n.geometry)&&Kk(n.geometry,n.geometry,r,s,e),n.centroid&&Kk(n.centroid,n.centroid,r,s,e);return t.transform=null,t}function Rot(t,e){const{geometryType:i,features:r,hasM:s,hasZ:n}=e;if(!t)return e;for(let o=0;o<r.length;o++){const a=r[o],l=a.weakClone();l.geometry=new xo,TK(l.geometry,a.geometry,s,n,i,t),a.centroid&&(l.centroid=new xo,TK(l.centroid,a.centroid,s,n,"esriGeometryPoint",t)),r[o]=l}return e.transform=t,e}function TK(t,e,i,r,s,n,o=i,a=r){if(t.lengths.length&&(t.lengths.length=0),t.coords.length&&(t.coords.length=0),A(e)||!e.coords.length)return null;const l=lK[s],{coords:c,lengths:h}=e,p=Hs(i,r),f=Hs(i&&o,r&&a),g=Hk(i,r,o,a);if(!h.length)return g(t.coords,c,0,0,Wk(n,c[0]),Zk(n,c[1])),t.lengths.length&&(t.lengths.length=0),t.coords.length=p,t;let y,v,b,w,S=0,T=0,C=T;for(const M of h){if(M<l)continue;let P=0;T=C,b=y=Wk(n,c[S]),w=v=Zk(n,c[S+1]),g(t.coords,c,T,S,b,w),P++,S+=p,T+=f;for(let F=1;F<M;F++,S+=p)b=Wk(n,c[S]),w=Zk(n,c[S+1]),b===y&&w===v||(g(t.coords,c,T,S,b-y,w-v),T+=f,P++,y=b,v=w);P>=l&&(t.lengths.push(P),C=T)}return t.coords.length=C,t.coords.length?t:null}function Iot(t,e,i,r,s,n,o=i,a=r){if(t.lengths.length&&(t.lengths.length=0),t.coords.length&&(t.coords.length=0),!e||!e.coords.length)return null;const l=lK[s],{coords:c,lengths:h}=e,p=Hs(i,r),f=Hs(i&&o,r&&a),g=Hk(i,r,o,a);if(!h.length)return g(t.coords,c,0,0,c[0],c[1]),t.lengths.length&&(t.lengths.length=0),t.coords.length=p,t;let y=0;const v=n*n;for(const b of h){if(b<l){y+=b*p;continue}const w=t.coords.length/f,S=y,T=y+(b-1)*p;g(t.coords,c,t.coords.length,S,c[S],c[S+1]),Xk(t.coords,c,p,v,g,S,T),g(t.coords,c,t.coords.length,T,c[T],c[T+1]);const C=t.coords.length/f-w;C>=l?t.lengths.push(C):t.coords.length=w*f,y+=b*p}return t.coords.length?t:null}function IAe(t,e,i,r){const s=t[e],n=t[e+1],o=t[i],a=t[i+1],l=t[r],c=t[r+1];let h=o,p=a,f=l-h,g=c-p;if(f!==0||g!==0){const y=((s-h)*f+(n-p)*g)/(f*f+g*g);y>1?(h=l,p=c):y>0&&(h+=f*y,p+=g*y)}return f=s-h,g=n-p,f*f+g*g}function Xk(t,e,i,r,s,n,o){let a,l=r,c=0;for(let h=n+i;h<o;h+=i)a=IAe(e,h,n,o),a>l&&(c=h,l=a);l>r&&(c-n>i&&Xk(t,e,i,r,s,n,c),s(t,e,t.length,c,e[c],e[c+1]),o-c>i&&Xk(t,e,i,r,s,c,o))}function Dot(t,e,i,r){if(A(e)||!e.coords||!e.coords.length)return null;const s=Hs(i,r);let n=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(e&&e.coords){const c=e.coords;for(let h=0;h<c.length;h+=s){const p=c[h],f=c[h+1];n=Math.min(n,p),a=Math.max(a,p),o=Math.min(o,f),l=Math.max(l,f)}}return t[0]=n,t[1]=o,t[2]=a,t[3]=l,t}function Kk(t,e,i,r,s){const{coords:n,lengths:o}=e,a=i?r?uK:BA:r?BA:cK,l=Hs(i,r);if(!n.length)return t!==e&&(t.lengths.length=0,t.coords.length=0),t;if(!o.length)return a(t.coords,n,0,0,hK(s,n[0]),dK(s,n[1])),t!==e&&(t.lengths.length=0,t.coords.length=l),t;const[c,h]=s.scale;let p=0;for(let f=0;f<o.length;f++){const g=o[f];t.lengths[f]=g;let y=hK(s,n[p]),v=dK(s,n[p+1]);a(t.coords,n,p,p,y,v),p+=l;for(let b=1;b<g;b++,p+=l)y+=n[p]*c,v-=n[p+1]*h,a(t.coords,n,p,p,y,v)}return t!==e&&(t.lengths.length=o.length,t.coords.length=n.length),t}function Fot(t,e,i,r,s,n){const o=Hs(i,r),a=Hk(i,r,s,n),l=e.coords;t.coords.length=0,t.lengths.length=0,t.lengths.push(...e.lengths);for(let c=0;c<l.length;c+=o)a(t.coords,l,t.coords.length,c,l[c],l[c+1]);return t}function DAe(t,e,i,r){let s=0,n=t[r*e],o=t[r*(e+1)];for(let a=1;a<i;a++){const l=n+t[r*(e+a)],c=o+t[r*(e+a)+1],h=(l-n)*(c+o);n=l,o=c,s+=h}return .5*s}function Lot(t,e){const{coords:i,lengths:r}=t;let s=0,n=0;for(let o=0;o<r.length;o++)n+=DAe(i,s,r[o],e),s+=o;return Math.abs(n)}function kot(t,e){if(A(t))return null;const i=t.clone(),r=t.coords,s=t.lengths;let n=0;for(let o=0;o<s.length;o++){const a=s[o];let l=r[e*n],c=r[e*n+1];for(let h=1;h<a;h++){const p=l+r[e*(n+h)],f=c+r[e*(n+h)+1];i.coords[e*(n+h)]=p,i.coords[e*(n+h)+1]=f,l=p,c=f}n+=a}return i}function FAe(t,e){return e}function ez(t,e,i,r){switch(i){case 0:return k2(t,e+r,0);case 1:return t.originPosition==="lowerLeft"?k2(t,e+r,1):zAe(t,e+r,1)}}function CK(t,e,i,r){return i===2?k2(t,e,2):ez(t,e,i,r)}function LAe(t,e,i,r){return i===2?k2(t,e,3):ez(t,e,i,r)}function kAe(t,e,i,r){return i===3?k2(t,e,3):CK(t,e,i,r)}function k2({translate:t,scale:e},i,r){return t[r]+i*e[r]}function zAe({translate:t,scale:e},i,r){return t[r]-i*e[r]}class VAe{constructor(e){this.options=e,this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"],this.previousCoordinate=[0,0],this.transform=null,this.applyTransform=FAe,this.lengths=[],this.currentLengthIndex=0,this.toAddInCurrentPath=0,this.vertexDimension=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,this.AttributesConstructor=function(){}}createFeatureResult(){return{fields:[],features:[]}}finishFeatureResult(e){if(this.options.applyTransform&&(e.transform=null),this.AttributesConstructor=function(){},this.coordinateBuffer=null,this.lengths.length=0,!e.hasZ)return;const i=o6(e.geometryType,this.options.sourceSpatialReference,e.spatialReference);if(!A(i))for(const r of e.features)i(r.geometry)}createSpatialReference(){return{}}addField(e,i){e.fields.push(i);const r=e.fields.map(s=>s.name);this.AttributesConstructor=function(){for(const s of r)this[s]=null}}addFeature(e,i){e.features.push(i)}prepareFeatures(e){switch(this.transform=e.transform,this.options.applyTransform&&e.transform&&(this.applyTransform=this.deriveApplyTransform(e)),this.vertexDimension=2,e.hasZ&&this.vertexDimension++,e.hasM&&this.vertexDimension++,e.geometryType){case"esriGeometryPoint":this.addCoordinate=(i,r,s)=>this.addCoordinatePoint(i,r,s),this.createGeometry=i=>this.createPointGeometry(i);break;case"esriGeometryPolygon":this.addCoordinate=(i,r,s)=>this.addCoordinatePolygon(i,r,s),this.createGeometry=i=>this.createPolygonGeometry(i);break;case"esriGeometryPolyline":this.addCoordinate=(i,r,s)=>this.addCoordinatePolyline(i,r,s),this.createGeometry=i=>this.createPolylineGeometry(i);break;case"esriGeometryMultipoint":this.addCoordinate=(i,r,s)=>this.addCoordinateMultipoint(i,r,s),this.createGeometry=i=>this.createMultipointGeometry(i);break;default:kn(e.geometryType)}}createFeature(){return this.lengths.length=0,this.currentLengthIndex=0,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,{attributes:new this.AttributesConstructor}}allocateCoordinates(){}addLength(e,i,r){this.lengths.length===0&&(this.toAddInCurrentPath=i),this.lengths.push(i)}addQueryGeometry(e,i){const{queryGeometry:r,queryGeometryType:s}=i,n=Kk(r.clone(),r,!1,!1,this.transform),o=xK(n,s,!1,!1);e.queryGeometryType=s,e.queryGeometry=E({},o)}createPointGeometry(e){const i={x:0,y:0,spatialReference:e.spatialReference};return e.hasZ&&(i.z=0),e.hasM&&(i.m=0),i}addCoordinatePoint(e,i,r){switch(i=this.applyTransform(this.transform,i,r,0),r){case 0:e.x=i;break;case 1:e.y=i;break;case 2:"z"in e?e.z=i:e.m=i;break;case 3:e.m=i}}transformPathLikeValue(e,i){let r=0;return i<=1&&(r=this.previousCoordinate[i],this.previousCoordinate[i]+=e),this.applyTransform(this.transform,e,i,r)}addCoordinatePolyline(e,i,r){this.dehydratedAddPointsCoordinate(e.paths,i,r)}addCoordinatePolygon(e,i,r){this.dehydratedAddPointsCoordinate(e.rings,i,r)}addCoordinateMultipoint(e,i,r){r===0&&e.points.push([]);const s=this.transformPathLikeValue(i,r);e.points[e.points.length-1].push(s)}createPolygonGeometry(e){return{rings:[[]],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}}createPolylineGeometry(e){return{paths:[[]],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}}createMultipointGeometry(e){return{points:[],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}}dehydratedAddPointsCoordinate(e,i,r){r===0&&this.toAddInCurrentPath--==0&&(e.push([]),this.toAddInCurrentPath=this.lengths[++this.currentLengthIndex]-1,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0);const s=this.transformPathLikeValue(i,r),n=e[e.length-1];r===0&&(this.coordinateBufferPtr=0,this.coordinateBuffer=new Array(this.vertexDimension),n.push(this.coordinateBuffer)),this.coordinateBuffer[this.coordinateBufferPtr++]=s}deriveApplyTransform(e){const{hasZ:i,hasM:r}=e;return i&&r?kAe:i?CK:r?LAe:ez}}async function NAe(t,e,i){const r=ss(t),s=E({},i),n=jn.from(e),o=!n.quantizationParameters,{data:a}=await iK(r,n,new VAe({sourceSpatialReference:n.sourceSpatialReference,applyTransform:o}),s);return a}function UAe(t,e){const i=t.toJSON();return i.objectIds&&(i.objectIds=i.objectIds.join(",")),i.orderByFields&&(i.orderByFields=i.orderByFields.join(",")),!i.outFields||e!=null&&e.returnCountOnly?delete i.outFields:i.outFields.indexOf("*")!==-1?i.outFields="*":i.outFields=i.outFields.join(","),i.outSpatialReference&&(i.outSR=i.outSR.wkid||JSON.stringify(i.outSR.toJSON()),delete i.outSpatialReference),i.dynamicDataSource&&(i.layer=JSON.stringify({source:i.dynamicDataSource}),delete i.dynamicDataSource),i}async function jAe(t,e,i){const r=await MK(t,e,i),s=r.data,n=s.geometryType,o=s.spatialReference,a={};for(const l of s.relatedRecordGroups){const c={fields:void 0,objectIdFieldName:void 0,geometryType:n,spatialReference:o,hasZ:!!s.hasZ,hasM:!!s.hasM,features:l.relatedRecords};if(l.objectId!=null)a[l.objectId]=c;else for(const h in l)l.hasOwnProperty(h)&&h!=="relatedRecords"&&(a[l[h]]=c)}return he(E({},r),{data:a})}async function BAe(t,e,i){const r=await MK(t,e,i,{returnCountOnly:!0}),s=r.data,n={};for(const o of s.relatedRecordGroups)o.objectId!=null&&(n[o.objectId]=o.count);return he(E({},r),{data:n})}async function MK(t,e,i={},r){const s=R2(E(E(he(E({},t.query),{f:"json"}),r),UAe(e,r)));return vt(t.path+"/queryRelatedRecords",he(E({},i),{query:E(E({},i.query),s)}))}async function GAe(t,e,i){e=Py.from(e);const r=ss(t);return jAe(r,e,i).then(s=>{const n=s.data,o={};return Object.keys(n).forEach(a=>o[a]=Cu.fromJSON(n[a])),o})}async function qAe(t,e,i){e=Py.from(e);const r=ss(t);return BAe(r,e,E({},i)).then(s=>s.data)}const PK="Layer does not support extent calculation.";function HAe(t,e){var i,r;const s=t.geometry,n=t.toJSON(),o=n;if(_(s)&&(o.geometry=JSON.stringify(s),o.geometryType=kp(s),o.inSR=s.spatialReference.wkid||JSON.stringify(s.spatialReference)),(i=n.topFilter)!=null&&i.groupByFields&&(o.topFilter.groupByFields=n.topFilter.groupByFields.join(",")),(r=n.topFilter)!=null&&r.orderByFields&&(o.topFilter.orderByFields=n.topFilter.orderByFields.join(",")),n.topFilter&&(o.topFilter=JSON.stringify(o.topFilter)),n.objectIds&&(o.objectIds=n.objectIds.join(",")),n.orderByFields&&(o.orderByFields=n.orderByFields.join(",")),n.outFields&&!(e!=null&&e.returnCountOnly||e!=null&&e.returnExtentOnly||e!=null&&e.returnIdsOnly)?n.outFields.indexOf("*")!==-1?o.outFields="*":o.outFields=n.outFields.join(","):delete o.outFields,n.outSR?o.outSR=n.outSR.wkid||JSON.stringify(n.outSR):s&&n.returnGeometry&&(o.outSR=o.inSR),n.returnGeometry&&delete n.returnGeometry,n.timeExtent){const a=n.timeExtent,{start:l,end:c}=a;l==null&&c==null||(o.time=l===c?l:`${l==null?"null":l},${c==null?"null":c}`),delete n.timeExtent}return o}async function WAe(t,e,i,r){const s=await qA(t,e,"json",r);return jA(e,i,s.data),s}async function ZAe(t,e,i){return _(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):qA(t,e,"json",i,{returnIdsOnly:!0})}async function JAe(t,e,i){return _(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):qA(t,e,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}).then(r=>{const s=r.data;if(s.hasOwnProperty("extent"))return r;if(s.features)throw new Error(PK);if(s.hasOwnProperty("count"))throw new Error(PK);return r})}function QAe(t,e,i){return _(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):qA(t,e,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}function qA(t,e,i,r={},s={}){const n=typeof t=="string"?ms(t):t,o=e.geometry?[e.geometry]:[];return r.responseType=i==="pbf"?"array-buffer":"json",NA(o,null,r).then(a=>{const l=a&&a[0];_(l)&&((e=e.clone()).geometry=l);const c=R2(E(E(he(E({},n.query),{f:i}),s),HAe(e,s)));return vt(Mp(n.path,"queryTopFeatures"),he(E({},r),{query:E(E({},c),r.query)}))})}var tz;let a_=tz=class extends ge{constructor(t){super(t),this.groupByFields=void 0,this.topCount=void 0,this.orderByFields=void 0}clone(){return new tz({groupByFields:this.groupByFields,topCount:this.topCount,orderByFields:this.orderByFields})}};u([d({type:[String],json:{write:!0}})],a_.prototype,"groupByFields",void 0),u([d({type:Number,json:{write:!0}})],a_.prototype,"topCount",void 0),u([d({type:[String],json:{write:!0}})],a_.prototype,"orderByFields",void 0),a_=tz=u([R("esri.rest.support.TopFilter")],a_);const YAe=a_;var iz;const AK=new wt({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),$K=new wt({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let ki=iz=class extends ge{constructor(t){super(t),this.cacheHint=void 0,this.distance=void 0,this.geometry=null,this.geometryPrecision=void 0,this.maxAllowableOffset=void 0,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.resultType=null,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.start=void 0,this.spatialRelationship="intersects",this.timeExtent=null,this.topFilter=void 0,this.units=null,this.where="1=1"}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10}clone(){return new iz(ie({cacheHint:this.cacheHint,distance:this.distance,geometry:this.geometry,geometryPrecision:this.geometryPrecision,maxAllowableOffset:this.maxAllowableOffset,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,resultType:this.resultType,returnGeometry:this.returnGeometry,returnZ:this.returnZ,returnM:this.returnM,start:this.start,spatialRelationship:this.spatialRelationship,timeExtent:this.timeExtent,topFilter:this.topFilter,units:this.units,where:this.where}))}};u([d({type:Boolean,json:{write:!0}})],ki.prototype,"cacheHint",void 0),u([d({type:Number,json:{write:{overridePolicy:t=>({enabled:t>0})}}})],ki.prototype,"distance",void 0),u([d({types:Og,json:{read:Lp,write:!0}})],ki.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],ki.prototype,"geometryPrecision",void 0),u([d({type:Number,json:{write:!0}})],ki.prototype,"maxAllowableOffset",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],ki.prototype,"num",void 0),u([d({json:{write:!0}})],ki.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],ki.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],ki.prototype,"outFields",void 0),u([d({type:Ue,json:{read:{source:"outSR"},write:{target:"outSR"}}})],ki.prototype,"outSpatialReference",void 0),u([d({type:String,json:{write:!0}})],ki.prototype,"resultType",void 0),u([d({json:{write:!0}})],ki.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],ki.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],ki.prototype,"returnZ",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],ki.prototype,"start",void 0),u([Ee("start"),Ee("num")],ki.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"spatialRel",reader:AK.read},write:{target:"spatialRel",writer:AK.write}}})],ki.prototype,"spatialRelationship",void 0),u([d({type:Su,json:{write:!0}})],ki.prototype,"timeExtent",void 0),u([d({type:YAe,json:{write:!0}})],ki.prototype,"topFilter",void 0),u([d({type:String,json:{read:$K.read,write:{writer:$K.write,overridePolicy(t){return{enabled:t&&this.distance>0}}}}})],ki.prototype,"units",void 0),u([d({type:String,json:{write:!0}})],ki.prototype,"where",void 0),ki=iz=u([R("esri.rest.support.TopFeaturesQuery")],ki),ki.from=Ni(ki);const wf=ki;async function XAe(t,e,i,r){const s=ss(t),n=E({},r),{data:o}=await WAe(s,wf.from(e),i,n);return Cu.fromJSON(o)}async function KAe(t,e,i){const r=ss(t);return(await ZAe(r,wf.from(e),E({},i))).data.objectIds}async function e$e(t,e,i){const r=ss(t),s=await JAe(r,wf.from(e),E({},i));return{count:s.data.count,extent:ht.fromJSON(s.data.extent)}}async function t$e(t,e,i){const r=ss(t);return(await QAe(r,wf.from(e),E({},i))).data.count}let l_=class extends ve{constructor(...t){super(...t),this.requestOptions=null,this.url=null}normalizeCtorArgs(t,e){return typeof t!="string"?t:E({url:t},e)}get parsedUrl(){return this._parseUrl(this.url)}_parseUrl(t){return t?ms(t):null}_encode(t,e,i){const r={};for(const s in t){if(s==="declaredClass")continue;const n=t[s];if(n!=null&&typeof n!="function")if(Array.isArray(n)){r[s]=[];for(let o=0;o<n.length;o++)r[s][o]=this._encode(n[o])}else if(typeof n=="object")if(n.toJSON){const o=n.toJSON(i&&i[s]);r[s]=e?o:JSON.stringify(o)}else r[s]=e?n:JSON.stringify(n);else r[s]=n}return r}};u([d({readOnly:!0})],l_.prototype,"parsedUrl",null),u([d()],l_.prototype,"requestOptions",void 0),u([d({type:String})],l_.prototype,"url",void 0),l_=u([R("esri.tasks.Task")],l_);const EK=l_;let id=class extends EK{constructor(t){super(t),this.dynamicDataSource=null,this.fieldsIndex=null,this.format="json",this.gdbVersion=null,this.infoFor3D=null,this.sourceSpatialReference=null}execute(t,e){return this.executeJSON(t,e).then(i=>this.featureSetFromJSON(t,i,e))}async executeJSON(t,e){var i;const r=E(E({},this.requestOptions),e),s=this._normalizeQuery(t),n=((i=t.outStatistics)==null?void 0:i[0])!=null,o=ae("featurelayer-pbf-statistics"),a=!n||o;let l;if(this.format==="pbf"&&a)try{l=await NAe(this.url,s,r)}catch(c){if(c.name!=="query:parsing-pbf")throw c;this.format="json"}return this.format!=="json"&&a||(l=await aK(this.url,s,r)),this._normalizeFields(l.fields),l}async featureSetFromJSON(t,e,i){if(!(this._queryIs3DObjectFormat(t)&&_(this.infoFor3D)&&e.features&&e.features.length))return Cu.fromJSON(e);const{meshFeatureSetFromJSON:r}=await yD(import("./meshFeatureSet.5f145187.js"),i);return r(t,this.infoFor3D,e)}executeForCount(t,e){const i=E(E({},this.requestOptions),e),r=this._normalizeQuery(t);return mAe(this.url,r,i)}executeForExtent(t,e){const i=E(E({},this.requestOptions),e),r=this._normalizeQuery(t);return gAe(this.url,r,i)}executeForIds(t,e){const i=E(E({},this.requestOptions),e),r=this._normalizeQuery(t);return yAe(this.url,r,i)}executeRelationshipQuery(t,e){t=Py.from(t);const i=E(E({},this.requestOptions),e);return(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),GAe(this.url,t,i)}executeRelationshipQueryForCount(t,e){t=Py.from(t);const i=E(E({},this.requestOptions),e);return(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),qAe(this.url,t,i)}executeAttachmentQuery(t,e){const i=E(E({},this.requestOptions),e);return OPe(this.url,t,i)}executeTopFeaturesQuery(t,e){const i=E(E({},this.requestOptions),e);return XAe(this.parsedUrl,t,this.sourceSpatialReference,i)}executeForTopIds(t,e){const i=E(E({},this.requestOptions),e);return KAe(this.parsedUrl,t,i)}executeForTopExtents(t,e){const i=E(E({},this.requestOptions),e);return e$e(this.parsedUrl,t,i)}executeForTopCount(t,e){const i=E(E({},this.requestOptions),e);return t$e(this.parsedUrl,t,i)}_normalizeQuery(t){let e=jn.from(t);if(e.sourceSpatialReference=e.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(e=e===t?e.clone():e,e.gdbVersion=t.gdbVersion||this.gdbVersion,e.dynamicDataSource=t.dynamicDataSource?na.from(t.dynamicDataSource):this.dynamicDataSource),_(this.infoFor3D)&&this._queryIs3DObjectFormat(t)){e=e===t?e.clone():e,e.formatOf3DObjects=null;for(const i of this.infoFor3D.queryFormats){if(i.id==="3D_glb"){e.formatOf3DObjects=i.id;break}i.id!=="3D_gltf"||e.formatOf3DObjects||(e.formatOf3DObjects=i.id)}if(!e.formatOf3DObjects)throw new Q("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(A(e.outFields)||!e.outFields.includes("*")){e=e===t?e.clone():e,A(e.outFields)&&(e.outFields=[]);const{originX:i,originY:r,originZ:s,translationX:n,translationY:o,translationZ:a,scaleX:l,scaleY:c,scaleZ:h,rotationX:p,rotationY:f,rotationZ:g,rotationDeg:y}=this.infoFor3D.transformFieldRoles;e.outFields.push(i,r,s,n,o,a,l,c,h,p,f,g,y)}}return e}_normalizeFields(t){if(_(this.fieldsIndex)&&_(t))for(const e of t){const i=this.fieldsIndex.get(e.name);i&&Object.assign(e,i.toJSON())}}_queryIs3DObjectFormat(t){return _(this.infoFor3D)&&t.returnGeometry&&t.multipatchOption!=="xyFootprint"&&!t.outStatistics}};u([d({type:na})],id.prototype,"dynamicDataSource",void 0),u([d()],id.prototype,"fieldsIndex",void 0),u([d()],id.prototype,"format",void 0),u([d()],id.prototype,"gdbVersion",void 0),u([d()],id.prototype,"infoFor3D",void 0),u([d()],id.prototype,"sourceSpatialReference",void 0),id=u([R("esri.tasks.QueryTask")],id);const i$e=id,r$e="esri.widgets.Feature.support.relatedFeatureUtils",OK=le.getLogger(r$e),RK=new Map;function z2(t){if(!Kh(t))return null;const[e,i]=t.split("/").slice(1);return{layerId:e,fieldName:i}}function s$e(t,e){if(!e.relationships)return null;let i=null;const{relationships:r}=e;return r.some(s=>s.id===parseInt(t,10)&&(i=s,!0)),i}function n$e({originRelationship:t,relationships:e,layerId:i}){let r;return e&&e.some(s=>(`${s.relatedTableId}`===i&&s.id===t.id&&(r=s),!!r)),r}function o$e(t,e){const i=e.toLowerCase();for(const r in t)if(r.toLowerCase()===i)return t[r];return null}function a$e(t,e){const i=s$e(t,e);if(!i)return;const r=`${e.url}/${i.relatedTableId}`;return{url:r,queryTask:new i$e({url:r,sourceSpatialReference:e.spatialReference}),relation:i,relatedFields:[],outStatistics:[]}}function l$e(t,e){if(!e||!t)return;const{features:i,statsFeatures:r}=t,s=i&&i.value;e.relatedFeatures=s?s.features:[];const n=r&&r.value;e.relatedStatsFeatures=n?n.features:[]}function c$e(t,e,i,r){const s=new Py;return s.outFields=["*"],s.relationshipId=typeof e.id=="number"?e.id:parseInt(e.id,10),s.objectIds=[t.attributes[i.objectIdField]],i.queryRelatedFeatures(s,r)}function u$e(t,e,i){let r=0;const s=[];for(;r<e.length;)s.push(`${t} IN (${e.slice(r,i+r)})`),r+=i;return s.join(" OR ")}async function h$e(t,e,i,r){const s=i.layerId.toString(),{layerInfo:n,queryTask:o,relation:a,relatedFields:l,outStatistics:c}=e,h=n$e({originRelationship:a,relationships:n.relationships,layerId:s});if(h.relationshipTableId&&h.keyFieldInRelationshipTable){const f=(await c$e(t,h,i,r))[t.attributes[i.objectIdField]];if(!f)return null;const g=f.features.map(y=>y.attributes[n.objectIdField]);if((c==null?void 0:c.length)>0&&n.supportsStatistics){const y=new jn;y.where=u$e(n.objectIdField,g,1e3),y.outFields=l,y.outStatistics=c;const v={features:Promise.resolve(f),statsFeatures:o.execute(y)};return En(v)}}const p=h==null?void 0:h.keyField;if(p){const f=BM(g$e(n.fields,p)),g=o$e(t.attributes,a.keyField),y=f?`${p}=${g}`:`${p}='${g}'`,v=o.execute(new jn({where:y,outFields:e.relatedFields}),r),b=e.outStatistics&&e.outStatistics.length>0&&n.supportsStatistics?o.execute(new jn({where:y,outFields:e.relatedFields,outStatistics:e.outStatistics}),r):null,w={features:v};return b&&(w.statsFeatures=b),En(w)}return null}function d$e(t,e){return vt(t,{query:{f:"json"},signal:e&&e.signal})}function p$e({relatedInfos:t,layer:e},i){const r={};return t.forEach((s,n)=>{const{relation:o}=s;if(!o){const p=new Q("relation-required","A relation is required on a layer to retrieve related records.");throw OK.error(p),p}const{relatedTableId:a}=o;if(typeof a!="number"){const p=new Q("A related table ID is required on a layer to retrieve related records.");throw OK.error(p),p}const l=`${e.url}/${a}`,c=RK.get(l),h=c||d$e(l,i);c||RK.set(l,h),r[n]=h}),En(r)}function f$e({graphic:t,relatedInfos:e,layer:i},r){const s={};return e.forEach((n,o)=>{n.layerInfo&&(s[o]=h$e(t,n,i,r))}),En(s)}function m$e({relatedInfo:t,fieldName:e,fieldInfo:i}){if(t.relatedFields.push(e),i.statisticType){const r=new FX({statisticType:i.statisticType,onStatisticField:e,outStatisticFieldName:e});t.outStatistics.push(r)}}function g$e(t,e){if(t!=null){e=e.toLowerCase();for(const i of t)if(i&&i.name.toLowerCase()===e)return i}return null}let Ws=class extends ve{constructor(t){super(t),this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,i=(t+e)%e;this.activeMediaInfoIndex=i}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,i=e+t;this._setContentElementMedia(i)}_formatMediaInfos(){const{attributes:t,mediaInfos:e,formattedAttributes:i,expressionAttributes:r,fieldInfoMap:s,layer:n}=this;return e==null?void 0:e.map(o=>{const a=o==null?void 0:o.clone();if(!a)return null;if(a.title=Sy({attributes:t,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.title}),a.caption=Sy({attributes:t,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.caption}),a.altText=Sy({attributes:t,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.altText}),a.type==="image"){const{value:l}=a;return this._setImageValue({value:l,formattedAttributes:i,layer:n}),a.value.sourceURL?a:void 0}if(a.type==="pie-chart"||a.type==="line-chart"||a.type==="column-chart"||a.type==="bar-chart"){const{value:l}=a;return this._setChartValue({value:l,chartType:a.type,attributes:t,formattedAttributes:i,layer:n}),a}return null}).filter(Boolean)}_setImageValue(t){const{fieldInfoMap:e}=this,{value:i,formattedAttributes:r,layer:s}=t,{linkURL:n,sourceURL:o}=i;if(o){const a=gk(o,s);i.sourceURL=mk({formattedAttributes:r,template:a,fieldInfoMap:e})}if(n){const a=gk(n,s);i.linkURL=mk({formattedAttributes:r,template:a,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:i,formattedAttributes:r,chartType:s,layer:n}=t,{popupTemplate:o,relatedInfos:a}=this,{fields:l,normalizeField:c}=e;if(e.fields=RMe(l,n),c&&(e.normalizeField=RA(c,n)),!l.some(p=>!!(r[p]!=null||Kh(p)&&a.size)))return;const h=o==null?void 0:o.fieldInfos;l.forEach(p=>{if(Kh(p))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:h,fieldName:p,formattedAttributes:r,chartType:s,value:e})]);const f=this._getChartOption({value:e,attributes:i,chartType:s,formattedAttributes:r,fieldName:p,fieldInfos:h});e.series.push(f)})}_getRelatedChartInfos(t){var e;const{fieldInfos:i,fieldName:r,formattedAttributes:s,chartType:n,value:o}=t,a=[],l=z2(r),{layerId:c,fieldName:h}=l,p=(e=this.relatedInfos)==null?void 0:e.get(c.toString());if(!p)return a;const{relatedFeatures:f,relation:g}=p;if(!g||!f)return a;const{cardinality:y}=g;return f.forEach(v=>{const{attributes:b}=v;b&&Object.keys(b).forEach(w=>{w===h&&a.push(this._getChartOption({value:o,attributes:b,formattedAttributes:s,fieldName:r,chartType:n,relatedFieldName:w,fieldInfos:i}))})}),y==="one-to-many"||y==="many-to-many"?a:[a[0]]}_getTooltip({label:t,value:e,chartType:i}){return i==="pie-chart"?t:`${t}: ${e}`}_getChartOption(t){var e;const{value:i,attributes:r,formattedAttributes:s,fieldName:n,relatedFieldName:o,fieldInfos:a,chartType:l}=t,{layer:c}=this,{normalizeField:h,tooltipField:p}=i,f=h?Kh(h)?r[z2(h).fieldName]:r[h]:null,g=o&&r[o]!==void 0?r[o]:r[n]!==void 0?r[n]:s[n],y=g===void 0?null:g&&f?g/f:g,v=new SW({value:y});if(Kh(n)){const C=z2(n),M=z2(p),P=M?M.fieldName:null,F=pX(y,{fieldInfos:a,fieldName:o,layer:c,preventPlacesFormatting:!!f}),z=C?C.label||C.fieldName:o,D=P&&r[P]!==void 0?r[P]:z;return v.tooltip=this._getTooltip({label:D,value:F,chartType:l}),v}const b=fX(a,n),w=RA(n,c),S=p&&s[p]!==void 0?s[p]:hX(b||new Rx({fieldName:w}),(e=this.popupTemplate)==null?void 0:e.expressionInfos),T=s[w];return v.tooltip=this._getTooltip({label:S,value:T,chartType:l}),v}};u([d()],Ws.prototype,"activeMediaInfoIndex",void 0),u([d({readOnly:!0})],Ws.prototype,"activeMediaInfo",null),u([d()],Ws.prototype,"attributes",void 0),u([d()],Ws.prototype,"description",void 0),u([d()],Ws.prototype,"fieldInfoMap",void 0),u([d()],Ws.prototype,"formattedAttributes",void 0),u([d()],Ws.prototype,"expressionAttributes",void 0),u([d({readOnly:!0})],Ws.prototype,"formattedMediaInfos",null),u([d()],Ws.prototype,"layer",void 0),u([d({readOnly:!0})],Ws.prototype,"formattedMediaInfoCount",null),u([d()],Ws.prototype,"mediaInfos",void 0),u([d()],Ws.prototype,"popupTemplate",void 0),u([d()],Ws.prototype,"relatedInfos",void 0),u([d()],Ws.prototype,"title",void 0),Ws=u([R("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],Ws);const Ey=Ws;var IK=["#ffffff","#858585","#ffbebe","#ffebbe","#ffebaf","#ffffbe","#e9ffbe","#d3ffbe","#beffe8","#bee8ff","#bed2ff","#e8beff","#ffbee8","#ebebeb","#707070","#ff7f7f","#ffa77f","#ffd37f","#ffff73","#d1ff73","#a3ff73","#73ffdf","#73dfff","#73b2ff","#df73ff","#ff73df","#d6d6d6","#5c5c5c","#ff0000","#ff5500","#ffaa00","#ffff00","#aaff00","#55ff00","#00ffc5","#00c5ff","#0070ff","#c500ff","#ff00c5","#c2c2c2","#474747","#e60000","#e64c00","#e69800","#e6e600","#98e600","#4ce600","#00e6a9","#00a9e6","#005ce6","#a900e6","#e600a9","#adadad","#242424","#a80000","#a83800","#a87000","#a8a800","#70a800","#38a800","#00a884","#0084a8","#004da8","#8400a8","#a80084","#999999","#1a1a1a","#730000","#732600","#734c00","#737300","#4c7300","#267300","#00734c","#004c73","#002673","#4c0073","#73004"],y$e=[].concat(IK.slice(30,39),IK.slice(28,30).reverse()),v$e=[{name:"default",colors:y$e},{name:"cat-dark",colors:["#ed5151","#149ece","#a7c636","#9e559c","#fc921f","#ffde3e","#f789d8","#b7814a","#3caf99","#6b6bd6","#b54779","#7f7f7f"]},{name:"tropical-bliss",colors:["#fce138","#ff9399","#fcd27e","#f1983c","#a553b7","#b1a9d0","#6ecffc","#4c81cd","#fc6f84","#fc3e5a","#6af689","#48885c"]},{name:"desert-blooms",colors:["#102432","#144d59","#ffc730","#ed9310","#a64f1b","#661510","#d9351a","#b31515","#4a0932","#8c213f","#18382e","#2c6954"]},{name:"under-the-sea",colors:["#bf9727","#607100","#00734c","#704489","#01acca","#024e76","#f09100","#ea311f","#c6004b","#7570b3","#666666","#333333"]},{name:"vibrant-rainbow",colors:["#fffb00","#f5cb11","#9fd40c","#46e39c","#32b8a6","#7ff2fa","#ac08cc","#dd33ff","#eb7200","#e8a784","#bf2e2e","#6c7000"]},{name:"ocean-bay",colors:["#191921","#11495c","#78b1c2","#454f4b","#8f8f82","#9be0c0","#87b051","#f7ec88","#ebdcc1","#dbb658","#c43541","#75351e"]},{name:"prairie-summer",colors:["#332424","#751555","#d47013","#d68989","#211173","#82aad6","#7bfaeb","#6ec9a8","#6b6408","#eada40","#ccc54a","#1fc235"]},{name:"pastel-chalk",colors:["#fffd99","#f5e6a4","#c1d48c","#b8e3d0","#a0b8b5","#cbf7fa","#d791f2","#dfc1eb","#f2b983","#e8c4b2","#bf8e8e","#94995c"]},{name:"seq-yellow-orange-red-bright",colors:["#910000","#b1260b","#c0370f","#e05919","#ef6a1d","#ff7b22","#ffa143","#ffb454","#ffda74","#ffed85"]},{name:"seq-reds-bright",colors:["#57453b","#7b4238","#9f4036","#c23d33","#d7483c","#ec5244","#f3696c","#f9816c","#ffc4ae","#fff0dc"]},{name:"seq-purples-bright",colors:["#4e465c","#5a4a78","#695291","#775baa","#8663c3","#946bdc","#aa89e8","#c1a6f3","#d7c4ff","#e6e1ff"]},{name:"seq-blues-bright",colors:["#404d54","#435c6c","#48799d","#4b88b6","#4d96ce","#50a5e7","#74bbed","#98d0f3","#bce6f9","#e6faff"]},{name:"seq-greens-bright",colors:["#39544c","#386757","#368165","#359b73","#33b581","#4bc392","#64d2a2","#7ce0b3","#cbf6d9","#f4ffea"]},{name:"seq-browns-bright",colors:["#524834","#715b38","#8f6e3c","#ae8140","#cc9444","#eba748","#eeb664","#f0c47f","#f9e0b7","#fff8eb"]}];const DK="en-us",rz=new Map([["ar",()=>import("./ar.2aab08dd.js").then(t=>t.a)],["bg-bg",()=>import("./bg_BG.b814a1ac.js").then(t=>t.b)],["bs-ba",()=>import("./bs_BA.b36cdbe8.js").then(t=>t.b)],["ca-es",()=>import("./ca_ES.b2e66739.js").then(t=>t.c)],["cs-cz",()=>import("./cs_CZ.b348e786.js").then(t=>t.c)],["da-dk",()=>import("./da_DK.a9983cb5.js").then(t=>t.d)],["de-de",()=>import("./de_DE.f5c21793.js").then(t=>t.d)],["de-ch",()=>import("./de_CH.367d6186.js").then(t=>t.d)],["el-gr",()=>import("./el_GR.93c63da8.js").then(t=>t.e)],["en-us",()=>import("./en_US.94ffd6bf.js").then(t=>t.e)],["en-ca",()=>import("./en_CA.4a9a20c9.js").then(t=>t.e)],["es-es",()=>import("./es_ES.c1f238ad.js").then(t=>t.e)],["et-ee",()=>import("./et_EE.ab8b5c7e.js").then(t=>t.e)],["fi-fi",()=>import("./fi_FI.1ae4aba0.js").then(t=>t.f)],["fr-fr",()=>import("./fr_FR.c5170e72.js").then(t=>t.f)],["he-il",()=>import("./he_IL.70f08c13.js").then(t=>t.h)],["hr-hr",()=>import("./hr_HR.4ec47474.js").then(t=>t.h)],["hu-hu",()=>import("./hu_HU.67e7344c.js").then(t=>t.h)],["id-id",()=>import("./id_ID.5ebc9d3e.js").then(t=>t.i)],["it-it",()=>import("./it_IT.80fc4063.js").then(t=>t.i)],["ja-jp",()=>import("./ja_JP.aa21c5f2.js").then(t=>t.j)],["ko-kr",()=>import("./ko_KR.dd101165.js").then(t=>t.k)],["lt-lt",()=>import("./lt_LT.3a76834a.js").then(t=>t.l)],["lv-lv",()=>import("./lv_LV.588ac36f.js").then(t=>t.l)],["nb-no",()=>import("./nb_NO.360a7c86.js").then(t=>t.n)],["nl-nl",()=>import("./nl_NL.82b9b3fb.js").then(t=>t.n)],["pl-pl",()=>import("./pl_PL.13a1dd20.js").then(t=>t.p)],["pt-br",()=>import("./pt_BR.e98052aa.js").then(t=>t.p)],["pt-pt",()=>import("./pt_PT.ac201416.js").then(t=>t.p)],["ro-ro",()=>import("./ro_RO.79558846.js").then(t=>t.r)],["ru-ru",()=>import("./ru_RU.3d0da07d.js").then(t=>t.r)],["sk-sk",()=>import("./sk_SK.00b55fc5.js").then(t=>t.s)],["sl-sl",()=>import("./sl_SL.11eccaee.js").then(t=>t.s)],["sr-rs",()=>import("./sr_RS.6fc5c6c6.js").then(t=>t.s)],["sv-se",()=>import("./sv_SE.c30d188d.js").then(t=>t.s)],["th-th",()=>import("./th_TH.c18c2f94.js").then(t=>t.t)],["tr-tr",()=>import("./tr_TR.6f662bfc.js").then(t=>t.t)],["uk-ua",()=>import("./uk_UA.9032e489.js").then(t=>t.u)],["vi-vn",()=>import("./vi_VN.b86d38c9.js").then(t=>t.v)],["zh-cn",()=>import("./zh_Hans.c9aa9284.js").then(t=>t.z)],["zh-hk",()=>import("./zh_Hant.7dec10d9.js").then(t=>t.z)],["zh-tw",()=>import("./zh_Hant.7dec10d9.js").then(t=>t.z)]]);function _$e(t){const e=t.split("-")[0].toLowerCase();let i=null;for(const r of rz.keys())if(r.startsWith(e)){i=r;break}return i}function b$e(t){return t?rz.has(t.toLowerCase())?t.toLowerCase():_$e(t)||DK:DK}let c_,V2;async function w$e(t=La()){if(t=b$e(t),c_&&t===V2)return c_;c_=import("./index.69546dd0.js").then(e=>e.i),V2=t;try{const[e,i]=await Promise.all([c_,rz.get(V2)()]);V2===t&&(e.am4core.options.defaultLocale=i.default),e.am4core.options.suppressWarnings=!0,e.am4core.options.autoDispose=!0}catch{return c_=null,V2=null,null}return c_}function x$e(t,e="default"){const i=v$e.find(r=>r.name===e);return i?i.colors.map(r=>t.color(r)):null}const dr={base:"esri-feature-media",mediaContainer:"esri-feature-media__container",mediaItemContainer:"esri-feature-media__item-container",mediaItem:"esri-feature-media__item",mediaItemTitle:"esri-feature-media__item-title",mediaItemCaption:"esri-feature-media__item-caption",mediaPrevious:"esri-feature-media__previous",mediaPreviousIconLTR:"esri-feature-media__previous-icon",mediaPreviousIconRTL:"esri-feature-media__previous-icon--rtl",mediaNext:"esri-feature-media__next",mediaNextIconLTR:"esri-feature-media__next-icon",mediaNextIconRTL:"esri-feature-media__next-icon--rtl",mediaChart:"esri-feature-media__chart",mediaButton:"esri-feature-media__button",mediaIcon:"esri-feature-media__icon",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow"},sz=.05,nz=.95,oz=15;let So=class extends Bs{constructor(t,e){super(t,e),this._refreshTimer=null,this._refreshIntervalInfo=null,this._featureElementInfo=null,this.attributes=null,this.activeMediaInfoIndex=null,this.description=null,this.fieldInfoMap=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null,this.viewModel=new Ey,this.messages=null,this._getChartDependencies=async i=>{const r=await w$e(),{viewModel:s}=this;if(!s)return;const{activeMediaInfo:n}=s;this._renderChart({chartDiv:i,mediaInfo:n,chartsModule:r})}}initialize(){this._featureElementInfo=new Tk,this.own(Ke(this,["viewModel.activeMediaInfo","viewModel.activeMediaInfoIndex"],()=>this._setupMediaRefreshTimer()),Ke(this,["viewModel.description","viewModel.title"],()=>this._setupFeatureElementInfo()))}destroy(){this._clearMediaRefreshTimer(),this._featureElementInfo.destroy()}render(){var t;return ee("div",{bind:this,class:dr.base,onkeyup:this._handleMediaKeyup},(t=this._featureElementInfo)==null?void 0:t.render(),this.renderMedia())}renderMedia(){const{formattedMediaInfoCount:t}=this.viewModel;return t?ee("div",{key:"media-element-container",class:dr.mediaContainer},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null}renderImageMediaInfo(t){const{_refreshIntervalInfo:e}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:r}=this.viewModel,{value:s,refreshInterval:n,altText:o,title:a,type:l}=t,{sourceURL:c,linkURL:h}=s,p=cX(h)?"_blank":"_self",f=p==="_blank"?"noreferrer":"",g=n?e:null,y=g?g.timestamp:0,v=g?g.sourceURL:c,b=ee("img",{alt:o||a,key:`media-${l}-${i}-${r}-${y}`,src:v});return(h?ee("a",{title:a,href:h,rel:f,target:p},b):null)||b}renderChartMediaInfo(t){const{activeMediaInfoIndex:e,formattedMediaInfoCount:i}=this.viewModel;return ee("div",{key:`media-${t.type}-${e}-${i}`,bind:this,class:dr.mediaChart,afterCreate:this._getChartDependencies})}renderMediaInfoType(){const{activeMediaInfo:t}=this.viewModel;return t?t.type==="image"?this.renderImageMediaInfo(t):t.type.indexOf("chart")!==-1?this.renderChartMediaInfo(t):null:null}renderMediaInfo(){const{activeMediaInfo:t}=this.viewModel;if(!t)return null;const e=t.title?ee("div",{key:"media-title",class:dr.mediaItemTitle,innerHTML:t.title}):null,i=t.caption?ee("div",{key:"media-caption",class:dr.mediaItemCaption,innerHTML:t.caption}):null;return ee("div",{key:"media-container",class:dr.mediaItemContainer},ee("div",{key:"media-item-container",class:dr.mediaItem},this.renderMediaInfoType()),e,i)}renderMediaPageButton(t){if(this.viewModel.formattedMediaInfoCount<2)return null;const e=t==="previous",i=e?this.messages.previous:this.messages.next,r=e?this.classes(dr.mediaButton,dr.mediaPrevious):this.classes(dr.mediaButton,dr.mediaNext),s=e?this.classes(dr.mediaIcon,dr.mediaPreviousIconLTR,dr.iconLeftTriangleArrow):this.classes(dr.mediaIcon,dr.mediaNextIconLTR,dr.iconRightTriangleArrow),n=e?this.classes(dr.mediaIcon,dr.mediaPreviousIconRTL,dr.iconRightTriangleArrow):this.classes(dr.mediaIcon,dr.mediaNextIconRTL,dr.iconLeftTriangleArrow),o=e?"media-previous":"media-next",a=e?this._previous:this._next;return ee("button",{type:"button",key:o,title:i,"aria-label":i,tabIndex:0,class:r,bind:this,onclick:a},ee("span",{"aria-hidden":"true",class:s}),ee("span",{"aria-hidden":"true",class:n}))}_setupFeatureElementInfo(){const{description:t,title:e}=this;this._featureElementInfo.set({description:t,title:e})}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}_handleMediaKeyup(t){const e=Fl(t);e==="ArrowLeft"&&(t.stopPropagation(),this.viewModel.previous()),e==="ArrowRight"&&(t.stopPropagation(),this.viewModel.next())}_renderChart(t){const{chartsModule:e,chartDiv:i,mediaInfo:r}=t,{value:s,type:n}=r,{am4core:o}=e,a=x$e(o);function l(h){h instanceof o.ColorSet&&a&&(h.list=a)}oY()&&o.useTheme(e.am4themes_dark),o.useTheme(e.am4themes_animated),o.useTheme(l);const c=n==="pie-chart"?this._createPieChart(t):this._createXYChart(t);i.setAttribute("aria-label",r.altText||r.title),c.data=s.series.map(h=>({tooltip:h.tooltip,value:h.value})).filter(h=>n!=="pie-chart"||h.value>0)}_customizeChartTooltip(t,e){t.label.wrap=!0,t.label.maxWidth=200,t.autoTextColor=!1,t.getFillFromObject=!1,t.label.fill=e.color("#ffffff"),t.background.fill=e.color({r:0,g:0,b:0,a:.7})}_createPieChart(t){const{chartDiv:e,chartsModule:i}=t,{am4core:r,am4charts:s}=i,n=r.create(e,s.PieChart);n.rtl=yf(this.container);const o=n.series.push(new s.PieSeries);return o.labels.template.disabled=!0,o.ticks.template.disabled=!0,o.dataFields.value="value",o.dataFields.category="tooltip",this._customizeChartTooltip(o.tooltip,r),n}_getMinSeriesValue(t){let e=0;return t.forEach(i=>e=Math.min(i.value,e)),e}_createColumnChart(t,e){const{chartsModule:i,mediaInfo:r}=e,{value:s}=r,{am4core:n,am4charts:o}=i,a=t.xAxes.push(new o.CategoryAxis);a.dataFields.category="tooltip",a.renderer.labels.template.disabled=!0,this._customizeChartTooltip(a.tooltip,n),a.tooltip.events.on("sizechanged",()=>{a.tooltip.dy=-a.tooltip.contentHeight});const l=t.yAxes.push(new o.ValueAxis),c=l.renderer.labels.template;l.renderer.minLabelPosition=sz,l.renderer.maxLabelPosition=nz,l.min=this._getMinSeriesValue(s.series),this._customizeChartTooltip(l.tooltip,n),c.wrap=!0;const h=t.series.push(new o.ColumnSeries);h.dataFields.valueY="value",h.dataFields.categoryX="tooltip",t.cursor=new o.XYCursor,s.series.length>oz&&(t.scrollbarX=new n.Scrollbar)}_createBarChart(t,e){const{chartsModule:i,mediaInfo:r}=e,{value:s}=r,{am4core:n,am4charts:o}=i,a=t.yAxes.push(new o.CategoryAxis);a.dataFields.category="tooltip",a.renderer.inversed=!0,a.renderer.labels.template.disabled=!0,this._customizeChartTooltip(a.tooltip,n),a.tooltip.events.on("sizechanged",()=>{a.tooltip.dx=a.tooltip.contentWidth});const l=t.xAxes.push(new o.ValueAxis),c=l.renderer.labels.template;l.renderer.minLabelPosition=sz,l.renderer.maxLabelPosition=nz,l.min=this._getMinSeriesValue(s.series),this._customizeChartTooltip(l.tooltip,n),c.wrap=!0;const h=t.series.push(new o.ColumnSeries);h.dataFields.valueX="value",h.dataFields.categoryY="tooltip",t.cursor=new o.XYCursor,s.series.length>oz&&(t.scrollbarY=new n.Scrollbar)}_createLineChart(t,e){const{chartsModule:i,mediaInfo:r}=e,{value:s}=r,{am4core:n,am4charts:o}=i,a=t.xAxes.push(new o.CategoryAxis);a.dataFields.category="tooltip",a.renderer.labels.template.disabled=!0,this._customizeChartTooltip(a.tooltip,n),a.tooltip.events.on("sizechanged",()=>{a.tooltip.dy=-a.tooltip.contentHeight});const l=t.yAxes.push(new o.ValueAxis),c=l.renderer.labels.template;l.renderer.minLabelPosition=sz,l.renderer.maxLabelPosition=nz,l.min=this._getMinSeriesValue(s.series),this._customizeChartTooltip(l.tooltip,n),c.wrap=!0;const h=t.series.push(new o.LineSeries);h.dataFields.categoryX="tooltip",h.dataFields.valueY="value",t.cursor=new o.XYCursor,s.series.length>oz&&(t.scrollbarX=new n.Scrollbar)}_createXYChart(t){const{chartDiv:e,chartsModule:i,mediaInfo:r}=t,{type:s}=r,{am4core:n,am4charts:o}=i,a=n.create(e,o.XYChart);return a.rtl=yf(this.container),s==="column-chart"&&this._createColumnChart(a,t),s==="bar-chart"&&this._createBarChart(a,t),s==="line-chart"&&this._createLineChart(a,t),a}_clearMediaRefreshTimer(){const{_refreshTimer:t}=this;t&&(clearTimeout(t),this._refreshTimer=null)}_updateMediaInfoTimestamp(t){const e=Date.now();this._refreshIntervalInfo={timestamp:e,sourceURL:this._getImageSource(t,e)},this.scheduleRender()}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:t}=this.viewModel;t&&t.type==="image"&&t.refreshInterval&&this._setRefreshTimeout(t)}_setRefreshTimeout(t){const{refreshInterval:e,value:i}=t;if(!e)return;const r=6e4*e;this._updateMediaInfoTimestamp(i.sourceURL);const s=setInterval(()=>{this._updateMediaInfoTimestamp(i.sourceURL)},r);this._refreshTimer=s}_getImageSource(t,e){const i=t.indexOf("?")!==-1?"&":"?",[r,s=""]=t.split("#");return`${r}${i}timestamp=${e}${s?"#":""}${s}`}};u([Ve("viewModel.attributes")],So.prototype,"attributes",void 0),u([Ve("viewModel.activeMediaInfoIndex")],So.prototype,"activeMediaInfoIndex",void 0),u([Ve("viewModel.description")],So.prototype,"description",void 0),u([Ve("viewModel.fieldInfoMap")],So.prototype,"fieldInfoMap",void 0),u([Ve("viewModel.layer")],So.prototype,"layer",void 0),u([Ve("viewModel.mediaInfos")],So.prototype,"mediaInfos",void 0),u([Ve("viewModel.popupTemplate")],So.prototype,"popupTemplate",void 0),u([Ve("viewModel.relatedInfos")],So.prototype,"relatedInfos",void 0),u([Ve("viewModel.title")],So.prototype,"title",void 0),u([d({type:Ey})],So.prototype,"viewModel",void 0),u([d(),qs("esri/widgets/Feature/t9n/Feature")],So.prototype,"messages",void 0),So=u([R("esri.widgets.Feature.FeatureMedia")],So);const FK=So;class S$e{constructor(e,i){this.definition=null,this.context=null,this.definition=e,this.context=i}}class Mu{constructor(e=[]){this._elements=e}length(){return this._elements.length}get(e){return this._elements[e]}toArray(){const e=[];for(let i=0;i<this.length();i++)e.push(this.get(i));return e}}class Oy extends Mu{constructor(e,i,r,s,n,o){super(e),this._lazyPt=[],this._hasZ=!1,this._hasM=!1,this._spRef=i,this._hasZ=r,this._hasM=s,this._cacheId=n,this._partId=o}get(e){if(this._lazyPt[e]===void 0){const i=this._elements[e];if(i===void 0)return;const r=this._hasZ,s=this._hasM;let n=null;n=r&&!s?new je(i[0],i[1],i[2],void 0,this._spRef):s&&!r?new je(i[0],i[1],void 0,i[2],this._spRef):r&&s?new je(i[0],i[1],i[2],i[3],this._spRef):new je(i[0],i[1],this._spRef),n.cache._arcadeCacheId=this._cacheId.toString()+"-"+this._partId.toString()+"-"+e.toString(),this._lazyPt[e]=n}return this._lazyPt[e]}equalityTest(e){return e===this||e!==null&&e instanceof Oy&&e.getUniqueHash()===this.getUniqueHash()}getUniqueHash(){return this._cacheId.toString()+"-"+this._partId.toString()}}class az extends Mu{constructor(e,i,r,s,n){super(e),this._lazyPath=[],this._hasZ=!1,this._hasM=!1,this._hasZ=r,this._hasM=s,this._spRef=i,this._cacheId=n}get(e){if(this._lazyPath[e]===void 0){const i=this._elements[e];if(i===void 0)return;this._lazyPath[e]=new Oy(i,this._spRef,this._hasZ,this._hasM,this._cacheId,e)}return this._lazyPath[e]}equalityTest(e){return e===this||e!==null&&e instanceof az&&e.getUniqueHash()===this.getUniqueHash()}getUniqueHash(){return this._cacheId.toString()}}class Ry extends Error{}class T$e extends Ry{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class C$e extends Ry{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class M$e extends Ry{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class N2 extends Ry{}class LK extends Ry{constructor(e){super(`Invalid unit ${e}`)}}class Ga extends Ry{}class xf extends Ry{constructor(){super("Zone is an abstract class")}}const Fe="numeric",pc="short",oa="long",lz={year:Fe,month:Fe,day:Fe},kK={year:Fe,month:pc,day:Fe},P$e={year:Fe,month:pc,day:Fe,weekday:pc},zK={year:Fe,month:oa,day:Fe},VK={year:Fe,month:oa,day:Fe,weekday:oa},NK={hour:Fe,minute:Fe},UK={hour:Fe,minute:Fe,second:Fe},jK={hour:Fe,minute:Fe,second:Fe,timeZoneName:pc},BK={hour:Fe,minute:Fe,second:Fe,timeZoneName:oa},GK={hour:Fe,minute:Fe,hourCycle:"h23"},qK={hour:Fe,minute:Fe,second:Fe,hourCycle:"h23"},HK={hour:Fe,minute:Fe,second:Fe,hourCycle:"h23",timeZoneName:pc},WK={hour:Fe,minute:Fe,second:Fe,hourCycle:"h23",timeZoneName:oa},ZK={year:Fe,month:Fe,day:Fe,hour:Fe,minute:Fe},JK={year:Fe,month:Fe,day:Fe,hour:Fe,minute:Fe,second:Fe},QK={year:Fe,month:pc,day:Fe,hour:Fe,minute:Fe},YK={year:Fe,month:pc,day:Fe,hour:Fe,minute:Fe,second:Fe},A$e={year:Fe,month:pc,day:Fe,weekday:pc,hour:Fe,minute:Fe},XK={year:Fe,month:oa,day:Fe,hour:Fe,minute:Fe,timeZoneName:pc},KK={year:Fe,month:oa,day:Fe,hour:Fe,minute:Fe,second:Fe,timeZoneName:pc},eee={year:Fe,month:oa,day:Fe,weekday:oa,hour:Fe,minute:Fe,timeZoneName:oa},tee={year:Fe,month:oa,day:Fe,weekday:oa,hour:Fe,minute:Fe,second:Fe,timeZoneName:oa};function ri(t){return typeof t=="undefined"}function Iy(t){return typeof t=="number"}function HA(t){return typeof t=="number"&&t%1==0}function $$e(t){return typeof t=="string"}function E$e(t){return Object.prototype.toString.call(t)==="[object Date]"}function iee(){try{return typeof Intl!="undefined"&&!!Intl.RelativeTimeFormat}catch{return!1}}function O$e(t){return Array.isArray(t)?t:[t]}function ree(t,e,i){if(t.length!==0)return t.reduce((r,s)=>{const n=[e(s),s];return r&&i(r[0],n[0])===r[0]?r:n},null)[1]}function R$e(t,e){return e.reduce((i,r)=>(i[r]=t[r],i),{})}function u_(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function rd(t,e,i){return HA(t)&&t>=e&&t<=i}function I$e(t,e){return t-e*Math.floor(t/e)}function h_(t,e=2){const i=t<0?"-":"",r=i?t*-1:t;let s;return r.toString().length<e?s=("0".repeat(e)+r).slice(-e):s=r.toString(),`${i}${s}`}function Sf(t){if(!(ri(t)||t===null||t===""))return parseInt(t,10)}function Dy(t){if(!(ri(t)||t===null||t===""))return parseFloat(t)}function cz(t){if(!(ri(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function uz(t,e,i=!1){const r=10**e;return(i?Math.trunc:Math.round)(t*r)/r}function U2(t){return t%4==0&&(t%100!=0||t%400==0)}function j2(t){return U2(t)?366:365}function WA(t,e){const i=I$e(e-1,12)+1,r=t+(e-i)/12;return i===2?U2(r)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][i-1]}function hz(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(e.getUTCFullYear()-1900)),+e}function ZA(t){const e=(t+Math.floor(t/4)-Math.floor(t/100)+Math.floor(t/400))%7,i=t-1,r=(i+Math.floor(i/4)-Math.floor(i/100)+Math.floor(i/400))%7;return e===4||r===3?53:52}function dz(t){return t>99?t:t>60?1900+t:2e3+t}function see(t,e,i,r=null){const s=new Date(t),n={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};r&&(n.timeZone=r);const o=E({timeZoneName:e},n),a=new Intl.DateTimeFormat(i,o).formatToParts(s).find(l=>l.type.toLowerCase()==="timezonename");return a?a.value:null}function JA(t,e){let i=parseInt(t,10);Number.isNaN(i)&&(i=0);const r=parseInt(e,10)||0,s=i<0||Object.is(i,-0)?-r:r;return i*60+s}function nee(t){const e=Number(t);if(typeof t=="boolean"||t===""||Number.isNaN(e))throw new Ga(`Invalid unit value ${t}`);return e}function QA(t,e){const i={};for(const r in t)if(u_(t,r)){const s=t[r];if(s==null)continue;i[e(r)]=nee(s)}return i}function YA(t,e){const i=Math.trunc(Math.abs(t/60)),r=Math.trunc(Math.abs(t%60)),s=t>=0?"+":"-";switch(e){case"short":return`${s}${h_(i,2)}:${h_(r,2)}`;case"narrow":return`${s}${i}${r>0?`:${r}`:""}`;case"techie":return`${s}${h_(i,2)}${h_(r,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function XA(t){return R$e(t,["hour","minute","second","millisecond"])}const oee=/[A-Za-z_+-]{1,256}(:?\/[A-Za-z0-9_+-]{1,256}(\/[A-Za-z0-9_+-]{1,256})?)?/,D$e=["January","February","March","April","May","June","July","August","September","October","November","December"],aee=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],F$e=["J","F","M","A","M","J","J","A","S","O","N","D"];function lee(t){switch(t){case"narrow":return[...F$e];case"short":return[...aee];case"long":return[...D$e];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const cee=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],uee=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],L$e=["M","T","W","T","F","S","S"];function hee(t){switch(t){case"narrow":return[...L$e];case"short":return[...uee];case"long":return[...cee];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const dee=["AM","PM"],k$e=["Before Christ","Anno Domini"],z$e=["BC","AD"],V$e=["B","A"];function pee(t){switch(t){case"narrow":return[...V$e];case"short":return[...z$e];case"long":return[...k$e];default:return null}}function N$e(t){return dee[t.hour<12?0:1]}function U$e(t,e){return hee(e)[t.weekday-1]}function j$e(t,e){return lee(e)[t.month-1]}function B$e(t,e){return pee(e)[t.year<0?0:1]}function G$e(t,e,i="always",r=!1){const s={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},n=["hours","minutes","seconds"].indexOf(t)===-1;if(i==="auto"&&n){const p=t==="days";switch(e){case 1:return p?"tomorrow":`next ${s[t][0]}`;case-1:return p?"yesterday":`last ${s[t][0]}`;case 0:return p?"today":`this ${s[t][0]}`}}const o=Object.is(e,-0)||e<0,a=Math.abs(e),l=a===1,c=s[t],h=r?l?c[1]:c[2]||c[1]:l?s[t][0]:t;return o?`${a} ${h} ago`:`in ${a} ${h}`}function fee(t,e){let i="";for(const r of t)r.literal?i+=r.val:i+=e(r.val);return i}const q$e={D:lz,DD:kK,DDD:zK,DDDD:VK,t:NK,tt:UK,ttt:jK,tttt:BK,T:GK,TT:qK,TTT:HK,TTTT:WK,f:ZK,ff:QK,fff:XK,ffff:eee,F:JK,FF:YK,FFF:KK,FFFF:tee};class To{static create(e,i={}){return new To(e,i)}static parseFormat(e){let i=null,r="",s=!1;const n=[];for(let o=0;o<e.length;o++){const a=e.charAt(o);a==="'"?(r.length>0&&n.push({literal:s,val:r}),i=null,r="",s=!s):s||a===i?r+=a:(r.length>0&&n.push({literal:!1,val:r}),r=a,i=a)}return r.length>0&&n.push({literal:s,val:r}),n}static macroTokenToFormatOpts(e){return q$e[e]}constructor(e,i){this.opts=i,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,i){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,E(E({},this.opts),i)).format()}formatDateTime(e,i={}){return this.loc.dtFormatter(e,E(E({},this.opts),i)).format()}formatDateTimeParts(e,i={}){return this.loc.dtFormatter(e,E(E({},this.opts),i)).formatToParts()}resolvedOptions(e,i={}){return this.loc.dtFormatter(e,E(E({},this.opts),i)).resolvedOptions()}num(e,i=0){if(this.opts.forceSimple)return h_(e,i);const r=E({},this.opts);return i>0&&(r.padTo=i),this.loc.numberFormatter(r).format(e)}formatDateTimeFromString(e,i){const r=this.loc.listingMode()==="en",s=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",n=(g,y)=>this.loc.extract(e,g,y),o=g=>e.isOffsetFixed&&e.offset===0&&g.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,g.format):"",a=()=>r?N$e(e):n({hour:"numeric",hourCycle:"h12"},"dayperiod"),l=(g,y)=>r?j$e(e,g):n(y?{month:g}:{month:g,day:"numeric"},"month"),c=(g,y)=>r?U$e(e,g):n(y?{weekday:g}:{weekday:g,month:"long",day:"numeric"},"weekday"),h=g=>{const y=To.macroTokenToFormatOpts(g);return y?this.formatWithSystemDefault(e,y):g},p=g=>r?B$e(e,g):n({era:g},"era"),f=g=>{switch(g){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12==0?12:e.hour%12);case"hh":return this.num(e.hour%12==0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return o({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return o({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return o({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return a();case"d":return s?n({day:"numeric"},"day"):this.num(e.day);case"dd":return s?n({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return c("short",!0);case"cccc":return c("long",!0);case"ccccc":return c("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return c("short",!1);case"EEEE":return c("long",!1);case"EEEEE":return c("narrow",!1);case"L":return s?n({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return s?n({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return l("short",!0);case"LLLL":return l("long",!0);case"LLLLL":return l("narrow",!0);case"M":return s?n({month:"numeric"},"month"):this.num(e.month);case"MM":return s?n({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return l("short",!1);case"MMMM":return l("long",!1);case"MMMMM":return l("narrow",!1);case"y":return s?n({year:"numeric"},"year"):this.num(e.year);case"yy":return s?n({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return s?n({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return s?n({year:"numeric"},"year"):this.num(e.year,6);case"G":return p("short");case"GG":return p("long");case"GGGGG":return p("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return h(g)}};return fee(To.parseFormat(i),f)}formatDurationFromString(e,i){const r=l=>{switch(l[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"M":return"month";case"y":return"year";default:return null}},s=l=>c=>{const h=r(c);return h?this.num(l.get(h),c.length):c},n=To.parseFormat(i),o=n.reduce((l,{literal:c,val:h})=>c?l:l.concat(h),[]),a=e.shiftTo(...o.map(r).filter(l=>l));return fee(n,s(a))}}class fc{constructor(e,i){this.reason=e,this.explanation=i}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}class B2{get type(){throw new xf}get name(){throw new xf}get isUniversal(){throw new xf}offsetName(e,i){throw new xf}formatOffset(e,i){throw new xf}offset(e){throw new xf}equals(e){throw new xf}get isValid(){throw new xf}}let pz=null;class fz extends B2{static get instance(){return pz===null&&(pz=new fz),pz}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:i,locale:r}){return see(e,i,r)}formatOffset(e,i){return YA(this.offset(e),i)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}const H$e=RegExp(`^${oee.source}$`);let KA={};function W$e(t){return KA[t]||(KA[t]=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})),KA[t]}const Z$e={year:0,month:1,day:2,hour:3,minute:4,second:5};function J$e(t,e){const i=t.format(e).replace(/\u200E/g,""),r=/(\d+)\/(\d+)\/(\d+),? (\d+):(\d+):(\d+)/.exec(i),[,s,n,o,a,l,c]=r;return[o,s,n,a,l,c]}function Q$e(t,e){const i=t.formatToParts(e),r=[];for(let s=0;s<i.length;s++){const{type:n,value:o}=i[s],a=Z$e[n];ri(a)||(r[a]=parseInt(o,10))}return r}let e$={};class mc extends B2{static create(e){return e$[e]||(e$[e]=new mc(e)),e$[e]}static resetCache(){e$={},KA={}}static isValidSpecifier(e){return!!(e&&e.match(H$e))}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super();this.zoneName=e,this.valid=mc.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:i,locale:r}){return see(e,i,r,this.name)}formatOffset(e,i){return YA(this.offset(e),i)}offset(e){const i=new Date(e);if(isNaN(i))return NaN;const r=W$e(this.name),[s,n,o,a,l,c]=r.formatToParts?Q$e(r,i):J$e(r,i),p=hz({year:s,month:n,day:o,hour:a===24?0:a,minute:l,second:c,millisecond:0});let f=+i;const g=f%1e3;return f-=g>=0?g:1e3+g,(p-f)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let mz=null;class Bn extends B2{static get utcInstance(){return mz===null&&(mz=new Bn(0)),mz}static instance(e){return e===0?Bn.utcInstance:new Bn(e)}static parseSpecifier(e){if(e){const i=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(i)return new Bn(JA(i[1],i[2]))}return null}constructor(e){super();this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${YA(this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,i){return YA(this.fixed,i)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class mee extends B2{constructor(e){super();this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function Tf(t,e){if(ri(t)||t===null)return e;if(t instanceof B2)return t;if($$e(t)){const i=t.toLowerCase();return i==="local"||i==="system"?e:i==="utc"||i==="gmt"?Bn.utcInstance:mc.isValidSpecifier(i)?mc.create(t):Bn.parseSpecifier(i)||new mee(t)}else return Iy(t)?Bn.instance(t):typeof t=="object"&&t.offset&&typeof t.offset=="number"?t:new mee(t)}let gee=()=>Date.now(),yee="system",vee=null,_ee=null,bee=null,wee;class ns{static get now(){return gee}static set now(e){gee=e}static set defaultZone(e){yee=e}static get defaultZone(){return Tf(yee,fz.instance)}static get defaultLocale(){return vee}static set defaultLocale(e){vee=e}static get defaultNumberingSystem(){return _ee}static set defaultNumberingSystem(e){_ee=e}static get defaultOutputCalendar(){return bee}static set defaultOutputCalendar(e){bee=e}static get throwOnInvalid(){return wee}static set throwOnInvalid(e){wee=e}static resetCaches(){pr.resetCache(),mc.resetCache()}}let gz={};function yz(t,e={}){const i=JSON.stringify([t,e]);let r=gz[i];return r||(r=new Intl.DateTimeFormat(t,e),gz[i]=r),r}let vz={};function Y$e(t,e={}){const i=JSON.stringify([t,e]);let r=vz[i];return r||(r=new Intl.NumberFormat(t,e),vz[i]=r),r}let _z={};function X$e(t,e={}){const o=e,{base:i}=o,r=$B(o,["base"]),s=JSON.stringify([t,r]);let n=_z[s];return n||(n=new Intl.RelativeTimeFormat(t,e),_z[s]=n),n}let G2=null;function K$e(){return G2||(G2=new Intl.DateTimeFormat().resolvedOptions().locale,G2)}function eEe(t){const e=t.indexOf("-u-");if(e===-1)return[t];{let i;const r=t.substring(0,e);try{i=yz(t).resolvedOptions()}catch{i=yz(r).resolvedOptions()}const{numberingSystem:s,calendar:n}=i;return[r,s,n]}}function tEe(t,e,i){return(i||e)&&(t+="-u",i&&(t+=`-ca-${i}`),e&&(t+=`-nu-${e}`)),t}function iEe(t){const e=[];for(let i=1;i<=12;i++){const r=gt.utc(2016,i,1);e.push(t(r))}return e}function rEe(t){const e=[];for(let i=1;i<=7;i++){const r=gt.utc(2016,11,13+i);e.push(t(r))}return e}function t$(t,e,i,r,s){const n=t.listingMode(i);return n==="error"?null:n==="en"?r(e):s(e)}function sEe(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||new Intl.DateTimeFormat(t.intl).resolvedOptions().numberingSystem==="latn"}class nEe{constructor(e,i,r){if(this.padTo=r.padTo||0,this.floor=r.floor||!1,!i){const s={useGrouping:!1};r.padTo>0&&(s.minimumIntegerDigits=r.padTo),this.inf=Y$e(e,s)}}format(e){if(this.inf){const i=this.floor?Math.floor(e):e;return this.inf.format(i)}else{const i=this.floor?Math.floor(e):uz(e,3);return h_(i,this.padTo)}}}class oEe{constructor(e,i,r){this.opts=r;let s;if(e.zone.isUniversal){const o=-1*(e.offset/60),a=o>=0?`Etc/GMT+${o}`:`Etc/GMT${o}`;e.offset!==0&&mc.create(a).valid?(s=a,this.dt=e):(s="UTC",r.timeZoneName?this.dt=e:this.dt=e.offset===0?e:gt.fromMillis(e.ts+e.offset*60*1e3))}else e.zone.type==="system"?this.dt=e:(this.dt=e,s=e.zone.name);const n=E({},this.opts);s&&(n.timeZone=s),this.dtf=yz(i,n)}format(){return this.dtf.format(this.dt.toJSDate())}formatToParts(){return this.dtf.formatToParts(this.dt.toJSDate())}resolvedOptions(){return this.dtf.resolvedOptions()}}class aEe{constructor(e,i,r){this.opts=E({style:"long"},r),!i&&iee()&&(this.rtf=X$e(e,r))}format(e,i){return this.rtf?this.rtf.format(e,i):G$e(i,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,i){return this.rtf?this.rtf.formatToParts(e,i):[]}}class pr{static fromOpts(e){return pr.create(e.locale,e.numberingSystem,e.outputCalendar,e.defaultToEN)}static create(e,i,r,s=!1){const n=e||ns.defaultLocale,o=n||(s?"en-US":K$e()),a=i||ns.defaultNumberingSystem,l=r||ns.defaultOutputCalendar;return new pr(o,a,l,n)}static resetCache(){G2=null,gz={},vz={},_z={}}static fromObject({locale:e,numberingSystem:i,outputCalendar:r}={}){return pr.create(e,i,r)}constructor(e,i,r,s){const[n,o,a]=eEe(e);this.locale=n,this.numberingSystem=i||o||null,this.outputCalendar=r||a||null,this.intl=tEe(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=s,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=sEe(this)),this.fastNumbersCached}listingMode(e=!0){const i=this.isEnglish(),r=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return i&&r?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:pr.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone(he(E({},e),{defaultToEN:!0}))}redefaultToSystem(e={}){return this.clone(he(E({},e),{defaultToEN:!1}))}months(e,i=!1,r=!0){return t$(this,e,r,lee,()=>{const s=i?{month:e,day:"numeric"}:{month:e},n=i?"format":"standalone";return this.monthsCache[n][e]||(this.monthsCache[n][e]=iEe(o=>this.extract(o,s,"month"))),this.monthsCache[n][e]})}weekdays(e,i=!1,r=!0){return t$(this,e,r,hee,()=>{const s=i?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},n=i?"format":"standalone";return this.weekdaysCache[n][e]||(this.weekdaysCache[n][e]=rEe(o=>this.extract(o,s,"weekday"))),this.weekdaysCache[n][e]})}meridiems(e=!0){return t$(this,void 0,e,()=>dee,()=>{if(!this.meridiemCache){const i={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[gt.utc(2016,11,13,9),gt.utc(2016,11,13,19)].map(r=>this.extract(r,i,"dayperiod"))}return this.meridiemCache})}eras(e,i=!0){return t$(this,e,i,pee,()=>{const r={era:e};return this.eraCache[e]||(this.eraCache[e]=[gt.utc(-40,1,1),gt.utc(2017,1,1)].map(s=>this.extract(s,r,"era"))),this.eraCache[e]})}extract(e,i,r){const s=this.dtFormatter(e,i),n=s.formatToParts(),o=n.find(a=>a.type.toLowerCase()===r);return o?o.value:null}numberFormatter(e={}){return new nEe(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,i={}){return new oEe(e,this.intl,i)}relFormatter(e={}){return new aEe(this.intl,this.isEnglish(),e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||new Intl.DateTimeFormat(this.intl).resolvedOptions().locale.startsWith("en-us")}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}}function d_(...t){const e=t.reduce((i,r)=>i+r.source,"");return RegExp(`^${e}$`)}function Fy(...t){return e=>t.reduce(([i,r,s],n)=>{const[o,a,l]=n(e,s);return[E(E({},i),o),r||a,l]},[{},null,1]).slice(0,2)}function p_(t,...e){if(t==null)return[null,null];for(const[i,r]of e){const s=i.exec(t);if(s)return r(s)}return[null,null]}function xee(...t){return(e,i)=>{const r={};let s;for(s=0;s<t.length;s++)r[t[s]]=Sf(e[i+s]);return[r,null,i+s]}}const See=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,bz=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,Tee=RegExp(`${bz.source}${See.source}?`),wz=RegExp(`(?:T${Tee.source})?`),lEe=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,cEe=/(\d{4})-?W(\d\d)(?:-?(\d))?/,uEe=/(\d{4})-?(\d{3})/,hEe=xee("weekYear","weekNumber","weekDay"),dEe=xee("year","ordinal"),pEe=/(\d{4})-(\d\d)-(\d\d)/,Cee=RegExp(`${bz.source} ?(?:${See.source}|(${oee.source}))?`),fEe=RegExp(`(?: ${Cee.source})?`);function f_(t,e,i){const r=t[e];return ri(r)?i:Sf(r)}function Mee(t,e){return[{year:f_(t,e),month:f_(t,e+1,1),day:f_(t,e+2,1)},null,e+3]}function Ly(t,e){return[{hours:f_(t,e,0),minutes:f_(t,e+1,0),seconds:f_(t,e+2,0),milliseconds:cz(t[e+3])},null,e+4]}function m_(t,e){const i=!t[e]&&!t[e+1],r=JA(t[e+1],t[e+2]),s=i?null:Bn.instance(r);return[{},s,e+3]}function Pee(t,e){const i=t[e]?mc.create(t[e]):null;return[{},i,e+1]}const mEe=RegExp(`^T?${bz.source}$`),gEe=/^-?P(?:(?:(-?\d{1,9}(?:\.\d{1,9})?)Y)?(?:(-?\d{1,9}(?:\.\d{1,9})?)M)?(?:(-?\d{1,9}(?:\.\d{1,9})?)W)?(?:(-?\d{1,9}(?:\.\d{1,9})?)D)?(?:T(?:(-?\d{1,9}(?:\.\d{1,9})?)H)?(?:(-?\d{1,9}(?:\.\d{1,9})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,9}))?S)?)?)$/;function yEe(t){const[e,i,r,s,n,o,a,l,c]=t,h=e[0]==="-",p=l&&l[0]==="-",f=(g,y=!1)=>g!==void 0&&(y||g&&h)?-g:g;return[{years:f(Dy(i)),months:f(Dy(r)),weeks:f(Dy(s)),days:f(Dy(n)),hours:f(Dy(o)),minutes:f(Dy(a)),seconds:f(Dy(l),l==="-0"),milliseconds:f(cz(c),p)}]}const vEe={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function xz(t,e,i,r,s,n,o){const a={year:e.length===2?dz(Sf(e)):Sf(e),month:aee.indexOf(i)+1,day:Sf(r),hour:Sf(s),minute:Sf(n)};return o&&(a.second=Sf(o)),t&&(a.weekday=t.length>3?cee.indexOf(t)+1:uee.indexOf(t)+1),a}const _Ee=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function bEe(t){const[,e,i,r,s,n,o,a,l,c,h,p]=t,f=xz(e,s,r,i,n,o,a);let g;return l?g=vEe[l]:c?g=0:g=JA(h,p),[f,new Bn(g)]}function wEe(t){return t.replace(/\([^)]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const xEe=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,SEe=/^(Monday|Tuesday|Wedsday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,TEe=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function Aee(t){const[,e,i,r,s,n,o,a]=t;return[xz(e,s,r,i,n,o,a),Bn.utcInstance]}function CEe(t){const[,e,i,r,s,n,o,a]=t;return[xz(e,a,i,r,s,n,o),Bn.utcInstance]}const MEe=d_(lEe,wz),PEe=d_(cEe,wz),AEe=d_(uEe,wz),$Ee=d_(Tee),EEe=Fy(Mee,Ly,m_),OEe=Fy(hEe,Ly,m_),REe=Fy(dEe,Ly,m_),IEe=Fy(Ly,m_);function DEe(t){return p_(t,[MEe,EEe],[PEe,OEe],[AEe,REe],[$Ee,IEe])}function FEe(t){return p_(wEe(t),[_Ee,bEe])}function LEe(t){return p_(t,[xEe,Aee],[SEe,Aee],[TEe,CEe])}function kEe(t){return p_(t,[gEe,yEe])}const zEe=Fy(Ly);function VEe(t){return p_(t,[mEe,zEe])}const NEe=d_(pEe,fEe),UEe=d_(Cee),jEe=Fy(Mee,Ly,m_,Pee),BEe=Fy(Ly,m_,Pee);function GEe(t){return p_(t,[NEe,jEe],[UEe,BEe])}const qEe="Invalid Duration",$ee={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},HEe=E({years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3}},$ee),qa=146097/400,g_=146097/4800,WEe=E({years:{quarters:4,months:12,weeks:qa/7,days:qa,hours:qa*24,minutes:qa*24*60,seconds:qa*24*60*60,milliseconds:qa*24*60*60*1e3},quarters:{months:3,weeks:qa/28,days:qa/4,hours:qa*24/4,minutes:qa*24*60/4,seconds:qa*24*60*60/4,milliseconds:qa*24*60*60*1e3/4},months:{weeks:g_/7,days:g_,hours:g_*24,minutes:g_*24*60,seconds:g_*24*60*60,milliseconds:g_*24*60*60*1e3}},$ee),y_=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],ZEe=y_.slice(0).reverse();function ky(t,e,i=!1){const r={values:i?e.values:E(E({},t.values),e.values||{}),loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy};return new Yt(r)}function JEe(t){return t<0?Math.floor(t):Math.ceil(t)}function Eee(t,e,i,r,s){const n=t[s][i],o=e[i]/n,a=Math.sign(o)===Math.sign(r[s]),l=!a&&r[s]!==0&&Math.abs(o)<=1?JEe(o):Math.trunc(o);r[s]+=l,e[i]-=l*n}function QEe(t,e){ZEe.reduce((i,r)=>ri(e[r])?i:(i&&Eee(t,e,i,e,r),r),null)}class Yt{constructor(e){const i=e.conversionAccuracy==="longterm"||!1;this.values=e.values,this.loc=e.loc||pr.create(),this.conversionAccuracy=i?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=i?WEe:HEe,this.isLuxonDuration=!0}static fromMillis(e,i){return Yt.fromObject({milliseconds:e},i)}static fromObject(e,i={}){if(e==null||typeof e!="object")throw new Ga(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new Yt({values:QA(e,Yt.normalizeUnit),loc:pr.fromObject(i),conversionAccuracy:i.conversionAccuracy})}static fromDurationLike(e){if(Iy(e))return Yt.fromMillis(e);if(Yt.isDuration(e))return e;if(typeof e=="object")return Yt.fromObject(e);throw new Ga(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,i){const[r]=kEe(e);return r?Yt.fromObject(r,i):Yt.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,i){const[r]=VEe(e);return r?Yt.fromObject(r,i):Yt.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,i=null){if(!e)throw new Ga("need to specify a reason the Duration is invalid");const r=e instanceof fc?e:new fc(e,i);if(ns.throwOnInvalid)throw new M$e(r);return new Yt({invalid:r})}static normalizeUnit(e){const i={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!i)throw new LK(e);return i}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,i={}){const r=he(E({},i),{floor:i.round!==!1&&i.floor!==!1});return this.isValid?To.create(this.loc,r).formatDurationFromString(this,e):qEe}toObject(){return this.isValid?E({},this.values):{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=uz(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const i=this.toMillis();if(i<0||i>=864e5)return null;e=E({suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended"},e);const r=this.shiftTo("hours","minutes","seconds","milliseconds");let s=e.format==="basic"?"hhmm":"hh:mm";(!e.suppressSeconds||r.seconds!==0||r.milliseconds!==0)&&(s+=e.format==="basic"?"ss":":ss",(!e.suppressMilliseconds||r.milliseconds!==0)&&(s+=".SSS"));let n=r.toFormat(s);return e.includePrefix&&(n="T"+n),n}toJSON(){return this.toISO()}toString(){return this.toISO()}toMillis(){return this.as("milliseconds")}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const i=Yt.fromDurationLike(e),r={};for(const s of y_)(u_(i.values,s)||u_(this.values,s))&&(r[s]=i.get(s)+this.get(s));return ky(this,{values:r},!0)}minus(e){if(!this.isValid)return this;const i=Yt.fromDurationLike(e);return this.plus(i.negate())}mapUnits(e){if(!this.isValid)return this;const i={};for(const r of Object.keys(this.values))i[r]=nee(e(this.values[r],r));return ky(this,{values:i},!0)}get(e){return this[Yt.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const i=E(E({},this.values),QA(e,Yt.normalizeUnit));return ky(this,{values:i})}reconfigure({locale:e,numberingSystem:i,conversionAccuracy:r}={}){const s=this.loc.clone({locale:e,numberingSystem:i}),n={loc:s};return r&&(n.conversionAccuracy=r),ky(this,n)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return QEe(this.matrix,e),ky(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(o=>Yt.normalizeUnit(o));const i={},r={},s=this.toObject();let n;for(const o of y_)if(e.indexOf(o)>=0){n=o;let a=0;for(const c in r)a+=this.matrix[c][o]*r[c],r[c]=0;Iy(s[o])&&(a+=s[o]);const l=Math.trunc(a);i[o]=l,r[o]=a-l;for(const c in s)y_.indexOf(c)>y_.indexOf(o)&&Eee(this.matrix,s,c,i,o)}else Iy(s[o])&&(r[o]=s[o]);for(const o in r)r[o]!==0&&(i[n]+=o===n?r[o]:r[o]/this.matrix[n][o]);return ky(this,{values:i},!0).normalize()}negate(){if(!this.isValid)return this;const e={};for(const i of Object.keys(this.values))e[i]=-this.values[i];return ky(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function i(r,s){return r===void 0||r===0?s===void 0||s===0:r===s}for(const r of y_)if(!i(this.values[r],e.values[r]))return!1;return!0}}const q2="Invalid Interval";function YEe(t,e){return!t||!t.isValid?wr.invalid("missing or invalid start"):!e||!e.isValid?wr.invalid("missing or invalid end"):e<t?wr.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class wr{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,i=null){if(!e)throw new Ga("need to specify a reason the Interval is invalid");const r=e instanceof fc?e:new fc(e,i);if(ns.throwOnInvalid)throw new C$e(r);return new wr({invalid:r})}static fromDateTimes(e,i){const r=Z2(e),s=Z2(i),n=YEe(r,s);return n==null?new wr({start:r,end:s}):n}static after(e,i){const r=Yt.fromDurationLike(i),s=Z2(e);return wr.fromDateTimes(s,s.plus(r))}static before(e,i){const r=Yt.fromDurationLike(i),s=Z2(e);return wr.fromDateTimes(s.minus(r),s)}static fromISO(e,i){const[r,s]=(e||"").split("/",2);if(r&&s){let n,o;try{n=gt.fromISO(r,i),o=n.isValid}catch{o=!1}let a,l;try{a=gt.fromISO(s,i),l=a.isValid}catch{l=!1}if(o&&l)return wr.fromDateTimes(n,a);if(o){const c=Yt.fromISO(s,i);if(c.isValid)return wr.after(n,c)}else if(l){const c=Yt.fromISO(r,i);if(c.isValid)return wr.before(a,c)}}return wr.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds"){if(!this.isValid)return NaN;const i=this.start.startOf(e),r=this.end.startOf(e);return Math.floor(r.diff(i,e).get(e))+1}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:i}={}){return this.isValid?wr.fromDateTimes(e||this.s,i||this.e):this}splitAt(...e){if(!this.isValid)return[];const i=e.map(Z2).filter(o=>this.contains(o)).sort(),r=[];let{s}=this,n=0;for(;s<this.e;){const o=i[n]||this.e,a=+o>+this.e?this.e:o;r.push(wr.fromDateTimes(s,a)),s=a,n+=1}return r}splitBy(e){const i=Yt.fromDurationLike(e);if(!this.isValid||!i.isValid||i.as("milliseconds")===0)return[];let{s:r}=this,s=1,n;const o=[];for(;r<this.e;){const a=this.start.plus(i.mapUnits(l=>l*s));n=+a>+this.e?this.e:a,o.push(wr.fromDateTimes(r,n)),r=n,s+=1}return o}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const i=this.s>e.s?this.s:e.s,r=this.e<e.e?this.e:e.e;return i>=r?null:wr.fromDateTimes(i,r)}union(e){if(!this.isValid)return this;const i=this.s<e.s?this.s:e.s,r=this.e>e.e?this.e:e.e;return wr.fromDateTimes(i,r)}static merge(e){const[i,r]=e.sort((s,n)=>s.s-n.s).reduce(([s,n],o)=>n?n.overlaps(o)||n.abutsStart(o)?[s,n.union(o)]:[s.concat([n]),o]:[s,o],[[],null]);return r&&i.push(r),i}static xor(e){let i=null,r=0;const s=[],n=e.map(l=>[{time:l.s,type:"s"},{time:l.e,type:"e"}]),o=Array.prototype.concat(...n),a=o.sort((l,c)=>l.time-c.time);for(const l of a)r+=l.type==="s"?1:-1,r===1?i=l.time:(i&&+i!=+l.time&&s.push(wr.fromDateTimes(i,l.time)),i=null);return wr.merge(s)}difference(...e){return wr.xor([this].concat(e)).map(i=>this.intersection(i)).filter(i=>i&&!i.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} \u2013 ${this.e.toISO()})`:q2}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:q2}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:q2}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:q2}toFormat(e,{separator:i=" \u2013 "}={}){return this.isValid?`${this.s.toFormat(e)}${i}${this.e.toFormat(e)}`:q2}toDuration(e,i){return this.isValid?this.e.diff(this.s,e,i):Yt.invalid(this.invalidReason)}mapEndpoints(e){return wr.fromDateTimes(e(this.s),e(this.e))}}class i${static hasDST(e=ns.defaultZone){const i=gt.now().setZone(e).set({month:12});return!e.isUniversal&&i.offset!==i.set({month:6}).offset}static isValidIANAZone(e){return mc.isValidSpecifier(e)&&mc.isValidZone(e)}static normalizeZone(e){return Tf(e,ns.defaultZone)}static months(e="long",{locale:i=null,numberingSystem:r=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||pr.create(i,r,n)).months(e)}static monthsFormat(e="long",{locale:i=null,numberingSystem:r=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||pr.create(i,r,n)).months(e,!0)}static weekdays(e="long",{locale:i=null,numberingSystem:r=null,locObj:s=null}={}){return(s||pr.create(i,r,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:i=null,numberingSystem:r=null,locObj:s=null}={}){return(s||pr.create(i,r,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return pr.create(e).meridiems()}static eras(e="short",{locale:i=null}={}){return pr.create(i,null,"gregory").eras(e)}static features(){return{relative:iee()}}}function Oee(t,e){const i=s=>s.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),r=i(e)-i(t);return Math.floor(Yt.fromMillis(r).as("days"))}function XEe(t,e,i){const r=[["years",(a,l)=>l.year-a.year],["quarters",(a,l)=>l.quarter-a.quarter],["months",(a,l)=>l.month-a.month+(l.year-a.year)*12],["weeks",(a,l)=>{const c=Oee(a,l);return(c-c%7)/7}],["days",Oee]],s={};let n,o;for(const[a,l]of r)if(i.indexOf(a)>=0){n=a;let c=l(t,e);o=t.plus({[a]:c}),o>e?(t=t.plus({[a]:c-1}),c-=1):t=o,s[a]=c}return[t,s,o,n]}function KEe(t,e,i,r){let[s,n,o,a]=XEe(t,e,i);const l=e-s,c=i.filter(p=>["hours","minutes","seconds","milliseconds"].indexOf(p)>=0);c.length===0&&(o<e&&(o=s.plus({[a]:1})),o!==s&&(n[a]=(n[a]||0)+l/(o-s)));const h=Yt.fromObject(n,r);return c.length>0?Yt.fromMillis(l,r).shiftTo(...c).plus(h):h}const Sz={arab:"[\u0660-\u0669]",arabext:"[\u06F0-\u06F9]",bali:"[\u1B50-\u1B59]",beng:"[\u09E6-\u09EF]",deva:"[\u0966-\u096F]",fullwide:"[\uFF10-\uFF19]",gujr:"[\u0AE6-\u0AEF]",hanidec:"[\u3007|\u4E00|\u4E8C|\u4E09|\u56DB|\u4E94|\u516D|\u4E03|\u516B|\u4E5D]",khmr:"[\u17E0-\u17E9]",knda:"[\u0CE6-\u0CEF]",laoo:"[\u0ED0-\u0ED9]",limb:"[\u1946-\u194F]",mlym:"[\u0D66-\u0D6F]",mong:"[\u1810-\u1819]",mymr:"[\u1040-\u1049]",orya:"[\u0B66-\u0B6F]",tamldec:"[\u0BE6-\u0BEF]",telu:"[\u0C66-\u0C6F]",thai:"[\u0E50-\u0E59]",tibt:"[\u0F20-\u0F29]",latn:"\\d"},Ree={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},eOe=Sz.hanidec.replace(/[\[|\]]/g,"").split("");function tOe(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let i=0;i<t.length;i++){const r=t.charCodeAt(i);if(t[i].search(Sz.hanidec)!==-1)e+=eOe.indexOf(t[i]);else for(const s in Ree){const[n,o]=Ree[s];r>=n&&r<=o&&(e+=r-n)}}return parseInt(e,10)}else return e}function gc({numberingSystem:t},e=""){return new RegExp(`${Sz[t||"latn"]}${e}`)}const iOe="missing Intl.DateTimeFormat.formatToParts support";function ai(t,e=i=>i){return{regex:t,deser:([i])=>e(tOe(i))}}const rOe=String.fromCharCode(160),Iee=`( |${rOe})`,Dee=new RegExp(Iee,"g");function sOe(t){return t.replace(/\./g,"\\.?").replace(Dee,Iee)}function Fee(t){return t.replace(/\./g,"").replace(Dee," ").toLowerCase()}function yc(t,e){return t===null?null:{regex:RegExp(t.map(sOe).join("|")),deser:([i])=>t.findIndex(r=>Fee(i)===Fee(r))+e}}function Lee(t,e){return{regex:t,deser:([,i,r])=>JA(i,r),groups:e}}function Tz(t){return{regex:t,deser:([e])=>e}}function nOe(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function oOe(t,e){const i=gc(e),r=gc(e,"{2}"),s=gc(e,"{3}"),n=gc(e,"{4}"),o=gc(e,"{6}"),a=gc(e,"{1,2}"),l=gc(e,"{1,3}"),c=gc(e,"{1,6}"),h=gc(e,"{1,9}"),p=gc(e,"{2,4}"),f=gc(e,"{4,6}"),g=b=>({regex:RegExp(nOe(b.val)),deser:([w])=>w,literal:!0}),v=(b=>{if(t.literal)return g(b);switch(b.val){case"G":return yc(e.eras("short",!1),0);case"GG":return yc(e.eras("long",!1),0);case"y":return ai(c);case"yy":return ai(p,dz);case"yyyy":return ai(n);case"yyyyy":return ai(f);case"yyyyyy":return ai(o);case"M":return ai(a);case"MM":return ai(r);case"MMM":return yc(e.months("short",!0,!1),1);case"MMMM":return yc(e.months("long",!0,!1),1);case"L":return ai(a);case"LL":return ai(r);case"LLL":return yc(e.months("short",!1,!1),1);case"LLLL":return yc(e.months("long",!1,!1),1);case"d":return ai(a);case"dd":return ai(r);case"o":return ai(l);case"ooo":return ai(s);case"HH":return ai(r);case"H":return ai(a);case"hh":return ai(r);case"h":return ai(a);case"mm":return ai(r);case"m":return ai(a);case"q":return ai(a);case"qq":return ai(r);case"s":return ai(a);case"ss":return ai(r);case"S":return ai(l);case"SSS":return ai(s);case"u":return Tz(h);case"uu":return Tz(a);case"uuu":return ai(i);case"a":return yc(e.meridiems(),0);case"kkkk":return ai(n);case"kk":return ai(p,dz);case"W":return ai(a);case"WW":return ai(r);case"E":case"c":return ai(i);case"EEE":return yc(e.weekdays("short",!1,!1),1);case"EEEE":return yc(e.weekdays("long",!1,!1),1);case"ccc":return yc(e.weekdays("short",!0,!1),1);case"cccc":return yc(e.weekdays("long",!0,!1),1);case"Z":case"ZZ":return Lee(new RegExp(`([+-]${a.source})(?::(${r.source}))?`),2);case"ZZZ":return Lee(new RegExp(`([+-]${a.source})(${r.source})?`),2);case"z":return Tz(/[a-z_+-/]{1,256}?/i);default:return g(b)}})(t)||{invalidReason:iOe};return v.token=t,v}const aOe={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour:{numeric:"h","2-digit":"hh"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"}};function lOe(t,e,i){const{type:r,value:s}=t;if(r==="literal")return{literal:!0,val:s};const n=i[r];let o=aOe[r];if(typeof o=="object"&&(o=o[n]),o)return{literal:!1,val:o}}function cOe(t){return[`^${t.map(i=>i.regex).reduce((i,r)=>`${i}(${r.source})`,"")}$`,t]}function uOe(t,e,i){const r=t.match(e);if(r){const s={};let n=1;for(const o in i)if(u_(i,o)){const a=i[o],l=a.groups?a.groups+1:1;!a.literal&&a.token&&(s[a.token.val[0]]=a.deser(r.slice(n,n+l))),n+=l}return[r,s]}else return[r,{}]}function hOe(t){const e=s=>{switch(s){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let i;return ri(t.Z)?ri(t.z)?i=null:i=mc.create(t.z):i=new Bn(t.Z),ri(t.q)||(t.M=(t.q-1)*3+1),ri(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),ri(t.u)||(t.S=cz(t.u)),[Object.keys(t).reduce((s,n)=>{const o=e(n);return o&&(s[o]=t[n]),s},{}),i]}let Cz=null;function dOe(){return Cz||(Cz=gt.fromMillis(1555555555555)),Cz}function pOe(t,e){if(t.literal)return t;const i=To.macroTokenToFormatOpts(t.val);if(!i)return t;const n=To.create(e,i).formatDateTimeParts(dOe()).map(o=>lOe(o,e,i));return n.includes(void 0)?t:n}function fOe(t,e){return Array.prototype.concat(...t.map(i=>pOe(i,e)))}function kee(t,e,i){const r=fOe(To.parseFormat(i),t),s=r.map(o=>oOe(o,t)),n=s.find(o=>o.invalidReason);if(n)return{input:e,tokens:r,invalidReason:n.invalidReason};{const[o,a]=cOe(s),l=RegExp(o,"i"),[c,h]=uOe(e,l,a),[p,f]=h?hOe(h):[null,null];if(u_(h,"a")&&u_(h,"H"))throw new N2("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:r,regex:l,rawMatches:c,matches:h,result:p,zone:f}}}function mOe(t,e,i){const{result:r,zone:s,invalidReason:n}=kee(t,e,i);return[r,s,n]}const zee=[0,31,59,90,120,151,181,212,243,273,304,334],Vee=[0,31,60,91,121,152,182,213,244,274,305,335];function Ha(t,e){return new fc("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function Nee(t,e,i){const r=new Date(Date.UTC(t,e-1,i)).getUTCDay();return r===0?7:r}function Uee(t,e,i){return i+(U2(t)?Vee:zee)[e-1]}function jee(t,e){const i=U2(t)?Vee:zee,r=i.findIndex(n=>n<e),s=e-i[r];return{month:r+1,day:s}}function Mz(t){const{year:e,month:i,day:r}=t,s=Uee(e,i,r),n=Nee(e,i,r);let o=Math.floor((s-n+10)/7),a;return o<1?(a=e-1,o=ZA(a)):o>ZA(e)?(a=e+1,o=1):a=e,E({weekYear:a,weekNumber:o,weekday:n},XA(t))}function Bee(t){const{weekYear:e,weekNumber:i,weekday:r}=t,s=Nee(e,1,4),n=j2(e);let o=i*7+r-s-3,a;o<1?(a=e-1,o+=j2(a)):o>n?(a=e+1,o-=j2(e)):a=e;const{month:l,day:c}=jee(a,o);return E({year:a,month:l,day:c},XA(t))}function Pz(t){const{year:e,month:i,day:r}=t,s=Uee(e,i,r);return E({year:e,ordinal:s},XA(t))}function Gee(t){const{year:e,ordinal:i}=t,{month:r,day:s}=jee(e,i);return E({year:e,month:r,day:s},XA(t))}function gOe(t){const e=HA(t.weekYear),i=rd(t.weekNumber,1,ZA(t.weekYear)),r=rd(t.weekday,1,7);return e?i?r?!1:Ha("weekday",t.weekday):Ha("week",t.week):Ha("weekYear",t.weekYear)}function yOe(t){const e=HA(t.year),i=rd(t.ordinal,1,j2(t.year));return e?i?!1:Ha("ordinal",t.ordinal):Ha("year",t.year)}function qee(t){const e=HA(t.year),i=rd(t.month,1,12),r=rd(t.day,1,WA(t.year,t.month));return e?i?r?!1:Ha("day",t.day):Ha("month",t.month):Ha("year",t.year)}function Hee(t){const{hour:e,minute:i,second:r,millisecond:s}=t,n=rd(e,0,23)||e===24&&i===0&&r===0&&s===0,o=rd(i,0,59),a=rd(r,0,59),l=rd(s,0,999);return n?o?a?l?!1:Ha("millisecond",s):Ha("second",r):Ha("minute",i):Ha("hour",e)}const Az="Invalid DateTime",Wee=864e13;function r$(t){return new fc("unsupported zone",`the zone "${t.name}" is not supported`)}function $z(t){return t.weekData===null&&(t.weekData=Mz(t.c)),t.weekData}function H2(t,e){const i={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new gt(he(E(E({},i),e),{old:i}))}function Zee(t,e,i){let r=t-e*60*1e3;const s=i.offset(r);if(e===s)return[r,e];r-=(s-e)*60*1e3;const n=i.offset(r);return s===n?[r,s]:[t-Math.min(s,n)*60*1e3,Math.max(s,n)]}function Jee(t,e){t+=e*60*1e3;const i=new Date(t);return{year:i.getUTCFullYear(),month:i.getUTCMonth()+1,day:i.getUTCDate(),hour:i.getUTCHours(),minute:i.getUTCMinutes(),second:i.getUTCSeconds(),millisecond:i.getUTCMilliseconds()}}function s$(t,e,i){return Zee(hz(t),e,i)}function Qee(t,e){const i=t.o,r=t.c.year+Math.trunc(e.years),s=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,n=he(E({},t.c),{year:r,month:s,day:Math.min(t.c.day,WA(r,s))+Math.trunc(e.days)+Math.trunc(e.weeks)*7}),o=Yt.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),a=hz(n);let[l,c]=Zee(a,i,t.zone);return o!==0&&(l+=o,c=t.zone.offset(l)),{ts:l,o:c}}function W2(t,e,i,r,s){const{setZone:n,zone:o}=i;if(t&&Object.keys(t).length!==0){const a=e||o,l=gt.fromObject(t,he(E({},i),{zone:a}));return n?l:l.setZone(o)}else return gt.invalid(new fc("unparsable",`the input "${s}" can't be parsed as ${r}`))}function v_(t,e,i=!0){return t.isValid?To.create(pr.create("en-US"),{allowZ:i,forceSimple:!0}).formatDateTimeFromString(t,e):null}function Yee(t,{suppressSeconds:e=!1,suppressMilliseconds:i=!1,includeOffset:r,includePrefix:s=!1,includeZone:n=!1,spaceZone:o=!1,format:a="extended"}){let l=a==="basic"?"HHmm":"HH:mm";(!e||t.second!==0||t.millisecond!==0)&&(l+=a==="basic"?"ss":":ss",(!i||t.millisecond!==0)&&(l+=".SSS")),(n||r)&&o&&(l+=" "),n?l+="z":r&&(l+=a==="basic"?"ZZZ":"ZZ");let c=v_(t,l);return s&&(c="T"+c),c}const Xee={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},vOe={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},_Oe={ordinal:1,hour:0,minute:0,second:0,millisecond:0},Kee=["year","month","day","hour","minute","second","millisecond"],bOe=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],wOe=["year","ordinal","hour","minute","second","millisecond"];function ete(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new LK(t);return e}function tte(t,e){const i=Tf(e.zone,ns.defaultZone),r=pr.fromObject(e),s=ns.now();let n,o;if(ri(t.year))n=s;else{for(const c of Kee)ri(t[c])&&(t[c]=Xee[c]);const a=qee(t)||Hee(t);if(a)return gt.invalid(a);const l=i.offset(s);[n,o]=s$(t,l,i)}return new gt({ts:n,zone:i,loc:r,o})}function ite(t,e,i){const r=ri(i.round)?!0:i.round,s=(o,a)=>(o=uz(o,r||i.calendary?0:2,!0),e.loc.clone(i).relFormatter(i).format(o,a)),n=o=>i.calendary?e.hasSame(t,o)?0:e.startOf(o).diff(t.startOf(o),o).get(o):e.diff(t,o).get(o);if(i.unit)return s(n(i.unit),i.unit);for(const o of i.units){const a=n(o);if(Math.abs(a)>=1)return s(a,o)}return s(t>e?-0:0,i.units[i.units.length-1])}function rte(t){let e={},i;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],i=Array.from(t).slice(0,t.length-1)):i=Array.from(t),[e,i]}class gt{constructor(e){const i=e.zone||ns.defaultZone;let r=e.invalid||(Number.isNaN(e.ts)?new fc("invalid input"):null)||(i.isValid?null:r$(i));this.ts=ri(e.ts)?ns.now():e.ts;let s=null,n=null;if(!r)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(i))[s,n]=[e.old.c,e.old.o];else{const a=i.offset(this.ts);s=Jee(this.ts,a),r=Number.isNaN(s.year)?new fc("invalid input"):null,s=r?null:s,n=r?null:a}this._zone=i,this.loc=e.loc||pr.create(),this.invalid=r,this.weekData=null,this.c=s,this.o=n,this.isLuxonDateTime=!0}static now(){return new gt({})}static local(){const[e,i]=rte(arguments),[r,s,n,o,a,l,c]=i;return tte({year:r,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},e)}static utc(){const[e,i]=rte(arguments),[r,s,n,o,a,l,c]=i;return e.zone=Bn.utcInstance,tte({year:r,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},e)}static fromJSDate(e,i={}){const r=E$e(e)?e.valueOf():NaN;if(Number.isNaN(r))return gt.invalid("invalid input");const s=Tf(i.zone,ns.defaultZone);return s.isValid?new gt({ts:r,zone:s,loc:pr.fromObject(i)}):gt.invalid(r$(s))}static fromMillis(e,i={}){if(Iy(e))return e<-Wee||e>Wee?gt.invalid("Timestamp out of range"):new gt({ts:e,zone:Tf(i.zone,ns.defaultZone),loc:pr.fromObject(i)});throw new Ga(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,i={}){if(Iy(e))return new gt({ts:e*1e3,zone:Tf(i.zone,ns.defaultZone),loc:pr.fromObject(i)});throw new Ga("fromSeconds requires a numerical input")}static fromObject(e,i={}){e=e||{};const r=Tf(i.zone,ns.defaultZone);if(!r.isValid)return gt.invalid(r$(r));const s=ns.now(),n=r.offset(s),o=QA(e,ete),a=!ri(o.ordinal),l=!ri(o.year),c=!ri(o.month)||!ri(o.day),h=l||c,p=o.weekYear||o.weekNumber,f=pr.fromObject(i);if((h||a)&&p)throw new N2("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&a)throw new N2("Can't mix ordinal dates with month/day");const g=p||o.weekday&&!h;let y,v,b=Jee(s,n);g?(y=bOe,v=vOe,b=Mz(b)):a?(y=wOe,v=_Oe,b=Pz(b)):(y=Kee,v=Xee);let w=!1;for(const z of y){const D=o[z];ri(D)?w?o[z]=v[z]:o[z]=b[z]:w=!0}const S=g?gOe(o):a?yOe(o):qee(o),T=S||Hee(o);if(T)return gt.invalid(T);const C=g?Bee(o):a?Gee(o):o,[M,P]=s$(C,n,r),F=new gt({ts:M,zone:r,o:P,loc:f});return o.weekday&&h&&e.weekday!==F.weekday?gt.invalid("mismatched weekday",`you can't specify both a weekday of ${o.weekday} and a date of ${F.toISO()}`):F}static fromISO(e,i={}){const[r,s]=DEe(e);return W2(r,s,i,"ISO 8601",e)}static fromRFC2822(e,i={}){const[r,s]=FEe(e);return W2(r,s,i,"RFC 2822",e)}static fromHTTP(e,i={}){const[r,s]=LEe(e);return W2(r,s,i,"HTTP",i)}static fromFormat(e,i,r={}){if(ri(e)||ri(i))throw new Ga("fromFormat requires an input string and a format");const{locale:s=null,numberingSystem:n=null}=r,o=pr.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0}),[a,l,c]=mOe(o,e,i);return c?gt.invalid(c):W2(a,l,r,`format ${i}`,e)}static fromString(e,i,r={}){return gt.fromFormat(e,i,r)}static fromSQL(e,i={}){const[r,s]=GEe(e);return W2(r,s,i,"SQL",e)}static invalid(e,i=null){if(!e)throw new Ga("need to specify a reason the DateTime is invalid");const r=e instanceof fc?e:new fc(e,i);if(ns.throwOnInvalid)throw new T$e(r);return new gt({invalid:r})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?$z(this).weekYear:NaN}get weekNumber(){return this.isValid?$z(this).weekNumber:NaN}get weekday(){return this.isValid?$z(this).weekday:NaN}get ordinal(){return this.isValid?Pz(this.c).ordinal:NaN}get monthShort(){return this.isValid?i$.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?i$.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?i$.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?i$.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1}).offset||this.offset>this.set({month:5}).offset}get isInLeapYear(){return U2(this.year)}get daysInMonth(){return WA(this.year,this.month)}get daysInYear(){return this.isValid?j2(this.year):NaN}get weeksInWeekYear(){return this.isValid?ZA(this.weekYear):NaN}resolvedLocaleOptions(e={}){const{locale:i,numberingSystem:r,calendar:s}=To.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:i,numberingSystem:r,outputCalendar:s}}toUTC(e=0,i={}){return this.setZone(Bn.instance(e),i)}toLocal(){return this.setZone(ns.defaultZone)}setZone(e,{keepLocalTime:i=!1,keepCalendarTime:r=!1}={}){if(e=Tf(e,ns.defaultZone),e.equals(this.zone))return this;if(e.isValid){let s=this.ts;if(i||r){const n=e.offset(this.ts),o=this.toObject();[s]=s$(o,n,e)}return H2(this,{ts:s,zone:e})}else return gt.invalid(r$(e))}reconfigure({locale:e,numberingSystem:i,outputCalendar:r}={}){const s=this.loc.clone({locale:e,numberingSystem:i,outputCalendar:r});return H2(this,{loc:s})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const i=QA(e,ete),r=!ri(i.weekYear)||!ri(i.weekNumber)||!ri(i.weekday),s=!ri(i.ordinal),n=!ri(i.year),o=!ri(i.month)||!ri(i.day),a=n||o,l=i.weekYear||i.weekNumber;if((a||s)&&l)throw new N2("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(o&&s)throw new N2("Can't mix ordinal dates with month/day");let c;r?c=Bee(E(E({},Mz(this.c)),i)):ri(i.ordinal)?(c=E(E({},this.toObject()),i),ri(i.day)&&(c.day=Math.min(WA(c.year,c.month),c.day))):c=Gee(E(E({},Pz(this.c)),i));const[h,p]=s$(c,this.o,this.zone);return H2(this,{ts:h,o:p})}plus(e){if(!this.isValid)return this;const i=Yt.fromDurationLike(e);return H2(this,Qee(this,i))}minus(e){if(!this.isValid)return this;const i=Yt.fromDurationLike(e).negate();return H2(this,Qee(this,i))}startOf(e){if(!this.isValid)return this;const i={},r=Yt.normalizeUnit(e);switch(r){case"years":i.month=1;case"quarters":case"months":i.day=1;case"weeks":case"days":i.hour=0;case"hours":i.minute=0;case"minutes":i.second=0;case"seconds":i.millisecond=0;break}if(r==="weeks"&&(i.weekday=1),r==="quarters"){const s=Math.ceil(this.month/3);i.month=(s-1)*3+1}return this.set(i)}endOf(e){return this.isValid?this.plus({[e]:1}).startOf(e).minus(1):this}toFormat(e,i={}){return this.isValid?To.create(this.loc.redefaultToEN(i)).formatDateTimeFromString(this,e):Az}toLocaleString(e=lz,i={}){return this.isValid?To.create(this.loc.clone(i),e).formatDateTime(this):Az}toLocaleParts(e={}){return this.isValid?To.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO(e={}){return this.isValid?`${this.toISODate(e)}T${this.toISOTime(e)}`:null}toISODate({format:e="extended"}={}){let i=e==="basic"?"yyyyMMdd":"yyyy-MM-dd";return this.year>9999&&(i="+"+i),v_(this,i)}toISOWeekDate(){return v_(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:i=!1,includeOffset:r=!0,includePrefix:s=!1,format:n="extended"}={}){return Yee(this,{suppressSeconds:i,suppressMilliseconds:e,includeOffset:r,includePrefix:s,format:n})}toRFC2822(){return v_(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return v_(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return v_(this,"yyyy-MM-dd")}toSQLTime({includeOffset:e=!0,includeZone:i=!1}={}){return Yee(this,{includeOffset:e,includeZone:i,spaceZone:!0})}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():Az}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const i=E({},this.c);return e.includeConfig&&(i.outputCalendar=this.outputCalendar,i.numberingSystem=this.loc.numberingSystem,i.locale=this.loc.locale),i}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,i="milliseconds",r={}){if(!this.isValid||!e.isValid)return Yt.invalid("created by diffing an invalid DateTime");const s=E({locale:this.locale,numberingSystem:this.numberingSystem},r),n=O$e(i).map(Yt.normalizeUnit),o=e.valueOf()>this.valueOf(),a=o?this:e,l=o?e:this,c=KEe(a,l,n,s);return o?c.negate():c}diffNow(e="milliseconds",i={}){return this.diff(gt.now(),e,i)}until(e){return this.isValid?wr.fromDateTimes(this,e):this}hasSame(e,i){if(!this.isValid)return!1;const r=e.valueOf(),s=this.setZone(e.zone,{keepLocalTime:!0});return s.startOf(i)<=r&&r<=s.endOf(i)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const i=e.base||gt.fromObject({},{zone:this.zone}),r=e.padding?this<i?-e.padding:e.padding:0;let s=["years","months","days","hours","minutes","seconds"],n=e.unit;return Array.isArray(e.unit)&&(s=e.unit,n=void 0),ite(i,this.plus(r),he(E({},e),{numeric:"always",units:s,unit:n}))}toRelativeCalendar(e={}){return this.isValid?ite(e.base||gt.fromObject({},{zone:this.zone}),this,he(E({},e),{numeric:"auto",units:["years","months","days"],calendary:!0})):null}static min(...e){if(!e.every(gt.isDateTime))throw new Ga("min requires all arguments be DateTimes");return ree(e,i=>i.valueOf(),Math.min)}static max(...e){if(!e.every(gt.isDateTime))throw new Ga("max requires all arguments be DateTimes");return ree(e,i=>i.valueOf(),Math.max)}static fromFormatExplain(e,i,r={}){const{locale:s=null,numberingSystem:n=null}=r,o=pr.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0});return kee(o,e,i)}static fromStringExplain(e,i,r={}){return gt.fromFormatExplain(e,i,r)}static get DATE_SHORT(){return lz}static get DATE_MED(){return kK}static get DATE_MED_WITH_WEEKDAY(){return P$e}static get DATE_FULL(){return zK}static get DATE_HUGE(){return VK}static get TIME_SIMPLE(){return NK}static get TIME_WITH_SECONDS(){return UK}static get TIME_WITH_SHORT_OFFSET(){return jK}static get TIME_WITH_LONG_OFFSET(){return BK}static get TIME_24_SIMPLE(){return GK}static get TIME_24_WITH_SECONDS(){return qK}static get TIME_24_WITH_SHORT_OFFSET(){return HK}static get TIME_24_WITH_LONG_OFFSET(){return WK}static get DATETIME_SHORT(){return ZK}static get DATETIME_SHORT_WITH_SECONDS(){return JK}static get DATETIME_MED(){return QK}static get DATETIME_MED_WITH_SECONDS(){return YK}static get DATETIME_MED_WITH_WEEKDAY(){return A$e}static get DATETIME_FULL(){return XK}static get DATETIME_FULL_WITH_SECONDS(){return KK}static get DATETIME_HUGE(){return eee}static get DATETIME_HUGE_WITH_SECONDS(){return tee}}function Z2(t){if(gt.isDateTime(t))return t;if(t&&t.valueOf&&Iy(t.valueOf()))return gt.fromJSDate(t);if(t&&typeof t=="object")return gt.fromObject(t);throw new Ga(`Unknown datetime argument: ${t}, of type ${typeof t}`)}const Ez={ar:[".",","],bg:[",","\xA0"],bs:[",","."],ca:[",","."],cs:[",","\xA0"],da:[",","."],de:[",","."],"de-ch":[".","\u2019"],el:[",","."],en:[".",","],"en-au":[".",","],es:[",","."],"es-mx":[".",","],et:[",","\xA0"],fi:[",","\xA0"],fr:[",","\u202F"],"fr-ch":[",","\u202F"],he:[".",","],hi:[".",",","#,##,##0.###"],hr:[",","."],hu:[",","\xA0"],id:[",","."],it:[",","."],"it-ch":[".","\u2019"],ja:[".",","],ko:[".",","],lt:[",","\xA0"],lv:[",","\xA0"],mk:[",","."],nb:[",","\xA0"],nl:[",","."],pl:[",","\xA0"],pt:[",","."],"pt-pt":[",","\xA0"],ro:[",","."],ru:[",","\xA0"],sk:[",","\xA0"],sl:[",","."],sr:[",","."],sv:[",","\xA0"],th:[".",","],tr:[",","."],uk:[",","\xA0"],vi:[",","."],zh:[".",","]};function ste(t){t||(t=La());let e=t in Ez;if(!e){const n=t.split("-");n.length>1&&n[0]in Ez&&(t=n[0],e=!0),e||(t="en")}const[i,r,s="#,##0.###"]=Ez[t];return{decimal:i,group:r,pattern:s}}function xOe(t,e){const i=ste((e=E({},e)).locale);e.customs=i;const r=e.pattern||i.pattern;return isNaN(t)||Math.abs(t)===1/0?null:SOe(t,r,e)}const nte=/[#0,]*[#0](?:\.0*#*)?/;function SOe(t,e,i){const r=(i=i||{}).customs.group,s=i.customs.decimal,n=e.split(";"),o=n[0];if((e=n[t<0?1:0]||"-"+o).indexOf("%")!==-1)t*=100;else if(e.indexOf("\u2030")!==-1)t*=1e3;else{if(e.indexOf("\xA4")!==-1)throw new Error("currency notation not supported");if(e.indexOf("E")!==-1)throw new Error("exponential notation not supported")}const a=nte,l=o.match(a);if(!l)throw new Error("unable to find a number expression in pattern: "+e);return i.fractional===!1&&(i.places=0),e.replace(a,TOe(t,l[0],{decimal:s,group:r,places:i.places,round:i.round}))}function TOe(t,e,i){(i=i||{}).places===!0&&(i.places=0),i.places===1/0&&(i.places=6);const r=e.split("."),s=typeof i.places=="string"&&i.places.indexOf(",");let n=i.places;s?n=i.places.substring(s+1):n>=0||(n=(r[1]||[]).length),i.round<0||(t=Number(t.toFixed(Number(n))));const o=String(Math.abs(t)).split("."),a=o[1]||"";if(r[1]||i.places){s&&(i.places=i.places.substring(0,s));const y=i.places!==void 0?i.places:r[1]&&r[1].lastIndexOf("0")+1;y>a.length&&(o[1]=a.padEnd(Number(y),"0")),n<a.length&&(o[1]=a.substr(0,Number(n)))}else o[1]&&o.pop();const l=r[0].replace(",","");let c=l.indexOf("0");c!==-1&&(c=l.length-c,c>o[0].length&&(o[0]=o[0].padStart(c,"0")),l.indexOf("#")===-1&&(o[0]=o[0].substr(o[0].length-c)));let h,p,f=r[0].lastIndexOf(",");if(f!==-1){h=r[0].length-f-1;const y=r[0].substr(0,f);f=y.lastIndexOf(","),f!==-1&&(p=y.length-f-1)}const g=[];for(let y=o[0];y;){const v=y.length-h;g.push(v>0?y.substr(v):y),y=v>0?y.slice(0,v):"",p&&(h=p,p=void 0)}return o[0]=g.reverse().join(i.group||","),o.join(i.decimal||".")}function COe(t){const e=ste((t=t||{}).locale),i=t.pattern||e.pattern,r=e.group,s=e.decimal;let n=1;if(i.indexOf("%")!==-1)n/=100;else if(i.indexOf("\u2030")!==-1)n/=1e3;else if(i.indexOf("\xA4")!==-1)throw new Error("currency notation not supported");const o=i.split(";");return o.length===1&&o.push("-"+o[0]),{regexp:J2(o,function(l){return(l="(?:"+JB(l,".")+")").replace(nte,function(c){const h={signed:!1,separator:t.strict?r:[r,""],fractional:t.fractional,decimal:s,exponent:!1},p=c.split(".");let f=t.places;p.length===1&&n!==1&&(p[1]="###"),p.length===1||f===0?h.fractional=!1:(f===void 0&&(f=t.pattern?p[1].lastIndexOf("0")+1:1/0),f&&t.fractional==null&&(h.fractional=!0),!t.places&&f<p[1].length&&(f+=","+p[1].length),h.places=f);const g=p[0].split(",");return g.length>1&&(h.groupSize=g.pop().length,g.length>1&&(h.groupSize2=g.pop().length)),"("+POe(h)+")"})},!0).replace(/[\xa0 ]/g,"[\\s\\xa0]"),group:r,decimal:s,factor:n}}function MOe(t,e){const i=COe(e),r=new RegExp("^"+i.regexp+"$").exec(t);if(!r)return NaN;let s=r[1];if(!r[1]){if(!r[2])return NaN;s=r[2],i.factor*=-1}return s=s.replace(new RegExp("["+i.group+"\\s\\xa0]","g"),"").replace(i.decimal,"."),Number(s)*i.factor}function POe(t){"places"in(t=t||{})||(t.places=1/0),typeof t.decimal!="string"&&(t.decimal="."),"fractional"in t&&!/^0/.test(String(t.places))||(t.fractional=[!0,!1]),"exponent"in t||(t.exponent=[!0,!1]),"eSigned"in t||(t.eSigned=[!0,!1]);const e=ote(t),i=J2(t.fractional,function(s){let n="";return s&&t.places!==0&&(n="\\"+t.decimal,t.places===1/0?n="(?:"+n+"\\d+)?":n+="\\d{"+t.places+"}"),n},!0);let r=e+i;return i&&(r="(?:(?:"+r+")|(?:"+i+"))"),r+J2(t.exponent,function(s){return s?"([eE]"+ote({signed:t.eSigned})+")":""})}function ote(t){return"signed"in(t=t||{})||(t.signed=[!0,!1]),"separator"in t?"groupSize"in t||(t.groupSize=3):t.separator="",J2(t.signed,function(e){return e?"[-+]":""},!0)+J2(t.separator,function(e){if(!e)return"(?:\\d+)";(e=JB(e))===" "?e="\\s":e==="\xA0"&&(e="\\s\\xa0");const i=t.groupSize,r=t.groupSize2;if(r){const s="(?:0|[1-9]\\d{0,"+(r-1)+"}(?:["+e+"]\\d{"+r+"})*["+e+"]\\d{"+i+"})";return i-r>0?"(?:"+s+"|(?:0|[1-9]\\d{0,"+(i-1)+"}))":s}return"(?:0|[1-9]\\d{0,"+(i-1)+"}(?:["+e+"]\\d{"+i+"})*)"},!0)}const J2=function(t,e,i){if(!(t instanceof Array))return e(t);const r=[];for(let s=0;s<t.length;s++)r.push(e(t[s]));return AOe(r.join("|"),i)},AOe=function(t,e){return"("+(e?"?:":"")+t+")"};class ate{constructor(e){this.value=e}}class lte{constructor(e){this.value=e}}class Oz{constructor(e){this.fn=e}}class Rz{constructor(e,i){this.paramCount=i,this.fn=e}}const $Oe=Oz,EOe=lte,OOe=ate,ROe=Rz,aa={type:"VOID"},IOe={type:"BREAK"},DOe={type:"CONTINUE"};function Q2(t,e,i){return e===""||e==null||e===i||e===i?t:t=t.split(e).join(i)}function Iz(t){return t instanceof Oz||t instanceof S$e||t instanceof Rz}function n$(t){return!!Zs(t)||!!qn(t)||!!mn(t)||!!Gn(t)||t===null||t===aa||typeof t=="number"}function FOe(t,e){return t===void 0?e:t}function Zs(t){return typeof t=="string"||t instanceof String}function Gn(t){return typeof t=="boolean"}function qn(t){return typeof t=="number"}function LOe(t){return typeof t=="number"&&isFinite(t)&&Math.floor(t)===t}function Wa(t){return t instanceof Array}function kOe(t){return(t&&t.declaredRootClass&&t.declaredRootClass==="esri.arcade.featureset.support.FeatureSet")===!0}function zOe(t){return(t&&t.declaredRootClass&&t.declaredRootClass==="esri.arcade.featureSetCollection")===!0}function zy(t){return t instanceof Mu}function mn(t){return t instanceof Date}function VOe(t,e,i){if(t.length<e||t.length>i)throw new Error("Function called with wrong number of Parameters")}function NOe(t){return t<0?-Math.round(-t):Math.round(t)}function UOe(){let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),(e==="x"?i:3&i|8).toString(16)})}function Dz(t,e){return isNaN(t)===!1?e==null||e===""?t.toString():(e=Q2(e,"\u2030",""),e=Q2(e,"\xA4",""),xOe(t,{pattern:e})):t.toString()}function o$(t,e){const i=gt.fromJSDate(t);return e==null||e===""?i.toISO({suppressMilliseconds:!0}):i.toFormat(cte(e),{locale:La(),numberingSystem:"latn"})}function cte(t){t=t.replace(/LTS|LT|LL?L?L?|l{1,4}/g,"[$&]");let e="";const i=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|N{1,5}|YYYYYY|YYYYY|YYYY|YY|y{2,4}|yo?|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g;for(const r of t.match(i))switch(r){case"D":e+="d";break;case"DD":e+="dd";break;case"DDD":e+="o";break;case"d":e+="c";break;case"ddd":e+="ccc";break;case"dddd":e+="cccc";break;case"M":e+="L";break;case"MM":e+="LL";break;case"MMM":e+="LLL";break;case"MMMM":e+="LLLL";break;case"YY":e+="yy";break;case"Y":case"YYYY":e+="yyyy";break;case"Q":e+="q";break;case"Z":e+="ZZ";break;case"ZZ":e+="ZZZ";break;case"S":e+="'S'";break;case"SS":e+="'SS'";break;case"SSS":e+="u";break;case"A":case"a":e+="a";break;case"m":case"mm":case"h":case"hh":case"H":case"HH":case"s":case"ss":case"X":case"x":e+=r;break;default:r.length>=2&&r.slice(0,1)==="["&&r.slice(-1)==="]"?e+=`'${r.slice(1,-1)}'`:e+=`'${r}'`}return e}function di(t,e,i){switch(i){case">":return t>e;case"<":return t<e;case">=":return t>=e;case"<=":return t<=e}return!1}function jOe(t,e,i){if(t===null){if(e===null||e===aa)return di(null,null,i);if(qn(e))return di(0,e,i);if(Zs(e)||Gn(e))return di(0,fr(e),i);if(mn(e))return di(0,e.getTime(),i)}if(t===aa){if(e===null||e===aa)return di(null,null,i);if(qn(e))return di(0,e,i);if(Zs(e)||Gn(e))return di(0,fr(e),i);if(mn(e))return di(0,e.getTime(),i)}else if(qn(t)){if(qn(e))return di(t,e,i);if(Gn(e))return di(t,fr(e),i);if(e===null||e===aa)return di(t,0,i);if(Zs(e))return di(t,fr(e),i);if(mn(e))return di(t,e.getTime(),i)}else if(Zs(t)){if(Zs(e))return di(Cf(t),Cf(e),i);if(mn(e))return di(fr(t),e.getTime(),i);if(qn(e))return di(fr(t),e,i);if(e===null||e===aa)return di(fr(t),0,i);if(Gn(e))return di(fr(t),fr(e),i)}else if(mn(t)){if(mn(e))return di(t,e,i);if(e===null||e===aa)return di(t.getTime(),0,i);if(qn(e))return di(t.getTime(),e,i);if(Gn(e)||Zs(e))return di(t.getTime(),fr(e),i)}else if(Gn(t)){if(Gn(e))return di(t,e,i);if(qn(e))return di(fr(t),fr(e),i);if(mn(e))return di(fr(t),e.getTime(),i);if(e===null||e===aa)return di(fr(t),0,i);if(Zs(e))return di(fr(t),fr(e),i)}return!!ute(t,e)&&(i==="<="||i===">=")}function ute(t,e){if(t===e||t===null&&e===aa||e===null&&t===aa)return!0;if(mn(t)&&mn(e))return t.getTime()===e.getTime();if(t instanceof az||t instanceof Oy)return t.equalityTest(e);if(t instanceof je&&e instanceof je){const i=t.cache._arcadeCacheId,r=e.cache._arcadeCacheId;if(i!=null)return i===r}return t!==void 0&&e!==void 0&&t!==null&&e!==null&&typeof t=="object"&&typeof e=="object"&&(t._arcadeCacheId===e._arcadeCacheId&&t._arcadeCacheId!==void 0&&t._arcadeCacheId!==null||t._underlyingGraphic===e._underlyingGraphic&&t._underlyingGraphic!==void 0&&t._underlyingGraphic!==null)}function Cf(t,e){if(Zs(t))return t;if(t===null)return"";if(qn(t))return Dz(t,e);if(Gn(t))return t.toString();if(mn(t))return o$(t,e);if(t instanceof ho)return JSON.stringify(t.toJSON());if(Wa(t)){const i=[];for(let r=0;r<t.length;r++)i[r]=l$(t[r]);return"["+i.join(",")+"]"}if(t instanceof Mu){const i=[];for(let r=0;r<t.length();r++)i[r]=l$(t.get(r));return"["+i.join(",")+"]"}return t!==null&&typeof t=="object"&&t.castToText!==void 0?t.castToText():Iz(t)?"object, Function":""}function BOe(t){const e=[];if(Wa(t)===!1)return null;if(t instanceof Mu){for(let i=0;i<t.length();i++)e[i]=fr(t.get(i));return e}for(let i=0;i<t.length;i++)e[i]=fr(t[i]);return e}function a$(t,e){if(Zs(t))return t;if(t===null)return"";if(qn(t))return Dz(t,e);if(Gn(t))return t.toString();if(mn(t))return o$(t,e);if(t instanceof ho)return t instanceof ht?'{"xmin":'+t.xmin.toString()+',"ymin":'+t.ymin.toString()+","+(t.hasZ?'"zmin":'+t.zmin.toString()+",":"")+(t.hasM?'"mmin":'+t.mmin.toString()+",":"")+'"xmax":'+t.xmax.toString()+',"ymax":'+t.ymax.toString()+","+(t.hasZ?'"zmax":'+t.zmax.toString()+",":"")+(t.hasM?'"mmax":'+t.mmax.toString()+",":"")+'"spatialReference":'+Fz(t.spatialReference)+"}":Fz(t.toJSON(),(i,r)=>i.key===r.key?0:i.key==="spatialReference"?1:r.key==="spatialReference"||i.key<r.key?-1:i.key>r.key?1:0);if(Wa(t)){const i=[];for(let r=0;r<t.length;r++)i[r]=l$(t[r]);return"["+i.join(",")+"]"}if(t instanceof Mu){const i=[];for(let r=0;r<t.length();r++)i[r]=l$(t.get(r));return"["+i.join(",")+"]"}return t!==null&&typeof t=="object"&&t.castToText!==void 0?t.castToText():Iz(t)?"object, Function":""}function l$(t){if(t===null)return"null";if(Gn(t)||qn(t)||Zs(t))return JSON.stringify(t);if(t instanceof ho||t instanceof Mu||t instanceof Array)return a$(t);if(t instanceof Date)return JSON.stringify(o$(t,""));if(t!==null&&typeof t=="object"){if(t.castToText!==void 0)return t.castToText()}else if(t===aa)return"null";return"null"}function fr(t,e){return qn(t)?t:t===null||t===""?0:mn(t)?NaN:Gn(t)?t?1:0:Wa(t)||t===""||t===void 0?NaN:e!==void 0&&Zs(t)?(e=Q2(e,"\u2030",""),e=Q2(e,"\xA4",""),MOe(t,{pattern:e})):t===aa?0:Number(t)}function GOe(t){if(mn(t))return t;if(Zs(t)){const e=hte(t);if(e)return e.toJSDate()}return null}function qOe(t){return mn(t)?gt.fromJSDate(t):Zs(t)?hte(t):null}function hte(t){const e=/ (\d\d)/;let i=gt.fromISO(t);return i.isValid||e.test(t)&&(t=t.replace(e,"T$1"),i=gt.fromISO(t),i.isValid)?i:null}function HOe(t){return Gn(t)?t:Zs(t)?(t=t.toLowerCase())==="true":!!qn(t)&&t!==0&&!isNaN(t)}function WOe(t,e){return A(t)?null:(t.spatialReference!==null&&t.spatialReference!==void 0||(t.spatialReference=e),t)}function ZOe(t){if(t===null)return null;if(t instanceof je)return t.x==="NaN"||t.x===null||isNaN(t.x)?null:t;if(t instanceof Zo){if(t.rings.length===0)return null;for(const e of t.rings)if(e.length>0)return t;return null}if(t instanceof Jo){if(t.paths.length===0)return null;for(const e of t.paths)if(e.length>0)return t;return null}return t instanceof $g?t.points.length===0?null:t:t instanceof ht?t.xmin==="NaN"||t.xmin===null||isNaN(t.xmin)?null:t:null}function JOe(t,e){if(!t||!t.domain)return e;let i=null;if(t.field.type==="string"||t.field.type==="esriFieldTypeString")e=Cf(e);else{if(e==null)return null;if(e==="")return e;e=fr(e)}for(let r=0;r<t.domain.codedValues.length;r++){const s=t.domain.codedValues[r];s.code===e&&(i=s)}return i===null?e:i.name}function QOe(t,e){if(!t||!t.domain)return e;let i=null;e=Cf(e);for(let r=0;r<t.domain.codedValues.length;r++){const s=t.domain.codedValues[r];s.name===e&&(i=s)}return i===null?e:i.code}function YOe(t,e,i=null,r){if(!e||!e.fields)return null;let s,n,o=null;for(let a=0;a<e.fields.length;a++){const l=e.fields[a];l.name.toLowerCase()===t.toString().toLowerCase()&&(o=l)}if(o===null)throw new Error("Field not found");return r||(r=i&&e.typeIdField&&i._field(e.typeIdField)),r!=null&&e.types.some(function(a){return a.id===r&&(s=a.domains&&a.domains[o.name],s&&s.type==="inherited"&&(s=dte(o.name,e),n=!0),!0)}),n||s||(s=dte(t,e)),{field:o,domain:s}}function dte(t,e){let i;return e.fields.some(function(r){return r.name.toLowerCase()===t.toLowerCase()&&(i=r.domain),!!i}),i}function Fz(t,e){e||(e={}),typeof e=="function"&&(e={cmp:e});const i=typeof e.cycles=="boolean"&&e.cycles,r=e.cmp&&(s=e.cmp,function(o){return function(a,l){const c={key:a,value:o[a]},h={key:l,value:o[l]};return s(c,h)}});var s;const n=[];return function o(a){if(a&&a.toJSON&&typeof a.toJSON=="function"&&(a=a.toJSON()),a===void 0)return;if(typeof a=="number")return isFinite(a)?""+a:"null";if(typeof a!="object")return JSON.stringify(a);let l,c;if(Array.isArray(a)){for(c="[",l=0;l<a.length;l++)l&&(c+=","),c+=o(a[l])||"null";return c+"]"}if(a===null)return"null";if(n.indexOf(a)!==-1){if(i)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}const h=n.push(a)-1,p=Object.keys(a).sort(r&&r(a));for(c="",l=0;l<p.length;l++){const f=p[l],g=o(a[f]);g&&(c&&(c+=","),c+=JSON.stringify(f)+":"+g)}return n.splice(h,1),"{"+c+"}"}(t)}function XOe(t){if(t===null)return null;const e=[];for(const i of t)i&&(i.declaredClass&&i.declaredClass==="esri.arcade.Feature"||i.type==="FeatureSetReader")?e.push(i.geometry()):e.push(i);return e}function __(t,e){if(!(e instanceof je))throw new Error("Invalid Argument");t.push(e.hasZ?e.hasM?[e.x,e.y,e.z,e.m]:[e.x,e.y,e.z]:[e.x,e.y])}function KOe(t,e){if(Wa(t)||zy(t)){let i=!1,r=!1,s=[],n=e;if(Wa(t)){for(const o of t)__(s,o);s.length>0&&(n=t[0].spatialReference,i=t[0].hasZ,r=t[0].hasM)}else if(t instanceof Oy)s=t._elements,s.length>0&&(i=t._hasZ,r=t._hasM,n=t.get(0).spatialReference);else{if(!zy(t))throw new Error("Invalid Argument");for(const o of t.toArray())__(s,o);s.length>0&&(n=t.get(0).spatialReference,i=t.get(0).hasZ===!0,r=t.get(0).hasM===!0)}return s.length===0?null:(BF(s,r,i)===!1&&(s=s.slice(0).reverse()),new Zo({rings:[s],spatialReference:n,hasZ:i,hasM:r}))}return t}function eRe(t,e){if(Wa(t)||zy(t)){let i=!1,r=!1,s=[],n=e;if(Wa(t)){for(const o of t)__(s,o);s.length>0&&(n=t[0].spatialReference,i=t[0].hasZ===!0,r=t[0].hasM===!0)}else if(t instanceof Oy)s=t._elements,s.length>0&&(i=t._hasZ,r=t._hasM,n=t.get(0).spatialReference);else if(zy(t)){for(const o of t.toArray())__(s,o);s.length>0&&(n=t.get(0).spatialReference,i=t.get(0).hasZ===!0,r=t.get(0).hasM===!0)}return s.length===0?null:new Jo({paths:[s],spatialReference:n,hasZ:i,hasM:r})}return t}function tRe(t,e){if(Wa(t)||zy(t)){let i=!1,r=!1,s=[],n=e;if(Wa(t)){for(const o of t)__(s,o);s.length>0&&(n=t[0].spatialReference,i=t[0].hasZ===!0,r=t[0].hasM===!0)}else if(t instanceof Oy)s=t._elements,s.length>0&&(i=t._hasZ,r=t._hasM,n=t.get(0).spatialReference);else if(zy(t)){for(const o of t.toArray())__(s,o);s.length>0&&(n=t.get(0).spatialReference,i=t.get(0).hasZ===!0,r=t.get(0).hasM===!0)}return s.length===0?null:new $g({points:s,spatialReference:n,hasZ:i,hasM:r})}return t}function iRe(t,e=!1){const i=[];if(t===null)return i;if(Wa(t)===!0){for(let r=0;r<t.length;r++){const s=Cf(t[r]);s===""&&e!==!0||i.push(s)}return i}if(t instanceof Mu){for(let r=0;r<t.length();r++){const s=Cf(t.get(r));s===""&&e!==!0||i.push(s)}return i}if(n$(t)){const r=Cf(t);return r===""&&e!==!0||i.push(r),i}return[]}let Lz=0;function rRe(t){return Lz++,Lz%100==0?(Lz=0,gG(e=>{setTimeout(()=>{e(t)},0)})):t}function sRe(t,e,i){switch(i){case"&":return t&e;case"|":return t|e;case"^":return t^e;case"<<":return t<<e;case">>":return t>>e;case">>>":return t>>>e}}function Y2(t,e=null){return t==null?null:Gn(t)||qn(t)||Zs(t)?t:t instanceof ho?(e==null?void 0:e.keepGeometryType)===!0?t:t.toJSON():t instanceof Mu?t.toArray().map(i=>Y2(i,e)):t instanceof Array?t.map(i=>Y2(i,e)):t instanceof Date?t:t!==null&&typeof t=="object"&&t.castAsJson!==void 0?t.castAsJson(e):null}function nRe(t,e,i,r,s){return kz(t,e,i).then(n=>{s[r]=n})}function kz(t,e=null,i=null){if(t instanceof Mu&&(t=t.toArray()),t==null)return Ww(null);if(n$(t)||t instanceof ho||t instanceof Date)return Ww(Y2(t,i));if(t instanceof Array){const r=[],s=[];for(const n of t)n===null||n$(n)||n instanceof ho||n instanceof Date?s.push(Y2(n,i)):(s.push(null),r.push(nRe(n,e,i,s.length-1,s)));return r.length>0?mD(r).then(()=>s):Ww(s)}return t!==null&&typeof t=="object"&&t.castAsJsonAsync!==void 0?t.castAsJsonAsync(e,i):Ww(null)}const zot=Object.freeze({__proto__:null,ReturnResultE:ate,ImplicitResultE:lte,NativeFunctionE:Oz,SizzleFunctionE:Rz,NativeFunction:$Oe,ImplicitResult:EOe,ReturnResult:OOe,SizzleFunction:ROe,voidOperation:aa,breakResult:IOe,continueResult:DOe,multiReplace:Q2,isFunctionParameter:Iz,isSimpleType:n$,defaultUndefined:FOe,isString:Zs,isBoolean:Gn,isNumber:qn,isInteger:LOe,isArray:Wa,isFeatureSet:kOe,isFeatureSetCollection:zOe,isImmutableArray:zy,isDate:mn,pcCheck:VOe,absRound:NOe,generateUUID:UOe,formatNumber:Dz,formatDate:o$,standardiseDateFormat:cte,greaterThanLessThan:jOe,equalityTest:ute,toString:Cf,toNumberArray:BOe,toStringExplicit:a$,toNumber:fr,toDate:GOe,toDateTime:qOe,toBoolean:HOe,fixSpatialReference:WOe,fixNullGeometry:ZOe,getDomainValue:JOe,getDomainCode:QOe,getDomain:YOe,stableStringify:Fz,autoCastFeatureToGeometry:XOe,autoCastArrayOfPointsToPolygon:KOe,autoCastArrayOfPointsToPolyline:eRe,autoCastArrayOfPointsToMultiPoint:tRe,toStringArray:iRe,tick:rRe,binaryOperator:sRe,castAsJson:Y2,castAsJsonAsync:kz});var zz;let X2=zz=class extends ge{constructor(t){super(t),this.minValue=0,this.maxValue=0}clone(){return new zz({minValue:this.minValue,maxValue:this.maxValue})}};u([d({type:Number,json:{write:!0}})],X2.prototype,"minValue",void 0),u([d({type:Number,json:{write:!0}})],X2.prototype,"maxValue",void 0),X2=zz=u([R("esri.renderer.support.AuthoringInfoClassBreakInfo")],X2);const oRe=X2;var Vz;let Vy=Vz=class extends ge{constructor(t){super(t),this.field="",this.normalizationField="",this.label="",this.classBreakInfos=[]}clone(){return new Vz({field:this.field,normalizationField:this.normalizationField,label:this.label,classBreakInfos:ie(this.classBreakInfos)})}};u([d({type:String,json:{write:!0}})],Vy.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],Vy.prototype,"normalizationField",void 0),u([d({type:String,json:{write:!0}})],Vy.prototype,"label",void 0),u([d({type:[oRe],json:{write:!0}})],Vy.prototype,"classBreakInfos",void 0),Vy=Vz=u([R("esri.renderers.support.AuthoringInfoFieldInfo")],Vy);const pte=Vy;var Nz;const c$=new wt({percentTotal:"percent-of-total",ratio:"ratio",percent:"percent"}),u$=new wt({sizeInfo:"size",colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation"}),fte={key:t=>typeof t=="number"?"number":"string",typeMap:{number:Number,string:String},base:null},mte=["high-to-low","above-and-below","centered-on","extremes"],gte=[...new Set(["high-to-low","above-and-below","centered-on","extremes","90-10","above","below","high-to-low","above-and-below","90-10","above","below"])],yte=["seconds","minutes","hours","days","months","years"];let Co=Nz=class extends ge{constructor(t){super(t),this.endTime=null,this.field=null,this.maxSliderValue=null,this.minSliderValue=null,this.startTime=null,this.type=null,this.units=null}castEndTime(t){return typeof t=="string"||typeof t=="number"?t:null}castStartTime(t){return typeof t=="string"||typeof t=="number"?t:null}get style(){return this.type==="color"?this._get("style"):null}set style(t){this._set("style",t)}get theme(){return this.type==="color"||this.type==="size"?this._get("theme")||"high-to-low":null}set theme(t){this._set("theme",t)}clone(){return new Nz({endTime:this.endTime,field:this.field,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,startTime:this.startTime,style:this.style,theme:this.theme,type:this.type,units:this.units})}};u([d({types:fte,json:{write:!0}})],Co.prototype,"endTime",void 0),u([ut("endTime")],Co.prototype,"castEndTime",null),u([d({type:String,json:{write:!0}})],Co.prototype,"field",void 0),u([d({type:Number,json:{write:!0}})],Co.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0}})],Co.prototype,"minSliderValue",void 0),u([d({types:fte,json:{write:!0}})],Co.prototype,"startTime",void 0),u([ut("startTime")],Co.prototype,"castStartTime",null),u([d({type:c$.apiValues,value:null,json:{type:c$.jsonValues,read:c$.read,write:c$.write}})],Co.prototype,"style",null),u([d({type:gte,value:null,json:{type:gte,origins:{"web-scene":{type:mte,write:{writer:(t,e)=>{mte.indexOf(t)>-1&&(e.theme=t)}}}},write:!0}})],Co.prototype,"theme",null),u([d({type:u$.apiValues,json:{type:u$.jsonValues,read:u$.read,write:u$.write}})],Co.prototype,"type",void 0),u([d({type:yte,json:{type:yte,write:!0}})],Co.prototype,"units",void 0),Co=Nz=u([R("esri.renderers.support.AuthoringInfoVisualVariable")],Co);const aRe=Co;let h$=class extends ge{constructor(t){super(t),this.type=null}};u([d({readOnly:!0,json:{read:!1,write:!0}})],h$.prototype,"type",void 0),h$=u([R("esri.rest.support.ColorRamp")],h$);const Uz=h$;var jz;let Ny=jz=class extends Uz{constructor(t){super(t),this.algorithm=null,this.fromColor=null,this.toColor=null,this.type="algorithmic"}clone(){return new jz({fromColor:ie(this.fromColor),toColor:ie(this.toColor),algorithm:this.algorithm})}};u([Xe({esriCIELabAlgorithm:"cie-lab",esriHSVAlgorithm:"hsv",esriLabLChAlgorithm:"lab-lch"})],Ny.prototype,"algorithm",void 0),u([d({type:Ae,json:{type:[Oi],write:!0}})],Ny.prototype,"fromColor",void 0),u([d({type:Ae,json:{type:[Oi],write:!0}})],Ny.prototype,"toColor",void 0),u([d({type:["algorithmic"]})],Ny.prototype,"type",void 0),Ny=jz=u([R("esri.rest.support.AlgorithmicColorRamp")],Ny);const Bz=Ny;var Gz;let K2=Gz=class extends Uz{constructor(t){super(t),this.colorRamps=null,this.type="multipart"}clone(){return new Gz({colorRamps:ie(this.colorRamps)})}};u([d({type:[Bz],json:{write:!0}})],K2.prototype,"colorRamps",void 0),u([d({type:["multipart"]})],K2.prototype,"type",void 0),K2=Gz=u([R("esri.rest.support.MultipartColorRamp")],K2);const vte=K2,lRe={key:"type",base:Uz,typeMap:{algorithmic:Bz,multipart:vte}};function cRe(t){return t&&t.type?t.type==="algorithmic"?Bz.fromJSON(t):t.type==="multipart"?vte.fromJSON(t):null:null}var qz;const Uy=new wt({esriClassifyDefinedInterval:"defined-interval",esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation"}),d$=new wt({classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density"}),_te=["inches","feet","yards","miles","nautical-miles","millimeters","centimeters","decimeters","meters","kilometers","decimal-degrees"],uRe=["high-to-low","above-and-below","above","below","90-10"],hRe=["caret","circle-caret","arrow","circle-arrow","plus-minus","circle-plus-minus","square","circle","triangle","happy-sad","thumb","custom"];let Hr=qz=class extends ge{constructor(t){super(t),this.colorRamp=null,this.lengthUnit=null,this.maxSliderValue=null,this.minSliderValue=null,this.visualVariables=null}get classificationMethod(){const t=this._get("classificationMethod"),e=this.type;return e&&e!=="relationship"?e==="class-breaks-size"||e==="class-breaks-color"?t||"manual":null:t}set classificationMethod(t){this._set("classificationMethod",t)}readColorRamp(t){if(t)return cRe(t)}get fields(){return this.type&&this.type!=="predominance"?null:this._get("fields")}set fields(t){this._set("fields",t)}get field1(){return this.type&&this.type!=="relationship"?null:this._get("field1")}set field1(t){this._set("field1",t)}get field2(){return this.type&&this.type!=="relationship"?null:this._get("field2")}set field2(t){this._set("field2",t)}get focus(){return this.type&&this.type!=="relationship"?null:this._get("focus")}set focus(t){this._set("focus",t)}get numClasses(){return this.type&&this.type!=="relationship"?null:this._get("numClasses")}set numClasses(t){this._set("numClasses",t)}get statistics(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("statistics"):null}set statistics(t){this._set("statistics",t)}get standardDeviationInterval(){const t=this.type;return t&&t!=="relationship"&&t!=="class-breaks-size"&&t!=="class-breaks-color"||this.classificationMethod&&this.classificationMethod!=="standard-deviation"?null:this._get("standardDeviationInterval")}set standardDeviationInterval(t){this._set("standardDeviationInterval",t)}get type(){return this._get("type")}set type(t){let e=t;t==="classed-size"?e="class-breaks-size":t==="classed-color"&&(e="class-breaks-color"),this._set("type",e)}get univariateSymbolStyle(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("univariateSymbolStyle"):null}set univariateSymbolStyle(t){this._set("univariateSymbolStyle",t)}get univariateTheme(){return this.type==="univariate-color-size"?this._get("univariateTheme"):null}set univariateTheme(t){this._set("univariateTheme",t)}clone(){return new qz({classificationMethod:this.classificationMethod,colorRamp:ie(this.colorRamp),fields:this.fields&&this.fields.slice(0),field1:ie(this.field1),field2:ie(this.field2),focus:this.focus,numClasses:this.numClasses,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,lengthUnit:this.lengthUnit,statistics:this.statistics,standardDeviationInterval:this.standardDeviationInterval,type:this.type,visualVariables:this.visualVariables&&this.visualVariables.map(t=>t.clone()),univariateSymbolStyle:this.univariateSymbolStyle,univariateTheme:this.univariateTheme})}};u([d({type:Uy.apiValues,value:null,json:{type:Uy.jsonValues,read:Uy.read,write:Uy.write,origins:{"web-document":{default:"manual",type:Uy.jsonValues,read:Uy.read,write:Uy.write}}}})],Hr.prototype,"classificationMethod",null),u([d({types:lRe,json:{write:!0}})],Hr.prototype,"colorRamp",void 0),u([Ce("colorRamp")],Hr.prototype,"readColorRamp",null),u([d({type:[String],value:null,json:{write:!0}})],Hr.prototype,"fields",null),u([d({type:pte,value:null,json:{write:!0}})],Hr.prototype,"field1",null),u([d({type:pte,value:null,json:{write:!0}})],Hr.prototype,"field2",null),u([d({type:["HH","HL","LH","LL"],value:null,json:{write:!0}})],Hr.prototype,"focus",null),u([d({type:Number,value:null,json:{type:Oi,write:!0}})],Hr.prototype,"numClasses",null),u([d({type:_te,json:{type:_te,read:!1,write:!1,origins:{"web-scene":{read:!0,write:!0}}}})],Hr.prototype,"lengthUnit",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],Hr.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],Hr.prototype,"minSliderValue",void 0),u([d({type:Object,value:null,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],Hr.prototype,"statistics",null),u([d({type:[.25,.33,.5,1],value:null,json:{type:[.25,.33,.5,1],write:!0}})],Hr.prototype,"standardDeviationInterval",null),u([d({type:d$.apiValues,value:null,json:{type:d$.jsonValues,read:d$.read,write:d$.write}})],Hr.prototype,"type",null),u([d({type:[aRe],json:{write:!0}})],Hr.prototype,"visualVariables",void 0),u([d({type:hRe,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],Hr.prototype,"univariateSymbolStyle",null),u([d({type:uRe,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],Hr.prototype,"univariateTheme",null),Hr=qz=u([R("esri.renderers.support.AuthoringInfo")],Hr);const dRe=Hr,Hz=new wt({simple:"simple",uniqueValue:"unique-value",classBreaks:"class-breaks",heatmap:"heatmap",dotDensity:"dot-density",dictionary:"dictionary"},{ignoreUnknown:!0});let eS=class extends ge{constructor(t){super(t),this.authoringInfo=null,this.type=null}async getRequiredFields(t){if(!this.collectRequiredFields)return[];const e=new Set;return await this.collectRequiredFields(e,t),Array.from(e).sort()}getSymbol(t,e){}async getSymbolAsync(t,e){}getSymbols(){return[]}getAttributeHash(){return JSON.stringify(this)}getMeshHash(){return JSON.stringify(this)}};u([d({type:dRe,json:{write:!0}})],eS.prototype,"authoringInfo",void 0),u([d({type:Hz.apiValues,readOnly:!0,json:{type:Hz.jsonValues,read:!1,write:{writer:Hz.write,ignoreOrigin:!0}}})],eS.prototype,"type",void 0),eS=u([R("esri.renderers.Renderer")],eS);const Mf=eS;var Wz;let p$=Wz=class extends ge{constructor(){super(...arguments),this.title=null}clone(){return new Wz({title:this.title})}};u([d({type:String,json:{write:!0}})],p$.prototype,"title",void 0),p$=Wz=u([R("esri.renderers.support.LegendOptions")],p$);const Zz=p$;var Jz;let f$=Jz=class extends Zz{constructor(){super(...arguments),this.showLegend=null}clone(){return new Jz({title:this.title,showLegend:this.showLegend})}};u([d({type:Boolean,json:{write:!0}})],f$.prototype,"showLegend",void 0),f$=Jz=u([R("esri.renderers.visualVariables.support.VisualVariableLegendOptions")],f$);const bte=f$,pRe=le.getLogger("esri.renderers.visualVariables.VisualVariable"),Qz=new wt({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"});let vc=class extends ge{constructor(t){super(t),this.index=null,this.type=null,this.field=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null}castField(t){return t==null?t:typeof t=="function"?(pRe.error(".field: field must be a string value"),null):Kw(t)}get arcadeRequired(){return!!this.valueExpression}clone(){}getAttributeHash(){return`${this.type}-${this.field}-${this.valueExpression}`}};u([d()],vc.prototype,"index",void 0),u([d({type:Qz.apiValues,readOnly:!0,json:{read:Qz.read,write:Qz.write}})],vc.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],vc.prototype,"field",void 0),u([ut("field")],vc.prototype,"castField",null),u([d({type:String,json:{write:!0}})],vc.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],vc.prototype,"valueExpressionTitle",void 0),u([d({readOnly:!0})],vc.prototype,"arcadeRequired",null),u([d({type:bte,json:{write:!0}})],vc.prototype,"legendOptions",void 0),vc=u([R("esri.renderers.visualVariables.VisualVariable")],vc);const tS=vc;var Yz;let jy=Yz=class extends ge{constructor(t){super(t),this.color=null,this.label=null,this.value=null}writeValue(t,e,i){e[i]=t==null?0:t}clone(){return new Yz({color:this.color&&this.color.clone(),label:this.label,value:this.value})}};u([d({type:Ae,json:{type:[Oi],write:!0}})],jy.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],jy.prototype,"label",void 0),u([d({type:Number,json:{write:{writerEnsuresNonNull:!0}}})],jy.prototype,"value",void 0),u([Ee("value")],jy.prototype,"writeValue",null),jy=Yz=u([R("esri.renderers.visualVariables.support.ColorStop")],jy);const fRe=jy;var Xz;let By=Xz=class extends tS{constructor(t){super(t),this.type="color",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(t){t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,i)=>e.value-i.value),this._set("stops",t)}clone(){return new Xz({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(t=>t.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],By.prototype,"cache",null),u([d({type:["color"],json:{type:["colorInfo"]}})],By.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],By.prototype,"normalizationField",void 0),u([d({type:[fRe],json:{write:!0}})],By.prototype,"stops",null),By=Xz=u([R("esri.renderers.visualVariables.ColorVariable")],By);const wte=By;var Kz;let Pf=Kz=class extends ge{constructor(t){super(t),this.label=null,this.opacity=null,this.value=null}readOpacity(t,e){return yx(e.transparency)}writeOpacity(t,e,i){e[i]=kF(t)}clone(){return new Kz({label:this.label,opacity:this.opacity,value:this.value})}};u([d({type:String,json:{write:!0}})],Pf.prototype,"label",void 0),u([d({type:Number,json:{type:Oi,write:{target:"transparency"}}})],Pf.prototype,"opacity",void 0),u([Ce("opacity",["transparency"])],Pf.prototype,"readOpacity",null),u([Ee("opacity")],Pf.prototype,"writeOpacity",null),u([d({type:Number,json:{write:!0}})],Pf.prototype,"value",void 0),Pf=Kz=u([R("esri.renderers.visualVariables.support.OpacityStop")],Pf);const mRe=Pf;var e8;let Gy=e8=class extends tS{constructor(t){super(t),this.type="opacity",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(t){t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,i)=>e.value-i.value),this._set("stops",t)}clone(){return new e8({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(t=>t.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],Gy.prototype,"cache",null),u([d({type:["opacity"],json:{type:["transparencyInfo"]}})],Gy.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Gy.prototype,"normalizationField",void 0),u([d({type:[mRe],json:{write:!0}})],Gy.prototype,"stops",null),Gy=e8=u([R("esri.renderers.visualVariables.OpacityVariable")],Gy);const xte=Gy;var t8;let sd=t8=class extends tS{constructor(t){super(t),this.axis=null,this.type="rotation",this.rotationType="geographic",this.valueExpressionTitle=null}get cache(){return{hasExpression:!!this.valueExpression,compiledFunc:null}}writeValueExpressionTitleWebScene(t,e,i,r){if(r&&r.messages){const s=`visualVariables[${this.index}]`;r.messages.push(new Q("property:unsupported",this.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:s+".valueExpressionTitle",context:r}))}}clone(){return new t8({axis:this.axis,rotationType:this.rotationType,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,legendOptions:this.legendOptions&&this.legendOptions.clone()})}};u([d({readOnly:!0})],sd.prototype,"cache",null),u([d({type:["heading","tilt","roll"],json:{origins:{"web-scene":{default:"heading",write:!0}}}})],sd.prototype,"axis",void 0),u([d({type:["rotation"],json:{type:["rotationInfo"]}})],sd.prototype,"type",void 0),u([d({type:["geographic","arithmetic"],json:{write:!0,origins:{"web-document":{write:!0,default:"geographic"}}}})],sd.prototype,"rotationType",void 0),u([d({type:String,json:{write:!0}})],sd.prototype,"valueExpressionTitle",void 0),u([Ee("web-scene","valueExpressionTitle")],sd.prototype,"writeValueExpressionTitleWebScene",null),sd=t8=u([R("esri.renderers.visualVariables.RotationVariable")],sd);const Ste=sd;var i8;let b_=i8=class extends ge{constructor(t){super(t),this.label=null,this.size=null,this.value=null}clone(){return new i8({label:this.label,size:this.size,value:this.value})}};u([d({type:String,json:{write:!0}})],b_.prototype,"label",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],b_.prototype,"size",void 0),u([d({type:Number,json:{write:!0}})],b_.prototype,"value",void 0),b_=i8=u([R("esri.renderers.visualVariables.support.SizeStop")],b_);const gRe=b_;var r8;let m$=r8=class extends bte{constructor(){super(...arguments),this.customValues=null}clone(){return new r8({title:this.title,showLegend:this.showLegend,customValues:this.customValues&&this.customValues.slice(0)})}};u([d({type:[Number],json:{write:!0}})],m$.prototype,"customValues",void 0),m$=r8=u([R("esri.renderers.visualVariables.support.SizeVariableLegendOptions")],m$);const yRe=m$;function w_(t){return t&&t.declaredClass==="esri.renderers.visualVariables.SizeVariable"}function iS(t){return t!=null&&!isNaN(t)&&isFinite(t)}function Tte(t){return t.valueExpression?"expression":t.field&&typeof t.field=="string"?"field":"unknown"}function vRe(t,e){const i=e||Tte(t),r=t.valueUnit||"unknown";return i==="unknown"?"constant":t.stops?"stops":t.minSize!=null&&t.maxSize!=null&&t.minDataValue!=null&&t.maxDataValue!=null?"clamped-linear":r==="unknown"?t.minSize!=null&&t.minDataValue!=null?t.minSize&&t.minDataValue?"proportional":"additive":"identity":"real-world-size"}const x_={inches:cr(1,"meters","inches"),feet:cr(1,"meters","feet"),"us-feet":cr(1,"meters","us-feet"),yards:cr(1,"meters","yards"),miles:cr(1,"meters","miles"),"nautical-miles":cr(1,"meters","nautical-miles"),millimeters:cr(1,"meters","millimeters"),centimeters:cr(1,"meters","centimeters"),decimeters:cr(1,"meters","decimeters"),meters:cr(1,"meters","meters"),kilometers:cr(1,"meters","kilometers"),"decimal-degrees":1/E2e(1,"meters",Lt.radius)},Af=le.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),Cte=new pn,g$=Math.PI,Mte=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function Pte(t,e,i){const r="visualVariables"in t&&t.visualVariables?t.visualVariables.filter(y=>y.type==="color")[0]:t;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.ColorVariable")return void Af.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const s=typeof e=="number",n=s?null:e,o=n&&n.attributes;let a=s?e:null;const l=r.field,{ipData:c,hasExpression:h}=r.cache;let p=r.cache.compiledFunc;if(!l&&!h){const y=r.stops;return y&&y[0]&&y[0].color}if(typeof a!="number")if(h){if(!_(i)||!_(i.arcade))return void Af.error("Use of arcade expressions requires an arcade context");const y={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},v=i.arcade.arcadeUtils,b=v.getViewInfo(y),w=v.createExecContext(n,b);if(!p){const S=v.createSyntaxTree(r.valueExpression);p=v.createFunction(S),r.cache.compiledFunc=p}a=v.executeFunction(p,w)}else o&&(a=o[l]);const f=r.normalizationField,g=o?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(g)&&g!==0)){isNaN(g)||s||(a/=g);const y=n8(a,c);if(y){const v=y[0],b=y[1],w=v===b?r.stops[v].color:Ae.blendColors(r.stops[v].color,r.stops[b].color,y[2],_(i)?i.color:void 0);return new Ae(w)}}}function Ate(t,e,i){const r="visualVariables"in t&&t.visualVariables?t.visualVariables.filter(y=>y.type==="opacity")[0]:t;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.OpacityVariable")return void Af.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const s=typeof e=="number",n=s?null:e,o=n&&n.attributes;let a=s?e:null;const l=r.field,{ipData:c,hasExpression:h}=r.cache;let p=r.cache.compiledFunc;if(!l&&!h){const y=r.stops;return y&&y[0]&&y[0].opacity}if(typeof a!="number")if(h){if(A(i)||A(i.arcade))return void Af.error("Use of arcade expressions requires an arcade context");const y={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},v=i.arcade.arcadeUtils,b=v.getViewInfo(y),w=v.createExecContext(n,b);if(!p){const S=v.createSyntaxTree(r.valueExpression);p=v.createFunction(S),r.cache.compiledFunc=p}a=v.executeFunction(p,w)}else o&&(a=o[l]);const f=r.normalizationField,g=o?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(g)&&g!==0)){isNaN(g)||s||(a/=g);const y=n8(a,c);if(y){const v=y[0],b=y[1];if(v===b)return r.stops[v].opacity;{const w=r.stops[v].opacity;return w+(r.stops[b].opacity-w)*y[2]}}}}function $te(t,e,i){const r="visualVariables"in t&&t.visualVariables?t.visualVariables.filter(g=>g.type==="rotation")[0]:t;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.RotationVariable")return void Af.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const s=r.axis||"heading",n=s==="heading"&&r.rotationType==="arithmetic"?90:0,o=s==="heading"&&r.rotationType==="arithmetic"?-1:1,a=typeof e=="number"?null:e,l=a&&a.attributes,c=r.field,{hasExpression:h}=r.cache;let p=r.cache.compiledFunc,f=0;if(!c&&!h)return f;if(h){if(A(i)||A(i.arcade))return void Af.error("Use of arcade expressions requires an arcade context");const g={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},y=i.arcade.arcadeUtils,v=y.getViewInfo(g),b=y.createExecContext(a,v);if(!p){const w=y.createSyntaxTree(r.valueExpression);p=y.createFunction(w),r.cache.compiledFunc=p}f=y.executeFunction(p,b)}else l&&(f=l[c]||0);return f=typeof f!="number"||isNaN(f)?null:n+o*f,f}function _Re(t,e,i){const r=typeof e=="number",s=r?null:e,n=s&&s.attributes;let o=r?e:null;const{isScaleDriven:a}=t.cache;let l=t.cache.compiledFunc;if(a){const h=_(i)?i.scale:void 0,p=_(i)?i.view:void 0;o=h==null||p==="3d"?bRe(t):h}else if(!r)switch(t.inputValueType){case"expression":{if(A(i)||A(i.arcade))return void Af.error("Use of arcade expressions requires an arcade context");const h={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},p=i.arcade.arcadeUtils,f=p.getViewInfo(h),g=p.createExecContext(s,f);if(!l){const y=p.createSyntaxTree(t.valueExpression);l=p.createFunction(y),t.cache.compiledFunc=l}o=p.executeFunction(l,g);break}case"field":n&&(o=n[t.field]);break;case"unknown":o=null}if(!iS(o))return null;if(r||!t.normalizationField)return o;const c=n?parseFloat(n[t.normalizationField]):null;return iS(c)&&c!==0?o/c:null}function bRe(t){let e=null,i=null;const r=t.stops;return r?(e=r[0].value,i=r[r.length-1].value):(e=t.minDataValue||0,i=t.maxDataValue||0),(e+i)/2}function y$(t,e,i){const r="visualVariables"in t&&t.visualVariables?t.visualVariables.filter(n=>n.type==="size")[0]:t;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.SizeVariable")return void Af.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const s=Ote(_Re(r,e,i),r,e,i,r.cache.ipData);return s==null||isNaN(s)?0:s}function Mo(t,e,i){return t==null?null:w_(t)?y$(t,e,i):iS(t)?t:null}function Ete(t,e,i){return iS(i)&&t>i?i:iS(e)&&t<e?e:t}function wRe(t,e,i,r){return t+(Mo(e.minSize,i,r)||e.minDataValue)}function xRe(t,e,i){const r=t.stops;let s=r&&r.length&&r[0].size;return s==null&&(s=t.minSize),Mo(s,e,i)}function SRe(t,e,i,r){const s=(t-e.minDataValue)/(e.maxDataValue-e.minDataValue),n=Mo(e.minSize,i,r),o=Mo(e.maxSize,i,r),a=_(r)?r.shape:void 0;if(t<=e.minDataValue)return n;if(t>=e.maxDataValue)return o;if(e.scaleBy==="area"&&a){const l=a==="circle",c=l?g$*(n/2)**2:n*n,h=c+s*((l?g$*(o/2)**2:o*o)-c);return l?2*Math.sqrt(h/g$):Math.sqrt(h)}return n+s*(o-n)}function TRe(t,e,i,r){const s=_(r)?r.shape:void 0,n=t/e.minDataValue,o=Mo(e.minSize,i,r),a=Mo(e.maxSize,i,r);let l=null;return l=s==="circle"?2*Math.sqrt(n*(o/2)**2):s==="square"||s==="diamond"||s==="image"?Math.sqrt(n*o**2):n*o,Ete(l,o,a)}function CRe(t,e,i,r,s){const[n,o,a]=n8(t,s);if(n===o)return Mo(e.stops[n].size,i,r);{const l=Mo(e.stops[n].size,i,r);return l+(Mo(e.stops[o].size,i,r)-l)*a}}function MRe(t,e,i,r){const s=(_(r)&&r.resolution?r.resolution:1)*x_[e.valueUnit],n=Mo(e.minSize,i,r),o=Mo(e.maxSize,i,r),{valueRepresentation:a}=e;let l=null;return l=a==="area"?2*Math.sqrt(t/g$)/s:a==="radius"||a==="distance"?2*t/s:t/s,Ete(l,n,o)}function PRe(t){return t}function Ote(t,e,i,r,s){switch(e.transformationType){case"additive":return wRe(t,e,i,r);case"constant":return xRe(e,i,r);case"clamped-linear":return SRe(t,e,i,r);case"proportional":return TRe(t,e,i,r);case"stops":return CRe(t,e,i,r,s);case"real-world-size":return MRe(t,e,i,r);case"identity":return PRe(t);case"unknown":return null}}function ARe(t,e,i){const{isScaleDriven:r}=t.cache;if(!(r&&i==="3d"||e))return null;const s={scale:e,view:i};let n=Mo(t.minSize,Cte,s),o=Mo(t.maxSize,Cte,s);if(n!=null||o!=null){if(n>o){const a=o;o=n,n=a}return{minSize:n,maxSize:o}}}function s8(t,e,i){if(!t.visualVariables)return;const r=[],s=[],n=[],o=[],a=[];for(const l of t.visualVariables)switch(l.type){case"color":s.push(l);break;case"opacity":n.push(l);break;case"rotation":a.push(l);break;case"size":o.push(l)}return s.forEach(l=>{const c=Pte(l,e,i);r.push({variable:l,value:c})}),n.forEach(l=>{const c=Ate(l,e,i);r.push({variable:l,value:c})}),a.forEach(l=>{const c=$te(l,e,i);r.push({variable:l,value:c})}),o.forEach(l=>{const c=y$(l,e,i);r.push({variable:l,value:c})}),r.filter(l=>l.value!=null)}function n8(t,e){if(!e)return;let i=0,r=e.length-1;return e.some((s,n)=>t<s?(r=n,!0):(i=n,!1)),[i,r,(t-e[i])/(e[r]-e[i])]}function $Re(t,e,i){const r=["proportional","proportional","proportional"];for(const s of t){const n=s.useSymbolValue?"symbol-value":y$(s,e,i);switch(s.axis){case"width":r[0]=n;break;case"depth":r[1]=n;break;case"height":r[2]=n;break;case"width-and-depth":r[0]=n,r[1]=n;break;case"all":case void 0:case null:r[0]=n,r[1]=n,r[2]=n;break;default:kn(s.axis)}}return r}var ERe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",getAllSizes:$Re,getColor:Pte,getOpacity:Ate,getRotationAngle:$te,getSize:y$,getSizeForValue:Ote,getSizeFromNumberOrVariable:Mo,getSizeRangeAtScale:ARe,getVisualVariableValues:s8,viewScaleRE:Mte}),o8;const S_=le.getLogger("esri.renderers.visualVariables.SizeVariable"),v$=new wt({width:"width",depth:"depth",height:"height",widthAndDepth:"width-and-depth",all:"all"}),a8=new wt({unknown:"unknown",inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers","decimal-degree":"decimal-degrees"});function Rte(t){if(t!=null)return typeof t=="string"||typeof t=="number"?ti(t):t.type==="size"?w_(t)?t:(delete(t=E({},t)).type,new Xt(t)):void 0}function Ite(t,e,i){if(typeof t!="object")return t;const r=new Xt;return r.read(t,i),r}let Xt=o8=class extends tS{constructor(t){super(t),this.axis=null,this.legendOptions=null,this.normalizationField=null,this.scaleBy=null,this.target=null,this.type="size",this.useSymbolValue=null,this.valueExpression=null,this.valueRepresentation=null,this.valueUnit=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null,isScaleDriven:Mte.test(this.valueExpression)}}set expression(t){S_.warn("'expression' is deprecated since version 4.2. Use 'valueExpression' instead. The only supported expression is 'view.scale'."),t==="view.scale"?(this.valueExpression="$view.scale",this._set("expression",t)):this._set("expression",null)}set index(t){w_(this.maxSize)&&(this.maxSize.index=`visualVariables[${t}].maxSize`),w_(this.minSize)&&(this.minSize.index=`visualVariables[${t}].minSize`),this._set("index",t)}get inputValueType(){return Tte(this)}set maxDataValue(t){t&&this.stops&&(S_.warn("cannot set maxDataValue when stops is not null."),t=null),this._set("maxDataValue",t)}set maxSize(t){t&&this.stops&&(S_.warn("cannot set maxSize when stops is not null."),t=null),this._set("maxSize",t)}castMaxSize(t){return Rte(t)}readMaxSize(t,e,i){return Ite(t,e,i)}set minDataValue(t){t&&this.stops&&(S_.warn("cannot set minDataValue when stops is not null."),t=null),this._set("minDataValue",t)}set minSize(t){t&&this.stops&&(S_.warn("cannot set minSize when stops is not null."),t=null),this._set("minSize",t)}castMinSize(t){return Rte(t)}readMinSize(t,e,i){return Ite(t,e,i)}get arcadeRequired(){return!!this.valueExpression||this.minSize&&typeof this.minSize=="object"&&this.minSize.arcadeRequired||this.maxSize&&typeof this.maxSize=="object"&&this.maxSize.arcadeRequired}set stops(t){this.minDataValue==null&&this.maxDataValue==null&&this.minSize==null&&this.maxSize==null?t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,i)=>e.value-i.value):t&&(S_.warn("cannot set stops when one of minDataValue, maxDataValue, minSize or maxSize is not null."),t=null),this._set("stops",t)}get transformationType(){return vRe(this,this.inputValueType)}readValueExpression(t,e){return t||e.expression&&"$view.scale"}writeValueExpressionWebScene(t,e,i,r){if(t==="$view.scale"){if(r&&r.messages){const s=this.index,n=typeof s=="string"?s:`visualVariables[${s}]`;r.messages.push(new Q("property:unsupported",this.type+"VisualVariable.valueExpression = '$view.scale' is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:n+".valueExpression",context:r}))}}else e[i]=t}readValueUnit(t){return t?a8.read(t):null}clone(){return new o8({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:w_(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:w_(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(t=>t.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone()})}flipSizes(){if(this.transformationType==="clamped-linear"){const{minSize:t,maxSize:e}=this;return this.minSize=e,this.maxSize=t,this}if(this.transformationType==="stops"){const t=this.stops,e=t.map(r=>r.size).reverse(),i=t.length;for(let r=0;r<i;r++)t[r].size=e[r];return this}return this}getAttributeHash(){return`${super.getAttributeHash()}-${this.target}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],Xt.prototype,"cache",null),u([d({type:v$.apiValues,json:{type:v$.jsonValues,origins:{"web-map":{read:!1}},read:v$.read,write:v$.write}})],Xt.prototype,"axis",void 0),u([d({type:String,value:null,json:{read:!1}})],Xt.prototype,"expression",null),u([d()],Xt.prototype,"index",null),u([d({type:String,readOnly:!0})],Xt.prototype,"inputValueType",null),u([d({type:yRe,json:{write:!0}})],Xt.prototype,"legendOptions",void 0),u([d({type:Number,value:null,json:{write:!0}})],Xt.prototype,"maxDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],Xt.prototype,"maxSize",null),u([ut("maxSize")],Xt.prototype,"castMaxSize",null),u([Ce("maxSize")],Xt.prototype,"readMaxSize",null),u([d({type:Number,value:null,json:{write:!0}})],Xt.prototype,"minDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],Xt.prototype,"minSize",null),u([ut("minSize")],Xt.prototype,"castMinSize",null),u([Ce("minSize")],Xt.prototype,"readMinSize",null),u([d({type:String,json:{write:!0}})],Xt.prototype,"normalizationField",void 0),u([d({readOnly:!0})],Xt.prototype,"arcadeRequired",null),u([d({type:String})],Xt.prototype,"scaleBy",void 0),u([d({type:[gRe],value:null,json:{write:!0}})],Xt.prototype,"stops",null),u([d({type:["outline"],json:{write:!0}})],Xt.prototype,"target",void 0),u([d({type:String,readOnly:!0})],Xt.prototype,"transformationType",null),u([d({type:["size"],json:{type:["sizeInfo"]}})],Xt.prototype,"type",void 0),u([d({type:Boolean,json:{write:!0,origins:{"web-map":{read:!1}}}})],Xt.prototype,"useSymbolValue",void 0),u([d({type:String,json:{write:!0}})],Xt.prototype,"valueExpression",void 0),u([Ce("valueExpression",["valueExpression","expression"])],Xt.prototype,"readValueExpression",null),u([Ee("web-scene","valueExpression")],Xt.prototype,"writeValueExpressionWebScene",null),u([d({type:["radius","diameter","area","width","distance"],json:{write:!0}})],Xt.prototype,"valueRepresentation",void 0),u([d({type:a8.apiValues,json:{write:a8.write,origins:{"web-map":{read:!1},"web-scene":{write:!0}}}})],Xt.prototype,"valueUnit",void 0),u([Ce("valueUnit")],Xt.prototype,"readValueUnit",null),Xt=o8=u([R("esri.renderers.visualVariables.SizeVariable")],Xt);const Dte=Xt,ORe=le.getLogger("esri.renderers.visualVariables.VisualVariableFactory"),RRe={color:wte,size:Dte,opacity:xte,rotation:Ste},IRe=new wt({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"}),DRe=/^\[([^\]]+)\]$/i;let _$=class extends ve{constructor(){super(...arguments),this.colorVariables=null,this.opacityVariables=null,this.rotationVariables=null,this.sizeVariables=null}set visualVariables(t){if(this._resetVariables(),(t=t&&t.filter(e=>!!e))&&t.length){for(const e of t)switch(e.type){case"color":this.colorVariables.push(e);break;case"opacity":this.opacityVariables.push(e);break;case"rotation":this.rotationVariables.push(e);break;case"size":this.sizeVariables.push(e)}this.sizeVariables.length&&this.sizeVariables.some(e=>!!e.target)&&t.sort((e,i)=>{let r=null;return r=e.target===i.target?0:e.target?1:-1,r});for(let e=0;e<t.length;e++)t[e].index=e;this._set("visualVariables",t)}else this._set("visualVariables",t)}readVariables(t,e,i){const{rotationExpression:r,rotationType:s}=e,n=r&&r.match(DRe),o=n&&n[1];if(o&&(t||(t=[]),t.push({type:"rotationInfo",rotationType:s,field:o})),t)return t.map(a=>{const l=IRe.read(a.type),c=RRe[l];c||(ORe.warn(`Unknown variable type: ${l}`),i&&i.messages&&i.messages.push(new Go("visual-variable:unsupported",`visualVariable of type '${l}' is not supported`,{definition:a,context:i})));const h=new c;return h.read(a,i),h})}writeVariables(t,e){const i=[];for(const r of t){const s=r.toJSON(e);s&&i.push(s)}return i}_resetVariables(){this.colorVariables=[],this.opacityVariables=[],this.rotationVariables=[],this.sizeVariables=[]}};u([d()],_$.prototype,"visualVariables",null),_$=u([R("esri.renderers.visualVariables.VisualVariableFactory")],_$);const FRe=_$,LRe={base:tS,key:"type",typeMap:{opacity:xte,color:wte,rotation:Ste,size:Dte}},rS=t=>{let e=class extends t{constructor(){super(...arguments),this._vvFactory=new FRe}set visualVariables(i){this._vvFactory.visualVariables=i,this._set("visualVariables",this._vvFactory.visualVariables)}readVisualVariables(i,r,s){return this._vvFactory.readVariables(i,r,s)}writeVisualVariables(i,r,s,n){r[s]=this._vvFactory.writeVariables(i,n)}get arcadeRequiredForVisualVariables(){if(!this.visualVariables)return!1;for(const i of this.visualVariables)if(i.arcadeRequired)return!0;return!1}hasVisualVariables(i,r){return i?this.getVisualVariablesForType(i,r).length>0:this.getVisualVariablesForType("size",r).length>0||this.getVisualVariablesForType("color",r).length>0||this.getVisualVariablesForType("opacity",r).length>0||this.getVisualVariablesForType("rotation",r).length>0}getVisualVariablesForType(i,r){const s=this.visualVariables;return s?s.filter(n=>n.type===i&&(typeof r=="string"?n.target===r:r!==!1||!n.target)):[]}async collectVVRequiredFields(i,r){let s=[];this.visualVariables&&(s=s.concat(this.visualVariables));for(const n of s)n&&(n.field&&Na(i,r,n.field),n.normalizationField&&Na(i,r,n.normalizationField),n.valueExpression&&await Qo(i,r,n.valueExpression))}};return u([d({types:[LRe],value:null,json:{write:!0}})],e.prototype,"visualVariables",null),u([Ce("visualVariables",["visualVariables","rotationType","rotationExpression"])],e.prototype,"readVisualVariables",null),u([Ee("visualVariables")],e.prototype,"writeVisualVariables",null),e=u([R("esri.renderers.mixins.VisualVariablesMixin")],e),e},sS={retainId:!1,ignoreDrivers:!1,hasLabelingContext:!0};function kRe(t,e=sS){if(!t)return{symbol:null};const{retainId:i=sS.retainId,ignoreDrivers:r=sS.ignoreDrivers,hasLabelingContext:s=sS.hasLabelingContext,retainCIM:n=sS.retainCIM}=e;let o;if(o2(t)||t instanceof ry)o=t.clone();else if(t.type==="cim"){var a,l;const c=(a=t.data)==null||(l=a.symbol)==null?void 0:l.type;if(c!=="CIMPointSymbol")return{error:new Q("symbol-conversion:unsupported-cim-symbol",`CIM symbol of type '${c||"unknown"}' is unsupported in 3D`,{symbol:t})};o=n?t.clone():Xp.fromCIMSymbol(t)}else if(t instanceof Jl)o=TP.fromSimpleLineSymbol(t);else if(t instanceof C1)o=Xp.fromSimpleMarkerSymbol(t);else if(t instanceof CP)o=Xp.fromPictureMarkerSymbol(t);else if(t instanceof iy)o=n2.fromSimpleFillSymbol(t);else{if(!(t instanceof M1))return{error:new Q("symbol-conversion:unsupported-2d-symbol",`2D symbol of type '${t.type||t.declaredClass}' is unsupported in 3D`,{symbol:t})};o=s?xP.fromTextSymbol(t):Xp.fromTextSymbol(t)}if(i&&o.type!=="cim"&&(o.id=t.id),r&&o2(o))for(let c=0;c<o.symbolLayers.length;++c)o.symbolLayers.getItemAt(c)._ignoreDrivers=!0;return{symbol:o}}function T_(t,e,i,r){const s=zRe(t,{},r);s&&(e[i]=s)}function zRe(t,e,i){if(!t)return null;if(i&&i.origin==="web-scene"&&!(t instanceof x1)&&!(t instanceof ry)){const r=kRe(t,{retainCIM:!0});return _(r.symbol)?r.symbol.write(e,i):(i.messages&&i.messages.push(new Q("symbol:unsupported",`Symbols of type '${t.declaredClass}' are not supported in scenes. Use 3D symbology instead when working with WebScene and SceneView`,{symbol:t,context:i,error:r.error})),null)}return i&&i.origin==="web-map"&&t.type==="web-style"?(i.messages&&i.messages.push(new Q("symbol:unsupported",`Symbols of type '${t.declaredClass}' are not supported in webmaps. Use CIMSymbol instead when working with WebMap in MapView.`,{symbol:t,context:i})),null):t.write(e,i)}function Vot(t,e){return Uxe(t,null,e)}const nS={types:wZ,json:{write:{writer:T_},origins:{"web-scene":{types:xZ,write:{writer:T_},read:{reader:Gv({types:xZ})}}}}},Fte={types:{base:vo,key:"type",typeMap:{"simple-fill":sy.typeMap["simple-fill"],"picture-fill":sy.typeMap["picture-fill"],"polygon-3d":sy.typeMap["polygon-3d"]}},json:{write:{writer:T_},origins:{"web-scene":{type:n2,write:{writer:T_}}}}};var l8;let $f=l8=class extends ge{constructor(t){super(t),this.description=null,this.label=null,this.minValue=null,this.maxValue=0,this.symbol=null}clone(){return new l8({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const t=JSON.stringify(this.symbol);return`${this.minValue}.${this.maxValue}.${t}`}};u([d({type:String,json:{write:!0}})],$f.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],$f.prototype,"label",void 0),u([d({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue"}}})],$f.prototype,"minValue",void 0),u([d({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue"}}})],$f.prototype,"maxValue",void 0),u([d(nS)],$f.prototype,"symbol",void 0),$f=l8=u([R("esri.renderers.support.ClassBreakInfo")],$f);const b$=$f;var c8;const w$=le.getLogger("esri.renderers.ClassBreaksRenderer"),Lte="log",x$="percent-of-total",S$="field",T$=new wt({esriNormalizeByLog:Lte,esriNormalizeByPercentOfTotal:x$,esriNormalizeByField:S$}),VRe=Ni(b$);let Wr=c8=class extends rS(Mf){constructor(t){super(t),this._compiledValueExpression={valueExpression:null,compiledFunction:null},this.backgroundFillSymbol=null,this.classBreakInfos=null,this.defaultLabel=null,this.defaultSymbol=null,this.field=null,this.isMaxInclusive=!0,this.legendOptions=null,this.normalizationField=null,this.normalizationTotal=null,this.type="class-breaks",this.valueExpression=null,this.valueExpressionTitle=null,this._set("classBreakInfos",[])}readClassBreakInfos(t,e,i){if(!Array.isArray(t))return;let r=e.minValue;return t.map(s=>{const n=new b$;return n.read(s,i),n.minValue==null&&(n.minValue=r),n.maxValue==null&&(n.maxValue=n.minValue),r=n.maxValue,n})}writeClassBreakInfos(t,e,i,r){const s=t.map(n=>n.write({},r));this._areClassBreaksConsecutive()&&s.forEach(n=>delete n.classMinValue),e[i]=s}castField(t){return t==null?t:typeof t=="function"?(w$.error(".field: field must be a string value"),null):Kw(t)}get minValue(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}get normalizationType(){let t=this._get("normalizationType");const e=!!this.normalizationField,i=this.normalizationTotal!=null;return e||i?(t=e&&S$||i&&x$||null,e&&i&&w$.warn("warning: both normalizationField and normalizationTotal are set!")):t!==S$&&t!==x$||(t=null),t}set normalizationType(t){this._set("normalizationType",t)}addClassBreakInfo(t,e,i){let r=null;r=typeof t=="number"?new b$({minValue:t,maxValue:e,symbol:SZ(i)}):VRe(ie(t)),this.classBreakInfos.push(r),this.classBreakInfos.length===1&&this.notifyChange("minValue")}removeClassBreakInfo(t,e){const i=this.classBreakInfos.length;for(let r=0;r<i;r++){const s=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(s[0]===t&&s[1]===e){this.classBreakInfos.splice(r,1);break}}}getBreakIndex(t,e){return this.valueExpression&&(A(e)||A(e.arcade))&&w$.warn(""),this.valueExpression?this._getBreakIndexForExpression(t,e):this._getBreakIndexForField(t)}async getClassBreakInfo(t,e){let i=e;this.valueExpression&&(A(e)||A(e.arcade))&&(i=he(E({},i),{arcade:await su()}));const r=this.getBreakIndex(t,i);return r!==-1?this.classBreakInfos[r]:null}getSymbol(t,e){if(this.valueExpression&&(A(e)||A(e.arcade)))return void w$.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const i=this.getBreakIndex(t,e);return i>-1?this.classBreakInfos[i].symbol:this.defaultSymbol}async getSymbolAsync(t,e){let i=e;if(this.valueExpression&&(A(e)||A(e.arcade))){const s=await su(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),i=he(E({},i),{arcade:s})}const r=this.getBreakIndex(t,i);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol}getSymbols(){const t=[];return this.classBreakInfos.forEach(e=>{e.symbol&&t.push(e.symbol)}),this.defaultSymbol&&t.push(this.defaultSymbol),t}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){const t=JSON.stringify(this.backgroundFillSymbol),e=JSON.stringify(this.defaultSymbol),i=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`;return`${t}.${e}.${this.classBreakInfos.reduce((r,s)=>r+s.getMeshHash(),"")}.${i}.${this.field}.${this.valueExpression}`}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}clone(){return new c8({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:ie(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:ie(this.visualVariables),legendOptions:ie(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}async collectRequiredFields(t,e){const i=[this.collectVVRequiredFields(t,e),this.collectSymbolFields(t,e)];await Promise.all(i)}async collectSymbolFields(t,e){const i=[...this.getSymbols().map(r=>r.collectRequiredFields(t,e)),Qo(t,e,this.valueExpression)];Na(t,e,this.field),Na(t,e,this.normalizationField),await Promise.all(i)}_getBreakIndexForExpression(t,e){const{viewingMode:i,scale:r,spatialReference:s,arcade:n}=st(e,{});let o=this._compiledValueExpression.valueExpression===this.valueExpression?this._compiledValueExpression.compiledFunction:null;const a=at(n).arcadeUtils;if(!o){const c=a.createSyntaxTree(this.valueExpression);o=a.createFunction(c),this._compiledValueExpression.compiledFunction=o}this._compiledValueExpression.valueExpression=this.valueExpression;const l=a.executeFunction(o,a.createExecContext(t,a.getViewInfo({viewingMode:i,scale:r,spatialReference:s})));return this._getBreakIndexfromInfos(l)}_getBreakIndexForField(t){const e=this.field,i=t.attributes,r=this.normalizationType;let s=parseFloat(i[e]);if(r){const n=this.normalizationTotal,o=parseFloat(i[this.normalizationField]);if(r===Lte)s=Math.log(s)*Math.LOG10E;else if(r!==x$||isNaN(n)){if(r===S$&&!isNaN(o)){if(isNaN(s)||isNaN(o))return-1;s/=o}}else s=s/n*100}return this._getBreakIndexfromInfos(s)}_getBreakIndexfromInfos(t){const e=this.isMaxInclusive;if(t!=null&&typeof t=="number"&&!isNaN(t))for(let i=0;i<this.classBreakInfos.length;i++){const r=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue];if(r[0]<=t&&(e?t<=r[1]:t<r[1]))return i}return-1}_areClassBreaksConsecutive(){const t=this.classBreakInfos,e=t.length;for(let i=1;i<e;i++)if(t[i-1].maxValue!==t[i].minValue)return!1;return!0}};u([d(Fte)],Wr.prototype,"backgroundFillSymbol",void 0),u([d({type:[b$]})],Wr.prototype,"classBreakInfos",void 0),u([Ce("classBreakInfos")],Wr.prototype,"readClassBreakInfos",null),u([Ee("classBreakInfos")],Wr.prototype,"writeClassBreakInfos",null),u([d({type:String,json:{write:!0}})],Wr.prototype,"defaultLabel",void 0),u([d(nS)],Wr.prototype,"defaultSymbol",void 0),u([d({type:String,json:{write:!0}})],Wr.prototype,"field",void 0),u([ut("field")],Wr.prototype,"castField",null),u([d({type:Boolean})],Wr.prototype,"isMaxInclusive",void 0),u([d({type:Zz,json:{write:!0}})],Wr.prototype,"legendOptions",void 0),u([d({type:Number,readOnly:!0,value:null,json:{read:!1,write:{overridePolicy(){return this.classBreakInfos.length!==0&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],Wr.prototype,"minValue",null),u([d({type:String,json:{write:!0}})],Wr.prototype,"normalizationField",void 0),u([d({type:Number,cast:t=>kl(t),json:{write:!0}})],Wr.prototype,"normalizationTotal",void 0),u([d({type:T$.apiValues,value:null,json:{type:T$.jsonValues,read:T$.read,write:T$.write}})],Wr.prototype,"normalizationType",null),u([Xe({classBreaks:"class-breaks"})],Wr.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Wr.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],Wr.prototype,"valueExpressionTitle",void 0),Wr=c8=u([R("esri.renderers.ClassBreaksRenderer")],Wr);const kte=Wr,C$=-3;class NRe{constructor(e,i,r){this._namespace=e,this._storage=i,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",r&&(this._storage.registerRemoveFunc(this._namespace,r),this._removeFunc=!0)}destroy(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this),this._storage=null}get namespace(){return this._namespace.slice(0,-1)}get hitRate(){return this._hit/(this._hit+this._miss)}get size(){return this._storage.size}get maxSize(){return this._storage.maxSize}resetHitRate(){this._hit=this._miss=0}put(e,i,r,s=0){this._storage.put(this._namespace+e,i,r,s)}get(e){const i=this._storage.get(this._namespace+e);return i===void 0?++this._miss:++this._hit,i}pop(e){const i=this._storage.pop(this._namespace+e);return i===void 0?++this._miss:++this._hit,i}updateSize(e,i,r){this._storage.updateSize(this._namespace+e,i,r)}clear(){this._storage.clear(this._namespace)}clearAll(){this._storage.clearAll()}getStats(){return this._storage.getStats()}resetStats(){this._storage.resetStats()}}class u8{constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new ct,this._users=new ct}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(e){this._users.push(e)}deregister(e){this._users.removeUnordered(e)}registerRemoveFunc(e,i){this._removeFuncs.push([e,i])}deregisterRemoveFunc(e){this._removeFuncs.filterInPlace(i=>i[0]!==e)}get size(){return this._size}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,0),this._checkSizeLimit()}put(e,i,r,s){const n=this._db.get(e);if(n&&(this._size-=n.size,this._db.delete(e),n.entry!==i&&this._notifyRemove(e,n.entry,0)),r>this._maxSize)return void this._notifyRemove(e,i,0);if(i===void 0)return void console.warn("Refusing to cache undefined entry ");if(!r||r<0)return void console.warn("Refusing to cache entry with invalid size "+r);const o=1+Math.max(s,C$)-C$;this._db.set(e,{entry:i,size:r,lifetime:o,lives:o}),this._size+=r,this._checkSizeLimit()}updateSize(e,i,r){const s=this._db.get(e);if(s&&s.entry===i){for(this._size-=s.size;r>this._maxSize;){const n=this._notifyRemove(e,i,1);if(!(_(n)&&n>0))return void this._db.delete(e);r=n}s.size=r,this._size+=r,this._checkSizeLimit()}}pop(e){const i=this._db.get(e);if(i)return this._size-=i.size,this._db.delete(e),++this._hit,i.entry;++this._miss}get(e){const i=this._db.get(e);if(i!==void 0)return this._db.delete(e),i.lives=i.lifetime,this._db.set(e,i),++this._hit,i.entry;++this._miss}getStats(){const e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},i={},r=new Array;this._db.forEach((o,a)=>{const l=o.lifetime;r[l]=(r[l]||0)+o.size,this._users.forAll(c=>{const h=c.namespace;if(a.startsWith(h)){const p=i[h]||0;i[h]=p+o.size}})});const s={};this._users.forAll(o=>{const a=o.namespace;if(!isNaN(o.hitRate)&&o.hitRate>0){const l=i[a]||0;i[a]=l,s[a]=Math.round(100*o.hitRate)+"%"}else s[a]="0%"});const n=Object.keys(i);n.sort((o,a)=>i[a]-i[o]),n.forEach(o=>e[o]=Math.round(i[o]/2**20)+"MB / "+s[o]);for(let o=r.length-1;o>=0;--o){const a=r[o];a&&(e["Priority "+(o+C$-1)]=Math.round(a/this.size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forAll(e=>e.resetHitRate())}clear(e){this._db.forEach((i,r)=>{r.startsWith(e)&&(this._size-=i.size,this._db.delete(r),this._notifyRemove(r,i.entry,0))})}clearAll(){this._db.forEach((e,i)=>this._notifyRemove(i,e.entry,0)),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(e,i,r){let s;return this._removeFuncs.some(n=>{if(e.startsWith(n[0])){const o=n[1](i,r);return typeof o=="number"&&(s=o),!0}return!1}),s}_checkSizeLimit(){if(!(this._size<=this._maxSize))for(const[e,i]of this._db){if(this._db.delete(e),i.lives<=1){this._size-=i.size;const r=this._notifyRemove(e,i.entry,1);_(r)&&r>0&&(this._size+=r,i.lives=i.lifetime,i.size=r,this._db.set(e,i))}else--i.lives,this._db.set(e,i);if(this._size<=.9*this.maxSize)return}}}class zte{constructor(e,i){this._storage=new u8,this._storage.maxSize=e,i&&this._storage.registerRemoveFunc("",i)}put(e,i,r){this._storage.put(e,i,r,1)}pop(e){return this._storage.pop(e)}get(e){return this._storage.get(e)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}get maxSize(){return this._storage.maxSize}set maxSize(e){this._storage.maxSize=e}}var h8;const Vte=le.getLogger("esri.renderers.DictionaryRenderer"),URe={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};let Pu=h8=class extends rS(Mf){constructor(t){super(t),this._ongoingRequests=new Map,this._symbolCache=new zte(100),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}writeData(t,e){t&&(e.scalingExpressionInfo={expression:t,returnType:"number"})}writeVisualVariables(t,e,i,r){r!=null&&r.origin||super.writeVisualVariables(t,e,i,r)}clone(){return new h8({config:ie(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:ie(this.fieldMap),url:ie(this.url),visualVariables:ie(this.visualVariables)})}async getSymbolAsync(t,e){let i;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(e));try{i=await this._dictionaryPromise}catch(f){if(bi(f))return this._dictionaryPromise=null,null}const r={};if(this.fieldMap)for(const f of this._symbolFields){const g=this.fieldMap[f];if(g&&t.attributes[g]!==null&&t.attributes[g]!==void 0){const y=""+t.attributes[g];r[f]=y}else r[f]=""}const s=i(r,e);if(!s||typeof s!="string")return null;const n=aD(s).toString(),o=this._symbolCache.get(n);if(o)return o.catch(()=>{this._symbolCache.pop(n)}),o;const a=s.split(";"),l=[],c=[];for(const f of a)if(f&&f.length!==0)if(f.indexOf("po:")===-1)if(f.indexOf("|")!==-1){for(const g of f.split("|"))if(this._itemNames.has(g)){l.push(g);break}}else this._itemNames.has(f)&&l.push(f);else{const g=f.substr(3).split("|");if(g.length===3){const y=g[0],v=g[1];let b=g[2];if(v==="DashTemplate")b=b.split(" ").map(w=>Number(w));else if(v==="Color"){const w=new Ae(b).toRgba();b=[w[0],w[1],w[2],255*w[3]]}else b=Number(b);c.push({primitiveName:y,propertyName:v,value:b})}}const h=!_(t.geometry)||!t.geometry.hasZ&&t.geometry.type==="point",p=this._cimPartsToCIMSymbol(l,c,h,e);return this._symbolCache.put(n,p,1),p}async collectRequiredFields(t,e){await this.collectVVRequiredFields(t,e),this.scaleExpression&&await Qo(t,e,this.scaleExpression);for(const i in this.fieldMap){const r=this.fieldMap[i];e.has(r)&&t.add(r)}}get arcadeRequired(){return!0}async fetchResources(t){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void Vte.error("no valid URL!");const e=_(t)?t.abortOptions:null,i=vt(this.url+"/resources/styles/dictionary-info.json",E({responseType:"json",query:{f:"json"}},e)),[{data:r}]=await Promise.all([i,su()]);if(!r)throw this._dictionaryPromise=null,new Q("esri.renderers.DictionaryRenderer","Bad dictionary data!");const s=r.expression,n=r.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+r.cimRefTemplateUrl,this._itemNames=new Set(r.itemsNames),this._symbolFields=n.symbol;const o={};if(this.config){const l=this.config;for(const c in l)o[c]=l[c]}if(n.configuration)for(const l of n.configuration)o.hasOwnProperty(l.name)||(o[l.name]=l.value);const a=[];if(_(t)&&t.fields&&this.fieldMap)for(const l of this._symbolFields){const c=this.fieldMap[l],h=t.fields.filter(p=>p.name===c);h.length>0&&a.push(he(E({},h[0]),{name:l}))}return this._dictionaryPromise=Qbe(s,_(t)?t.spatialReference:null,a,o).then(l=>{const c={scale:0};return(h,p)=>{const f=l.repurposeFeature({geometry:null,attributes:h});return c.scale=_(p)?p.scale:void 0,l.evaluate({$feature:f,$view:c})}}).catch(l=>(Vte.error("Creating dictinoary expression failed:",l),null)),this._dictionaryPromise}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._symbolFields}async _getSymbolPart(t,e){if(this._ongoingRequests.has(t))return this._ongoingRequests.get(t).then(s=>s.data);const i=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,t),r=vt(i,E({responseType:"json",query:{f:"json"}},e));this._ongoingRequests.set(t,r);try{return(await r).data}catch(s){return this._ongoingRequests.delete(t),Promise.reject(s)}}_combineSymbolParts(t,e,i){if(!t||t.length===0)return null;const r=E({},t[0]);if(t.length>1){r.symbolLayers=[];for(const s of t){const n=s;r.symbolLayers.unshift(...n.symbolLayers)}}return i&&(r.callout=URe),{type:"CIMSymbolReference",symbol:r,primitiveOverrides:e}}async _cimPartsToCIMSymbol(t,e,i,r){const s=new Array(t.length);for(let o=0;o<t.length;o++)s[o]=this._getSymbolPart(t[o],r);const n=await Promise.all(s);return new p1({data:this._combineSymbolParts(n,e,i)})}};u([d({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],Pu.prototype,"config",void 0),u([d({type:Object,json:{write:!0}})],Pu.prototype,"fieldMap",void 0),u([d({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],Pu.prototype,"scaleExpression",void 0),u([Ee("scaleExpression")],Pu.prototype,"writeData",null),u([d({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(t){return{enabled:!!t&&!!this.scaleExpression}}}}})],Pu.prototype,"scaleExpressionTitle",void 0),u([d({type:String,json:{write:!0}})],Pu.prototype,"url",void 0),u([Ee("visualVariables")],Pu.prototype,"writeVisualVariables",null),Pu=h8=u([R("esri.renderers.DictionaryRenderer")],Pu);const Nte=Pu;var Not=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Nte}),d8;const jRe=le.getLogger("esri.renderers.support.AttributeColorInfo");let nd=d8=class extends ge{constructor(t){super(t),this.color=null,this.field=null,this.label=null,this.valueExpression=null,this.valueExpressionTitle=null}castField(t){return t==null?t:typeof t=="function"?(jRe.error(".field: field must be a string value"),null):Kw(t)}getAttributeHash(){return`${this.field}-${this.valueExpression}`}clone(){return new d8({color:this.color&&this.color.clone(),field:this.field,label:this.label,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};u([d({type:Ae,json:{type:[Number],write:!0}})],nd.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],nd.prototype,"field",void 0),u([ut("field")],nd.prototype,"castField",null),u([d({type:String,json:{write:!0}})],nd.prototype,"label",void 0),u([d({type:String,json:{write:!0}})],nd.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],nd.prototype,"valueExpressionTitle",void 0),nd=d8=u([R("esri.renderers.support.AttributeColorInfo")],nd);const BRe=nd;var p8;let M$=p8=class extends ge{constructor(){super(...arguments),this.unit=null}clone(){return new p8({unit:this.unit})}};u([d({type:String,json:{write:!0}})],M$.prototype,"unit",void 0),M$=p8=u([R("esri.renderers.support.DotDensityLegendOptions")],M$);const GRe=M$;var f8;let gn=f8=class extends rS(Mf){constructor(t){super(t),this.attributes=null,this.backgroundColor=new Ae([0,0,0,0]),this.blendDots=!0,this.dotBlendingEnabled=!0,this.dotShape="square",this.dotSize=1,this.legendOptions=null,this.outline=new Jl,this.dotValue=null,this.referenceDotValue=null,this.referenceScale=null,this.seed=1,this.type="dot-density"}calculateDotValue(t){if(this.referenceScale==null)return this.dotValue;const e=t/this.referenceScale*this.dotValue;return e<1?1:e}getSymbol(){return new iy({outline:this.outline})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}getAttributeHash(){return this.attributes&&this.attributes.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){return JSON.stringify(this.outline)}clone(){return new f8({attributes:ie(this.attributes),backgroundColor:ie(this.backgroundColor),dotBlendingEnabled:ie(this.dotBlendingEnabled),dotShape:ie(this.dotShape),dotSize:ie(this.dotSize),dotValue:ie(this.dotValue),legendOptions:ie(this.legendOptions),outline:ie(this.outline),referenceScale:ie(this.referenceScale),visualVariables:ie(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}getControllerHash(){return`${this.attributes.map(t=>t.field||t.valueExpression||"")}-${this.outline&&JSON.stringify(this.outline.toJSON())||""}`}async collectRequiredFields(t,e){await this.collectVVRequiredFields(t,e);for(const i of this.attributes)i.valueExpression&&await Qo(t,e,i.valueExpression),i.field&&t.add(i.field)}};u([d({type:[BRe],json:{write:!0}})],gn.prototype,"attributes",void 0),u([d({type:Ae,json:{write:!0}})],gn.prototype,"backgroundColor",void 0),u([d({type:Boolean}),Ve("dotBlendingEnabled")],gn.prototype,"blendDots",void 0),u([d({type:Boolean,json:{write:!0}})],gn.prototype,"dotBlendingEnabled",void 0),u([d({type:String,json:{write:!1}})],gn.prototype,"dotShape",void 0),u([d({type:Number,json:{write:!1}})],gn.prototype,"dotSize",void 0),u([d({type:GRe,json:{write:!0}})],gn.prototype,"legendOptions",void 0),u([d({type:Jl,json:{default:null,write:!0}})],gn.prototype,"outline",void 0),u([d({type:Number,json:{write:!0}})],gn.prototype,"dotValue",void 0),u([d({type:Number}),Ve("dotValue")],gn.prototype,"referenceDotValue",void 0),u([d({type:Number,json:{write:!0}})],gn.prototype,"referenceScale",void 0),u([d({type:Number,json:{write:!0}})],gn.prototype,"seed",void 0),u([Xe({dotDensity:"dot-density"})],gn.prototype,"type",void 0),gn=f8=u([R("esri.renderers.DotDensityRenderer")],gn);const qRe=gn;var m8;let oS=m8=class extends ge{constructor(t){super(t),this.color=null,this.ratio=null}clone(){return new m8({color:this.color,ratio:this.ratio})}};u([d({type:Ae,json:{write:!0}})],oS.prototype,"color",void 0),u([d({type:Number,json:{write:!0}})],oS.prototype,"ratio",void 0),oS=m8=u([R("esri.renderers.support.HeatmapColorStop")],oS);const P$=oS;var g8;let Au=g8=class extends Mf{constructor(t){super(t),this.blurRadius=10,this.colorStops=[new P$({ratio:0,color:new Ae("rgba(255, 140, 0, 0)")}),new P$({ratio:.75,color:new Ae("rgba(255, 140, 0, 1)")}),new P$({ratio:.9,color:new Ae("rgba(255, 0,   0, 1)")})],this.field=null,this.fieldOffset=0,this.maxPixelIntensity=100,this.minPixelIntensity=0,this.type="heatmap"}async collectRequiredFields(t,e){const i=this.field;i&&typeof i=="string"&&Na(t,e,i)}getAttributeHash(){return null}getMeshHash(){return`${JSON.stringify(this.colorStops)}.${this.blurRadius}.${this.field}`}clone(){return new g8({blurRadius:this.blurRadius,colorStops:ie(this.colorStops),field:this.field,maxPixelIntensity:this.maxPixelIntensity,minPixelIntensity:this.minPixelIntensity})}};u([d({type:Number,json:{write:!0}})],Au.prototype,"blurRadius",void 0),u([d({type:[P$],json:{write:!0}})],Au.prototype,"colorStops",void 0),u([d({type:String,json:{write:!0}})],Au.prototype,"field",void 0),u([d({type:Number,json:{write:{overridePolicy:(t,e,i)=>({enabled:i==null})}}})],Au.prototype,"fieldOffset",void 0),u([d({type:Number,json:{write:!0}})],Au.prototype,"maxPixelIntensity",void 0),u([d({type:Number,json:{write:!0}})],Au.prototype,"minPixelIntensity",void 0),u([Xe({heatmap:"heatmap"})],Au.prototype,"type",void 0),Au=g8=u([R("esri.renderers.HeatmapRenderer")],Au);const HRe=Au;var y8;let qy=y8=class extends rS(Mf){constructor(t){super(t),this.description=null,this.label=null,this.symbol=null,this.type="simple"}async collectRequiredFields(t,e){await Promise.all([this.collectSymbolFields(t,e),this.collectVVRequiredFields(t,e)])}async collectSymbolFields(t,e){await Promise.all(this.getSymbols().map(i=>i.collectRequiredFields(t,e)))}getSymbol(t,e){return this.symbol}async getSymbolAsync(t,e){return this.symbol}getSymbols(){return this.symbol?[this.symbol]:[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((t,e)=>t+JSON.stringify(e),"")}get arcadeRequired(){return this.arcadeRequiredForVisualVariables}clone(){return new y8({description:this.description,label:this.label,symbol:this.symbol&&this.symbol.clone(),visualVariables:ie(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}};u([d({type:String,json:{write:!0}})],qy.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],qy.prototype,"label",void 0),u([d(nS)],qy.prototype,"symbol",void 0),u([Xe({simple:"simple"})],qy.prototype,"type",void 0),qy=y8=u([R("esri.renderers.SimpleRenderer")],qy);const v8=qy,WRe=["esri.Color","esri.portal.Portal","esri.symbols.support.Symbol3DAnchorPosition2D","esri.symbols.support.Symbol3DAnchorPosition3D"];function _8(t){return t instanceof ve}function Ute(t){return t instanceof We?Object.keys(t.items):_8(t)?Ea(t).keys():t?Object.keys(t):[]}function A$(t,e){return t instanceof We?t.items[e]:t[e]}function ZRe(t,e){return!(!Array.isArray(t)||!Array.isArray(e))&&t.length!==e.length}function aS(t){return t?t.declaredClass:null}function jte(t,e){const i=t.diff;if(i&&typeof i=="function")return i(t,e);const r=Ute(t),s=Ute(e);if(r.length===0&&s.length===0)return;if(!r.length||!s.length||ZRe(t,e))return{type:"complete",oldValue:t,newValue:e};const n=s.filter(p=>r.indexOf(p)===-1),o=r.filter(p=>s.indexOf(p)===-1),a=r.filter(p=>s.indexOf(p)>-1&&A$(t,p)!==A$(e,p)).concat(n,o).sort(),l=aS(t);if(l&&WRe.indexOf(l)>-1&&a.length)return{type:"complete",oldValue:t,newValue:e};let c;const h=_8(t)&&_8(e);for(const p of a){const f=A$(t,p),g=A$(e,p);let y;(h||typeof f!="function"&&typeof g!="function")&&f!==g&&(f==null&&g==null||(y=i&&i[p]&&typeof i[p]=="function"?i[p](f,g):typeof f=="object"&&typeof g=="object"&&aS(f)===aS(g)?jte(f,g):{type:"complete",oldValue:f,newValue:g},_(y)&&(_(c)?c.diff[p]=y:c={type:"partial",diff:{[p]:y}})))}return c}function JRe(t,e){if(A(t))return!1;const i=e.split(".");let r=t;for(const s of i){if(r.type==="complete")return!0;if(r.type!=="partial")return!1;{const n=r.diff[s];if(!n)return!1;r=n}}return!0}function Uot(t,e){for(const i of e)if(JRe(t,i))return!0;return!1}function QRe(t,e){if(!(typeof t=="function"||typeof e=="function"||A(t)&&A(e)))return A(t)||A(e)||typeof t=="object"&&typeof e=="object"&&aS(t)!==aS(e)?{type:"complete",oldValue:t,newValue:e}:jte(t,e)}function $$(t){if(A(t))return!0;switch(t.type){case"complete":return!1;case"collection":{const e=t;for(const i of e.added)if(!$$(i))return!1;for(const i of e.removed)if(!$$(i))return!1;for(const i of e.changed)if(!$$(i))return!1;return!0}case"partial":for(const e in t.diff)if(!$$(t.diff[e]))return!1;return!0}}var b8;let Hy=b8=class extends ge{constructor(t){super(t),this.description=null,this.label=null,this.symbol=null,this.value=null}clone(){return new b8({value:this.value,description:this.description,label:this.label,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const t=JSON.stringify(this.symbol&&this.symbol.toJSON());return`${this.value}.${t}`}};u([d({type:String,json:{write:!0}})],Hy.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Hy.prototype,"label",void 0),u([d(nS)],Hy.prototype,"symbol",void 0),u([d({type:[String,Number],json:{type:String,write:{writer:(t,e)=>{e.value=t==null?void 0:t.toString()}}}})],Hy.prototype,"value",void 0),Hy=b8=u([R("esri.renderers.support.UniqueValueInfo")],Hy);const E$=Hy,YRe=()=>!!ae("enable-feature:force-wosr"),w8=()=>!!ae("enable-feature:disable-context-navigation"),jot=()=>!!ae("enable-feature:direct-3d-object-feature-layer-display"),x8={};async function XRe(t,e){try{return{data:(await iIe(t,e)).data,baseUrl:Wve(t),styleUrl:t}}catch(i){return Wc(i),null}}function KRe(t,e,i){const r=e&&e.portal||po.getDefault();let s;const n=`${r.url} - ${r.user&&r.user.username} - ${t}`;return x8[n]||(x8[n]=eIe(t,r,i).then(o=>(s=o,o.fetchData())).then(o=>({data:o,baseUrl:s.itemUrl,styleName:t}))),x8[n]}function eIe(t,e,i){return e.load(i).then(()=>{const r=new Dh({disableExtraQuery:!0,query:`owner:${Bte} AND type:${Gte} AND typekeywords:"${t}"`});return e.queryItems(r,i)}).then(({results:r})=>{let s=null;const n=t.toLowerCase();if(r&&Array.isArray(r)){for(const o of r)if(o.typeKeywords.some(a=>a.toLowerCase()===n)&&o.type===Gte&&o.owner===Bte){s=o;break}}if(!s)throw new Q("symbolstyleutils:style-not-found",`The style '${t}' could not be found`,{styleName:t});return s.load(i)})}function tIe(t,e,i){return t.styleUrl?XRe(t.styleUrl,i):t.styleName?KRe(t.styleName,e,i):Promise.reject(new Q("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function Bot(t){return t===null||t.type==="CIMSymbolReference"?t:{type:"CIMSymbolReference",symbol:t}}function Got(t,e){if(e==="cimRef")return t.cimRef;if(t.formatInfos&&!YRe()){for(const i of t.formatInfos)if(i.type==="gltf")return i.href}return t.webRef}function iIe(t,e){const i=E({responseType:"json",query:{f:"json"}},e);return vt(Ia(t),i)}const Bte="esri_en",Gte="Style",qot="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";var lS;const Wy=le.getLogger("esri.renderers.UniqueValueRenderer"),rIe=Ni(E$);let mr=lS=class extends rS(Mf){constructor(t){super(t),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this.type="unique-value",this.backgroundFillSymbol=null,this.field=null,this.field2=null,this.field3=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.fieldDelimiter=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(e,i){if(!e&&!i)return;if(!e||!i)return{type:"complete",oldValue:e,newValue:i};let r=!1;const s={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let n=0;n<i.length;n++){const o=e.find(a=>a.value===i[n].value);o?QRe(o,i[n])?(s.changed.push({type:"complete",oldValue:o,newValue:i[n]}),r=!0):s.unchanged.push({oldValue:o,newValue:i[n]}):(s.added.push(i[n]),r=!0)}for(let n=0;n<e.length;n++)i.find(o=>o.value===e[n].value)||(s.removed.push(e[n]),r=!0);return r?s:void 0}},this._set("uniqueValueInfos",[])}get _cache(){return{compiledFunc:null}}castField(t){return t==null||typeof t=="function"?t:Kw(t)}writeField(t,e,i,r){typeof t=="string"?e[i]=t:r&&r.messages?r.messages.push(new Q("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):Wy.error(".field: cannot write field to JSON since it's not a string value")}set defaultSymbol(t){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",t)}readPortal(t,e,i){return i.portal||po.getDefault()}readStyleOrigin(t,e,i){if(e.styleName)return Object.freeze({styleName:e.styleName});if(e.styleUrl){const r=_1(e.styleUrl,i);return Object.freeze({styleUrl:r})}}writeStyleOrigin(t,e,i,r){t.styleName?e.styleName=t.styleName:t.styleUrl&&(e.styleUrl=Jg(t.styleUrl,r))}set uniqueValueInfos(t){this.styleOrigin?Wy.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",t),this._updateValueInfoMap())}addUniqueValueInfo(t,e){if(this.styleOrigin)return void Wy.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let i;i=typeof t=="object"?rIe(t):new E$({value:t,symbol:SZ(e)}),this.uniqueValueInfos.push(i),this._valueInfoMap[i.value]=i}removeUniqueValueInfo(t){if(this.styleOrigin)Wy.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(let e=0;e<this.uniqueValueInfos.length;e++)if(this.uniqueValueInfos[e].value===t+""){delete this._valueInfoMap[t],this.uniqueValueInfos.splice(e,1);break}}async getUniqueValueInfo(t,e){let i=e;return this.valueExpression&&(A(e)||A(e.arcade))&&(i=he(E({},i),{arcade:await su()})),this._getUniqueValueInfo(t,i)}getSymbol(t,e){if(this.valueExpression&&(A(e)||A(e.arcade)))return void Wy.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const i=this._getUniqueValueInfo(t,e);return i&&i.symbol||this.defaultSymbol}async getSymbolAsync(t,e){let i=e;if(this.valueExpression&&(A(i)||A(i.arcade))){const s=await su(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),i=he(E({},i),{arcade:s})}const r=this._getUniqueValueInfo(t,i);return r&&r.symbol||this.defaultSymbol}getSymbols(){const t=[];for(const e of this.uniqueValueInfos)e.symbol&&t.push(e.symbol);return this.defaultSymbol&&t.push(this.defaultSymbol),t}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){return`${JSON.stringify(this.backgroundFillSymbol)}.${JSON.stringify(this.defaultSymbol)}.${this.uniqueValueInfos.reduce((t,e)=>t+e.getMeshHash(),"")}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){const t=new lS({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:ie(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:ie(this.visualVariables),legendOptions:ie(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:ie(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(t._isDefaultSymbolDerived=!0),t._set("portal",this.portal);const e=ie(this.uniqueValueInfos);return this.styleOrigin&&(t._set("styleOrigin",Object.freeze(ie(this.styleOrigin))),Object.freeze(e)),t._set("uniqueValueInfos",e),t._updateValueInfoMap(),t}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(t,e){const i=[this.collectVVRequiredFields(t,e),this.collectSymbolFields(t,e)];await Promise.all(i)}async collectSymbolFields(t,e){const i=[...this.getSymbols().map(r=>r.collectRequiredFields(t,e)),Qo(t,e,this.valueExpression)];Na(t,e,this.field),Na(t,e,this.field2),Na(t,e,this.field3),await Promise.all(i)}populateFromStyle(){return tIe(this.styleOrigin,{portal:this.portal}).then(t=>{const e=[];return this._valueInfoMap={},t&&t.data&&Array.isArray(t.data.items)&&t.data.items.forEach(i=>{const r=new ry({styleUrl:t.styleUrl,styleName:t.styleName,portal:this.portal,name:i.name});this.defaultSymbol||i.name!==t.data.defaultItem||(this.defaultSymbol=r,this._isDefaultSymbolDerived=!0);const s=new E$({value:i.name,symbol:r});e.push(s),this._valueInfoMap[i.name]=s}),this._set("uniqueValueInfos",Object.freeze(e)),!this.defaultSymbol&&this.uniqueValueInfos.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateValueInfoMap(){this._valueInfoMap={},this.uniqueValueInfos.forEach(t=>this._valueInfoMap[t.value+""]=t)}_getUniqueValueInfo(t,e){return this.valueExpression?this._getUnqiueValueInfoForExpression(t,e):this._getUnqiueValueInfoForFields(t)}_getUnqiueValueInfoForExpression(t,e){const{viewingMode:i,scale:r,spatialReference:s,arcade:n}=st(e,{});let o=this._cache.compiledFunc;const a=at(n).arcadeUtils;if(!o){const c=a.createSyntaxTree(this.valueExpression);o=a.createFunction(c),this._cache.compiledFunc=o}const l=a.executeFunction(o,a.createExecContext(t,a.getViewInfo({viewingMode:i,scale:r,spatialReference:s})));return this._valueInfoMap[l+""]}_getUnqiueValueInfoForFields(t){const e=this.field,i=t.attributes;let r;if(typeof e!="function"&&this.field2){const s=this.field2,n=this.field3,o=[];e&&o.push(i[e]),s&&o.push(i[s]),n&&o.push(i[n]),r=o.join(this.fieldDelimiter||"")}else typeof e=="function"?r=e(t):e&&(r=i[e]);return this._valueInfoMap[r+""]}static fromPortalStyle(t,e){const i=new lS(e&&e.properties);i._set("styleOrigin",Object.freeze({styleName:t})),i._set("portal",e&&e.portal||po.getDefault());const r=i.populateFromStyle();return r.catch(s=>{Wy.error(`#fromPortalStyle('${t}'[, ...])`,"Failed to create unique value renderer from style name",s)}),r}static fromStyleUrl(t,e){const i=new lS(e&&e.properties);i._set("styleOrigin",Object.freeze({styleUrl:t}));const r=i.populateFromStyle();return r.catch(s=>{Wy.error(`#fromStyleUrl('${t}'[, ...])`,"Failed to create unique value renderer from style URL",s)}),r}};u([d({readOnly:!0})],mr.prototype,"_cache",null),u([Xe({uniqueValue:"unique-value"})],mr.prototype,"type",void 0),u([d(Fte)],mr.prototype,"backgroundFillSymbol",void 0),u([d({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],mr.prototype,"field",void 0),u([ut("field")],mr.prototype,"castField",null),u([Ee("field")],mr.prototype,"writeField",null),u([d({type:String,json:{write:!0}})],mr.prototype,"field2",void 0),u([d({type:String,json:{write:!0}})],mr.prototype,"field3",void 0),u([d({type:String,json:{write:!0}})],mr.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],mr.prototype,"valueExpressionTitle",void 0),u([d({type:Zz,json:{write:!0}})],mr.prototype,"legendOptions",void 0),u([d({type:String,json:{write:!0}})],mr.prototype,"defaultLabel",void 0),u([d(GB(E({},nS),{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],mr.prototype,"defaultSymbol",null),u([d({type:String,json:{write:!0}})],mr.prototype,"fieldDelimiter",void 0),u([d({type:po,readOnly:!0})],mr.prototype,"portal",void 0),u([Ce("portal",["styleName"])],mr.prototype,"readPortal",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],mr.prototype,"styleOrigin",void 0),u([Ce("styleOrigin",["styleName","styleUrl"])],mr.prototype,"readStyleOrigin",null),u([Ee("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],mr.prototype,"writeStyleOrigin",null),u([d({type:[E$],json:{write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],mr.prototype,"uniqueValueInfos",null),mr=lS=u([R("esri.renderers.UniqueValueRenderer")],mr);const S8=mr,qte={key:"type",base:Mf,typeMap:{heatmap:HRe,simple:v8,"unique-value":S8,"class-breaks":kte,"dot-density":qRe,dictionary:Nte},errorContext:"renderer"},sIe={key:"type",base:Mf,typeMap:{simple:v8,"unique-value":S8,"class-breaks":kte},errorContext:"renderer"},nIe=Gv({types:qte});function oIe(t,e,i){return t?t&&(t.styleName||t.styleUrl)&&t.type!=="uniqueValue"?(i&&i.messages&&i.messages.push(new Go("renderer:unsupported","Only UniqueValueRenderer can be referenced from a web style, but found '"+t.type+"'",{definition:t,context:i})),null):nIe(t,e,i):null}class T8{constructor(){this._propertyOriginMap=new Map,this._originStores=new Array(uD),this._values=new Map}clone(e){const i=new T8,r=this._originStores[0];r&&r.forEach((s,n)=>{i.set(n,ie(s),0)});for(let s=2;s<uD;s++){const n=this._originStores[s];n&&n.forEach((o,a)=>{e&&e.has(a)||i.set(a,ie(o),s)})}return i}get(e,i){const r=i===void 0?this._values:this._originStores[i];return r?r.get(e):void 0}keys(e){const i=e==null?this._values:this._originStores[e];return i?[...i.keys()]:[]}set(e,i,r=6){let s=this._originStores[r];if(s||(s=new Map,this._originStores[r]=s),s.set(e,i),!this._values.has(e)||Kr(this._propertyOriginMap.get(e))<=r){const n=this._values.get(e);return this._values.set(e,i),this._propertyOriginMap.set(e,r),n!==i}return!1}delete(e,i=6){const r=this._originStores[i];if(!r)return;const s=r.get(e);if(r.delete(e),this._values.has(e)&&this._propertyOriginMap.get(e)===i){this._values.delete(e);for(let n=i-1;n>=0;n--){const o=this._originStores[n];if(o&&o.has(e)){this._values.set(e,o.get(e)),this._propertyOriginMap.set(e,n);break}}}return s}has(e,i){const r=i===void 0?this._values:this._originStores[i];return!!r&&r.has(e)}revert(e,i){for(;i>0&&!this.has(e,i);)--i;const r=this._originStores[i],s=r&&r.get(e),n=this._values.get(e);return this._values.set(e,s),this._propertyOriginMap.set(e,i),n!==s}originOf(e){return this._propertyOriginMap.get(e)||0}forEach(e){this._values.forEach(e)}}const Hte=t=>{let e=class extends t{constructor(...i){super(...i);const r=Kr(Ea(this)),s=r.metadatas,n=r.store,o=new T8;r.store=o,n.keys().forEach(a=>{o.set(a,n.get(a),0)}),Object.keys(s).forEach(a=>{r.internalGet(a)&&o.set(a,r.internalGet(a),0)})}read(i,r){tq(this,i,r)}getAtOrigin(i,r){const s=C8(this),n=bp(r);if(typeof i=="string")return s.get(i,n);const o={};return i.forEach(a=>{o[a]=s.get(a,n)}),o}originOf(i){return VC(this.originIdOf(i))}originIdOf(i){return C8(this).originOf(i)}revert(i,r){const s=C8(this),n=bp(r),o=Ea(this);let a;a=typeof i=="string"?i==="*"?s.keys(n):[i]:i,a.forEach(l=>{o.invalidate(l),s.revert(l,n),o.commit(l)})}};return e=u([R("esri.core.ReadOnlyMultiOriginJSONSupport")],e),e};function C8(t){return Ea(t).store}let Wte=class extends Hte(ve){};Wte=u([R("esri.core.ReadOnlyMultiOriginJSONSupport")],Wte);const aIe=t=>{let e=class extends t{constructor(...i){super(...i)}clear(i,r="user"){return M8(this).delete(i,bp(r))}write(i={},r){return rq(this,i=i||{},r),i}setAtOrigin(i,r,s){Ea(this).setAtOrigin(i,r,bp(s))}removeOrigin(i){const r=M8(this),s=bp(i),n=r.keys(s);for(const o of n)r.originOf(o)===s&&r.set(o,r.get(o,s),6)}updateOrigin(i,r){const s=M8(this),n=bp(r),o=this.get(i);for(let a=n+1;a<uD;++a)s.delete(i,a);s.set(i,o,n)}toJSON(i){return this.write({},i)}};return e=u([R("esri.core.WriteableMultiOriginJSONSupport")],e),e.prototype.toJSON.isDefaultToJSON=!0,e};function M8(t){return Ea(t).store}const O$=t=>{let e=class extends aIe(Hte(t)){constructor(...i){super(...i)}};return e=u([R("esri.core.MultiOriginJSONSupport")],e),e};let Zte=class extends O$(ve){};Zte=u([R("esri.core.MultiOriginJSONSupport")],Zte);async function lIe(t,e){const{WhereClause:i}=await import("./WhereClause.34680e97.js");return i.create(t,e)}var P8;let Zy=P8=class extends ge{constructor(t){super(t),this.expression=null,this.name=null,this.returnType="boolean",this.title=null}clone(){return new P8({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],Zy.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],Zy.prototype,"name",void 0),u([d({type:["boolean"],json:{write:!0}})],Zy.prototype,"returnType",void 0),u([d({type:String,json:{write:!0}})],Zy.prototype,"title",void 0),Zy=P8=u([R("esri.form.ExpressionInfo")],Zy);const cIe=Zy;let Jy=class extends ge{constructor(t){super(t),this.description=null,this.label=null,this.type=null,this.visibilityExpression=null}};u([d({type:String,json:{write:!0}})],Jy.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Jy.prototype,"label",void 0),u([d()],Jy.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Jy.prototype,"visibilityExpression",void 0),Jy=u([R("esri.form.elements.Element")],Jy);const C_=Jy;var A8;let R$=A8=class extends ge{constructor(t){super(t),this.type=null}clone(){return new A8({type:this.type})}};u([d({type:["attachment","audio","document","image","signature","video"],json:{write:!0}})],R$.prototype,"type",void 0),R$=A8=u([R("esri.form.elements.inputs.AttachmentInput")],R$);const uIe=R$;var $8;let Qy=$8=class extends C_{constructor(t){super(t),this.attachmentKeyword=null,this.editable=!0,this.input=null,this.type="attachment"}clone(){return new $8({attachmentKeyword:this.attachmentKeyword,description:this.description,editable:this.editable,input:this.input,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({type:String,json:{write:!0}})],Qy.prototype,"attachmentKeyword",void 0),u([d({type:Boolean,json:{write:!0}})],Qy.prototype,"editable",void 0),u([d({type:uIe,json:{read:{source:"inputType"},write:{target:"inputType"}}})],Qy.prototype,"input",void 0),u([d({type:["attachment"],json:{read:!1,write:!0}})],Qy.prototype,"type",void 0),Qy=$8=u([R("esri.form.elements.AttachmentElement")],Qy);const Jte=Qy;let I$=class extends ge{constructor(t){super(t),this.type=null}};u([d()],I$.prototype,"type",void 0),I$=u([R("esri.form.elements.inputs.Input")],I$);const M_=I$;let cS=class extends M_{constructor(t){super(t),this.maxLength=null,this.minLength=0}};u([d({type:Number,json:{write:!0}})],cS.prototype,"maxLength",void 0),u([d({type:Number,json:{write:!0}})],cS.prototype,"minLength",void 0),cS=u([R("esri.form.elements.inputs.TextInput")],cS);const E8=cS;var O8;let D$=O8=class extends E8{constructor(t){super(t),this.type="barcode-scanner"}clone(){return new O8({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["barcode-scanner"],json:{read:!1,write:!0}})],D$.prototype,"type",void 0),D$=O8=u([R("esri.form.elements.inputs.BarcodeScannerInput")],D$);const hIe=D$;var R8;let P_=R8=class extends M_{constructor(t){super(t),this.noValueOptionLabel=null,this.showNoValueOption=!1,this.type="combo-box"}clone(){return new R8({showNoValueOption:this.showNoValueOption,noValueOptionLabel:this.noValueOptionLabel})}};u([d({type:String,json:{write:!0}})],P_.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],P_.prototype,"showNoValueOption",void 0),u([d({type:["combo-box"],json:{read:!1,write:!0}})],P_.prototype,"type",void 0),P_=R8=u([R("esri.form.elements.inputs.ComboBoxInput")],P_);const dIe=P_;var I8;function Qte(t){return t!=null?new Date(t):null}function Yte(t){return t?t.getTime():null}let _c=I8=class extends M_{constructor(t){super(t),this.includeTime=!1,this.max=null,this.min=null,this.type="datetime-picker"}readMax(t,e){return Qte(e.max)}writeMax(t,e){e.max=Yte(t)}readMin(t,e){return Qte(e.min)}writeMin(t,e){e.min=Yte(t)}clone(){return new I8({includeTime:this.includeTime,max:this.max,min:this.min,type:this.type})}};u([d({type:Boolean,json:{write:!0}})],_c.prototype,"includeTime",void 0),u([d({type:Date,json:{type:Number,write:!0}})],_c.prototype,"max",void 0),u([Ce("max")],_c.prototype,"readMax",null),u([Ee("max")],_c.prototype,"writeMax",null),u([d({type:Date,json:{type:Number,write:!0}})],_c.prototype,"min",void 0),u([Ce("min")],_c.prototype,"readMin",null),u([Ee("min")],_c.prototype,"writeMin",null),u([d({type:["datetime-picker"],json:{read:!1,write:!0}})],_c.prototype,"type",void 0),_c=I8=u([R("esri.form.elements.inputs.DateTimePickerInput")],_c);const pIe=_c;var D8;let A_=D8=class extends M_{constructor(t){super(t),this.noValueOptionLabel=null,this.showNoValueOption=!1,this.type="radio-buttons"}clone(){return new D8({noValueOptionLabel:this.noValueOptionLabel,showNoValueOption:this.showNoValueOption})}};u([d({type:String,json:{write:!0}})],A_.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],A_.prototype,"showNoValueOption",void 0),u([d({type:["radio-buttons"],json:{read:!1,write:!0}})],A_.prototype,"type",void 0),A_=D8=u([R("esri.form.elements.inputs.RadioButtonsInput")],A_);const fIe=A_;var F8;let $_=F8=class extends M_{constructor(t){super(t),this.offValue=null,this.onValue=null,this.type="switch"}clone(){return new F8({offValue:this.offValue,onValue:this.onValue})}};u([d({type:[String,Number],json:{write:!0}})],$_.prototype,"offValue",void 0),u([d({type:[String,Number],json:{write:!0}})],$_.prototype,"onValue",void 0),u([d({type:["switch"],json:{read:!1,write:!0}})],$_.prototype,"type",void 0),$_=F8=u([R("esri.form.elements.inputs.SwitchInput")],$_);const mIe=$_;var L8;let F$=L8=class extends E8{constructor(t){super(t),this.type="text-area"}clone(){return new L8({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-area"],json:{read:!1,write:!0}})],F$.prototype,"type",void 0),F$=L8=u([R("esri.form.elements.inputs.TextAreaInput")],F$);const gIe=F$;var k8;let L$=k8=class extends E8{constructor(t){super(t),this.type="text-box"}clone(){return new k8({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-box"],json:{read:!1,write:!0}})],L$.prototype,"type",void 0),L$=k8=u([R("esri.form.elements.inputs.TextBoxInput")],L$);const yIe=L$,vIe={base:M_,key:"type",typeMap:{"barcode-scanner":hIe,"combo-box":dIe,"datetime-picker":pIe,"radio-buttons":fIe,switch:mIe,"text-area":gIe,"text-box":yIe}};var z8;let $u=z8=class extends C_{constructor(t){super(t),this.domain=null,this.editable=!0,this.fieldName=null,this.hint=null,this.input=null,this.requiredExpression=null,this.type="field"}clone(){return new z8({description:this.description,domain:this.domain,editable:this.editable,fieldName:this.fieldName,hint:this.hint,input:this.input,label:this.label,requiredExpression:this.requiredExpression,visibilityExpression:this.visibilityExpression})}};u([d({types:OX,json:{read:{reader:Ek},write:!0}})],$u.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],$u.prototype,"editable",void 0),u([d({type:String,json:{write:!0}})],$u.prototype,"fieldName",void 0),u([d({type:String,json:{write:!0}})],$u.prototype,"hint",void 0),u([d({types:vIe,json:{read:{source:"inputType"},write:{target:"inputType"}}})],$u.prototype,"input",void 0),u([d({type:String,json:{write:!0}})],$u.prototype,"requiredExpression",void 0),u([d({type:String,json:{read:!1,write:!0}})],$u.prototype,"type",void 0),$u=z8=u([R("esri.form.elements.FieldElement")],$u);const Xte=$u;var V8;let od=V8=class extends C_{constructor(t){super(t),this.displayCount=null,this.displayType="list",this.editable=!0,this.orderByFields=null,this.relationshipId=null,this.type="relationship"}clone(){return new V8({description:this.description,displayCount:this.displayCount,displayType:this.displayType,editable:this.editable,label:this.label,orderByFields:ie(this.orderByFields),relationshipId:this.relationshipId,visibilityExpression:this.visibilityExpression})}};u([d({type:Number,json:{write:!0}})],od.prototype,"displayCount",void 0),u([d({type:["list"],json:{write:!0}})],od.prototype,"displayType",void 0),u([d({type:Boolean,json:{write:!0}})],od.prototype,"editable",void 0),u([d({type:[OW],json:{write:!0}})],od.prototype,"orderByFields",void 0),u([d({type:Number,json:{write:!0}})],od.prototype,"relationshipId",void 0),u([d({type:["relationship"],json:{read:!1,write:!0}})],od.prototype,"type",void 0),od=V8=u([R("esri.form.elements.RelationshipElement")],od);const Kte=od;function eie(t){return{typesWithGroup:{base:C_,key:"type",typeMap:{attachment:Jte,field:Xte,group:t,relationship:Kte}},typesWithoutGroup:{base:C_,key:"type",typeMap:{attachment:Jte,field:Xte,relationship:Kte}}}}function tie(t,e,i=!0){if(!t)return null;const r=i?e.typesWithGroup.typeMap:e.typesWithoutGroup.typeMap;return t.filter(s=>r[s.type]).map(s=>r[s.type].fromJSON(s))}function iie(t,e,i=!0){if(!t)return null;const r=i?e.typesWithGroup.typeMap:e.typesWithoutGroup.typeMap;return t.filter(s=>r[s.type]).map(s=>s.toJSON())}function rie(t,e,i=!0){return t?t.map(r=>Zc(i?e.typesWithGroup:e.typesWithoutGroup,r)):null}var N8;let Eu=N8=class extends C_{constructor(t){super(t),this.elements=null,this.initialState="expanded",this.type="group"}castElements(t){return rie(t,U8,!1)}readElements(t,e){return tie(e.formElements,U8,!1)}writeElements(t,e){e.formElements=iie(t,U8,!1)}clone(){return new N8({description:this.description,elements:ie(this.elements),initialState:this.initialState,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({json:{write:!0}})],Eu.prototype,"elements",void 0),u([ut("elements")],Eu.prototype,"castElements",null),u([Ce("elements",["formElements"])],Eu.prototype,"readElements",null),u([Ee("elements")],Eu.prototype,"writeElements",null),u([d({type:["collapsed","expanded"],json:{write:!0}})],Eu.prototype,"initialState",void 0),u([d({type:String,json:{read:!1,write:!0}})],Eu.prototype,"type",void 0),Eu=N8=u([R("esri.form.elements.GroupElement")],Eu);const U8=eie(Eu),_Ie=Eu;var j8;const B8=eie(_Ie);let Ou=j8=class extends ge{constructor(t){super(t),this.description=null,this.elements=null,this.expressionInfos=null,this.title=null}castElements(t){return rie(t,B8)}readElements(t,e){return tie(e.formElements,B8)}writeElements(t,e){e.formElements=iie(t,B8)}clone(){return new j8({description:this.description,expressionInfos:ie(this.expressionInfos),elements:ie(this.elements),title:this.title})}};u([d({type:String,json:{write:!0}})],Ou.prototype,"description",void 0),u([d({json:{write:!0}})],Ou.prototype,"elements",void 0),u([ut("elements")],Ou.prototype,"castElements",null),u([Ce("elements",["formElements"])],Ou.prototype,"readElements",null),u([Ee("elements")],Ou.prototype,"writeElements",null),u([d({type:[cIe],json:{write:!0}})],Ou.prototype,"expressionInfos",void 0),u([d({type:String,json:{write:!0}})],Ou.prototype,"title",void 0),Ou=j8=u([R("esri.form.FormTemplate")],Ou);const bIe=Ou;function sie(t,e,i){if(t.hasM==null||t.hasZ)for(const r of e)for(const s of r)s.length>2&&(s[2]*=i)}function wIe(t,e,i){if(!t&&!e||!i)return;const r=A1(i);nie(t,i,r),nie(e,i,r)}function nie(t,e,i){if(t)for(const r of t)xIe(r.geometry,e,i)}function xIe(t,e,i){if(A(t)||!t.spatialReference||Da(t.spatialReference,e))return;const r=A1(t.spatialReference)/i;if(r!==1){if("x"in t)t.z!=null&&(t.z*=r);else if("rings"in t)sie(t,t.rings,r);else if("paths"in t)sie(t,t.paths,r);else if("points"in t&&(t.hasM==null||t.hasZ))for(const s of t.points)s.length>2&&(s[2]*=r)}}let SIe=0;const G8=le.getLogger("esri.layers.graphics.sources.MemorySource");let Ef=class extends Ph.LoadableMixin(rx(tu(We))){constructor(t){super(t),this._idToClientGraphic=null,this.type="memory"}load(t){const e=_(t)?t.signal:null;return this.addResolvingPromise(this._startWorker(e)),Promise.resolve(this)}destroy(){var t;(t=this._connection)==null||t.close(),this._connection=null}get workerGeometryType(){var t;const e=(t=this.layer)==null?void 0:t.geometryType;return e?this._geometryTypeRequiresClientGraphicMapping(e)?"polygon":e:null}applyEdits(t){return this.load().then(()=>this._applyEdits(t))}openPorts(){return this.load().then(()=>this._connection.openPorts())}async queryFeatures(t,e={}){await this.load(e);const i=await this._connection.invoke("queryFeatures",t?t.toJSON():null,e);jA(t,this.layer.spatialReference,i);const r=Cu.fromJSON(i);if(!this._requiresClientGraphicMapping())return r;const s=this.layer.objectIdField;for(const n of r.features){const o=n.attributes[s],a=this._idToClientGraphic.get(o);a&&(n.geometry=a.geometry)}return r.geometryType=this.layer.geometryType,r}async queryFeaturesJSON(t,e={}){if(this._requiresClientGraphicMapping())throw new Q("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)");await this.load(e);const i=await this._connection.invoke("queryFeatures",t?t.toJSON():null,e);return jA(t,this.layer.spatialReference,i),i}queryFeatureCount(t,e={}){return this.load(e).then(()=>this._connection.invoke("queryFeatureCount",t?t.toJSON():null,e))}queryObjectIds(t,e={}){return this.load(e).then(()=>this._connection.invoke("queryObjectIds",t?t.toJSON():null,e))}queryExtent(t,e={}){return this.load(e).then(()=>this._connection.invoke("queryExtent",t?t.toJSON():null,e)).then(i=>({count:i.count,extent:ht.fromJSON(i.extent)}))}querySnapping(t,e={}){return this.load(e).then(()=>this._connection.invoke("querySnapping",t,e))}async _applyEdits(t){if(!this._connection)throw new Q("feature-layer-source:edit-failure","Memory source not loaded");const e=this.layer.objectIdField;let i=null;const r=[],s=[];await Promise.all([this._prepareClientMapping(t.addFeatures,null),this._prepareClientMapping(t.updateFeatures,null)]);const n=c=>"objectId"in c&&c.objectId!=null?c.objectId:"attributes"in c&&c.attributes[e]!=null?c.attributes[e]:null;if(t.addFeatures&&(i=this._prepareAddFeatures(t.addFeatures)),t.deleteFeatures)for(const c of t.deleteFeatures){const h=n(c);h!=null&&r.push(h)}const o=t.updateFeatures&&this._idToClientGraphic?new Map:null;if(t.updateFeatures){for(const c of t.updateFeatures)if(s.push(this._serializeFeature(c)),o){const h=n(c);h!=null&&o.set(h,c)}}wIe(i?i.features:null,s,this.layer.spatialReference);const{fullExtent:a,featureEditResults:l}=await this._connection.invoke("applyEdits",{adds:i?i.features:[],updates:s,deletes:r});return this.fullExtent=a,i&&i.finish(l.uidToObjectId),this._updateClientGraphicIds(o,l),this._createEditsResult(l)}async _prepareClientMapping(t,e){if(this.layerOrSourceGeometryType!=="mesh"||A(t))return;const i=[];for(const{geometry:r}of t)!_(r)||r.type!=="mesh"||r.hasExtent||r.loaded||i.push(r.load({signal:e}));i.length&&await Promise.all(i)}_updateClientGraphicIds(t,e){if(this._idToClientGraphic){if(t)for(const i of e.updateResults){if(!i.success)continue;const r=t.get(i.objectId);r!=null&&this._addIdToClientGraphic(r)}for(const i of e.deleteResults)i.success&&this._idToClientGraphic.delete(i.objectId)}}_createEditsResult(t){return{addFeatureResults:t.addResults?t.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:t.updateResults?t.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:t.deleteResults?t.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}_createFeatureEditResult(t){const e=t.success===!0?null:t.error||{code:void 0,description:void 0};return{objectId:t.objectId,globalId:t.globalId,error:e?new Q("feature-layer-source:edit-failure",e.description,{code:e.code}):null}}_prepareAddFeatures(t){const e=new Map,i=new Array(t.length);let r=null;for(let n=0;n<t.length;n++){const o=t[n],a=this._serializeFeature(o);!r&&_(o.geometry)&&(r=o.geometry.type),i[n]=a,e.set(`${a.uid}`,o)}const s=this;return{features:i,inferredGeometryType:r,finish(n){const o=s.sourceJSON.objectIdField;for(const a in n){const l=n[a],c=e.get(a);c&&(c.attributes||(c.attributes={}),l===-1?delete c.attributes[o]:c.attributes[o]=l,s._addIdToClientGraphic(c))}}}}_addIdToClientGraphic(t){if(!this._idToClientGraphic)return;const e=this.sourceJSON.objectIdField,i=t.attributes&&t.attributes[e];i!=null&&this._idToClientGraphic.set(i,t)}get layerOrSourceGeometryType(){var t,e,i;return(t=(e=this.layer)==null?void 0:e.geometryType)!=null?t:(i=this.sourceJSON)==null?void 0:i.geometryType}_requiresClientGraphicMapping(){return this._geometryTypeRequiresClientGraphicMapping(this.layerOrSourceGeometryType)}_geometryRequiresClientGraphicMapping(t){return this._geometryTypeRequiresClientGraphicMapping(t.type)}_geometryTypeRequiresClientGraphicMapping(t){return t==="mesh"||t==="multipatch"||t==="extent"}_serializeFeature(t){const{attributes:e}=t,i=this._geometryForSerialization(t),r=(SIe++).toString();return i?{uid:r,geometry:i.toJSON(),attributes:e}:{uid:r,attributes:e}}_geometryForSerialization(t){const{geometry:e}=t;return A(e)?null:this._geometryRequiresClientGraphicMapping(e)?e.extent?Zo.fromExtent(e.extent):null:e}async _startWorker(t){this._connection=await jZ("MemorySourceWorker",{strategy:ae("feature-layers-workers")?"dedicated":"local",signal:t});const{fields:e,spatialReference:i,objectIdField:r,hasM:s,hasZ:n,timeInfo:o}=this.layer,a=this.layer.originOf("spatialReference")==="defaults";await this._prepareClientMapping(this.items,t);const l=this._prepareAddFeatures(this.items);this.handles.add(this.on("before-changes",f=>{G8.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),f.preventDefault()}));const c={features:l.features,fields:e&&e.map(f=>f.toJSON()),geometryType:tW.toJSON(this.workerGeometryType),hasM:this.layerOrSourceGeometryType!=="mesh"&&s,hasZ:this.layerOrSourceGeometryType==="mesh"||n,objectIdField:r,spatialReference:a?null:i&&i.toJSON(),timeInfo:o?o.toJSON():null},h=await this._connection.invoke("load",c,{signal:t});for(const f of h.warnings)G8.warn(f.message,{layer:this.layer,warning:f});h.featureErrors.length&&G8.warn(`Encountered ${h.featureErrors.length} validation errors while loading features`,h.featureErrors);const p=h.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(l.inferredGeometryType)&&(p.geometryType=tW.toJSON(l.inferredGeometryType)),this.sourceJSON=p,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),l.finish(h.assignedObjectIds)}};u([zD({Type:pn,ensureType:Ni(pn)})],Ef.prototype,"itemType",void 0),u([d()],Ef.prototype,"type",void 0),u([d({constructOnly:!0})],Ef.prototype,"layer",void 0),u([d({readOnly:!0})],Ef.prototype,"workerGeometryType",null),u([d()],Ef.prototype,"sourceJSON",void 0),Ef=u([R("esri.layers.graphics.sources.MemorySource")],Ef);const oie=Ef;function TIe(t){return"portalItem"in t}const CIe=t=>{let e=class extends t{get apiKey(){var i;return this._isOverridden("apiKey")?this._get("apiKey"):TIe(this)?(i=this.portalItem)==null?void 0:i.apiKey:null}set apiKey(i){i!=null?this._override("apiKey",i):(this._clearOverride("apiKey"),this.clear("apiKey","user"))}};return u([d({type:String})],e.prototype,"apiKey",null),e=u([R("esri.layers.mixins.APIKeyMixin")],e),e},aie=t=>{let e=class extends t{get title(){if(this._get("title")&&this.originOf("title")!=="defaults")return this._get("title");if(this.url){const i=D2(this.url);if(_(i)&&i.title)return i.title}return this._get("title")||""}set title(i){this._set("title",i)}set url(i){this._set("url",WPe(i,le.getLogger(this.declaredClass)))}};return u([d()],e.prototype,"title",null),u([d({type:String})],e.prototype,"url",null),e=u([R("esri.layers.mixins.ArcGISService")],e),e};function uS(){const t=new Float32Array(16);return t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function MIe(t){const e=new Float32Array(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function PIe(t,e,i,r,s,n,o,a,l,c,h,p,f,g,y,v){const b=new Float32Array(16);return b[0]=t,b[1]=e,b[2]=i,b[3]=r,b[4]=s,b[5]=n,b[6]=o,b[7]=a,b[8]=l,b[9]=c,b[10]=h,b[11]=p,b[12]=f,b[13]=g,b[14]=y,b[15]=v,b}function AIe(t,e){return new Float32Array(t,e,16)}const $Ie=uS();Object.freeze({__proto__:null,create:uS,clone:MIe,fromValues:PIe,createView:AIe,IDENTITY:$Ie});const EIe=(t,e)=>{const i=_u(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1);return Nn(i,i)},OIe=(t,e)=>{const i=_u(t,e,0,0,.5-.5*e,0,e,0,.5-.5*e,0,0,e,.5-.5*e,0,0,0,1);return Nn(i,i)},RIe=(t,e)=>{const i=1-e,r=_u(t,.2126+.7874*i,.7152-.7152*i,.0722-.0722*i,0,.2126-.2126*i,.7152+.2848*i,.0722-.0722*i,0,.2126-.2126*i,.7152-.7152*i,.0722+.9278*i,0,0,0,0,1);return Nn(r,r)},IIe=(t,e)=>{const i=Math.sin(e*Math.PI/180),r=Math.cos(e*Math.PI/180),s=_u(t,.213+.787*r-.213*i,.715-.715*r-.715*i,.072-.072*r+.928*i,0,.213-.213*r+.143*i,.715+.285*r+.14*i,.072-.072*r-.283*i,0,.213-.213*r-.787*i,.715-.715*r+.715*i,.072+.928*r+.072*i,0,0,0,0,1);return Nn(s,s)},DIe=(t,e)=>{const i=1-2*e,r=_u(t,i,0,0,e,0,i,0,e,0,0,i,e,0,0,0,1);return Nn(r,r)},FIe=(t,e)=>{const i=_u(t,.213+.787*e,.715-.715*e,.072-.072*e,0,.213-.213*e,.715+.285*e,.072-.072*e,0,.213-.213*e,.715-.715*e,.072+.928*e,0,0,0,0,1);return Nn(i,i)},LIe=(t,e)=>{const i=1-e,r=_u(t,.393+.607*i,.769-.769*i,.189-.189*i,0,.349-.349*i,.686+.314*i,.168-.168*i,0,.272-.272*i,.534-.534*i,.131+.869*i,0,0,0,0,1);return Nn(r,r)};class k${constructor(e,i,r){this.strength=e,this.radius=i,this.threshold=r,this.type="bloom"}interpolate(e,i,r){this.strength=Po(e.strength,i.strength,r),this.radius=Po(e.radius,i.radius,r),this.threshold=Po(e.threshold,i.threshold,r)}clone(){return new k$(this.strength,this.radius,this.threshold)}toJSON(){return{type:"bloom",radius:dS(this.radius),strength:this.strength,threshold:this.threshold}}}class z${constructor(e){this.radius=e,this.type="blur"}interpolate(e,i,r){this.radius=Math.round(Po(e.radius,i.radius,r))}clone(){return new z$(this.radius)}toJSON(){return{type:"blur",radius:dS(this.radius)}}}class hS{constructor(e,i){this.type=e,this.amount=i,this.type!=="invert"&&this.type!=="grayscale"&&this.type!=="sepia"||(this.amount=Math.min(this.amount,1))}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(e,i,r){this.amount=Po(e.amount,i.amount,r),this._updateMatrix()}clone(){return new hS(this.type,this.amount)}toJSON(){return{type:this.type,amount:this.amount}}_updateMatrix(){const e=this._colorMatrix||uS();switch(this.type){case"brightness":this._colorMatrix=EIe(e,this.amount);break;case"contrast":this._colorMatrix=OIe(e,this.amount);break;case"grayscale":this._colorMatrix=RIe(e,this.amount);break;case"invert":this._colorMatrix=DIe(e,this.amount);break;case"saturate":this._colorMatrix=FIe(e,this.amount);break;case"sepia":this._colorMatrix=LIe(e,this.amount)}}}class V${constructor(e,i,r,s){this.offsetX=e,this.offsetY=i,this.blurRadius=r,this.color=s,this.type="drop-shadow"}interpolate(e,i,r){this.offsetX=Po(e.offsetX,i.offsetX,r),this.offsetY=Po(e.offsetY,i.offsetY,r),this.blurRadius=Po(e.blurRadius,i.blurRadius,r),this.color[0]=Math.round(Po(e.color[0],i.color[0],r)),this.color[1]=Math.round(Po(e.color[1],i.color[1],r)),this.color[2]=Math.round(Po(e.color[2],i.color[2],r)),this.color[3]=Po(e.color[3],i.color[3],r)}clone(){return new V$(this.offsetX,this.offsetY,this.blurRadius,[...this.color])}toJSON(){const e=[...this.color];return e[3]*=255,{type:"drop-shadow",xoffset:dS(this.offsetX),yoffset:dS(this.offsetY),blurRadius:dS(this.blurRadius),color:e}}}class N${constructor(e){this.angle=e,this.type="hue-rotate"}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(e,i,r){this.angle=Po(e.angle,i.angle,r),this._updateMatrix()}clone(){return new N$(this.angle)}toJSON(){return{type:"hue-rotate",angle:this.angle}}_updateMatrix(){const e=this._colorMatrix||uS();this._colorMatrix=IIe(e,this.angle)}}class U${constructor(e){this.amount=e,this.type="opacity",this.amount=Math.min(this.amount,1)}interpolate(e,i,r){this.amount=Po(e.amount,i.amount,r)}clone(){return new U$(this.amount)}toJSON(){return{type:"opacity",amount:this.amount}}}function Po(t,e,i){return t+(e-t)*i}function dS(t){return Math.round(1e3*au(t))/1e3}function kIe(t){switch(t.type){case"grayscale":case"sepia":case"invert":return new hS(t.type,0);case"saturate":case"brightness":case"contrast":return new hS(t.type,1);case"opacity":return new U$(1);case"hue-rotate":return new N$(0);case"blur":return new z$(0);case"drop-shadow":return new V$(0,0,0,[..._F("transparent")]);case"bloom":return new k$(0,0,1)}}var q8=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function Hot(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function Wot(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}function zIe(t,e){const i=t.length>e.length?t:e;return(t.length>e.length?e:t).every((r,s)=>r.type===i[s].type)}function VIe(t,e){const i=t.length>e.length?t:e,r=t.length>e.length?e:t;for(let s=r.length;s<i.length;s++)r.push(kIe(i[s]))}function NIe(t){const e=t[0];return!!e&&"type"in e}var lie,cie,uie={exports:{}};function hie(t){if(!t||t.length===0)return null;if(typeof t=="string"){const i=die(t);return i&&i.length!==0?i:null}const e=t.map(i=>{if(!Number.isFinite(i.scale)||i.scale<=0)throw new Q("effect:invalid-scale","scale must be finite and greater than 0",{stop:i});return{scale:i.scale,effects:die(i.value)}});e.sort((i,r)=>r.effects.length-i.effects.length);for(let i=0;i<e.length-1;i++){if(!zIe(e[i].effects,e[i+1].effects))throw new Q("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:e[i].effects,b:e[i+1].effects});VIe(e[i].effects,e[i+1].effects)}return e.sort((i,r)=>r.scale-i.scale),e}function die(t){let e;if(!t)return[];try{e=uie.exports.parse(t)}catch(i){throw new Q("effect:invalid-syntax","Invalid effect syntax",{value:t,error:i})}return e.map(i=>UIe(i))}function UIe(t){try{switch(t.name){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":return jIe(t);case"opacity":return BIe(t);case"hue-rotate":return GIe(t);case"blur":return qIe(t);case"drop-shadow":return HIe(t);case"bloom":return WIe(t)}}catch(e){throw e.details.filter=t,e}throw new Q("effect:unknown-effect",`Effect '${t.name}' is not supported`,{effect:t})}function jIe(t){let e=1;return E_(t.parameters,1),t.parameters.length===1&&(e=bc(t.parameters[0])),new hS(t.name,e)}function BIe(t){let e=1;return E_(t.parameters,1),t.parameters.length===1&&(e=bc(t.parameters[0])),new U$(e)}function GIe(t){let e=0;return E_(t.parameters,1),t.parameters.length===1&&(e=KIe(t.parameters[0])),new N$(e)}function qIe(t){let e=0;return E_(t.parameters,1),t.parameters.length===1&&(e=Z8(t.parameters[0]),pS(e,t.parameters[0])),new z$(e)}function HIe(t){const e=[];let i=null;for(const r of t.parameters)if(r.type==="color"){if(e.length&&Object.freeze(e),i)throw new Q("effect:type-error","Accepts only one color",{});i=e4e(r)}else{const s=Z8(r);if(Object.isFrozen(e))throw new Q("effect:type-error","<length> parameters not consecutive",{lengths:e});e.push(s),e.length===3&&pS(s,r)}if(e.length<2||e.length>3)throw new Q("effect:type-error",`Expected <length>{2,3}, Actual: <length>{${e.length}}`,{lengths:e});return new V$(e[0],e[1],e[2]||0,i||pie("black"))}function WIe(t){let e=1,i=0,r=0;return E_(t.parameters,3),t.parameters[0]&&(e=bc(t.parameters[0])),t.parameters[1]&&(i=Z8(t.parameters[1]),pS(i,t.parameters[1])),t.parameters[2]&&(r=bc(t.parameters[2])),new k$(e,i,r)}function E_(t,e){if(t.length>e)throw new Q("effect:type-error",`Function supports up to ${e} parameters, Actual: ${t.length}`,{parameters:t})}function j$(t){if(t.type==="color")return"<color>";if(t.unit){if(W8[t.unit])return"<length>";if(H8[t.unit])return"<angle>";if(t.unit==="%")return"<percentage>"}return"<double>"}function pS(t,e){if(t<0)throw new Q("effect:type-error",`Negative values are not allowed, Actual: ${t}`,{term:e})}function ZIe(t){if(t.type!=="quantity"||t.unit!==null)throw new Q("effect:type-error",`Expected <double>, Actual: ${j$(t)}`,{term:t})}function JIe(t){if(t.type!=="quantity"||t.unit!==null&&t.unit!=="%")throw new Q("effect:type-error",`Expected <double> or <percentage>, Actual: ${j$(t)}`,{term:t})}cie=function(){function t(s,n){function o(){this.constructor=s}o.prototype=n.prototype,s.prototype=new o}function e(s,n,o,a){var l=Error.call(this,s);return Object.setPrototypeOf&&Object.setPrototypeOf(l,e.prototype),l.expected=n,l.found=o,l.location=a,l.name="SyntaxError",l}function i(s,n,o){return o=o||" ",s.length>n?s:(n-=s.length,s+(o+=o.repeat(n)).slice(0,n))}function r(s,n){var o,a={},l=(n=n!==void 0?n:{}).grammarSource,c={start:TB},h=TB,p="none",f=")",g=",",y="(",v="%",b="px",w="cm",S="mm",T="in",C="pt",M="pc",P="deg",F="rad",z="grad",D="turn",U="#",G=".",k="e",j=/^[ \t\n\r]/,V=/^[a-z\-]/,q=/^[0-9a-fA-F]/,J=/^[+\-]/,O=/^[0-9]/,L=bh("none"),N=hs("none",!1),B=hs(")",!1),W=hs(",",!1),Y=bh("whitespace"),H=jw([" ","	",`
`,"\r"],!1,!1),K=bh("function"),fe=hs("(",!1),ce=bh("identifier"),me=jw([["a","z"],"-"],!1,!1),Ie=bh("percentage"),He=hs("%",!1),$e=bh("length"),Le=hs("px",!1),Ei=hs("cm",!1),rr=hs("mm",!1),Or=hs("in",!1),us=hs("pt",!1),yr=hs("pc",!1),Rr=bh("angle"),lt=hs("deg",!1),wC=hs("rad",!1),qc=hs("grad",!1),Nw=hs("turn",!1),Uw=bh("number"),Ege=bh("color"),Oge=hs("#",!1),bB=jw([["0","9"],["a","f"],["A","F"]],!1,!1),wB=jw(["+","-"],!1,!1),gp=jw([["0","9"]],!1,!1),Rge=hs(".",!1),Ige=hs("e",!1),Dge=function(){return[]},Fge=function(Z,pe){return{type:"function",name:Z,parameters:pe||[]}},Lge=function(Z,pe){return pe.length>0?mye(Z,pe,3):[Z]},kge=function(Z){return{type:"quantity",value:Z.value,unit:Z.unit}},zge=function(Z){return{type:"color",colorType:Z.type,value:Z.value}},Vge=function(Z){return Z},Nge=function(){return SC()},Uge=function(Z){return{value:Z,unit:"%"}},jge=function(Z){return{value:Z,unit:"px"}},Bge=function(Z){return{value:Z,unit:"cm"}},Gge=function(Z){return{value:Z,unit:"mm"}},qge=function(Z){return{value:Z,unit:"in"}},Hge=function(Z){return{value:Z,unit:"pt"}},Wge=function(Z){return{value:Z,unit:"pc"}},Zge=function(Z){return{value:Z,unit:"deg"}},Jge=function(Z){return{value:Z,unit:"rad"}},Qge=function(Z){return{value:Z,unit:"grad"}},Yge=function(Z){return{value:Z,unit:"turn"}},Xge=function(Z){return{value:Z,unit:null}},Kge=function(){return{type:"hex",value:SC()}},eye=function(Z){return{type:"function",value:Z}},tye=function(){return{type:"named",value:SC()}},iye=function(){return parseFloat(SC())},oe=0,Yi=0,xC=[{line:1,column:1}],Hc=0,K4=[],Je=0;if("startRule"in n){if(!(n.startRule in c))throw new Error(`Can't start parsing from rule "`+n.startRule+'".');h=c[n.startRule]}function SC(){return s.substring(Yi,oe)}function hs(Z,pe){return{type:"literal",text:Z,ignoreCase:pe}}function jw(Z,pe,we){return{type:"class",parts:Z,inverted:pe,ignoreCase:we}}function rye(){return{type:"end"}}function bh(Z){return{type:"other",description:Z}}function xB(Z){var pe,we=xC[Z];if(we)return we;for(pe=Z-1;!xC[pe];)pe--;for(we={line:(we=xC[pe]).line,column:we.column};pe<Z;)s.charCodeAt(pe)===10?(we.line++,we.column=1):we.column++,pe++;return xC[Z]=we,we}function SB(Z,pe){var we=xB(Z),Ct=xB(pe);return{source:l,start:{offset:Z,line:we.line,column:we.column},end:{offset:pe,line:Ct.line,column:Ct.column}}}function mt(Z){oe<Hc||(oe>Hc&&(Hc=oe,K4=[]),K4.push(Z))}function sye(Z,pe,we){return new e(e.buildMessage(Z,pe),Z,pe,we)}function TB(){var Z;return(Z=nye())===a&&(Z=oye()),Z}function nye(){var Z,pe;return Je++,Z=oe,ds(),s.substr(oe,4)===p?(pe=p,oe+=4):(pe=a,Je===0&&mt(N)),pe!==a?(ds(),Yi=Z,Z=Dge()):(oe=Z,Z=a),Je--,Z===a&&Je===0&&mt(L),Z}function oye(){var Z,pe;if(Z=[],(pe=eD())!==a)for(;pe!==a;)Z.push(pe),pe=eD();else Z=a;return Z}function eD(){var Z,pe,we,Ct;return Z=oe,ds(),(pe=lye())!==a?(ds(),(we=aye())===a&&(we=null),ds(),s.charCodeAt(oe)===41?(Ct=f,oe++):(Ct=a,Je===0&&mt(B)),Ct!==a?(ds(),Yi=Z,Z=Fge(pe,we)):(oe=Z,Z=a)):(oe=Z,Z=a),Z}function aye(){var Z,pe,we,Ct,Is,sr,Aa,TC;if(Z=oe,(pe=tD())!==a){for(we=[],Ct=oe,Is=ds(),s.charCodeAt(oe)===44?(sr=g,oe++):(sr=a,Je===0&&mt(W)),sr===a&&(sr=null),Aa=ds(),(TC=tD())!==a?Ct=Is=[Is,sr,Aa,TC]:(oe=Ct,Ct=a);Ct!==a;)we.push(Ct),Ct=oe,Is=ds(),s.charCodeAt(oe)===44?(sr=g,oe++):(sr=a,Je===0&&mt(W)),sr===a&&(sr=null),Aa=ds(),(TC=tD())!==a?Ct=Is=[Is,sr,Aa,TC]:(oe=Ct,Ct=a);Yi=Z,Z=Lge(pe,we)}else oe=Z,Z=a;return Z}function tD(){var Z,pe;return Z=oe,(pe=cye())===a&&(pe=uye())===a&&(pe=hye())===a&&(pe=dye()),pe!==a&&(Yi=Z,pe=kge(pe)),(Z=pe)===a&&(Z=oe,(pe=pye())!==a&&(Yi=Z,pe=zge(pe)),Z=pe),Z}function ds(){var Z,pe;for(Je++,Z=[],j.test(s.charAt(oe))?(pe=s.charAt(oe),oe++):(pe=a,Je===0&&mt(H));pe!==a;)Z.push(pe),j.test(s.charAt(oe))?(pe=s.charAt(oe),oe++):(pe=a,Je===0&&mt(H));return Je--,pe=a,Je===0&&mt(Y),Z}function lye(){var Z,pe,we;return Je++,Z=oe,(pe=CB())!==a?(s.charCodeAt(oe)===40?(we=y,oe++):(we=a,Je===0&&mt(fe)),we!==a?(Yi=Z,Z=Vge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a),Je--,Z===a&&(pe=a,Je===0&&mt(K)),Z}function CB(){var Z,pe,we;if(Je++,Z=oe,pe=[],V.test(s.charAt(oe))?(we=s.charAt(oe),oe++):(we=a,Je===0&&mt(me)),we!==a)for(;we!==a;)pe.push(we),V.test(s.charAt(oe))?(we=s.charAt(oe),oe++):(we=a,Je===0&&mt(me));else pe=a;return pe!==a&&(Yi=Z,pe=Nge()),Je--,(Z=pe)===a&&(pe=a,Je===0&&mt(ce)),Z}function cye(){var Z,pe,we;return Je++,Z=oe,ds(),(pe=Pa())!==a?(s.charCodeAt(oe)===37?(we=v,oe++):(we=a,Je===0&&mt(He)),we!==a?(Yi=Z,Z=Uge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a),Je--,Z===a&&Je===0&&mt(Ie),Z}function uye(){var Z,pe,we;return Je++,Z=oe,ds(),(pe=Pa())!==a?(s.substr(oe,2)===b?(we=b,oe+=2):(we=a,Je===0&&mt(Le)),we!==a?(Yi=Z,Z=jge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a),Z===a&&(Z=oe,ds(),(pe=Pa())!==a?(s.substr(oe,2)===w?(we=w,oe+=2):(we=a,Je===0&&mt(Ei)),we!==a?(Yi=Z,Z=Bge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a),Z===a&&(Z=oe,ds(),(pe=Pa())!==a?(s.substr(oe,2)===S?(we=S,oe+=2):(we=a,Je===0&&mt(rr)),we!==a?(Yi=Z,Z=Gge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a),Z===a&&(Z=oe,ds(),(pe=Pa())!==a?(s.substr(oe,2)===T?(we=T,oe+=2):(we=a,Je===0&&mt(Or)),we!==a?(Yi=Z,Z=qge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a),Z===a&&(Z=oe,ds(),(pe=Pa())!==a?(s.substr(oe,2)===C?(we=C,oe+=2):(we=a,Je===0&&mt(us)),we!==a?(Yi=Z,Z=Hge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a),Z===a&&(Z=oe,ds(),(pe=Pa())!==a?(s.substr(oe,2)===M?(we=M,oe+=2):(we=a,Je===0&&mt(yr)),we!==a?(Yi=Z,Z=Wge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a)))))),Je--,Z===a&&Je===0&&mt($e),Z}function hye(){var Z,pe,we;return Je++,Z=oe,(pe=Pa())!==a?(s.substr(oe,3)===P?(we=P,oe+=3):(we=a,Je===0&&mt(lt)),we!==a?(Yi=Z,Z=Zge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a),Z===a&&(Z=oe,(pe=Pa())!==a?(s.substr(oe,3)===F?(we=F,oe+=3):(we=a,Je===0&&mt(wC)),we!==a?(Yi=Z,Z=Jge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a),Z===a&&(Z=oe,(pe=Pa())!==a?(s.substr(oe,4)===z?(we=z,oe+=4):(we=a,Je===0&&mt(qc)),we!==a?(Yi=Z,Z=Qge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a),Z===a&&(Z=oe,(pe=Pa())!==a?(s.substr(oe,4)===D?(we=D,oe+=4):(we=a,Je===0&&mt(Nw)),we!==a?(Yi=Z,Z=Yge(pe)):(oe=Z,Z=a)):(oe=Z,Z=a)))),Je--,Z===a&&(pe=a,Je===0&&mt(Rr)),Z}function dye(){var Z,pe;return Je++,Z=oe,ds(),(pe=Pa())!==a?(Yi=Z,Z=Xge(pe)):(oe=Z,Z=a),Je--,Z===a&&Je===0&&mt(Uw),Z}function pye(){var Z,pe,we,Ct;if(Je++,Z=oe,s.charCodeAt(oe)===35?(pe=U,oe++):(pe=a,Je===0&&mt(Oge)),pe!==a){if(we=[],q.test(s.charAt(oe))?(Ct=s.charAt(oe),oe++):(Ct=a,Je===0&&mt(bB)),Ct!==a)for(;Ct!==a;)we.push(Ct),q.test(s.charAt(oe))?(Ct=s.charAt(oe),oe++):(Ct=a,Je===0&&mt(bB));else we=a;we!==a?(Yi=Z,Z=Kge()):(oe=Z,Z=a)}else oe=Z,Z=a;return Z===a&&(Z=oe,(pe=eD())!==a&&(Yi=Z,pe=eye(pe)),(Z=pe)===a&&(Z=oe,(pe=CB())!==a&&(Yi=Z,pe=tye()),Z=pe)),Je--,Z===a&&(pe=a,Je===0&&mt(Ege)),Z}function Pa(){var Z,pe,we,Ct,Is,sr,Aa;for(Z=oe,J.test(s.charAt(oe))?(s.charAt(oe),oe++):Je===0&&mt(wB),pe=oe,we=[],O.test(s.charAt(oe))?(Ct=s.charAt(oe),oe++):(Ct=a,Je===0&&mt(gp));Ct!==a;)we.push(Ct),O.test(s.charAt(oe))?(Ct=s.charAt(oe),oe++):(Ct=a,Je===0&&mt(gp));if(s.charCodeAt(oe)===46?(Ct=G,oe++):(Ct=a,Je===0&&mt(Rge)),Ct!==a){if(Is=[],O.test(s.charAt(oe))?(sr=s.charAt(oe),oe++):(sr=a,Je===0&&mt(gp)),sr!==a)for(;sr!==a;)Is.push(sr),O.test(s.charAt(oe))?(sr=s.charAt(oe),oe++):(sr=a,Je===0&&mt(gp));else Is=a;Is!==a?pe=we=[we,Ct,Is]:(oe=pe,pe=a)}else oe=pe,pe=a;if(pe===a)if(pe=[],O.test(s.charAt(oe))?(we=s.charAt(oe),oe++):(we=a,Je===0&&mt(gp)),we!==a)for(;we!==a;)pe.push(we),O.test(s.charAt(oe))?(we=s.charAt(oe),oe++):(we=a,Je===0&&mt(gp));else pe=a;if(pe!==a){if(we=oe,s.charCodeAt(oe)===101?(Ct=k,oe++):(Ct=a,Je===0&&mt(Ige)),Ct!==a){if(J.test(s.charAt(oe))?(Is=s.charAt(oe),oe++):(Is=a,Je===0&&mt(wB)),Is===a&&(Is=null),sr=[],O.test(s.charAt(oe))?(Aa=s.charAt(oe),oe++):(Aa=a,Je===0&&mt(gp)),Aa!==a)for(;Aa!==a;)sr.push(Aa),O.test(s.charAt(oe))?(Aa=s.charAt(oe),oe++):(Aa=a,Je===0&&mt(gp));else sr=a;sr!==a?we=Ct=[Ct,Is,sr]:(oe=we,we=a)}else oe=we,we=a;we===a&&(we=null),Yi=Z,Z=iye()}else oe=Z,Z=a;return Z}function fye(Z,pe){return Z.map(function(we){return we[pe]})}function mye(Z,pe,we){return[Z].concat(fye(pe,we))}if((o=h())!==a&&oe===s.length)return o;throw o!==a&&oe<s.length&&mt(rye()),sye(K4,Hc<s.length?s.charAt(Hc):null,Hc<s.length?SB(Hc,Hc+1):SB(Hc,Hc))}return t(e,Error),e.prototype.format=function(s){var n="Error: "+this.message;if(this.location){var o,a=null;for(o=0;o<s.length;o++)if(s[o].source===this.location.source){a=s[o].text.split(/\r\n|\n|\r/g);break}var l=this.location.start,c=this.location.source+":"+l.line+":"+l.column;if(a){var h=this.location.end,p=i("",l.line.toString().length),f=a[l.line-1],g=l.line===h.line?h.column:f.length+1;n+=`
 --> `+c+`
`+p+` |
`+l.line+" | "+f+`
`+p+" | "+i("",l.column-1)+i("",g-l.column,"^")}else n+=`
 at `+c}return n},e.buildMessage=function(s,n){var o={literal:function(g){return'"'+l(g.text)+'"'},class:function(g){var y=g.parts.map(function(v){return Array.isArray(v)?c(v[0])+"-"+c(v[1]):c(v)});return"["+(g.inverted?"^":"")+y+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(g){return g.description}};function a(g){return g.charCodeAt(0).toString(16).toUpperCase()}function l(g){return g.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function c(g){return g.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function h(g){return o[g.type](g)}function p(g){var y,v,b=g.map(h);if(b.sort(),b.length>0){for(y=1,v=1;y<b.length;y++)b[y-1]!==b[y]&&(b[v]=b[y],v++);b.length=v}switch(b.length){case 1:return b[0];case 2:return b[0]+" or "+b[1];default:return b.slice(0,-1).join(", ")+", or "+b[b.length-1]}}function f(g){return g?'"'+l(g)+'"':"end of input"}return"Expected "+p(s)+" but "+f(n)+" found."},{SyntaxError:e,parse:r}},(lie=uie).exports&&(lie.exports=cie());const H8={deg:1,grad:.9,rad:180/Math.PI,turn:360};function QIe(t){if(t.type!=="quantity"||!(t.value===0&&t.unit===null||t.unit&&H8[t.unit]!=null))throw new Q("effect:type-error",`Expected <angle>, Actual: ${j$(t)}`,{term:t})}const W8={px:1,cm:96/2.54,mm:96/2.54/10,in:96,pc:16,pt:96/72};function YIe(t){if(t.type!=="quantity"||!(t.value===0&&t.unit===null||t.unit&&W8[t.unit]!=null))throw new Q("effect:type-error",`Expected <length>, Actual: ${j$(t)}`,{term:t})}function bc(t){JIe(t);const e=t.value;return pS(e,t),t.unit==="%"?.01*e:e}function XIe(t){return ZIe(t),pS(t.value,t),t.value}function KIe(t){return QIe(t),t.value*H8[t.unit]||0}function Z8(t){return YIe(t),t.value*W8[t.unit]||0}function e4e(t){switch(t.colorType){case"hex":return y_e(t.value);case"named":return pie(t.value);case"function":return r4e(t.value)}}function pie(t){if(!nH(t))throw new Q("effect:unknown-color",`color '${t}' isn't valid`,{namedColor:t});return g_e(t)}const t4e=/^rgba?/i,i4e=/^hsla?/i;function r4e(t){if(E_(t.parameters,4),t4e.test(t.name))return[bc(t.parameters[0]),bc(t.parameters[1]),bc(t.parameters[2]),t.parameters[3]?bc(t.parameters[3]):1];if(i4e.test(t.name))return oH(XIe(t.parameters[0]),bc(t.parameters[1]),bc(t.parameters[2]),t.parameters[3]?bc(t.parameters[3]):1);throw new Q("effect:syntax-error",`Invalid color function '${t.name}'`,{colorFunction:t})}function J8(t,e,i){try{return n4e(t)}catch(s){var r;i==null||(r=i.messages)==null||r.push(s)}return null}function Q8(t,e,i,r){try{const s=s4e(t);Bo(i,s,e)}catch(s){r.messages&&r.messages.push(s)}}function s4e(t){const e=hie(t);return e?NIe(e)?e.map(i=>i.toJSON()):e.map(({scale:i,effects:r})=>({scale:i,value:r.map(s=>s.toJSON())})):null}function n4e(t){if(!t||t.length===0)return null;if(o4e(t)){const e=[];for(const i of t)e.push({scale:i.scale,value:fie(i.value)});return e}return fie(t)}function o4e(t){const e=t[0];return!!e&&"scale"in e}function fie(t){if(!t||!t.length)return"";const e=[];for(const i of t){let r=[];switch(i.type){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":case"opacity":r=[ad(i,"amount")];break;case"blur":r=[ad(i,"radius","pt")];break;case"hue-rotate":r=[ad(i,"angle","deg")];break;case"drop-shadow":r=[ad(i,"xoffset","pt"),ad(i,"yoffset","pt"),ad(i,"blurRadius","pt"),a4e(i,"color")];break;case"bloom":r=[ad(i,"strength"),ad(i,"radius","pt"),ad(i,"threshold")]}const s=`${i.type}(${r.filter(Boolean).join(" ")})`;hie(s),e.push(s)}return e.join(" ")}function ad(t,e,i){if(t[e]==null)throw new Q("effect:missing-parameter",`Missing parameter '${e}' in ${t.type} effect`,{effect:t});return i?t[e]+i:""+t[e]}function a4e(t,e){if(t[e]==null)throw new Q("effect:missing-parameter",`Missing parameter '${e}' in ${t.type} effect`,{effect:t});const i=t[e];return`rgba(${i[0]||0}, ${i[1]||0}, ${i[2]||0}, ${i[3]/255||0})`}const Y8=t=>{let e=class extends t{constructor(){super(...arguments),this.blendMode="normal",this.effect=null}};return u([d({type:["average","color-burn","color-dodge","color","darken","destination-atop","destination-in","destination-out","destination-over","difference","exclusion","hard-light","hue","invert","lighten","lighter","luminosity","minus","multiply","normal","overlay","plus","reflect","saturation","screen","soft-light","source-atop","source-in","source-out","vivid-light","xor"],nonNullable:!0,json:{read:!1,write:!1,origins:{"web-map":{read:!0,write:!0}}}})],e.prototype,"blendMode",void 0),u([d({json:{read:!1,write:!1,origins:{"web-map":{read:{reader:J8},write:{allowNull:!0,writer:Q8}}}}})],e.prototype,"effect",void 0),e=u([R("esri.layers.mixins.BlendLayer")],e),e},l4e=t=>{let e=class extends t{constructor(){super(...arguments),this.customParameters=null}};return u([d({type:Object,json:{write:{overridePolicy:i=>({enabled:!!(i&&Object.keys(i).length>0)})}}})],e.prototype,"customParameters",void 0),e=u([R("esri.layers.mixins.CustomParametersMixin")],e),e};var X8;const K8=new wt({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),e9=new wt({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let Ru=X8=class extends ge{constructor(t){super(t),this.where=null,this.geometry=null,this.spatialRelationship="intersects",this.distance=void 0,this.objectIds=null,this.units=null,this.timeExtent=null}createQuery(t={}){const{where:e,geometry:i,spatialRelationship:r,timeExtent:s,objectIds:n,units:o,distance:a}=this;return new jn(E({geometry:ie(i),objectIds:ie(n),spatialRelationship:r,timeExtent:ie(s),where:e,units:o,distance:a},t))}clone(){const{where:t,geometry:e,spatialRelationship:i,timeExtent:r,objectIds:s,units:n,distance:o}=this;return new X8({geometry:ie(e),objectIds:ie(s),spatialRelationship:i,timeExtent:ie(r),where:t,units:n,distance:o})}};u([d({type:String,json:{write:!0}})],Ru.prototype,"where",void 0),u([d({types:Og,json:{write:!0}})],Ru.prototype,"geometry",void 0),u([d({type:K8.apiValues,json:{name:"spatialRel",read:{reader:K8.read},write:{allowNull:!1,writer:K8.write,overridePolicy(){return{enabled:_(this.geometry)}}}}})],Ru.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{write:{overridePolicy(t){return{enabled:t!=null&&this.geometry!=null}}}}})],Ru.prototype,"distance",void 0),u([d({type:[Number],json:{write:!0}})],Ru.prototype,"objectIds",void 0),u([d({type:e9.apiValues,json:{read:e9.read,write:{writer:e9.write,overridePolicy(t){return{enabled:t!=null&&this.geometry!=null}}}}})],Ru.prototype,"units",void 0),u([d({type:Su,json:{write:!0}})],Ru.prototype,"timeExtent",void 0),Ru=X8=u([R("esri.layers.support.FeatureFilter")],Ru);const c4e=Ru;var t9;let Yy=t9=class extends ge{constructor(t){super(t),this.filter=null,this.includedEffect=null,this.excludedEffect=null,this.excludedLabelsVisible=!1}write(t,e){const i=super.write(t,e);if(e!=null&&e.origin){if(i.filter){const n=Object.keys(i.filter);var r;if(n.length>1||n[0]!=="where")return(r=e.messages)==null||r.push(new Q("web-document-write:unsupported-feature-effect","Invalid feature effect 'filter'. A filter can only contain a 'where' property",{layer:e.layer,effect:this})),null}var s;if("showExcludedLabels"in i)return(s=e.messages)==null||s.push(new Q("web-document-write:unsupported-feature-effect","Invalid value for property 'excludedLabelsVisible' which should always be 'true'",{layer:e.layer,effect:this})),null}return i}clone(){return new t9({filter:_(this.filter)&&this.filter.clone(),includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}};u([d({type:c4e,json:{write:{allowNull:!0,writer(t,e,i,r){const s=t==null?void 0:t.write({},r);s&&Object.keys(s).length!==0?Bo(i,s,e):Bo(i,null,e)}}}})],Yy.prototype,"filter",void 0),u([d({json:{write:!0,origins:{"web-map":{read:{reader:J8},write:{writer:Q8,overridePolicy(){return{allowNull:this.excludedEffect!=null,isRequired:this.excludedEffect==null}}}}}}})],Yy.prototype,"includedEffect",void 0),u([d({json:{write:!0,origins:{"web-map":{read:{reader:J8},write:{writer:Q8,overridePolicy(){return{allowNull:this.includedEffect!=null,isRequired:this.includedEffect==null}}}}}}})],Yy.prototype,"excludedEffect",void 0),u([d({type:Boolean,json:{write:!0,name:"showExcludedLabels",origins:{"web-map":{name:"showExcludedLabels",default:!0}}}})],Yy.prototype,"excludedLabelsVisible",void 0),Yy=t9=u([R("esri.layers.support.FeatureEffect")],Yy);const u4e=Yy,h4e=t=>{let e=class extends t{constructor(){super(...arguments),this.featureEffect=null}};return u([d({type:u4e,json:{origins:{"web-map":{write:{allowNull:!0}}}}})],e.prototype,"featureEffect",void 0),e=u([R("esri.layers.mixins.FeatureEffectLayer")],e),e},d4e={"web-scene/operational-layers":{ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0,ArcGISTiledElevationServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BuildingSceneLayer:!0,GroupLayer:!0,IntegratedMeshLayer:!0,OGCFeatureLayer:!0,PointCloudLayer:!0,WebTiledLayer:!0,CSV:!0,GeoJSON:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,KML:!0,RasterDataLayer:!0,Voxel:!1},"web-scene/basemap":{ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,WebTiledLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,ArcGISImageServiceLayer:!0,WMS:!0,ArcGISMapServiceLayer:!0},"web-scene/ground":{ArcGISTiledElevationServiceLayer:!0,RasterDataElevationLayer:!0},"web-map/operational-layers":{ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISStreamLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BingMapsAerial:!0,BingMapsHybrid:!0,BingMapsRoad:!0,CSV:!0,GeoRSS:!0,GeoJSON:!0,GroupLayer:!0,KML:!0,OGCFeatureLayer:!0,SubtypeGroupLayer:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,WebTiledLayer:!0},"web-map/basemap":{ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,WMS:!0,WebTiledLayer:!0,BingMapsAerial:!0,BingMapsRoad:!0,BingMapsHybrid:!0},"web-map/tables":{ArcGISFeatureLayer:!0},"portal-item/operational-layers":{ArcGISSceneServiceLayer:!0,PointCloudLayer:!0,BuildingSceneLayer:!0,IntegratedMeshLayer:!0}};function p4e(t){if(!t)return t;const{start:e,end:i}=t;return new Su({start:_(e)?Ty(e,-e.getTimezoneOffset(),"minutes"):e,end:_(i)?Ty(i,-i.getTimezoneOffset(),"minutes"):i})}function f4e(t){if(!t)return t;const{start:e,end:i}=t;return new Su({start:_(e)?Ty(e,e.getTimezoneOffset(),"minutes"):e,end:_(i)?Ty(i,i.getTimezoneOffset(),"minutes"):i})}var i9;let fS=i9=class extends ge{async collectRequiredFields(t,e){return Qo(t,e,this.expression)}clone(){return new i9({expression:this.expression,title:this.title})}};u([d({type:String,json:{write:!0}})],fS.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],fS.prototype,"title",void 0),fS=i9=u([R("esri.layers.support.FeatureExpressionInfo")],fS);const mie=fS;function m4e(t){return x_[t]!=null}function g4e(t){return 1/(x_[t]||1)}function y4e(){const t=Object.keys(x_);return t.sort(),t}const v4e=y4e();var r9;const B$=Ds()({onTheGround:"on-the-ground",relativeToGround:"relative-to-ground",relativeToScene:"relative-to-scene",absoluteHeight:"absolute-height"}),gie=new wt({foot:"feet",kilometer:"kilometers",meter:"meters",mile:"miles","us-foot":"us-feet",yard:"yards"});let ld=r9=class extends ge{constructor(){super(...arguments),this.offset=null}readFeatureExpressionInfo(t,e){return t!=null?t:e.featureExpression&&e.featureExpression.value===0?{expression:"0"}:void 0}writeFeatureExpressionInfo(t,e,i,r){e[i]=t.write({},r),t.expression==="0"&&(e.featureExpression={value:0})}get mode(){const{offset:t,featureExpressionInfo:e}=this;return this._isOverridden("mode")?this._get("mode"):_(t)||e?"relative-to-ground":"on-the-ground"}set mode(t){this._override("mode",t)}set unit(t){this._set("unit",t)}write(t,e){return this.offset||this.mode||this.featureExpressionInfo||this.unit?super.write(t,e):null}clone(){return new r9({mode:this.mode,offset:this.offset,featureExpressionInfo:this.featureExpressionInfo?this.featureExpressionInfo.clone():void 0,unit:this.unit})}};u([d({type:mie,json:{write:!0}})],ld.prototype,"featureExpressionInfo",void 0),u([Ce("featureExpressionInfo",["featureExpressionInfo","featureExpression"])],ld.prototype,"readFeatureExpressionInfo",null),u([Ee("featureExpressionInfo",{featureExpressionInfo:{type:mie},"featureExpression.value":{type:[0]}})],ld.prototype,"writeFeatureExpressionInfo",null),u([d({type:B$.apiValues,nonNullable:!0,json:{type:B$.jsonValues,read:B$.read,write:{writer:B$.write,isRequired:!0}}})],ld.prototype,"mode",null),u([d({type:Number,json:{write:!0}})],ld.prototype,"offset",void 0),u([d({type:v4e,json:{type:String,read:gie.read,write:gie.write}})],ld.prototype,"unit",null),ld=r9=u([R("esri.layers.support.ElevationInfo")],ld);const yie=ld,_4e={type:Boolean,value:!0,json:{origins:{service:{read:!1,write:!1},"web-map":{read:!1,write:!1}},name:"screenSizePerspective",write:!0}},vie={type:Boolean,value:!0,json:{name:"disablePopup",read:{reader:(t,e)=>!e.disablePopup},write:{enabled:!0,writer(t,e,i){e[i]=!t}}}},_ie={type:Boolean,value:!0,json:{name:"showLabels",write:!0}},bie={type:String,json:{origins:{"portal-item":{write:!1}},write:{isRequired:!0,ignoreOrigin:!0,writer:qp}}},b4e={type:Boolean,value:!0,json:{origins:{service:{read:{enabled:!1}}},name:"showLegend",write:!0}},w4e={value:null,type:yie,json:{origins:{service:{name:"elevationInfo",write:!0}},name:"layerDefinition.elevationInfo",write:!0}};function Zot(t){return{type:t,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}}}const G$={type:Number,json:{origins:{"web-document":{write:!0,read:!0},"portal-item":{write:!0}}}},x4e=he(E({},G$),{json:he(E({},G$.json),{origins:{"web-document":he(E({},G$.json.origins["web-document"]),{write:{enabled:!0,target:{opacity:{type:Number},"layerDefinition.drawingInfo.transparency":{type:Number}}}})},read:{source:["layerDefinition.drawingInfo.transparency","drawingInfo.transparency"],reader:(t,e,i)=>i&&i.origin!=="service"||!e.drawingInfo||e.drawingInfo.transparency===void 0?e.layerDefinition&&e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.transparency!==void 0?yx(e.layerDefinition.drawingInfo.transparency):void 0:yx(e.drawingInfo.transparency)}})}),Jot={type:Su,readOnly:!0,get(){var t,e;if((t=this.layer)==null||!t.timeInfo)return null;const{datesInUnknownTimezone:i,timeOffset:r,useViewTime:s}=this.layer,n=(e=this.view)==null?void 0:e.timeExtent;let o=this.layer.timeExtent;i&&(o=f4e(o));let a=s?n&&o?n.intersection(o):n||o:o;if(!a||a.isEmpty||a.isAllTime)return a;r&&(a=a.offset(-r.value,r.unit)),i&&(a=p4e(a));const l=this._get("timeExtent");return a.equals(l)?l:a}},Qot={type:ht,readOnly:!0,json:{origins:{service:{read:{source:["fullExtent","spatialReference"],reader:(t,e)=>{const i=ht.fromJSON(t);return e.spatialReference!=null&&typeof e.spatialReference=="object"&&(i.spatialReference=Ue.fromJSON(e.spatialReference)),i}}}},read:!1}},S4e={type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}}}},T4e={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}},C4e={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}},s9=t=>{let e=class extends t{constructor(){super(...arguments),this.title=null}writeListMode(i,r,s,n){(n&&n.layerContainerType==="ground"||i&&wve(this,s,{},n))&&(r[s]=i)}writeOperationalLayerType(i,r,s,n){!i||n&&n.layerContainerType==="tables"||(r.layerType=i)}writeTitle(i,r){r.title=i||"Layer"}read(i,r){r&&(r.layer=this),yve(this,i,s=>super.read(i,s),r)}write(i,r){if(r!=null&&r.origin){const l=`${r.origin}/${r.layerContainerType||"operational-layers"}`,c=d4e[l];let h=c&&c[this.operationalLayerType];var s;if(this.operationalLayerType==="ArcGISTiledElevationServiceLayer"&&l==="web-scene/operational-layers"&&(h=!1),!h)return(s=r.messages)==null||s.push(new Q("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${l}'`,{layer:this})),null}const n=super.write(i,he(E({},r),{layer:this})),o=!!r&&!!r.messages&&!!r.messages.filter(l=>l instanceof Q&&l.name==="web-document-write:property-required").length;var a;return Zv(n==null?void 0:n.url)?(r==null||(a=r.messages)==null||a.push(new Q("layer:invalid-url",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a Blob URL cannot be written to web scenes and web maps`,{layer:this})),null):!this.url&&o?null:n}beforeSave(){}};return u([d({type:String,json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0}},"portal-item":{write:!1}}}})],e.prototype,"id",void 0),u([d({json:{write:{ignoreOrigin:!0},origins:{"web-map":{read:!1,write:!1}}}})],e.prototype,"listMode",void 0),u([Ee("listMode")],e.prototype,"writeListMode",null),u([d({type:String,readOnly:!0,json:{read:!1,write:{target:"layerType",ignoreOrigin:!0},origins:{"portal-item":{write:!1}}}})],e.prototype,"operationalLayerType",void 0),u([Ee("operationalLayerType")],e.prototype,"writeOperationalLayerType",null),u([d(G$)],e.prototype,"opacity",void 0),u([d({type:String,json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}},"portal-item":{write:!1}}},value:"Layer"})],e.prototype,"title",void 0),u([Ee("title")],e.prototype,"writeTitle",null),u([d({type:Boolean,json:{name:"visibility",origins:{"web-document":{name:"visibility",default:!0},"portal-item":{name:"visibility",read:{source:["visible","visibility"]}}}}})],e.prototype,"visible",void 0),e=u([R("esri.layers.mixins.OperationalLayer")],e),e};var n9;const o9=new wt({asc:"ascending",desc:"descending"});let O_=n9=class extends ge{constructor(t){super(t),this.field=null,this.valueExpression=null,this.order="ascending"}clone(){return new n9({field:this.field,valueExpression:this.valueExpression,order:this.order})}};u([d({type:String,json:{write:!0}})],O_.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],O_.prototype,"valueExpression",void 0),u([d({type:o9.apiValues,json:{read:o9.read,write:o9.write}})],O_.prototype,"order",void 0),O_=n9=u([R("esri.layers.support.OrderByInfo")],O_);const wie=O_;function M4e(t,e,i){if(!t)return null;const r=t.find(n=>!!n.field);if(!r)return null;const s=new wie;return s.read(r,i),[s]}function P4e(t,e,i,r){const s=t.find(n=>!!n.field);s&&Bo(i,[s.toJSON()],e)}const A4e=t=>{let e=class extends t{constructor(){super(...arguments),this.orderBy=null}};return u([d({type:[wie],json:{origins:{"web-scene":{write:!1,read:!1}},read:{source:"layerDefinition.orderBy",reader:M4e},write:{target:"layerDefinition.orderBy",writer:P4e}}})],e.prototype,"orderBy",void 0),e=u([R("esri.layers.mixins.OrderedLayer")],e),e},$4e=le.getLogger("esri.layers.mixins.PortalLayer"),a9=t=>{let e=class extends t{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0}destroy(){var i;(i=this.portalItem)==null||i.destroy(),this.portalItem=null}set portalItem(i){i!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",i))}readPortalItem(i,r,s){if(r.itemId)return new SM({id:r.itemId,portal:s&&s.portal})}writePortalItem(i,r){i&&i.id&&(r.itemId=i.id)}async loadFromPortal(i,r){if(this.portalItem&&this.portalItem.id)try{const s=await import("./layersLoader.aa166bc3.js").then(function(n){return n.l});return Dt(r),await s.load({instance:this,supportedTypes:i.supportedTypes,validateItem:i.validateItem,supportsData:i.supportsData},r)}catch(s){throw bi(s)||$4e.warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})
  ${s}`),s}}async finishLoadEditablePortalLayer(i){this._set("userHasEditingPrivileges",await this.fetchUserHasEditingPrivileges(i).catch(r=>(Wc(r),!0)))}async fetchUserHasEditingPrivileges(i){const r=this.url?_r==null?void 0:_r.findCredential(this.url):null;if(!r)return!0;const s=q$.credential===r?q$.user:await this.fetchEditingUser(i);return q$.credential=r,q$.user=s,A(s)||s.privileges==null||s.privileges.includes("features:user:edit")}async fetchEditingUser(i){var r,s;const n=(r=this.portalItem)==null||(s=r.portal)==null?void 0:s.user;if(n)return n;const o=_r.findServerInfo(this.url);if(o==null||!o.owningSystemUrl)return null;const a=`${o.owningSystemUrl}/sharing/rest`,l=po.getDefault();if(l&&l.loaded&&Ia(l.restUrl)===Ia(a))return l.user;const c=`${a}/community/self`,h=_(i)?i.signal:null,p=await zl(vt(c,{authMode:"no-prompt",query:{f:"json"},signal:h}));return p.ok?dF.fromJSON(p.value.data):null}read(i,r){r&&(r.layer=this),super.read(i,r)}write(i,r){const s=r&&r.portal,n=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||po.getDefault());return s&&n&&!fq(n.restUrl,s.restUrl)?(r.messages&&r.messages.push(new Q("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save the scene, set the layer.portalItem to null or save the scene to the same portal as the item associated with the layer`,{layer:this})),null):super.write(i,he(E({},r),{layer:this}))}};return u([d({type:SM})],e.prototype,"portalItem",null),u([Ce("web-document","portalItem",["itemId"])],e.prototype,"readPortalItem",null),u([Ee("web-document","portalItem",{itemId:{type:String}})],e.prototype,"writePortalItem",null),u([d()],e.prototype,"resourceReferences",void 0),u([d({readOnly:!0})],e.prototype,"userHasEditingPrivileges",void 0),e=u([R("esri.layers.mixins.PortalLayer")],e),e},q$={credential:null,user:null},mS=new We,gS=new WeakMap;function E4e(t){xie(t)&&mS.push(t)}function O4e(t){xie(t)&&mS.includes(t)&&mS.remove(t)}function xie(t){return t&&typeof t=="object"&&"refreshInterval"in t&&"refresh"in t}function Sie(t,e){return Number.isFinite(t)&&Number.isFinite(e)?e<=0?t:Sie(e,t%e):0}let l9=0,H$=0;function R4e(){const t=Date.now();for(const i of mS)if(i.refreshInterval){var e;t-((e=gS.get(i))!=null?e:0)+5>=6e4*i.refreshInterval&&(gS.set(i,t),i.refresh(t))}}CG(()=>{const t=Date.now();let e=0;for(const i of mS)e=Sie(Math.round(6e4*i.refreshInterval),e),i.refreshInterval?gS.get(i)||gS.set(i,t):gS.delete(i);if(e!==H$){if(H$=e,clearInterval(l9),H$===0)return void(l9=0);l9=setInterval(R4e,H$)}});function I4e(t){return t&&typeof t=="object"&&"refreshTimestamp"in t&&"refresh"in t}const Tie=t=>{let e=class extends t{constructor(...i){super(...i),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=yG(()=>this.hasDataChanged()),this.when().then(()=>{E4e(this)},()=>{})}destroy(){O4e(this)}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(i=Date.now()){vD(this._debounceHasDataChanged()).then(r=>{r&&this._set("refreshTimestamp",i),this.emit("refresh",{dataChanged:r})},r=>{le.getLogger(this.declaredClass).error(r),this.emit("refresh",{dataChanged:!1,error:r})})}async hasDataChanged(){return!0}};return u([d({type:Number,cast:i=>i>=.1?i:i<=0?0:.1,json:{write:!0}})],e.prototype,"refreshInterval",void 0),u([d({readOnly:!0})],e.prototype,"refreshTimestamp",void 0),u([d()],e.prototype,"refreshParameters",null),e=u([R("esri.layers.mixins.RefreshableLayer")],e),e},c9=t=>{let e=class extends t{constructor(){super(...arguments),this.minScale=0,this.maxScale=0}get scaleRangeId(){return`${this.minScale},${this.maxScale}`}};return u([d({type:Number,nonNullable:!0,json:{write:!0}})],e.prototype,"minScale",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0}})],e.prototype,"maxScale",void 0),u([d({readOnly:!0})],e.prototype,"scaleRangeId",null),e=u([R("esri.layers.mixins.ScaleRangeLayer")],e),e},Xy=Ds()({esriTimeUnitsMilliseconds:"milliseconds",esriTimeUnitsSeconds:"seconds",esriTimeUnitsMinutes:"minutes",esriTimeUnitsHours:"hours",esriTimeUnitsDays:"days",esriTimeUnitsWeeks:"weeks",esriTimeUnitsMonths:"months",esriTimeUnitsYears:"years",esriTimeUnitsDecades:"decades",esriTimeUnitsCenturies:"centuries",esriTimeUnitsUnknown:void 0});var u9;let yS=u9=class extends ge{constructor(t){super(t),this.value=0,this.unit="milliseconds"}toMilliseconds(){return gPe(this.value,this.unit,"milliseconds")}clone(){return new u9({value:this.value,unit:this.unit})}};u([d({type:Number,json:{write:!0},nonNullable:!0})],yS.prototype,"value",void 0),u([d({type:Xy.apiValues,json:{type:Xy.jsonValues,read:Xy.read,write:Xy.write},nonNullable:!0})],yS.prototype,"unit",void 0),yS=u9=u([R("esri.TimeInterval")],yS);const vS=yS;var h9;let R_=h9=class extends ge{constructor(t){super(t),this.respectsDaylightSaving=!1,this.timezone=null}readRespectsDaylightSaving(t,e){return e.respectsDaylightSaving!==void 0?e.respectsDaylightSaving:e.respectDaylightSaving!==void 0&&e.respectDaylightSaving}clone(){const{respectsDaylightSaving:t,timezone:e}=this;return new h9({respectsDaylightSaving:t,timezone:e})}};u([d({type:Boolean,json:{write:!0}})],R_.prototype,"respectsDaylightSaving",void 0),u([Ce("respectsDaylightSaving",["respectsDaylightSaving","respectDaylightSaving"])],R_.prototype,"readRespectsDaylightSaving",null),u([d({type:String,json:{read:{source:"timeZone"},write:{target:"timeZone"}}})],R_.prototype,"timezone",void 0),R_=h9=u([R("esri.layers.support.TimeReference")],R_);const D4e=R_;var d9;let yn=d9=class extends ge{constructor(t){super(t),this.cumulative=!1,this.endField=null,this.fullTimeExtent=null,this.hasLiveData=!1,this.interval=null,this.startField=null,this.timeReference=null,this.trackIdField=null,this.useTime=!0}readFullTimeExtent(t,e){if(!e.timeExtent||!Array.isArray(e.timeExtent)||e.timeExtent.length!==2)return null;const i=new Date(e.timeExtent[0]),r=new Date(e.timeExtent[1]);return new Su({start:i,end:r})}writeFullTimeExtent(t,e){t&&_(t.start)&&_(t.end)?e.timeExtent=[t.start.getTime(),t.end.getTime()]:e.timeExtent=null}readInterval(t,e){return e.timeInterval&&e.timeIntervalUnits?new vS({value:e.timeInterval,unit:Xy.fromJSON(e.timeIntervalUnits)}):e.defaultTimeInterval&&e.defaultTimeIntervalUnits?new vS({value:e.defaultTimeInterval,unit:Xy.fromJSON(e.defaultTimeIntervalUnits)}):null}writeInterval(t,e){if(t){const i=t.toJSON();e.timeInterval=i.value,e.timeIntervalUnits=i.unit}else e.timeInterval=null,e.timeIntervalUnits=null}clone(){const{cumulative:t,endField:e,hasLiveData:i,interval:r,startField:s,timeReference:n,fullTimeExtent:o,trackIdField:a,useTime:l}=this;return new d9({cumulative:t,endField:e,hasLiveData:i,interval:r,startField:s,timeReference:ie(n),fullTimeExtent:ie(o),trackIdField:a,useTime:l})}};u([d({type:Boolean,json:{read:{source:"exportOptions.timeDataCumulative"},write:{target:"exportOptions.timeDataCumulative"}}})],yn.prototype,"cumulative",void 0),u([d({type:String,json:{read:{source:"endTimeField"},write:{target:"endTimeField",allowNull:!0}}})],yn.prototype,"endField",void 0),u([d({type:Su,json:{write:{enabled:!0,allowNull:!0}}})],yn.prototype,"fullTimeExtent",void 0),u([Ce("fullTimeExtent",["timeExtent"])],yn.prototype,"readFullTimeExtent",null),u([Ee("fullTimeExtent")],yn.prototype,"writeFullTimeExtent",null),u([d({type:Boolean,json:{write:!0}})],yn.prototype,"hasLiveData",void 0),u([d({type:vS,json:{write:{enabled:!0,allowNull:!0}}})],yn.prototype,"interval",void 0),u([Ce("interval",["timeInterval","timeIntervalUnits","defaultTimeInterval","defaultTimeIntervalUnits"])],yn.prototype,"readInterval",null),u([Ee("interval")],yn.prototype,"writeInterval",null),u([d({type:String,json:{read:{source:"startTimeField"},write:{target:"startTimeField",allowNull:!0}}})],yn.prototype,"startField",void 0),u([d({type:D4e,json:{write:{enabled:!0,allowNull:!0}}})],yn.prototype,"timeReference",void 0),u([d({type:String,json:{write:{enabled:!0,allowNull:!0}}})],yn.prototype,"trackIdField",void 0),u([d({type:Boolean,json:{read:{source:"exportOptions.useTime"},write:{target:"exportOptions.useTime"}}})],yn.prototype,"useTime",void 0),yn=d9=u([R("esri.layers.support.TimeInfo")],yn);const Cie=yn,F4e=t=>{let e=class extends t{constructor(){super(...arguments),this.timeExtent=null,this.timeOffset=null,this.useViewTime=!0}readOffset(i,r){const s=r.timeInfo.exportOptions;if(!s)return null;const n=s.timeOffset,o=Xy.fromJSON(s.timeOffsetUnits);return n&&o?new vS({value:n,unit:o}):null}set timeInfo(i){dW(i,this.fieldsIndex),this._set("timeInfo",i)}};return u([d({type:Su,json:{write:!1}})],e.prototype,"timeExtent",void 0),u([d({type:vS})],e.prototype,"timeOffset",void 0),u([Ce("service","timeOffset",["timeInfo.exportOptions"])],e.prototype,"readOffset",null),u([d({value:null,type:Cie,json:{write:!0,origins:{"web-document":{read:!1,write:!1}}}})],e.prototype,"timeInfo",null),u([d({type:Boolean,json:{read:{source:"timeAnimation"},write:{target:"timeAnimation"},origins:{"web-scene":{read:!1,write:!1}}}})],e.prototype,"useViewTime",void 0),e=u([R("esri.layers.mixins.TemporalLayer")],e),e};var p9;let cd=p9=class extends ge{constructor(t){super(t)}clone(){const{name:t,fields:e,isAscending:i,isUnique:r,description:s}=this;return new p9({name:t,fields:e,isAscending:i,isUnique:r,description:s})}};u([d({constructOnly:!0})],cd.prototype,"name",void 0),u([d({constructOnly:!0})],cd.prototype,"fields",void 0),u([d({constructOnly:!0})],cd.prototype,"isAscending",void 0),u([d({constructOnly:!0})],cd.prototype,"isUnique",void 0),u([d({constructOnly:!0})],cd.prototype,"description",void 0),cd=p9=u([R("esri.layers.support.FeatureIndex")],cd);let W$=class extends ge{constructor(){super(...arguments),this.type=null}};u([d({type:["selection","cluster"],readOnly:!0,json:{read:!1,write:!0}})],W$.prototype,"type",void 0),W$=u([R("esri.layers.support.FeatureReduction")],W$);const Z$=W$;var f9;let I_=f9=class extends ge{constructor(){super(...arguments),this.statisticType=null,this.onStatisticField=null,this.onStatisticValueExpression=null}clone(){return new f9({statisticType:this.statisticType,onStatisticField:this.onStatisticField,onStatisticValueExpression:this.onStatisticValueExpression})}};u([d({type:String,json:{write:!0}})],I_.prototype,"statisticType",void 0),u([d({type:String,json:{write:!0}})],I_.prototype,"onStatisticField",void 0),u([d({type:String,json:{write:!0}})],I_.prototype,"onStatisticValueExpression",void 0),I_=f9=u([R("esri.layers.support.OutStatistic")],I_);const L4e=I_;var m9;let _S=m9=class extends ge{constructor(){super(...arguments),this.name=null}clone(){return new m9({name:this.name,outStatistic:this.outStatistic.clone()})}};u([d({type:String,json:{write:!0}})],_S.prototype,"name",void 0),u([d({type:L4e,json:{write:!0}})],_S.prototype,"outStatistic",void 0),_S=m9=u([R("esri.layers.support.AggregateField")],_S);const k4e=_S,g9="__begin__",y9="__end__",z4e=new RegExp(g9,"ig"),V4e=new RegExp(y9,"ig"),Mie=new RegExp("^"+g9,"i"),Pie=new RegExp(y9+"$","i"),J$='"',N4e=J$+" + ",U4e=" + "+J$;function j4e(t){return t.replace(new RegExp("\\[","g"),"{").replace(new RegExp("\\]","g"),"}")}function B4e(t){return t.replace(new RegExp("\\{","g"),"[").replace(new RegExp("\\}","g"),"]")}function Q$(t){const e={expression:"",type:"none"};return t.labelExpressionInfo?t.labelExpressionInfo.value?(e.expression=t.labelExpressionInfo.value,e.type="conventional"):t.labelExpressionInfo.expression&&(e.expression=t.labelExpressionInfo.expression,e.type="arcade"):t.labelExpression!=null&&(e.expression=j4e(t.labelExpression),e.type="conventional"),e}function G4e(t){const e=Q$(t);if(!e)return null;switch(e.type){case"conventional":return v9(e.expression);case"arcade":return e.expression}return null}function q4e(t){const e=Q$(t);if(!e)return null;switch(e.type){case"conventional":return W4e(e.expression);case"arcade":return _9(e.expression)}return null}function v9(t){let e;return t?(e=Dl(t,i=>g9+'$feature["'+i+'"]'+y9),e=Mie.test(e)?e.replace(Mie,""):J$+e,e=Pie.test(e)?e.replace(Pie,""):e+J$,e=e.replace(z4e,N4e).replace(V4e,U4e)):e='""',e}const H4e=/^\s*\{([^}]+)\}\s*$/i;function W4e(t){const e=t.match(H4e);return e&&e[1].trim()||null}const Z4e=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*$/i,J4e=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])(\1|\3)(\5)\s*\));?\s*$/i,Q4e=/^\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])([\w\s]+)(\1)\s*\));?\s*$/i;function _9(t){if(!t)return null;let e=Z4e.exec(t)||J4e.exec(t);return e?e[1]||e[3]:(e=Q4e.exec(t),e?e[2]:null)}var b9;let Of=b9=class extends ge{constructor(){super(...arguments),this.expression=null,this.title=null,this.value=null}readExpression(t,e){return e.value?v9(e.value):t}writeExpression(t,e,i){this.value!=null&&(t=v9(this.value)),t!=null&&(e[i]=t)}clone(){return new b9({expression:this.expression,title:this.title,value:this.value})}};u([d({type:String,json:{write:{writerEnsuresNonNull:!0}}})],Of.prototype,"expression",void 0),u([Ce("expression",["expression","value"])],Of.prototype,"readExpression",null),u([Ee("expression")],Of.prototype,"writeExpression",null),u([d({type:String,json:{write:!0,origins:{"web-scene":{write:!1}}}})],Of.prototype,"title",void 0),u([d({json:{read:!1,write:!1}})],Of.prototype,"value",void 0),Of=b9=u([R("esri.layers.support.LabelExpressionInfo")],Of);const Aie=Of,$ie=[252,146,31,255],Yot=[153,153,153,255],Y4e={type:"esriSMS",style:"esriSMSCircle",size:6,color:$ie,outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[153,153,153,255]}},X4e={type:"esriSLS",style:"esriSLSSolid",width:.75,color:$ie},K4e={type:"esriSFS",style:"esriSFSSolid",color:[252,146,31,196],outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[255,255,255,191]}},eDe={type:"esriTS",color:[255,255,255,255],font:{family:"arial-unicode-ms",size:10,weight:"bold"},horizontalAlignment:"center",kerning:!0,haloColor:[0,0,0,255],haloSize:1,rotated:!1,text:"",xoffset:0,yoffset:0,angle:0},tDe={type:"esriSMS",style:"esriSMSCircle",color:[0,0,0,255],outline:null,size:10.5},iDe={type:"esriSLS",style:"esriSLSSolid",color:[0,0,0,255],width:1.5},rDe={type:"esriSFS",style:"esriSFSSolid",color:[0,0,0,255],outline:null},Xot=C1.fromJSON(Y4e),Kot=Jl.fromJSON(X4e),eat=iy.fromJSON(K4e),sDe=M1.fromJSON(eDe);C1.fromJSON(tDe);Jl.fromJSON(iDe);iy.fromJSON(rDe);var w9;const Y$=new wt({esriServerPointLabelPlacementAboveCenter:"above-center",esriServerPointLabelPlacementAboveLeft:"above-left",esriServerPointLabelPlacementAboveRight:"above-right",esriServerPointLabelPlacementBelowCenter:"below-center",esriServerPointLabelPlacementBelowLeft:"below-left",esriServerPointLabelPlacementBelowRight:"below-right",esriServerPointLabelPlacementCenterCenter:"center-center",esriServerPointLabelPlacementCenterLeft:"center-left",esriServerPointLabelPlacementCenterRight:"center-right",esriServerLinePlacementAboveAfter:"above-after",esriServerLinePlacementAboveAlong:"above-along",esriServerLinePlacementAboveBefore:"above-before",esriServerLinePlacementAboveStart:"above-start",esriServerLinePlacementAboveEnd:"above-end",esriServerLinePlacementBelowAfter:"below-after",esriServerLinePlacementBelowAlong:"below-along",esriServerLinePlacementBelowBefore:"below-before",esriServerLinePlacementBelowStart:"below-start",esriServerLinePlacementBelowEnd:"below-end",esriServerLinePlacementCenterAfter:"center-after",esriServerLinePlacementCenterAlong:"center-along",esriServerLinePlacementCenterBefore:"center-before",esriServerLinePlacementCenterStart:"center-start",esriServerLinePlacementCenterEnd:"center-end",esriServerPolygonPlacementAlwaysHorizontal:"always-horizontal"},{ignoreUnknown:!0});function Eie(t){return!t||t.origin!=="service"&&!Oie(t.layer)}function Oie(t){return(t==null?void 0:t.type)==="map-image"}function Rie(t){var e,i;return!!Oie(t)&&!((e=t.capabilities)==null||(i=e.exportMap)==null||!i.supportsArcadeExpressionForLabeling)}function nDe(t){return Eie(t)||Rie(t.layer)}let xr=w9=class extends ge{constructor(t){super(t),this.type="label",this.name=null,this.allowOverrun=!1,this.deconflictionStrategy="static",this.labelExpression=null,this.labelExpressionInfo=null,this.labelPlacement=null,this.labelPosition="curved",this.maxScale=0,this.minScale=0,this.repeatLabel=!0,this.repeatLabelDistance=null,this.symbol=sDe,this.useCodedValues=void 0,this.where=null}static evaluateWhere(t,e){const i=function(r,s,n){switch(s){case"=":return r==n;case"<>":return r!=n;case">":return r>n;case">=":return r>=n;case"<":return r<n;case"<=":return r<=n}return!1};try{if(t==null)return!0;const r=t.split(" ");if(r.length===3)return i(e[r[0]],r[1],r[2]);if(r.length===7){const s=i(e[r[0]],r[1],r[2]),n=r[3],o=i(e[r[4]],r[5],r[6]);switch(n){case"AND":return s&&o;case"OR":return s||o}}return!1}catch{console.log("Error.: can't parse = "+t)}}readLabelExpression(t,e){const i=e.labelExpressionInfo;if(!i||!i.value&&!i.expression)return t}writeLabelExpression(t,e,i){if(this.labelExpressionInfo){if(this.labelExpressionInfo.value!=null)t=B4e(this.labelExpressionInfo.value);else if(this.labelExpressionInfo.expression!=null){const r=_9(this.labelExpressionInfo.expression);r&&(t="["+r+"]")}}t!=null&&(e[i]=t)}writeLabelExpressionInfo(t,e,i,r){if(t==null&&this.labelExpression!=null&&Eie(r))t=new Aie({expression:this.getLabelExpressionArcade()});else if(!t)return;const s=t.toJSON(r);s.expression&&(e[i]=s)}writeMaxScale(t,e){(t||this.minScale)&&(e.maxScale=t)}writeMinScale(t,e){(t||this.maxScale)&&(e.minScale=t)}getLabelExpression(){return Q$(this)}getLabelExpressionArcade(){return G4e(this)}getLabelExpressionSingleField(){return q4e(this)}hash(){return JSON.stringify(this)}clone(){return new w9({allowOverrun:this.allowOverrun,deconflictionStrategy:this.deconflictionStrategy,labelExpression:this.labelExpression,labelExpressionInfo:ie(this.labelExpressionInfo),labelPosition:this.labelPosition,labelPlacement:this.labelPlacement,maxScale:this.maxScale,minScale:this.minScale,name:this.name,repeatLabel:this.repeatLabel,repeatLabelDistance:this.repeatLabelDistance,symbol:ie(this.symbol),where:this.where,useCodedValues:this.useCodedValues})}};u([d({type:String,json:{write:!0}})],xr.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0,default:!1,origins:{"web-scene":{write:!1}}}})],xr.prototype,"allowOverrun",void 0),u([d({type:String,json:{write:!0,default:"static",origins:{"web-scene":{write:!1}}}})],xr.prototype,"deconflictionStrategy",void 0),u([d({type:String,json:{write:{overridePolicy(t,e,i){return this.labelExpressionInfo&&(i==null?void 0:i.origin)==="service"&&Rie(i.layer)?{enabled:!1}:{allowNull:!0}}}}})],xr.prototype,"labelExpression",void 0),u([Ce("labelExpression")],xr.prototype,"readLabelExpression",null),u([Ee("labelExpression")],xr.prototype,"writeLabelExpression",null),u([d({type:Aie,json:{write:{overridePolicy:(t,e,i)=>nDe(i)?{allowNull:!0}:{enabled:!1}}}})],xr.prototype,"labelExpressionInfo",void 0),u([Ee("labelExpressionInfo")],xr.prototype,"writeLabelExpressionInfo",null),u([d({type:Y$.apiValues,json:{type:Y$.jsonValues,read:Y$.read,write:Y$.write}})],xr.prototype,"labelPlacement",void 0),u([d({type:["curved","parallel"],json:{write:!0,origins:{"web-map":{write:!1},"web-scene":{write:!1},"portal-item":{write:!1}}}})],xr.prototype,"labelPosition",void 0),u([d({type:Number})],xr.prototype,"maxScale",void 0),u([Ee("maxScale")],xr.prototype,"writeMaxScale",null),u([d({type:Number})],xr.prototype,"minScale",void 0),u([Ee("minScale")],xr.prototype,"writeMinScale",null),u([d({type:Boolean,json:{write:!0,origins:{"web-scene":{write:!1},"portal-item":{write:!1}}}})],xr.prototype,"repeatLabel",void 0),u([d({type:Number,cast:ti,json:{write:!0,origins:{"web-scene":{write:!1}}}})],xr.prototype,"repeatLabelDistance",void 0),u([d({types:jxe,json:{origins:{"web-scene":{types:Bxe,write:T_,default:null}},write:T_,default:null}})],xr.prototype,"symbol",void 0),u([d({type:Boolean,json:{write:!0}})],xr.prototype,"useCodedValues",void 0),u([d({type:String,json:{write:!0}})],xr.prototype,"where",void 0),xr=w9=u([R("esri.layers.support.LabelClass")],xr);const x9=xr;var S9;let la=S9=class extends ge{constructor(t){super(t),this.type="cluster",this.clusterRadius=ti("80px"),this.clusterMinSize=ti("12px"),this.clusterMaxSize=ti("50px"),this.popupEnabled=!0,this.popupTemplate=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=null}clone(){return new S9({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:ie(this.labelingInfo),labelsVisible:this.labelsVisible,fields:ie(this.fields),popupEnabled:this.popupEnabled,popupTemplate:ie(this.popupTemplate)})}};u([d({type:["cluster"],readOnly:!0,json:{write:!0}})],la.prototype,"type",void 0),u([d({type:Number,cast:t=>t==="auto"?t:ti(t),json:{write:!0}})],la.prototype,"clusterRadius",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],la.prototype,"clusterMinSize",void 0),u([d({type:Number,cast:ti,json:{write:!0}})],la.prototype,"clusterMaxSize",void 0),u([d(vie)],la.prototype,"popupEnabled",void 0),u([d({type:rP,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],la.prototype,"popupTemplate",void 0),u([d({types:Nxe})],la.prototype,"symbol",void 0),u([d({type:[x9],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],la.prototype,"labelingInfo",void 0),u([d(_ie)],la.prototype,"labelsVisible",void 0),u([d({type:[k4e],json:{write:!0}})],la.prototype,"fields",void 0),la=S9=u([R("esri.layers.support.FeatureReductionCluster")],la);const Iie=la;var T9;let X$=T9=class extends Z${constructor(t){super(t),this.type="selection"}clone(){return new T9}};u([d({type:["selection"]})],X$.prototype,"type",void 0),X$=T9=u([R("esri.layers.support.FeatureReductionSelection")],X$);const Die=X$,oDe={types:{key:"type",base:Z$,typeMap:{selection:Die,cluster:Iie}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:{key:"type",base:Z$,typeMap:{selection:Iie}}},"web-scene":{types:{key:"type",base:Z$,typeMap:{selection:Die}}}}}},Fie=new wt({esriFeatureEditToolAutoCompletePolygon:"auto-complete-polygon",esriFeatureEditToolCircle:"circle",esriFeatureEditToolEllipse:"ellipse",esriFeatureEditToolFreehand:"freehand",esriFeatureEditToolLine:"line",esriFeatureEditToolNone:"none",esriFeatureEditToolPoint:"point",esriFeatureEditToolPolygon:"polygon",esriFeatureEditToolRectangle:"rectangle",esriFeatureEditToolArrow:"arrow",esriFeatureEditToolTriangle:"triangle",esriFeatureEditToolLeftArrow:"left-arrow",esriFeatureEditToolRightArrow:"right-arrow",esriFeatureEditToolUpArrow:"up-arrow",esriFeatureEditToolDownArrow:"down-arrow"});let Rf=class extends ge{constructor(t){super(t),this.name=null,this.description=null,this.drawingTool=null,this.prototype=null,this.thumbnail=null}};u([d({json:{write:!0}})],Rf.prototype,"name",void 0),u([d({json:{write:!0}})],Rf.prototype,"description",void 0),u([d({json:{read:Fie.read,write:Fie.write}})],Rf.prototype,"drawingTool",void 0),u([d({json:{write:!0}})],Rf.prototype,"prototype",void 0),u([d({json:{write:!0}})],Rf.prototype,"thumbnail",void 0),Rf=u([R("esri.layers.support.FeatureTemplate")],Rf);const C9=Rf;let ud=class extends ge{constructor(t){super(t),this.id=null,this.name=null,this.domains=null,this.templates=null}readDomains(t){const e={};for(const i of Object.keys(t))e[i]=Ek(t[i]);return e}writeDomains(t,e){const i={};for(const s of Object.keys(t)){var r;t[s]&&(i[s]=(r=t[s])==null?void 0:r.toJSON())}e.domains=i}};u([d({json:{write:!0}})],ud.prototype,"id",void 0),u([d({json:{write:!0}})],ud.prototype,"name",void 0),u([d({json:{write:!0}})],ud.prototype,"domains",void 0),u([Ce("domains")],ud.prototype,"readDomains",null),u([Ee("domains")],ud.prototype,"writeDomains",null),u([d({type:[C9],json:{write:!0}})],ud.prototype,"templates",void 0),ud=u([R("esri.layers.support.FeatureType")],ud);const Lie=ud;function aDe(t){return t.type==="date"||t.type==="esriFieldTypeDate"}function kie(t){return t.type==="oid"||t.type==="esriFieldTypeOID"}function zie(t){return t.type==="global-id"||t.type==="esriFieldTypeGlobalID"}class lDe{constructor(e){if(this.fields=e,this._fieldsMap=new Map,this._dateFieldsSet=new Set,this._numericFieldsSet=new Set,this.dateFields=[],this.numericFields=[],this._requiredFields=null,!e)return;const i=[];for(const r of e){const s=r&&r.name;if(s){const n=Vie(s);this._fieldsMap.set(s,r),this._fieldsMap.set(n,r),i.push(n),aDe(r)?(this.dateFields.push(r),this._dateFieldsSet.add(r)):BM(r)&&(this._numericFieldsSet.add(r),this.numericFields.push(r)),kie(r)||zie(r)||(r.editable=r.editable==null||!!r.editable,r.nullable=r.nullable==null||!!r.nullable)}}i.sort(),this.uid=i.join(",")}destroy(){this._fieldsMap.clear()}get requiredFields(){if(!this._requiredFields){this._requiredFields=[];for(const e of this.fields)kie(e)||zie(e)||e.nullable||swe(e)!==void 0||this._requiredFields.push(e)}return this._requiredFields}has(e){return this.get(e)!=null}get(e){return e!=null?this._fieldsMap.get(e)||this._fieldsMap.get(Vie(e)):void 0}isDateField(e){return this._dateFieldsSet.has(this.get(e))}isNumericField(e){return this._numericFieldsSet.has(this.get(e))}normalizeFieldName(e){const i=this.get(e);if(i)return i.name}}function Vie(t){return t.toLowerCase().trim()}const cDe=le.getLogger("esri.layers.support.fieldProperties");function uDe(){return{fields:{type:[t_],value:null},fieldsIndex:{readOnly:!0,get(){return new lDe(this.fields||[])}},outFields:{type:[String],json:{read:!1},set:function(t){this._userOutFields=t,this.notifyChange("outFields")},get:function(){const t=this._userOutFields;if(!t||!t.length)return null;if(t.includes("*"))return["*"];if(!this.fields)return t;for(const e of t)this.fieldsIndex.has(e)||cDe.error("field-attributes-layer:invalid-field",`Invalid field ${e} found in outFields`,{layer:this,outFields:t});return pW(this.fieldsIndex,t)}}}}let D_=class extends ge{constructor(t){super(t),this.shapeAreaField=null,this.shapeLengthField=null,this.units=null}};u([d({type:String,json:{read:{source:"shapeAreaFieldName"}}})],D_.prototype,"shapeAreaField",void 0),u([d({type:String,json:{read:{source:"shapeLengthFieldName"}}})],D_.prototype,"shapeLengthField",void 0),u([d({type:String,json:{read:t=>F2e.read(t)||L2e.read(t)}})],D_.prototype,"units",void 0),D_=u([R("esri.layers.support.GeometryFieldsInfo")],D_);const hDe=D_,dDe=/\[([^\[\]]+)\]/gi;function Nie(t,e,i){return t?t.map(r=>{const s=new x9;if(s.read(r,i),s.labelExpression){const n=e.fields||e.layerDefinition&&e.layerDefinition.fields||this.fields;s.labelExpression=s.labelExpression.replace(dDe,(o,a)=>`[${pDe(a,n)}]`)}return s}):null}function pDe(t,e){if(!e)return t;const i=t.toLowerCase();for(let r=0;r<e.length;r++){const s=e[r].name;if(s.toLowerCase()===i)return s}return t}var M9;let F_=M9=class extends ge{constructor(t){super(t),this.floorField=null,this.viewAllMode=!1,this.viewAllLevelIds=new We}clone(){return new M9({floorField:this.floorField,viewAllMode:this.viewAllMode,viewAllLevelIds:this.viewAllLevelIds})}};u([d({type:String,json:{write:!0}})],F_.prototype,"floorField",void 0),u([d({json:{read:!1,write:!1}})],F_.prototype,"viewAllMode",void 0),u([d({json:{read:!1,write:!1}})],F_.prototype,"viewAllLevelIds",void 0),F_=M9=u([R("esri.layers.support.LayerFloorInfo")],F_);const fDe=F_,Uie=new wt({esriRelCardinalityOneToOne:"one-to-one",esriRelCardinalityOneToMany:"one-to-many",esriRelCardinalityManyToMany:"many-to-many"}),jie=new wt({esriRelRoleOrigin:"origin",esriRelRoleDestination:"destination"});let Za=class extends ge{constructor(t){super(t),this.cardinality=null,this.composite=null,this.id=null,this.keyField=null,this.keyFieldInRelationshipTable=null,this.name=null,this.relatedTableId=null,this.relationshipTableId=null,this.role=null}};u([d({json:{read:Uie.read,write:Uie.write}})],Za.prototype,"cardinality",void 0),u([d({json:{read:!0,write:!0}})],Za.prototype,"composite",void 0),u([d({json:{read:!0,write:!0}})],Za.prototype,"id",void 0),u([d({json:{read:!0,write:!0}})],Za.prototype,"keyField",void 0),u([d({json:{read:!0,write:!0}})],Za.prototype,"keyFieldInRelationshipTable",void 0),u([d({json:{read:!0,write:!0}})],Za.prototype,"name",void 0),u([d({json:{read:!0,write:!0}})],Za.prototype,"relatedTableId",void 0),u([d({json:{read:!0,write:!0}})],Za.prototype,"relationshipTableId",void 0),u([d({json:{read:jie.read,write:jie.write}})],Za.prototype,"role",void 0),Za=u([R("esri.layers.support.Relationship")],Za);const mDe=Za;async function gDe(t,e,i){const r=t&&t.getAtOrigin&&t.getAtOrigin("renderer",e.origin);if(r&&r.type==="unique-value"&&r.styleOrigin){const s=await zl(r.populateFromStyle());if(Dt(i),s.ok===!1){const n=s.error;e&&e.messages&&e.messages.push(new Go("renderer:style-reference",`Failed to create unique value renderer from style reference: ${n.message}`,{error:n,context:e})),t.clear("renderer",e.origin)}}}const yDe=["oid","global-id"],vDe=["oid","global-id","guid"];function _De({displayField:t,editFieldsInfo:e,fields:i,objectIdField:r,title:s},n){if(!i)return null;const o=CDe({editFieldsInfo:e,fields:i,objectIdField:r},n);if(!o.length)return null;const a=ADe({titleBase:s,fields:i,displayField:t}),l=PDe();return new rP({title:a,content:l,fieldInfos:o})}const bDe=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/shape/i,/perimeter/i,/objectid/i,/_i$/i],wDe=(t,{editFieldsInfo:e,objectIdField:i,visibleFieldNames:r})=>r?r.has(t.name):!Bie(t.name,e)&&(!i||t.name!==i)&&!(yDe.indexOf(t.type)>-1)&&!bDe.some(s=>s.test(t.name));function xDe(t,e){const i=t;return e&&(t=t.filter(r=>e.indexOf(r.type)===-1)),t===i&&(t=t.slice()),t.sort(SDe),t}function SDe(t,e){return t.type==="oid"?-1:e.type==="oid"?1:Gie(t)?-1:Gie(e)?1:(t.alias||t.name).toLocaleLowerCase().localeCompare((e.alias||e.name).toLocaleLowerCase())}function Bie(t,e){if(!t||!e)return!1;const{creationDateField:i,creatorField:r,editDateField:s,editorField:n}=e;return[i&&i.toLowerCase(),r&&r.toLowerCase(),s&&s.toLowerCase(),n&&n.toLowerCase()].indexOf(t.toLowerCase())!==-1}function TDe(t,e){return t.editable&&vDe.indexOf(t.type)===-1&&!Bie(t.name,e)}function CDe({editFieldsInfo:t,fields:e,objectIdField:i},r){return xDe(e,(r==null?void 0:r.ignoreFieldTypes)||$De).map(s=>new Rx({fieldName:s.name,isEditable:TDe(s,t),label:s.alias,format:MDe(s),visible:wDe(s,{editFieldsInfo:t,objectIdField:i,visibleFieldNames:r==null?void 0:r.visibleFieldNames})}))}function MDe(t){switch(t.type){case"small-integer":case"integer":case"single":return new Ox({digitSeparator:!0,places:0});case"double":return new Ox({digitSeparator:!0,places:2});case"date":return new Ox({dateFormat:"long-month-day-year"});default:return null}}function PDe(){return[new l1,new Tx]}function ADe(t){const e=Kbe(t),{titleBase:i}=t;return e?`${i}: {${e.trim()}}`:i}function Gie(t){return(t.name&&t.name.toLowerCase())==="name"?!0:(t.alias&&t.alias.toLowerCase())==="name"||void 0}const $De=["geometry","blob","raster","guid","xml"],P9=new wt({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),EDe={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"},Fr="FeatureLayer",qie=le.getLogger("esri.layers.FeatureLayer");function Hie(t){return t&&t instanceof We}function yt(t,e,i){return!!(t&&t.hasOwnProperty(e)?t[e]:i)}function K$(t,e,i){return t&&t.hasOwnProperty(e)?t[e]:i}const A9=uDe();function $9(t,e,i){const r=!(i==null||!i.writeLayerSchema);return{enabled:r,ignoreOrigin:r}}let Se=class extends h4e(Y8(A4e(F4e(c9(Tie(aie(s9(a9(O$(l4e(CIe(n1)))))))))))){constructor(...t){super(...t),this._handles=new dt,this.capabilities=null,this.charts=null,this.copyright=null,this.datesInUnknownTimezone=!1,this.displayField=null,this.definitionExpression=null,this.dynamicDataSource=null,this.editFieldsInfo=null,this.editingInfo=null,this.elevationInfo=null,this.featureReduction=null,this.fields=null,this.fieldsIndex=null,this.floorInfo=null,this.formTemplate=null,this.fullExtent=null,this.gdbVersion=null,this.geometryFieldsInfo=null,this.geometryType=null,this.hasM=void 0,this.hasZ=void 0,this.heightModelInfo=null,this.historicMoment=null,this.infoFor3D=null,this.isTable=!1,this.labelsVisible=!0,this.labelingInfo=null,this.layerId=void 0,this.legendEnabled=!0,this.minScale=0,this.maxScale=0,this.globalIdField=null,this.objectIdField=null,this.outFields=null,this.path=null,this.popupEnabled=!0,this.popupTemplate=null,this.relationships=null,this.sourceJSON=null,this.returnM=void 0,this.returnZ=void 0,this.screenSizePerspectiveEnabled=!0,this.serviceDefinitionExpression=null,this.spatialReference=Ue.WGS84,this.subtypeCode=null,this.templates=null,this.timeInfo=null,this.title=null,this.sublayerTitleMode="item-title",this.trackIdField=null,this.type="feature",this.typeIdField=null,this.types=null,this.indexes=new(We.ofType(cd)),this.userIsAdmin=!1,this.version=void 0,this.visible=!0}destroy(){var t;(t=this.source)==null||t.destroy(),this._handles=tt(this._handles)}normalizeCtorArgs(t,e){return typeof t=="string"?E({url:t},e):t}load(t){const e=_(t)?t.signal:null;if(this.portalItem&&this.portalItem.loaded&&this.source)return void this.addResolvingPromise(this.createGraphicsSource(e).then(r=>this._initLayerProperties(r)));const i=this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]},t).catch(Wc).then(async()=>{if(this.url&&this.layerId==null&&/FeatureServer|MapServer\/*$/i.test(this.url)){const r=await this._fetchFirstLayerId(e);r!=null&&(this.layerId=r)}if(!this.url&&!this._hasMemorySource())throw new Q("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this._initLayerProperties(await this.createGraphicsSource(e))}).then(()=>this.finishLoadEditablePortalLayer(t));return this.addResolvingPromise(i),Promise.resolve(this)}readCapabilities(t,e){return e=e.layerDefinition||e,{attachment:this._readAttachmentCapabilities(e.attachmentProperties),data:this._readDataCapabilities(e),metadata:this._readMetadataCapabilities(e),operations:this._readOperationsCapabilities(e.capabilities||t,e),query:this._readQueryCapabilities(e),queryRelated:this._readQueryRelatedCapabilities(e),editing:this._readEditingCapabilities(e)}}get createQueryVersion(){return this.commitProperty("definitionExpression"),this.commitProperty("dynamicDataSource"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("gdbVersion"),this.commitProperty("historicMoment"),this.commitProperty("returnZ"),this.commitProperty("capabilities"),this.commitProperty("returnM"),(this._get("createQueryVersion")||0)+1}get editingEnabled(){return!(this.loaded&&!this.capabilities.operations.supportsEditing)&&(this._isOverridden("editingEnabled")?this._get("editingEnabled"):this._hasMemorySource()||this.userHasEditingPrivileges)}set editingEnabled(t){t!=null?this._override("editingEnabled",t):this._clearOverride("editingEnabled")}readEditingEnabled(t,e){return this._readEditingEnabled(e,!1)}readEditingEnabledFromWebMap(t,e,i){return this._readEditingEnabled(e,!0,i)}writeEditingEnabled(t,e){this._writeEditingEnabled(t,e,!1)}writeEditingEnabledToWebMap(t,e,i,r){this._writeEditingEnabled(t,e,!0,r)}readEditingInfo(t,e){const{editingInfo:i}=e;return i?{lastEditDate:i.lastEditDate!=null?new Date(i.lastEditDate):null}:null}readIsTable(t,e){return(e=e&&e.layerDefinition||e).type==="Table"||!e.geometryType}writeIsTable(t,e,i,r){r!=null&&r.writeLayerSchema&&Bo(i,t?"Table":"Feature Layer",e)}readMinScale(t,e){return e.effectiveMinScale||t||0}readMaxScale(t,e){return e.effectiveMaxScale||t||0}readGlobalIdFieldFromService(t,e){if((e=e.layerDefinition||e).globalIdField)return e.globalIdField;if(e.fields){for(const i of e.fields)if(i.type==="esriFieldTypeGlobalID")return i.name}}readObjectIdFieldFromService(t,e){if((e=e.layerDefinition||e).objectIdField)return e.objectIdField;if(e.fields){for(const i of e.fields)if(i.type==="esriFieldTypeOID")return i.name}}get parsedUrl(){const t=this.url?ms(this.url):null;return t!=null&&(this.dynamicDataSource!=null?t.path=Mp(t.path,"dynamicLayer"):this.layerId!=null&&(t.path=Mp(t.path,this.layerId.toString()))),t}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(t){uW(t,this.fieldsIndex),this._set("renderer",t)}readRenderer(t,e,i){const r=(e=e.layerDefinition||e).drawingInfo&&e.drawingInfo.renderer||void 0;if(r){const s=oIe(r,e,i)||void 0;return s||qie.error("Failed to create renderer",{rendererDefinition:e.drawingInfo.renderer,layer:this,context:i}),s}if(e.defaultSymbol)return e.types&&e.types.length?new S8({defaultSymbol:E9(e.defaultSymbol,e,i),field:e.typeIdField,uniqueValueInfos:e.types.map(s=>({id:s.id,symbol:E9(s.symbol,s,i)}))}):new v8({symbol:E9(e.defaultSymbol,e,i)})}set source(t){const e=this._get("source");e!==t&&(Hie(e)&&this._resetMemorySource(e),Hie(t)&&this._initMemorySource(t),this._set("source",t))}castSource(t){return t?Array.isArray(t)||t instanceof We?new oie({layer:this,items:t}):t:null}readSource(t,e){const i=Cu.fromJSON(e.featureSet);return new oie({layer:this,items:i&&i.features||[]})}readServiceDefinitionExpression(t,e){return e.definitionQuery||e.definitionExpression}readTemplates(t,e){const i=e.editFieldsInfo,r=i&&i.creatorField,s=i&&i.editorField;return t=t&&t.map(n=>C9.fromJSON(n)),this._fixTemplates(t,r),this._fixTemplates(t,s),t}readTitle(t,e){const i=e.layerDefinition&&e.layerDefinition.name||e.name,r=e.title||e.layerDefinition&&e.layerDefinition.title;if(i){const s=this.portalItem&&this.portalItem.title;if(this.sublayerTitleMode==="item-title")return this.url?qPe(this.url,i):i;let n=i;if(!n&&this.url){const o=D2(this.url);_(o)&&(n=o.title)}return n?(this.sublayerTitleMode==="item-title-and-service-name"&&s&&s!==n&&(n=s+" - "+n),Gk(n)):void 0}if(this.sublayerTitleMode==="item-title"&&r)return r}readTitleFromWebMap(t,e){return e.title||e.layerDefinition&&e.layerDefinition.name}readTypeIdField(t,e){let i=(e=e.layerDefinition||e).typeIdField;if(i&&e.fields){i=i.toLowerCase();const r=e.fields.find(s=>s.name.toLowerCase()===i);r&&(i=r.name)}return i}readTypes(t,e){t=(e=e.layerDefinition||e).types;const i=e.editFieldsInfo,r=i&&i.creatorField,s=i&&i.editorField;return t&&t.map(n=>(n=Lie.fromJSON(n),this._fixTemplates(n.templates,r),this._fixTemplates(n.templates,s),n))}set url(t){const e=ZPe({layer:this,url:t,nonStandardUrlAllowed:!0,logger:qie});this._set("url",e.url),e.layerId!=null&&this._set("layerId",e.layerId)}writeUrl(t,e,i,r){JPe(this,t,null,e,r)}readVersion(t,e){return e.currentVersion?e.currentVersion:e.hasOwnProperty("capabilities")||e.hasOwnProperty("drawingInfo")||e.hasOwnProperty("hasAttachments")||e.hasOwnProperty("htmlPopupType")||e.hasOwnProperty("relationships")||e.hasOwnProperty("timeInfo")||e.hasOwnProperty("typeIdField")||e.hasOwnProperty("types")?10:9.3}readVisible(t,e){return e.layerDefinition&&e.layerDefinition.defaultVisibility!=null?!!e.layerDefinition.defaultVisibility:e.visibility!=null?!!e.visibility:void 0}addAttachment(t,e){return this.load().then(()=>this._checkAttachmentSupport(t)).then(()=>{if(!("addAttachment"in this.source))throw new Q(Fr,"Layer source does not support addAttachment capability");return this.source.addAttachment(t,e)})}updateAttachment(t,e,i){return this.load().then(()=>this._checkAttachmentSupport(t)).then(()=>{if(!("updateAttachment"in this.source))throw new Q(Fr,"Layer source does not support updateAttachment capability");return this.source.updateAttachment(t,e,i)})}async applyEdits(t,e){const i=await import("./editingSupport.6c941b40.js");return await this.load(),i.applyEdits(this,this.source,t,e)}on(t,e){return super.on(t,e)}createPopupTemplate(t){return _De(this,t)}async createGraphicsSource(t){if(this._hasMemorySource())return this.source.load({signal:t});const{default:e}=await yD(import("./FeatureLayerSource.e1904246.js"),t);return new e({layer:this}).load({signal:t})}createQuery(){const t=new jn,e=this.get("capabilities.data");t.dynamicDataSource=this.dynamicDataSource,t.gdbVersion=this.gdbVersion,t.historicMoment=this.historicMoment,t.returnGeometry=!0,e&&(e.supportsZ&&this.returnZ!=null&&(t.returnZ=this.returnZ),e.supportsM&&this.returnM!=null&&(t.returnM=this.returnM)),t.outFields=["*"],t.where=this.definitionExpression||"1=1";const{timeOffset:i,timeExtent:r}=this;return t.timeExtent=i!=null&&r!=null?r.offset(-i.value,i.unit):r||null,t.multipatchOption=this.geometryType==="multipatch"?"xyFootprint":null,t}deleteAttachments(t,e){return this.load().then(()=>this._checkAttachmentSupport(t)).then(()=>{if(!("deleteAttachments"in this.source))throw new Q(Fr,"Layer source does not support deleteAttachments capability");return this.source.deleteAttachments(t,e)})}fetchRecomputedExtents(t){return this.load({signal:t==null?void 0:t.signal}).then(()=>{if(this.source.fetchRecomputedExtents)return this.source.fetchRecomputedExtents(t);throw new Q(Fr,"Layer source does not support fetchUpdates capability")})}getFeatureType(t){const{typeIdField:e,types:i}=this;if(!e||!t)return null;const r=t.attributes?t.attributes[e]:void 0;if(r==null)return null;let s=null;return i.some(n=>{const{id:o}=n;return o!=null&&(o.toString()===r.toString()&&(s=n),!!s)}),s}getFieldDomain(t,e){const i=e&&e.feature,r=this.getFeatureType(i);if(r){const s=r.domains&&r.domains[t];if(s&&s.type!=="inherited")return s}return this._getLayerDomain(t)}getField(t){return this.fieldsIndex.get(t)}queryAttachments(t,e){return t=EA.from(t),this.load().then(()=>{if(!this.get("capabilities.data.supportsAttachment"))throw new Q(Fr,"this layer doesn't support attachments");const{attachmentTypes:i,objectIds:r,globalIds:s,num:n,size:o,start:a,where:l}=t;if(!this.get("capabilities.operations.supportsQueryAttachments")){const c=r&&r.length>1,h=i&&i.length,p=s&&s.length,f=o&&o.length;if(c||h||p||f||n||a||l)throw new Q(Fr,"when 'supportsQueryAttachments' is false, only objectIds of length 1 are supported",t)}if(!(r&&r.length||l))throw new Q(Fr,"'objectIds' or 'where' are required to perform attachment query",t);if(!("queryAttachments"in this.source))throw new Q(Fr,"Layer source does not support queryAttachments capability",t);return this.source.queryAttachments(t)})}queryFeatures(t,e){return this.load().then(()=>this.source.queryFeatures(jn.from(t)||this.createQuery(),e)).then(i=>{if(i!=null&&i.features)for(const r of i.features)r.layer=r.sourceLayer=this;return i})}queryObjectIds(t,e){return this.load().then(()=>{if(this.source.queryObjectIds)return this.source.queryObjectIds(jn.from(t)||this.createQuery(),e);throw new Q(Fr,"Layer source does not support queryObjectIds capability")})}queryFeatureCount(t,e){return this.load().then(()=>{if(this.source.queryFeatureCount)return this.source.queryFeatureCount(jn.from(t)||this.createQuery(),e);throw new Q(Fr,"Layer source does not support queryFeatureCount capability")})}queryExtent(t,e){return this.load().then(()=>{if(this.source.queryExtent)return this.source.queryExtent(jn.from(t)||this.createQuery(),e);throw new Q(Fr,"Layer source does not support queryExtent capability")})}queryRelatedFeatures(t,e){return this.load().then(()=>{if("queryRelatedFeatures"in this.source)return this.source.queryRelatedFeatures(Py.from(t),e);throw new Q(Fr,"Layer source does not support queryRelatedFeatures capability")})}queryRelatedFeaturesCount(t,e){return this.load().then(()=>{if("queryRelatedFeaturesCount"in this.source)return this.source.queryRelatedFeaturesCount(Py.from(t),e);throw new Q(Fr,"Layer source does not support queryRelatedFeaturesCount capability")})}queryTopFeatures(t,e){return this.load().then(()=>{if("queryTopFeatures"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopFeatures(wf.from(t),e).then(i=>{if(i!=null&&i.features)for(const r of i.features)r.layer=r.sourceLayer=this;return i});throw new Q(Fr,"Layer source does not support queryTopFeatures capability")})}queryTopObjectIds(t,e){return this.load().then(()=>{if("queryTopObjectIds"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopObjectIds(wf.from(t),e);throw new Q(Fr,"Layer source does not support queryTopObjectIds capability")})}queryTopFeaturesExtent(t,e){return this.load().then(()=>{if("queryTopExtents"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopExtents(wf.from(t),e);throw new Q(Fr,"Layer source does not support queryTopExtents capability")})}queryTopFeatureCount(t,e){return this.load().then(()=>{if("queryTopCount"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopCount(wf.from(t),e);throw new Q(Fr,"Layer source does not support queryFeatureCount capability")})}read(t,e){const i=t.featureCollection;if(i){const r=i.layers;r&&r.length===1&&(super.read(r[0],e),i.showLegend!=null&&super.read({showLegend:i.showLegend},e))}super.read(t,e),e&&e.origin==="service"&&this.revert(["objectIdField","fields","timeInfo","spatialReference"],"service")}write(t,e){var i,r;const s=(e=he(E({},e),{writeLayerSchema:(i=(r=e)==null?void 0:r.writeLayerSchema)!=null?i:this._hasMemorySource()})).origin,n=e.layerContainerType,o=e.messages;if(this.isTable){if(s==="web-scene"||s==="web-map"&&n!=="tables")return o&&o.push(new Q("layer:unsupported",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a Table source cannot be written to web scenes and web maps`,{layer:this})),null;if(this._hasMemorySource())return o&&o.push(new Q("layer:unsupported",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using an in-memory Table source cannot be written to web scenes and web maps`,{layer:this})),null}else if(this.loaded&&s==="web-map"&&n==="tables")return o&&o.push(new Q("layer:unsupported",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a non-table source cannot be written to tables in web maps`,{layer:this})),null;return super.write(t,e)}_readEditingEnabled(t,e,i){var r;let s=(r=t.layerDefinition)==null?void 0:r.capabilities;return s?this._hasEditingCapability(s):(s=t.capabilities,e&&(i==null?void 0:i.origin)==="web-map"&&!this._hasMemorySource()&&s?this._hasEditingCapability(s):void 0)}_hasEditingCapability(t){return t.toLowerCase().split(",").map(e=>e.trim()).includes("editing")}_writeEditingEnabled(t,e,i,r){if(!t){var s,n;const o=(s=this.capabilities)!=null&&(n=s.operations)!=null&&n.supportsSync?"Query,Sync":"Query";Bo("layerDefinition.capabilities",o,e),!i||r!=null&&r.writeLayerSchema||(e.capabilities=o)}}_checkAttachmentSupport(t){const{attributes:e}=t,{objectIdField:i}=this;return this.get("capabilities.data.supportsAttachment")?t?e?e[i]?void 0:Promise.reject(new Q(Fr,`feature is missing the identifying attribute ${i}`)):Promise.reject(new Q(Fr,"'attributes' are required on a feature to query attachments")):Promise.reject(new Q(Fr,"A feature is required to add/delete/update attachments")):Promise.reject(new Q(Fr,"this layer doesn't support attachments"))}_getLayerDomain(t){const e=this.fieldsIndex.get(t);return e?e.domain:null}_fetchFirstLayerId(t){return vt(this.url,{query:he(E({f:"json"},this.customParameters),{token:this.apiKey}),responseType:"json",signal:t}).then(e=>{const i=e.data;if(i)return Array.isArray(i.layers)&&i.layers.length>0?i.layers[0].id:Array.isArray(i.tables)&&i.tables.length>0?i.tables[0].id:void 0})}async _initLayerProperties(t){return this._set("source",t),t.sourceJSON&&(this.sourceJSON=t.sourceJSON,this.read(t.sourceJSON,{origin:"service",url:this.parsedUrl})),this._verifySource(),this._verifyFields(),uW(this.renderer,this.fieldsIndex),dW(this.timeInfo,this.fieldsIndex),gDe(this,{origin:"service"})}async hasDataChanged(){var t;if((t=this.source)!=null&&t.refresh)try{var e;const{dataChanged:i,updates:r}=await((e=this.source)==null?void 0:e.refresh());if(_(r)&&(this.sourceJSON=E(E({},this.sourceJSON),r),this.read(r,{origin:"service",url:this.parsedUrl})),i)return!0}catch{}if(this.definitionExpression)try{return(await lIe(this.definitionExpression,this.fieldsIndex)).hasDateFunctions}catch{}return!1}_verifyFields(){const t=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+t+")"),this.isTable||this._hasMemorySource()||t.search(/\/FeatureServer\//i)!==-1||this.fields&&this.fields.some(function(e){return e.type==="geometry"})||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+t+")")}_fixTemplates(t,e){t&&t.forEach(i=>{const r=i.prototype&&i.prototype.attributes;r&&e&&delete r[e]})}_verifySource(){if(this._hasMemorySource()){if(this.url)throw new Q("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url")}else if(!this.url)throw new Q("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}_initMemorySource(t){t.forEach(e=>{e.layer=this,e.sourceLayer=this}),this._handles.add([t.on("after-add",e=>{e.item.layer=this,e.item.sourceLayer=this}),t.on("after-remove",e=>{e.item.layer=null,e.item.sourceLayer=null})],"fl-source")}_resetMemorySource(t){t.forEach(e=>{e.layer=null,e.sourceLayer=null}),this._handles.remove("fl-source")}_hasMemorySource(){return!(this.url||!this.source)}_readAttachmentCapabilities(t){const e={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1};return t&&Array.isArray(t)&&t.forEach(i=>{const r=EDe[i.name];r&&(e[r]=!!i.isEnabled)}),e}_readDataCapabilities(t){return{isVersioned:yt(t,"isDataVersioned",!1),supportsAttachment:yt(t,"hasAttachments",!1),supportsM:yt(t,"hasM",!1),supportsZ:yt(t,"hasZ",!1)}}_readMetadataCapabilities(t){return{supportsAdvancedFieldProperties:yt(t,"supportsFieldDescriptionProperty",!1)}}_readOperationsCapabilities(t,e){const i=t?t.toLowerCase().split(",").map(l=>l.trim()):[],r=i.includes("editing")&&!e.datesInUnknownTimezone;let s=r&&i.includes("create"),n=r&&i.includes("delete"),o=r&&i.includes("update");const a=i.includes("changetracking");return r&&!(s||n||o)&&(s=n=o=!0),{supportsCalculate:yt(e,"supportsCalculate",!1),supportsTruncate:yt(e,"supportsTruncate",!1),supportsValidateSql:yt(e,"supportsValidateSql",!1),supportsAdd:s,supportsDelete:n,supportsEditing:r,supportsChangeTracking:a,supportsQuery:i.includes("query"),supportsQueryAttachments:yt(e.advancedQueryCapabilities,"supportsQueryAttachments",!1),supportsResizeAttachments:yt(e,"supportsAttachmentsResizing",!1),supportsSync:i.includes("sync"),supportsUpdate:o,supportsExceedsLimitStatistics:yt(e,"supportsExceedsLimitStatistics",!1)}}_readQueryCapabilities(t){var e;const i=t.advancedQueryCapabilities,r=t.ownershipBasedAccessControlForFeatures,s=t.archivingInfo,n=(e=this.url)==null?void 0:e.includes("MapServer"),o=!ae("mapserver-pbf-enabled")&&n&&this.version<10.81,a=(t.supportedQueryFormats||"").split(",").reduce((l,c)=>{const h=c.toLowerCase().trim();return h&&l.add(h),l},new Set);return{supportsStatistics:yt(i,"supportsStatistics",t.supportsStatistics),supportsPercentileStatistics:yt(i,"supportsPercentileStatistics",!1),supportsCentroid:yt(i,"supportsReturningGeometryCentroid",!1),supportsDistance:yt(i,"supportsQueryWithDistance",!1),supportsDistinct:yt(i,"supportsDistinct",t.supportsAdvancedQueries),supportsExtent:yt(i,"supportsReturningQueryExtent",!1),supportsGeometryProperties:yt(i,"supportsReturningGeometryProperties",!1),supportsHavingClause:yt(i,"supportsHavingClause",!1),supportsOrderBy:yt(i,"supportsOrderBy",t.supportsAdvancedQueries),supportsPagination:yt(i,"supportsPagination",!1),supportsQuantization:yt(t,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:yt(t,"supportsQuantizationEditMode",!1),supportsQueryGeometry:yt(t,"supportsReturningQueryGeometry",!1),supportsResultType:yt(i,"supportsQueryWithResultType",!1),supportsMaxRecordCountFactor:yt(i,"supportsMaxRecordCountFactor",!1),supportsSqlExpression:yt(i,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:yt(t,"useStandardizedQueries",!1),supportsTopFeaturesQuery:yt(i,"supportsTopFeaturesQuery",!1),supportsQueryByOthers:yt(r,"allowOthersToQuery",!0),supportsHistoricMoment:yt(s,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:!o&&a.has("pbf"),supportsDisjointSpatialRelationship:yt(i,"supportsDisjointSpatialRel",!1),supportsCacheHint:yt(i,"supportsQueryWithCacheHint",!1),maxRecordCountFactor:K$(t,"maxRecordCountFactor",void 0),maxRecordCount:K$(t,"maxRecordCount",void 0),standardMaxRecordCount:K$(t,"standardMaxRecordCount",void 0),tileMaxRecordCount:K$(t,"tileMaxRecordCount",void 0)}}_readQueryRelatedCapabilities(t){const e=t.advancedQueryCapabilities,i=yt(e,"supportsAdvancedQueryRelated",!1);return{supportsPagination:yt(e,"supportsQueryRelatedPagination",!1),supportsCount:i,supportsOrderBy:i}}_readEditingCapabilities(t){const e=t.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:yt(t,"allowGeometryUpdates",!0),supportsGlobalId:yt(t,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:yt(t,"supportsReturnServiceEditsInSourceSR",!1),supportsRollbackOnFailure:yt(t,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:yt(t,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:yt(t,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:yt(e,"allowAnonymousToDelete",!0),supportsDeleteByOthers:yt(e,"allowOthersToDelete",!0),supportsUpdateByAnonymous:yt(e,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:yt(e,"allowOthersToUpdate",!0)}}};u([d({readOnly:!0,json:{read:!1}})],Se.prototype,"capabilities",void 0),u([Ce("service","capabilities",["advancedQueryCapabilities","allowGeometryUpdates","allowUpdateWithoutMValues","archivingInfo","capabilities","datesInUnknownTimezone","hasAttachments","hasM","hasZ","maxRecordCount","maxRecordCountFactor","ownershipBasedAccessControlForFeatures","standardMaxRecordCount","supportedQueryFormats","supportsAdvancedQueries","supportsApplyEditsWithGlobalIds","supportsAttachmentsByUploadId","supportsAttachmentsResizing","supportsCalculate","supportsCoordinatesQuantization","supportsExceedsLimitStatistics","supportsFieldDescriptionProperty","supportsQuantizationEditMode","supportsRollbackOnFailureParameter","supportsStatistics","supportsTruncate","supportsValidateSql","tileMaxRecordCount","useStandardizedQueries"])],Se.prototype,"readCapabilities",null),u([d({json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],Se.prototype,"charts",void 0),u([d({readOnly:!0})],Se.prototype,"createQueryVersion",null),u([d({type:String,json:{read:{source:"layerDefinition.copyrightText"},origins:{service:{read:{source:"copyrightText"}}}}})],Se.prototype,"copyright",void 0),u([d({type:Boolean})],Se.prototype,"datesInUnknownTimezone",void 0),u([d({type:String,json:{read:{source:"layerDefinition.displayField"},origins:{service:{read:{source:"displayField"}}}}})],Se.prototype,"displayField",void 0),u([d({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],Se.prototype,"definitionExpression",void 0),u([d({types:sy,readOnly:!0})],Se.prototype,"defaultSymbol",void 0),u([d({type:na})],Se.prototype,"dynamicDataSource",void 0),u([d({readOnly:!0})],Se.prototype,"editFieldsInfo",void 0),u([d({type:Boolean})],Se.prototype,"editingEnabled",null),u([Ce(["portal-item","web-scene"],"editingEnabled",["layerDefinition.capabilities"])],Se.prototype,"readEditingEnabled",null),u([Ce("web-map","editingEnabled",["capabilities","layerDefinition.capabilities"])],Se.prototype,"readEditingEnabledFromWebMap",null),u([Ee(["portal-item","web-scene"],"editingEnabled",{"layerDefinition.capabilities":{type:String}})],Se.prototype,"writeEditingEnabled",null),u([Ee("web-map","editingEnabled",{capabilities:{type:String},"layerDefinition.capabilities":{type:String}})],Se.prototype,"writeEditingEnabledToWebMap",null),u([d({readOnly:!0})],Se.prototype,"editingInfo",void 0),u([Ce("editingInfo")],Se.prototype,"readEditingInfo",null),u([d(w4e)],Se.prototype,"elevationInfo",void 0),u([d(oDe)],Se.prototype,"featureReduction",void 0),u([d(he(E({},A9.fields),{json:{read:{source:"layerDefinition.fields"},origins:{service:{name:"fields"},"web-map":{write:{target:"layerDefinition.fields",overridePolicy:$9}}}}}))],Se.prototype,"fields",void 0),u([d(A9.fieldsIndex)],Se.prototype,"fieldsIndex",void 0),u([d({type:fDe,json:{read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo"}}})],Se.prototype,"floorInfo",void 0),u([d({type:bIe,json:{name:"formInfo",write:!0,origins:{"web-scene":{read:!1,write:!1}}}})],Se.prototype,"formTemplate",void 0),u([d({type:ht,json:{origins:{service:{read:{source:"extent"}}},read:{source:"layerDefinition.extent"}}})],Se.prototype,"fullExtent",void 0),u([d()],Se.prototype,"gdbVersion",void 0),u([d({readOnly:!0,type:hDe,json:{read:{source:"geometryProperties"}}})],Se.prototype,"geometryFieldsInfo",void 0),u([d({type:["point","polygon","polyline","multipoint","multipatch","mesh"],json:{origins:{service:{read:P9.read},"web-map":{write:{target:"layerDefinition.geometryType",overridePolicy:$9,writer(t,e,i){const r=t?P9.toJSON(t):null;r&&Bo(i,r,e)}}}},read:{source:"layerDefinition.geometryType",reader:P9.read}}})],Se.prototype,"geometryType",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}})],Se.prototype,"hasM",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasZ"}}})],Se.prototype,"hasZ",void 0),u([d({readOnly:!0,type:ay})],Se.prototype,"heightModelInfo",void 0),u([d({type:Date})],Se.prototype,"historicMoment",void 0),u([d(S4e)],Se.prototype,"id",void 0),u([d({readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],Se.prototype,"infoFor3D",void 0),u([d({readOnly:!0,json:{origins:{"web-map":{write:{target:"layerDefinition.type"}}}}})],Se.prototype,"isTable",void 0),u([Ce("service","isTable",["type","geometryType"]),Ce("isTable",["layerDefinition.type","layerDefinition.geometryType"])],Se.prototype,"readIsTable",null),u([Ee("web-map","isTable")],Se.prototype,"writeIsTable",null),u([d(_ie)],Se.prototype,"labelsVisible",void 0),u([d({type:[x9],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:Nie},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:Nie},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],Se.prototype,"labelingInfo",void 0),u([d(x4e)],Se.prototype,"opacity",void 0),u([d({type:Number,json:{origins:{service:{read:{source:"id"}}},read:!1}})],Se.prototype,"layerId",void 0),u([d(b4e)],Se.prototype,"legendEnabled",void 0),u([d({type:["show","hide"]})],Se.prototype,"listMode",void 0),u([d(T4e)],Se.prototype,"minScale",void 0),u([Ce("service","minScale",["minScale","effectiveMinScale"])],Se.prototype,"readMinScale",null),u([d(C4e)],Se.prototype,"maxScale",void 0),u([Ce("service","maxScale",["maxScale","effectiveMaxScale"])],Se.prototype,"readMaxScale",null),u([d({type:String})],Se.prototype,"globalIdField",void 0),u([Ce("globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"]),Ce("service","globalIdField",["globalIdField","fields"])],Se.prototype,"readGlobalIdFieldFromService",null),u([d({type:String,json:{origins:{"web-map":{write:{target:"layerDefinition.objectIdField",overridePolicy:$9}}}}})],Se.prototype,"objectIdField",void 0),u([Ce("objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"]),Ce("service","objectIdField",["objectIdField","fields"])],Se.prototype,"readObjectIdFieldFromService",null),u([d({value:"ArcGISFeatureLayer",type:["ArcGISFeatureLayer"]})],Se.prototype,"operationalLayerType",void 0),u([d(A9.outFields)],Se.prototype,"outFields",void 0),u([d({readOnly:!0})],Se.prototype,"parsedUrl",null),u([d({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],Se.prototype,"path",void 0),u([d(vie)],Se.prototype,"popupEnabled",void 0),u([d({type:rP,json:{name:"popupInfo",write:!0}})],Se.prototype,"popupTemplate",void 0),u([d({readOnly:!0})],Se.prototype,"defaultPopupTemplate",null),u([d({type:[mDe],readOnly:!0})],Se.prototype,"relationships",void 0),u([d({types:qte,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}},"web-scene":{types:sIe,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:(t,e,i)=>({ignoreOrigin:i==null?void 0:i.writeLayerSchema})}}},write:{target:"layerDefinition.drawingInfo.renderer",overridePolicy:(t,e,i)=>({ignoreOrigin:i==null?void 0:i.writeLayerSchema})}}})],Se.prototype,"renderer",null),u([Ce("service","renderer",["drawingInfo.renderer","defaultSymbol"]),Ce("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol"])],Se.prototype,"readRenderer",null),u([d()],Se.prototype,"sourceJSON",void 0),u([d({type:Boolean})],Se.prototype,"returnM",void 0),u([d({type:Boolean})],Se.prototype,"returnZ",void 0),u([d(_4e)],Se.prototype,"screenSizePerspectiveEnabled",void 0),u([d()],Se.prototype,"source",null),u([ut("source")],Se.prototype,"castSource",null),u([Ce("portal-item","source",["featureSet"]),Ce("web-map","source",["featureSet"])],Se.prototype,"readSource",null),u([d({readOnly:!0})],Se.prototype,"serviceDefinitionExpression",void 0),u([Ce("service","serviceDefinitionExpression",["definitionQuery","definitionExpression"])],Se.prototype,"readServiceDefinitionExpression",null),u([d({type:Ue,json:{origins:{service:{read:{source:"extent.spatialReference"}}},read:{source:"layerDefinition.extent.spatialReference"}}})],Se.prototype,"spatialReference",void 0),u([d({type:Number})],Se.prototype,"subtypeCode",void 0),u([d({type:[C9]})],Se.prototype,"templates",void 0),u([Ce("templates",["editFieldsInfo","creatorField","editorField","templates"])],Se.prototype,"readTemplates",null),u([d({type:Cie})],Se.prototype,"timeInfo",void 0),u([d()],Se.prototype,"title",void 0),u([Ce("service","title",["name"]),Ce("portal-item","title",["layerDefinition.title","layerDefinition.name","title"])],Se.prototype,"readTitle",null),u([Ce("web-map","title",["layerDefinition.name","title"])],Se.prototype,"readTitleFromWebMap",null),u([d({type:String})],Se.prototype,"sublayerTitleMode",void 0),u([d({type:String,json:{read:{source:"timeInfo.trackIdField"}}})],Se.prototype,"trackIdField",void 0),u([d({json:{read:!1}})],Se.prototype,"type",void 0),u([d({type:String})],Se.prototype,"typeIdField",void 0),u([Ce("service","typeIdField"),Ce("typeIdField",["layerDefinition.typeIdField"])],Se.prototype,"readTypeIdField",null),u([d({type:[Lie]})],Se.prototype,"types",void 0),u([Ce("service","types",["types"]),Ce("types",["layerDefinition.types"])],Se.prototype,"readTypes",null),u([d({readOnly:!0,json:{write:!1}})],Se.prototype,"serverGens",void 0),u([d({type:We.ofType(cd),readOnly:!0})],Se.prototype,"indexes",void 0),u([d(bie)],Se.prototype,"url",null),u([Ee("url")],Se.prototype,"writeUrl",null),u([d({readOnly:!0})],Se.prototype,"userIsAdmin",void 0),u([d({json:{origins:{service:{read:!0}},read:!1}})],Se.prototype,"version",void 0),u([Ce("service","version",["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"])],Se.prototype,"readVersion",null),u([d({type:Boolean,json:{origins:{"portal-item":{write:{target:"layerDefinition.defaultVisibility"}}}}})],Se.prototype,"visible",void 0),u([Ce("portal-item","visible",["visibility","layerDefinition.defaultVisibility"])],Se.prototype,"readVisible",null),Se=u([R("esri.layers.FeatureLayer")],Se);const E9=Gv({types:wZ}),Wie=Se;var tat=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Wie});const ODe=["$datastore","$map","$layer","$aggregatedfeatures"],RDe="esri.widgets.Feature.support.arcadeFeatureUtils",IDe=le.getLogger(RDe);function DDe(t){return typeof t=="string"?M2(yk(t)):Array.isArray(t)?FDe(t):(t==null?void 0:t.declaredClass)==="esri.arcade.Dictionary"?LDe(t):t}function FDe(t){return`<ul class="esri-widget__list">${t.map(e=>`<li>${typeof e=="string"?M2(yk(e)):e}</li>`).join("")}</ul>`}function LDe(t){return`<table class="esri-widget__table">${t.keys().map(e=>{const i=t.field(e);return`<tr><th>${e}</th><td>${typeof i=="string"?M2(yk(i)):i}</td></tr>`}).join("")}</table>`}function kDe({aggregatedFeatures:t,arcadeUtils:e,featureSetVars:i,context:r,viewInfo:s,map:n,graphic:o,interceptor:a}){i.forEach(l=>{const c=l.toLowerCase(),h={map:n,spatialReference:s.sr,interceptor:a};if(c==="$map"&&(r.vars[c]=e.convertMapToFeatureSetCollection(h)),c==="$layer"&&(r.vars[c]=e.convertFeatureLayerToFeatureSet({layer:o.sourceLayer,spatialReference:s.sr,interceptor:a})),c==="$datastore"&&(r.vars[c]=e.convertServiceUrlToWorkspace({url:o.sourceLayer.url,spatialReference:s.sr,interceptor:a})),c==="$aggregatedfeatures"){const p=o.layer,{fields:f,objectIdField:g,geometryType:y,spatialReference:v,displayField:b}=p,w=new Wie(he(E({fields:f,objectIdField:g,geometryType:y,spatialReference:v,displayField:b},p.type==="feature"?{templates:p.templates,typeIdField:p.typeIdField,types:p.types}:null),{source:t}));r.vars[c]=e.convertFeatureLayerToFeatureSet({layer:w,spatialReference:s.sr,interceptor:a})}})}function Zie(){return import("./arcadeUtils.af7f668d.js").then(function(t){return t.Q})}async function zDe({graphic:t,view:e}){const{isAggregate:i,layer:r}=t;if(!i||!r||(e==null?void 0:e.type)!=="2d")return[];const s=await e.whenLayerView(r);if(!s.createQuery||!s.queryFeatures)return[];const n=s.createQuery();n.aggregateIds=[t.getObjectId()];const{features:o}=await s.queryFeatures(n);return o}async function Jie({expressionInfo:t,arcadeUtils:e,interceptor:i,spatialReference:r,map:s,graphic:n,view:o}){if(!t||!t.expression)return null;const a=e.createSyntaxTree(t.expression),l=ODe.filter(g=>e.hasVariable(a,g)),[c]=await mD([zDe({graphic:n,view:o}),e.loadScriptDependencies(a,!0,l)]),h=e.getViewInfo({spatialReference:r}),p=e.createExecContext(n,h);p.interceptor=i,p.useAsync=!0,kDe({aggregatedFeatures:c,arcadeUtils:e,featureSetVars:l,context:p,viewInfo:h,map:s,graphic:n,interceptor:i});const f=e.createFunction(a,p);return e.executeAsyncFunction(f,p).catch(g=>IDe.error("arcade-execution-error",{error:g,graphic:n,expressionInfo:t}))}async function VDe({expressionInfos:t,spatialReference:e,graphic:i,interceptor:r,map:s,view:n}){if(!t||!t.length)return{};const o=await Zie(),a={};for(const h of t)a[`expression/${h.name}`]=Jie({expressionInfo:h,arcadeUtils:o,interceptor:r,spatialReference:e,map:s,graphic:i,view:n});const l=await En(a),c={};for(const h in l)c[h]=DDe(l[h].value);return c}const NDe=1;let ca=class extends tu(ve){constructor(t){super(t),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:e}=this;e&&e.abort(),this._abortController=null},this._createVM=()=>{var e,i;const r=(e=this.contentElement)==null?void 0:e.type;(i=this.contentElementViewModel)==null||i.destroy();const s=r==="fields"?new LA:r==="media"?new Ey:r==="text"?new IA:null;this._set("contentElementViewModel",s)},this._compile=async()=>{this._cancelQuery();const e=new AbortController;this._abortController=e,await this._compileExpression(),this._abortController===e&&(this._abortController=null)},this._compileThrottled=rk(this._compile,NDe,this),this._compileExpression=async()=>{const{expressionInfo:e,graphic:i,interceptor:r,spatialReference:s,map:n,view:o,_abortController:a}=this;if(!(e&&i&&s&&n&&o))return void this._set("contentElement",null);const l=await Zie();if(a!==this._abortController)return;const c=await Jie({arcadeUtils:l,expressionInfo:e,graphic:i,interceptor:r,map:n,spatialReference:s,view:o});if(!c||c.declaredClass!=="esri.arcade.Dictionary")return void this._set("contentElement",null);const h=await kz(c,a.signal),p=h==null?void 0:h.type,f=p==="media"?Lx.fromJSON(h):p==="text"?u1.fromJSON(h):p==="fields"?l1.fromJSON(h):null;this._set("contentElement",f)},this.handles.add([Ke(this,["expressionInfo","graphic","map","spatialReference","view"],this._compileThrottled),Ke(this,"contentElement",this._createVM)])}destroy(){var t;this._cancelQuery(),(t=this.contentElementViewModel)==null||t.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){var t;return((t=this.view)==null?void 0:t.spatialReference)||null}set spatialReference(t){t!==void 0?this._override("spatialReference",t):this._clearOverride("spatialReference")}get state(){const{_abortController:t,contentElement:e,contentElementViewModel:i}=this;return t?"loading":e||i?"ready":"disabled"}get map(){var t;return((t=this.view)==null?void 0:t.map)||null}set map(t){t!==void 0?this._override("map",t):this._clearOverride("map")}};u([d()],ca.prototype,"_abortController",void 0),u([d({type:_W})],ca.prototype,"expressionInfo",void 0),u([d({type:pn})],ca.prototype,"graphic",void 0),u([d({readOnly:!0})],ca.prototype,"contentElement",void 0),u([d({readOnly:!0})],ca.prototype,"contentElementViewModel",void 0),u([d()],ca.prototype,"interceptor",void 0),u([d()],ca.prototype,"spatialReference",null),u([d({readOnly:!0})],ca.prototype,"state",null),u([d()],ca.prototype,"map",null),u([d()],ca.prototype,"view",void 0),ca=u([R("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],ca);const O9=ca,eE={iconLoading:"esri-icon-loading-indicator esri-rotating",base:"esri-feature-expression",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"};let tE=class extends Bs{constructor(t,e){super(t,e),this.viewModel=new O9}initialize(){Ke(this,"viewModel.contentElementViewModel",()=>this._setupExpressionWidget())}destroy(){var t;(t=this._contentWidget)==null||t.destroy(),this._contentWidget=null}renderLoading(){return ee("div",{key:"loading-container",class:eE.loadingSpinnerContainer},ee("span",{class:this.classes(eE.iconLoading,eE.spinner)}))}render(){var t;const{state:e}=this.viewModel;return ee("div",{class:eE.base},e==="loading"?this.renderLoading():e==="disabled"?null:(t=this._contentWidget)==null?void 0:t.render())}_setupExpressionWidget(){var t;const{contentElementViewModel:e,contentElement:i}=this.viewModel,r=i==null?void 0:i.type;(t=this._contentWidget)==null||t.destroy(),this._contentWidget=null;const s=e?r==="fields"?new TX({viewModel:e}):r==="media"?new FK({viewModel:e}):r==="text"?new FA({viewModel:e}):null:null;this._contentWidget=s,this.scheduleRender()}};u([d({type:O9})],tE.prototype,"viewModel",void 0),tE=u([R("esri.widgets.Feature.FeatureExpression")],tE);const UDe=tE;class jDe{constructor(e,i){this.preLayerQueryCallback=e,this.preRequestCallback=i,this.preLayerQueryCallback||(this.preLayerQueryCallback=r=>{}),this.preRequestCallback||(this.preLayerQueryCallback=r=>{})}}var iE;const BDe=1,Qie="content-view-models",Yie="esri.widgets.FeatureViewModel",GDe=le.getLogger(Yie),Xie={attachmentsContent:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0};let Ki=iE=class extends ve{constructor(t){super(t),this._handles=new dt,this._error=null,this._featureAbortController=null,this.graphicChangedThrottled=rk(this.graphicChanged,BDe,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities=E({},Xie),this.content=null,this.contentViewModels=[],this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=e=>{const{abilities:i}=this;return e.type==="attachments"&&i.attachmentsContent||e.type==="custom"&&i.customContent||e.type==="fields"&&i.fieldsContent||e.type==="media"&&i.mediaContent||e.type==="text"&&i.textContent||e.type==="expression"&&i.expressionContent},this._handles.add(Ke(this,["graphic","_effectivePopupTemplate","abilities"],()=>this.graphicChangedThrottled()))}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return _(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return GMe(mX(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return lX(this.graphic)}castAbilities(t){return E(E({},Xie),t)}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(t){this._set("graphic",t?t.clone():null)}get spatialReference(){return this.get("view.spatialReference")||null}set spatialReference(t){t!==void 0?this._override("spatialReference",t):this._clearOverride("spatialReference")}get map(){return this.get("view.map")||null}set map(t){t!==void 0?this._override("map",t):this._clearOverride("map")}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(t,e){const i=this.contentViewModels[t];i instanceof Ey&&i.setActiveMedia(e)}nextMedia(t){const e=this.contentViewModels[t];e instanceof Ey&&e.next()}previousMedia(t){const e=this.contentViewModels[t];e instanceof Ey&&e.previous()}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:t}=this;if(!t)return;const e=new AbortController;this._featureAbortController=e;try{await this._queryFeature({signal:e.signal})}catch(i){bi(i)||(this._error=i,GDe.error("error","The popupTemplate could not be displayed for this feature.",{error:i,graphic:t,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===e&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:t}=this;t&&t.abort(),this._featureAbortController=null}_compileContentElement(t,e){return t.type==="attachments"?this._compileAttachments(t,e):t.type==="custom"?this._compileCustom(t,e):t.type==="fields"?this._compileFields(t,e):t.type==="media"?this._compileMedia(t,e):t.type==="text"?this._compileText(t,e):t.type==="expression"?this._compileExpression(t,e):void 0}_compileContent(t){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(t)?t.filter(this._isAllowedContentType).map((e,i)=>this._compileContentElement(e,i)):typeof t=="string"?this._compileText(new u1({text:t}),0).text:t}_destroyContentViewModels(){var t;(t=this._handles)==null||t.remove(Qie),this.contentViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("contentViewModels",[])}_setExpressionContentVM(t,e){const{formattedAttributes:i}=this,{contentElement:r,contentElementViewModel:s}=t,n=r==null?void 0:r.type;s&&n&&(n==="fields"&&(this._createFieldsFormattedAttributes({contentElement:r,contentElementIndex:e,formattedAttributes:i}),s.set(this._createFieldsVMParams(r,e))),n==="media"&&(this._createMediaFormattedAttributes({contentElement:r,contentElementIndex:e,formattedAttributes:i}),s.set(this._createMediaVMParams(r,e))),n==="text"&&s.set(this._createTextVMParams(r)))}_compileExpression(t,e){const{expressionInfo:i}=t,{graphic:r,map:s,spatialReference:n,view:o}=this,a=new O9({expressionInfo:i,graphic:r,interceptor:iE.interceptor,map:s,spatialReference:n,view:o});return this.contentViewModels[e]=a,this._handles.add(Ke(a,"contentElementViewModel",()=>this._setExpressionContentVM(a,e)),Qie),t}_compileAttachments(t,e){const{graphic:i}=this,{description:r,title:s}=t;return this.contentViewModels[e]=new wk(E({graphic:i},this._compileTitleAndDesc({title:s,description:r}))),t}_compileCustom(t,e){const{graphic:i}=this,{creator:r,destroyer:s}=t;return this.contentViewModels[e]=new IA({graphic:i,creator:r,destroyer:s}),t}_compileTitleAndDesc({title:t,description:e}){const{_fieldInfoMap:i,_sourceLayer:r,graphic:s,formattedAttributes:n,_expressionAttributes:o}=this,{attributes:a}=s,l=n.global;return{title:Sy({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:r,text:t}),description:Sy({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:r,text:e})}}_createFieldsVMParams(t,e){const{_effectivePopupTemplate:i,formattedAttributes:r}=this,s=E(E({},r.global),r.content[e]),n=(t==null?void 0:t.fieldInfos)||(i==null?void 0:i.fieldInfos),o=n==null?void 0:n.filter(({fieldName:h})=>uX(h)||Kh(h)||s.hasOwnProperty(h)),a=i==null?void 0:i.expressionInfos,{description:l,title:c}=t;return E({attributes:s,expressionInfos:a,fieldInfos:o},this._compileTitleAndDesc({title:c,description:l}))}_compileFields(t,e){const i=t.clone(),r=new LA(this._createFieldsVMParams(t,e));return this.contentViewModels[e]=r,i.fieldInfos=r.formattedFieldInfos.slice(0),i}_createMediaVMParams(t,e){const{graphic:i,_fieldInfoMap:r,formattedAttributes:s,_effectivePopupTemplate:n,relatedInfos:o,_sourceLayer:a,_expressionAttributes:l}=this,{attributes:c}=i,{description:h,mediaInfos:p,title:f}=t;return E({activeMediaInfoIndex:t.activeMediaInfoIndex||0,attributes:c,layer:a,fieldInfoMap:r,formattedAttributes:E(E({},s.global),s.content[e]),expressionAttributes:l,mediaInfos:p,popupTemplate:n,relatedInfos:o},this._compileTitleAndDesc({title:f,description:h}))}_compileMedia(t,e){const i=t.clone(),r=new Ey(this._createMediaVMParams(t,e));return i.mediaInfos=r.formattedMediaInfos.slice(0),this.contentViewModels[e]=r,i}_createTextVMParams(t){const{graphic:e,_fieldInfoMap:i,_sourceLayer:r,_expressionAttributes:s}=this;if(t&&t.text){const{attributes:n}=e,o=this.formattedAttributes.global;t.text=Sy({attributes:n,fieldInfoMap:i,globalAttributes:o,expressionAttributes:s,layer:r,text:t.text})}return{graphic:e,creator:t.text}}_compileText(t,e){const i=t.clone();return this.contentViewModels[e]=new IA(this._createTextVMParams(i)),i}_compileLastEditInfo(){const{_effectivePopupTemplate:t,_sourceLayer:e,graphic:i}=this;if(!t)return;const{lastEditInfoEnabled:r}=t,s=e==null?void 0:e.editFieldsInfo;return r&&s?BMe(s,i.attributes):void 0}_compileTitle(t){const{_fieldInfoMap:e,_sourceLayer:i,graphic:r,_expressionAttributes:s}=this,{attributes:n}=r,o=this.formattedAttributes.global;return Sy({attributes:n,fieldInfoMap:e,globalAttributes:o,expressionAttributes:s,layer:i,text:t})}async _getTitle(){const{_effectivePopupTemplate:t,graphic:e}=this,i=t==null?void 0:t.title;return OA(i,{graphic:e})}async _getContent(){const{_effectivePopupTemplate:t,graphic:e}=this,i=t==null?void 0:t.content;return OA(i,{graphic:e})}async _queryFeature(t){const{_featureAbortController:e,_sourceLayer:i,graphic:r,_effectivePopupTemplate:s,spatialReference:n,map:o,view:a}=this,{content:{value:l},title:{value:c}}=await En({content:this._getContent(),title:this._getTitle()});if(e!==this._featureAbortController||!r)return;await ZMe({graphic:r,popupTemplate:s,layer:i,spatialReference:n},t);const{expressionAttributes:{value:h}}=await En({checkForRelatedFeatures:this._checkForRelatedFeatures(t),expressionAttributes:VDe({expressionInfos:s==null?void 0:s.expressionInfos,spatialReference:n,graphic:r,map:o,interceptor:iE.interceptor,view:a})});e===this._featureAbortController&&r&&(this._expressionAttributes=h,this._graphicExpressionAttributes=E(E({},r.attributes),h),this._set("formattedAttributes",this._createFormattedAttributes(l)),this._set("title",this._compileTitle(c)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(l)||null))}_createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:i}){const{_effectivePopupTemplate:r,graphic:s,relatedInfos:n,_sourceLayer:o,_fieldInfoMap:a,_graphicExpressionAttributes:l}=this;i.content[e]=vk({fieldInfos:r==null?void 0:r.fieldInfos,graphic:s,attributes:E(E({},l),t.attributes),layer:o,fieldInfoMap:a,relatedInfos:n})}_createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:i}){if(t.fieldInfos){const{graphic:r,relatedInfos:s,_sourceLayer:n,_fieldInfoMap:o,_graphicExpressionAttributes:a}=this;i.content[e]=vk({fieldInfos:t.fieldInfos,graphic:r,attributes:E(E({},a),t.attributes),layer:n,fieldInfoMap:o,relatedInfos:s})}}_createFormattedAttributes(t){const{_effectivePopupTemplate:e,graphic:i,relatedInfos:r,_sourceLayer:s,_fieldInfoMap:n,_graphicExpressionAttributes:o}=this,a=e==null?void 0:e.fieldInfos,l={global:vk({fieldInfos:a,graphic:i,attributes:o,layer:s,fieldInfoMap:n,relatedInfos:r}),content:[]};return Array.isArray(t)&&t.forEach((c,h)=>{c.type==="fields"&&this._createFieldsFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l}),c.type==="media"&&this._createMediaFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l})}),l}_checkForRelatedFeatures(t){const{graphic:e,_effectivePopupTemplate:i}=this;return this._queryRelatedInfos(e,mX(i),t)}async _queryRelatedInfos(t,e,i){const{relatedInfos:r,_sourceLayer:s}=this;r.clear();const n=_(s.associatedLayer)?await s.associatedLayer.load(i):s;if(!n)return;const o=e.filter(c=>c&&Kh(c.fieldName));if(!o||!o.length)return;e.forEach(c=>this._configureRelatedInfo(c,n));const a=await p$e({relatedInfos:r,layer:n},i);Object.keys(a).forEach(c=>{var h;const p=r.get(c.toString()),f=(h=a[c])==null?void 0:h.value;p&&f&&(p.layerInfo=f.data)});const l=await f$e({graphic:t,relatedInfos:r,layer:n},i);Object.keys(l).forEach(c=>{var h;l$e((h=l[c])==null?void 0:h.value,r.get(c.toString()))})}_configureRelatedInfo(t,e){const{relatedInfos:i}=this,r=z2(t.fieldName);if(!r)return;const{layerId:s,fieldName:n}=r;if(!s)return;const o=i.get(s.toString())||a$e(s,e);o&&(m$e({relatedInfo:o,fieldName:n,fieldInfo:t}),this.relatedInfos.set(s,o))}};Ki.interceptor=new jDe(YMe,XMe),u([d()],Ki.prototype,"_error",void 0),u([d()],Ki.prototype,"_featureAbortController",void 0),u([d({readOnly:!0})],Ki.prototype,"_effectivePopupTemplate",null),u([d({readOnly:!0})],Ki.prototype,"_fieldInfoMap",null),u([d({readOnly:!0})],Ki.prototype,"_sourceLayer",null),u([d()],Ki.prototype,"abilities",void 0),u([ut("abilities")],Ki.prototype,"castAbilities",null),u([d({readOnly:!0})],Ki.prototype,"content",void 0),u([d({readOnly:!0})],Ki.prototype,"contentViewModels",void 0),u([d({type:Boolean})],Ki.prototype,"defaultPopupTemplateEnabled",void 0),u([d({readOnly:!0})],Ki.prototype,"state",null),u([d({readOnly:!0})],Ki.prototype,"formattedAttributes",void 0),u([d({type:pn,value:null})],Ki.prototype,"graphic",null),u([d({readOnly:!0})],Ki.prototype,"lastEditInfo",void 0),u([d({readOnly:!0})],Ki.prototype,"relatedInfos",void 0),u([d()],Ki.prototype,"spatialReference",null),u([d({readOnly:!0})],Ki.prototype,"title",void 0),u([d()],Ki.prototype,"map",null),u([d({readOnly:!0})],Ki.prototype,"waitingForContent",null),u([d()],Ki.prototype,"view",void 0),Ki=iE=u([R(Yie)],Ki);const R9=Ki,Kie=t=>{let e=class extends t{constructor(){super(...arguments),this.renderNodeContent=i=>DA(i)&&!i.destroyed?ee("div",{key:i},i.render()):i instanceof HTMLElement?ee("div",{key:i,bind:i,afterCreate:this._attachToNode}):SX(i)?ee("div",{key:i,bind:i.domNode,afterCreate:this._attachToNode}):null}_attachToNode(i){const r=this;i.appendChild(r)}};return e=u([R("esri.widgets.Feature.ContentMixin")],e),e},Js={iconText:"esri-icon-font-fallback-text",iconLoading:"esri-icon-loading-indicator esri-rotating",esriTable:"esri-widget__table",esriWidget:"esri-widget",base:"esri-feature",container:"esri-feature__size-container",title:"esri-feature__title",main:"esri-feature__main-container",btn:"esri-feature__button",icon:"esri-feature__icon",content:"esri-feature__content",contentElement:"esri-feature__content-element",text:"esri-feature__text",lastEditedInfo:"esri-feature__last-edited-info",fields:"esri-feature__fields",fieldHeader:"esri-feature__field-header",fieldData:"esri-feature__field-data",fieldDataDate:"esri-feature__field-data--date",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"},ere={title:!0,content:!0,lastEditedInfo:!0};let Qs=class extends Kie(Bs){constructor(t,e){super(t,e),this._contentWidgets=[],this.graphic=null,this.defaultPopupTemplateEnabled=!1,this.headingLevel=2,this.label=void 0,this.messages=null,this.messagesCommon=null,this.messagesURIUtils=null,this.spatialReference=null,this.title=null,this.visibleElements=E({},ere),this.map=null,this.view=null,this.viewModel=new R9}initialize(){this.own(Ke(this,"viewModel.contentViewModels",()=>this._setupContentWidgets()))}loadDependencies(){return import("./calcite-notice.b9659e5b.js")}destroy(){this._destroyContentWidgets()}castVisibleElements(t){return E(E({},ere),t)}render(){const{state:t}=this.viewModel,e=ee("div",{class:Js.container,key:"container"},this.renderTitle(),t==="error"?this.renderError():t==="loading"?this.renderLoading():this.renderContentContainer());return ee("div",{class:this.classes(Js.base,Js.esriWidget)},e)}setActiveMedia(t,e){this.viewModel.setActiveMedia(t,e)}nextMedia(t){this.viewModel.nextMedia(t)}previousMedia(t){this.viewModel.previousMedia(t)}renderError(){const{messagesCommon:t,messages:e,visibleElements:i}=this;return ee("calcite-notice",{active:!0,color:"red",icon:"exclamation-mark-circle",scale:"s"},i.title?ee("div",{key:"error-title",slot:"title"},t.errorMessage):null,ee("div",{key:"error-message",slot:"message"},e.loadingError))}renderLoading(){return ee("div",{key:"loading-container",class:Js.loadingSpinnerContainer},ee("span",{class:this.classes(Js.iconLoading,Js.spinner)}))}renderContentContainer(){const{visibleElements:t}=this;return t.content?ee("div",{class:Js.main},[this.renderContent(),this.renderLastEditInfo()]):null}renderTitle(){const{visibleElements:t,title:e}=this;return t.title?ee(xk,{level:this.headingLevel,class:Js.title,innerHTML:e}):null}renderContent(){const t=this.viewModel.content,e="content";if(!t)return null;if(Array.isArray(t))return t.length?ee("div",{key:`${e}-content-elements`},t.map(this.renderContentElement,this)):null;if(typeof t=="string"){const i=this._contentWidgets[0];return!i||i.destroyed?null:ee("div",{key:`${e}-content`},i.render())}return this.renderNodeContent(t)}renderContentElement(t,e){const{visibleElements:i}=this;if(typeof i.content!="boolean"&&!i.content[t.type])return null;switch(t.type){case"attachments":return this.renderAttachments(e);case"custom":return this.renderCustom(t,e);case"fields":return this.renderFields(e);case"media":return this.renderMedia(e);case"text":return this.renderText(t,e);case"expression":return this.renderExpression(e);default:return null}}renderAttachments(t){const e=this._contentWidgets[t];if(!e||e.destroyed)return null;const{state:i,attachmentInfos:r}=e.viewModel;return i==="loading"||r.length>0?ee("div",{key:this._buildKey("attachments-element",t),class:this.classes(Js.contentElement)},e.render()):null}renderExpression(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:ee("div",{key:this._buildKey("expression-element",t),class:Js.contentElement},e.render())}renderCustom(t,e){const{creator:i}=t,r=this._contentWidgets[e];return!r||r.destroyed?null:i?ee("div",{key:this._buildKey("custom-element",e),class:Js.contentElement},r.render()):null}renderFields(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:ee("div",{key:this._buildKey("fields-element",t),class:Js.contentElement},e.render())}renderMedia(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:ee("div",{key:this._buildKey("media-element",t),class:Js.contentElement},e.render())}renderLastEditInfo(){const{visibleElements:t,messages:e}=this,{lastEditInfo:i}=this.viewModel;if(!i||!t.lastEditedInfo)return null;const{date:r,user:s}=i,n=i.type==="edit"?s?e.lastEditedByUser:e.lastEdited:s?e.lastCreatedByUser:e.lastCreated,o=yu(n,{date:r,user:s});return ee("div",{key:"edit-info-element",class:this.classes(Js.lastEditedInfo,Js.contentElement)},o)}renderText(t,e){const i=t.text,r=this._contentWidgets[e];return!r||r.destroyed?null:i?ee("div",{key:this._buildKey("text-element",e),class:this.classes(Js.contentElement,Js.text)},r.render()):null}_buildKey(t,...e){return`${t}__${this.get("viewModel.graphic.uid")||"0"}-${e.join("-")}`}_destroyContentWidget(t){t&&(t.viewModel=null,!t.destroyed&&t.destroy())}_destroyContentWidgets(){this._contentWidgets.forEach(t=>this._destroyContentWidget(t)),this._contentWidgets=[]}_setupContentWidgets(){this._destroyContentWidgets();const{headingLevel:t,visibleElements:e}=this,i=this.get("viewModel.content"),{contentViewModels:r}=this.viewModel;if(Array.isArray(i))i.forEach((s,n)=>{s.type==="attachments"&&(this._contentWidgets[n]=new aPe({displayType:s.displayType,headingLevel:e.title?t+1:t,viewModel:r[n]})),s.type==="fields"&&(this._contentWidgets[n]=new TX({viewModel:r[n]})),s.type==="media"&&(this._contentWidgets[n]=new FK({viewModel:r[n]})),s.type==="text"&&(this._contentWidgets[n]=new FA({viewModel:r[n]})),s.type==="custom"&&(this._contentWidgets[n]=new FA({viewModel:r[n]})),s.type==="expression"&&(this._contentWidgets[n]=new UDe({viewModel:r[n]}))},this);else{const s=r[0];s&&!s.destroyed&&(this._contentWidgets[0]=new FA({viewModel:s}))}this.scheduleRender()}};u([Ve("viewModel.graphic")],Qs.prototype,"graphic",void 0),u([Ve("viewModel.defaultPopupTemplateEnabled")],Qs.prototype,"defaultPopupTemplateEnabled",void 0),u([d()],Qs.prototype,"headingLevel",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Qs.prototype,"label",void 0),u([d(),qs("esri/widgets/Feature/t9n/Feature")],Qs.prototype,"messages",void 0),u([d(),qs("esri/t9n/common")],Qs.prototype,"messagesCommon",void 0),u([d(),qs("esri/widgets/support/t9n/uriUtils")],Qs.prototype,"messagesURIUtils",void 0),u([Ve("viewModel.spatialReference")],Qs.prototype,"spatialReference",void 0),u([Ve("viewModel.title")],Qs.prototype,"title",void 0),u([d()],Qs.prototype,"visibleElements",void 0),u([ut("visibleElements")],Qs.prototype,"castVisibleElements",null),u([Ve("viewModel.map")],Qs.prototype,"map",void 0),u([Ve("viewModel.view")],Qs.prototype,"view",void 0),u([d({type:R9})],Qs.prototype,"viewModel",void 0),Qs=u([R("esri.widgets.Feature")],Qs);const qDe=Qs;let Ky=class extends Ci.EventedAccessor{constructor(t){super(t),this._anchorHandles=new dt,this.location=null,this.screenLocation=null,this.screenLocationEnabled=!1,this.view=null,this._anchorHandles.add([gi(this,["screenLocationEnabled","location","view.size","view.stationary"],()=>this._updateScreenPointAndHandle()),gi(this,["view","view.ready"],()=>this._wireUpView())])}destroy(){this.view=null,this._anchorHandles&&this._anchorHandles.destroy(),this._anchorHandles=null,this._viewpointHandle=null}_wireUpView(){const t="view";if(this._anchorHandles.remove(t),this._viewpointHandle=null,!this.get("view.ready"))return;this._setScreenLocation();const{view:e}=this,i=e.type==="3d"?"camera":"viewpoint",r=$H(e,i,()=>this._viewpointChange());this._anchorHandles.add(r,t),this._viewpointHandle=r,this._toggleWatchingViewpoint()}_viewpointChange(){this._setScreenLocation(),this.emit("view-change")}_updateScreenPointAndHandle(){this._setScreenLocation(),this._toggleWatchingViewpoint()}_toggleWatchingViewpoint(){const{_viewpointHandle:t,location:e,screenLocationEnabled:i}=this;!t||(e&&i?t.resume():t.pause())}_setScreenLocation(){const{location:t,view:e,screenLocationEnabled:i}=this,r=this.get("view.ready"),s=i&&r&&_(t)?e.toScreen(t):null;this._set("screenLocation",s)}};u([d()],Ky.prototype,"location",void 0),u([d({readOnly:!0})],Ky.prototype,"screenLocation",void 0),u([d()],Ky.prototype,"screenLocationEnabled",void 0),u([d()],Ky.prototype,"view",void 0),Ky=u([R("esri.widgets.support.AnchorElementViewModel")],Ky);const tre=Ky,HDe="esri.widgets.CompassViewModel";let rE=class extends tre{constructor(t){super(t),this.visible=!1}};u([d()],rE.prototype,"visible",void 0),rE=u([R(HDe)],rE);const ire=rE,I9={base:"esri-spinner",spinnerStart:"esri-spinner--start",spinnerFinish:"esri-spinner--finish"};let e0=class extends Bs{constructor(t,e){super(t,e),this._animationDelay=500,this._animationPromise=null,this.location=null,this.view=null,this.viewModel=new ire,this.visible=!1}initialize(){this.own([gi(this,"visible",t=>this._visibleChange(t))])}destroy(){this._animationPromise=null}show(t){const{location:e,promise:i}=t;e&&(this.viewModel.location=e),this.visible=!0;const r=()=>this.hide();i&&i.catch(()=>{}).then(r)}hide(){this.visible=!1}render(){const{visible:t}=this,{screenLocation:e}=this.viewModel,i=!!e,r=t&&i,s=!t&&i,n={[I9.spinnerStart]:r,[I9.spinnerFinish]:s},o=this._getPositionStyles();return ee("div",{class:this.classes(I9.base,n),styles:o})}_visibleChange(t){if(t)return void(this.viewModel.screenLocationEnabled=!0);const e=Zw(this._animationDelay);this._animationPromise=e,e.catch(()=>{}).then(()=>{this._animationPromise===e&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)})}_getPositionStyles(){const{screenLocation:t,view:e}=this.viewModel;if(!e||A(t))return{};const{padding:i}=e;return{left:t.x-i.left+"px",top:t.y-i.top+"px"}}};u([Ve("viewModel.location")],e0.prototype,"location",void 0),u([Ve("viewModel.view")],e0.prototype,"view",void 0),u([d({type:ire})],e0.prototype,"viewModel",void 0),u([Ve("viewModel.visible")],e0.prototype,"visible",void 0),e0=u([R("esri.widgets.Spinner")],e0);const WDe=e0;class ZDe{constructor(e,i){this._storage=new u8,this._storage.maxSize=e,i&&this._storage.registerRemoveFunc("",i)}put(e,i){this._storage.put(e,i,1,1)}pop(e){return this._storage.pop(e)}get(e){return this._storage.get(e)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}}function JDe(t){return typeof t=="function"}function iat(t,e,i,r){return JDe(t)?t(e,i,r):t}function rat(t){return[t.r,t.g,t.b,t.a]}function sat(t,e,i){const r=` /-,
`,s=l=>{let c=l.length;for(;c--;)if(r.indexOf(l.charAt(c))===-1)return!1;return!0},n=[];let o=0,a=-1;do if(a=e.indexOf("[",o),a>=o){if(a>o){const l=e.substr(o,a-o);n.push([l,null,s(l)])}if(o=a+1,a=e.indexOf("]",o),a>=o){if(a>o){const l=t[e.substr(o,a-o)];l&&n.push([null,l,!1])}o=a+1}}while(a!==-1);if(o<e.length-1){const l=e.substr(o);n.push([l,null,s(l)])}return l=>{let c="",h=null;for(const p of n){const[f,g,y]=p;if(f)y?h=f:(h&&(c+=h,h=null),c+=f);else{const v=l.attributes[g];v&&(h&&(c+=h,h=null),c+=v)}}return QDe(c,i)}}function QDe(t,e){switch(typeof t!="string"&&(t=String(t)),e){case"LowerCase":return t.toLowerCase();case"Allcaps":return t.toUpperCase();default:return t}}function nat(t,e,i,r,s,n,o=!0){const a=e/s,l=i/n,c=Math.ceil(a/2),h=Math.ceil(l/2);for(let p=0;p<n;p++)for(let f=0;f<s;f++){const g=4*(f+(o?n-p-1:p)*s);let y=0,v=0,b=0,w=0,S=0,T=0,C=0;const M=(p+.5)*l;for(let P=Math.floor(p*l);P<(p+1)*l;P++){const F=Math.abs(M-(P+.5))/h,z=(f+.5)*a,D=F*F;for(let U=Math.floor(f*a);U<(f+1)*a;U++){let G=Math.abs(z-(U+.5))/c;const k=Math.sqrt(D+G*G);k>=-1&&k<=1&&(y=2*k*k*k-3*k*k+1,y>0&&(G=4*(U+P*e),C+=y*t[G+3],b+=y,t[G+3]<255&&(y=y*t[G+3]/250),w+=y*t[G],S+=y*t[G+1],T+=y*t[G+2],v+=y))}}r[g]=w/v,r[g+1]=S/v,r[g+2]=T/v,r[g+3]=C/b}}function oat(t){return t?{r:t[0],g:t[1],b:t[2],a:t[3]/255}:{r:0,g:0,b:0,a:0}}function YDe(t){return t.type==="CIMMarkerPlacementAlongLineRandomSize"||t.type==="CIMMarkerPlacementAlongLineSameSize"||t.type==="CIMMarkerPlacementAlongLineVariableSize"||t.type==="CIMMarkerPlacementAtExtremities"||t.type==="CIMMarkerPlacementAtMeasuredUnits"||t.type==="CIMMarkerPlacementAtRatioPositions"||t.type==="CIMMarkerPlacementOnLine"||t.type==="CIMMarkerPlacementOnVertices"}const aat=t=>t&&t.toLowerCase().replace(/\s+/g,"-"),lat=t=>isNaN(t)||!t?0:t;function rre(t,e,i,r){if(t.type!=="CIMTextSymbol"){if(i&&t.effects)for(const s of t.effects)eFe(s,e);if(t.symbolLayers)for(const s of t.symbolLayers)switch(s.type){case"CIMPictureMarker":case"CIMVectorMarker":XDe(s,e,r);break;case"CIMPictureStroke":case"CIMSolidStroke":r!=null&&r.preserveOutlineWidth||(s.width*=e);break;case"CIMPictureFill":s.height*=e,s.offsetX*=e,s.offsetY*=e;break;case"CIMHatchFill":rre(s.lineSymbol,e,!0,he(E({},r),{preserveOutlineWidth:!1})),s.offsetX*=e,s.offsetY*=e,s.separation*=e}}else t.height*=e}function XDe(t,e,i){if(t.markerPlacement&&KDe(t.markerPlacement,e),t.offsetX*=e,t.offsetY*=e,t.anchorPoint&&t.anchorPointUnits==="Absolute"&&(t.anchorPoint={x:t.anchorPoint.x*e,y:t.anchorPoint.y*e}),t.size*=e,t.type==="CIMVectorMarker"&&t.markerGraphics)for(const r of t.markerGraphics)t.scaleSymbolsProportionally||rre(r.symbol,e,!0,i)}function KDe(t,e){switch(YDe(t)&&(t.offset*=e),t.type){case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineSameSize":if(t.customEndingOffset*=e,t.offsetAlongLine*=e,t.placementTemplate&&t.placementTemplate.length){const i=t.placementTemplate.map(r=>r*e);t.placementTemplate=i}break;case"CIMMarkerPlacementAlongLineVariableSize":if(t.maxRandomOffset*=e,t.placementTemplate&&t.placementTemplate.length){const i=t.placementTemplate.map(r=>r*e);t.placementTemplate=i}break;case"CIMMarkerPlacementOnLine":t.startPointOffset*=e;break;case"CIMMarkerPlacementAtExtremities":t.offsetAlongLine*=e;break;case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementOnVertices":break;case"CIMMarkerPlacementAtRatioPositions":t.beginPosition*=e,t.endPosition*=e;break;case"CIMMarkerPlacementPolygonCenter":t.offsetX*=e,t.offsetY*=e;break;case"CIMMarkerPlacementInsidePolygon":t.offsetX*=e,t.offsetY*=e,t.stepX*=e,t.stepY*=e}}function eFe(t,e){switch(t.type){case"CIMGeometricEffectArrow":case"CIMGeometricEffectDonut":t.width*=e;break;case"CIMGeometricEffectBuffer":t.size*=e;break;case"CIMGeometricEffectCut":t.beginCut*=e,t.endCut*=e,t.middleCut*=e;break;case"CIMGeometricEffectDashes":if(t.customEndingOffset*=e,t.offsetAlongLine*=e,t.dashTemplate&&t.dashTemplate.length){const i=t.dashTemplate.map(r=>r*e);t.dashTemplate=i}break;case"CIMGeometricEffectExtension":case"CIMGeometricEffectJog":case"CIMGeometricEffectRadial":t.length*=e;break;case"CIMGeometricEffectMove":t.offsetX*=e,t.offsetY*=e;break;case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":t.offset*=e;break;case"CIMGeometricEffectRegularPolygon":t.radius*=e;break;case"CIMGeometricEffectTaperedPolygon":t.fromWidth*=e,t.length*=e,t.toWidth*=e;break;case"CIMGeometricEffectWave":t.amplitude*=e,t.period*=e}}new ZDe(1e3);new Ae([128,128,128]);const sre=/\/resource\/(.*?)\.svg$/,tFe=new Ae("white");function iFe(t,e){const i=e.resource.href;return!ae("esri-canvas-svg-support")&&t.styleOrigin&&sre.test(i)?i.replace(sre,"/resource/png/$1.png"):i}function sE(t,e){if(e==null)return t;const i=t.toRgba();return i[3]=i[3]*e,new Ae(i)}function rFe(t,e,i){const r=t.symbolLayers;if(!r)return;const s=n=>{const o=_(n)?n:null;return sE(e=e||o||i!=null&&tFe,i)};r.forEach(n=>{if(n.type!=="object"||n.resource.href==null||e)if(n.type==="water")n.color=s(n.color);else{const o=_(n.material)?n.material.color:null,a=s(o);A(n.material)?n.material=new m1({color:a}):n.material.color=a,i!=null&&"outline"in n&&_(n.outline)&&_(n.outline.color)&&(n.outline.color=sE(n.outline.color,i))}})}function sFe(t,e,i){(e=e||t.color)&&(t.color=sE(e,i)),i!=null&&"outline"in t&&t.outline&&t.outline.color&&(t.outline.color=sE(t.outline.color,i))}function D9(t,e,i){t&&(e||i!=null)&&(e&&(e=new Ae(e)),o2(t)?rFe(t,e,i):NL(t)&&sFe(t,e,i))}async function nFe(t,e){const i=t.symbolLayers;i&&await cM(i,async r=>oFe(r,e))}async function oFe(t,e){switch(t.type){case"extrude":lFe(t,e);break;case"icon":case"line":case"text":aFe(t,e);break;case"path":uFe(t,e);break;case"object":await cFe(t,e)}}function aFe(t,e){const i=nre(e);_(i)&&(t.size=i)}function nre(t){for(const e of t)if(typeof e=="number")return e;return null}function lFe(t,e){t.size=typeof e[2]=="number"?e[2]:0}async function cFe(t,e){const{resourceSize:i,symbolSize:r}=await hFe(t),s=ore(e,i,r);t.width=bS(e[0],r[0],i[0],s),t.depth=bS(e[1],r[1],i[1],s),t.height=bS(e[2],r[2],i[2],s)}function uFe(t,e){const i=ore(e,Kc,[t.width,void 0,t.height]);t.width=bS(e[0],t.width,1,i),t.height=bS(e[2],t.height,1,i)}function ore(t,e,i){for(let r=0;r<3;r++){const s=t[r];switch(s){case"symbol-value":return i[r]!=null?i[r]/e[r]:1;case"proportional":break;default:if(s&&e[r])return s/e[r]}}return 1}async function hFe(t){const e=await import("./symbolLayerUtils.11df19ec.js"),i=await e.computeObjectLayerResourceSize(t,10),{width:r,height:s,depth:n}=t,o=[r,n,s];let a=1;for(let l=0;l<3;l++)if(o[l]!=null){a=o[l]/i[l];break}for(let l=0;l<3;l++)o[l]==null&&(o[l]=i[l]*a);return{resourceSize:i,symbolSize:o}}function bS(t,e,i,r){switch(t){case"proportional":return i*r;case"symbol-value":return e!=null?e:i;default:return t}}function dFe(t,e){const i=nre(e);if(!A(i))switch(t.type){case"simple-marker":t.size=i;break;case"picture-marker":{const r=t.width/t.height;r>1?(t.width=i,t.height=i*r):(t.width=i*r,t.height=i);break}case"simple-line":t.width=i;break;case"text":t.font.size=i}}async function pFe(t,e){if(t&&e)return o2(t)?nFe(t,e):void(NL(t)&&dFe(t,e))}function fFe(t,e,i){if(t&&e!=null)if(o2(t)){const r=t.symbolLayers;r&&r.forEach(s=>{if(s&&s.type==="object")switch(i){case"tilt":s.tilt=e;break;case"roll":s.roll=e;break;default:s.heading=e}})}else NL(t)&&(t.type!=="simple-marker"&&t.type!=="picture-marker"&&t.type!=="text"||(t.angle=e))}function are(t){return t&&"opacity"in t?t.opacity*are(t.parent):1}async function mFe(t,e){var i,r;if(!t)return;const s=t.sourceLayer,n=(i=_(e)&&(r=e.useSourceLayer)!=null&&r?s:t.layer)!=null?i:s,o=are(n);if(_(t.symbol)&&(!_(e)||e.ignoreGraphicSymbol!==!0)){const S=t.symbol.type==="web-style"?await t.symbol.fetchSymbol(_(e)?e.abortOptions:null):t.symbol.clone();return D9(S,null,o),S}const a=_(e)&&e.renderer||n&&"renderer"in n&&n.renderer;let l=a&&"getSymbolAsync"in a?await a.getSymbolAsync(t,e):null;if(!l)return;if(l=l.type==="web-style"?await l.fetchSymbol(_(e)?e.abortOptions:null):l.clone(),!("visualVariables"in a)||!a.visualVariables||!a.visualVariables.length)return D9(l,null,o),l;if("arcadeRequiredForVisualVariables"in a&&a.arcadeRequiredForVisualVariables&&(A(e)||A(e.arcade))){const S=E({},at(e));S.arcade=await su(),e=S}const c=await Promise.resolve().then(function(){return ERe}),h=[],p=[],f=[],g=[];for(const S of a.visualVariables)switch(S.type){case"color":h.push(S);break;case"opacity":p.push(S);break;case"rotation":g.push(S);break;case"size":S.target||f.push(S)}const y=!!h.length&&h[h.length-1],v=y?c.getColor(y,t,e):null,b=!!p.length&&p[p.length-1];let w=b?c.getOpacity(b,t,e):null;if(o!=null&&(w=w!=null?w*o:o),D9(l,v,w),f.length){const S=c.getAllSizes(f,t,e);await pFe(l,S)}for(const S of g)fFe(l,c.getRotationAngle(S,t,e),S.axis);return l}class lre{constructor(e=i=>i.values().next().value){this._peeker=e,this._items=new Set}get length(){return this._items.size}clear(){this._items.clear()}last(){if(this._items.size===0)return;let e;for(e of this._items);return e}peek(){if(this._items.size!==0)return this._peeker(this._items)}push(e){this.contains(e)||this._items.add(e)}contains(e){return this._items.has(e)}pop(){if(this.length===0)return;const e=this.peek();return this._items.delete(Kr(e)),e}popLast(){if(this.length===0)return;const e=this.last();return this._items.delete(Kr(e)),e}remove(e){this._items.delete(e)}filter(e){return this._items.forEach(i=>{e(i)||this._items.delete(i)}),this}}const gFe=ae("mac")?"Meta":"Ctrl",nE={8:"Backspace",9:"Tab",13:"Enter",27:"Escape",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete"};for(let t=48;t<58;t++)nE[t]=String.fromCharCode(t);for(let t=1;t<25;t++)nE[111+t]=`F${t}`;for(let t=65;t<91;t++)nE[t]=[String.fromCharCode(t+32),String.fromCharCode(t)];function yFe(t){if(t.key!==void 0)return Fl(t);const e=nE[t.keyCode];return Array.isArray(e)?t.shiftKey?e[1]:e[0]:e}function vFe(t){switch(t){case"Ctrl":case"Alt":case"Shift":case"Meta":case"Primary":return!0}return!1}class _Fe{constructor(e,i=[]){this.eventType=e,this.keyModifiers=i}matches(e){if(e.type!==this.eventType)return!1;if(this.keyModifiers.length===0)return!0;const i=e.modifiers;for(const r of this.keyModifiers)if(!i.has(r))return!1;return!0}}const cre=le.getLogger("esri.views.input.InputHandler");class bs{constructor(e){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=e}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const e in this._incoming){const i=this._incoming[e];for(const r of i)this._incomingEventMatches.push(r.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map(e=>e.eventType)),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(e){this._manager?cre.error("This InputHandler has already been registered with an InputManager"):(e.setEventCallback(i=>this._handleEvent(i)),e.setUninstallCallback(()=>this._onUninstall()),this._manager=e)}onUninstall(){}registerIncoming(e,i,r){let s;typeof i=="function"?(r=i,s=[]):s=i||[];const n=typeof e=="string"?new _Fe(e,s):e,o=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},a=h=>{const p=this._incoming[h.match.eventType];if(p){const f=p.indexOf(h);p.splice(f,1),o(),this._manager&&this._manager.updateDependencies()}},l=new bFe(n,r,{onPause:a,onRemove:a,onResume:h=>{const p=this._incoming[h.match.eventType];p&&p.indexOf(h)===-1&&(p.push(h),o(),this._manager&&this._manager.updateDependencies())}});let c=this._incoming[n.eventType];return c||(c=[],this._incoming[n.eventType]=c),c.push(l),o(),this._manager&&this._manager.updateDependencies(),l}registerOutgoing(e){if(this._outgoing[e])throw Error("There is already a callback registered for this outgoing InputEvent: "+e);const i=new wFe(e,{onEmit:(r,s,n,o)=>{this._manager.emit(r.eventType,s,n,o)},onRemove:r=>{delete this._outgoing[r.eventType],this._manager.updateDependencies()}});return this._outgoing[e]=i,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),i}startCapturingPointer(e){this._manager.setPointerCapture(e,!0)}stopCapturingPointer(e){this._manager.setPointerCapture(e,!1)}refreshHasPendingInputs(){this._manager.refreshHasPendingInputs()}_onUninstall(){this._manager?(this.onUninstall(),this._manager=null):cre.error("This InputHandler is not registered with an InputManager")}_handleEvent(e){const i=this._incoming[e.type];if(i){for(const r of i)if(r.match.matches(e)&&(r.callback(e),e.shouldStopPropagation()))break}}}class bFe{constructor(e,i,r){this.match=e,this._callback=i,this._handler=r}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}}class wFe{constructor(e,i){this.eventType=e,this._removed=!1,this._handler=i}emit(e,i,r){this._removed||this._handler.onEmit(this,e,i,r)}remove(){this._removed=!0,this._handler.onRemove(this)}}class xFe extends bs{constructor(e){super(!0),this._onChange=e,this._value="mouse",this.registerIncoming("pointer-down",i=>{const r=i.data.native.pointerType==="touch";this._setValue(r?"touch":"mouse")}),this._moveHandler=this.registerIncoming("pointer-move",i=>{const r=i.data.native.pointerType==="touch";this._setValue(r?"touch":"mouse")}),this._moveHandler.pause()}_setValue(e){e!==this._value&&(e==="touch"?this._moveHandler.resume():this._moveHandler.pause(),this._value=e,this._onChange(e))}}const F9=le.getLogger("esri.views.input.InputManager");let t0=class extends ve{constructor(t){super(t),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=gFe,this.latestPointerType="mouse",this.test={timestamp:void 0,hasCurrentPropagation:()=>!!this._currentPropagation}}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const t=Object.keys(this._nameToGroup);for(const e of t)this.uninstallHandlers(e);this.eventSource=null,this._currentPropagation=null}get hasPendingInputs(){return this._handlers.some(t=>t.handler.hasPendingInputs)}installHandlers(t,e,i=If.INTERNAL){if(this._nameToGroup[t])return void F9.error("There is already an InputHandler group registered under the name `"+t+"`");if(e.length===0)return void F9.error("Can't register a group of zero handlers");const r={name:t,handlers:e.map(s=>({handler:s,active:!0,removed:!1,priorityIndex:0,groupPriority:i,eventCallback:null,uninstallCallback:null}))};this._nameToGroup[t]=r;for(let s=r.handlers.length-1;s>=0;s--){const n=r.handlers[s];this._handlers.push(n),n.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(o,a,l,c,h)=>{this._emitInputEvent(n.priorityIndex+1,o,a,l,h,c)},setPointerCapture:(o,a)=>{this._setPointerCapture(r,n,o,a)},setEventCallback:o=>{n.eventCallback=o},setUninstallCallback:o=>{n.uninstallCallback=o},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(t){const e=this._nameToGroup[t];e?(e.handlers.forEach(i=>{i.removed=!0,i.uninstallCallback()}),delete this._nameToGroup[t],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):F9.error("There is no InputHandler group registered under the name `"+t+"`")}hasHandlers(t){return this._nameToGroup[t]!==void 0}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const t=new Set,e=new Set;this._handlersPriority=[];for(let i=this._handlers.length-1;i>=0;i--){const r=this._handlers[i];r.priorityIndex=i,this._handlersPriority.push(r)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let i=this._handlersPriority.length-1;i>=0;i--){const r=this._handlersPriority[i];r.priorityIndex=i;let s=r.handler.hasSideEffects;if(!s){for(const n of r.handler.outgoingEventTypes)if(t.has(n)){s=!0;break}}if(s)for(const n of r.handler.incomingEventMatches){t.add(n.eventType);for(const o of n.keyModifiers)vFe(o)||e.add(o)}r.active=s}this._sourceEvents=t,this._keyModifiers=e,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointerType(t){this._set("latestPointerType",t)}_onEventReceived(t,e){if(t==="pointer-capture-lost"){const s=e;this._pointerCaptures.delete(s.native.pointerId)}this._updateKeyModifiers(t,e);const i=this.test.timestamp!=null?this.test.timestamp:e.native?e.native.timestamp:void 0,r=e.native?e.native.cancelable:void 0;this._emitInputEventFromSource(t,e,i,r)}_updateKeyModifiers(t,e){if(!e)return;let i=!1;const r=()=>{if(!i){const o=new Set;this._activeKeyModifiers.forEach(a=>{o.add(a)}),this._activeKeyModifiers=o,i=!0}},s=(o,a)=>{a&&!this._activeKeyModifiers.has(o)?(r(),this._activeKeyModifiers.add(o)):!a&&this._activeKeyModifiers.has(o)&&(r(),this._activeKeyModifiers.delete(o))};if(t==="key-down"||t==="key-up"){const o=e.key;this._keyModifiers.has(o)&&s(o,t==="key-down")}const n=e.native;s("Alt",!(!n||!n.altKey)),s("Ctrl",!(!n||!n.ctrlKey)),s("Shift",!(!n||!n.shiftKey)),s("Meta",!(!n||!n.metaKey)),s("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerTypeHandler=new xFe(t=>this._setLatestPointerType(t)),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,If.INTERNAL),this.installHandlers("input-manager-logic",[this._latestPointerTypeHandler],If.INTERNAL)}_setPointerCapture(t,e,i,r){const s=t.name+"-"+e.priorityIndex,n=this._pointerCaptures.get(i.pointerId)||new Set;this._pointerCaptures.set(i.pointerId,n),r?(n.add(s),n.size===1&&this.eventSource&&this.eventSource.setPointerCapture(i,!0)):n.has(s)&&(n.delete(s),n.size===0&&(this._pointerCaptures.delete(i.pointerId),this.eventSource&&this.eventSource.setPointerCapture(i,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter(t=>!t.removed),this.updateDependencies()}_emitInputEventFromSource(t,e,i,r){this._emitInputEvent(0,t,e,i,r)}_emitInputEvent(t,e,i,r,s,n){const o=r!==void 0?r:this._currentPropagation?this._currentPropagation.timestamp:performance.now(),a=s!==void 0&&s,l={event:new SFe(e,i,o,n||this._activeKeyModifiers,a),priorityIndex:t};this._currentPropagation?this._currentPropagation.events.push(l):this._doNewPropagation(l)}_doNewPropagation(t){this._currentPropagation={events:new lre,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:t.event.timestamp},this._currentPropagation.events.push(t),this._continuePropagation()}_continuePropagation(){const t=this._currentPropagation;if(t){for(;this._currentPropagation.events.length>0;){const{event:e,priorityIndex:i}=this._currentPropagation.events.pop(),r=e.data&&e.data.eventId;if(!(r!=null&&this._stoppedPropagationEventIds.has(r)))for(t.currentHandler=this._handlersPriority[i];t.currentHandler;){if(t.currentHandler.removed)t.needsHandlerGarbageCollect=!0;else{if(t.currentHandler.active&&!e.shouldStopPropagation()&&t.currentHandler.eventCallback(e),e.shouldStopPropagation()){r!=null&&this._stoppedPropagationEventIds.add(r);break}if(e.shouldPausePropagation(()=>this._continuePropagation()))return void this._pausePropagation({event:e,priorityIndex:t.currentHandler.priorityIndex+1})}t.currentHandler=this._handlersPriority[t.currentHandler.priorityIndex+1]}}t.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}}_pausePropagation(t){const e=new lre;for(e.push(t);this._currentPropagation.events.length;)e.push(this._currentPropagation.events.pop());this._currentPropagation.events=e,this._currentPropagation.currentHandler=null}_compareHandlerPriority(t,e){if(t.handler.hasSideEffects!==e.handler.hasSideEffects)return t.handler.hasSideEffects?1:-1;if(t.groupPriority!==e.groupPriority)return t.groupPriority>e.groupPriority?-1:1;for(const i of t.handler.incomingEventMatches)for(const r of e.handler.incomingEventMatches){if(i.eventType!==r.eventType)continue;const s=i.keyModifiers.filter(n=>r.keyModifiers.indexOf(n)!==-1);if(s.length===i.keyModifiers.length!=(s.length===r.keyModifiers.length))return i.keyModifiers.length>r.keyModifiers.length?-1:1}return t.priorityIndex>e.priorityIndex?-1:1}_sortHandlersPriority(t){const e=[];for(const i of t){let r=0;for(;r<e.length&&this._compareHandlerPriority(i,e[r])>=0;)r++;e.splice(r,0,i)}return e}get debug(){const t=e=>{const i=this._setPointerCapture;this._setPointerCapture=()=>{},e(),this._setPointerCapture=i};return{injectEvent:(e,i)=>{t(()=>{this._onEventReceived(e,i)})},disablePointerCapture:t}}};u([d({readOnly:!0})],t0.prototype,"hasPendingInputs",null),u([d()],t0.prototype,"eventSource",void 0),u([d()],t0.prototype,"recognizers",void 0),u([d({readOnly:!0})],t0.prototype,"latestPointerType",void 0),t0=u([R("esri.views.input.InputManager")],t0);class SFe{constructor(e,i,r,s,n){this.type=e,this.data=i,this.timestamp=r,this.modifiers=s,this.cancelable=n,this._propagationState=0,this._resumeCallback=null}stopPropagation(){this._propagationState|=1}shouldStopPropagation(){return(1&this._propagationState)!=0}async(e){this._propagationState|=2;const i=(r,s)=>{this._propagationState&=-3;const n=this._resumeCallback;if(this._resumeCallback=null,n&&n(),s)throw r;return r};return(typeof e=="function"?e():e).then(r=>i(r,!1),r=>i(r,!0))}shouldPausePropagation(e){return!!(2&this._propagationState)&&(this._resumeCallback=e,!0)}preventDefault(){this.data.native.preventDefault()}}const If={DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3};function TFe(t){return t&&typeof t.highlight=="function"}function CFe(t){return t&&typeof t.maskOccludee=="function"}function cat(t,e,i){return A(t)||t>i&&(e===0||t<e)}function uat(t){let{minScale:e,maxScale:i}=t;return e=e||0,i=i||0,{minScale:e,maxScale:i}}const oE={iconZoom:"esri-icon-zoom-in-magnifying-glass",iconTrash:"esri-icon-trash",iconBrowseClusteredFeatures:"esri-icon-table"},i0=new h1({id:"zoom-to-feature",title:"{messages.zoom}",className:oE.iconZoom}),ure=new h1({id:"remove-selected-feature",title:"{messages.remove}",className:oE.iconTrash}),L_=new h1({id:"zoom-to-clustered-features",title:"{messages.zoom}",className:oE.iconZoom}),k_=new h1({id:"browse-clustered-features",title:"{messages.browseClusteredFeatures}",className:oE.iconBrowseClusteredFeatures}),MFe="esri.widgets.Popup.PopupViewModel",Df=le.getLogger(MFe),PFe=function(t){const{event:e,view:i}=t,{action:r}=e,s=i&&i.popup;if(!r)return Promise.reject(new Q("trigger-action:missing-arguments","Event has no action"));if(!s)return Promise.reject(new Q("trigger-action:missing-arguments","view.popup is missing"));const{disabled:n,id:o}=r;if(!o)return Promise.reject(new Q("trigger-action:invalid-action","action.id is missing"));if(n)return Promise.reject(new Q("trigger-action:invalid-action","Action is disabled"));if(o===i0.id)return $Fe(s.viewModel).catch(gD);if(o===L_.id)return EFe(s.viewModel);if(o===k_.id)return s.featureMenuOpen=!s.featureMenuOpen,s.viewModel.browseClusterEnabled=!s.viewModel.browseClusterEnabled,Promise.resolve();if(s.viewModel.browseClusterEnabled=!1,o===ure.id){s.close();const{selectedFeature:a}=s;if(!a)return Promise.reject(new Q(`trigger-action:${ure.id}`,"selectedFeature is required",{selectedFeature:a}));const{sourceLayer:l}=a;return l?l.remove(a):i.graphics.remove(a),Promise.resolve()}return Promise.resolve()};function hre(t){const{selectedFeature:e,location:i,view:r}=t;return r?r.type==="3d"?e||i:t.get("selectedFeature.geometry")||i:null}function AFe(t,e){if((e==null?void 0:e.type)!=="3d"||!t||t.declaredClass!=="esri.Graphic")return!0;const i=e.getViewForGraphic(t);if(i&&"whenGraphicBounds"in i){let r=!1;return i.whenGraphicBounds(t,{useViewElevation:!0}).then(s=>{r=!s||!s.boundingBox||s.boundingBox[0]===s.boundingBox[3]&&s.boundingBox[1]===s.boundingBox[4]&&s.boundingBox[2]===s.boundingBox[5]}).catch(()=>{const s=new Q("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:t});Df.error(s)}),r}return!0}async function $Fe(t){const{location:e,selectedFeature:i,view:r,zoomFactor:s}=t,n=hre(t);if(!n){const c=new Q("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:n,view:r});return Df.error(c),Promise.reject(c)}const o=r.scale/s,a=t.get("selectedFeature.geometry")||e,l=a&&a.type==="point"&&AFe(i,r);i0.active=!0,i0.disabled=!0;try{await t.view.goTo({target:n,scale:l?o:void 0})}finally{i0.active=!1,i0.disabled=!1,t.zoomToLocation=null,l&&(t.location=a)}}async function EFe(t){const{selectedFeature:e,view:i}=t;if((i==null?void 0:i.type)!=="2d"){const a=new Q("zoomToCluster:invalid-view","View must be 2d MapView.",{view:i});throw Df.error(a),a}if(!e.isAggregate){const a=new Q("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:e});throw Df.error(a),a}const r=e.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[e.getObjectId()],L_.active=!0,L_.disabled=!0;const{extent:o}=await s.queryExtent(n);await i.goTo({target:o}),L_.active=!1,L_.disabled=!1}async function OFe(t){const{selectedFeature:e,view:i}=t;if((i==null?void 0:i.type)!=="2d"){const a=new Q("displayClusterExtent:invalid-view","View must be 2d MapView.",{view:i});throw Df.error(a),a}if(!e.isAggregate){const a=new Q("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:e});throw Df.error(a),a}const r=e.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[e.getObjectId()];const{extent:o}=await s.queryExtent(n);t.selectedClusterBoundaryFeature.geometry=o,i.graphics.add(t.selectedClusterBoundaryFeature)}async function RFe(t){const{selectedFeature:e,view:i}=t;if((i==null?void 0:i.type)!=="2d"){const a=new Q("browseAggregateFeatures:invalid-view","View must be 2d MapView.",{view:i});throw Df.error(a),a}if(!e.isAggregate){const a=new Q("browseAggregateFeatures:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:e});throw Df.error(a),a}const r=e.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[e.getObjectId()],k_.active=!0,k_.disabled=!0;const{features:o}=await s.queryFeatures(n);k_.active=!1,k_.disabled=!1,i.popup.open({features:[e].concat(o),featureMenuOpen:!0})}function IFe(t){t.features=t.features.filter(e=>e.isAggregate)}const dre=t=>{let e=class extends t{constructor(...i){super(...i),this.goToOverride=null,this.view=null}callGoTo(i){const{view:r}=this;return this.goToOverride?this.goToOverride(r,i):r.goTo(i.target,i.options)}};return u([d()],e.prototype,"goToOverride",void 0),u([d()],e.prototype,"view",void 0),e=u([R("esri.widgets.support.GoTo")],e),e},wS=We.ofType({key:"type",defaultKeyValue:"button",base:tP,typeMap:{button:h1,toggle:RW}}),DFe=()=>[i0.clone()],FFe=()=>[L_.clone(),k_.clone()],pre="esri.widgets.Popup.PopupViewModel",fre=le.getLogger(pre);let Vt=class extends dre(tre){constructor(t){super(t),this._handles=new dt,this._pendingPromises=new Set,this._fetchFeaturesController=null,this._selectedClusterFeature=null,this.featurePage=null,this.actions=new wS,this.defaultPopupTemplateEnabled=!1,this.autoCloseEnabled=!1,this.autoOpenEnabled=!0,this.browseClusterEnabled=!1,this.content=null,this.featuresPerPage=20,this.featureViewModelAbilities=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.selectedClusterBoundaryFeature=new pn({symbol:new iy({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null}get isLoadingFeature(){return this.featureViewModels.some(t=>t.waitingForContent)}initialize(){this._handles.add([Ke(this,["autoOpenEnabled","view"],()=>this._autoOpenEnabledChange()),this.on("view-change",()=>this._autoClose()),gi(this,["highlightEnabled","selectedFeature","visible","view"],()=>this._highlightFeature()),gi(this,"view.animation.state",t=>this._animationStateChange(t)),gi(this,"location",t=>this._locationChange(t)),gi(this,"selectedFeature",t=>this._selectedFeatureChange(t)),gi(this,["selectedFeatureIndex","featureCount","featuresPerPage"],()=>this._selectedFeatureIndexChange()),gi(this,["featurePage","selectedFeatureIndex","featureCount","featuresPerPage, featureViewModels"],()=>this._setGraphicOnFeatureViewModels()),gi(this,"featureViewModels",()=>this._featureViewModelsChange()),this.on("trigger-action",t=>PFe({event:t,view:this.view})),LM(this,"waitingForResult",()=>this._waitingForResultChange(),!0),gi(this,["features","view","view.map","view.spatialReference"],()=>this._updateFeatureVMs()),gi(this,["view.scale"],this._viewScaleChange),LM(this,"visible",()=>this.browseClusterEnabled=!1),gi(this,"browseClusterEnabled",t=>t?this.enableClusterBrowsing():this.disableClusterBrowsing())])}destroy(){this._cancelFetchingFeatures(),this._handles.destroy(),this._handles=null,this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const t=this._get("allActions")||new wS;t.removeAll();const{actions:e,defaultActions:i,defaultPopupTemplateEnabled:r,includeDefaultActions:s,selectedFeature:n}=this,o=s?i.concat(e):e,a=n&&(typeof n.getEffectivePopupTemplate=="function"&&n.getEffectivePopupTemplate(r)||n.popupTemplate),l=a&&a.actions,c=a&&a.overwriteActions?l:l?l.concat(o):o;return c&&c.filter(Boolean).forEach(h=>t.add(h)),t}get defaultActions(){var t;const e=this._get("defaultActions")||new wS;return e.removeAll(),e.addMany((t=this.selectedFeature)!=null&&t.isAggregate?FFe():DFe()),e}get featureCount(){return this.features.length}get features(){return this._get("features")||[]}set features(t){const e=t||[];this._set("features",e);const{pendingPromisesCount:i,promiseCount:r,selectedFeatureIndex:s}=this,n=r&&e.length;n&&i&&s===-1?this.selectedFeatureIndex=0:n&&s!==-1||(this.selectedFeatureIndex=e.length?0:-1)}get location(){return this._get("location")||null}set location(t){const e=this.get("view.spatialReference.isWebMercator");t&&t.get("spatialReference.isWGS84")&&e&&(t=Ih(t)),this._set("location",t)}get pendingPromisesCount(){return this._pendingPromises.size}get waitingForResult(){return!(!(!!this._fetchFeaturesController||this.pendingPromisesCount>0)||this.featureCount!==0)}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(t){if(this._pendingPromises.clear(),this.features=[],!Array.isArray(t)||!t.length)return this._set("promises",[]),void this.notifyChange("pendingPromisesCount");this._set("promises",t),(t=t.slice(0)).forEach(e=>{this._pendingPromises.add(e);const i=s=>{this._pendingPromises.has(e)&&this._updateFeatures(s),this._updatePendingPromises(e)},r=()=>this._updatePendingPromises(e);e.then(i,r)}),this.notifyChange("pendingPromisesCount")}get selectedFeature(){const{features:t,selectedFeatureIndex:e}=this;return e===-1?null:t[e]||null}get selectedFeatureIndex(){const t=this._get("selectedFeatureIndex");return typeof t=="number"?t:-1}set selectedFeatureIndex(t){const{featureCount:e}=this;t=isNaN(t)||t<-1||!e?-1:(t+e)%e,this._set("selectedFeatureIndex",t)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get state(){return this.get("view.ready")?"ready":"disabled"}centerAtLocation(){const{view:t}=this,e=hre(this);if(!e){const i=new Q("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:e,view:t});return fre.error(i),Promise.reject(i)}return this.callGoTo({target:{target:e,scale:t.scale}})}clear(){this.set({promises:[],features:[],content:null,title:null,location:null})}fetchFeatures(t,e){const{view:i}=this;if(!i||!t){const r=new Q("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:t,view:i});return fre.error(r),Promise.reject(r)}return i.fetchPopupFeatures(t,{event:e&&e.event,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:e&&e.signal})}open(t){const e=he(E({updateLocationEnabled:!1,promises:[],fetchFeatures:!1},t),{visible:!0}),{fetchFeatures:i}=e;delete e.fetchFeatures,i&&this._setFetchFeaturesPromises(e.location),this.set(e)}triggerAction(t){const e=this.allActions.getItemAt(t);e&&!e.disabled&&this.emit("trigger-action",{action:e})}next(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this}previous(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this}disableClusterBrowsing(){IFe(this),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){await OFe(this),await RFe(this)}_animationStateChange(t){this.zoomToLocation||(i0.disabled=t==="waiting-for-target")}_clearBrowsedClusterGraphics(){var t;const e=(t=this.view)==null?void 0:t.graphics;e&&(e.remove(this.selectedClusterBoundaryFeature),e.remove(this._selectedClusterFeature)),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){var t;((t=this.selectedFeature)!=null&&t.isAggregate||this.browseClusterEnabled)&&(this.browseClusterEnabled=!1,this.visible=!1)}_locationChange(t){const{selectedFeature:e,updateLocationEnabled:i}=this;i&&t&&(!e||e.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>1?Math.floor(this.selectedFeatureIndex/this.featuresPerPage)+1:null}_featureViewModelsChange(){this.featurePage=this.featureCount>1?1:null}_setGraphicOnFeatureViewModels(){const{features:t,featureCount:e,featurePage:i,featuresPerPage:r,featureViewModels:s}=this;if(i===null)return;const n=((i-1)*r+e)%e,o=n+r;s.slice(n,o).forEach((a,l)=>{a&&!a.graphic&&(a.graphic=t[n+l])})}async _selectedFeatureChange(t){if(!t)return;const{location:e,updateLocationEnabled:i,view:r}=this;if(this.browseClusterEnabled)return this._selectedClusterFeature&&(r.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),t.isAggregate?void 0:(t.symbol=await mFe(t),this._selectedClusterFeature=t,void r.graphics.add(this._selectedClusterFeature));!i&&e||!t.geometry?i&&!t.geometry&&this.centerAtLocation().then(()=>{this.location=r.center.clone()}):this.location=at(this._getPointFromGeometry(t.geometry))}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}_setFetchFeaturesPromises(t){return this._fetchFeaturesWithController(this._getScreenPoint(t||this.location)).then(e=>{const{clientOnlyGraphics:i,promisesPerLayerView:r}=e,s=Promise.resolve(i),n=r.map(o=>o.promise);this.promises=[s,...n]})}_destroyFeatureVMs(){this.featureViewModels.forEach(t=>t&&!t.destroyed&&t.destroy()),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:t,features:e,featureViewModels:i}=this;if(t!=null&&t.isAggregate||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!e||!e.length)return;const r=i.slice(0),s=[];e.forEach((n,o)=>{if(!n)return;let a=null;if(r.some((h,p)=>(h&&h.graphic===n&&(a=h,r.splice(p,1)),!!a)),a)s[o]=a;else{var l,c;const h=new R9({abilities:this.featureViewModelAbilities,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:(l=this.view)==null?void 0:l.spatialReference,graphic:n===t?n:null,map:(c=this.view)==null?void 0:c.map,view:this.view});s[o]=h}}),r.forEach(n=>n&&!n.destroyed&&n.destroy()),this._set("featureViewModels",s)}_getScreenPoint(t){const{view:e}=this;return e&&t&&typeof e.toScreen=="function"?e.toScreen(t):null}_autoOpenEnabledChange(){const t="auto-fetch-features",{_handles:e,autoOpenEnabled:i}=this;if(e.remove(t),i&&this.view){const r=this.view.on("click",s=>{s.pointerType==="mouse"&&s.button!==0||this._fetchFeaturesAndOpen(s)},If.WIDGET);e.add(r,t)}}_cancelFetchingFeatures(){const t=this._fetchFeaturesController;t&&t.abort(),this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}_fetchFeaturesWithController(t,e){this._cancelFetchingFeatures();const i=new AbortController,{signal:r}=i;this._fetchFeaturesController=i,this.notifyChange("waitingForResult");const s=this.fetchFeatures(t,{signal:r,event:e});return s.catch(()=>{}).then(()=>{this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}),s}_fetchFeaturesAndOpen(t){const{screenPoint:e,mapPoint:i}=t,{view:r}=this;this._fetchFeaturesWithController(e,t).then(s=>{const{clientOnlyGraphics:n,promisesPerLayerView:o,location:a}=s,l=[Promise.resolve(n),...o.map(c=>c.promise)];return r.popup.open({location:a||i,promises:l}),s})}_updatePendingPromises(t){t&&this._pendingPromises.has(t)&&(this._pendingPromises.delete(t),this.notifyChange("pendingPromisesCount"))}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}_getPointFromGeometry(t){return A(t)?null:t.type==="point"?t:t.type==="extent"?t.center:t.type==="polygon"?t.centroid:t.type==="multipoint"||t.type==="polyline"?t.extent.center:null}async _getLayerView(t,e){return await t.when(),t.whenLayerView(e)}async _highlightFeature(){const t="highlight";this._handles.remove(t);const{selectedFeature:e,highlightEnabled:i,view:r,visible:s}=this;if(!(e&&r&&i&&s))return;let{layer:n,sourceLayer:o}=e;if((o==null?void 0:o.type)!=="map-notes"&&(o==null?void 0:o.type)!=="subtype-group"||(n=o),!(n&&n instanceof n1))return;const a=this._getLayerView(r,n);this._highlightPromise=a;const l=await a;if(!(l&&TFe(l)&&this._highlightPromise===a&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const c="objectIdField"in n&&n.objectIdField,h=e.attributes,p=h&&c&&h[c],f=l.highlight(p||e);this._handles.add(f,t)}_updateFeatures(t){const{features:e}=this;if(!t||!t.length)return;if(!e.length)return void(this.features=t);const i=t.filter(r=>e.indexOf(r)===-1);this.features=e.concat(i)}};u([d()],Vt.prototype,"featurePage",void 0),u([d()],Vt.prototype,"isLoadingFeature",null),u([d({type:wS})],Vt.prototype,"actions",void 0),u([d({readOnly:!0})],Vt.prototype,"active",null),u([d({readOnly:!0})],Vt.prototype,"allActions",null),u([d({type:Boolean})],Vt.prototype,"defaultPopupTemplateEnabled",void 0),u([d()],Vt.prototype,"autoCloseEnabled",void 0),u([d()],Vt.prototype,"autoOpenEnabled",void 0),u([d()],Vt.prototype,"browseClusterEnabled",void 0),u([d()],Vt.prototype,"content",void 0),u([d({type:wS,readOnly:!0})],Vt.prototype,"defaultActions",null),u([d({readOnly:!0})],Vt.prototype,"featureCount",null),u([d()],Vt.prototype,"features",null),u([d()],Vt.prototype,"featuresPerPage",void 0),u([d()],Vt.prototype,"featureViewModelAbilities",void 0),u([d({readOnly:!0})],Vt.prototype,"featureViewModels",void 0),u([d()],Vt.prototype,"highlightEnabled",void 0),u([d()],Vt.prototype,"includeDefaultActions",void 0),u([d({type:je})],Vt.prototype,"location",null),u([d({readOnly:!0})],Vt.prototype,"pendingPromisesCount",null),u([d({readOnly:!0})],Vt.prototype,"selectedClusterBoundaryFeature",void 0),u([d({readOnly:!0})],Vt.prototype,"waitingForResult",null),u([d({readOnly:!0})],Vt.prototype,"promiseCount",null),u([d()],Vt.prototype,"promises",null),u([d({value:null,readOnly:!0})],Vt.prototype,"selectedFeature",null),u([d({value:-1})],Vt.prototype,"selectedFeatureIndex",null),u([d({readOnly:!0})],Vt.prototype,"selectedFeatureViewModel",null),u([d({readOnly:!0})],Vt.prototype,"state",null),u([d()],Vt.prototype,"title",void 0),u([d()],Vt.prototype,"updateLocationEnabled",void 0),u([d()],Vt.prototype,"view",void 0),u([d()],Vt.prototype,"visible",void 0),u([d()],Vt.prototype,"zoomFactor",void 0),u([d()],Vt.prototype,"zoomToLocation",void 0),u([d()],Vt.prototype,"centerAtLocation",null),Vt=u([R(pre)],Vt);const mre=Vt,gre="selected-index",LFe=0,yre="popup-spinner",xe={iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconDockToTop:"esri-icon-maximize",iconDockToBottom:"esri-icon-dock-bottom",iconDockToLeft:"esri-icon-dock-left",iconDockToRight:"esri-icon-dock-right",iconClose:"esri-icon-close",iconUndock:"esri-icon-minimize",iconCheckMark:"esri-icon-check-mark",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",iconActionsMenu:"esri-icon-handle-horizontal",rotating:"esri-rotating",base:"esri-popup",widget:"esri-widget",main:"esri-popup__main-container",loadingContainer:"esri-popup__loading-container",isCollapsible:"esri-popup--is-collapsible",isCollapsed:"esri-popup--is-collapsed",shadow:"esri-popup--shadow",isDocked:"esri-popup--is-docked",isDockedTopLeft:"esri-popup--is-docked-top-left",isDockedTopCenter:"esri-popup--is-docked-top-center",isDockedTopRight:"esri-popup--is-docked-top-right",isDockedBottomLeft:"esri-popup--is-docked-bottom-left",isDockedBottomCenter:"esri-popup--is-docked-bottom-center",isDockedBottomRight:"esri-popup--is-docked-bottom-right",alignTopCenter:"esri-popup--aligned-top-center",alignBottomCenter:"esri-popup--aligned-bottom-center",alignTopLeft:"esri-popup--aligned-top-left",alignBottomLeft:"esri-popup--aligned-bottom-left",alignTopRight:"esri-popup--aligned-top-right",alignBottomRight:"esri-popup--aligned-bottom-right",isFeatureMenuOpen:"esri-popup--feature-menu-open",isActionsMenuOpen:"esri-popup--actions-menu-open",hasFeatureUpdated:"esri-popup--feature-updated",header:"esri-popup__header",headerButtons:"esri-popup__header-buttons",headerContainer:"esri-popup__header-container",headerContainerButton:"esri-popup__header-container--button",headerTitle:"esri-popup__header-title",content:"esri-popup__content",footer:"esri-popup__footer",footerHasPagination:"esri-popup__footer--has-pagination",footerHasActions:"esri-popup__footer--has-actions",footerHasActionsMenu:"esri-popup__footer--has-actions-menu",button:"esri-popup__button",buttonDisabled:"esri-popup__button--disabled",buttonDock:"esri-popup__button--dock",icon:"esri-popup__icon",iconDock:"esri-popup__icon--dock-icon",inlineActionsContainer:"esri-popup__inline-actions-container",actionsMenuButton:"esri-popup__actions-menu-button",actions:"esri-popup__actions",action:"esri-popup__action",actionImage:"esri-popup__action-image",actionText:"esri-popup__action-text",actionToggle:"esri-popup__action-toggle",actionToggleOn:"esri-popup__action-toggle--on",pointer:"esri-popup__pointer",pointerDirection:"esri-popup__pointer-direction",navigation:"esri-popup__navigation",paginationPrevious:"esri-popup__pagination-previous",paginationNext:"esri-popup__pagination-next",paginationPreviousIconLTR:"esri-popup__pagination-previous-icon",paginationPreviousIconRTL:"esri-popup__pagination-previous-icon--rtl",paginationNextIconLTR:"esri-popup__pagination-next-icon",paginationNextIconRTL:"esri-popup__pagination-next-icon--rtl",featureMenu:"esri-popup__feature-menu",featureMenuList:"esri-popup__feature-menu-list",featureMenuItem:"esri-popup__feature-menu-item",featureMenuViewport:"esri-popup__feature-menu-viewport",featureMenuHeader:"esri-popup__feature-menu-header",featureMenuNote:"esri-popup__feature-menu-note",featureMenuSelected:"esri-popup__feature-menu-item--selected",featureMenuButton:"esri-popup__feature-menu-button",featureMenuTitle:"esri-popup__feature-menu-title",featureMenuObserver:"esri-popup__feature-menu-observer",featureMenuLoader:"esri-popup__feature-menu-loader",collapseButton:"esri-popup__collapse-button"},vre={buttonEnabled:!0,position:"auto",breakpoint:{width:544}},_re="esri-popup";function hd(t,e){return e===void 0?`${_re}__${t}`:`${_re}__${t}-${e}`}const bre="esri.widgets.Popup",wre=le.getLogger(bre),xre={closeButton:!0,featureNavigation:!0};let et=class extends Kie(Bs){constructor(t,e){super(t,e),this._blurClose=!1,this._blurContainer=!1,this._containerNode=null,this._mainContainerNode=null,this._featureMenuNode=null,this._actionsMenuNode=null,this._focusClose=!1,this._focusContainer=!1,this._focusDockButton=!1,this._focusFeatureMenuButton=!1,this._focusActionsMenuButton=!1,this._focusFirstFeature=!1,this._focusFirstAction=!1,this._handles=new dt,this._pointerOffsetInPx=16,this._spinner=null,this._feature=null,this._featureMenuIntersectionObserverCallback=([i])=>{i!=null&&i.isIntersecting&&this.viewModel.featurePage++},this._featureMenuIntersectionObserver=new IntersectionObserver(this._featureMenuIntersectionObserverCallback,{root:window.document}),this._displaySpinnerThrottled=rk(()=>this._displaySpinner(),LFe),this.actions=null,this.alignment="auto",this.autoCloseEnabled=null,this.autoOpenEnabled=null,this.defaultPopupTemplateEnabled=null,this.content=null,this.collapsed=!1,this.collapseEnabled=!0,this.dockEnabled=!1,this.featureCount=null,this.featureMenuOpen=!1,this.features=null,this.goToOverride=null,this.headingLevel=2,this.highlightEnabled=null,this.location=null,this.label=void 0,this.maxInlineActions=3,this.messages=null,this.messagesCommon=null,this.promises=null,this.selectedFeature=null,this.selectedFeatureIndex=null,this.spinnerEnabled=!0,this.title=null,this.updateLocationEnabled=null,this.view=null,this.viewModel=new mre,this.visible=null,this.visibleElements=E({},xre),this._addSelectedFeatureIndexHandle(),this.own([gi(this,"viewModel.screenLocation",()=>this._positionContainer()),gi(this,["viewModel.active","dockEnabled"],()=>this._toggleScreenLocationEnabled()),gi(this,"viewModel.screenLocation",(i,r)=>{!!i!=!!r&&this.reposition()}),gi(this,["viewModel.view.padding","viewModel.view.size","viewModel.active","viewModel.location","alignment"],()=>this.reposition()),gi(this,"spinnerEnabled",i=>this._spinnerEnabledChange(i)),gi(this,"viewModel.view.size",(i,r)=>this._updateDockEnabledForViewSize(i,r)),gi(this,"viewModel.view",(i,r)=>this._viewChange(i,r)),gi(this,"viewModel.view.ready",(i,r)=>this._viewReadyChange(i,r)),gi(this,["viewModel.waitingForResult","viewModel.location"],()=>{this._hideSpinner(),this._displaySpinnerThrottled()}),gi(this,["selectedFeatureWidget.viewModel.title","selectedFeatureWidget.viewModel.state"],()=>this._setTitleFromFeatureWidget()),gi(this,["selectedFeatureWidget.viewModel.content","selectedFeatureWidget.viewModel.state"],()=>this._setContentFromFeatureWidget()),LM(this,"collapsed",()=>{var i,r;((i=this.viewModel)==null||(r=i.view)==null?void 0:r.widthBreakpoint)==="xsmall"&&this.viewModel.active&&this.collapseEnabled&&this.viewModel.centerAtLocation()}),ks(this,"viewModel.allActions","change",()=>this._watchActions()),Ke(this,"viewModel.allActions",()=>this._watchActions()),gi(this,"viewModel.featureViewModels",()=>this._featureMenuViewportScrollTop())])}destroy(){var t,e;this._destroySelectedFeatureWidget(),this._destroySpinner(),(t=this._handles)==null||t.destroy(),this._unobserveFeatureMenuObserver(),(e=this._featureMenuIntersectionObserver)==null||e.disconnect(),this._handles=null}get actionsMenuId(){return`${this.id}-actions-menu`}get actionsMenuButtonId(){return`${this.id}-actions-menu-button`}get featureMenuId(){return`${this.id}-feature-menu`}get titleId(){return`${this.id}-popup-title`}get contentId(){return`${this.id}-popup-content`}get hasContent(){var t,e,i,r,s,n,o;return!!(this.selectedFeatureWidget?((t=this.selectedFeatureWidget)==null||(e=t.viewModel)==null?void 0:e.waitingForContent)||((i=this.selectedFeatureWidget)==null||(r=i.viewModel)==null?void 0:r.state)==="error"||((s=this.selectedFeatureWidget)==null||(n=s.viewModel)==null?void 0:n.content):(o=this.viewModel)==null?void 0:o.content)}get featureNavigationVisible(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation}get collapsible(){return!!(this.collapseEnabled&&this.viewModel.title&&this.hasContent)}get featureMenuVisible(){return this.featureNavigationVisible&&this.featureMenuOpen}get contentCollapsed(){return this.collapsible&&!this.featureMenuVisible&&this.collapsed}get dividedActions(){return this._divideActions()}set actionsMenuOpen(t){this._set("actionsMenuOpen",!!t)}get actionsMenuOpen(){return!!this.viewModel.active&&this._get("actionsMenuOpen")}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||vre}set dockOptions(t){const e=E({},vre),i=this.get("viewModel.view.breakpoints"),r={};i&&(r.width=i.xsmall,r.height=i.xsmall);const s=E(E({},e),t),n=E(E({},e.breakpoint),r),{breakpoint:o}=s;o===!0?s.breakpoint=n:typeof o=="object"&&(s.breakpoint=E(E({},n),o)),this._set("dockOptions",s),this._setCurrentDockPosition(),this.reposition()}get selectedFeatureWidget(){const{_feature:t,visibleElements:e,headingLevel:i}=this,{selectedFeatureViewModel:r}=this.viewModel,s=he(E({},e),{title:!1});return r?(t?(t.viewModel=r,t.visibleElements=s):this._feature=new qDe({headingLevel:i+1,viewModel:r,visibleElements:s}),this._feature):null}castVisibleElements(t){return E(E({},xre),t)}blur(){const{active:t}=this.viewModel;t||wre.warn("Popup can only be blurred when currently active."),this.visibleElements.closeButton?this._blurClose=!0:this._blurContainer=!0,this.scheduleRender()}clear(){this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(t,e){return this.viewModel.fetchFeatures(t,e)}focus(){const{active:t}=this.viewModel;t||wre.warn("Popup can only be focused when currently active."),this.visibleElements.closeButton?this._focusClose=!0:this._focusContainer=!0,this.scheduleRender()}next(){return this.viewModel.next()}open(t){var e,i;this._handles.remove(gre);const r=!!t&&!!t.featureMenuOpen,s=!!t&&!!t.actionsMenuOpen,n={collapsed:!!t&&!!t.collapsed,actionsMenuOpen:s,featureMenuOpen:r};((e=this.viewModel)==null||(i=e.view)==null?void 0:i.widthBreakpoint)==="xsmall"&&(n.collapsed=!0),this.set(n),this.viewModel.open(t),this._addSelectedFeatureIndexHandle()}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(t){this.viewModel.triggerAction(t)}render(){var t,e,i,r;const{actionsMenuOpen:s,dockEnabled:n,featureMenuVisible:o,dividedActions:a,currentAlignment:l,currentDockPosition:c}=this,{active:h}=this.viewModel,{menuActions:p}=a,f=h&&p.length>1&&s,g=h&&n,y=h&&!n,v=(t=this.selectedFeature)==null||(e=t.layer)==null?void 0:e.title,b=(i=this.selectedFeature)==null||(r=i.layer)==null?void 0:r.id,w={[xe.alignTopCenter]:l==="top-center",[xe.alignBottomCenter]:l==="bottom-center",[xe.alignTopLeft]:l==="top-left",[xe.alignBottomLeft]:l==="bottom-left",[xe.alignTopRight]:l==="top-right",[xe.alignBottomRight]:l==="bottom-right",[xe.isDocked]:g,[xe.shadow]:y,[xe.isDockedTopLeft]:c==="top-left",[xe.isDockedTopCenter]:c==="top-center",[xe.isDockedTopRight]:c==="top-right",[xe.isDockedBottomLeft]:c==="bottom-left",[xe.isDockedBottomCenter]:c==="bottom-center",[xe.isDockedBottomRight]:c==="bottom-right",[xe.isFeatureMenuOpen]:o,[xe.isActionsMenuOpen]:f};return ee("div",{class:this.classes(xe.base,w),role:"presentation","data-layer-title":v,"data-layer-id":b,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},h?[this.renderMainContainer(),this.renderPointer()]:null)}renderLoadingIcon(){return ee("span",{"aria-hidden":"true",class:this.classes(xe.icon,xe.iconLoading,xe.rotating)})}renderNavigationLoading(){const{messagesCommon:t}=this;return this.viewModel.pendingPromisesCount?ee("div",{key:hd("loading-container"),role:"presentation",class:xe.loadingContainer,"aria-label":t.loading,title:t.loading},this.renderLoadingIcon()):null}renderPreviousIcon(){const t=yf(this.container),e={[xe.iconRightTriangleArrow]:t,[xe.paginationPreviousIconRTL]:t,[xe.iconLeftTriangleArrow]:!t,[xe.paginationPreviousIconLTR]:!t};return ee("span",{"aria-hidden":"true",class:this.classes(xe.icon,e)})}renderPreviousButton(){const{messages:t}=this;return ee("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(xe.button,xe.paginationPrevious),"aria-label":t.previous,title:t.previous},this.renderPreviousIcon())}renderNextIcon(){const t=yf(this.container),e={[xe.iconLeftTriangleArrow]:t,[xe.paginationNextIconRTL]:t,[xe.iconRightTriangleArrow]:!t,[xe.paginationNextIconLTR]:!t};return ee("span",{"aria-hidden":"true",class:this.classes(xe.icon,e)})}renderNextButton(){const{messages:t}=this;return ee("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(xe.button,xe.paginationNext),"aria-label":t.next,title:t.next},this.renderNextIcon())}renderFeatureMenuButton(){const{featureMenuOpen:t,featureMenuId:e,messagesCommon:i}=this,{featureCount:r,selectedFeatureIndex:s}=this.viewModel;return ee("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(xe.button,xe.featureMenuButton),"aria-haspopup":"true","aria-controls":e,"aria-expanded":t.toString(),"aria-label":i.menu,title:i.menu},this._getPageText(r,s))}renderNavigationButtons(){return this.featureNavigationVisible?[this.renderPreviousButton(),this.renderNavigationLoading()||this.renderFeatureMenuButton(),this.renderNextButton()]:null}renderDockIcon(){const{dockEnabled:t}=this,e=this._wouldDockTo(),i={[xe.iconUndock]:t,[xe.iconDock]:!t,[xe.iconDockToRight]:!t&&(e==="top-right"||e==="bottom-right"),[xe.iconDockToLeft]:!t&&(e==="top-left"||e==="bottom-left"),[xe.iconDockToTop]:!t&&e==="top-center",[xe.iconDockToBottom]:!t&&e==="bottom-center"};return ee("span",{"aria-hidden":"true",class:this.classes(i,xe.icon)})}renderDockButton(){var t,e,i;const{dockEnabled:r,messages:s}=this,n=(t=this.viewModel)==null||(e=t.view)==null?void 0:e.widthBreakpoint,o=r?s.undock:s.dock;return n!=="xsmall"&&(i=this.dockOptions)!=null&&i.buttonEnabled?ee("div",{role:"button","aria-label":o,title:o,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(xe.button,xe.buttonDock)},this.renderDockIcon()):null}renderTitle(){const{title:t}=this.viewModel,{titleId:e,collapsible:i,contentCollapsed:r,messagesCommon:s}=this,n={[xe.headerContainerButton]:i},o=ee(xk,{level:this.headingLevel,class:xe.headerTitle,innerHTML:t}),a=i?ee("button",{key:`${t}--collapsible`,id:e,title:r?s.expand:s.collapse,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(xe.headerContainer,n),"aria-expanded":r?"false":"true",onclick:this._toggleCollapsed},o):ee("div",{key:t,id:e,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(xe.headerContainer,n)},o);return t?a:null}renderCloseIcon(){return ee("span",{"aria-hidden":"true",class:this.classes(xe.icon,xe.iconClose)})}renderCloseButton(){const{visibleElements:t,messagesCommon:e}=this;return t.closeButton?ee("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:xe.button,"aria-label":e.close,title:e.close,afterCreate:this._closeButtonNodeUpdated,afterUpdate:this._closeButtonNodeUpdated},this.renderCloseIcon()):null}renderHeader(){return ee("header",{class:xe.header},this.renderTitle(),ee("div",{class:xe.headerButtons},this.renderDockButton(),this.renderCloseButton()))}renderContentContainer(){const{contentId:t,hasContent:e,contentCollapsed:i}=this,{content:r}=this.viewModel;return e&&!i?ee("article",{key:r,enterAnimation:this._createFeatureUpdatedAnimation(),id:t,class:xe.content},this.renderContent()):null}renderActionsMenuButton(){const{actionsMenuId:t,actionsMenuButtonId:e,actionsMenuOpen:i,dividedActions:r,messagesCommon:s}=this,n=i?s.close:s.open,{menuActions:o}=r;return o.length?ee("div",{key:hd("actions-menu-button"),class:this.classes(xe.button,xe.actionsMenuButton),role:"button",id:e,"aria-haspopup":"true","aria-controls":i?t:null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":n,title:n},ee("span",{"aria-hidden":"true",class:xe.iconActionsMenu})):null}renderMenuActions(){const{actionsMenuId:t,actionsMenuButtonId:e,actionsMenuOpen:i,dividedActions:r}=this,{menuActions:s}=r;return s.length&&i?ee("ul",{id:t,role:"menu","aria-labelledby":e,key:hd("actions"),class:xe.actions,bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},s.toArray().map(n=>this.renderAction({action:n,type:"menu-item"}))):null}renderInlineActions(){const{inlineActions:t}=this.dividedActions;return!!t.length&&t.toArray().map(e=>this.renderAction({action:e,type:"inline"}))}renderInlineActionsContainer(){const{inlineActions:t,menuActions:e}=this.dividedActions,i=!!t.length,r=!!e.length;return i||r?ee("div",{key:"inline-actions-container","data-inline-actions":i.toString(),"data-menu-actions":r.toString(),class:xe.inlineActionsContainer},this.renderInlineActions(),this.renderActionsMenuButton(),this.renderMenuActions()):null}renderNavigation(){return this.featureNavigationVisible?ee("section",{key:hd("navigation"),class:this.classes(xe.navigation)},this.renderNavigationButtons()):null}renderFooter(){const{featureNavigationVisible:t,dividedActions:e}=this,{inlineActions:i,menuActions:r}=e,s=!!i.length,n=!!r.length,o={[xe.footerHasPagination]:t,[xe.footerHasActions]:s,[xe.footerHasActionsMenu]:n};return t||s?ee("div",{key:hd("feature-buttons"),class:this.classes(xe.footer,o)},this.renderInlineActionsContainer(),this.renderNavigation()):null}renderFeatureMenuContainer(){const{messages:t}=this,{featureViewModels:e,isLoadingFeature:i}=this.viewModel,r=yu(t.selectedFeatures,{total:e.length});return ee("section",{key:hd("menu"),class:xe.featureMenu},ee("strong",{class:xe.featureMenuHeader},r),ee("nav",{bind:this,class:xe.featureMenuViewport,"data-node-ref":"_featureMenuViewportNode",afterCreate:Q6},this.renderFeatureMenu(),ee("div",{class:xe.featureMenuObserver,bind:this,afterCreate:this._featureMenuIntersectionObserverCreated}),i?ee("div",{class:xe.featureMenuLoader},this.renderLoadingIcon()):null))}renderPointer(){return this.dockEnabled?null:ee("div",{key:hd("pointer"),class:xe.pointer,role:"presentation"},ee("div",{class:this.classes(xe.pointerDirection,xe.shadow)}))}renderMainContainer(){const{dockEnabled:t,currentAlignment:e,currentDockPosition:i,titleId:r,contentId:s,collapsible:n,hasContent:o,contentCollapsed:a,visibleElements:l}=this,{title:c}=this.viewModel,h=e==="bottom-left"||e==="bottom-center"||e==="bottom-right"||i==="top-left"||i==="top-center"||i==="top-right",p=e==="top-left"||e==="top-center"||e==="top-right"||i==="bottom-left"||i==="bottom-center"||i==="bottom-right",f={[xe.shadow]:t,[xe.isCollapsible]:n,[xe.isCollapsed]:a};return ee("div",{class:this.classes(xe.main,xe.widget,f),tabIndex:l.closeButton?null:-1,role:"dialog","aria-labelledby":c?r:"","aria-describedby":o&&!a?s:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},h?this.renderFooter():null,h?this.renderFeatureMenuContainer():null,this.renderHeader(),this.renderContentContainer(),p?this.renderFooter():null,p?this.renderFeatureMenuContainer():null)}renderContent(){var t;const e=(t=this.viewModel)==null?void 0:t.content;return e?typeof e=="string"?ee("div",{key:e,innerHTML:e}):this.renderNodeContent(e):null}renderActionText(t){return ee("span",{key:"text",class:xe.actionText},t)}renderActionIcon(t){const e=this._getActionClass(t),i=this._getActionImage(t),r={[xe.iconLoading]:t.active,[xe.rotating]:t.active,[xe.icon]:!!e,[xe.actionImage]:!t.active&&!!i};return e&&(r[e]=!t.active),ee("span",{key:"icon","aria-hidden":"true",class:this.classes(xe.icon,r),styles:this._getIconStyles(i)})}renderAction(t){const{action:e,type:i}=t,r=this._getActionTitle(e),s={[xe.action]:e.type!=="toggle",[xe.actionToggle]:e.type==="toggle",[xe.actionToggleOn]:e.type==="toggle"&&e.value,[xe.buttonDisabled]:e.disabled},n=[this.renderActionIcon(e),this.renderActionText(r)],o=i==="menu-item"?ee("li",{key:e.uid,role:"menuitem",tabIndex:0,title:r,"aria-label":r,class:this.classes(xe.button,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":e.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},n):ee("div",{key:e.uid,role:"button",tabIndex:0,title:r,"aria-label":r,class:this.classes(xe.button,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":e.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},n);return e.visible?o:null}renderFeatureMenuItem(t,e){const{messages:i,messagesCommon:r}=this,{selectedFeatureIndex:s,selectedFeatureViewModel:n}=this.viewModel,o=t===n,a={[xe.featureMenuSelected]:o},l=o?ee("span",{key:hd(`feature-menu-selected-feature-${s}`),title:i.selectedFeature,"aria-label":i.selectedFeature,class:xe.iconCheckMark}):null,c=ee("span",{innerHTML:t.title||r.untitled});return ee("li",{role:"menuitem",tabIndex:-1,key:hd(`feature-menu-feature-${s}`),class:this.classes(a,xe.featureMenuItem),bind:this,"data-feature-index":e,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature},ee("span",{class:xe.featureMenuTitle},c,l))}renderFeatureMenu(){const{featureMenuId:t}=this,{featureViewModels:e}=this.viewModel;return e.length>1?ee("ol",{class:xe.featureMenuList,id:t,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},e.filter(i=>!!i.graphic).map((i,r)=>this.renderFeatureMenuItem(i,r))):null}_getActionTitle(t){const{messages:e,selectedFeature:i,messagesCommon:r}=this,{id:s}=t,n=i==null?void 0:i.attributes,o=s==="zoom-to-feature"?yu(t.title,{messages:e}):s==="remove-selected-feature"?yu(t.title,{messages:r}):s==="zoom-to-clustered-features"||s==="browse-clustered-features"?yu(t.title,{messages:e}):t.title;return o&&n?yu(o,n):o}_getActionClass(t){const{selectedFeature:e}=this,i=e==null?void 0:e.attributes,{className:r,image:s}=t,n=s||r?r:xe.iconDefaultAction;return n&&i?yu(n,i):n}_getActionImage(t){const{selectedFeature:e}=this,i=e==null?void 0:e.attributes,{image:r}=t;return r&&i?yu(r,i):r}_createFeatureUpdatedAnimation(){return Q3e("enter",xe.hasFeatureUpdated)}_getInlineActionCount(){const{maxInlineActions:t,featureNavigationVisible:e}=this;if(typeof t!="number")return null;const i=Math.round(t);return Math.max(e?i-1:i,0)}_watchActions(){const{allActions:t}=this.viewModel;this.notifyChange("dividedActions");const e="actions";this._handles.remove(e),t&&t.forEach(i=>{this._handles.add(gi(i,["uid","active","className","disabled","id","title","image","visible"],()=>this.scheduleRender()),e)})}_divideActions(){const{allActions:t}=this.viewModel,e=t.filter(n=>n.visible),i=this._getInlineActionCount(),r=i===null,s=i===0;return{inlineActions:r?e.slice(0):s?new We:e.slice(0,i),menuActions:r?new We:s?e.slice(0):e.slice(i)}}_featureMenuOpenChanged(t){t?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0}_actionsMenuOpenChanged(t){t?this._focusFirstAction=!0:this._focusActionsMenuButton=!0}_setTitleFromFeatureWidget(){const{selectedFeatureWidget:t,messagesCommon:e}=this;var i,r;t&&(this.viewModel.title=((i=t.viewModel)==null?void 0:i.state)==="error"?e.errorMessage:((r=t.viewModel)==null?void 0:r.title)||"")}_setContentFromFeatureWidget(){const{selectedFeatureWidget:t}=this;t&&(this.viewModel.content=t)}_unobserveFeatureMenuObserver(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)}_featureMenuIntersectionObserverCreated(t){this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver.observe(t),this._featureMenuIntersectionObserverNode=t}_handleFeatureMenuKeyup(t){Fl(t)==="Escape"&&(t.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())}_handleActionMenuKeyup(t){Fl(t)==="Escape"&&(t.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())}_handleFeatureMenuItemKeyup(t){const e=Fl(t),{_featureMenuNode:i}=this,r=t.currentTarget["data-feature-index"];if(!i)return;const s=i.querySelectorAll("li"),n=s.length;e!=="ArrowUp"?e!=="ArrowDown"?e!=="Home"?e!=="End"||(t.stopPropagation(),s[s.length-1].focus()):(t.stopPropagation(),s[0].focus()):(t.stopPropagation(),s[(r+1+n)%n].focus()):(t.stopPropagation(),s[(r-1+n)%n].focus())}_handleActionMenuItemKeyup(t){const e=Fl(t),{_actionsMenuNode:i}=this,r=t.currentTarget.dataset.actionUid,{menuActions:s}=this.dividedActions,n=s.findIndex(l=>l.uid===r);if(!i)return;const o=i.querySelectorAll("li"),a=o.length;e!=="ArrowUp"?e!=="ArrowDown"?e!=="Home"?e!=="End"||(t.stopPropagation(),o[o.length-1].focus()):(t.stopPropagation(),o[0].focus()):(t.stopPropagation(),o[(n+1+a)%a].focus()):(t.stopPropagation(),o[(n-1+a)%a].focus())}_handleMainKeyup(t){const e=Fl(t);e==="ArrowLeft"&&(t.stopPropagation(),this.previous()),e==="ArrowRight"&&(t.stopPropagation(),this.next())}_spinnerEnabledChange(t){if(this._destroySpinner(),!t)return;const e=this.get("viewModel.view");this._createSpinner(e)}_hideSpinner(){const{_spinner:t}=this;t&&(t.location=null,t.hide())}_displaySpinner(){const{_spinner:t}=this;if(!t)return;const{location:e,waitingForResult:i}=this.viewModel;i?t.show({location:e}):t.hide()}_getIconStyles(t){return{"background-image":t?`url(${t})`:""}}_addSelectedFeatureIndexHandle(){const t=gi(this,"viewModel.selectedFeatureIndex",(e,i)=>this._selectedFeatureIndexUpdated(e,i));this._handles.add(t,gre)}_selectedFeatureIndexUpdated(t,e){const{featureCount:i}=this;i&&t!==e&&t!==-1&&(this.actionsMenuOpen=!1,this.featureMenuOpen=!1)}_destroySelectedFeatureWidget(){const{_feature:t}=this;t&&(t.viewModel=null,t&&!t.destroyed&&t.destroy()),this._feature=null}_isScreenLocationWithinView(t,e){return t.x>-1&&t.y>-1&&t.x<=e.width&&t.y<=e.height}_isOutsideView(t){const{popupHeight:e,popupWidth:i,screenLocation:r,side:s,view:n}=t;if(isNaN(i)||isNaN(e)||!n||!r)return!1;const o=n.padding;return s==="right"&&r.x+i/2>n.width-o.right||s==="left"&&r.x-i/2<o.left||s==="top"&&r.y-e<o.top||s==="bottom"&&r.y+e>n.height-o.bottom}_calculateAutoAlignment(t){if(t!=="auto")return t;const{_pointerOffsetInPx:e,_containerNode:i,_mainContainerNode:r,viewModel:s}=this,{screenLocation:n,view:o}=s;if(A(n)||!o||!i)return"top-center";if(!this._isScreenLocationWithinView(n,o))return this._get("currentAlignment")||"top-center";function a(T){return parseInt(T.replace(/[^-\d\.]/g,""),10)}const l=r?window.getComputedStyle(r,null):null,c=l?a(l.getPropertyValue("max-height")):0,h=l?a(l.getPropertyValue("height")):0,{height:p,width:f}=i.getBoundingClientRect(),g=f+e,y=Math.max(p,c,h)+e,v=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"right",view:o}),b=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"left",view:o}),w=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"top",view:o}),S=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"bottom",view:o});return b?w?"bottom-right":"top-right":v?w?"bottom-left":"top-left":w?S?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(t){return typeof t=="function"?t.call(this):t}_getCurrentAlignment(){const{alignment:t,dockEnabled:e}=this;return e||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(t)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(t){const e=["left","right"];return yf(this.container)&&e.reverse(),t.replace(/leading/gi,e[0]).replace(/trailing/gi,e[1])}_callDockPosition(t){return typeof t=="function"?t.call(this):t}_getDockPosition(){var t;return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition((t=this.dockOptions)==null?void 0:t.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_wouldDockTo(){return this.dockEnabled?null:this._getDockPosition()}_calculateAutoDockPosition(t){var e;if(t!=="auto")return t;const i=(e=this.viewModel)==null?void 0:e.view,r=yf(this.container)?"top-left":"top-right";if(!i)return r;const s=i.padding||{left:0,right:0,top:0,bottom:0},n=i.width-s.left-s.right,{breakpoints:o}=i;return o&&n<=o.xsmall?"bottom-center":r}_positionContainer(t=this._containerNode){if(t&&(this._containerNode=t),!t)return;const{screenLocation:e}=this.viewModel,{width:i}=t.getBoundingClientRect(),r=this._calculatePositionStyle(e,i);r&&(t.style.top=r.top,t.style.left=r.left,t.style.bottom=r.bottom,t.style.right=r.right)}_calculateFullWidth(t){const{currentAlignment:e,_pointerOffsetInPx:i}=this;return e==="top-left"||e==="bottom-left"||e==="top-right"||e==="bottom-right"?t+i:t}_calculateAlignmentPosition(t,e,i,r){const{currentAlignment:s,_pointerOffsetInPx:n}=this,o=r/2,a=i.height-e,l=i.width-t,{padding:c}=this.view;return s==="bottom-center"?{top:e+n-c.top,left:t-o-c.left}:s==="top-left"?{bottom:a+n-c.bottom,right:l+n-c.right}:s==="bottom-left"?{top:e+n-c.top,right:l+n-c.right}:s==="top-right"?{bottom:a+n-c.bottom,left:t+n-c.left}:s==="bottom-right"?{top:e+n-c.top,left:t+n-c.left}:s==="top-center"?{bottom:a+n-c.bottom,left:t-o-c.left}:void 0}_calculatePositionStyle(t,e){const{dockEnabled:i,view:r}=this;if(!r)return;if(i)return{left:"",top:"",right:"",bottom:""};if(A(t)||!e)return;const s=this._calculateFullWidth(e),n=this._calculateAlignmentPosition(t.x,t.y,r,s);return n?{top:n.top!==void 0?`${n.top}px`:"auto",left:n.left!==void 0?`${n.left}px`:"auto",bottom:n.bottom!==void 0?`${n.bottom}px`:"auto",right:n.right!==void 0?`${n.right}px`:"auto"}:void 0}_viewChange(t,e){t&&e&&(this.close(),this.clear())}_viewReadyChange(t,e){if(t){const i=this.get("viewModel.view");this._wireUpView(i)}else e&&(this.close(),this.clear())}_wireUpView(t){if(this._destroySpinner(),!t)return;const{spinnerEnabled:e}=this;e&&this._createSpinner(t),this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(t,e,i){const[r,s]=t,[n,o]=e,{width:a,height:l}=i;return r<=a&&n>a||r>a&&n<=a||s<=l&&o>l||s>l&&o<=l}_updateDockEnabledForViewSize(t,e){if(!t||!e)return;const i=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},r=i.left+i.right,s=i.top+i.bottom,n=[],o=[];n[0]=t[0]-r,n[1]=t[1]-s,o[0]=e[0]-r,o[1]=e[1]-s;const{dockOptions:a}=this,l=a.breakpoint;this._dockingThresholdCrossed(n,o,l)&&this._setDockEnabledForViewSize(a),this._setCurrentDockPosition()}_focusDockButtonNode(t){this._focusDockButton&&(this._focusDockButton=!1,t.focus())}_closeButtonNodeUpdated(t){return this._focusClose?(this._focusClose=!1,void t.focus()):this._blurClose?(this._blurClose=!1,void t.blur()):void 0}_mainContainerNodeUpdated(t){return this._mainContainerNode=t,this._focusContainer?(this._focusContainer=!1,void t.focus()):this._blurContainer?(this._blurContainer=!1,void t.blur()):void 0}_featureMenuNodeUpdated(t){if(this._featureMenuNode=t,!t||!this._focusFirstFeature)return;this._focusFirstFeature=!1;const e=t.querySelectorAll("li");e.length&&e[0].focus()}_actionsMenuNodeUpdated(t){if(this._actionsMenuNode=t,!t||!this._focusFirstAction)return;this._focusFirstAction=!1;const e=t.querySelectorAll("li");e.length&&e[0].focus()}_focusFeatureMenuButtonNode(t){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,t.focus())}_focusActionsMenuButtonNode(t){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,t.focus())}_featureMenuViewportScrollTop(){this._featureMenuViewportNode&&(this._featureMenuViewportNode.scrollTop=0)}_toggleScreenLocationEnabled(){const{dockEnabled:t,viewModel:e}=this;if(!e)return;const i=e.active&&!t;e.screenLocationEnabled=i}_shouldDockAtCurrentViewSize(t){var e,i;const r=t.breakpoint,s=(e=this.viewModel)==null||(i=e.view)==null?void 0:i.ui;if(!s)return!1;const{width:n,height:o}=s;if(isNaN(n)||isNaN(o))return!1;const a=r.hasOwnProperty("width")&&n<=r.width,l=r.hasOwnProperty("height")&&o<=r.height;return a||l}_setDockEnabledForViewSize(t){t.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(t))}_getPageText(t,e){return this.featureNavigationVisible?yu(this.messages.pageText,{index:e+1,total:t}):null}_destroySpinner(){const{_spinner:t,view:e}=this;t&&(e&&e.ui&&e.ui.remove(this._spinner,yre),t.destroy(),this._spinner=null)}_createSpinner(t){t&&(this._spinner=new WDe({view:t}),t.ui.add(this._spinner,{key:yre,position:"manual"}))}_toggleCollapsed(){this.collapsed=!this.collapsed}_close(){this.close(),this.view&&this.view.focus()}_toggleDockEnabled(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()}_toggleFeatureMenu(){const t=!this.featureMenuOpen;this._featureMenuOpenChanged(t),this.actionsMenuOpen=!1,this.featureMenuOpen=t}_toggleActionsMenu(){const t=!this.actionsMenuOpen;this._actionsMenuOpenChanged(t),this.featureMenuOpen=!1,this.actionsMenuOpen=t}_triggerAction(t){const e=t.currentTarget.dataset.actionUid,{allActions:i}=this.viewModel,r=i.findIndex(n=>n.uid===e),s=i.getItemAt(r);s&&s.type==="toggle"&&(s.value=!s.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(r)}_selectFeature(t){const e=t.currentTarget["data-feature-index"];isNaN(e)||(this.viewModel.selectedFeatureIndex=e),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()}_next(){this.next()}_previous(){this.previous()}};u([d({readOnly:!0})],et.prototype,"actionsMenuId",null),u([d({readOnly:!0})],et.prototype,"actionsMenuButtonId",null),u([d({readOnly:!0})],et.prototype,"featureMenuId",null),u([d({readOnly:!0})],et.prototype,"titleId",null),u([d({readOnly:!0})],et.prototype,"contentId",null),u([d({readOnly:!0})],et.prototype,"hasContent",null),u([d({readOnly:!0})],et.prototype,"featureNavigationVisible",null),u([d({readOnly:!0})],et.prototype,"collapsible",null),u([d({readOnly:!0})],et.prototype,"featureMenuVisible",null),u([d({readOnly:!0})],et.prototype,"contentCollapsed",null),u([d({readOnly:!0})],et.prototype,"dividedActions",null),u([Ve("viewModel.actions")],et.prototype,"actions",void 0),u([d()],et.prototype,"actionsMenuOpen",null),u([d()],et.prototype,"alignment",void 0),u([Ve("viewModel.autoCloseEnabled")],et.prototype,"autoCloseEnabled",void 0),u([Ve("viewModel.autoOpenEnabled")],et.prototype,"autoOpenEnabled",void 0),u([Ve("viewModel.defaultPopupTemplateEnabled")],et.prototype,"defaultPopupTemplateEnabled",void 0),u([Ve("viewModel.content")],et.prototype,"content",void 0),u([d()],et.prototype,"collapsed",void 0),u([d()],et.prototype,"collapseEnabled",void 0),u([d({readOnly:!0})],et.prototype,"currentAlignment",null),u([d({readOnly:!0})],et.prototype,"currentDockPosition",null),u([d()],et.prototype,"dockOptions",null),u([d()],et.prototype,"dockEnabled",void 0),u([Ve("viewModel.featureCount")],et.prototype,"featureCount",void 0),u([d()],et.prototype,"featureMenuOpen",void 0),u([Ve("viewModel.features")],et.prototype,"features",void 0),u([Ve("viewModel.goToOverride")],et.prototype,"goToOverride",void 0),u([d()],et.prototype,"headingLevel",void 0),u([Ve("viewModel.highlightEnabled")],et.prototype,"highlightEnabled",void 0),u([Ve("viewModel.location")],et.prototype,"location",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],et.prototype,"label",void 0),u([d()],et.prototype,"maxInlineActions",void 0),u([d(),qs("esri/widgets/Popup/t9n/Popup")],et.prototype,"messages",void 0),u([d(),qs("esri/t9n/common")],et.prototype,"messagesCommon",void 0),u([Ve("viewModel.promises")],et.prototype,"promises",void 0),u([Ve("viewModel.selectedFeature")],et.prototype,"selectedFeature",void 0),u([Ve("viewModel.selectedFeatureIndex")],et.prototype,"selectedFeatureIndex",void 0),u([d({readOnly:!0})],et.prototype,"selectedFeatureWidget",null),u([d()],et.prototype,"spinnerEnabled",void 0),u([Ve("viewModel.title")],et.prototype,"title",void 0),u([Ve("viewModel.updateLocationEnabled")],et.prototype,"updateLocationEnabled",void 0),u([Ve("viewModel.view")],et.prototype,"view",void 0),u([d({type:mre}),hPe(["triggerAction","trigger-action"])],et.prototype,"viewModel",void 0),u([Ve("viewModel.visible")],et.prototype,"visible",void 0),u([d()],et.prototype,"visibleElements",void 0),u([ut("visibleElements")],et.prototype,"castVisibleElements",null),u([ia()],et.prototype,"_close",null),u([ia()],et.prototype,"_toggleDockEnabled",null),u([ia()],et.prototype,"_toggleFeatureMenu",null),u([ia()],et.prototype,"_toggleActionsMenu",null),u([ia()],et.prototype,"_triggerAction",null),u([ia()],et.prototype,"_selectFeature",null),u([ia()],et.prototype,"_next",null),u([ia()],et.prototype,"_previous",null),et=u([R(bre)],et);const Sre=et,L9=[0,0];function kFe(t){const e=(t.ownerDocument||window.document).defaultView,i=t.getBoundingClientRect();return L9[0]=i.left+e.pageXOffset,L9[1]=i.top+e.pageYOffset,L9}function Tre(t){t&&(TZ(t),t.parentNode&&t.parentNode.removeChild(t))}function zFe(t){const e=document.createElement("div");return t.appendChild(e),e}const xS=16,aE=750,VFe=512,NFe=2,UFe=t=>{let e=class extends t{constructor(...i){super(...i),this._freqInfo={freq:xS,time:aE},this._overlayRenderTaskHandle=null,this.height=0,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.ui=null,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.handles.add([this.watch("cursor",r=>{const s=this.surface;s&&s.setAttribute("data-cursor",r)}),this.watch("interacting",r=>{const s=this.surface;s&&s.setAttribute("data-interacting",r.toString())})])}initialize(){this.handles.add(this.watch("ui",(i,r)=>this._handleUIChange(i,r))),this._wireUI(this.ui),this.handles.add([this.on("focus",()=>this.notifyChange("focused")),this.on("blur",()=>this.notifyChange("focused"))])}destroy(){this.destroyed||(this.ui&&(this.ui.destroy(),this.ui=null),this.popup&&!this.popup.destroyed&&this.popup.destroy(),this.container=null)}set container(i){const r=this._get("container");if(r===i)return;const s="dom-size";if(this.handles.remove(s),this._stopMeasuring(),r&&(r.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay.destroy(),this._set("overlay",null),Tre(this.root),this._set("root",null),MZ(this.userContent,r),Tre(this.userContent),this._set("userContent",null)),i){i.classList.add("esri-view");const n=document.createElement("div");n.className="esri-view-user-storage",MZ(i,n),i.appendChild(n),this._set("userContent",n);const o=document.createElement("div");o.className="esri-view-root",i.insertBefore(o,i.firstChild),this._set("root",o);const a=document.createElement("div");a.className="esri-view-surface",a.setAttribute("role","application"),a.tabIndex=0,o.appendChild(a),this._set("surface",a);const l=new vY;o.appendChild(l.surface),this._set("overlay",l),l.watch("needsRender",c=>{c&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=gg({render:()=>{this.overlay.render()}}):this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null)}),this.forceDOMReadyCycle(),this.handles.add(Ke(this,"size",c=>{const[h,p]=c,f="esri-view-surface--inset-outline";h>=document.body.clientWidth||p>=document.body.clientHeight?a.classList.add(f):a.classList.remove(f)}),s),this._set("container",i),this._startMeasuring()}else this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),this._set("container",null)}get focused(){const i=document.activeElement===this.surface;return document.hasFocus()&&i}get popup(){return this._get("popup")||new Sre({view:this})}set popup(i){const r=this._get("popup");r&&r!==i&&r.destroy(),this._set("popup",i)}get size(){return[this.width,this.height]}blur(){this.surface&&this.surface.blur()}focus(){this.surface&&this.surface.focus()}pageToContainer(i,r,s){const n=this.position;return i-=n[0],r-=n[1],s?(s[0]=i,s[1]=r):s=[i,r],s}containerToPage(i,r,s){const n=this.position;return i+=n[0],r+=n[1],s?(s[0]=i,s[1]=r):s=[i,r],s}_handleUIChange(i,r){r&&(this.handles.remove("ui"),r.destroy()),i&&this._wireUI(i),this._set("ui",i)}_wireUI(i){this.handles.remove("ui"),i&&(i.view=this,this.handles.add([Ke(this,"root",r=>{i.container=r?zFe(r):null}),Ke(this,"popup",(r,s)=>{const n="popup",o="manual";s&&i.remove(s,n),r&&(r.view=i.view,i.add(r,{key:n,position:o}))})],"ui"))}_stopMeasuring(){this.handles.remove("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const i=this._freqInfo;i.freq=xS,i.time=aE,this.handles.add([(()=>{const r=()=>{i.freq=xS,i.time=aE};return window.addEventListener("resize",r),{remove(){window.removeEventListener("resize",r)}}})(),gg({prepare:r=>{const s=this._measure(),n=this._freqInfo;if(n.time+=r.deltaTime,s&&(n.freq=xS,this._get("resizing")||this._set("resizing",!0)),n.time<n.freq)return;n.time=0;const o=this._position();n.freq=o||s?xS:Math.min(aE,n.freq*NFe),!s&&n.freq>=VFe&&this._get("resizing")&&this._set("resizing",!1)}})],"measuring"),this._measure(),this._position()}_measure(){const i=this.container,r=i?i.clientWidth:0,s=i?i.clientHeight:0;if(r===0||s===0)return this.suspended||this._set("suspended",!0),!1;const n=this.width,o=this.height;return r===n&&s===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",r),this._set("height",s),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:n,oldHeight:o,width:r,height:s}),!0)}_position(){const i=this.container,r=this.position,s=kFe(i);return(!r||s[0]!==r[0]||s[1]!==r[1])&&(this._set("position",[s[0],s[1]]),!0)}forceDOMReadyCycle(){}};return u([d({value:null,cast:i=>MP(i)})],e.prototype,"container",null),u([d({readOnly:!0})],e.prototype,"focused",null),u([d({readOnly:!0})],e.prototype,"height",void 0),u([d({type:Sre})],e.prototype,"popup",null),u([d({type:vY})],e.prototype,"overlay",void 0),u([d({readOnly:!0})],e.prototype,"position",void 0),u([d({readOnly:!0})],e.prototype,"resizing",void 0),u([d({readOnly:!0})],e.prototype,"root",void 0),u([d({value:null,readOnly:!0})],e.prototype,"size",null),u([d({readOnly:!0})],e.prototype,"surface",void 0),u([d({readOnly:!0})],e.prototype,"suspended",void 0),u([d()],e.prototype,"ui",void 0),u([d({readOnly:!0})],e.prototype,"userContent",void 0),u([d({readOnly:!0})],e.prototype,"width",void 0),u([d()],e.prototype,"widthBreakpoint",void 0),e=u([R("esri.views.DOMContainer")],e),e},k9=le.getLogger("esri.layers.support.ElevationSampler");class Cre{queryElevation(e){return Mre(e.clone(),this)}on(){return HFe}projectIfRequired(e,i){return Pre(e,i)}}class jFe extends Cre{constructor(e,i,r){super(),this.tile=e,this.noDataValue=r,this.extent=lP(e.tile.extent,i.spatialReference);const s=bo(i.spatialReference),n=i.lodAt(e.tile.level).resolution*s;this.demResolution={min:n,max:n}}get spatialReference(){return this.extent.spatialReference}contains(e){const i=this.projectIfRequired(e,this.spatialReference);return ux(this.extent,i)}elevationAt(e){const i=this.projectIfRequired(e,this.spatialReference);if(A(i))return null;if(!this.contains(e)){const r=this.extent,s=`${r.xmin}, ${r.ymin}, ${r.xmax}, ${r.ymax}`;return k9.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler extent (${s})`),this.noDataValue}return this.tile.sample(i.x,i.y)}}class hat extends Cre{constructor(e,i,r){let s;super(),typeof i=="number"?(this.noDataValue=i,s=null):(s=i,this.noDataValue=r),this.samplers=s?e.map(o=>new jFe(o,s,this.noDataValue)):e;const n=this.samplers[0];if(n){this.extent=n.extent.clone();const{min:o,max:a}=n.demResolution;this.demResolution={min:o,max:a};for(let l=1;l<this.samplers.length;l++){const c=this.samplers[l];this.extent.union(c.extent),this.demResolution.min=Math.min(this.demResolution.min,c.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,c.demResolution.max)}}else this.extent=lP(pt(),s.spatialReference),this.demResolution={min:0,max:0}}get spatialReference(){return this.extent.spatialReference}elevationAt(e){const i=this.projectIfRequired(e,this.spatialReference);if(!i)return null;for(const r of this.samplers)if(r.contains(i))return r.elevationAt(i);return k9.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler`),this.noDataValue}}function Mre(t,e){const i=Pre(t,e.spatialReference);if(!i)return null;switch(t.type){case"point":BFe(t,i,e);break;case"polyline":GFe(t,i,e);break;case"multipoint":qFe(t,i,e)}return t}function Pre(t,e){if(A(t))return null;const i=t.spatialReference;if(i.equals(e))return t;const r=wg(t,e);return r||k9.error(`Cannot project geometry spatial reference (wkid:${i.wkid}) to elevation sampler spatial reference (wkid:${e.wkid})`),r}function BFe(t,e,i){t.z=st(i.elevationAt(e),0)}function GFe(t,e,i){Ff.spatialReference=e.spatialReference;const r=t.hasM&&!t.hasZ;for(let s=0;s<t.paths.length;s++){const n=t.paths[s],o=e.paths[s];for(let a=0;a<n.length;a++){const l=n[a],c=o[a];Ff.x=c[0],Ff.y=c[1],r&&(l[3]=l[2]),l[2]=st(i.elevationAt(Ff),0)}}t.hasZ=!0}function qFe(t,e,i){Ff.spatialReference=e.spatialReference;const r=t.hasM&&!t.hasZ;for(let s=0;s<t.points.length;s++){const n=t.points[s],o=e.points[s];Ff.x=o[0],Ff.y=o[1],r&&(n[3]=n[2]),n[2]=st(i.elevationAt(Ff),0)}t.hasZ=!0}const Ff=new je,HFe={remove(){}};function lE(t){return t.type==="point"}class Are{constructor(e,i=null,r=0){this.array=e,this.spatialReference=i,this.offset=r}}function $re(t){return"array"in t}function wc(t,e,i="ground"){if(lE(e))return t.getElevation(e.x,e.y,e.z||0,e.spatialReference,i);if($re(e)){let r=e.offset;return t.getElevation(e.array[r++],e.array[r++],e.array[r]||0,st(e.spatialReference,t.spatialReference),i)}return t.getElevation(e[0],e[1],e[2]||0,t.spatialReference,i)}var z9;let Iu=z9=class extends ge{constructor(t){super(t),this.cols=null,this.level=0,this.levelValue=null,this.origin=null,this.resolution=0,this.rows=null,this.scale=0}clone(){return new z9({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}};u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Iu.prototype,"cols",void 0),u([d({type:Oi,json:{write:!0}})],Iu.prototype,"level",void 0),u([d({type:String,json:{write:!0}})],Iu.prototype,"levelValue",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Iu.prototype,"origin",void 0),u([d({type:Number,json:{write:!0}})],Iu.prototype,"resolution",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Iu.prototype,"rows",void 0),u([d({type:Number,json:{write:!0}})],Iu.prototype,"scale",void 0),Iu=z9=u([R("esri.layers.support.LOD")],Iu);const qi=Iu;var SS;const Ere=new wt({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});let Ys=SS=class extends ge{constructor(t){super(t),this.dpi=96,this.format=null,this.origin=null,this.minScale=0,this.maxScale=0,this.size=null,this.spatialReference=null}static create(t={}){const{resolutionFactor:e=1,scales:i,size:r=256,spatialReference:s=Ue.WebMercator,numLODs:n=24}=t;if(!Ho(s)){const p=[];if(i)for(let f=0;f<i.length;f++){const g=i[f];p.push({level:f,scale:g,resolution:g})}else{let f=5e-4;for(let g=n-1;g>=0;g--)p.unshift({level:g,scale:f,resolution:f}),f*=2}return new SS({dpi:96,lods:p,origin:new je(0,0,s),size:[r,r],spatialReference:s})}const o=Pp(s),a=t.origin?new je({x:t.origin.x,y:t.origin.y,spatialReference:s}):new je(o?{x:o.origin[0],y:o.origin[1],spatialReference:s}:{x:0,y:0,spatialReference:s}),l=96,c=1/(bo(s)*39.37*l),h=[];if(i)for(let p=0;p<i.length;p++){const f=i[p],g=f*c;h.push({level:p,scale:f,resolution:g})}else{let p=Cq(s)?512/r*5916575275917094e-7:256/r*591657527591555e-6;const f=Math.ceil(n/e);h.push({level:0,scale:p,resolution:p*c});for(let g=1;g<f;g++){const y=p/2**e,v=y*c;h.push({level:g,scale:y,resolution:v}),p=y}}return new SS({dpi:l,lods:h,origin:a,size:[r,r],spatialReference:s})}get isWrappable(){const{spatialReference:t,origin:e}=this;if(t&&e){const i=Pp(t);return t.isWrappable&&Math.abs(i.origin[0]-e.x)<=i.dx}return!1}readOrigin(t,e){return je.fromJSON(E({spatialReference:e.spatialReference},t))}set lods(t){let e=0,i=0;const r=[];this._levelToLOD={},t&&(e=-1/0,i=1/0,t.forEach(s=>{r.push(s.scale),e=s.scale>e?s.scale:e,i=s.scale<i?s.scale:i,this._levelToLOD[s.level]=s})),this._set("scales",r),this._set("minScale",e),this._set("maxScale",i),this._set("lods",t),this._initializeUpsampleLevels()}readSize(t,e){return[e.cols,e.rows]}writeSize(t,e){e.cols=t[0],e.rows=t[1]}zoomToScale(t){const e=this.scales;if(t<=0)return e[0];if(t>=e.length-1)return e[e.length-1];{const i=Math.floor(t),r=i+1;return e[i]/(e[i]/e[r])**(t-i)}}scaleToZoom(t){const e=this.scales,i=e.length-1;let r=0;for(;r<i;r++){const s=e[r],n=e[r+1];if(s<=t)return r;if(n===t)return r+1;if(s>t&&n<t)return r+Math.log(s/t)/Math.log(s/n)}return r}snapScale(t,e=.95){const i=this.scaleToZoom(t);return i%Math.floor(i)>=e?this.zoomToScale(Math.ceil(i)):this.zoomToScale(Math.floor(i))}tileAt(t,e,i,r){const s=this.lodAt(t);if(!s)return null;let n,o;if(typeof e=="number")n=e,o=i;else if(Da(e.spatialReference,this.spatialReference))n=e.x,o=e.y,r=i;else{const c=wg(e,this.spatialReference);if(A(c))return null;n=c.x,o=c.y,r=i}const a=s.resolution*this.size[0],l=s.resolution*this.size[1];return r||(r={id:null,level:0,row:0,col:0,extent:pt()}),r.level=t,r.row=Math.floor((this.origin.y-o)/l+.001),r.col=Math.floor((n-this.origin.x)/a+.001),this.updateTileInfo(r),r}updateTileInfo(t,e=0){let i=this.lodAt(t.level);if(!i&&e===1){const o=this.lods[this.lods.length-1];o.level<t.level&&(i=o)}if(!i)return;const r=t.level-i.level,s=i.resolution*this.size[0]/2**r,n=i.resolution*this.size[1]/2**r;t.id=`${t.level}/${t.row}/${t.col}`,t.extent||(t.extent=pt()),t.extent[0]=this.origin.x+t.col*s,t.extent[1]=this.origin.y-(t.row+1)*n,t.extent[2]=t.extent[0]+s,t.extent[3]=t.extent[1]+n}upsampleTile(t){const e=this._upsampleLevels[t.level];return!(!e||e.parentLevel===-1)&&(t.level=e.parentLevel,t.row=Math.floor(t.row/e.factor+.001),t.col=Math.floor(t.col/e.factor+.001),this.updateTileInfo(t),!0)}getTileBounds(t,e){const{resolution:i}=this.lodAt(e.level),r=i*this.size[0],s=i*this.size[1];return t[0]=this.origin.x+e.col*r,t[1]=this.origin.y-(e.row+1)*s,t[2]=t[0]+r,t[3]=t[1]+s,t}lodAt(t){return this._levelToLOD&&this._levelToLOD[t]||null}clone(){return SS.fromJSON(this.write({}))}_initializeUpsampleLevels(){const t=this.lods;this._upsampleLevels=[];let e=null;for(let i=0;i<t.length;i++){const r=t[i];this._upsampleLevels[r.level]={parentLevel:e?e.level:-1,factor:e?e.resolution/r.resolution:0},e=r}}};u([d({type:Number,json:{write:!0}})],Ys.prototype,"compressionQuality",void 0),u([d({type:Number,json:{write:!0}})],Ys.prototype,"dpi",void 0),u([d({type:String,json:{read:Ere.read,write:Ere.write,origins:{"web-scene":{read:!1,write:!1}}}})],Ys.prototype,"format",void 0),u([d({readOnly:!0})],Ys.prototype,"isWrappable",null),u([d({type:je,json:{write:!0}})],Ys.prototype,"origin",void 0),u([Ce("origin")],Ys.prototype,"readOrigin",null),u([d({type:[qi],value:null,json:{write:!0}})],Ys.prototype,"lods",null),u([d({readOnly:!0})],Ys.prototype,"minScale",void 0),u([d({readOnly:!0})],Ys.prototype,"maxScale",void 0),u([d({readOnly:!0})],Ys.prototype,"scales",void 0),u([d({cast:t=>Array.isArray(t)?t:typeof t=="number"?[t,t]:[256,256]})],Ys.prototype,"size",void 0),u([Ce("size",["rows","cols"])],Ys.prototype,"readSize",null),u([Ee("size",{cols:{type:Oi},rows:{type:Oi}})],Ys.prototype,"writeSize",null),u([d({type:Ue,json:{write:!0}})],Ys.prototype,"spatialReference",void 0),Ys=SS=u([R("esri.layers.support.TileInfo")],Ys);const xc=Ys,WFe=12;class yi{constructor(e){const i=yi.checkUnsupported(e);if(_(i))throw i;const r=at(e);this.spatialReference=r.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=fy(this.spatialReference)||$h(this.spatialReference)||Eh(this.spatialReference),this.origin=[r.origin.x,r.origin.y],this.pixelSize=r.size[0],this.dpi=r.dpi;const s=r.lods.reduce(function(c,h,p){return h.level<c.min&&(c.min=h.level,c.minIndex=p),c.max=Math.max(c.max,h.level),c},{min:1/0,minIndex:0,max:-1/0}),n=r.lods[s.minIndex],o=2**n.level;let a=n.resolution*o,l=n.scale*o;this.levels=new Array(s.max+1);for(let c=0;c<this.levels.length;c++)this.levels[c]={resolution:a,scale:l,tileSize:[a*r.size[0],a*r.size[1]]},a/=2,l/=2}clone(){return new yi(this.toTileInfo())}toTileInfo(){return new xc({dpi:this.dpi,origin:{x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference},size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((e,i)=>({level:i,scale:e.scale,resolution:e.resolution}))})}getExtent(e,i,r,s){const n=this.levels[e],o=n.tileSize[0],a=n.tileSize[1];s[0]=this.origin[0]+r*o,s[2]=s[0]+o,s[3]=this.origin[1]-i*a,s[1]=s[3]-a}convertExtentToRadians(e,i){this._isWebMercator?(i[0]=Nq(e[0]),i[1]=_M(e[1]),i[2]=Nq(e[2]),i[3]=_M(e[3])):this._isGCS&&(i[0]=nt(e[0]),i[1]=nt(e[1]),i[2]=nt(e[2]),i[3]=nt(e[3]))}getExtentGeometry(e,i,r,s=new ht){return this.getExtent(e,i,r,Du),s.spatialReference=this.spatialReference,s.xmin=Du[0],s.ymin=Du[1],s.xmax=Du[2],s.ymax=Du[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(e){if(e==null)return!1;let i=!1;for(;this.levels.length<=e;){const r=this.levels[this.levels.length-1],s=r.resolution/2;this.levels.push({resolution:s,scale:r.scale/2,tileSize:[s*this.pixelSize,s*this.pixelSize]}),i=!0}return i}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const i=this.levels[0].scale;return e>=i?0:Math.log(i/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof yi)){if(yi.checkUnsupported(e))return!1;e=new yi(e)}if(!e.spatialReference.equals(this.spatialReference)||e.pixelSize!==this.pixelSize)return!1;const i=Math.min(this.levels.length,e.levels.length)-1,r=this.levels[i].resolution;let s=.5*r;return!DF(e.origin[0],this.origin[0],s)||!DF(e.origin[1],this.origin[1],s)?!1:(s=.5*r/2**i/this.pixelSize*WFe,DF(r,e.levels[i].resolution,s))}rootTilesInExtent(e,i=null,r=1/0){const s=new Array,n=this.levels[0].tileSize;if(A(e)||n[0]===0||n[1]===0)return s;yi.computeRowColExtent(e,n,this.origin,Du);let o=Du[1],a=Du[3],l=Du[0],c=Du[2];const h=c-l,p=a-o;if(h*p>r){const f=Math.floor(Math.sqrt(r));p>f&&(o=o+Math.floor(.5*p)-Math.floor(.5*f),a=o+f),h>f&&(l=l+Math.floor(.5*h)-Math.floor(.5*f),c=l+f)}for(let f=o;f<a;f++)for(let g=l;g<c;g++)s.push([0,f,g]);return _(i)&&(i[0]=this.origin[0]+l*n[0],i[1]=this.origin[1]-a*n[1],i[2]=this.origin[0]+c*n[0],i[3]=this.origin[1]-o*n[1]),s}static computeRowColExtent(e,i,r,s){const n=.001*(e[2]-e[0]+(e[3]-e[1]));s[0]=Math.max(0,Math.floor((e[0]+n-r[0])/i[0])),s[2]=Math.max(0,Math.ceil((e[2]-n-r[0])/i[0])),s[1]=Math.max(0,Math.floor((r[1]-e[3]+n)/i[1])),s[3]=Math.max(0,Math.ceil((r[1]-e[1]-n)/i[1]))}static isPowerOfTwo(e){const i=e.lods,r=i[0].resolution*2**i[0].level;return!i.some(function(s){return!ibe(s.resolution,r/2**s.level)})}static hasGapInLevels(e){const i=e.lods.map(function(r){return r.level});i.sort(function(r,s){return r-s});for(let r=1;r<i.length;r++)if(i[r]!==i[0]+r)return!0;return!1}static tileSizeSupported(e){const i=e.size[1];return i===e.size[0]&&(i&i-1)==0&&i>=128&&i<=512}static hasOriginPerLODs(e){const i=e.origin;return e.lods.some(r=>r.origin!=null&&(r.origin[0]!==i.x||r.origin[1]!==i.y))}static checkUnsupported(e){return A(e)?new Q("tilingscheme:tile-info-missing","Tiling scheme must have tiling information"):e.lods.length<1?new Q("tilingscheme:generic","Tiling scheme must have at least one level"):yi.isPowerOfTwo(e)?yi.hasGapInLevels(e)?new Q("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):yi.tileSizeSupported(e)?yi.hasOriginPerLODs(e)?new Q("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new Q("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new Q("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,i){const r=e[2]-e[0],s=e[3]-e[1],n=bo(i),o=1.2*Math.max(r,s),a=256,l=96,c=.0254,h=new yi(new xc({size:[a,a],origin:{x:e[0]-.5*(o-r),y:e[3]+.5*(o-s)},lods:[{level:0,resolution:o/a,scale:1/(a/l*c/(o*n))}],spatialReference:i}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(e){const i=new yi(yi.WebMercatorAuxiliarySphereTileInfo);return i.ensureMaxLod(e),i}static makeGCSWithTileSize(e,i=256,r=16){const s=256/i,n=new yi(new xc({size:[i,i],origin:{x:-180,y:90,spatialReference:e},spatialReference:e,lods:[{level:0,resolution:.703125*s,scale:295497598570834e-6*s}]}));return n.ensureMaxLod(r),n}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}yi.WebMercatorAuxiliarySphereTileInfo=new xc({size:[256,256],origin:{x:-20037508342787e-6,y:20037508342787e-6,spatialReference:Ue.WebMercator},spatialReference:Ue.WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527591555e-6}]}),yi.WebMercatorAuxiliarySphere=yi.makeWebMercatorAuxiliarySphere(19);const Du=pt(),z_=64,TS=512,ZFe=2.5,CS=rbe(FF/10),Ore=4,JFe=4,cE=t=>t<4?3:JFe,Rre=pt();yi.WebMercatorAuxiliarySphere.getExtent(0,0,0,Rre);const QFe=pt([-180,-90,180,90]),YFe="Cannot extend surface to encompass all layers because it would result in too many root tiles.",XFe="Surface extent is too large for tile resolution at level 0.",Ire="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED8xAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAA2JJREFUeNrs3d1O20AQgFFvRJInQLQBhHj/h0JVW34El1yQ2F73DVq3jTys55zrqUBbPrErZUSZ+vcOsto4AjK76Lqu1vr8+G3mPzjc3D/+eJj/Bcz/cd75R80fbu79BsAVCAQAAgABgABAACAAEAAIAAQAAgABQPOKfQAy83Ho+HnnHzXv49B4A4AAQAAgABAACAAEAAIAAYAAQAAgABAANM4+AKnZB4ifd/5R8/YB8AYAAYAAQAAgABAACAAEAAIAAYAAQAAgAGicfQBSsw8QP+/8o+btA+ANAAIAAYAAQAAgABAACAAEAAIAAYAAQADQOPsApGYfIH7e+UfN2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAXA201QdggAggH0AUrMPED8/jsPL03fns/y8fQC8AUAAIAAQAAgABAACAAGAAEAAIAAQAAgAGmcfgNTsA8TP2weImrcPgDcACAAEAAIAAYAAQAAgABAACAAEAAIAAUDj7AOQmn2A+Hn7AFHz9gHwBgABgABAACAAEAAIAAQAAgABgABgNS4cAf9pu9u3O1+m/n2aplKK/0j+TX86/tVP5+eZ3+729gFIfwWyDxA7bx8gat4+ANkJAAGAAEAAIAAQAAgABAACAAGAAEAAIABonn0AUrMPED9vHyBq3j4A3gAgABAACAAEAAIAAYAAQAAgABAA51VrdQgCAAHAsuwDkJp9gPj5vj+9vvx0PsvP2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAYAAoHH2AUjNPkD8vH2AqHn7AHgDgABAACAAEAAIAAQAAgABgABAACAAEAA0zj4AqdkHiJ+3DxA1bx8AbwAQACQ0DL0AyKuOowBwBYKUSikCIHUBAsAVCAQAAgABgABAALBy9gFIzT5A/Lx9gKj5y6trVyC8AUAAIAAQAAgAVq90Pg5N5gA2AsAVCAQAAgABgABAALB29gFIzT5A/Lx9gKj5q6+3rkB4A4AAQAAgABAACADWzB/IIHsCAsAVCARAlKlWhyAAEAAIABZjH4DU7APEz5+OH2+vT85n+fkvhztXILwBQAAgABAACAAEAGtWigBIHcBGALgCgQBAACAAyPMO9nHosxuHodZx5vB2t691HIdh/nx/Os7/Zsz/fvgXAAAA//8DAF1P1hM2ICMfAAAAAElFTkSuQmCC",uE=5,Dre=le.getLogger("esri.views.support.GroundViewElevationSampler");let Lf=class extends Ci.EventedAccessor{constructor(t){super(t),this.demResolution={min:-1,max:-1},this.noDataValue=CS}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const t=this.view.basemapTerrain;return _(t.extent)&&t.spatialReference?lP(t.extent,t.spatialReference):null}elevationAt(t){const e=t.spatialReference,i=this.spatialReference;if(!Rh(e,i)){const r=e?e.wkid:"unknown";return Dre.error(`Cannot sample elevation at a location with spatial reference (${r}) different from the view (${i.wkid})`),null}if(A(this.extent)||!ux(this.extent,t)){const r=_(this.extent)?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return Dre.warn("#elevationAt()",`Point used to sample elevation (${t.x}, ${t.y}) is outside of the sampler extent (${r})`),this.noDataValue}return wc(this.view.elevationProvider,t)}queryElevation(t){return Mre(t.clone(),this)}};u([d({readOnly:!0})],Lf.prototype,"demResolution",void 0),u([d({readOnly:!0})],Lf.prototype,"extent",null),u([d({readOnly:!0})],Lf.prototype,"noDataValue",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],Lf.prototype,"spatialReference",void 0),u([d({constructOnly:!0})],Lf.prototype,"view",void 0),Lf=u([R("esri.views.support.GroundViewElevationSampler")],Lf);const KFe=Lf;let kf=class extends ve{constructor(t){super(t),this.handles=new dt,this.view=null,this.layerViews=new We}initialize(){this.handles.add(NF(this,"view.map.ground",t=>t.load())),this.handles.add(this.layerViews.on("after-changes",()=>this.layerViewsAfterChangesHandler()))}destroy(){this._set("view",null),this.handles&&(this.handles.destroy(),this.handles=null)}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new KFe({view:this.view}):null:null}get updating(){return!this.suspended&&this.layerViews.some(t=>t.updating)}get suspended(){return!this.view||this.view.suspended}layerViewsAfterChangesHandler(){this.handles.remove("updating"),this.handles.add(this.layerViews.map(t=>t.watch("updating",()=>this.updateUpdating(),!0)).toArray(),"updating"),this.updateUpdating()}updateUpdating(){this.notifyChange("updating")}};u([d({readOnly:!0})],kf.prototype,"elevationSampler",null),u([d({type:Boolean,readOnly:!0})],kf.prototype,"updating",null),u([d({constructOnly:!0})],kf.prototype,"view",void 0),u([d({type:We,readOnly:!0})],kf.prototype,"layerViews",void 0),u([d({readOnly:!0})],kf.prototype,"suspended",null),kf=u([R("esri.views.GroundView")],kf);const e5e=kf,t5e=t=>{let e=class extends t{async fetchPopupFeatures(i,r){await this.when();const{location:s,queryArea:n,layerViewsAndGraphics:o,clientOnlyGraphics:a}=await this._prepareFetchPopupFeatures(i,r),l=Promise.resolve(a),c=this._queryLayerPopupFeatures(n,o,r),h=c.map(p=>p.promise);return{location:s,clientOnlyGraphics:a,allGraphicsPromise:l0e([l,...h]).then($ye),promisesPerLayerView:c}}_queryLayerPopupFeatures(i,r,s){return r.map(({layerView:n,graphics:o})=>{const a={clientGraphics:o,event:_(s)?s.event:null,signal:_(s)?s.signal:null,defaultPopupTemplateEnabled:!!_(s)&&!!s.defaultPopupTemplateEnabled},l=n.fetchPopupFeatures(i,a);return{layerView:n,promise:l}})}_isValidPopupGraphic(i,r){return i&&!!i.getEffectivePopupTemplate(_(r)&&r.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(i,r){const{clientGraphics:s,queryArea:n,location:o}=await this._popupHitTestGraphics(i,r),a=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:l,clientOnlyGraphics:c}=this._graphicsPerFetchPopupLayerView(s,a);return{clientOnlyGraphics:c,layerViewsAndGraphics:l,queryArea:n,location:o}}async _popupHitTestGraphics(i,r){const{results:s,mapPoint:n}=await this.popupHitTest(i),o=s.filter(l=>this._isValidPopupGraphic(l.graphic,r)),a=o.length?o[0].mapPoint:null;return{clientGraphics:o.map(l=>l.graphic),queryArea:n,location:n||a}}_getFetchPopupLayerViews(){const i=[];return this.allLayerViews.forEach(r=>{this._isValidPopupLayerView(r)&&i.push(r)}),_(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&i.push(this.graphicsView),i.reverse()}_isValidPopupLayerView(i){return _(i)&&(!("layer"in i)||!i.suspended)&&"fetchPopupFeatures"in i}_graphicsPerFetchPopupLayerView(i,r){const s=[],n=new Map,o=r.map(a=>{const l=[];return"layer"in a?n.set(a.layer,l):n.set(a.graphics,l),{layerView:a,graphics:l}});for(const a of i){const l=n.get(a.layer)||n.get(a.sourceLayer)||null;l?l.push(a):s.push(a)}return{layerViewsAndGraphics:o,clientOnlyGraphics:s}}};return e=u([R("esri.views.PopupView")],e),e};le.getLogger("esri.core.support.OwningCollection");let MS=class extends tu(We){constructor(t){super(t),this.handles.add([this.on("before-add",e=>{A(e.item)&&e.preventDefault()}),this.on("after-add",e=>this._own(e.item)),this.on("after-remove",e=>this._release(e.item))])}get owner(){return this._get("owner")}set owner(t){t!==this._get("owner")&&(this._releaseAll(),this._set("owner",t),this._ownAll())}_ownAll(){for(const t of this.items)this._own(t)}_releaseAll(){for(const t of this.items)this._release(t)}_createNewInstance(t){return this.itemType?new(We.ofType(this.itemType.Type))(t):new We(t)}};function V9(t,e){return{type:t,cast:KG,set(i){const r=vg(i,this._get(e),t);r.owner=this,this._set(e,r)}}}u([d()],MS.prototype,"owner",null),MS=u([R("esri.core.support.OwningCollection")],MS);let hE=class extends MS{_own(t){t.parent=this.owner}_release(t){t.parent=null}};hE=u([R("esri.support.AnalysesCollection")],hE);let r0=class extends MS{_own(t){t.layer&&"remove"in t.layer&&t.layer!==this.owner&&t.layer.remove(t),t.layer=this.owner}_release(t){t.layer===this.owner&&(t.layer=null)}};u([zD({Type:pn,ensureType:Ni(pn)})],r0.prototype,"itemType",void 0),r0=u([R("esri.support.GraphicsCollection")],r0);let zf=class extends ve{constructor(t){super(t),this.view=null,this.baseLayerViews=new We,this.referenceLayerViews=new We,this._loadingHandle=Ke(this,"view.map.basemap",e=>{e&&e.load().catch(()=>{})})}destroy(){this._set("view",null),this._loadingHandle&&(this._loadingHandle.remove(),this._loadingHandle=null)}get suspended(){return!this.view||this.view.suspended}get updating(){return(!this.view||!this.view.suspended)&&!(!(this.view&&this.view.map&&this.view.map.basemap)||this.view.map.basemap.loaded)}};u([d({constructOnly:!0})],zf.prototype,"view",void 0),u([d({readOnly:!0})],zf.prototype,"baseLayerViews",void 0),u([d({readOnly:!0})],zf.prototype,"referenceLayerViews",void 0),u([d({readOnly:!0})],zf.prototype,"suspended",null),u([d({type:Boolean,readOnly:!0})],zf.prototype,"updating",null),zf=u([R("esri.views.BasemapView")],zf);const i5e=le.getLogger("esri.views.LayerViewManager");class r5e{constructor(e,i,r){this.layer=e,this.view=i,this.layerViewImporter=r,this._controller=new AbortController,this._deferred=xp(),this._started=!1,this.done=!1,ps(this._controller.signal,()=>{const s=new Q("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(s)})}get promise(){return this._deferred.promise}destroy(){this._controller.abort();const{layerView:e}=this;if(!e)return;const{layer:i,view:r}=this;i.emit("layerview-destroy",{view:r,layerView:e}),r.emit("layerview-destroy",{layer:i,layerView:e}),this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null}async start(){if(this._started)return;this._started=!0;const{_controller:{signal:e},layer:i,view:r}=this;this._map=r.map;try{var s,n;let o,a;if(await i.load({signal:e}),"prefetchResources"in i&&await i.prefetchResources({signal:e}),i.createLayerView)o=await i.createLayerView(r,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(i))throw new Q("layer:view-not-supported","No layerview implementation was found");const c=await this.layerViewImporter.importLayerView(i);Dt(e),o="default"in c?new c.default({layer:i,view:r}):new c({layer:i,view:r})}const l=()=>{a=ln(a),o.destroyed||o.destroy(),o.layer=null,o.parent=null,o.view=null,this.done=!0};a=ps(e,l),Dt(e);try{await o.when()}catch(c){throw l(),c}if(!((s=this._map)==null||(n=s.allLayers)==null?void 0:n.includes(i)))return l(),void this._deferred.reject(new Q("view:no-layerview-for-layer","The layer has been removed from the map",{layer:i}));this.layerView=o,i.emit("layerview-create",{view:r,layerView:o}),r.emit("layerview-create",{layer:i,layerView:o}),this.done=!0,this._deferred.resolve(o)}catch(o){i.emit("layerview-create-error",{view:r,error:o}),r.emit("layerview-create-error",{layer:i,error:o}),this.done=!0,this._deferred.reject(new Q("layerview:create-error","layerview creation failed",{layer:i,error:o}))}}}let Ja=class extends e1{constructor(t){super(t),this._layerLayerViewInfoMap=new Map,this._watchUpdatingTracking=new zh,this.supportsGround=!0,this._preloadLayerViewModules=()=>{var e;const i=(e=this.view.map)==null?void 0:e.allLayers;if(i)for(const r of i)this.layerViewImporter.hasLayerViewModule(r)&&this.layerViewImporter.importLayerView(r)},this._reschedule=()=>(A(this._workPromise)&&(this._workPromise=xp()),this.handles.remove("reschedule"),this.handles.add(Yw(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{var e,i,r;const s=this.view.map;if(this._map!==s&&(this.clear(),this._map=s),A(this._workPromise))return void this.notifyChange("updating");this.handles.remove("reschedule"),this.handles.remove("collection-change");const n=new i1({getCollections:()=>this._rootCollectionNames.map(l=>this.get(l)),getChildrenFunction:l=>l&&"layers"in l?l.layers:null});if(!n)return this._workPromise.resolve(),void(this._workPromise=null);for(const l of n)this._createLayerView(l);this._refreshCollections();for(const[l,c]of this._layerLayerViewInfoMap)n.includes(l)||(this._layerLayerViewInfoMap.delete(c.layer),c.destroy());const o=n.filter(l=>l.type==="group").map(l=>l.layers),a=[s==null||(e=s.ground)==null?void 0:e.layers,s==null||(i=s.basemap)==null?void 0:i.baseLayers,s==null||(r=s.basemap)==null?void 0:r.referenceLayers,s==null?void 0:s.layers,...o].filter(l=>!!l);this.handles.add(a.map(l=>this._watchUpdatingTracking.addOnCollectionChange(l,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.handles.add([ks(this,"view.map.allLayers","change",this._preloadLayerViewModules,this._preloadLayerViewModules),Ke(this.view,["map.basemap","map.ground","map.layers","ready"],this._reschedule,!0)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),this._watchUpdatingTracking.destroy(),this._map=null}get _layersToLayerViews(){const t=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&t.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(t)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return _(this._workPromise)||this._watchUpdatingTracking.updating||vr(this._layerLayerViewInfoMap,t=>!t.done)}get updatingRemaining(){let t=0;for(const e of this._layerLayerViewInfoMap.values())e.done||++t;return t}clear(){if(!this.destroyed){for(const t of this._layerLayerViewInfoMap.values())t.destroy();this._layerLayerViewInfoMap.clear(),this._refreshCollections()}}async whenLayerView(t){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(t))throw new Q("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:t});return this._layerLayerViewInfoMap.get(t).promise}_refreshCollections(){for(const[t,e]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(t),this.get(e),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(t,e,i){if(!t||!e)return void(e&&e.removeAll());let r=0;for(const s of t){const n=this._layerLayerViewInfoMap.get(s);if(!n||!n.layerView)continue;const o=n.layerView;o.layer=s,o.parent=i,e.getItemAt(r)!==o&&e.splice(r,0,o),s.layers&&this._populateLayerViewsOwners(s.layers,o.layerViews,o),r+=1}r<e.length&&e.splice(r,e.length)}_createLayerView(t){if(this._layerLayerViewInfoMap.has(t))return this.view.ready&&this._layerLayerViewInfoMap.get(t).start(),this.notifyChange("updating"),void this.notifyChange("updatingRemaining");t.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(t)&&this.layerViewImporter.importLayerView(t);const e=new r5e(t,this.view,this.layerViewImporter);e.promise.then(()=>this._refreshCollections(),i=>{var r,s;i&&(bi(i)||i.name==="cancelled:layerview-create")||i5e.error(`Failed to create layerview for layer title:'${(r=t.title)!=null?r:"no title"}', id:'${(s=t.id)!=null?s:"no id"}' of type '${t.type}'.`,{layer:t,error:i}),this._refreshCollections()}),this._layerLayerViewInfoMap.set(t,e),this.view.ready&&e.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};u([d()],Ja.prototype,"_workPromise",void 0),u([d({readOnly:!0})],Ja.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],Ja.prototype,"_layersToLayerViews",null),u([d({readOnly:!0})],Ja.prototype,"_rootCollectionNames",null),u([d()],Ja.prototype,"layerViewImporter",void 0),u([d()],Ja.prototype,"supportsGround",void 0),u([d({readOnly:!0})],Ja.prototype,"updating",null),u([d({readOnly:!0})],Ja.prototype,"updatingRemaining",null),u([d({constructOnly:!0})],Ja.prototype,"view",void 0),Ja=u([R("esri.views.LayerViewManager")],Ja);const s5e=Ja;let ua=class extends ve{constructor(t){super(t),this.factor=1.5,this.offset=Zl(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};u([d({type:Number})],ua.prototype,"factor",void 0),u([d({nonNullable:!0})],ua.prototype,"offset",void 0),u([d()],ua.prototype,"position",void 0),u([d({type:Number,range:{min:0}})],ua.prototype,"size",void 0),u([d()],ua.prototype,"maskUrl",void 0),u([d()],ua.prototype,"maskEnabled",void 0),u([d()],ua.prototype,"overlayUrl",void 0),u([d()],ua.prototype,"overlayEnabled",void 0),u([d({readOnly:!0})],ua.prototype,"version",null),u([d({type:Boolean})],ua.prototype,"visible",void 0),ua=u([R("esri.views.Magnifier")],ua);const Fre=ua;let dE=class extends ve{constructor(){super(...arguments),this._tasks=new Array,this.running=!1}get length(){return this._tasks.length}destroy(){this.cancelAll()}runTask(t){for(;!t.done&&this._process(t);)t.madeProgress()}push(t,e,i){return this.running=!0,new Promise((r,s)=>this._tasks.push(new Lre(r,s,t,e,i)))}unshift(t,e,i){return this.running=!0,new Promise((r,s)=>this._tasks.unshift(new Lre(r,s,t,e,i)))}_process(t){if(this._tasks.length===0)return!1;const e=this._tasks.shift();try{const i=Ir(e.signal);if(i&&!e.abortCallback)e.reject($t());else{const r=i?e.abortCallback($t()):e.callback(t);ZC(r)?r.then(e.resolve,e.reject):e.resolve(r)}}catch(i){e.reject(i)}return this.running=this._tasks.length>0,!0}cancelAll(){const t=$t();for(const e of this._tasks)if(e.abortCallback){const i=e.abortCallback(t);e.resolve(i)}else e.reject(t);this._tasks.length=0,this.running=!1}};u([d()],dE.prototype,"running",void 0),dE=u([R("esri.layers.support.PromiseQueue")],dE);class Lre{constructor(e,i,r,s,n){this.resolve=e,this.reject=i,this.callback=r,this.signal=s,this.abortCallback=n}}let PS=class extends ve{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};u([d()],PS.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),u([d()],PS.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),PS=u([R("esri.views.support.DebugFlags")],PS);const n5e=new PS,o5e=le.getLogger("esri.views.support.Scheduler");function a5e(t){return new pE.Scheduler({nowFunc:t})}var Qe;(function(t){t.RESOURCE_CONTROLLER="schedule",t.SLIDE="slide",t.STREAM_DATA_LOADER="stream loader",t.ELEVATION_QUERY="elevation query",t.TERRAIN_SURFACE="terrain",t.SURFACE_GEOMETRY_UPDATES="surface geometry updates",t.GRAPHICS_CORE="Graphics3D",t.I3S_CONTROLLER="I3S",t.POINT_CLOUD_LAYER="point cloud",t.FEATURE_TILE_FETCHER="feature fetcher",t.OVERLAY="overlay",t.STAGE="stage",t.GRAPHICS_DECONFLICTOR="graphics deconflictor",t.FILTER_VISIBILITY="Graphics3D filter visibility",t.SCALE_VISIBILITY="Graphics3D scale visibility",t.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",t.POINT_OF_INTEREST_FREQUENT="POI frequent",t.POINT_OF_INTEREST_INFREQUENT="POI infrequent",t.LABELER="labeler",t.FEATURE_QUERY_ENGINE="feature query",t.FEATURE_TILE_TREE="feature tile tree",t.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",t.ELEVATION_ALIGNMENT="elevation alignment",t.TEXT_TEXTURE_ATLAS="text texture atlas",t.TEXTURE_UNLOAD="texture unload",t.LINE_OF_SIGHT_TOOL="line of sight tool",t.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",t.ELEVATION_PROFILE="elevation profile",t.SNAPPING="snapping",t.SHADOW_ACCUMULATOR="shadow accumulator",t.CLOUDS_GENERATOR="cloud generator",t[t.TEST_PRIO=1]="TEST_PRIO"})(Qe||(Qe={}));const Fu=0,kre=new Map([[Qe.RESOURCE_CONTROLLER,Fu],[Qe.SLIDE,Fu],[Qe.STREAM_DATA_LOADER,Fu],[Qe.ELEVATION_QUERY,Fu],[Qe.TERRAIN_SURFACE,1],[Qe.SURFACE_GEOMETRY_UPDATES,1],[Qe.GRAPHICS_CORE,2],[Qe.I3S_CONTROLLER,2],[Qe.POINT_CLOUD_LAYER,2],[Qe.FEATURE_TILE_FETCHER,2],[Qe.OVERLAY,4],[Qe.STAGE,4],[Qe.GRAPHICS_DECONFLICTOR,4],[Qe.FILTER_VISIBILITY,4],[Qe.SCALE_VISIBILITY,4],[Qe.FRUSTUM_VISIBILITY,4],[Qe.POINT_OF_INTEREST_FREQUENT,6],[Qe.POINT_OF_INTEREST_INFREQUENT,30],[Qe.LABELER,8],[Qe.FEATURE_QUERY_ENGINE,8],[Qe.FEATURE_TILE_TREE,16],[Qe.FEATURE_TILE_TREE_ACTIVE,Fu],[Qe.ELEVATION_ALIGNMENT,12],[Qe.TEXT_TEXTURE_ATLAS,12],[Qe.CLOUDS_GENERATOR,12],[Qe.TEXTURE_UNLOAD,12],[Qe.LINE_OF_SIGHT_TOOL,16],[Qe.LINE_OF_SIGHT_TOOL_INTERACTIVE,Fu],[Qe.SNAPPING,Fu],[Qe.SHADOW_ACCUMULATOR,30]]);function zre(t){return kre.has(t)?kre.get(t):typeof t=="number"?t:1}const Vre=Ft(6.5),Nre=Ft(1),l5e=Ft(30),Ure=Ft(1e3/30),jre=Ft(100),Bre=.9;var pE,s0;(function(t){let e=class extends ve{constructor(s){super(s),this.updating=!0,this._microTaskQueued=!1,this.performanceInfo={total:new wp("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=null,this._state=1,this._tasks=new ct,this._runQueue=new ct,this._load=0,this._idleStateCallbacks=new ct,this._idleUpdatesStartFired=!1,this._maxReschedule=fE,this._forceTask=!1,this._debug=!1,this._debugHandle=Ke(n5e,"SCHEDULER_LOG_SLOW_TASKS",a=>this._debug=a),this._budget=new r(s.nowFunc);for(const a of Object.keys(Qe))this.performanceInfo.tasks.set(Qe[a],new wp(Qe[a]));let n;const o=this;this._test={get state(){return st(n,o._state)},set state(a){n=a},FRAME_SAFETY_BUDGET:Vre,INTERACTING_BUDGET:Ure,IDLE_BUDGET:jre,get budget(){return o._budget.budget},usedBudget:0,setBudget:a=>o._budget=a,updateTask:a=>this._updateTask(a),getState:a=>this._getState(a),getRuntime:a=>this._getRuntime(a),frameTaskTimes:this._frameTaskTimes,resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._debugHandle&&this._debugHandle.remove(),this._microTaskQueued=!1}activate(){this._budget.done||this._microTaskQueued||(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.done||(this._maxReschedule=fE,this._schedule(),this.frame()))}))}registerTask(s,n){const o=zre(s),a=new i(this,s,n,o);return this._tasks.push(a),this.performanceInfo.tasks.has(s)||this.performanceInfo.tasks.set(s,new wp(s)),a}registerIdleStateCallbacks(s,n){const o={idleBegin:s,idleEnd:n};this._idleStateCallbacks.push(o),this.state===2&&this._idleUpdatesStartFired&&o.idleBegin();const a=this;return{remove:()=>this._removeIdleStateCallbacks(o),set idleBegin(l){a._idleUpdatesStartFired&&(o.idleEnd(),a._state===2&&l()),o.idleBegin=l},set idleEnd(l){o.idleEnd=l}}}get now(){return this.nowFunc()}get load(){return this._load}set state(s){this._state!==s&&(this._state=s,this.state!==2&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(n=>n.idleEnd())))}get state(){return A(this._test.state)?this._state:this._test.state}updateBudget(s){this._test.usedBudget=0;let n=Vre,o=s.frameDuration,a=Nre;switch(this.state){case 2:n=Ft(0),o=Ft(Math.max(jre,s.frameDuration)),a=l5e;break;case 1:o=Ft(Math.max(Ure,s.frameDuration))}return o=Ft(o-s.elapsedFrameTime-n),this.state!==2&&o<Nre&&!this._forceTask?(this._forceTask=!0,!1):(o=Ft(Math.max(o,a)),this._budget.reset(o,this.state),this._maxReschedule=fE,this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(s=>s.idleBegin())),this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset(Ft(0),this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(s){this._idleUpdatesStartFired&&s.idleEnd(),this._idleStateCallbacks.removeUnordered(s)}removeTask(s){this._tasks.removeUnordered(s),this._runQueue.removeUnordered(s)}_updateTask(s){this._tasks.forAll(n=>{n.name===s&&n.setPriority(s)})}_getState(s){if(this._runQueue.some(o=>o.name===s))return s0.SCHEDULED;let n=s0.IDLE;return this._tasks.forAll(o=>{o.name===s&&o.needsUpdate&&(o.schedulePriority<=1?n=s0.READY:n!==s0.READY&&(n=s0.WAITING))}),n}_getRuntime(s){let n=0;return this._tasks.forAll(o=>{o.name===s&&(n+=o.runtime)}),n}_resetRuntimes(){this._tasks.forAll(s=>s.runtime=0)}_getRunning(){const s=new Map;if(this._tasks.forAll(o=>{o.needsUpdate&&s.set(o.name,(s.get(o.name)||0)+1)}),s.size===0)return null;let n="";return s.forEach((o,a)=>{n+=o>1?` ${o}x ${a}`:` ${a}`}),n}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const s=this._tasks.reduce((n,o)=>o.needsUpdate?++n:n,0);this._load=this._load*Bre+s*(1-Bre)}_schedule(){if(this._maxReschedule<=0)return!1;for(this._runQueue.filterInPlace(s=>!!s.needsUpdate||(s.schedulePriority=s.basePriority,!1)),this._tasks.forAll(s=>{s.basePriority===Fu&&s.needsUpdate&&!this._runQueue.some(n=>n===s)&&this._runQueue.unshift(s)});this._runQueue.length===0;){let s=!1,n=0;if(this._tasks.forAll(o=>{o.needsUpdate&&o.schedulePriority!==0&&o.basePriority!==Fu&&(s=!0,n=Math.max(n,o.basePriority),o.schedulePriority===1?(o.schedulePriority=0,this._runQueue.push(o)):--o.schedulePriority)}),!s)return this.updating=!1,!1;this._maxReschedule===fE&&(this._maxReschedule=n),--this._maxReschedule}return this.updating=!0,!0}_run(){const s=this._budget.now();this._startFrameTaskTimes();do for(;this._runQueue.length>0;){const n=this._budget.now(),o=this._runQueue.pop();this._budget.resetProgress();try{o.task.runTask(this._budget)}catch(l){o5e.error(`Exception in task "${o.name}"`,l)}o.schedulePriority=o.basePriority;const a=this._budget.now()-n;if(o.runtime+=a,this._frameTaskTimes.set(o.priority,this._frameTaskTimes.get(o.priority)+a),this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",o.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return void this._recordFrameTaskTimes(this._budget.now()-s)}while(this._schedule());this._recordFrameTaskTimes(this._budget.now()-s)}_startFrameTaskTimes(){for(const s of Object.keys(Qe))this._frameTaskTimes.set(Qe[s],0)}_recordFrameTaskTimes(s){this._frameTaskTimes.forEach((n,o)=>this.performanceInfo.tasks.get(o).record(n)),this.performanceInfo.total.record(s)}get test(){return this._test}};u([d()],e.prototype,"updating",void 0),u([d()],e.prototype,"nowFunc",void 0),e=u([R("esri.views.support.Scheduler")],e),t.Scheduler=e;let i=class extends ve{constructor(s,n,o,a){super({}),this._scheduler=s,this.name=n,this._basePriority=a,this.runtime=0,this._queue=new dE,this._handles=new dt,this.schedulePriority=this._basePriority,this.task=_(o)?o:this._queue,this._handles.add(obe(()=>this.task.running,()=>s.activate()))}get updating(){return this._queue.running}normalizeCtorArgs(){return{}}remove(){this.processQueue(V_),this._scheduler.removeTask(this),this.schedule=N_.schedule,this.reschedule=N_.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(s){this.name=s;const n=zre(s);this._basePriority!==Fu&&this.schedulePriority===0||(this.schedulePriority=n),this._basePriority=n}get priority(){return this.name}set priority(s){this.setPriority(s)}get needsUpdate(){return this.updating||this.task.running}schedule(s,n,o){return this._queue.push(s,n,o)}reschedule(s,n,o){return this._queue.unshift(s,n,o)}processQueue(s){this._queue.runTask(s)}};u([d({constructOnly:!0})],i.prototype,"task",void 0),u([d({readOnly:!0})],i.prototype,"updating",null),i=u([R("esri.views.support.SchedulerTask")],i);class r{constructor(n){this.now=n,this._begin=0,this._budget=0,this._state=2,this._didWork=!1,this._enabled=!0}run(n){return!this.done&&(n()===!0&&(this._didWork=!0),!0)}get done(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}get budget(){return this._budget}madeProgress(){this._didWork=!0}get state(){return this._state}get enabled(){return this._enabled}set enabled(n){this._enabled=n}reset(n,o){this._begin=this.now(),this._budget=n,this._state=o,this._didWork=!1}get remaining(){return Math.max(this._budget-this.elapsed,0)}get elapsed(){return this.now()-this._begin}resetProgress(){this._didWork=!1}get hasProgressed(){return this._didWork}}t.Budget=r})(pE||(pE={})),function(t){t.SCHEDULED="s",t.READY="r",t.WAITING="w",t.IDLE="i"}(s0||(s0={}));const V_=(()=>{const t=new pE.Budget(()=>performance.now());return t.enabled=!1,t})();class c5e{remove(){}processQueue(){}schedule(e,i,r){try{if(Ir(i)){const s=$t();return r?Promise.resolve(r(s)):Promise.reject(s)}return _D(e(V_))}catch(s){return Promise.reject(s)}}reschedule(e,i,r){return this.schedule(e,i,r)}}const N_=new c5e,fE=Number.MAX_SAFE_INTEGER;class Gre{constructor(e,i){this._stage=e,this._textureRequests=new Map,this._frameTask=_(i)?i.registerTask(Qe.TEXTURE_UNLOAD):N_}destroy(){this._frameTask.remove(),this._textureRequests.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests.clear()}fromData(e,i){const r=this.makeUid(e);let s=this._textureRequests.get(r);return s||(s={referenceCount:0,texture:i(),textureAsync:null,abortController:null},this._stage&&(this._stage.add(s.texture),this._stage.loadSynchronous(s.texture)),this._textureRequests.set(r,s)),s.referenceCount++,{uid:r,texture:s.texture,release:()=>this._release(r)}}_release(e){if(!this._textureRequests)return;const i=this._textureRequests.get(e);i?(i.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),i.referenceCount--,i.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){if(!this._textureRequests)return;const i=this._textureRequests.get(e);!i||i.referenceCount>0||(this._releaseTextureRequest(i),this._textureRequests.delete(e))}_releaseTextureRequest(e){var i;e.texture?(i=this._stage)==null||i.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,i=null){return _(i)?`${e}.${i}px`:e}}const qre=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],Hre={};function Wre(t){return!!Hre[t]}function u5e(t){for(const e of t)if(!Wre(e))return!1;return!0}qre.forEach(t=>{Hre[t]=!0});class h5e{constructor(e){this.handlers=new Map,this.counter=0,this.handlerCounts=new Map,this.view=e,this.inputManager=null}connect(e){e&&this.disconnect(),this.inputManager=e,this.handlers.forEach(({handler:i,priority:r},s)=>this.inputManager.installHandlers(s,[i],r))}disconnect(){this.inputManager&&this.handlers.forEach((e,i)=>this.inputManager.uninstallHandlers(i)),this.inputManager=null}destroy(){this.disconnect(),this.handlers.clear(),this.view=null}on(e,i,r,s){const n=Array.isArray(e)?e:e.split(",");if(!u5e(n))return n.some(Wre)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let o,a;Array.isArray(i)?a=i:(o=i,a=[]),typeof r=="function"?o=r:s=r,s=s!=null?s:If.DEFAULT;const l=this.createUniqueGroupName(),c=new d5e(this.view,n,a,o);this.handlers.set(l,{handler:c,priority:s});for(const h of n){const p=this.handlerCounts.get(h)||0;this.handlerCounts.set(h,p+1)}return this.inputManager&&this.inputManager.installHandlers(l,[c],s),{remove:()=>this.removeHandler(l,n)}}hasHandler(e){return!!this.handlerCounts.get(e)}removeHandler(e,i){if(this.handlers.has(e)){this.handlers.delete(e);for(const r of i){const s=this.handlerCounts.get(r);s===void 0?console.error("Trying to remove handler for event that has no handlers registered: ",r):s===1?this.handlerCounts.delete(r):this.handlerCounts.set(r,s-1)}}this.inputManager&&this.inputManager.uninstallHandlers(e)}createUniqueGroupName(){return this.counter+=1,`viewEvents_${this.counter}`}}class d5e extends bs{constructor(e,i,r,s){super(!0),this.view=e;for(const n of i)switch(n){case"click":this.registerIncoming("click",r,o=>s(this.wrapClick(o)));break;case"double-click":this.registerIncoming("double-click",r,o=>s(this.wrapDoubleClick(o)));break;case"immediate-click":this.registerIncoming("immediate-click",r,o=>s(this.wrapImmediateClick(o)));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",r,o=>s(this.wrapImmediateDoubleClick(o)));break;case"hold":this.registerIncoming("hold",r,o=>s(this.wrapHold(o)));break;case"drag":this.registerIncoming("drag",r,o=>{const a=this.wrapDrag(o);a&&s(a)});break;case"key-down":this.registerIncoming("key-down",r,o=>s(this.wrapKeyDown(o)));break;case"key-up":this.registerIncoming("key-up",r,o=>s(this.wrapKeyUp(o)));break;case"pointer-down":this.registerIncoming("pointer-down",r,o=>s(this.wrapPointer(o,"pointer-down")));break;case"pointer-move":this.registerIncoming("pointer-move",r,o=>s(this.wrapPointer(o,"pointer-move")));break;case"pointer-up":this.registerIncoming("pointer-up",r,o=>s(this.wrapPointer(o,"pointer-up")));break;case"pointer-drag":this.registerIncoming("pointer-drag",r,o=>s(this.wrapPointerDrag(o)));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",r,o=>s(this.wrapMouseWheel(o)));break;case"pointer-enter":this.registerIncoming("pointer-enter",r,o=>s(this.wrapPointer(o,"pointer-enter")));break;case"pointer-leave":this.registerIncoming("pointer-leave",r,o=>s(this.wrapPointer(o,"pointer-leave")));break;case"gamepad":this.registerIncoming("gamepad",r,o=>{s(this.wrapGamepad(o))});break;case"focus":this.registerIncoming("focus",r,o=>{s(this.wrapFocus(o))});break;case"blur":this.registerIncoming("blur",r,o=>{s(this.wrapBlur(o))})}}wrapFocus(e){return{type:"focus",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:i=>e.async(i),preventDefault:()=>e.preventDefault()}}wrapBlur(e){return{type:"blur",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:i=>e.async(i),preventDefault:()=>e.preventDefault()}}wrapClick(e){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,{cancelable:c,timestamp:h}=e;return{type:"click",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:h,screenPoint:Zl(n,o),mapPoint:this.getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>e.stopPropagation(),async:p=>e.async(p),preventDefault:()=>e.preventDefault()}}wrapDoubleClick(e){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,{cancelable:c,timestamp:h}=e;return{type:"double-click",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:h,mapPoint:this.getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>e.stopPropagation(),async:p=>e.async(p),preventDefault:()=>e.preventDefault()}}wrapImmediateClick(e){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,c=a.pointerId,{cancelable:h,timestamp:p}=e;return{type:"immediate-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this.getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:f=>e.async(f),preventDefault:()=>e.preventDefault()}}wrapImmediateDoubleClick(e){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,c=a.pointerId,{cancelable:h,timestamp:p}=e;return{type:"immediate-double-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this.getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:f=>e.async(f),preventDefault:()=>e.preventDefault()}}wrapHold(e){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a}=e.data,{cancelable:l,timestamp:c}=e;return{type:"hold",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:c,mapPoint:this.getMapPoint(n,o),cancelable:l,stopPropagation:()=>e.stopPropagation(),async:h=>e.async(h),preventDefault:()=>e.preventDefault()}}getMapPoint(e,i){return this.view.toMap(Zl(e,i),{exclude:[]})}wrapDrag(e){const i=e.data,{x:r,y:s}=i.center,{action:n,pointerType:o,button:a}=i;if(n==="start"&&(this.latestDragStart=i),!this.latestDragStart)return;const l=i.pointer.native,c=i.buttons,{cancelable:h,timestamp:p}=e,f={x:this.latestDragStart.center.x,y:this.latestDragStart.center.y};return n==="end"&&(this.latestDragStart=void 0),{type:"drag",action:n,x:r,y:s,origin:f,pointerType:o,button:a,buttons:c,radius:i.radius,angle:go(i.angle),native:l,timestamp:p,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:g=>e.async(g),preventDefault:()=>e.preventDefault()}}wrapKeyDown(e){const{key:i,repeat:r,native:s}=e.data,{cancelable:n,timestamp:o}=e;return{type:"key-down",key:i,repeat:r,native:s,timestamp:o,cancelable:n,stopPropagation:()=>e.stopPropagation(),async:a=>e.async(a),preventDefault:()=>e.preventDefault()}}wrapKeyUp(e){const{key:i,native:r}=e.data,{cancelable:s,timestamp:n}=e;return{type:"key-up",key:i,native:r,timestamp:n,cancelable:s,stopPropagation:()=>e.stopPropagation(),async:o=>e.async(o),preventDefault:()=>e.preventDefault()}}wrapPointer(e,i){const{x:r,y:s,button:n,buttons:o,native:a,eventId:l}=e.data,c=a.pointerId,h=a.pointerType,{cancelable:p,timestamp:f}=e;return{type:i,x:r,y:s,pointerId:c,pointerType:h,button:n,buttons:o,native:a,timestamp:f,eventId:l,cancelable:p,stopPropagation:()=>e.stopPropagation(),async:g=>e.async(g),preventDefault:()=>e.preventDefault()}}wrapPointerDrag(e){const{x:i,y:r,buttons:s,native:n,eventId:o}=e.data.currentEvent,{button:a}=e.data.startEvent,l=e.data.startEvent.native.pointerId,c=e.data.startEvent.native.pointerType,h=e.data.action,p={x:e.data.startEvent.x,y:e.data.startEvent.y},{cancelable:f,timestamp:g}=e;return{type:"pointer-drag",x:i,y:r,pointerId:l,pointerType:c,button:a,buttons:s,action:h,origin:p,native:n,timestamp:g,eventId:o,cancelable:f,stopPropagation:()=>e.stopPropagation(),async:y=>e.async(y),preventDefault:()=>e.preventDefault()}}wrapMouseWheel(e){const{cancelable:i,data:r,timestamp:s}=e,{x:n,y:o,deltaY:a,native:l}=r;return{type:"mouse-wheel",x:n,y:o,deltaY:a,native:l,timestamp:s,cancelable:i,stopPropagation:()=>e.stopPropagation(),async:c=>e.async(c),preventDefault:()=>e.preventDefault()}}wrapGamepad(e){const{action:i,state:r,device:s}=e.data,{cancelable:n,timestamp:o}=e,{buttons:a,axes:l}=r;return{type:"gamepad",device:s,timestamp:o,action:i,buttons:a,axes:l,cancelable:n,stopPropagation:()=>e.stopPropagation(),async:c=>e.async(c),preventDefault:()=>e.preventDefault()}}}function p5e(t){return[t.on("after-add",e=>{const i=e.item;i.view&&i.view.ready&&!i.attached&&i.attach()}),t.on("after-remove",e=>{const i=e.item;i.active&&(i.view.activeTool=null),i.attached&&i.detach()})]}function mE(t){return t.visible&&t.getEditableFlag(0)&&t.getEditableFlag(1)}function Lu(t){return Zl(t.x,t.y)}function Zre(t,e){const i=(t instanceof HTMLElement?t:t.surface).getBoundingClientRect();return Zl(e.clientX-i.left,e.clientY-i.top)}function Jre(t,e){return e instanceof Event?Zre(t,e):Lu(e)}function Qre(t){if(t instanceof Event)return!0;if(typeof t=="object"&&"type"in t)switch(t.type){case"click":case"double-click":case"pointer-down":case"pointer-drag":case"pointer-enter":case"pointer-leave":case"pointer-up":case"pointer-move":case"immediate-click":case"immediate-double-click":case"hold":case"drag":case"mouse-wheel":return!0;default:return!1}return!1}class f5e{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._currentlyActiveTool=null,this._revertToActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}handleInputEvent(e,i){const r=()=>e.stopPropagation();switch(e.type){case"pointer-move":Yre(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(r(),e.action==="end"&&(this._stopDrag=!1));break;case"pointer-down":{if(!Xre(e))break;const s=Lu(e),n=this._intersect(s,e.pointerType,i.forEachTool);if(A(n))break;const o=this._findToolAndManipulatorByKey(n,i.forEachTool,gE),a=vp(o,c=>c.manipulator),l=vp(o,c=>c.tool);!(_(a)&&_(l)&&a.interactive)||a.grabbable&&a.grabbableForEvent(e)||!a.grabbing||a.dragging||this._ungrabManipulatorBeforeDragging(a,l,e),_(a)&&a.interactive&&a.grabbable&&a.grabbableForEvent(e)&&!a.grabbing&&(this._grabbedManipulators.set(e.pointerId,{key:n,start:s,pointerType:e.pointerType}),this._grabbedManipulators.size===1&&i.activeTool!==n.tool&&(this._currentlyActiveTool=i.activeTool,this._revertToActiveTool=!0,i.setActiveTool(n.tool)),a.grabbing=!0,a.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:s}),r());break}case"pointer-up":this._handlePointerEnd(e,i);break;case"pointer-drag":{if(!Xre(e))break;const s=this._grabbedManipulators.get(e.pointerId),n=this._draggedManipulators.get(e.pointerId),o=vp(s||n,({key:h})=>h),a=this._findManipulatorByKey(o,i.forEachTool);if(A(a))break;const l=Lu(e);l.x=Re(l.x,0,i.view.width),l.y=Re(l.y,0,i.view.height);const c=at(s||n).start;switch(e.action){case"start":case"update":e.action!=="update"&&this._grabbedManipulators.size!==1||(a.dragging=!0,n?a.events.emit("drag",{action:"update",start:c,screenPoint:l}):a.events.emit("drag",{action:"start",start:c,screenPoint:l,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{key:at(o),start:c}));break;case"end":a.dragging=!1,n&&a.events.emit("drag",{action:"end",start:c,screenPoint:l}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,i)}r();break}case"immediate-click":{const s=Lu(e),n=this._intersect(s,e.pointerType,i.forEachTool),o=this._findToolAndManipulatorByKey(n,i.forEachTool,gE);if(m5e(e)||i.forEachTool(h=>{if((!_(o)||o.tool!==h||h.automaticManipulatorSelection)&&h.manipulators){let p=!1;h.manipulators.forEach(({manipulator:f})=>{f.selected&&(f.selected=!1,p=!0)}),p&&h.manipulatorSelectionChanged&&h.manipulatorSelectionChanged()}}),A(o))break;const{manipulator:a,tool:l}=o;if(!a.interactive)break;a.selectable&&l.automaticManipulatorSelection&&(a.selected=!a.selected,l.manipulatorSelectionChanged&&l.manipulatorSelectionChanged());const c=e.native.shiftKey;a.events.emit("immediate-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:c,stopPropagation:r});break}case"click":{const s=Lu(e),n=this._intersect(s,e.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(A(o)||!o.interactive)break;const a=e.native.shiftKey;o.events.emit(e.type,{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a}),r();break}case"double-click":{const s=Lu(e),n=this._intersect(s,e.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(A(o)||!o.interactive)break;const a=e.native.shiftKey;o.events.emit("double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:r});break}case"immediate-double-click":{const s=Lu(e),n=this._intersect(s,e.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(A(o)||!o.interactive)break;const a=e.native.shiftKey;o.events.emit("immediate-double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:r});break}}this._updateCursor(i.forEachTool)}_ungrabManipulatorBeforeDragging(e,i,r){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:r.pointerType,screenPoint:Lu(r)}),this._grabbedManipulators.forEach(({key:s},n)=>{s.tool===i&&i.manipulators.findById(s.manipulatorId)===e&&this._grabbedManipulators.delete(n)})}_handlePointerEnd(e,i){const r=vp(this._grabbedManipulators.get(e.pointerId),({key:n})=>n),s=this._findManipulatorByKey(r,i.forEachTool);_(s)&&!s.dragging&&(this._grabbedManipulators.size===1&&this._draggedManipulators.size===0&&this._revertToActiveTool&&(i.setActiveTool(this._currentlyActiveTool),this._revertToActiveTool=!1,this._currentlyActiveTool=null),s.grabbing&&(s.grabbing=!1,s.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:Lu(e)})),this._grabbedManipulators.delete(e.pointerId))}_cursorFromMap(e,i){let r=null;return vr(e,({key:s})=>{const n=this._findManipulatorByKey(s,i);return!!(_(n)&&n.interactive&&"cursor"in n&&n.cursor)&&(r=n.cursor,!0)}),r}_updateCursor(e){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators,e)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators,e)||"pointer":this._cursor=null}clearPointers(e,i,r=!0,s){const n=o=>o.tool===e&&(A(s)||o.manipulatorId===s);this._grabbedManipulators.forEach(({key:o,pointerType:a},l)=>{if(n(o)){this._grabbedManipulators.delete(l);const c=this._findManipulatorByKey(o,i);_(c)&&(c.grabbing=!1,c.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:a}))}}),this._draggedManipulators.forEach(({key:o},a)=>{if(n(o)){this._draggedManipulators.delete(a);const l=this._findManipulatorByKey(o,i);_(l)&&(l.dragging=!1,l.events.emit("drag",{action:"cancel"}))}}),r&&this._hoveredManipulators.forEach(({key:o},a)=>{if(n(o)){this._hoveredManipulators.delete(a);const l=this._findManipulatorByKey(o,i);_(l)&&(l.hovering=!1)}}),this._updateCursor(i)}_intersect(e,i,r){let s=null;return r(n=>{if(n.manipulators==null||!mE(n))return!1;const o=n.manipulators.intersect(e,i);return!A(o)&&(s={manipulatorId:o.id,tool:n},!0)}),s}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach((i,r)=>{this._updateHoveredStateForPointerAtScreenPosition(Zl(i.x,i.y),r,i.pointerType,e)})}handleHoverEvent(e,i){e.type!=="pointer-up"&&e.type!=="immediate-click"&&e.type!=="pointer-move"||!Yre(e.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(Lu(e),e.pointerId,e.pointerType,i)}_updateHoveredStateForPointerAtScreenPosition(e,i,r,s){const n=this._intersect(e,r,s);let o=this._findManipulatorByKey(n,s);const a=vp(this._hoveredManipulators.get(i),({key:c})=>c),l=this._findManipulatorByKey(a,s);_(o)&&!o.interactive&&(o=null),l!==o&&(_(l)&&(l.hovering=!1),_(o)?(o.hovering=!0,this._hoveredManipulators.set(i,{key:at(n)})):this._hoveredManipulators.delete(i),this._updateCursor(s))}_findManipulatorByKey(e,i){return this._findToolAndManipulatorByKey(e,i,gE)?gE.manipulator:null}_findToolAndManipulatorByKey(e,i,r){return A(e)?null:(r.tool=null,r.manipulator=null,i(s=>{if(s!==e.tool||s.manipulators==null||!mE(s))return!1;const n=s.manipulators.findById(e.manipulatorId);return!!_(n)&&(r.manipulator=n,r.tool=s,!0)}),r.manipulator?r:null)}}function Yre(t){return t==="mouse"}function Xre(t){return t.pointerType!=="mouse"||t.button===0}function m5e(t){return!!t.native.shiftKey}const gE={manipulator:null,tool:null},N9=le.getLogger("esri.views.ToolViewManager"),Kre="attached",U9="tools";let dd=class extends e1{constructor(t){super(t),this._manipulatorState=new f5e,this.tools=new We,this.cursor=null,this._forEachTool=e=>{for(const i of this.tools.items)if(e(i))return}}initialize(){this.handles.add([this.view.on(qre,t=>{this._handleInputEvent(t)},If.TOOL),...p5e(this.tools),this.tools.on("before-add",t=>{const e=t.item;if(e==null||this.tools.includes(e))return N9.warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault()}),this.tools.on("before-remove",({item:t})=>{this._manipulatorState.clearPointers(t,this._forEachTool)}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this._forEachTool(t=>t.destroy())}set activeTool(t){if(_(t)&&!this.view.ready)return void N9.error("Cannot set active tool while view is not ready.");if(t===this.activeTool)return void(_(t)&&N9.warn("Tool is already active - ignoring activation request."));_(this.activeTool)&&this.activeTool.deactivate(),_(t)&&t.activate(),this._set("activeTool",t),this._removeIncompleteTools(t);const e=A(this.activeTool);for(const i of this.tools){i.setEditableFlag(1,e||i===this.activeTool);const r=mE(i);!e&&r||this._manipulatorState.clearPointers(i,this._forEachTool,!r)}this._updateCursor()}get updating(){return this.updatingHandles.updating||this.tools.some(t=>t.updating)}attach(){this._forEachTool(t=>t.attach()),this.view.type==="3d"?(this._set("textures",new Gre(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([this.view.state.watch("camera",()=>{this._forEachManipulator(t=>{t.onViewChange!=null&&t.onViewChange()})}),this.view.elevationProvider.on("elevation-change",t=>{this._forEachManipulator(e=>{e.onElevationChange!=null&&e.onElevationChange(t)})}),pg(()=>this._set("textures",tt(this.textures)))],Kre)):this.handles.add(this.view.watch("extent",()=>{this._forEachManipulator(t=>{t.onViewChange!=null&&t.onViewChange()})}))}detach(){_(this.activeTool)&&(this.activeTool=null),this._forEachTool(t=>{t.detach(),t.destroy()}),this.tools.removeAll(),this.handles.remove(Kre)}_forEachManipulator(t){this._forEachTool(e=>{e.manipulators&&e.manipulators.forEach(({manipulator:i})=>t(i,e))})}_handleInputEvent(t){let e=!1;const i=he(E({},t),{stopPropagation:()=>{e=!0,t.stopPropagation()}});_(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool(r=>{!e&&r.attached&&r.visible&&r.handleInputEvent(i)}),!e&&t.type==="key-down"&&t.key==="Escape"&&this.activeTool&&(t.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:r=>{this.activeTool=r},view:this.view}),!e&&_(this.activeTool)&&this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this.handles.remove(U9),this._forEachTool(t=>{if(t instanceof ve){const e=gi(t,["cursor","visible","editable"],()=>{mE(t)||this._manipulatorState.clearPointers(t,this._forEachTool),this._updateCursor()});this.handles.add(e,U9)}t.manipulators&&this.handles.add(t.manipulators.on("change",e=>{e.removed.forEach(({id:i})=>{this._manipulatorState.clearPointers(t,this._forEachTool,!0,i)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}),U9)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateCursor(){let t=this._manipulatorState.cursor;this._forEachTool(e=>!(!_(e.cursor)||!e.visible)&&(t=e.cursor,!0)),this._get("cursor")!==t&&this._set("cursor",t)}_removeIncompleteTools(t){this.tools.filter(e=>(A(t)||e!==t)&&!e.completed).forEach(e=>{this.tools.remove(e),e.destroy()})}};u([d({constructOnly:!0,nonNullable:!0})],dd.prototype,"view",void 0),u([d({readOnly:!0,nonNullable:!0})],dd.prototype,"textures",void 0),u([d({value:null})],dd.prototype,"activeTool",null),u([d({readOnly:!0,type:We})],dd.prototype,"tools",void 0),u([d({readOnly:!0})],dd.prototype,"cursor",void 0),u([d({readOnly:!0})],dd.prototype,"updating",null),dd=u([R("esri.views.ToolViewManager")],dd);const g5e=dd;let U_=class extends ve{constructor(t){super(),this.nativeIndex=null,this._detectedDeviceType="unknown",t.mapping==="standard"?this._detectedDeviceType="standard":y5e.test(t.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=t.index}get native(){return(navigator.getGamepads?navigator.getGamepads():[])[this.nativeIndex]}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return v5e[this.deviceType]}};u([d({nonNullable:!0,readOnly:!0})],U_.prototype,"nativeIndex",void 0),u([d({type:String,readOnly:!0})],U_.prototype,"deviceType",null),u([d({type:Number,readOnly:!0})],U_.prototype,"axisThreshold",null),U_=u([R("esri.views.input.gamepad.GamepadInputDevice")],U_);const y5e=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),v5e={standard:.15,spacemouse:.025,unknown:0},j9=U_;let AS=class extends ve{constructor(...t){super(...t),this.devices=new We,this.enabledFocusMode="document"}};u([d({type:We.ofType(j9),readOnly:!0})],AS.prototype,"devices",void 0),u([d({type:["document","view","none"]})],AS.prototype,"enabledFocusMode",void 0),AS=u([R("esri.views.input.gamepad.GamepadSettings")],AS);const _5e=AS;let yE=class extends ve{constructor(){super(...arguments),this.gamepad=new _5e}};u([d({readOnly:!0})],yE.prototype,"gamepad",void 0),yE=u([R("esri.views.input.Input")],yE);const b5e=yE;let Vf=class extends ve{constructor(t){super(t),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};u([d({type:Boolean,nonNullable:!0})],Vf.prototype,"enabled",void 0),u([d({type:j9})],Vf.prototype,"device",void 0),u([d({type:["pan","zoom"],nonNullable:!0})],Vf.prototype,"mode",void 0),u([d({type:["forward-down","forward-up"],nonNullable:!0})],Vf.prototype,"tiltDirection",void 0),u([d({type:Number,nonNullable:!0})],Vf.prototype,"velocityFactor",void 0),Vf=u([R("esri.views.navigation.gamepad.GamepadSettings")],Vf);const ese=Vf;let n0=class extends ve{constructor(t){super(t),this.browserTouchPanEnabled=!0,this.gamepad=new ese,this.momentumEnabled=!0,this.mouseWheelZoomEnabled=!0}};u([d({type:Boolean})],n0.prototype,"browserTouchPanEnabled",void 0),u([d({type:ese,nonNullable:!0})],n0.prototype,"gamepad",void 0),u([d({type:Boolean})],n0.prototype,"momentumEnabled",void 0),u([d({type:Boolean})],n0.prototype,"mouseWheelZoomEnabled",void 0),n0=u([R("esri.views.navigation.Navigation")],n0);const tse=n0;function w5e(t,e,i){const r=rse(t),s=e,n=x5e(r,s,i);{let o=null;if(r){const a=ay.deriveUnitFromSR(r,t.spatialReference).heightUnit;i||a===r.heightUnit||(o=new Q("layerview:unmatched-height-unit",`The vertical units of the layer must match the horizontal units (${a})`,{horizontalUnit:a}))}if(!S5e(t)||n===4||o)return new Q("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:r,error:o})}{let o=null;switch(n){case 1:{const a=r.heightUnit||"unknown",l=s.heightUnit||"unknown";o=new Q("layerview:incompatible-height-unit",`The vertical units of the layer (${a}) must match the vertical units of the scene (${l})`,{layerUnit:a,sceneUnit:l});break}case 2:{const a=r.heightModel||"unknown",l=s.heightModel||"unknown";o=new Q("layerview:incompatible-height-model",`The height model of the layer (${a}) must match the height model of the scene (${l})`,{layerHeightModel:a,sceneHeightModel:l});break}case 3:{const a=r.vertCRS||"unknown",l=s.vertCRS||"unknown";o=new Q("layerview:incompatible-vertical-datum",`The vertical datum of the layer (${a}) must match the vertical datum of the scene (${l})`,{layerDatum:a,sceneDatum:l});break}}if(o)return new Q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:o})}return null}function x5e(t,e,i){if(!ise(t)||!ise(e))return 4;if(t==null||e==null)return 0;if(!i&&t.heightUnit!==e.heightUnit)return 1;if(t.heightModel!==e.heightModel)return 2;switch(t.heightModel){case"gravity-related-height":return 0;case"ellipsoidal":return t.vertCRS===e.vertCRS?0:3;default:return 4}}function ise(t){return t==null||t.heightModel!=null&&t.heightUnit!=null}function S5e(t){return"heightModelInfo"in t&&t.heightModelInfo!=null||t.spatialReference!=null||!ose(t)}function rse(t){const e=t.url&&D2(t.url);return!((t.spatialReference&&t.spatialReference.vcsWkid)==null&&_(e)&&e.serverType==="ImageServer")&&sse(t)&&t.heightModelInfo?t.heightModelInfo:ose(t)?ay.deriveUnitFromSR(T5e,t.spatialReference):null}function sse(t){return"heightModelInfo"in t}function nse(t){if(t.type==="unknown"||!("capabilities"in t))return!1;switch(t.type){case"csv":case"feature":case"geojson":case"subtype-group":case"ogc-feature":case"wfs":return!0;default:return!1}}function ose(t){return nse(t)?!!(t.capabilities&&t.capabilities.data&&t.capabilities.data.supportsZ):lse(t)}function ase(t){return t.layers!=null||lse(t)||nse(t)||sse(t)}function lse(t){switch(t.type){case"building-scene":case"elevation":case"integrated-mesh":case"point-cloud":case"scene":case"voxel":return!0;case"analysis":case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"csv":case"geojson":case"feature":case"subtype-group":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"map-image":case"map-notes":case"ogc-feature":case"open-street-map":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"wcs":case"web-tile":case"wfs":case"wms":case"wmts":case null:return!1}return!1}const T5e=new ay({heightModel:"gravity-related-height"});function cse(t){return t==="global"?1:2}function $S(t){return t===1?"global":"local"}const use=10,hse=le.getLogger("esri.views.support.DefaultsFromMap");hse.level="info";let xi=class extends ve{constructor(t){super(t),this._handles=new dt,this.required={tileInfo:!1,heightModelInfo:!1,extent:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.priorityCollection=null,this.logDebugInformation=!1,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._handles=tt(this._handles),this._projectExtentTask.task&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=Rl(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return _(this.userSpatialReference)?this.userSpatialReference:at(this._spatialReferenceTask.spatialReference)}get extent(){return at(this._extentTask.extent)}get heightModelInfo(){return at(this._heightModelInfoTask.heightModelInfo)}get vcsWkid(){return at(this._heightModelInfoTask.vcsWkid)}get latestVcsWkid(){return at(this._heightModelInfoTask.latestVcsWkid)}get viewingMode(){return A(this.userSpatialReference)||this.userSpatialReference.equals(at(this._spatialReferenceTask.spatialReference))?at(this._spatialReferenceTask.viewingMode):null}get tileInfo(){return at(this._tileInfoTask.tileInfo)}get mapCollections(){var t,e,i,r;const s=(t=this.map)==null?void 0:t.call(this),n=[];return _(this.priorityCollection)&&n.push(this.priorityCollection),n.push({parent:s==null?void 0:s.basemap,layers:s==null||(e=s.basemap)==null?void 0:e.baseLayers},{layers:s==null?void 0:s.layers},{parent:s==null?void 0:s.ground,layers:s==null||(i=s.ground)==null?void 0:i.layers},{parent:s==null?void 0:s.basemap,layers:s==null||(r=s.basemap)==null?void 0:r.referenceLayers}),n}get _allLayers(){var t,e;const i=this._collectLayers(this.mapCollections);return this._debug("Collected",(t=(e=i.layers)==null?void 0:e.length)!=null?t:0,"layers, updating",i.updating),i}get _spatialReferenceTask(){var t,e;if(this.suspended)return(e=this._get("_spatialReferenceTask"))!=null?e:{updating:!1};const{layers:i,updating:r}=this._allLayers,s={candidates:null};for(const o of i)if(this._processSpatialReferenceCandidates(o,s),s.candidates&&s.candidates.length===1)break;if(((t=s.candidates)==null?void 0:t.length)!==1&&r)return{updating:!0};const n=this._pickSpatialReferenceCandidate(s.candidates);return this._debug("Finished spatial reference",_(n)?`${n.spatialReference.wkid}:${_(n.viewingMode)?$S(n.viewingMode):"global/local"}`:"none available"),{spatialReference:_(n)?n.spatialReference:null,viewingMode:_(n)?n.viewingMode:null,updating:!1}}get _tileInfoTask(){var t,e,i,r,s,n,o,a;if(!this.required.tileInfo)return(a=this._get("_tileInfoTask"))!=null?a:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:l,updating:c}=this._collectLayers([{parent:(t=this.map)==null||(e=t.call(this))==null?void 0:e.basemap,layers:(i=this.map)==null||(r=i.call(this))==null||(s=r.basemap)==null?void 0:s.baseLayers},{layers:(n=this.map)==null||(o=n.call(this))==null?void 0:o.layers}]);if(l&&l.length>0&&"tileInfo"in l[0]){const h=l[0].tileInfo;return{tileInfo:h&&h.spatialReference.equals(this.spatialReference)?h:null,updating:!1}}return{updating:c}}get _heightModelInfoTask(){var t,e;if(!this.required.heightModelInfo||this.suspended&&(t=this._get("_heightModelInfoTask"))!=null&&t.heightModelInfo)return(e=this._get("_heightModelInfoTask"))!=null?e:{updating:!1};const{layers:i,updating:r}=this._allLayers;for(const l of i){var s,n;if(this._debug("Considering",(s=(n=l.title)!=null?n:l.id)!=null?s:l.declaredClass,"for height model info"),ase(l)){const c=rse(l);var o,a;if(c)return this._debug("Derived height model info",c),{heightModelInfo:c,vcsWkid:(o=l.spatialReference)==null?void 0:o.vcsWkid,latestVcsWkid:(a=l.spatialReference)==null?void 0:a.latestVcsWkid,updating:!1}}this._debug("Layer does not support height models")}return this._debug("No height model info found,","updating",r),{updating:r}}get _extentCandidatesTask(){var t;if(this.suspended||!this.required.extent)return(t=this._get("_extentCandidatesTask"))!=null?t:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=this._allLayers,i=e.updating,r=[];for(const s of e.layers){const n="fullExtents"in s&&s.fullExtents||(_(s.fullExtent)?[s.fullExtent]:[]),o=n.find(a=>a.spatialReference.equals(this.spatialReference));if(o)return{candidates:[{extent:o,layer:s}],updating:!1};if(this._getSupportedSpatialReferences(s).length>0)for(const a of n)r.push({extent:a,layer:s})}return{candidates:r,updating:i}}get _extentTask(){const{candidates:t,updating:e}=this._extentCandidatesTask;if(e)return{updating:e};if(A(t)||t.length===0)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{candidate:i,requiresGeometryService:r}=this._pickExtentCandidate(t),s=this.spatialReference;if(i.extent.equals(this._projectExtentTask.input)&&s.equals(this._projectExtentTask.spatialReference))return{extent:this._projectExtentTask.output,updating:_(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished};if(_(this._projectExtentTask.task)&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=Rl(this._projectExtentTask.task)),!r){this._projectExtentTask={input:null,output:null,task:null,spatialReference:null};try{return{extent:f2(i.extent,s),updating:!1}}catch{return{updating:!1}}}return this._debug("Starting project extent task for",i.extent),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:s.clone(),task:Jw(async n=>{try{const o=await yD(Promise.resolve().then(function(){return MQe}),n),a=await o.projectGeometry(i.extent,s,i.layer.portalItem,n);this._debug("Project extent task finished",a),this._projectExtentTask=he(E({},this._projectExtentTask),{task:null,output:a})}catch{if(Ir(n))return;this._projectExtentTask=he(E({},this._projectExtentTask),{task:null})}})},{updating:!0}}_processSpatialReferenceCandidates(t,e){var i;const r=this._getSupportedSpatialReferences(t);if(r.length!==0)if(this._debug("Spatial reference candidates from",(i=t.title)!=null?i:t.id,":",r.map(s=>`${s.spatialReference.wkid}:${_(s.viewingMode)?$S(s.viewingMode):"global/local"}`).join(", ")),e.candidates){const s=[],n=(o,a)=>A(o.viewingMode)?a.viewingMode:(A(a.viewingMode)||o.viewingMode===a.viewingMode)&&o.viewingMode;for(const o of e.candidates)for(const a of r){if(!o.spatialReference.equals(a.spatialReference))continue;const l=n(o,a);if(l!==!1){s.push({spatialReference:o.spatialReference,viewingMode:l});break}}s.length>0&&(e.candidates=s)}else e.candidates=r}_pickSpatialReferenceCandidate(t){const e=this.defaultSpatialReference;return!t||t.length<1?_(e)?{spatialReference:e,viewingMode:null}:null:_(e)&&t.length>1&&t.some(({spatialReference:i})=>i.equals(e))?{spatialReference:e,viewingMode:null}:t[0]}_getSupportedSpatialReferences(t){const e="supportedSpatialReferences"in t&&t.supportedSpatialReferences||(t.spatialReference?[t.spatialReference]:[]);if(e.length===0)return[];const i=[];for(const r of e){const s=this.getSpatialReferenceSupport({spatialReference:r,layer:t});if(_(s)){const n=_(s.constraints)?s.constraints:[{spatialReference:r}];for(const{spatialReference:o,viewingMode:a}of n)(A(this.userSpatialReference)||o.equals(this.userSpatialReference))&&i.push({spatialReference:o,viewingMode:a})}}return i}_pickExtentCandidate(t){const e=this.spatialReference,i=t.find(({extent:r})=>O1(r.spatialReference,e)||fJ());return _(i)?{candidate:i,requiresGeometryService:!1}:{candidate:t[0],requiresGeometryService:!0}}_collectLayers(t){var e;if(this._loadMaybe((e=this.map)==null?void 0:e.call(this))!=="loaded")return{layers:[],updating:!0};const i={layers:[],preloading:-1,updating:!1};for(const r of t)if(this._collectCollection(r,i),i.preloading===use)break;return{layers:i.layers,updating:i.updating}}_collectCollection(t,e){if(t.layers){switch(this._loadMaybe(t.parent)){case"loading":return e.updating=!0,void++e.preloading;case"failed":return}for(const s of t.layers){switch(this._loadMaybe(s)){case"failed":continue;case"loading":e.updating=!0,++e.preloading;break;case"loaded":var i,r;e.updating||(this._debug("Considering layer",(i=(r=s.title)!=null?r:s.id)!=null?i:s.declaredClass),e.layers.push(s)),"layers"in s&&this._collectCollection({layers:s.layers},e)}if(e.preloading===use)break}}}_loadMaybe(t){return t&&"loadStatus"in t?t.loadStatus==="not-loaded"?(this._debug("Triggering load",(e=(i=t.title)!=null?i:t.id)!=null?e:t.declaredClass),t.load(),"loading"):t.loadStatus:"loaded";var e,i}_debug(...t){this.logDebugInformation&&hse.info(...t)}};u([d()],xi.prototype,"required",void 0),u([d({constructOnly:!0})],xi.prototype,"map",void 0),u([d({constructOnly:!0})],xi.prototype,"getSpatialReferenceSupport",void 0),u([d()],xi.prototype,"defaultSpatialReference",void 0),u([d()],xi.prototype,"userSpatialReference",void 0),u([d()],xi.prototype,"priorityCollection",void 0),u([d()],xi.prototype,"logDebugInformation",void 0),u([d()],xi.prototype,"suspended",void 0),u([d({readOnly:!0})],xi.prototype,"ready",null),u([d({readOnly:!0})],xi.prototype,"heightModelInfoReady",null),u([d({readOnly:!0})],xi.prototype,"spatialReference",null),u([d({readOnly:!0})],xi.prototype,"extent",null),u([d({readOnly:!0})],xi.prototype,"heightModelInfo",null),u([d({readOnly:!0})],xi.prototype,"vcsWkid",null),u([d({readOnly:!0})],xi.prototype,"latestVcsWkid",null),u([d({readOnly:!0})],xi.prototype,"viewingMode",null),u([d({readOnly:!0})],xi.prototype,"tileInfo",null),u([d({readOnly:!0})],xi.prototype,"mapCollections",null),u([d({readOnly:!0})],xi.prototype,"_allLayers",null),u([d({readOnly:!0})],xi.prototype,"_spatialReferenceTask",null),u([d({readOnly:!0})],xi.prototype,"_tileInfoTask",null),u([d({readOnly:!0})],xi.prototype,"_heightModelInfoTask",null),u([d({readOnly:!0})],xi.prototype,"_extentCandidatesTask",null),u([d()],xi.prototype,"_extentTask",null),u([d()],xi.prototype,"_projectExtentTask",void 0),xi=u([R("esri.views.support.DefaultsFromMap")],xi);const C5e=xi;var vE;const _E=le.getLogger("esri.views.View");let rt=vE=class extends tu(Ci.EventedMixin(rx(ve))){constructor(t){super(t),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new i1({getCollections:()=>{var e,i,r;return[(e=this.basemapView)==null?void 0:e.baseLayerViews,(i=this.groundView)==null?void 0:i.layerViews,this.layerViews,(r=this.basemapView)==null?void 0:r.referenceLayerViews]},getChildrenFunction:e=>e.layerViews}),this.groundView=null,this.animation=null,this.basemapView=null,this.fatalError=null,this.extent=null,this.graphics=new r0,this.analyses=new hE,this.navigating=!1,this.typeSpecificPreconditionsReady=!0,this.layerViews=new We,this.magnifier=new Fre,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new b5e,this.navigation=new tse,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new h5e(this),this.persistableViewModels=new We,this._isValid=!1,this._readyCycleForced=!1,this.handles.add(this.watch("preconditionsReady",e=>{var i,r;e?(this._currentSpatialReference=this.spatialReference,vE.views.add(this)):(this._currentSpatialReference=null,vE.views.remove(this)),this.notifyChange("spatialReference"),!e&&this.ready?((i=this.layerViewManager)==null||i.clear(),(r=this.toolViewManager)==null||r.detach(),_(this.analysisViewManager)&&this.analysisViewManager.detach(),this._teardown()):e&&!this.ready&&(_(this.analysisViewManager)&&this.analysisViewManager.attach(),this._startup(),this.toolViewManager.attach())},!0))}initialize(){this.addResolvingPromise(this.validate().then(()=>(this._isValid=!0,_x(this,"ready")))),this.basemapView=new zf({view:this}),this.layerViewManager=new s5e({view:this,layerViewImporter:{importLayerView:t=>this.importLayerView(t),hasLayerViewModule:t=>this.hasLayerViewModule(t)},supportsGround:this.supportsGround}),this.toolViewManager=new g5e({view:this}),this._setupSpatialReferenceLogger(),this.handles.add([hn(()=>this.initialExtentRequired,t=>this.defaultsFromMap.required=he(E({},this.defaultsFromMap.required),{extent:t}),{sync:!0,initial:!0}),hn(()=>this.ready,t=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=t,this.defaultsFromMap.userSpatialReference=t?this.spatialReference:this._userSpatialReference)},{sync:!0}),hn(()=>this._userSpatialReference,t=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=t)},{sync:!0,initial:!0})])}_setupSpatialReferenceLogger(){let t=null;this.handles.add([hn(()=>{var e;return(e=this.defaultsFromMap)==null?void 0:e.ready},e=>{var i;const r=((i=this.map)==null?void 0:i.allLayers.length)>0;if(e&&!this.spatialReference&&r){if(_(t))return;const s=pg(()=>t=Rl(t));t=Jw(async n=>{try{await Zw(this.spatialReferenceWarningDelay,null,n)}catch{return}finally{t=null}_E.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),this.handles.add(s,"spatial-reference-logger-task")}else this.handles.remove("spatial-reference-logger-task")},{sync:!0})])}destroy(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=tt(this.graphics),this.analyses=tt(this.analyses),this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.toolViewManager=tt(this.toolViewManager),this.layerViewManager=tt(this.layerViewManager),this.basemapView=tt(this.basemapView),this.invalidate(),this._emitter.clear(),this.handles.removeAll();const t=this.map;this.map=null,t==null||t.destroy()}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return _E.error("#toMap()","Not implemented on this instance of View"),null}get _defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new C5e(E({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:t=>this.getSpatialReferenceSupport(t)},this._defaultsFromMapSettings))}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get preconditionsReady(){var t;return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||Ph.isLoadable(this.map)&&!this.map.loaded||this.width===0||this.height===0||!this.spatialReference||!this.typeSpecificPreconditionsReady||!this._validateSpatialReference(this.spatialReference)||!(this._currentSpatialReference||(t=this.defaultsFromMap)!=null&&t.ready))}set map(t){var e;t!==this._get("map")&&((e=t)!=null&&e.destroyed&&(_E.warn("#map","The provided map is already destroyed",{map:t}),t=null),Ph.isLoadable(t)&&t.load().catch(()=>{}),this.initialized&&(this.forceReadyCycle(),this._currentSpatialReference=null),this._set("map",t))}get spatialReference(){var t,e;let i=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return i&&(t=this.defaultsFromMap)!=null&&(e=t.required)!=null&&e.heightModelInfo&&(i=i.clone(),i.vcsWkid=this.defaultsFromMap.vcsWkid,i.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),i}set spatialReference(t){this._userSpatialReference=t,this._set("spatialReference",t)}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get initialExtent(){var t;return(t=this.defaultsFromMap)==null?void 0:t.extent}get cursor(){const t=this.toolViewManager?this.toolViewManager.cursor:null;return _(t)?t:this._cursor||"default"}set cursor(t){this._cursor=t,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(t){return this.layerViewManager.whenLayerView(t)}getDefaultSpatialReference(){var t;return(t=this.defaultsFromMap)==null?void 0:t.spatialReference}getDefaultHeightModelInfo(){var t,e,i;return(t=(e=this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)!=null?e:(i=this.defaultsFromMap)==null?void 0:i.heightModelInfo)!=null?t:null}importLayerView(t){throw new Q("importLayerView() not implemented")}hasLayerViewModule(t){return!1}async validate(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{}}_validateSpatialReference(t){return _(this.getSpatialReferenceSupport({spatialReference:t}))}when(t,e){return this.isResolved()&&!this.ready&&_E.warn("#when()",'Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use watchUtils.whenOnce(view, "ready").then(...) instead.'),super.when(t,e)}forceReadyCycle(){this.ready&&(pbe(this,"preconditionsReady",()=>this._readyCycleForced=!1),this._readyCycleForced=!0)}addAndActivateTool(t){this.toolViewManager.tools.add(t),this.activeTool=t}tryFatalErrorRecovery(){this.fatalError=null}};rt.views=new We,u([d()],rt.prototype,"_userSpatialReference",void 0),u([Ve("toolViewManager.activeTool")],rt.prototype,"activeTool",void 0),u([d({readOnly:!0})],rt.prototype,"allLayerViews",void 0),u([d()],rt.prototype,"groundView",void 0),u([d()],rt.prototype,"animation",void 0),u([d()],rt.prototype,"basemapView",void 0),u([d({readOnly:!0})],rt.prototype,"_defaultsFromMapSettings",null),u([d()],rt.prototype,"defaultsFromMap",null),u([d()],rt.prototype,"fatalError",void 0),u([d({type:ht})],rt.prototype,"extent",void 0),u([d(V9(r0,"graphics"))],rt.prototype,"graphics",void 0),u([d(V9(hE,"analyses"))],rt.prototype,"analyses",void 0),u([d({readOnly:!0,type:ay})],rt.prototype,"heightModelInfo",null),u([d({readOnly:!0})],rt.prototype,"interacting",null),u([d({readOnly:!0})],rt.prototype,"navigating",void 0),u([d({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],rt.prototype,"preconditionsReady",null),u([d({readOnly:!0})],rt.prototype,"typeSpecificPreconditionsReady",void 0),u([d({type:We,readOnly:!0})],rt.prototype,"layerViews",void 0),u([d({type:Fre})],rt.prototype,"magnifier",void 0),u([d({value:null,type:jbe})],rt.prototype,"map",null),u([d()],rt.prototype,"padding",void 0),u([d({readOnly:!0})],rt.prototype,"ready",void 0),u([d({type:Ue})],rt.prototype,"spatialReference",null),u([d()],rt.prototype,"spatialReferenceWarningDelay",void 0),u([d()],rt.prototype,"stationary",null),u([d({readOnly:!0})],rt.prototype,"supportsGround",void 0),u([d({type:Su})],rt.prototype,"timeExtent",void 0),u([Ve("toolViewManager.tools")],rt.prototype,"tools",void 0),u([d()],rt.prototype,"toolViewManager",void 0),u([d({readOnly:!0})],rt.prototype,"type",void 0),u([d({type:Number})],rt.prototype,"scale",void 0),u([d({readOnly:!0})],rt.prototype,"updating",void 0),u([d({readOnly:!0})],rt.prototype,"initialExtentRequired",void 0),u([d({readOnly:!0,type:ht})],rt.prototype,"initialExtent",null),u([d()],rt.prototype,"cursor",null),u([d({readOnly:!0})],rt.prototype,"input",void 0),u([d({type:tse,nonNullable:!0})],rt.prototype,"navigation",void 0),u([d()],rt.prototype,"layerViewManager",void 0),u([d()],rt.prototype,"analysisViewManager",void 0),u([d()],rt.prototype,"width",void 0),u([d()],rt.prototype,"height",void 0),u([d({readOnly:!0})],rt.prototype,"resizing",void 0),u([d({value:null,readOnly:!0})],rt.prototype,"size",null),u([d({readOnly:!0})],rt.prototype,"suspended",void 0),u([d({readOnly:!0})],rt.prototype,"viewEvents",void 0),u([d({readOnly:!0})],rt.prototype,"persistableViewModels",void 0),u([d()],rt.prototype,"_isValid",void 0),u([d()],rt.prototype,"_readyCycleForced",void 0),u([d()],rt.prototype,"_currentSpatialReference",void 0),rt=vE=u([R("esri.views.View")],rt);const M5e=rt;let Nf=class extends lM{constructor(t){super(t),this.state="running",this.target=null}initialize(){this.addResolvingPromise(new Promise((t,e)=>this._dfd={resolve:t,reject:e}))}get done(){return this.state==="finished"||this.state==="stopped"}stop(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","stopped"),this._dfd.reject(new Q("ViewAnimation stopped")))}finish(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","finished"),this._dfd.resolve())}update(t,e){e||(e=fg(t)?"waiting-for-target":"running"),this._set("target",t),this._set("state",e)}};u([d({readOnly:!0})],Nf.prototype,"done",null),u([d({readOnly:!0,type:String})],Nf.prototype,"state",void 0),u([d()],Nf.prototype,"target",void 0),Nf=u([R("esri.views.ViewAnimation")],Nf),function(t){t.State={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}(Nf||(Nf={}));const j_=Nf,ES=()=>import("./TileLayerView3D.8a097bda.js"),dse=()=>Promise.resolve().then(function(){return WYe}),pse={analysis:()=>import("./AnalysisLayerView3D.6bd986c6.js"),"base-dynamic":()=>import("./BaseDynamicLayerView3D.e46f28f3.js"),"base-elevation":dse,"base-tile":ES,"bing-maps":ES,"building-scene":()=>import("./BuildingSceneLayerView3D.69cebcf4.js"),csv:()=>import("./CSVLayerView3D.e89f097c.js"),elevation:dse,feature:()=>import("./FeatureLayerView3D.90f6dfd2.js"),geojson:()=>import("./GeoJSONLayerView3D.6cc23102.js"),graphics:()=>import("./GraphicsLayerView3D.2a39ae2c.js"),group:()=>import("./GroupLayerView.2b7f22b2.js"),imagery:()=>import("./ImageryLayerView3D.27478296.js"),"integrated-mesh":()=>import("./IntegratedMeshLayerView3D.f443c0fd.js"),"map-image":()=>import("./MapImageLayerView3D.adfd9175.js"),"ogc-feature":()=>import("./OGCFeatureLayerView3D.9dbb8ef4.js"),"open-street-map":ES,"point-cloud":()=>import("./PointCloudLayerView3D.bc60b717.js").then(function(t){return t.P}),voxel:()=>import("./VoxelLayerView3D.b165f118.js"),scene:t=>t.profile==null||t.profile==="mesh-pyramids"?import("./SceneLayerView3D.a091f8fd.js"):import("./SceneLayerGraphicsView3D.e1345878.js"),stream:()=>import("./StreamLayerView3D.93c3e3f7.js"),tile:ES,"imagery-tile":()=>import("./ImageryTileLayerView3D.5ef65b16.js"),"vector-tile":()=>import("./VectorTileLayerView3D.91b3915b.js"),wcs:()=>import("./ImageryTileLayerView3D.5ef65b16.js"),"web-tile":ES,wfs:()=>import("./WFSLayerView3D.5467d59a.js"),wms:()=>import("./WMSLayerView3D.6df4b1da.js"),wmts:()=>import("./WMTSLayerView3D.317d1ff7.js"),"geo-rss":null,kml:null,"map-notes":null,route:null,"subtype-group":null,unknown:null,unsupported:null};function P5e(t){const e=t.declaredClass?t.declaredClass.slice(t.declaredClass.lastIndexOf(".")+1):"Unknown",i=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new Q(`${i}:view-not-supported`,`${e} is not supported in 3D`)}const fse={hasLayerViewModule:t=>_(pse[t.type]),importLayerView:t=>{const e=pse[t.type];if(!_(e))throw P5e(t);return e(t)}},A5e=le.getLogger("esri.views.3d.analysis.AnalysisViewManager3D"),mse="analyses-owner-handles";let o0=class extends tu(ve){constructor(t){super(t),this._allAnalysisViews=new We,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._analysisModules={"area-measurement":{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this.detach()}attach(){this.handles.add(this._connectOwner(this.view),mse)}detach(){this.handles.remove(mse),this._update(),this._creatingViewCount=0}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(t=>t.updating)}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}whenAnalysisView(t){const e=this._items.get(t);if(A(e)||e.state.list===1){const i=new Q("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to the scene.",{analysis:t});return Promise.reject(i)}return e.createAnalysisViewTask.promise}_connectOwner(t){return this._connectAnalysesCollection(t.analyses)}_connectAnalysesCollection(t){for(const r of t)this._addAnalysis(r);const e=t.on("after-add",r=>this._addAnalysis(r.item)),i=t.on("after-remove",r=>this._removeAnalysis(r.item));return{remove:()=>{e.remove(),i.remove();for(const r of t)this._removeAnalysis(r)}}}_addAnalysis(t){const e=this._items.get(t);if(e==null){const i={state:{view:0,list:0},analysis:t,view:null,createAnalysisViewTask:null};this._items.set(t,i),i.createAnalysisViewTask=Jw(r=>this._createAnalysisViewPromise(i,r))}else e.state.list=0}_removeAnalysis(t){const e=this._items.get(t);e!=null?(e.state.list=1,this._scheduleUpdate()):A5e.error("Trying to remove analysis which was not added")}_scheduleUpdate(){_(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=Yw(()=>this._update()))}_update(){this._scheduledUpdateHandle=ln(this._scheduledUpdateHandle),this._items.forEach(t=>{if(t.state.list===1)switch(this._items.delete(t.analysis),t.state.view){case 0:t.createAnalysisViewTask=Rl(t.createAnalysisViewTask);break;case 1:_(t.view)&&(this._allAnalysisViews.remove(t.view),t.view=tt(t.view),t.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(t,e){const i=t.analysis,r=i.type,s=this._analysisModules[r];if(this._creatingViewCount+=1,A(s.module))try{s.module=await this._loadAnalysisModule(r)}catch(o){throw this._creatingViewCount-=1,o}if(Ir(e))throw this._creatingViewCount-=1,$t("AnalysisView creation aborted");const n=new s.module.default({analysis:i,view:this.view});try{await n.when()}catch(o){throw this._creatingViewCount-=1,o}if(Ir(e))throw this._creatingViewCount-=1,n.destroy(),$t("AnalysisView creation aborted");return t.view=n,t.state.view=1,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_loadAnalysisModule(t){switch(t){case"area-measurement":return import("./AreaMeasurementView3D.e9f04dd4.js").then(function(e){return e.A});case"direct-line-measurement":return import("./DirectLineMeasurementView3D.7dfa956a.js").then(function(e){return e.D});case"line-of-sight":return import("./LineOfSightView3D.0320d90f.js");case"slice":return import("./SliceView3D.c2dadb8b.js").then(function(e){return e.S});default:return null}}};u([d()],o0.prototype,"updating",null),u([d({constructOnly:!0})],o0.prototype,"view",void 0),u([d()],o0.prototype,"_allAnalysisViews",void 0),u([d()],o0.prototype,"_creatingViewCount",void 0),o0=u([R("esri.views.3d.analysis.AnalysisViewManager3D")],o0);const $5e=o0,E5e=le.getLogger("esri.views.3d.state.Constraints");let pd=class extends ve{constructor(t){super(t),this.collision=new OS,this.distance=1/0,this.minimumPoiDistance=4}get altitude(){return this.mode===2?null:this._get("altitude")||null}set altitude(t){this.mode!==2?this._set("altitude",t):E5e.warn("Altitude constraint is ignored in local scenes")}clampAltitude(t){return this.altitude?Re(t,this.altitude.min,this.altitude.max):t}clampTilt(t,e){if(!this.tilt)return e;const i=this.tilt(t);return Re(e,i.min,i.max)}clampDistance(t){return Math.min(t,this.distance)}createDefaultTilt(){return this.mode===2?this.createDefaultTiltLocal():this.createDefaultTiltGlobal()}createConstantMaxTilt(t){return(e,i=B9)=>(i.min=ws.min,i.max=t,i)}createDefaultTiltLocal(){const t=this.collision.enabled?jM([[4e3,ws.max],[1e4,nt(88)],[6e6,nt(88)]]):()=>ws.max;return(e,i=B9)=>(i.min=ws.min,i.max=t(e),i)}createDefaultTiltGlobal(){const t=this.collision.enabled?jM([[4e3,ws.max],[5e4,nt(88)],[6e6,nt(88)],[2e7,ws.min]]):jM([[3e5,ws.max],[3e6,nt(88)],[6e6,nt(88)],[2e7,ws.min]]);return(e,i=B9)=>(i.min=ws.min,i.max=t(e),i)}};function O5e(t){return{min:-2e5,max:4*t.radius}}u([d()],pd.prototype,"altitude",null),u([d({readOnly:!0})],pd.prototype,"collision",void 0),u([d()],pd.prototype,"distance",void 0),u([d({readOnly:!0})],pd.prototype,"minimumPoiDistance",void 0),u([d()],pd.prototype,"tilt",void 0),u([d({constructOnly:!0})],pd.prototype,"mode",void 0),pd=u([R("esri.views.3d.state.Constraints")],pd);const gse=O5e(Lt),ws={min:nt(.5),max:nt(179.5)},B9={min:0,max:0};let OS=class extends ve{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};u([d({type:Boolean})],OS.prototype,"enabled",void 0),u([d({type:Number})],OS.prototype,"elevationMargin",void 0),OS=u([R("esri.views.3d.state.Constraints.CollisionConstraint")],OS);const R5e=pd;let RS=class extends ve{constructor(){super(...arguments),this.min=gse.min,this.max=gse.max}set mode(t){hg(le.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"})}get mode(){return hg(le.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"}),"manual"}};u([d({type:Number})],RS.prototype,"min",void 0),u([d({type:Number})],RS.prototype,"max",void 0),RS=u([R("esri.views.3d.constraints.AltitudeConstraint")],RS);const yse=RS;let Uf=class extends ve{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(t){this._set("near",t),t>=this._get("far")&&(this.far=t+1e-9),this.mode="manual"}castNear(t){return Math.max(1e-8,t)}get far(){return this._get("far")}set far(t){this._set("far",t),t<=this._get("near")&&(this.near=t-1e-9),this.mode="manual"}castFar(t){return Math.max(1e-8,t)}autoUpdate(t,e){this.mode==="auto"&&(this._get("near")!==t&&this._set("near",t),this._get("far")!==e&&this._set("far",e))}};u([d({type:Number,value:1e-8})],Uf.prototype,"near",null),u([ut("near")],Uf.prototype,"castNear",null),u([d({type:Number,value:1e-8})],Uf.prototype,"far",null),u([ut("far")],Uf.prototype,"castFar",null),u([d({type:["auto","manual"]})],Uf.prototype,"mode",void 0),Uf=u([R("esri.views.3d.constraints.ClipDistanceConstraint")],Uf);const vse=Uf,G9={min:go(ws.min),max:go(ws.max)};let B_=class extends ve{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(t){this._set("max",t),this.mode="manual"}castMax(t){return Re(t,G9.min,G9.max)}autoUpdate(t){this.mode==="auto"&&this._get("max")!==t&&this._set("max",t)}};u([d({type:["auto","manual"]})],B_.prototype,"mode",void 0),u([d({type:Number,value:G9.max})],B_.prototype,"max",null),u([ut("max")],B_.prototype,"castMax",null),B_=u([R("esri.views.3d.constraints.TiltConstraint")],B_);const _se=B_;let G_=class extends ve{constructor(){super(...arguments),this.tilt=new _se,this.altitude=new yse,this.clipDistance=new vse}};u([d({type:_se})],G_.prototype,"tilt",void 0),u([d({type:yse})],G_.prototype,"altitude",void 0),u([d({type:vse})],G_.prototype,"clipDistance",void 0),G_=u([R("esri.views.3d.constraints.Constraints")],G_);const bse=G_;var q9;let bE=q9=class extends ve{set quality(t){["low","high"].indexOf(t)!==-1&&this._set("quality",t)}clone(){return new q9({quality:this.quality})}};u([d({type:["low","high"],value:"low"})],bE.prototype,"quality",null),bE=q9=u([R("esri.views.3d.environment.SceneViewAtmosphere")],bE);const wse=bE;var H9;let Sc=H9=class extends ge{constructor(t){super(t),this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(t,e){return e.datetime!=null&&new Date(e.datetime)||null}writeDate(t,e,i){e[i]=t.getTime()}readDirectShadowsEnabled(t,e){return!!e.directShadows}writedirectShadowsEnabled(t,e,i){t&&(e[i]=t)}writeDisplayUTCOffset(t,e){t!=null&&(e.displayUTCOffset=t)}clone(){return new H9(this.cloneConstructProperties())}cloneConstructProperties(){const t={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:this.displayUTCOffset!=null?this.displayUTCOffset:null};return this.date!=null&&(t.date=new Date(this.date.getTime())),t}};u([d({type:Date,json:{type:Number,write:{target:"datetime"}}})],Sc.prototype,"date",void 0),u([Ce("date",["datetime"])],Sc.prototype,"readDate",null),u([Ee("date")],Sc.prototype,"writeDate",null),u([d({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],Sc.prototype,"directShadowsEnabled",void 0),u([Ce("directShadowsEnabled",["directShadows"])],Sc.prototype,"readDirectShadowsEnabled",null),u([Ee("directShadowsEnabled")],Sc.prototype,"writedirectShadowsEnabled",null),u([d({type:Number,json:{write:!0}})],Sc.prototype,"displayUTCOffset",void 0),u([Ee("displayUTCOffset")],Sc.prototype,"writeDisplayUTCOffset",null),Sc=H9=u([R("esri.webscene.Lighting")],Sc);const IS=Sc;var wE;let ha=wE=class extends Ci.EventedMixin(IS){constructor(t){super(t),this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0},this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1;const e=new Date().getFullYear(),i=new Date("March 15, "+e+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}static fromWebsceneLighting(t){return new wE(E({},t.cloneConstructProperties()))}get defaultDate(){return new Date(this._get("defaultDate").getTime())}set defaultDate(t){const e=this._get("date")===this._get("defaultDate");t=new Date(t.getTime()),this._set("defaultDate",t),e&&this._set("date",t)}set date(t){t!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(t.getTime())))}autoUpdate(t,e){const i=xse(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=e.hours,this.positionTimezoneInfo.minutes=e.minutes,this.positionTimezoneInfo.seconds=e.seconds;let r=null;t!=null&&(this.positionTimezoneInfo.autoUpdated=!0,r=this.date&&this.date.getTime(),this._set("date",new Date(t.getTime())));const s=xse(this.positionTimezoneInfo);if(i!==s&&(W9.target=this,W9.timezoneOffset=s,this.emit("timezone-will-change",W9)),t!=null)return r!==t.getTime()}clone(){const t=this._get("date")===this._get("defaultDate"),e=new wE(he(E({},this.cloneConstructProperties()),{defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled}));return t&&e._set("date",e._get("defaultDate")),e.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,e.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,e.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,e.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,e}cloneWithWebsceneLighting(t){const e=this.clone();return t.date!=null&&(e.date=t.date),e.directShadowsEnabled=t.directShadowsEnabled,e.displayUTCOffset=t.displayUTCOffset,e}};function xse({hours:t,minutes:e,seconds:i}){return Math.round(t+e/60+i/3600)}u([d({type:Boolean})],ha.prototype,"cameraTrackingEnabled",void 0),u([d({type:Boolean})],ha.prototype,"ambientOcclusionEnabled",void 0),u([d({type:Boolean})],ha.prototype,"waterReflectionEnabled",void 0),u([d({type:Date})],ha.prototype,"defaultDate",null),u([d({type:Date})],ha.prototype,"date",null),ha=wE=u([R("esri.views.3d.environment.SceneViewLighting")],ha);const W9={target:null,timezoneOffset:0};var Z9;let DS=Z9=class extends ge{constructor(t){super(t),this.type="sunny",this.cloudCover=.5}clone(){return new Z9({cloudCover:this.cloudCover})}};u([Xe({sunny:"sunny"})],DS.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],DS.prototype,"cloudCover",void 0),DS=Z9=u([R("esri.views.3d.environment.SunnyWeather")],DS);const Sse=DS;var J9;let FS=J9=class extends ve{constructor(t){super(t),this.type="cloudy",this.cloudCover=.5}clone(){return new J9({cloudCover:this.cloudCover})}};u([Xe({cloudy:"cloudy"})],FS.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],FS.prototype,"cloudCover",void 0),FS=J9=u([R("esri.views.3d.environment.CloudyWeather")],FS);const I5e=FS;var Q9;let LS=Q9=class extends ve{constructor(t){super(t),this.type="foggy",this.fogStrength=.5}clone(){return new Q9({fogStrength:this.fogStrength})}};u([Xe({foggy:"foggy"})],LS.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],LS.prototype,"fogStrength",void 0),LS=Q9=u([R("esri.views.3d.environment.FoggyWeather")],LS);const D5e=LS;var Y9;let kS=Y9=class extends ve{constructor(t){super(t),this.type="rainy",this.cloudCover=.5}clone(){return new Y9({cloudCover:this.cloudCover})}};u([Xe({rainy:"rainy"})],kS.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],kS.prototype,"cloudCover",void 0),kS=Y9=u([R("esri.views.3d.environment.RainyWeather")],kS);const F5e=kS,L5e={key:"type",base:null,typeMap:{sunny:Sse,cloudy:I5e,rainy:F5e,foggy:D5e}};let xE=class extends ge{constructor(t){super(t)}clone(){}};u([d({readOnly:!0,json:{read:!1}})],xE.prototype,"type",void 0),xE=u([R("esri.webscene.background.Background")],xE);const Tse=xE;var X9;const k5e=he(E({},Up),{nonNullable:!0});let zS=X9=class extends Tse{constructor(t){super(t),this.type="color",this.color=new Ae([0,0,0,1])}clone(){return new X9(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};u([Xe({color:"color"},{readOnly:!0})],zS.prototype,"type",void 0),u([d(k5e)],zS.prototype,"color",void 0),zS=X9=u([R("esri.webscene.background.ColorBackground")],zS);const Cse=zS,Mse={base:Tse,key:"type",typeMap:{color:Cse}};function z5e(t){return(e,i,r)=>{if(!e)return e;for(const s in t.typeMap)if(e.type===s){const n=new t.typeMap[s];return n.read(e,r),n}}}const V5e={types:Mse,json:{read:z5e(Mse),write:{overridePolicy:(t,e,i)=>({enabled:!i||!i.isPresentation})}}};var K9;const Pse=(t,e,i)=>({enabled:!i||!i.isPresentation});let a0=K9=class extends ge{constructor(t){super(t),this.lighting=new IS,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}clone(){return new K9(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:IS.prototype.clone.call(this.lighting),background:ie(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled}}};u([d({type:IS,json:{write:!0}})],a0.prototype,"lighting",void 0),u([d(V5e)],a0.prototype,"background",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Pse}}})],a0.prototype,"atmosphereEnabled",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Pse}}})],a0.prototype,"starsEnabled",void 0),a0=K9=u([R("esri.webscene.Environment")],a0);const Ase=a0;var VS;let l0=VS=class extends Ase{constructor(t){super(t),this.atmosphere=new wse,this.weather=new Sse}static fromWebsceneEnvironment(t){const e=t.cloneConstructProperties();return new VS(he(E({},e),{lighting:ha.fromWebsceneLighting(e.lighting)}))}castLighting(t){return this.convertLighting(t)}applyLighting(t){this.lighting=this.convertLighting(t)}convertLighting(t){return t?t instanceof ha?t:t instanceof IS?this.lighting?this.lighting.cloneWithWebsceneLighting(t):ha.fromWebsceneLighting(t):Ni(ha,t):new ha}clone(){return new VS({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:ie(this.background)})}cloneWithWebsceneEnvironment(t){return new VS(he(E({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:ie(this.background)},t.cloneConstructProperties()),{lighting:this.lighting!=null?this.lighting.cloneWithWebsceneLighting(t.lighting):ha.fromWebsceneLighting(t.lighting)}))}};u([d({type:wse,json:{read:!1},nonNullable:!0})],l0.prototype,"atmosphere",void 0),u([d({types:L5e,nonNullable:!0,json:{write:!1}})],l0.prototype,"weather",void 0),u([d()],l0.prototype,"lighting",void 0),u([ut("lighting")],l0.prototype,"castLighting",null),l0=VS=u([R("esri.views.3d.environment.SceneViewEnvironment")],l0);const q_=l0;function os(t,e){return t[0]=e[0],t[1]=e[1],t}function si(t,e,i){return t[0]=e,t[1]=i,t}function Tc(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t}function ku(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t}function $se(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t}function Ese(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t}function N5e(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t}function U5e(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t}function j5e(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t}function B5e(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t}function G5e(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t}function Ao(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t}function q5e(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t}function H_(t,e){const i=e[0]-t[0],r=e[1]-t[1];return Math.sqrt(i*i+r*r)}function SE(t,e){const i=e[0]-t[0],r=e[1]-t[1];return i*i+r*r}function eV(t){const e=t[0],i=t[1];return Math.sqrt(e*e+i*i)}function Ose(t){const e=t[0],i=t[1];return e*e+i*i}function tV(t,e){return t[0]=-e[0],t[1]=-e[1],t}function H5e(t,e){return t[0]=1/e[0],t[1]=1/e[1],t}function NS(t,e){const i=e[0],r=e[1];let s=i*i+r*r;return s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s),t}function Sr(t,e){return t[0]*e[0]+t[1]*e[1]}function W5e(t,e,i){const r=e[0]*i[1]-e[1]*i[0];return t[0]=t[1]=0,t[2]=r,t}function W_(t,e,i,r){const s=e[0],n=e[1];return t[0]=s+r*(i[0]-s),t[1]=n+r*(i[1]-n),t}function Z5e(t,e){e=e||1;const i=2*jl()*Math.PI;return t[0]=Math.cos(i)*e,t[1]=Math.sin(i)*e,t}function iV(t,e,i){const r=e[0],s=e[1];return t[0]=i[0]*r+i[2]*s,t[1]=i[1]*r+i[3]*s,t}function c0(t,e,i){const r=e[0],s=e[1];return t[0]=i[0]*r+i[2]*s+i[4],t[1]=i[1]*r+i[3]*s+i[5],t}function J5e(t,e,i){const r=e[0],s=e[1];return t[0]=i[0]*r+i[3]*s+i[6],t[1]=i[1]*r+i[4]*s+i[7],t}function Q5e(t,e,i){const r=e[0],s=e[1];return t[0]=i[0]*r+i[4]*s+i[12],t[1]=i[1]*r+i[5]*s+i[13],t}function Y5e(t,e,i,r){const s=e[0]-i[0],n=e[1]-i[1],o=Math.sin(r),a=Math.cos(r);return t[0]=s*a-n*o+i[0],t[1]=s*o+n*a+i[1],t}function X5e(t,e){const i=t[0],r=t[1],s=e[0],n=e[1];let o=i*i+r*r;o>0&&(o=1/Math.sqrt(o));let a=s*s+n*n;a>0&&(a=1/Math.sqrt(a));const l=(i*s+r*n)*o*a;return l>1?0:l<-1?Math.PI:Math.acos(l)}function K5e(t){return"vec2("+t[0]+", "+t[1]+")"}function Rse(t,e){return t[0]===e[0]&&t[1]===e[1]}function eLe(t,e){const i=t[0],r=t[1],s=e[0],n=e[1];return Math.abs(i-s)<=it*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-n)<=it*Math.max(1,Math.abs(r),Math.abs(n))}function tLe(t,e,i,r,s){let n=e[0]-i[0],o=e[1]-i[1];const a=(r[0]*n+r[1]*o)*(s-1);return n=r[0]*a,o=r[1]*a,t[0]=e[0]+n,t[1]=e[1]+o,t}const iLe=eV,rLe=ku,sLe=$se,nLe=Ese,Ise=H_,oLe=SE,aLe=Ose;Object.freeze({__proto__:null,copy:os,set:si,add:Tc,subtract:ku,multiply:$se,divide:Ese,ceil:N5e,floor:U5e,min:j5e,max:B5e,round:G5e,scale:Ao,scaleAndAdd:q5e,distance:H_,squaredDistance:SE,length:eV,squaredLength:Ose,negate:tV,inverse:H5e,normalize:NS,dot:Sr,cross:W5e,lerp:W_,random:Z5e,transformMat2:iV,transformMat2d:c0,transformMat3:J5e,transformMat4:Q5e,rotate:Y5e,angle:X5e,str:K5e,exactEquals:Rse,equals:eLe,projectAndScale:tLe,len:iLe,sub:rLe,mul:sLe,div:nLe,dist:Ise,sqrDist:oLe,sqrLen:aLe});function Dse(t){const e=1e5,i=1e6;return Math.min(1,Math.max(0,(t-e)/(i-e)))}const rV=1e4,Z_=De(5802e-9,13558e-9,331e-7),sV=3,nV=De(65e-8*sV,1881e-9*sV,85e-9*sV),lLe=3996e-9,cLe=.085,TE=1e5;function x(t,...e){let i="";for(let r=0;r<e.length;r++)i+=t[r]+e[r];return i+=t[t.length-1],i}(function(t){function e(r){return Math.round(r).toString()}function i(r){return r.toPrecision(8)}t.int=e,t.float=i})(x||(x={}));function fd(t,e){e.attributeTextureCoordinates===1&&(t.attributes.add("uv0","vec2"),t.varyings.add("vuv0","vec2"),t.vertex.code.add(x`void forwardTextureCoordinates() {
vuv0 = uv0;
}`)),e.attributeTextureCoordinates===2&&(t.attributes.add("uv0","vec2"),t.varyings.add("vuv0","vec2"),t.attributes.add("uvRegion","vec4"),t.varyings.add("vuvRegion","vec4"),t.vertex.code.add(x`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`)),e.attributeTextureCoordinates===0&&t.vertex.code.add(x`void forwardTextureCoordinates() {}`)}function zu(t){t.code.add(x`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}
const vec4 RGBA_2_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, RGBA_2_FLOAT_FACTORS);
}`)}function Lr(t){t.include(zu),t.code.add(x`float linearDepthFromFloat(float depth, vec2 nearFar) {
return -(depth * (nearFar[1] - nearFar[0]) + nearFar[0]);
}
float linearDepthFromTexture(sampler2D depthTex, vec2 uv, vec2 nearFar) {
return linearDepthFromFloat(rgba2float(texture2D(depthTex, uv)), nearFar);
}`)}function oV(t){t.fragment.code.add(x`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}const uLe=le.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class Fse{constructor(){this.includedModules=new Map}include(e,i){this.includedModules.has(e)?this.includedModules.get(e)!==i&&uLe.error("Trying to include shader module multiple times with different sets of options."):(this.includedModules.set(e,i),e(this.builder,i))}}class pi extends Fse{constructor(){super(...arguments),this.vertex=new Lse,this.fragment=new Lse,this.attributes=new pLe,this.varyings=new fLe,this.extensions=new J_,this.constants=new er}get fragmentUniforms(){return this.fragment.uniforms}get builder(){return this}generateSource(e){const i=this.extensions.generateSource(e),r=this.attributes.generateSource(e),s=this.varyings.generateSource(),n=e==="vertex"?this.vertex:this.fragment,o=n.uniforms.generateSource(),a=n.code.generateSource(),l=e==="vertex"?gLe:mLe,c=this.constants.generateSource().concat(n.constants.generateSource());return`
${i.join(`
`)}

${l}

${c.join(`
`)}

${o.join(`
`)}

${r.join(`
`)}

${s.join(`
`)}

${a.join(`
`)}`}}class hLe{constructor(){this._entries=new Map}add(e,i,r){const s=`${e}_${i}_${r}`;return this._entries.set(s,{name:e,type:i,arraySize:r}),this}generateSource(){const e=i=>i?`[${i}]`:"";return Array.from(this._entries.values()).map(i=>`uniform ${i.type} ${i.name}${e(i.arraySize)};`)}get entries(){return Array.from(this._entries.values())}}class dLe{constructor(){this._entries=new Array}add(e){this._entries.push(e)}generateSource(){return this._entries}}class Lse extends Fse{constructor(){super(...arguments),this.uniforms=new hLe,this.code=new dLe,this.constants=new er}get builder(){return this}}class pLe{constructor(){this._entries=new Array}add(e,i){this._entries.push([e,i])}generateSource(e){return e==="fragment"?[]:this._entries.map(i=>`attribute ${i[1]} ${i[0]};`)}}class fLe{constructor(){this._entries=new Array}add(e,i){this._entries.push([e,i])}generateSource(){return this._entries.map(e=>`varying ${e[1]} ${e[0]};`)}}class J_{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const i=e==="vertex"?J_.ALLOWLIST_VERTEX:J_.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(r=>i.includes(r)).map(r=>`#extension ${r} : enable`)}}J_.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],J_.ALLOWLIST_VERTEX=[];class er{constructor(){this._entries=[]}add(e,i,r){let s="ERROR_CONSTRUCTOR_STRING";switch(i){case"float":s=er.numberToFloatStr(r);break;case"int":s=er.numberToIntStr(r);break;case"bool":s=r.toString();break;case"vec2":s=`vec2(${er.numberToFloatStr(r[0])},                            ${er.numberToFloatStr(r[1])})`;break;case"vec3":s=`vec3(${er.numberToFloatStr(r[0])},                            ${er.numberToFloatStr(r[1])},                            ${er.numberToFloatStr(r[2])})`;break;case"vec4":s=`vec4(${er.numberToFloatStr(r[0])},                            ${er.numberToFloatStr(r[1])},                            ${er.numberToFloatStr(r[2])},                            ${er.numberToFloatStr(r[3])})`;break;case"ivec2":s=`ivec2(${er.numberToIntStr(r[0])},                             ${er.numberToIntStr(r[1])})`;break;case"ivec3":s=`ivec3(${er.numberToIntStr(r[0])},                             ${er.numberToIntStr(r[1])},                             ${er.numberToIntStr(r[2])})`;break;case"ivec4":s=`ivec4(${er.numberToIntStr(r[0])},                             ${er.numberToIntStr(r[1])},                             ${er.numberToIntStr(r[2])},                             ${er.numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":s=`${i}(${Array.prototype.map.call(r,n=>er.numberToFloatStr(n)).join(", ")})`}return this._entries.push(`const ${i} ${e} = ${s};`),this}static numberToIntStr(e){return e.toFixed(0)}static numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}}const mLe=`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp sampler2D;
#else
  precision mediump float;
  precision mediump sampler2D;
#endif`,gLe=`precision highp float;
precision highp sampler2D;`;function yLe(t){const e=new pi;return e.attributes.add("position","vec2"),e.include(fd,{attributeTextureCoordinates:1}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3"),e.vertex.uniforms.add("projectionInverse","mat4"),e.vertex.uniforms.add("viewInverse","mat4"),e.vertex.code.add(x`void main(void) {
vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),e.fragment.uniforms.add("lightingMainDirection","vec3").add("radii","vec2").add("scaleHeight","float").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4").add("innerFadeDistance","float").add("altitudeFade","float").add("depthTex","sampler2D").add("betaRayleigh","vec3").add("betaCombined","vec3").add("betaMie","float").add("hazeStrength","float"),e.include(oV),t.haze&&e.fragment.include(Lr),e.fragment.code.add(x`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),e.fragment.code.add(x`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),e.fragment.code.add(x`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),e.fragment.code.add(x`
    const int STEPS = 6;

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${t.haze?x`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${t.haze?x``:" mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${t.haze?"":x`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.05968310365 * mumu;

      ${t.haze?x`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:x`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.11936620731 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${t.haze?x`
          vec4 depthSample = texture2D(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:x`
          float depthSample = texture2D(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            gl_FragColor = vec4(0);
            return;
          }`}

      ${t.haze?x`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);
            }
            float alpha = 1.0 - fadeOut;`:x`
            vec3 col = getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);;
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      gl_FragColor = delinearizeGamma(vec4(col, alpha));
      ${t.haze?"":x`
          if (depthSample == 1.0) {
            gl_FragColor = applyUndergroundAtmosphere(rayDir, lightingMainDirection, gl_FragColor);
          }`}
    }
  `),e}const vLe=Object.freeze({__proto__:null,build:yLe});class vi{constructor(e,i){this._module=e,this._loadModule=i}get(){return this._module}async reload(){return this._module=await this._loadModule(),this._module}}class Si{constructor(e,i,r=()=>this.dispose()){this.release=r,i&&(this._config=i.snapshot()),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e)}dispose(){this._program=Ge(this._program),this._pipeline=this._config=null}reload(e){Ge(this._program),this._program=this.initializeProgram(e)}get program(){return this._program}get key(){return this._config.key}get configuration(){return this._config}bindPass(e,i){}bindMaterial(e,i){}bindDraw(e){}bindPipelineState(e,i=null,r){e.setPipelineState(this.getPipelineState(i,r))}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}get primitiveType(){return 4}getPipelineState(e,i){return this._pipeline}}class tr{constructor(){this._key="",this._keyDirty=!1,this._parameterBits=this._parameterBits?this._parameterBits.map(()=>0):[],this._parameterNames||(this._parameterNames=[])}get key(){return this._keyDirty&&(this._keyDirty=!1,this._key=String.fromCharCode.apply(String,this._parameterBits)),this._key}snapshot(){const e=this._parameterNames,i={key:this.key};for(const r of e)i[r]=this[r];return i}}function X(t={}){return(e,i)=>{var r,s;e._parameterNames=(r=e._parameterNames)!=null?r:[],e._parameterNames.push(i);const n=e._parameterNames.length-1,o=t.count||2,a=Math.ceil(Math.log2(o)),l=(s=e._parameterBits)!=null?s:[0];let c=0;for(;l[c]+a>16;)c++,c>=l.length&&l.push(0);e._parameterBits=l;const h=l[c],p=(1<<a)-1<<h;l[c]+=a,Object.defineProperty(e,i,{get(){return this[n]},set(f){if(this[n]!==f&&(this[n]=f,this._keyDirty=!0,this._parameterBits[c]=this._parameterBits[c]&~p|+f<<h&p,typeof f!="number"&&typeof f!="boolean"))throw"Configuration value for "+i+" must be boolean or number, got "+typeof f}})}}const Ht=new Map([["position",0],["normal",1],["uv0",2],["color",3],["size",4],["tangent",4],["auxpos1",5],["symbolColor",5],["auxpos2",6],["featureAttribute",6],["instanceFeatureAttribute",6],["instanceColor",7],["model",8],["modelNormal",12],["modelOriginHi",11],["modelOriginLo",15]]),_Le=le.getLogger("esri/views/webgl");function bLe(t,e){switch(e){case t.INVALID_ENUM:return"Invalid Enum. An unacceptable value has been specified for an enumerated argument.";case t.INVALID_VALUE:return"Invalid Value. A numeric argument is out of range.";case t.INVALID_OPERATION:return"Invalid Operation. The specified command is not allowed for the current state.";case t.INVALID_FRAMEBUFFER_OPERATION:return"Invalid Framebuffer operation. The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case t.OUT_OF_MEMORY:return"Out of memory. Not enough memory is left to execute the command.";case t.CONTEXT_LOST_WEBGL:return"WebGL context has been lost";default:return"Unknown error"}}const kse=!!ae("enable-feature:webgl-debug");function u0(){return kse}function CE(){return kse}function jf(t){if(u0()){const e=t.getError();if(e){const i=bLe(t,e),r=new Error().stack;_Le.error(new Q("webgl-error","WebGL error occured",{message:i,stack:r}))}}}const aV=33984;var kr;(function(t){t[t.Texture=0]="Texture",t[t.Buffer=1]="Buffer",t[t.VAO=2]="VAO",t[t.VertexShader=3]="VertexShader",t[t.FragmentShader=4]="FragmentShader",t[t.Program=5]="Program",t[t.Framebuffer=6]="Framebuffer",t[t.Renderbuffer=7]="Renderbuffer",t[t.COUNT=8]="COUNT"})(kr||(kr={}));const zse=33306,wLe=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"];var Vse,Nse={exports:{}};(Vse=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"])!==void 0&&(Nse.exports=Vse);const xLe=Nse.exports;var Use,jse={exports:{}};Use=jse,function(t){var e=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"];e!==void 0&&(Use.exports=e)}();const Bse=jse.exports;var Gse={exports:{}};(function(t){(function(e){var i=function(){return["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT"]}();i!==void 0&&(t.exports=i)})()})(Gse);const SLe=Gse.exports;var Cc=999,qse=9999,lV=0,cV=1,Hse=2,Wse=3,Zse=4,ME=5,TLe=6,CLe=7,MLe=8,Jse=9,PLe=10,Qse=11,ALe=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function $Le(){var t,e,i,r=0,s=0,n=Cc,o=[],a=[],l=1,c=0,h=0,p=!1,f=!1,g="";return function(k){return a=[],k!==null?v(k.replace?k.replace(/\r\n/g,`
`):k):b()};function y(k){k.length&&a.push({type:ALe[n],data:k,position:h,line:l,column:c})}function v(k){var j;for(r=0,i=(g+=k).length;t=g[r],r<i;){switch(j=r,n){case lV:r=M();break;case cV:r=C();break;case Hse:r=T();break;case Wse:r=P();break;case Zse:r=D();break;case Qse:r=z();break;case ME:r=U();break;case qse:r=G();break;case Jse:r=S();break;case Cc:r=w()}j!==r&&(g[j]===`
`?(c=0,++l):++c)}return s+=r,g=g.slice(r),a}function b(k){return o.length&&y(o.join("")),n=PLe,y("(eof)"),a}function w(){return o=o.length?[]:o,e==="/"&&t==="*"?(h=s+r-1,n=lV,e=t,r+1):e==="/"&&t==="/"?(h=s+r-1,n=cV,e=t,r+1):t==="#"?(n=Hse,h=s+r,r):/\s/.test(t)?(n=Jse,h=s+r,r):(p=/\d/.test(t),f=/[^\w_]/.test(t),h=s+r,n=p?Zse:f?Wse:qse,r)}function S(){return/[^\s]/g.test(t)?(y(o.join("")),n=Cc,r):(o.push(t),e=t,r+1)}function T(){return t!=="\r"&&t!==`
`||e==="\\"?(o.push(t),e=t,r+1):(y(o.join("")),n=Cc,r)}function C(){return T()}function M(){return t==="/"&&e==="*"?(o.push(t),y(o.join("")),n=Cc,r+1):(o.push(t),e=t,r+1)}function P(){if(e==="."&&/\d/.test(t))return n=ME,r;if(e==="/"&&t==="*")return n=lV,r;if(e==="/"&&t==="/")return n=cV,r;if(t==="."&&o.length){for(;F(o););return n=ME,r}if(t===";"||t===")"||t==="("){if(o.length)for(;F(o););return y(t),n=Cc,r+1}var k=o.length===2&&t!=="=";if(/[\w_\d\s]/.test(t)||k){for(;F(o););return n=Cc,r}return o.push(t),e=t,r+1}function F(k){for(var j,V,q=0;;){if(j=Bse.indexOf(k.slice(0,k.length+q).join("")),V=Bse[j],j===-1){if(q--+k.length>0)continue;V=k.slice(0,1).join("")}return y(V),h+=V.length,(o=o.slice(V.length)).length}}function z(){return/[^a-fA-F0-9]/.test(t)?(y(o.join("")),n=Cc,r):(o.push(t),e=t,r+1)}function D(){return t==="."||/[eE]/.test(t)?(o.push(t),n=ME,e=t,r+1):t==="x"&&o.length===1&&o[0]==="0"?(n=Qse,o.push(t),e=t,r+1):/[^\d]/.test(t)?(y(o.join("")),n=Cc,r):(o.push(t),e=t,r+1)}function U(){return t==="f"&&(o.push(t),e=t,r+=1),/[eE]/.test(t)||t==="-"&&/[eE]/.test(e)?(o.push(t),e=t,r+1):/[^\d]/.test(t)?(y(o.join("")),n=Cc,r):(o.push(t),e=t,r+1)}function G(){if(/[^\d\w_]/.test(t)){var k=o.join("");return n=xLe.indexOf(k)>-1?MLe:SLe.indexOf(k)>-1?CLe:TLe,y(o.join("")),n=Cc,r}return o.push(t),e=t,r+1}}function ELe(t){var e=$Le(),i=[];return i=(i=i.concat(e(t))).concat(e(null))}function OLe(t){return ELe(t)}function RLe(t){return t.map(e=>e.type!=="eof"?e.data:"").join("")}const uV=["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"];function ILe(t,e="100",i="300 es"){const r=/^\s*\#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const s of t)if(s.type==="preprocessor"){const n=r.exec(s.data);if(n){const o=n[1].replace(/\s\s+/g," ");if(o===i)return o;if(o===e)return s.data="#version "+i,e;throw new Error("unknown glsl version: "+o)}}return t.splice(0,0,{type:"preprocessor",data:"#version "+i},{type:"whitespace",data:`
`}),null}function DLe(t,e){for(let i=e-1;i>=0;i--){const r=t[i];if(r.type!=="whitespace"&&r.type!=="block-comment"){if(r.type!=="keyword")break;if(r.data==="attribute"||r.data==="in")return!0}}return!1}function US(t,e,i,r){r=r||i;for(const s of t)if(s.type==="ident"&&s.data===i)return r in e?e[r]++:e[r]=0,US(t,e,r+"_"+e[r],r);return i}function Yse(t,e,i="afterVersion"){function r(l,c){for(let h=c;h<l.length;h++){const p=l[h];if(p.type==="operator"&&p.data===";")return h}return null}function s(l){let c=-1,h=0,p=-1;for(let f=0;f<l.length;f++){const g=l[f];if(g.type==="preprocessor"&&(g.data.match(/\#(if|ifdef|ifndef)\s+.+/)?++h:g.data.match(/\#endif\s*.*/)&&--h),i!=="afterVersion"&&i!=="afterPrecision"||g.type==="preprocessor"&&/^#version/.test(g.data)&&(p=Math.max(p,f)),i==="afterPrecision"&&g.type==="keyword"&&g.data==="precision"){const y=r(l,f);if(y===null)throw new Error("precision statement not followed by any semicolons!");p=Math.max(p,y)}c<p&&h===0&&(c=f)}return c+1}const n={data:`
`,type:"whitespace"},o=l=>l<t.length&&/[^\r\n]$/.test(t[l].data);let a=s(t);o(a-1)&&t.splice(a++,0,n);for(const l of e)t.splice(a++,0,l);o(a-1)&&o(a)&&t.splice(a,0,n)}function FLe(t,e,i,r="lowp"){Yse(t,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function LLe(t,e,i,r,s="lowp"){Yse(t,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:r.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:s},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function kLe(t,e){let i,r,s=-1;for(let n=e;n<t.length;n++){const o=t[n];if(o.type==="operator"&&(o.data==="["&&(i=n),o.data==="]")){r=n;break}o.type==="integer"&&(s=parseInt(o.data,10))}return i&&r&&t.splice(i,r-i+1),s}function zLe(t,e){const i=VLe();if(_(i))return i;const r=OLe(t);if(ILe(r,"100","300 es")==="300 es")throw new Error("shader is already glsl 300 es");let s=null,n=null;const o={},a={};for(let l=0;l<r.length;++l){const c=r[l];switch(c.type){case"keyword":e===35633&&c.data==="attribute"?c.data="in":c.data==="varying"&&(c.data=e===35633?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(c.data.trim())&&(c.data=c.data.replace(/(2D|Cube|EXT)/g,"")),e===35632&&c.data==="gl_FragColor"&&(s||(s=US(r,o,"fragColor"),FLe(r,s,"vec4")),c.data=s),e===35632&&c.data==="gl_FragData"){const h=kLe(r,l+1),p=US(r,o,"fragData");LLe(r,p,"vec4",h,"mediump"),c.data=p}else e===35632&&c.data==="gl_FragDepthEXT"&&(n||(n=US(r,o,"gl_FragDepth")),c.data=n);break;case"ident":if(wLe.indexOf(c.data)>=0){if(e===35633&&DLe(r,l))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");c.data in a||(a[c.data]=US(r,o,c.data)),c.data=a[c.data]}}}for(let l=r.length-1;l>=0;--l){const c=r[l];if(c.type==="preprocessor"){const h=c.data.match(/\#extension\s+(.*)\:/);if(h&&h[1]&&uV.indexOf(h[1].trim())>=0){const g=r[l+1];r.splice(l,g&&g.type==="whitespace"?2:1)}const p=c.data.match(/\#ifdef\s+(.*)/);p&&p[1]&&uV.indexOf(p[1].trim())>=0&&(c.data="#if 1");const f=c.data.match(/\#ifndef\s+(.*)/);f&&f[1]&&uV.indexOf(f[1].trim())>=0&&(c.data="#if 0")}}return NLe(t,RLe(r))}function VLe(t){return null}function NLe(t,e){return e}class jS{constructor(e,i,r,s){this._context=e,this._locations=s,this._nameToUniformLocation={},this._nameToUniform1={},this._nameToUniform1v={},this._nameToUniform2={},this._nameToUniform3={},this._nameToUniform4={},this._nameToUniformMatrix3={},this._nameToUniformMatrix4={},e||console.error("RenderingContext isn't initialized!"),i.length===0&&console.error("Shaders source should not be empty!"),this._vShader=Xse(this._context,35633,i),this._fShader=Xse(this._context,35632,r),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(kr.VertexShader,this),this._context.instanceCounter.increment(kr.FragmentShader,this)}get glName(){if(_(this._glName))return this._glName;if(A(this._vShader))return null;const e=this._context.gl,i=e.createProgram();return e.attachShader(i,this._vShader),e.attachShader(i,this._fShader),this._locations.forEach((r,s)=>e.bindAttribLocation(i,r,s)),e.linkProgram(i),CE()&&!e.getProgramParameter(i,e.LINK_STATUS)&&console.error(`Could not link shader
validated: ${e.getProgramParameter(i,e.VALIDATE_STATUS)}, gl error ${e.getError()}, vertex: ${e.getShaderParameter(this._vShader,e.COMPILE_STATUS)}, fragment: ${e.getShaderParameter(this._fShader,e.COMPILE_STATUS)}, info log: ${e.getProgramInfoLog(i)}`),this._glName=i,this._context.instanceCounter.increment(kr.Program,this),i}dispose(){const e=this._context.gl;this._vShader&&(e.deleteShader(this._vShader),this._vShader=null,this._context.instanceCounter.decrement(kr.VertexShader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null,this._context.instanceCounter.decrement(kr.FragmentShader,this)),this._glName&&(e.deleteProgram(this._glName),this._glName=null,this._context.instanceCounter.decrement(kr.Program,this))}_getUniformLocation(e){return this._nameToUniformLocation[e]===void 0&&(this._nameToUniformLocation[e]=this._context.gl.getUniformLocation(this.glName,e)),this._nameToUniformLocation[e]}hasUniform(e){return this._getUniformLocation(e)!==null}setUniform1i(e,i){const r=this._nameToUniform1[e];(r===void 0||i!==r)&&(this._context.useProgram(this),this._context.gl.uniform1i(this._getUniformLocation(e),i),this._nameToUniform1[e]=i)}setUniform1iv(e,i){const r=this._nameToUniform1v[e];Vu(r,i)&&(this._context.useProgram(this),this._context.gl.uniform1iv(this._getUniformLocation(e),i),r===void 0?this._nameToUniform1v[e]=Array.from(i):Nu(i,r))}setUniform2iv(e,i){const r=this._nameToUniform2[e];Vu(r,i)&&(this._context.useProgram(this),this._context.gl.uniform2iv(this._getUniformLocation(e),i),r===void 0?this._nameToUniform2[e]=Array.from(i):Nu(i,r))}setUniform3iv(e,i){const r=this._nameToUniform3[e];Vu(r,i)&&(this._context.useProgram(this),this._context.gl.uniform3iv(this._getUniformLocation(e),i),r===void 0?this._nameToUniform3[e]=Array.from(i):Nu(i,r))}setUniform4iv(e,i){const r=this._nameToUniform4[e];Vu(r,i)&&(this._context.useProgram(this),this._context.gl.uniform4iv(this._getUniformLocation(e),i),r===void 0?this._nameToUniform4[e]=Array.from(i):Nu(i,r))}setUniform1f(e,i){const r=this._nameToUniform1[e];(r===void 0||i!==r)&&(this._context.useProgram(this),this._context.gl.uniform1f(this._getUniformLocation(e),i),this._nameToUniform1[e]=i)}setUniform1fv(e,i){const r=this._nameToUniform1v[e];Vu(r,i)&&(this._context.useProgram(this),this._context.gl.uniform1fv(this._getUniformLocation(e),i),r===void 0?this._nameToUniform1v[e]=Array.from(i):Nu(i,r))}setUniform2f(e,i,r){const s=this._nameToUniform2[e];(s===void 0||i!==s[0]||r!==s[1])&&(this._context.useProgram(this),this._context.gl.uniform2f(this._getUniformLocation(e),i,r),s===void 0?this._nameToUniform2[e]=[i,r]:(s[0]=i,s[1]=r))}setUniform2fv(e,i){const r=this._nameToUniform2[e];Vu(r,i)&&(this._context.useProgram(this),this._context.gl.uniform2fv(this._getUniformLocation(e),i),r===void 0?this._nameToUniform2[e]=Array.from(i):Nu(i,r))}setUniform3f(e,i,r,s){const n=this._nameToUniform3[e];(n===void 0||i!==n[0]||r!==n[1]||s!==n[2])&&(this._context.useProgram(this),this._context.gl.uniform3f(this._getUniformLocation(e),i,r,s),n===void 0?this._nameToUniform3[e]=[i,r,s]:(n[0]=i,n[1]=r,n[2]=s))}setUniform3fv(e,i){const r=this._nameToUniform3[e];Vu(r,i)&&(this._context.useProgram(this),this._context.gl.uniform3fv(this._getUniformLocation(e),i),r===void 0?this._nameToUniform3[e]=Array.from(i):Nu(i,r))}setUniform4f(e,i,r,s,n){const o=this._nameToUniform4[e];(o===void 0||i!==o[0]||r!==o[1]||s!==o[2]||n!==o[3])&&(this._context.useProgram(this),this._context.gl.uniform4f(this._getUniformLocation(e),i,r,s,n),o===void 0?this._nameToUniform4[e]=[i,r,s,n]:(o[0]=i,o[1]=r,o[2]=s,o[3]=n))}setUniform4fv(e,i){const r=this._nameToUniform4[e];Vu(r,i)&&(this._context.useProgram(this),this._context.gl.uniform4fv(this._getUniformLocation(e),i),r===void 0?this._nameToUniform4[e]=Array.from(i):Nu(i,r))}setUniformMatrix3fv(e,i,r=!1,s=!1){const n=this._nameToUniformMatrix3[e];(s?n!==i:BLe(n,i))&&(this._context.useProgram(this),this._context.gl.uniformMatrix3fv(this._getUniformLocation(e),r,i),n===void 0?this._nameToUniformMatrix3[e]=Array.from(i):Nu(i,n))}setUniformMatrix4fv(e,i,r=!1){const s=this._nameToUniformMatrix4[e];GLe(s,i)&&(this._context.useProgram(this),this._context.gl.uniformMatrix4fv(this._getUniformLocation(e),r,i),s===void 0?this._nameToUniformMatrix4[e]=Array.from(i):Nu(i,s))}assertCompatibleVertexAttributeLocations(e){e.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){}}function Vu(t,e){if(A(t)||t.length!==e.length)return!0;for(let i=0;i<t.length;++i)if(t[i]!==e[i])return!0;return!1}function Xse(t,e,i){const r=t.webglVersion==="webgl2"?zLe(i,e):i,s=t.gl,n=s.createShader(e);return s.shaderSource(n,r),s.compileShader(n),CE()&&!s.getShaderParameter(n,s.COMPILE_STATUS)&&(console.error("Compile error in ".concat(e===35633?"vertex":"fragment"," shader")),console.error(s.getShaderInfoLog(n)),console.error(ULe(r)),t.webglVersion==="webgl2"&&(console.log("Shader source before transpilation:"),console.log(i))),n}function ULe(t){let e=2;return t.replace(/\n/g,()=>`
`+jLe(e++)+":")}function jLe(t){return t>=1e3?t.toString():("  "+t).slice(-3)}function Nu(t,e){for(let i=0;i<t.length;++i)e[i]=t[i]}function BLe(t,e){return!!A(t)||(t.length!==9?Vu(t,e):t.length!==9||t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||t[4]!==e[4]||t[5]!==e[5]||t[6]!==e[6]||t[7]!==e[7]||t[8]!==e[8])}function GLe(t,e){return!!A(t)||(t.length!==16?Vu(t,e):t.length!==16||t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||t[4]!==e[4]||t[5]!==e[5]||t[6]!==e[6]||t[7]!==e[7]||t[8]!==e[8]||t[9]!==e[9]||t[10]!==e[10]||t[11]!==e[11]||t[12]!==e[12]||t[13]!==e[13]||t[14]!==e[14]||t[15]!==e[15])}class fi extends jS{constructor(e,i,r){super(e,i.generateSource("vertex"),i.generateSource("fragment"),r),this._textures=new Map,this._freeTextureUnits=new ct({deallocator:null}),this._fragmentUniforms=u0()?i.fragmentUniforms.entries:null}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(e,i){if(A(e)||e.glName==null){const s=this._textures.get(i);return s&&(this._context.bindTexture(null,s.unit),this._freeTextureUnit(s),this._textures.delete(i)),null}let r=this._textures.get(i);return r==null?(r=this._allocTextureUnit(e),this._textures.set(i,r)):r.texture=e,this._context.useProgram(this),this.setUniform1i(i,r.unit),this._context.bindTexture(e,r.unit),r.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach((e,i)=>{this._context.bindTexture(e.texture,e.unit),this.setUniform1i(i,e.unit)}),_(this._fragmentUniforms)&&this._fragmentUniforms.forEach(e=>{if((e.type==="sampler2D"||e.type==="samplerCube")&&!this._textures.has(e.name))throw new Error(`Texture sampler ${e.name} has no bound texture`)})}_allocTextureUnit(e){return{texture:e,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(e){this._freeTextureUnits.push(e.unit)}}function Qa(t,e,i=32774,r=[0,0,0,0]){return{srcRgb:t,srcAlpha:t,dstRgb:e,dstAlpha:e,opRgb:i,opAlpha:i,color:{r:r[0],g:r[1],b:r[2],a:r[3]}}}function Xs(t,e,i,r,s=32774,n=32774,o=[0,0,0,0]){return{srcRgb:t,srcAlpha:e,dstRgb:i,dstAlpha:r,opRgb:s,opAlpha:n,color:{r:o[0],g:o[1],b:o[2],a:o[3]}}}const hV={face:1029,mode:2305},Kse={face:1028,mode:2305},PE=t=>t===2?hV:t===1?Kse:null,$o={zNear:0,zFar:1},Pt={r:!0,g:!0,b:!0,a:!0};function qLe(t){return KLe.intern(t)}function HLe(t){return e6e.intern(t)}function WLe(t){return t6e.intern(t)}function ZLe(t){return i6e.intern(t)}function JLe(t){return r6e.intern(t)}function QLe(t){return s6e.intern(t)}function YLe(t){return n6e.intern(t)}function XLe(t){return o6e.intern(t)}function _t(t){return a6e.intern(t)}class md{constructor(e,i){this.makeKey=e,this.makeRef=i,this.interns=new Map}intern(e){if(!e)return null;const i=this.makeKey(e),r=this.interns;return r.has(i)||r.set(i,this.makeRef(e)),r.get(i)}}function gd(t){return"["+t.join(",")+"]"}const KLe=new md(ene,t=>E({__tag:"Blending"},t));function ene(t){return t?gd([t.srcRgb,t.srcAlpha,t.dstRgb,t.dstAlpha,t.opRgb,t.opAlpha,t.color.r,t.color.g,t.color.b,t.color.a]):null}const e6e=new md(tne,t=>E({__tag:"Culling"},t));function tne(t){return t?gd([t.face,t.mode]):null}const t6e=new md(ine,t=>E({__tag:"PolygonOffset"},t));function ine(t){return t?gd([t.factor,t.units]):null}const i6e=new md(rne,t=>E({__tag:"DepthTest"},t));function rne(t){return t?gd([t.func]):null}const r6e=new md(sne,t=>E({__tag:"StencilTest"},t));function sne(t){return t?gd([t.function.func,t.function.ref,t.function.mask,t.operation.fail,t.operation.zFail,t.operation.zPass]):null}const s6e=new md(nne,t=>E({__tag:"DepthWrite"},t));function nne(t){return t?gd([t.zNear,t.zFar]):null}const n6e=new md(one,t=>E({__tag:"ColorWrite"},t));function one(t){return t?gd([t.r,t.g,t.b,t.a]):null}const o6e=new md(ane,t=>E({__tag:"StencilWrite"},t));function ane(t){return t?gd([t.mask]):null}const a6e=new md(l6e,t=>({blending:qLe(t.blending),culling:HLe(t.culling),polygonOffset:WLe(t.polygonOffset),depthTest:ZLe(t.depthTest),stencilTest:JLe(t.stencilTest),depthWrite:QLe(t.depthWrite),colorWrite:YLe(t.colorWrite),stencilWrite:XLe(t.stencilWrite)}));function l6e(t){return t?gd([ene(t.blending),tne(t.culling),ine(t.polygonOffset),rne(t.depthTest),sne(t.stencilTest),nne(t.depthWrite),one(t.colorWrite),ane(t.stencilWrite)]):null}class c6e{constructor(e){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._stateSetters=e}setPipeline(e){(this._pipelineInvalid||e!==this._pipeline)&&(this.setBlending(e.blending),this.setCulling(e.culling),this.setPolygonOffset(e.polygonOffset),this.setDepthTest(e.depthTest),this.setStencilTest(e.stencilTest),this.setDepthWrite(e.depthWrite),this.setColorWrite(e.colorWrite),this.setStencilWrite(e.stencilWrite),this._pipeline=e),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}setBlending(e){this._blending=this.setSubState(e,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}setCulling(e){this._culling=this.setSubState(e,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}setPolygonOffset(e){this._polygonOffset=this.setSubState(e,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}setDepthTest(e){this._depthTest=this.setSubState(e,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}setStencilTest(e){this._stencilTest=this.setSubState(e,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}setDepthWrite(e){this._depthWrite=this.setSubState(e,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}setColorWrite(e){this._colorWrite=this.setSubState(e,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}setStencilWrite(e){this._stencilWrite=this.setSubState(e,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}setSubState(e,i,r,s){return(r||e!==i)&&(s(e),this._pipelineInvalid=!0),e}}class BS extends Si{initializeProgram(e){const i=BS.shader.get(),r=this.configuration,s=i.build({haze:r.haze});return new fi(e.rctx,s,Ht)}initializePipeline(){return this.configuration.haze?_t({blending:Xs(1,0,769,1),colorWrite:Pt}):_t({blending:Xs(770,1,771,771),depthTest:{func:515},colorWrite:Pt})}}BS.shader=new vi(vLe,()=>import("./ChapmanAtmosphere.glsl.38e5fa22.js"));class lne extends tr{constructor(){super(...arguments),this.haze=!1}}u([X()],lne.prototype,"haze",void 0);const dV=[{name:"position",count:2,type:5126,offset:0,stride:8,normalized:!1}],GS=[{name:"position",count:2,type:5126,offset:0,stride:16,normalized:!1},{name:"uv0",count:2,type:5126,offset:8,stride:16,normalized:!1}],Bf=le.getLogger("esri.views.webgl.BufferObject");class Nt{constructor(e,i,r,s,n){this._context=e,this.bufferType=i,this.usage=r,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(kr.Buffer,this),this._glName=this._context.gl.createBuffer(),jf(this._context.gl),s&&this.setData(s,n)}static createIndex(e,i,r,s){return new Nt(e,34963,i,r,s)}static createVertex(e,i,r){return new Nt(e,34962,i,r)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get byteSize(){return this.bufferType===34962?this._size:this._indexType===5125?4*this._size:2*this._size}dispose(){var e;(e=this._context)!=null&&e.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(kr.Buffer,this),this._context=null):this._glName&&Bf.warn("Leaked WebGL buffer object")}setData(e,i){if(!e)return;if(typeof e=="number"){if(e<0&&Bf.error("Buffer size cannot be negative!"),this._size=e,this.bufferType===34963&&i)switch(this._indexType=i,this._size=e,i){case 5123:e*=2;break;case 5125:e*=4}}else{let n=e.byteLength;AC(e)&&(n/=2,this._indexType=5123),$C(e)&&(n/=4,this._indexType=5125),this._size=n}const r=this._context.getBoundVAO();this._context.bindVAO(null),this._context.bindBuffer(this);const s=this._context.gl;s.bufferData(this.bufferType,e,this.usage),jf(s),this._context.bindVAO(r)}setSubData(e,i=0,r=0,s=e.byteLength){if(!e)return;(i<0||i>=this._size)&&Bf.error("offset is out of range!");let n=i,o=r,a=s,l=e.byteLength;AC(e)?(l/=2,n*=2,o*=2,a*=2):$C(e)&&(l/=4,n*=4,o*=4,a*=4),s===void 0&&(s=l-1),r>=s&&Bf.error("end must be bigger than start!"),i+r-s>this._size&&Bf.error("An attempt to write beyond the end of the buffer!");const c=this._context.getBoundVAO();this._context.bindVAO(null),this._context.bindBuffer(this);const h=this._context.gl,p=ArrayBuffer.isView(e)?e.buffer:e,f=o===0&&a===e.byteLength?p:p.slice(o,a);h.bufferSubData(this.bufferType,n,f),jf(h),this._context.bindVAO(c)}setSubDataFromView(e,i,r,s){if(!e)return;(i<0||i>=this._size)&&Bf.error("offset is out of range!"),r>=s&&Bf.error("end must be bigger than start!"),i+r-s>this._size&&Bf.error("An attempt to write beyond the end of the buffer!");const n=this._context.getBoundVAO();this._context.bindVAO(null),this._context.bindBuffer(this);const o=this._context.gl,a=r===0&&s===e.length?e:e.subarray(r,s);o.bufferSubData(this.bufferType,i*e.BYTES_PER_ELEMENT,a),jf(o),this._context.bindVAO(n)}}function Eo(t){return window.WebGL2RenderingContext&&t instanceof window.WebGL2RenderingContext}const cne=4;class qe{constructor(e,i,r=null){this._context=e,this.type="texture",this._glName=null,this._descriptor=void 0,this._samplingModeDirty=!1,this._wrapModeDirty=!1,e.instanceCounter.increment(kr.Texture,this),this._descriptor=E({target:3553,samplingMode:9729,wrapMode:10497,flipped:!1,hasMipmap:!1,isOpaque:!1,unpackAlignment:4,preMultiplyAlpha:!1},i),this._descriptor.target===34067?this.setDataCubeMap(r):this.setData(r)}get glName(){return this._glName}get descriptor(){return this._descriptor}get isDirty(){return this._samplingModeDirty||this._wrapModeDirty}dispose(){this._context.gl&&this._glName&&(this._context.unbindTextureAllUnits(this),this._context.gl.deleteTexture(this._glName),this._glName=null,this._context.instanceCounter.decrement(kr.Texture,this))}release(){this.dispose()}resize(e,i){const r=this._descriptor;r.width===e&&r.height===i||(r.width=e,r.height=i,this._descriptor.target===34067?this.setDataCubeMap(null):this.setData(null))}setDataCubeMap(e=null){for(let i=34069;i<=34074;i++)this.setData(e,i)}setData(e,i=3553){if(!this._context||!this._context.gl)return;const r=this._context.gl;this._glName||(this._glName=r.createTexture()),e===void 0&&(e=null),e===null&&(this._descriptor.width=this._descriptor.width||cne,this._descriptor.height=this._descriptor.height||cne);const s=this._context.bindTexture(this,qe.TEXTURE_UNIT_FOR_UPDATES),n=this._descriptor;qe._validateTexture(this._context,n),r.pixelStorei(r.UNPACK_ALIGNMENT,n.unpackAlignment),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,n.flipped?1:0),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.preMultiplyAlpha?1:0);const o=n.pixelFormat;let a=n.internalFormat?n.internalFormat:this._deriveInternalFormat(o,n.dataType);if(e instanceof ImageData||e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement){let l=e.width,c=e.height;e instanceof HTMLVideoElement&&(l=e.videoWidth,c=e.videoHeight),n.width&&n.height,r.texImage2D(i,0,a,o,n.dataType,e),jf(r),n.hasMipmap&&this.generateMipmap(),n.width===void 0&&(n.width=l),n.height===void 0&&(n.height=c)}else{n.width!=null&&n.height!=null||console.error("Width and height must be specified!"),r.DEPTH24_STENCIL8&&a===r.DEPTH_STENCIL&&(a=r.DEPTH24_STENCIL8);let l=n.width,c=n.height;if(u6e(e)){const h=Math.round(Math.log(Math.max(l,c))/Math.LN2)+1;n.hasMipmap=n.hasMipmap&&h===e.levels.length;for(let p=0;;++p){const f=e.levels[Math.min(p,e.levels.length-1)];if(r.compressedTexImage2D(i,p,a,l,c,0,f),l===1&&c===1||!n.hasMipmap)break;l=Math.max(1,l>>1),c=Math.max(1,c>>1)}}else if(_(e))r.texImage2D(i,0,a,l,c,0,o,n.dataType,e),jf(r),n.hasMipmap&&this.generateMipmap();else for(let h=0;r.texImage2D(i,h,a,l,c,0,o,n.dataType,null),jf(r),(l!==1||c!==1)&&n.hasMipmap;++h)l=Math.max(1,l>>1),c=Math.max(1,c>>1)}qe._applySamplingMode(r,this._descriptor),qe._applyWrapMode(r,this._descriptor),qe._applyAnisotropicFilteringParameters(this._context,this._descriptor),jf(r),this._context.bindTexture(s,qe.TEXTURE_UNIT_FOR_UPDATES)}updateData(e,i,r,s,n,o,a=3553){o||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const l=this._context.gl,c=this._descriptor,h=this._context.bindTexture(this,qe.TEXTURE_UNIT_FOR_UPDATES);(i<0||r<0||s>c.width||n>c.height||i+s>c.width||r+n>c.height)&&console.error("An attempt to update out of bounds of the texture!"),l.pixelStorei(l.UNPACK_ALIGNMENT,c.unpackAlignment),l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,c.flipped?1:0),l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,c.preMultiplyAlpha?1:0),o instanceof ImageData||o instanceof HTMLImageElement||o instanceof HTMLCanvasElement||o instanceof HTMLVideoElement?l.texSubImage2D(a,e,i,r,c.pixelFormat,c.dataType,o):l.texSubImage2D(a,e,i,r,s,n,c.pixelFormat,c.dataType,o),this._context.bindTexture(h,qe.TEXTURE_UNIT_FOR_UPDATES)}generateMipmap(){const e=this._descriptor;e.hasMipmap||(e.hasMipmap=!0,this._samplingModeDirty=!0,qe._validateTexture(this._context,e)),e.samplingMode===9729?(this._samplingModeDirty=!0,e.samplingMode=9985):e.samplingMode===9728&&(this._samplingModeDirty=!0,e.samplingMode=9984);const i=this._context.bindTexture(this,qe.TEXTURE_UNIT_FOR_UPDATES);this._context.gl.generateMipmap(e.target),this._context.bindTexture(i,qe.TEXTURE_UNIT_FOR_UPDATES)}setSamplingMode(e){e!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=e,this._samplingModeDirty=!0)}setWrapMode(e){e!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=e,qe._validateTexture(this._context,this._descriptor),this._wrapModeDirty=!0)}applyChanges(){const e=this._context.gl,i=this._descriptor;this._samplingModeDirty&&(qe._applySamplingMode(e,i),this._samplingModeDirty=!1),this._wrapModeDirty&&(qe._applyWrapMode(e,i),this._wrapModeDirty=!1)}_deriveInternalFormat(e,i){if(this._context.webglVersion==="webgl")return e;if(i===5126)switch(e){case 6408:return 34836;case 6407:return 34837;default:throw new Error("Unable to derive format")}return e}static _validateTexture(e,i){(i.width<0||i.height<0)&&console.error("Negative dimension parameters are not allowed!");const r=Kv(i.width)&&Kv(i.height);Eo(e.gl)||r||(typeof i.wrapMode=="number"?i.wrapMode!==33071&&console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"):i.wrapMode.s===33071&&i.wrapMode.t===33071||console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"),i.hasMipmap&&console.error("Mipmapping requires power-of-two textures!"))}static _applySamplingMode(e,i){let r=i.samplingMode,s=i.samplingMode;r===9985||r===9987?(r=9729,i.hasMipmap||(s=9729)):r!==9984&&r!==9986||(r=9728,i.hasMipmap||(s=9728)),e.texParameteri(i.target,e.TEXTURE_MAG_FILTER,r),e.texParameteri(i.target,e.TEXTURE_MIN_FILTER,s)}static _applyWrapMode(e,i){typeof i.wrapMode=="number"?(e.texParameteri(i.target,e.TEXTURE_WRAP_S,i.wrapMode),e.texParameteri(i.target,e.TEXTURE_WRAP_T,i.wrapMode)):(e.texParameteri(i.target,e.TEXTURE_WRAP_S,i.wrapMode.s),e.texParameteri(i.target,e.TEXTURE_WRAP_T,i.wrapMode.t))}static _applyAnisotropicFilteringParameters(e,i){var r;const s=e.capabilities.textureFilterAnisotropic;!s||e.gl.texParameterf(i.target,s.TEXTURE_MAX_ANISOTROPY,(r=i.maxAnisotropy)!=null?r:1)}}function u6e(t){return _(t)&&"type"in t&&t.type==="compressed"}qe.TEXTURE_UNIT_FOR_UPDATES=0;function xs(t,e){return t.vertexBuffers[e].size/h6e(t.layout[e])}function h6e(t){return t[0].stride}function une(t,e,i,r,s){const n=t.gl,o=t.capabilities.instancing;t.bindBuffer(i);for(const a of r){const l=e.get(a.name);l===void 0&&console.error(`There is no location for vertex attribute '${a.name}' defined.`),a.baseInstance&&!a.divisor&&console.error(`Vertex attribute '${a.name}' uses baseInstanceOffset without divisor.`);const c=(s||(0+a.baseInstance?a.baseInstance:0))*a.stride;if(a.count<=4)n.vertexAttribPointer(l,a.count,a.type,a.normalized,a.stride,a.offset+c),n.enableVertexAttribArray(l),a.divisor>0&&o&&o.vertexAttribDivisor(l,a.divisor);else if(a.count===9)for(let h=0;h<3;h++)n.vertexAttribPointer(l+h,3,a.type,a.normalized,a.stride,a.offset+12*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else if(a.count===16)for(let h=0;h<4;h++)n.vertexAttribPointer(l+h,4,a.type,a.normalized,a.stride,a.offset+16*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else console.error("Unsupported vertex attribute element count: "+a.count)}}function hne(t,e,i,r){const s=t.gl,n=t.capabilities.instancing;t.bindBuffer(i);for(const o of r){const a=e.get(o.name);if(o.count<=4)s.disableVertexAttribArray(a),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a,0);else if(o.count===9)for(let l=0;l<3;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else if(o.count===16)for(let l=0;l<4;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else console.error("Unsupported vertex attribute element count: "+o.count)}t.unbindBuffer(34962)}function dne(t){switch(t){case 6406:case 6409:case 36168:case 33778:case 33779:case 37490:case 37491:case 37496:case 37497:return 1;case 6410:case 32854:case 33325:case 32854:case 33189:return 2;case 6407:case 6402:return 3;case 6408:case 34041:case 33326:case 35898:case 33327:case 34041:return 4;case 33328:case 34842:return 8;case 34837:return 12;case 34836:return 16;case 33776:case 33777:case 37488:case 37489:case 37492:case 37493:case 37494:case 37495:return .5}return 0}function Gf(t){if(A(t))return 0;if("descriptor"in t)return t.glName?Gf(t.descriptor):0;const e=t.internalFormat||"pixelFormat"in t&&t.pixelFormat;if(!e)return 0;const i="hasMipmap"in t&&t.hasMipmap?1.3:1,r=t.width*t.height;return dne(e)*r*i}const h0=le.getLogger("esri.views.webgl.VertexArrayObject");class Tr{constructor(e,i,r,s,n=null){this._context=e,this._locations=i,this._layout=r,this._buffers=s,this._indexBuffer=n,this._glName=null,this._initialized=!1,e.instanceCounter.increment(kr.VAO,this)}get glName(){return this._glName}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get size(){return Object.keys(this._buffers).reduce((e,i)=>e+this._buffers[i].size,_(this._indexBuffer)?this._indexBuffer.size:0)}get layout(){return this._layout}get locations(){return this._locations}dispose(e=!0){if(!this._context)return void((this._glName||e&&Object.getOwnPropertyNames(this._buffers).length>0)&&h0.warn("Leaked WebGL VAO"));if(this._glName){var i,r;const s=(i=this._context)==null||(r=i.capabilities)==null?void 0:r.vao;s?(s.deleteVertexArray(this._glName),this._glName=null):h0.warn("Leaked WebGL VAO")}if(this._context.getBoundVAO()===this&&this._context.bindVAO(null),e){for(const s in this._buffers)this._buffers[s].dispose(),delete this._buffers[s];this._indexBuffer=Ge(this._indexBuffer)}this._context.instanceCounter.decrement(kr.VAO,this),this._context=null}initialize(){if(this._initialized)return;const e=this._context.capabilities.vao;if(e){const i=e.createVertexArray();e.bindVertexArray(i),this._bindLayout(),e.bindVertexArray(null),this._glName=i}this._initialized=!0}bind(){this.initialize();const e=this._context.capabilities.vao;e?e.bindVertexArray(this.glName):(this._context.bindVAO(null),this._bindLayout())}_bindLayout(){const{_buffers:e,_layout:i,_indexBuffer:r}=this;e||h0.error("Vertex buffer dictionary is empty!");const s=this._context.gl;for(const n in e){const o=e[n];o||h0.error("Vertex buffer is uninitialized!");const a=i[n];a||h0.error("Vertex element descriptor is empty!"),une(this._context,this._locations,o,a)}_(r)&&(this._context.capabilities.vao?s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r.glName):this._context.bindBuffer(r))}unbind(){this.initialize();const e=this._context.capabilities.vao;e?e.bindVertexArray(null):this._unbindLayout()}_unbindLayout(){const{_buffers:e,_layout:i}=this;e||h0.error("Vertex buffer dictionary is empty!");for(const r in e){const s=e[r];s||h0.error("Vertex buffer is uninitialized!");const n=i[r];hne(this._context,this._locations,s,n)}_(this._indexBuffer)&&this._context.unbindBuffer(this._indexBuffer.bufferType)}}function vn(t,e=dV,i=Ht,r=-1,s=1){let n=null;return e===GS?n=new Float32Array([r,r,0,0,s,r,1,0,r,s,0,1,s,s,1,1]):n=new Float32Array([r,r,s,r,r,s,s,s]),new Tr(t,i,{geometry:e},{geometry:Nt.createVertex(t,35044,n)})}function d6e(t,e=dV,i=Ht){const r=new Float32Array([-1,-1,3,-1,-1,3]);return new Tr(t,i,{geometry:e},{geometry:Nt.createVertex(t,35044,r)})}const pne=4;function fne(t,e=pne){return new qe(t,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:e})}function mne(t,e,i=pne){const r=new Uint8Array(i*i*4);for(let s=0;s<r.length;s+=4)r[s+0]=255*e[0],r[s+1]=255*e[1],r[s+2]=255*e[2],r[s+3]=255*e[3];return new qe(t,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:i,height:i},r)}function gne(t){return new qe(t,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255]))}class yne{constructor(e){this._view=e,this.type="realistic",this.canRender=!0,this._cameraPosition=$(),this._projectionInverse=be(),this._viewInverse=be(),this._heightParameters=Ot(),this._betasRayleigh=$(),this._betasCombined=$(),this._scaleHeight=0,this._radii=ke(),this._nearFar=ke(),this._cameraHeight=0,this._cameraHeightSq=0,this._cAtmosphere=0,this._innerFadeDistance=0,this._altitudeFade=0,this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=Lt.radius,this._hazeStrength=1,this._darkenHaze=!1,this._updateRadius(Lt.radius)}destroy(){this._atmosphereTechnique=nr(this._atmosphereTechnique),this._atmosphereHazeTechnique=nr(this._atmosphereHazeTechnique),this._vao=Ge(this._vao),this._handles=tt(this._handles)}when(){return Promise.resolve()}initializeRenderContext(e){const i=e.renderContext.rctx;this._handles=new dt,_(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(ks(this._view,"basemapTerrain","elevation-change",s=>this._updateElevation(s),()=>this._updateElevation())),this._handles.add(ks(this._view,"basemapTerrain","elevation-bounds-change",()=>this._updateVisibleElevationBounds()));const r=new lne;r.haze=!1,this._atmosphereTechnique=e.shaderTechniqueRep.acquire(BS,r),r.haze=!0,this._atmosphereHazeTechnique=e.shaderTechniqueRep.acquire(BS,r),this._vao=vn(i,GS),this._scaleHeight=cLe*TE,ne(this._betasRayleigh,Z_[0],Z_[1],Z_[2]),ne(this._betasCombined,Z_[0]+nV[0],Z_[1]+nV[1],Z_[2]+nV[2])}render(e){return this._render(e,this._atmosphereTechnique,e.offscreenRenderingHelper.depthTexture)}renderHaze(e,i){return this._darkenHaze=i,this._render(e,this._atmosphereHazeTechnique,e.offscreenRenderingHelper.linearDepthTexture)}_render(e,i,r){this._update(e.camera);const s=e.rctx,n=e.offscreenRenderingHelper;return s.useProgram(i.program),i.bindPipelineState(s),n.renderDepthDetached(()=>{i.program.bindTexture(r,"depthTex"),this._renderCommon(i.program,e)}),!0}_renderCommon(e,i){if(A(this._vao))return!1;const r=i.rctx;return i.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._heightParameters),e.setUniform3fv("cameraPosition",this._cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._projectionInverse),e.setUniformMatrix4fv("viewInverse",this._viewInverse),e.setUniform2fv("nearFar",this._nearFar),e.setUniform2fv("radii",this._radii),e.setUniform1f("scaleHeight",this._scaleHeight),e.setUniform1f("betaMie",lLe),e.setUniform3fv("betaRayleigh",this._betasRayleigh),e.setUniform3fv("betaCombined",this._betasCombined),e.setUniform1f("innerFadeDistance",this._innerFadeDistance),e.setUniform1f("altitudeFade",this._altitudeFade),e.setUniform1f("hazeStrength",this._hazeStrength),r.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(5,0,4),!0}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateElevation(e){const i=e?e.tile:st(this._view.basemapTerrain.rootTiles,[null])[0];if(A(i)||i.level!==0)return;const r=this._adjustRadiusForTesselation(Lt.radius+i.elevationBounds[0]);r!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=r,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(Lt.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,si(this._radii,e,e+TE),this._innerFadeDistance=2*Math.sqrt((2*e-rV)*rV)}_update(e){if(A(e))return;this._cameraHeight=Te(e.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*this._radii[1];const i=Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/TE));this._heightParameters=Bt(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,i),re(this._cameraPosition,e.eye),Fi(this._projectionInverse,e.projectionMatrix),Fi(this._viewInverse,e.viewMatrix),si(this._nearFar,e.near,e.far),this._altitudeFade=Dse(this._cameraHeight-this._lowerBoundEarthRadius),this._hazeStrength=this._darkenHaze?Et(.6,1,Ag(9500,10500,this._cameraHeight-Lt.radius)):1}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}function p6e(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function vne(t,e,i){i*=.5;const r=Math.sin(i);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(i),t}function _ne(t,e){const i=2*Math.acos(e[3]),r=Math.sin(i/2);return r>it?(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r):(t[0]=1,t[1]=0,t[2]=0),i}function bne(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=i[0],l=i[1],c=i[2],h=i[3];return t[0]=r*h+o*a+s*c-n*l,t[1]=s*h+o*l+n*a-r*c,t[2]=n*h+o*c+r*l-s*a,t[3]=o*h-r*a-s*l-n*c,t}function f6e(t,e,i){i*=.5;const r=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(i),l=Math.cos(i);return t[0]=r*l+o*a,t[1]=s*l+n*a,t[2]=n*l-s*a,t[3]=o*l-r*a,t}function m6e(t,e,i){i*=.5;const r=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(i),l=Math.cos(i);return t[0]=r*l-n*a,t[1]=s*l+o*a,t[2]=n*l+r*a,t[3]=o*l-s*a,t}function g6e(t,e,i){i*=.5;const r=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(i),l=Math.cos(i);return t[0]=r*l+s*a,t[1]=s*l-r*a,t[2]=n*l+o*a,t[3]=o*l-n*a,t}function y6e(t,e){const i=e[0],r=e[1],s=e[2];return t[0]=i,t[1]=r,t[2]=s,t[3]=Math.sqrt(Math.abs(1-i*i-r*r-s*s)),t}function AE(t,e,i,r){const s=e[0],n=e[1],o=e[2],a=e[3];let l,c,h,p,f,g=i[0],y=i[1],v=i[2],b=i[3];return c=s*g+n*y+o*v+a*b,c<0&&(c=-c,g=-g,y=-y,v=-v,b=-b),1-c>it?(l=Math.acos(c),h=Math.sin(l),p=Math.sin((1-r)*l)/h,f=Math.sin(r*l)/h):(p=1-r,f=r),t[0]=p*s+f*g,t[1]=p*n+f*y,t[2]=p*o+f*v,t[3]=p*a+f*b,t}function v6e(t){const e=jl(),i=jl(),r=jl(),s=Math.sqrt(1-e),n=Math.sqrt(e);return t[0]=s*Math.sin(2*Math.PI*i),t[1]=s*Math.cos(2*Math.PI*i),t[2]=n*Math.sin(2*Math.PI*r),t[3]=n*Math.cos(2*Math.PI*r),t}function _6e(t,e){const i=e[0],r=e[1],s=e[2],n=e[3],o=i*i+r*r+s*s+n*n,a=o?1/o:0;return t[0]=-i*a,t[1]=-r*a,t[2]=-s*a,t[3]=n*a,t}function qS(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t}function wne(t,e){const i=e[0]+e[4]+e[8];let r;if(i>0)r=Math.sqrt(i+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{let s=0;e[4]>e[0]&&(s=1),e[8]>e[3*s+s]&&(s=2);const n=(s+1)%3,o=(s+2)%3;r=Math.sqrt(e[3*s+s]-e[3*n+n]-e[3*o+o]+1),t[s]=.5*r,r=.5/r,t[3]=(e[3*n+o]-e[3*o+n])*r,t[n]=(e[3*n+s]+e[3*s+n])*r,t[o]=(e[3*o+s]+e[3*s+o])*r}return t}function b6e(t,e,i,r){const s=.5*Math.PI/180;e*=s,i*=s,r*=s;const n=Math.sin(e),o=Math.cos(e),a=Math.sin(i),l=Math.cos(i),c=Math.sin(r),h=Math.cos(r);return t[0]=n*l*h-o*a*c,t[1]=o*a*h+n*l*c,t[2]=o*l*c-n*a*h,t[3]=o*l*h+n*a*c,t}function w6e(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}const xne=Ln,x6e=Ls,S6e=$F,T6e=bne,C6e=gx,M6e=bH,P6e=RF,Sne=EF,A6e=Sne,Tne=OF,$6e=Tne,pV=_H,E6e=Pg,O6e=wH;function R6e(t,e,i){const r=ye(e,i);return r<-.999999?(Ye(Uu,I6e,e),PF(Uu)<1e-6&&Ye(Uu,D6e,e),_e(Uu,Uu),vne(t,Uu,Math.PI),t):r>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(Ye(Uu,e,i),t[0]=Uu[0],t[1]=Uu[1],t[2]=Uu[2],t[3]=1+r,pV(t,t))}const Uu=$(),I6e=De(1,0,0),D6e=De(0,1,0);function F6e(t,e,i,r,s,n){return AE(Cne,e,s,n),AE(Mne,i,r,n),AE(t,Cne,Mne,2*n*(1-n)),t}const Cne=pf(),Mne=pf();function L6e(t,e,i,r){const s=k6e;return s[0]=i[0],s[3]=i[1],s[6]=i[2],s[1]=r[0],s[4]=r[1],s[7]=r[2],s[2]=-e[0],s[5]=-e[1],s[8]=-e[2],pV(t,wne(t,s))}const k6e=Ai();Object.freeze({__proto__:null,identity:p6e,setAxisAngle:vne,getAxisAngle:_ne,multiply:bne,rotateX:f6e,rotateY:m6e,rotateZ:g6e,calculateW:y6e,slerp:AE,random:v6e,invert:_6e,conjugate:qS,fromMat3:wne,fromEuler:b6e,str:w6e,copy:xne,set:x6e,add:S6e,mul:T6e,scale:C6e,dot:M6e,lerp:P6e,length:Sne,len:A6e,squaredLength:Tne,sqrLen:$6e,normalize:pV,exactEquals:E6e,equals:O6e,rotationTo:R6e,sqlerp:F6e,setAxes:L6e});function Q_(t=V6e){return[t[0],t[1],t[2],t[3]]}function HS(t,e){return z6e(t[0],t[1],t[2],e,T6.get())}function z6e(t,e,i,r,s=Q_()){return s[0]=t,s[1]=e,s[2]=i,s[3]=r,s}function WS(t,e,i=Q_()){return Ye(i,t,e),_e(i,i),i[3]=P6(t,e),i}function fV(t){return t}const V6e=[0,0,1,0];function Pne(t,e){const i=t.fragment,r=e.lightingSphericalHarmonicsOrder!==void 0?e.lightingSphericalHarmonicsOrder:2;r===0?(i.uniforms.add("lightingAmbientSH0","vec3"),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):r===1?(i.uniforms.add("lightingAmbientSH_R","vec4"),i.uniforms.add("lightingAmbientSH_G","vec4"),i.uniforms.add("lightingAmbientSH_B","vec4"),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):r===2&&(i.uniforms.add("lightingAmbientSH0","vec3"),i.uniforms.add("lightingAmbientSH_R1","vec4"),i.uniforms.add("lightingAmbientSH_G1","vec4"),i.uniforms.add("lightingAmbientSH_B1","vec4"),i.uniforms.add("lightingAmbientSH_R2","vec4"),i.uniforms.add("lightingAmbientSH_G2","vec4"),i.uniforms.add("lightingAmbientSH_B2","vec4"),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),e.pbrMode!==1&&e.pbrMode!==2||i.code.add(x`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))}function mV(t){const e=t.fragment;e.uniforms.add("lightingMainDirection","vec3"),e.uniforms.add("lightingMainIntensity","vec3"),e.uniforms.add("lightingFixedFactor","float"),e.code.add(x`vec3 evaluateMainLighting(vec3 normal_global, float shadowing) {
float dotVal = clamp(dot(normal_global, lightingMainDirection), 0.0, 1.0);
dotVal = mix(dotVal, 1.0, lightingFixedFactor);
return lightingMainIntensity * ((1.0 - shadowing) * dotVal);
}`)}function $E(t){t.vertex.code.add(x`const float PI = 3.141592653589793;`),t.fragment.code.add(x`const float PI = 3.141592653589793;
const float LIGHT_NORMALIZATION = 1.0 / PI;
const float INV_PI = 0.3183098861837907;
const float HALF_PI = 1.570796326794897;`)}function N6e(t){t.fragment.uniforms.add("anchorPosition","vec3").add("anchorPositionCrossFade","vec3").add("fadeInOutFactor","float").add("cloudsHeight","float").add("rotationMatrixClouds","mat4").add("rotationMatrixCloudsCrossFade","mat4").add("radiusCurvatureCorrectionFactor","float").add("radius","float").add("cameraPosition","vec3").add("totalFadeInOut","float").add("crossFade","int").add("crossFadeAnchorFactor","float").add("cloudVariables","vec2"),t.include($E),t.fragment.code.add(x`vec3 intersectWithCloudLayer(vec3 dir, vec3 camPos, vec3 spherePos, float radiusReduction)
{
vec3 dirAnchor = normalize(spherePos);
vec3 sphereOriginOffset = dirAnchor * radiusReduction;
float radiusClouds = radius + cloudsHeight - radiusReduction;
float B = 2.0 * dot(camPos - sphereOriginOffset, dir);
float C = dot(camPos - sphereOriginOffset, camPos - sphereOriginOffset) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = camPos + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),t.fragment.code.add(x`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),t.fragment.code.add(x`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),t.fragment.code.add(x`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
const float GAMMA_SRGB = 2.1;
const float INV_GAMMA_SRGB = 0.4761904;
vec3 calculateCloudColor(vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(lightingMainDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(lightingMainDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((lightingMainIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA_SRGB)), vec3(INV_GAMMA_SRGB));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * pow(dirDotLight, RIM_SCATTERING_FACTOR) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),t.fragment.code.add(x`vec4 getCloudData(vec3 rayDir)
{
vec4 cloudData = textureCube(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
return mix(vec4(vec3(clamp(1.0 - cloudVariables.y, 0.6, 1.0)), 0.0), cloudData, smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(mu)));
}`),t.fragment.code.add(x`vec4 renderCloud(vec3 worldRay)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(normalize(-worldRay), cloudData), totalTransmittance);
}`),t.fragment.code.add(x`vec4 renderCloudCrossFade(vec3 worldRay)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColor = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade, 0.0);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`)}function yd(t){t.code.add(x`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}function U6e(){const t=new pi;return t.attributes.add("position","vec2"),t.varyings.add("worldRay","vec3"),t.vertex.uniforms.add("inverseProjectionMatrix","mat4"),t.vertex.uniforms.add("inverseViewMatrix","mat4"),t.vertex.code.add(x`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),t.fragment.uniforms.add("lightingMainDirection","vec3").add("cubeMap","samplerCube"),t.fragment.include(yd),t.fragment.include(zu),t.include(mV),t.include(Pne,{pbrMode:0,lightingSphericalHarmonicsOrder:2}),t.include(N6e),t.fragment.code.add(x`void main() {
vec4 cloudsColor = crossFade == 0 ? renderCloud(normalize(worldRay)) : renderCloudCrossFade(normalize(worldRay));
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),t}const j6e=Object.freeze({__proto__:null,build:U6e});class EE extends Si{initializeProgram(e){const i=EE.shader.get().build();return new fi(e.rctx,i,Ht)}initializePipeline(){return _t({blending:Qa(1,770),depthTest:{func:515},colorWrite:Pt})}}EE.shader=new vi(j6e,()=>import("./CloudsComposition.glsl.9eebdcde.js"));var Ya,_n,Xa,d0;(function(t){t[t.FINISHED=0]="FINISHED",t[t.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",t[t.FADE_IN=2]="FADE_IN"})(Ya||(Ya={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.FADE_OUT=1]="FADE_OUT",t[t.FADE_IN=2]="FADE_IN"}(_n||(_n={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.CROSS_FADE=1]="CROSS_FADE"}(Xa||(Xa={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.HEIGHT_FADE=1]="HEIGHT_FADE"}(d0||(d0={}));class B6e{constructor(e,i,r,s){this._viewingMode=i,this._inverseProjectionMatrix=be(),this._inverseViewMatrix=be(),this._cameraPositionLastFrame=$(),this._technique=new EE({rctx:e,viewingMode:this._viewingMode},null),this._vao=vn(e),this._setDefaultParallax(r,s)}destroy(){this._technique=nr(this._technique),this._vao=Ge(this._vao)}render(e,i,r,s,n){const o=e.camera;if(A(this._vao)||A(o))return!1;const a=e.rctx,l=this._technique.program;return a.useProgram(l),this._technique.bindPipelineState(a),this._isCameraAnimating=r,e.scenelightingData.setLightDirectionUniform(l),e.scenelightingData.setUniforms(l),Fi(this._inverseProjectionMatrix,o.projectionMatrix),Fi(this._inverseViewMatrix,o.viewMatrix),l.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),l.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),l.bindTexture(i.colorTexture,"cubeMap"),l.setUniform2fv("cloudVariables",[s,n]),this._setParallaxParams(o.eye),this._bindParallaxParams(l,e.camera),a.bindVAO(this._vao),l.assertCompatibleVertexAttributeLocations(this._vao),a.drawArrays(5,0,4),!0}isFading(){return this._crossFadeParams.crossFadeStage!==Xa.FINISHED||this._fadeInOutParams.fadeInOutStage!==_n.FINISHED||this._fadeInParams.fadeInStage!==Ya.FINISHED||this._fadeInOutHeightParams.fadeHeightStage!==d0.FINISHED}_setDefaultParallax(e,i){this._parallaxParams={anchorPointClouds:$(),radius:e,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:be()},this._parallaxParamsNew={anchorPointClouds:$(),radius:e,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:be()},this._crossFadeParams={crossFadeStage:Xa.FINISHED,crossFadeFactor:0,distanceThresholdFactor:.3},this._fadeInOutParams={fadeInOutStage:_n.FINISHED,fadeInOutFactor:0,distanceThresholdFactor:.6},this._fadeInParams={fadeInStage:Ya.FINISHED,fadeInFactor:0,distanceThresholdFactor:2},this._fadeInOutHeightParams={fadeHeightStage:d0.FINISHED,fadeHeightFactor:i>1e4?1:0,heightThresholdFactor:1e4}}_isCameraPositionFinal(e){return mx(this._cameraPositionLastFrame,e)}_setFadeInStage(e){const i=this._isCameraPositionFinal(e);this._fadeInParams.fadeInStage===Ya.FINISHED&&(this._fadeInParams.fadeInFactor=1,re(this._parallaxParams.anchorPointClouds,vd),this._fadeInParams.fadeInStage=Ya.CHANGE_ANCHOR,this._crossFadeParams.crossFadeStage=Xa.FINISHED,this._fadeInOutParams.fadeInOutStage=_n.FINISHED),this._fadeInParams.fadeInStage===Ya.CHANGE_ANCHOR&&i&&(re(this._parallaxParams.anchorPointClouds,vd),this._fadeInParams.fadeInStage=Ya.FADE_IN,this._startTime=performance.now()),this._fadeInParams.fadeInFactor>0&&this._fadeInParams.fadeInStage===Ya.FADE_IN&&(this._fadeInParams.fadeInFactor=1-(performance.now()-this._startTime)/500),this._fadeInParams.fadeInFactor<=0&&this._fadeInParams.fadeInStage===Ya.FADE_IN&&(this._fadeInParams.fadeInStage=Ya.FINISHED,this._fadeInParams.fadeInFactor=0)}_setCrossFadingStage(){this._crossFadeParams.crossFadeStage===Xa.FINISHED&&(re(this._parallaxParamsNew.anchorPointClouds,vd),this._startTime=performance.now(),this._crossFadeParams.crossFadeFactor=0,this._crossFadeParams.crossFadeStage=Xa.CROSS_FADE),this._crossFadeParams.crossFadeFactor<1&&this._crossFadeParams.crossFadeStage===Xa.CROSS_FADE&&(this._crossFadeParams.crossFadeFactor=(performance.now()-this._startTime)/500),this._crossFadeParams.crossFadeFactor>=1&&this._crossFadeParams.crossFadeStage===Xa.CROSS_FADE&&(this._crossFadeParams.crossFadeStage=Xa.FINISHED,this._crossFadeParams.crossFadeFactor=1,re(this._parallaxParams.anchorPointClouds,this._parallaxParamsNew.anchorPointClouds))}_setFadeInOutStage(e){this._fadeInOutParams.fadeInOutStage===_n.FINISHED&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=0,this._fadeInOutParams.fadeInOutStage=_n.FADE_OUT),this._fadeInOutParams.fadeInOutFactor<1&&this._fadeInOutParams.fadeInOutStage===_n.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=(performance.now()-this._startTime)/250),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===_n.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=1,re(this._parallaxParams.anchorPointClouds,vd)),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===_n.FADE_OUT&&this._isCameraPositionFinal(e)&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=1,this._fadeInOutParams.fadeInOutStage=_n.FADE_IN,this._crossFadeParams.crossFadeStage=Xa.FINISHED,this._crossFadeParams.crossFadeFactor=0),this._fadeInOutParams.fadeInOutFactor>0&&this._fadeInOutParams.fadeInOutStage===_n.FADE_IN&&(this._fadeInOutParams.fadeInOutFactor=1-(performance.now()-this._startTime)/500),this._fadeInOutParams.fadeInOutFactor<=0&&this._fadeInOutParams.fadeInOutStage===_n.FADE_IN&&(this._fadeInOutParams.fadeInOutStage=_n.FINISHED,this._fadeInOutParams.fadeInOutFactor=0)}_setFadeInOutHeight(e){const i=performance.now();this._startTimeHeightFade=this._fadeInOutHeightParams.fadeHeightStage===d0.FINISHED?i:this._startTimeHeightFade,e?this._fadeInOutHeightParams.fadeHeightFactor+=(i-this._startTimeHeightFade)/500:this._fadeInOutHeightParams.fadeHeightFactor-=(i-this._startTimeHeightFade)/500,this._startTimeHeightFade=i,this._fadeInOutHeightParams.fadeHeightFactor=Re(this._fadeInOutHeightParams.fadeHeightFactor,0,1),this._fadeInOutHeightParams.fadeHeightStage=d0.HEIGHT_FADE}_setParallaxParams(e){_e(vd,e),se(vd,vd,this._parallaxParams.radius),this._parallaxParams.anchorPointClouds[0]===0&&this._parallaxParams.anchorPointClouds[1]===0&&this._parallaxParams.anchorPointClouds[2]===0&&re(this._parallaxParams.anchorPointClouds,vd);const i=Te(ue(G6e,this._parallaxParams.anchorPointClouds,vd));let r=!0;i>this._fadeInParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInParams.fadeInStage!==Ya.FINISHED?this._setFadeInStage(e):i>this._fadeInOutParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInOutParams.fadeInOutStage!==_n.FINISHED?this._setFadeInOutStage(e):i>this._crossFadeParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight&&!this._isCameraAnimating||this._crossFadeParams.crossFadeStage!==Xa.FINISHED?this._setCrossFadingStage():r=!1;const s=Te(e),n=s-this._parallaxParams.radius;(n>1.7*this._fadeInOutHeightParams.heightThresholdFactor||n<-1*this._fadeInOutHeightParams.heightThresholdFactor)&&this._fadeInOutHeightParams.fadeHeightFactor<1?this._fadeInOutHeightParams.fadeHeightFactor=1:(n>this._fadeInOutHeightParams.heightThresholdFactor||n<-.35*this._fadeInOutHeightParams.heightThresholdFactor)&&this._fadeInOutHeightParams.fadeHeightFactor<1?this._setFadeInOutHeight(!0):n<this._fadeInOutHeightParams.heightThresholdFactor&&n>-.35*this._fadeInOutHeightParams.heightThresholdFactor&&this._fadeInOutHeightParams.fadeHeightFactor>0?this._setFadeInOutHeight(!1):this._fadeInOutHeightParams.fadeHeightStage=d0.FINISHED,this._parallaxParams.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(s*s-this._parallaxParams.radius*this._parallaxParams.radius,0))/s,WS(Ane,this._parallaxParams.anchorPointClouds,Y_),this._parallaxParams.transform=be(),Bi(this._parallaxParams.transform,this._parallaxParams.transform,Y_[3],fV(Y_)),r&&(WS(Ane,this._parallaxParamsNew.anchorPointClouds,Y_),this._parallaxParamsNew.transform=be(),Bi(this._parallaxParamsNew.transform,this._parallaxParamsNew.transform,Y_[3],fV(Y_))),re(this._cameraPositionLastFrame,e)}_bindParallaxParams(e,i){e.setUniform1f("cloudsHeight",this._parallaxParams.cloudsHeight),e.setUniformMatrix4fv("rotationMatrixClouds",this._parallaxParams.transform),e.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",this._parallaxParamsNew.transform),e.setUniform3fv("anchorPosition",this._parallaxParams.anchorPointClouds),e.setUniform3fv("anchorPositionCrossFade",this._parallaxParamsNew.anchorPointClouds),this._fadeInOutParams.fadeInOutStage!==_n.FINISHED?e.setUniform1f("totalFadeInOut",this._fadeInOutHeightParams.fadeHeightFactor+Math.max(Re(this._fadeInOutParams.fadeInOutFactor,0,1))):e.setUniform1f("totalFadeInOut",this._fadeInOutHeightParams.fadeHeightFactor+Math.max(Re(this._fadeInParams.fadeInFactor,0,1))),e.setUniform1f("radiusCurvatureCorrectionFactor",this._parallaxParams.radiusCurvatureCorrectionFactor),e.setUniform1i("crossFade",this._crossFadeParams.crossFadeStage),e.setUniform1f("crossFadeAnchorFactor",Re(this._crossFadeParams.crossFadeFactor,0,1)),e.setUniform1f("radius",this._parallaxParams.radius),e.setUniform3fv("cameraPosition",i.eye)}}const Ane=De(0,0,1),Y_=Q_(),vd=$(),G6e=$();function Ka(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function ZS(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function gV(t,e,i,r,s,n,o,a,l,c){return t[0]=e,t[1]=i,t[2]=r,t[3]=s,t[4]=n,t[5]=o,t[6]=a,t[7]=l,t[8]=c,t}function yV(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function el(t,e){if(t===e){const i=e[1],r=e[2],s=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=r,t[7]=s}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function p0(t,e){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=h*o-a*c,f=-h*n+a*l,g=c*n-o*l;let y=i*p+r*f+s*g;return y?(y=1/y,t[0]=p*y,t[1]=(-h*r+s*c)*y,t[2]=(a*r-s*o)*y,t[3]=f*y,t[4]=(h*i-s*l)*y,t[5]=(-a*i+s*n)*y,t[6]=g*y,t[7]=(-c*i+r*l)*y,t[8]=(o*i-r*n)*y,t):null}function q6e(t,e){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8];return t[0]=o*h-a*c,t[1]=s*c-r*h,t[2]=r*a-s*o,t[3]=a*l-n*h,t[4]=i*h-s*l,t[5]=s*n-i*a,t[6]=n*c-o*l,t[7]=r*l-i*c,t[8]=i*o-r*n,t}function H6e(t){const e=t[0],i=t[1],r=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8];return e*(c*n-o*l)+i*(-c*s+o*a)+r*(l*s-n*a)}function OE(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=i[0],g=i[1],y=i[2],v=i[3],b=i[4],w=i[5],S=i[6],T=i[7],C=i[8];return t[0]=f*r+g*o+y*c,t[1]=f*s+g*a+y*h,t[2]=f*n+g*l+y*p,t[3]=v*r+b*o+w*c,t[4]=v*s+b*a+w*h,t[5]=v*n+b*l+w*p,t[6]=S*r+T*o+C*c,t[7]=S*s+T*a+C*h,t[8]=S*n+T*l+C*p,t}function RE(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=i[0],g=i[1];return t[0]=r,t[1]=s,t[2]=n,t[3]=o,t[4]=a,t[5]=l,t[6]=f*r+g*o+c,t[7]=f*s+g*a+h,t[8]=f*n+g*l+p,t}function vV(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=Math.sin(i),g=Math.cos(i);return t[0]=g*r+f*o,t[1]=g*s+f*a,t[2]=g*n+f*l,t[3]=g*o-f*r,t[4]=g*a-f*s,t[5]=g*l-f*n,t[6]=c,t[7]=h,t[8]=p,t}function _V(t,e,i){const r=i[0],s=i[1],n=i[2];return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=s*e[3],t[4]=s*e[4],t[5]=s*e[5],t[6]=n*e[6],t[7]=n*e[7],t[8]=n*e[8],t}function W6e(t,e,i){const r=i[0],s=i[1];return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=s*e[3],t[4]=s*e[4],t[5]=s*e[5],t}function Z6e(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t}function J6e(t,e){const i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=i,t[2]=0,t[3]=-i,t[4]=r,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function Q6e(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function Y6e(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t}function bV(t,e){const i=e[0],r=e[1],s=e[2],n=e[3],o=i+i,a=r+r,l=s+s,c=i*o,h=r*o,p=r*a,f=s*o,g=s*a,y=s*l,v=n*o,b=n*a,w=n*l;return t[0]=1-p-y,t[3]=h-w,t[6]=f+b,t[1]=h+w,t[4]=1-c-y,t[7]=g-v,t[2]=f-b,t[5]=g+v,t[8]=1-c-p,t}function $ne(t,e){const i=e[0],r=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],c=e[9],h=e[10],p=h*o-a*c,f=-h*n+a*l,g=c*n-o*l,y=i*p+r*f+s*g;if(!y)return null;const v=1/y;return t[0]=p*v,t[1]=(-h*r+s*c)*v,t[2]=(a*r-s*o)*v,t[3]=f*v,t[4]=(h*i-s*l)*v,t[5]=(-a*i+s*n)*v,t[6]=g*v,t[7]=(-c*i+r*l)*v,t[8]=(o*i-r*n)*v,t}function X_(t,e){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],g=e[11],y=e[12],v=e[13],b=e[14],w=e[15],S=i*a-r*o,T=i*l-s*o,C=i*c-n*o,M=r*l-s*a,P=r*c-n*a,F=s*c-n*l,z=h*v-p*y,D=h*b-f*y,U=h*w-g*y,G=p*b-f*v,k=p*w-g*v,j=f*w-g*b;let V=S*j-T*k+C*G+M*U-P*D+F*z;return V?(V=1/V,t[0]=(a*j-l*k+c*G)*V,t[1]=(l*U-o*j-c*D)*V,t[2]=(o*k-a*U+c*z)*V,t[3]=(s*k-r*j-n*G)*V,t[4]=(i*j-s*U+n*D)*V,t[5]=(r*U-i*k-n*z)*V,t[6]=(v*F-b*P+w*M)*V,t[7]=(b*C-y*F-w*T)*V,t[8]=(y*P-v*C+w*S)*V,t):null}function X6e(t,e,i){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/i,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t}function K6e(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"}function eke(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+t[6]**2+t[7]**2+t[8]**2)}function tke(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t[8]=e[8]+i[8],t}function Ene(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t[6]=e[6]-i[6],t[7]=e[7]-i[7],t[8]=e[8]-i[8],t}function ike(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*i,t}function rke(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t[4]=e[4]+i[4]*r,t[5]=e[5]+i[5]*r,t[6]=e[6]+i[6]*r,t[7]=e[7]+i[7]*r,t[8]=e[8]+i[8]*r,t}function ske(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]}function nke(t,e){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=e[0],f=e[1],g=e[2],y=e[3],v=e[4],b=e[5],w=e[6],S=e[7],T=e[8];return Math.abs(i-p)<=it*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(r-f)<=it*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(s-g)<=it*Math.max(1,Math.abs(s),Math.abs(g))&&Math.abs(n-y)<=it*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(o-v)<=it*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(a-b)<=it*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(l-w)<=it*Math.max(1,Math.abs(l),Math.abs(w))&&Math.abs(c-S)<=it*Math.max(1,Math.abs(c),Math.abs(S))&&Math.abs(h-T)<=it*Math.max(1,Math.abs(h),Math.abs(T))}function wV(t){const e=it,i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8];return Math.abs(1-(i*i+n*n+l*l))<=e&&Math.abs(1-(r*r+o*o+c*c))<=e&&Math.abs(1-(s*s+a*a+h*h))<=e}const oke=OE,ake=Ene;Object.freeze({__proto__:null,fromMat4:Ka,copy:ZS,set:gV,identity:yV,transpose:el,invert:p0,adjoint:q6e,determinant:H6e,multiply:OE,translate:RE,rotate:vV,scale:_V,scaleByVec2:W6e,fromTranslation:Z6e,fromRotation:J6e,fromScaling:Q6e,fromMat2d:Y6e,fromQuat:bV,normalFromMat4Legacy:$ne,normalFromMat4:X_,projection:X6e,str:K6e,frob:eke,add:tke,subtract:Ene,multiplyScalar:ike,multiplyScalarAndAdd:rke,exactEquals:ske,equals:nke,isOrthoNormal:wV,mul:oke,sub:ake});function li(){return new Float32Array(3)}function IE(t){const e=new Float32Array(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function xt(t,e,i){const r=new Float32Array(3);return r[0]=t,r[1]=e,r[2]=i,r}function One(t,e){return new Float32Array(t,e,3)}function xV(){return li()}function Rne(){return xt(1,1,1)}function Ine(){return xt(1,0,0)}function Dne(){return xt(0,1,0)}function Fne(){return xt(0,0,1)}const lke=xV(),cke=Rne(),uke=Ine(),hke=Dne(),dke=Fne();Object.freeze({__proto__:null,create:li,clone:IE,fromValues:xt,createView:One,zeros:xV,ones:Rne,unitX:Ine,unitY:Dne,unitZ:Fne,ZEROS:lke,ONES:cke,UNIT_X:uke,UNIT_Y:hke,UNIT_Z:dke});class JS{constructor(e,i){this._context=e,this._desc=i,this._context.instanceCounter.increment(kr.Renderbuffer,this);const r=this._context.gl;this.glName=r.createRenderbuffer(),this._context.bindRenderbuffer(this),r.renderbufferStorage(r.RENDERBUFFER,i.internalFormat,i.width,i.height)}get descriptor(){return this._desc}resize(e,i){const r=this._desc;if(r.width===e&&r.height===i)return;r.width=e,r.height=i;const s=this._context.gl;this._context.bindRenderbuffer(this),s.renderbufferStorage(s.RENDERBUFFER,r.internalFormat,r.width,r.height)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(kr.Renderbuffer,this),this._context=null)}}const pke=le.getLogger("esri.views.webgl.FrameBufferObject");class ci{constructor(e,i,r=null,s=null){if(this._context=e,this._glName=null,this._depthAttachment=null,this._stencilAttachment=null,this._colorAttachments=new Map,this._initialized=!1,this._desc=E({},i),e.instanceCounter.increment(kr.Framebuffer,this),_(r)){Array.isArray(r)||(r=[r]);for(let l=0;l<r.length;++l){var n,o;const c=r[l];let h;f0(c)?(h=c.descriptor,this._colorAttachments.set(36064+l,c)):(h=c,this._colorAttachments.set(36064+l,new qe(e,c))),((n=this._desc)==null?void 0:n.colorTarget)!==0&&((o=this._desc)==null?void 0:o.colorTarget)!==2&&console.error("Framebuffer is initialized with a texture however the descriptor indicates using a renderbuffer color attachment!"),this._validateColorAttachmentPoint(36064+l),this._validateTextureDimensions(h,this._desc)}}if(s instanceof JS){var a;const l=(a=this._desc.depthStencilTarget)!=null?a:3;l===2?this._stencilAttachment=s:l===1||l===3?this._depthAttachment=s:console.error('If a Renderbuffer is provided, "depthStencilTarget" must be one of STENCIL_RENDER_BUFFER, DEPTH_RENDER_BUFFER or DEPTH_STENCIL_RENDER_BUFFER'),Lne(s.descriptor,this._desc)}else if(_(s)){let l;this._context.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!"),f0(s)?(this._depthStencilTexture=s,l=s.descriptor):this._depthStencilTexture=new qe(this._context,s),this._validateTextureDimensions(l,this._desc)}}dispose(){if(!this._desc)return;const e=this._context.getBoundFramebufferObject();this._disposeColorAttachments(),this._disposeDepthStencilAttachments(),this._glName&&(this._context.gl.deleteFramebuffer(this._glName),this._glName=null),this._context.bindFramebuffer(e),this._context.instanceCounter.decrement(kr.Framebuffer,this),this._desc=null}get glName(){return this._glName}get descriptor(){return this._desc}get colorTexture(){const e=this._colorAttachments.get(36064);return e&&f0(e)?e:null}get colorAttachment(){return this._colorAttachments.get(36064)}get depthStencilAttachment(){return this._depthStencilTexture||this._depthAttachment||this._stencilAttachment}get depthStencilTexture(){return this._depthStencilTexture}get width(){return this._desc.width}get height(){return this._desc.height}get gpuMemoryUsage(){return Gf(this.colorAttachment)+Gf(this.depthStencilAttachment)}getColorTexture(e){const i=this._colorAttachments.get(e);return i&&f0(i)?i:null}framebufferTexture2D(e,i,r=36064,s=3553,n=0){i.framebufferTexture2D(i.FRAMEBUFFER,r,s,e,n)}attachColorTexture(e,i=36064){if(!e)return;this._validateColorAttachmentPoint(i);const r=e.descriptor;this._validateTextureDimensions(r,this._desc),this._disposeColorAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this.framebufferTexture2D(e.glName,this._context.gl,i)),this._colorAttachments.set(i,e)}detachColorTexture(e=36064){const i=this._colorAttachments.get(e);if(f0(i)){const r=i;return this._initialized&&(this._context.bindFramebuffer(this),this.framebufferTexture2D(null,this._context.gl,e)),this._colorAttachments.delete(e),r}}attachDepthStencilTexture(e){if(A(e))return;const i=e.descriptor;i.pixelFormat!==34041&&console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!"),i.dataType!==34042&&console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"),this._context.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture!"),this._validateTextureDimensions(i,this._desc),this._desc.depthStencilTarget&&this._desc.depthStencilTarget!==4&&(this._desc.depthStencilTarget=4),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this.framebufferTexture2D(e.glName,this._context.gl,zse)),this._depthStencilTexture=e}detachDepthStencilTexture(){const e=this._depthStencilTexture;return e&&this._initialized&&(this._context.bindFramebuffer(this),this.framebufferTexture2D(null,this._context.gl,zse)),this._depthStencilTexture=null,e}attachDepthStencilBuffer(e){if(A(e))return;const i=e.descriptor;if(i.internalFormat!==34041&&i.internalFormat!==33189&&console.error("Depth/Stencil buffer must have correct internalFormat"),Lne(i,this._desc),this._disposeDepthStencilAttachments(),this._desc.depthStencilTarget=i.internalFormat===34041?3:1,this._initialized){this._context.bindFramebuffer(this);const r=this._context.gl,s=this._desc.depthStencilTarget===1?r.DEPTH_ATTACHMENT:r.DEPTH_STENCIL_ATTACHMENT;r.framebufferRenderbuffer(r.FRAMEBUFFER,s,r.RENDERBUFFER,e.glName)}this._depthAttachment=e}detachDepthStencilBuffer(){const e=this._context.gl,i=this._depthAttachment;if(i&&this._initialized){this._context.bindFramebuffer(this);const r=this._desc.depthStencilTarget===1?e.DEPTH_ATTACHMENT:e.DEPTH_STENCIL_ATTACHMENT;e.framebufferRenderbuffer(e.FRAMEBUFFER,r,e.RENDERBUFFER,null)}return this._depthAttachment=null,i}detachAll(){this.detachColorTexture(),this.detachDepthStencilBuffer(),this.detachDepthStencilTexture()}copyToTexture(e,i,r,s,n,o,a){(e<0||i<0||n<0||o<0)&&console.error("Offsets cannot be negative!"),(r<=0||s<=0)&&console.error("Copy width and height must be greater than zero!");const l=this._desc,c=a.descriptor;a.descriptor.target!==3553&&console.error("Texture target must be TEXTURE_2D!"),(e+r>l.width||i+s>l.height||n+r>c.width||o+s>c.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const h=this._context,p=h.bindTexture(a,qe.TEXTURE_UNIT_FOR_UPDATES);h.bindFramebuffer(this),h.gl.copyTexSubImage2D(3553,0,n,o,e,i,r,s),h.bindTexture(p,qe.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,i,r,s,n,o,a){(r<=0||s<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,i,r,s,n,o,a)}resize(e,i){const r=this._desc;if(r.width!==e||r.height!==i){if(!this._initialized)return r.width=e,r.height=i,this._colorAttachments.forEach(s=>{s&&s.resize(e,i)}),void(this._depthStencilTexture&&this._depthStencilTexture.resize(e,i));r.width=e,r.height=i,this._colorAttachments.forEach(s=>{s&&s.resize(e,i)}),this._depthStencilTexture!=null?this._depthStencilTexture.resize(e,i):(this._depthAttachment||this._stencilAttachment)&&(this._depthAttachment&&this._depthAttachment.resize(e,i),this._stencilAttachment&&this._stencilAttachment.resize(e,i)),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1}}initializeAndBind(e=3553){var i,r,s,n;const o=this._context.gl;if(this._initialized)return void o.bindFramebuffer(o.FRAMEBUFFER,this.glName);this._glName&&o.deleteFramebuffer(this._glName);const a=this._context,l=o.createFramebuffer(),c=this._desc,h=(i=c.colorTarget)!=null?i:1,p=(r=c.width)!=null?r:1,f=(s=c.height)!=null?s:1;if(o.bindFramebuffer(o.FRAMEBUFFER,l),this._colorAttachments.size===0)if(h===0)this._colorAttachments.set(36064,fke(a,c,this.descriptor.colorTarget===2?34067:3553));else{const y=new JS(a,{internalFormat:32854,width:p,height:f});this._colorAttachments.set(36064,y)}this._colorAttachments.forEach((y,v)=>{y&&(f0(y)?this.framebufferTexture2D(y.glName,o,v,e):o.framebufferRenderbuffer(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.RENDERBUFFER,y.glName))});const g=(n=c.depthStencilTarget)!=null?n:0;switch(g){case 1:case 3:{this._depthAttachment||(this._depthAttachment=new JS(a,{internalFormat:c.depthStencilTarget===1?33189:34041,width:p,height:f}));const y=g===1?o.DEPTH_ATTACHMENT:o.DEPTH_STENCIL_ATTACHMENT;o.framebufferRenderbuffer(o.FRAMEBUFFER,y,o.RENDERBUFFER,this._depthAttachment.glName);break}case 2:this._stencilAttachment||(this._stencilAttachment=new JS(a,{internalFormat:36168,width:p,height:f})),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.STENCIL_ATTACHMENT,o.RENDERBUFFER,this._stencilAttachment.glName);break;case 4:if(!this._depthStencilTexture){a.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!");const y={target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:p,height:f};this._depthStencilTexture=new qe(a,y)}this.framebufferTexture2D(this._depthStencilTexture.glName,o,o.DEPTH_STENCIL_ATTACHMENT,e)}CE()&&o.checkFramebufferStatus(o.FRAMEBUFFER)!==o.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=l,this._initialized=!0}_disposeColorAttachments(){this._colorAttachments.forEach((e,i)=>{if(f0(e))this._initialized&&(this._context.bindFramebuffer(this),this.framebufferTexture2D(null,this._context.gl,i)),e.dispose();else if(e instanceof WebGLRenderbuffer){const r=this._context.gl;this._initialized&&(this._context.bindFramebuffer(this),r.framebufferRenderbuffer(r.FRAMEBUFFER,i,r.RENDERBUFFER,null)),this._context.gl.deleteRenderbuffer(e)}}),this._colorAttachments.clear()}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthAttachment){if(this._initialized){this._context.bindFramebuffer(this);const i=this._desc.depthStencilTarget===1?e.DEPTH_ATTACHMENT:e.DEPTH_STENCIL_ATTACHMENT;e.framebufferRenderbuffer(e.FRAMEBUFFER,i,e.RENDERBUFFER,null)}this._depthAttachment.dispose(),this._depthAttachment=null}this._stencilAttachment&&(this._initialized&&(this._context.bindFramebuffer(this),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.STENCIL_ATTACHMENT,e.RENDERBUFFER,null)),this._stencilAttachment.dispose(),this._stencilAttachment=null),this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this.framebufferTexture2D(null,e,e.DEPTH_STENCIL_ATTACHMENT)),this._depthStencilTexture.dispose(),this._depthStencilTexture=null)}_validateTextureDimensions(e,i){e.target!==3553&&e.target!==34067&&console.error("Texture type must be TEXTURE_2D or TEXTURE_CUBE_MAP!"),i.width!==void 0&&i.width>=0&&i.height!==void 0&&i.height>=0?i.width===e.width&&i.height===e.height||console.error("Color attachment texture must match the framebuffer's!"):(i.width=e.width,i.height=e.height)}_validateColorAttachmentPoint(e){if(ci._MAX_COLOR_ATTACHMENTS===-1){const r=this._context.capabilities.drawBuffers;if(r){const s=this._context.gl;ci._MAX_COLOR_ATTACHMENTS=s.getParameter(r.MAX_COLOR_ATTACHMENTS)}else ci._MAX_COLOR_ATTACHMENTS=1}const i=e-36064;i+1>ci._MAX_COLOR_ATTACHMENTS&&pke.error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${i+1}. Implementation supports up to ${ci._MAX_COLOR_ATTACHMENTS} color attachments`)}}function f0(t){return"type"in t&&t.type==="texture"}function fke(t,e,i){return new qe(t,{target:i,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e.width,height:e.height})}function Lne(t,e){e.width!==void 0&&e.width>=0&&e.height!==void 0&&e.height>=0?e.width===t.width&&e.height===t.height||console.error("Renderbuffer dimensions must match the framebuffer's!"):(e.width=t.width,e.height=t.height)}ci._MAX_COLOR_ATTACHMENTS=-1;function mke(){const t=new pi;return t.attributes.add("position","vec3"),t.vertex.code.add(x`void main(void) {
gl_Position = vec4(position, 1.0);
}`),t.fragment.uniforms.add("tileRows","float").add("tileSize","float"),t.fragment.code.add(`
    #define NUM_CELLS 2.0
    #define PERLIN_WORLEY 0
    #define WORLEY 1

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    vec4 taylorInvSqrt(vec4 r) {
      return 1.79284291400159 - 0.85373472095314 * r;
    }

    vec4 mod289(vec4 x) {
      return x - floor( x * (1.0 / 289.0)) * 289.0;
    }

    vec4 permute(vec4 x) {
      return mod289(((x * 34.0) + 1.0) * x);
    }

    vec4 fade(vec4 t) {
      return (t * t * t) * (t * (t * vec4(6) - vec4(15)) + vec4(10));
    }

    float glmPerlin(vec4 Position, vec4 rep) {
      vec4 Pi0 = mod(floor(Position), rep);
      vec4 Pi1 = mod(Pi0 + float(1), rep);
      vec4 Pf0 = fract(Position);
      vec4 Pf1 = Pf0 - float(1);
      vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);
      vec4 iy = vec4(Pi0.y, Pi0.y, Pi1.y, Pi1.y);
      vec4 iz0 = vec4(Pi0.z);
      vec4 iz1 = vec4(Pi1.z);
      vec4 iw0 = vec4(Pi0.w);
      vec4 iw1 = vec4(Pi1.w);

      vec4 ixy = permute(permute(ix) + iy);
      vec4 ixy0 = permute(ixy + iz0);
      vec4 ixy1 = permute(ixy + iz1);
      vec4 ixy00 = permute(ixy0 + iw0);
      vec4 ixy01 = permute(ixy0 + iw1);
      vec4 ixy10 = permute(ixy1 + iw0);
      vec4 ixy11 = permute(ixy1 + iw1);

      vec4 gx00 = ixy00 / float(7);
      vec4 gy00 = floor(gx00) / float(7);
      vec4 gz00 = floor(gy00) / float(6);
      gx00 = fract(gx00) - float(0.5);
      gy00 = fract(gy00) - float(0.5);
      gz00 = fract(gz00) - float(0.5);
      vec4 gw00 = vec4(0.75) - abs(gx00) - abs(gy00) - abs(gz00);
      vec4 sw00 = step(gw00, vec4(0));
      gx00 -= sw00 * (step(float(0), gx00) - float(0.5));
      gy00 -= sw00 * (step(float(0), gy00) - float(0.5));

      vec4 gx01 = ixy01 / float(7);
      vec4 gy01 = floor(gx01) / float(7);
      vec4 gz01 = floor(gy01) / float(6);
      gx01 = fract(gx01) - float(0.5);
      gy01 = fract(gy01) - float(0.5);
      gz01 = fract(gz01) - float(0.5);
      vec4 gw01 = vec4(0.75) - abs(gx01) - abs(gy01) - abs(gz01);
      vec4 sw01 = step(gw01, vec4(0.0));
      gx01 -= sw01 * (step(float(0), gx01) - float(0.5));
      gy01 -= sw01 * (step(float(0), gy01) - float(0.5));

      vec4 gx10 = ixy10 / float(7);
      vec4 gy10 = floor(gx10) / float(7);
      vec4 gz10 = floor(gy10) / float(6);
      gx10 = fract(gx10) - float(0.5);
      gy10 = fract(gy10) - float(0.5);
      gz10 = fract(gz10) - float(0.5);
      vec4 gw10 = vec4(0.75) - abs(gx10) - abs(gy10) - abs(gz10);
      vec4 sw10 = step(gw10, vec4(0.0));
      gx10 -= sw10 * (step(float(0), gx10) - float(0.5));
      gy10 -= sw10 * (step(float(0), gy10) - float(0.5));

      vec4 gx11 = ixy11 / float(7);
      vec4 gy11 = floor(gx11) / float(7);
      vec4 gz11 = floor(gy11) / float(6);
      gx11 = fract(gx11) - float(0.5);
      gy11 = fract(gy11) - float(0.5);
      gz11 = fract(gz11) - float(0.5);
      vec4 gw11 = vec4(0.75) - abs(gx11) - abs(gy11) - abs(gz11);
      vec4 sw11 = step(gw11, vec4(float(0)));
      gx11 -= sw11 * (step(float(0), gx11) - float(0.5));
      gy11 -= sw11 * (step(float(0), gy11) - float(0.5));

      vec4 g0000 = vec4(gx00.x, gy00.x, gz00.x, gw00.x);
      vec4 g1000 = vec4(gx00.y, gy00.y, gz00.y, gw00.y);
      vec4 g0100 = vec4(gx00.z, gy00.z, gz00.z, gw00.z);
      vec4 g1100 = vec4(gx00.w, gy00.w, gz00.w, gw00.w);
      vec4 g0010 = vec4(gx10.x, gy10.x, gz10.x, gw10.x);
      vec4 g1010 = vec4(gx10.y, gy10.y, gz10.y, gw10.y);
      vec4 g0110 = vec4(gx10.z, gy10.z, gz10.z, gw10.z);
      vec4 g1110 = vec4(gx10.w, gy10.w, gz10.w, gw10.w);
      vec4 g0001 = vec4(gx01.x, gy01.x, gz01.x, gw01.x);
      vec4 g1001 = vec4(gx01.y, gy01.y, gz01.y, gw01.y);
      vec4 g0101 = vec4(gx01.z, gy01.z, gz01.z, gw01.z);
      vec4 g1101 = vec4(gx01.w, gy01.w, gz01.w, gw01.w);
      vec4 g0011 = vec4(gx11.x, gy11.x, gz11.x, gw11.x);
      vec4 g1011 = vec4(gx11.y, gy11.y, gz11.y, gw11.y);
      vec4 g0111 = vec4(gx11.z, gy11.z, gz11.z, gw11.z);
      vec4 g1111 = vec4(gx11.w, gy11.w, gz11.w, gw11.w);

      vec4 norm00 = taylorInvSqrt(vec4(dot(g0000, g0000), dot(g0100, g0100), dot(g1000, g1000), dot(g1100, g1100)));
      g0000 *= norm00.x;
      g0100 *= norm00.y;
      g1000 *= norm00.z;
      g1100 *= norm00.w;

      vec4 norm01 = taylorInvSqrt(vec4(dot(g0001, g0001), dot(g0101, g0101), dot(g1001, g1001), dot(g1101, g1101)));
      g0001 *= norm01.x;
      g0101 *= norm01.y;
      g1001 *= norm01.z;
      g1101 *= norm01.w;

      vec4 norm10 = taylorInvSqrt(vec4(dot(g0010, g0010), dot(g0110, g0110), dot(g1010, g1010), dot(g1110, g1110)));
      g0010 *= norm10.x;
      g0110 *= norm10.y;
      g1010 *= norm10.z;
      g1110 *= norm10.w;

      vec4 norm11 = taylorInvSqrt(vec4(dot(g0011, g0011), dot(g0111, g0111), dot(g1011, g1011), dot(g1111, g1111)));
      g0011 *= norm11.x;
      g0111 *= norm11.y;
      g1011 *= norm11.z;
      g1111 *= norm11.w;

      float n0000 = dot(g0000, Pf0);
      float n1000 = dot(g1000, vec4(Pf1.x, Pf0.y, Pf0.z, Pf0.w));
      float n0100 = dot(g0100, vec4(Pf0.x, Pf1.y, Pf0.z, Pf0.w));
      float n1100 = dot(g1100, vec4(Pf1.x, Pf1.y, Pf0.z, Pf0.w));
      float n0010 = dot(g0010, vec4(Pf0.x, Pf0.y, Pf1.z, Pf0.w));
      float n1010 = dot(g1010, vec4(Pf1.x, Pf0.y, Pf1.z, Pf0.w));
      float n0110 = dot(g0110, vec4(Pf0.x, Pf1.y, Pf1.z, Pf0.w));
      float n1110 = dot(g1110, vec4(Pf1.x, Pf1.y, Pf1.z, Pf0.w));
      float n0001 = dot(g0001, vec4(Pf0.x, Pf0.y, Pf0.z, Pf1.w));
      float n1001 = dot(g1001, vec4(Pf1.x, Pf0.y, Pf0.z, Pf1.w));
      float n0101 = dot(g0101, vec4(Pf0.x, Pf1.y, Pf0.z, Pf1.w));
      float n1101 = dot(g1101, vec4(Pf1.x, Pf1.y, Pf0.z, Pf1.w));
      float n0011 = dot(g0011, vec4(Pf0.x, Pf0.y, Pf1.z, Pf1.w));
      float n1011 = dot(g1011, vec4(Pf1.x, Pf0.y, Pf1.z, Pf1.w));
      float n0111 = dot(g0111, vec4(Pf0.x, Pf1.y, Pf1.z, Pf1.w));
      float n1111 = dot(g1111, Pf1);

      vec4 fade_xyzw = fade(Pf0);
      vec4 n_0w = mix(vec4(n0000, n1000, n0100, n1100), vec4(n0001, n1001, n0101, n1101), fade_xyzw.w);
      vec4 n_1w = mix(vec4(n0010, n1010, n0110, n1110), vec4(n0011, n1011, n0111, n1111), fade_xyzw.w);
      vec4 n_zw = mix(n_0w, n_1w, fade_xyzw.z);
      vec2 n_yzw = mix(vec2(n_zw.x, n_zw.y), vec2(n_zw.z, n_zw.w), fade_xyzw.y);
      float n_xyzw = mix(n_yzw.x, n_yzw.y, fade_xyzw.x);
      return float(2.2) * n_xyzw;
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      const float octaveFrequencyFactor = 2.0;

      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * glmPerlin(vec4(p, 0.0), vec4(frequency));
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float hash(float p) {
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);;
    }

    float noise(vec3 x) {
      vec3 p = floor(x);
      vec3 f = fract(x);

      f = f * f * (3.0 - 2.0 * f);
      float n = p.x + p.y * 57.0 + 113.0 * p.z;

      return mix(
      mix(
        mix(hash(n + 0.0), hash(n + 1.0), f.x),
        mix(hash(n + 57.0), hash(n + 58.0), f.x),
        f.y),
      mix(
        mix(hash(n + 113.0), hash(n + 114.0), f.x),
        mix(hash(n + 170.0), hash(n + 171.0), f.x),
        f.y),
      f.z);
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - noise(mod(tp, numCells));
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv, float tileRows) {
      vec2 tile = floor(uv);
      float z = floor(tileRows * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPoint(vec3 p, int type) {
      if (type == PERLIN_WORLEY) {

        const float frequency = 8.0;
        float perlinNoise = getPerlinNoise(p, frequency);

        float worley0 = worley(p, NUM_CELLS * 2.0);
        float worley1 = worley(p, NUM_CELLS * 8.0);
        float worley2 = worley(p, NUM_CELLS * 14.0);

        float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
        return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
      }

      float worley0 = worley(p, NUM_CELLS);
      float worley1 = worley(p, NUM_CELLS * 2.0);
      float worley2 = worley(p, NUM_CELLS * 4.0);
      float worley3 = worley(p, NUM_CELLS * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `),t.fragment.code.add(`
    void main() {
      const float padWidth = 1.0;
      float paddedSize = tileSize + 2.0 * padWidth;
      float tileCount = tileRows * tileRows;
      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

      bool padCell = false;
      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      bool startPadX = false;
      bool startPadY = false;
      bool endPadX = false;
      bool endPadY = false;

      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
        startPadX = true;
      }

      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
        startPadY = true;
      }

      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
        endPadX = true;
      }

      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
        endPadY = true;
      }

      vec2 padding = vec2(2.0 * padWidth) * tile;
      vec2 uv;

      if (padCell) {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;

        if (startPadX) {
          pixel.x += tileSize;	
        }

        if (startPadY) {
          pixel.y += tileSize;	
        }

        if (endPadX) {
          pixel.x -= tileSize;	
        }

        if (endPadY) {
          pixel.y -= tileSize;	
        }

        uv = vec2(pixel.xy / tileSize);
      } else {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;
        uv = vec2(pixel.xy / tileSize);
      }

      vec3 p_ = get3Dfrom2D(uv, tileRows);
      vec3 p = p_;
      p.z /= (tileRows * tileRows);

      float worleyPerlinNoise = getTextureForPoint(p, PERLIN_WORLEY);
      float worleyNoise = getTextureForPoint(p, WORLEY);

      gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      p_ = mod(p_ + 1.0, tileRows * tileRows);
      p = p_;
      p.z /= (tileRows * tileRows);

      worleyPerlinNoise = getTextureForPoint(p, PERLIN_WORLEY);
      worleyNoise = getTextureForPoint(p, WORLEY);

      gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

    	gl_FragColor.ba = vec2(0, 1);
    }
  `),t}const gke=Object.freeze({__proto__:null,build:mke});class DE extends Si{initializeProgram(e){const i=DE.shader.get().build();return new fi(e.rctx,i,Ht)}initializePipeline(){return _t({blending:Qa(1,0),depthTest:{func:515},colorWrite:Pt})}}DE.shader=new vi(gke,()=>import("./NoiseTextureAtlas.glsl.aa0e8d40.js"));const QS=ae("esri-mobile")?64:128,SV=Math.ceil(Math.sqrt(QS)),qf=(QS+2)*SV;class yke{constructor(e,i){this._shapeTextureDescriptor={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1,width:1,height:1},this._frameBuffer=new ci(e,{colorTarget:0}),this._vao=vn(e),this.textureAtlas=new qe(e,this._shapeTextureDescriptor,null),this._technique=new DE({rctx:e,viewingMode:i.state.viewingMode},null)}destroy(){this._technique=nr(this._technique),this._frameBuffer=Ge(this._frameBuffer),this._vao=Ge(this._vao),this.textureAtlas=Ge(this.textureAtlas)}render(e){if(A(this._vao)||A(this.textureAtlas))return!1;this._frameBuffer.resize(qf,qf),this.textureAtlas.resize(qf,qf),this._frameBuffer.attachColorTexture(this.textureAtlas),e.bindFramebuffer(this._frameBuffer);const i=this._technique.program;e.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),this._technique.bindPipelineState(e),e.useProgram(i),i.setUniform1f("tileSize",QS),i.setUniform1f("tileRows",SV);const r=e.getViewport();return e.setViewport(0,0,qf,qf),e.gl.drawArrays(e.gl.TRIANGLE_STRIP,0,4),this._frameBuffer.detachColorTexture(),e.setViewport(r.x,r.y,r.width,r.height),!0}}function vke(t){const e=new pi;return e.attributes.add("position","vec3"),e.fragment.uniforms.add("cloudRadius","float").add("halfCubeMapSize","float").add("power","float").add("sigmaE","float").add("density","float").add("cloudSize","float").add("detailSize","float").add("smoothness","float").add("cloudHeight","float").add("coverage","float").add("viewMatrix","mat3").add("cloudShapeTexture","sampler2D"),e.vertex.code.add(x`void main(void) {
gl_Position = vec4(position, 1.0);
}`),e.fragment.code.add(x`
    const int STEPS = ${t.steps===0?x`16`:t.steps===1?x`100`:x`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);

    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),e.fragment.code.add(`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = float(${qf});
      const float dataWidth = float(${qf});
      const float tileRows = float(${SV});
      const vec3 atlasDimensions = vec3(float(${QS}), float(${QS}), tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }`),e.fragment.code.add(`
    float clouds(vec3 p) {
      float cloudVariations = getCloudShape(0.002 * p, 0.5);

      float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
      cloud += (cloudVariations * 0.6 - 0.3) * ( -4.0 * (coverage * coverage - coverage));
      float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);

      //Round the bottom and top of the clouds
      cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * saturate(remap(heightFraction, 0.75, 1.0, 1.0, 0.0));

      float shape = getCloudShape(cloudSize * p, 0.0);
      shape *= mix(0.0, 1.0, min(2.0 * (1.0 - coverage), 1.0));
      cloud = saturate(remap(cloud, shape, 1.0, 0.0, 1.0));

      if (cloud <= 0.0) {
        return 0.0;
      }

      return density * saturate(remap(cloud, smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
    }`),e.fragment.code.add(`
    vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
      float a = dot(dir, dir);
      float b = 2.0 * dot(dir, start);
      float c = dot(start, start) - (radius * radius);
      float d = (b * b) - 4.0 * a * c;

      if (d < 0.0) {
        return vec2(1e5, -1e5);
      }

      return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
    }

    float HenyeyGreenstein(float g, float costh) {
      return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
    }
    `),e.fragment.code.add(`
    vec3 multipleOctaves(float extinction, float mu, float stepL) {
      float attenuation = 1.0;
      float contribution = 1.0;
      float phaseAttenuation = 1.0;
      vec3 luminance = vec3(0);

      for (int i = 0; i < 4; i++) {
        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
        attenuation *= 0.2;
        contribution *= 0.6;
        phaseAttenuation *= 0.5;
      }

      return luminance;
    }`),e.fragment.code.add(`
    vec3 lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
      float lightRayDensity = clouds(p);
      lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
      lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
      lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
      lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
      lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);

      vec3 beersLaw = multipleOctaves(lightRayDensity, mu, stepL);

      return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
    }`),e.fragment.code.add(`
    vec3 mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {

      // This is never true but having the if statement stops later loop unrolling, texture prefetching and WebGL context crashes
      if (dir.z < 0.0) {
        return vec3(0);
      }

      //Variable to track transmittance along view ray. Assume clear sky and attenuate light when encountering clouds.
      totalTransmittance = 1.0;

      float stepS = totalDistance / float(STEPS);
      float cameraHeight = length(org);

      //Alignment of view and light directions.
      float mu = 0.5 + 0.5 * dot(sunDirection, dir);
      float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);

      vec3 p = org + distToStart  * dir;
      float dist = distToStart;
      vec3 color = vec3(0.0);

      for (int i = 0; i < STEPS; i++) {

        float sampleDensity = clouds(p);
        float sampleSigmaE = sampleDensity * sigmaE;

        if (sampleDensity > 0.0 ) {
          float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));

          vec3 luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
          float transmittance = exp(-sampleSigmaE * stepS);

          //Better energy conserving integration
          //"From Physically based sky, atmosphere and cloud rendering in Frostbite" 5.6
          color += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;

          totalTransmittance *= transmittance;

          //If ray combined transmittance is close to 0, nothing beyond this sample point is visible, so break early.
          if (totalTransmittance <= 0.001) {
            totalTransmittance = 0.0;
            break;
          }

        }

        dist += stepS;
        p = org + dir * dist;
      }

      return color;
    }`),e.fragment.code.add(`
    void main() {
      vec3 rayDir = rayDirection(gl_FragCoord.xy);
      rayDir = normalize(viewMatrix * rayDir);

      vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);

      bool hitsPlanet = rayDir.z < 0.0;

      if (hitsPlanet) {
        gl_FragColor = vec4(vec3(0), 1);
        return;
      }

      vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
      vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
      float distToStart = rayStartIntersect.y;
      float totalDistance = rayEndIntersect.y - distToStart;

      float totalTransmittance = 1.0;
      vec3 sunDirection = normalize(vec3(0, 0, 1));
      vec3 col = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance).rgb;

      gl_FragColor = vec4(col, totalTransmittance);
    }
  `),e}const _ke=Object.freeze({__proto__:null,build:vke});class FE extends Si{initializeProgram(e){const i=FE.shader.get().build({steps:this.configuration.steps});return new fi(e.rctx,i,Ht)}initializePipeline(){return _t({blending:Xs(1,1,0,0),depthTest:{func:515},colorWrite:Pt})}}FE.shader=new vi(_ke,()=>import("./Clouds.glsl.58b2f746.js"));class kne extends tr{constructor(){super(...arguments),this.steps=0}}u([X({count:3})],kne.prototype,"steps",void 0);let _d=class extends ve{constructor(t){super(t),this._frameTask=null,this._techniques=[],this._techniqueConfiguration=new kne,this._cubeMapSize=ae("esri-mobile")?1024:2048,this._viewMat3=Ai(),this._eye=xV(),this._didRenderFaces=!1,this._raymarchingStepType=0,this._cloudRadius=0,this._viewMatrix=be();const e=YS.sunny;this.coverage=Et(e.coverage[1],e.coverage[0],.5),this.density=Et(e.density[1],e.density[0],.5),this.absorption=Et(e.absorption[1],e.absorption[0],.5),this.cloudSize=Et(e.cloudSize[1],e.cloudSize[0],.5),this.detailSize=Et(e.detailSize[1],e.detailSize[0],.5),this.smoothness=Et(e.smoothness[1],e.smoothness[0],.5),this.cloudHeight=Et(e.cloudHeight[1],e.cloudHeight[0],.5),this.raymarchingStepType=e.raymarchingStepType}_getTechnique(t){return this._techniques[t]||(this._techniqueConfiguration.steps=t,this._techniques[t]=new FE({rctx:this.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[t])}initialize(){this._vao=vn(this.rctx);const t=Ut(this.view.spatialReference);this._cloudRadius=.5*t.radius,this.resetRenderFlags(),this._frameTask=this.view.resourceController.scheduler.registerTask(Qe.CLOUDS_GENERATOR,this)}destroy(){this._frameTask=ln(this._frameTask),this._techniques.forEach(t=>nr(t)),this._techniques=null,this._frameBufferCube=Ge(this._frameBufferCube),this._vao=Ge(this._vao),this._noiseTexture=tt(this._noiseTexture)}set coverage(t){this._coverage=t,this.resetRenderFlags()}get coverage(){return this._coverage}set density(t){this._density=this.remap(t,0,1,0,.3),this.resetRenderFlags()}set cloudSize(t){this._cloudSize=this.remap(Math.max(.01,1-t),0,1,0,.02),this.resetRenderFlags()}set detailSize(t){this._detailSize=this.remap(Math.max(.01,1-t),0,1,0,.2),this.resetRenderFlags()}set smoothness(t){this._smoothness=this.remap(1-t,0,1,0,.5),this.resetRenderFlags()}set absorption(t){this._sigmaE=1+t,this._power=this.remap(t,0,1,35,120),this.resetRenderFlags()}get absorption(){return this._sigmaE-1}set cloudHeight(t){this._cloudHeight=this.remap(t,0,1,0,1500),this.resetRenderFlags()}get cloudHeight(){return this._cloudHeight}set raymarchingStepType(t){this._raymarchingStepType=t,this.resetRenderFlags()}_ensureNoiseTexture(){return A(this._noiseTexture)&&(this._noiseTexture=new yke(this.rctx,this.view),this._noiseTexture.render(this.rctx)),this._noiseTexture}get frameBufferCube(){if(A(this._frameBufferCube)){const t={target:34067,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize};this._frameBufferCube=new ci(this.rctx,{colorTarget:2,width:this._cubeMapSize,height:this._cubeMapSize},t)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}resetRenderFlags(){this._didRenderFaces=!1}remap(t,e,i,r,s){return r+(t-e)*(s-r)/(i-e)}get running(){return!this._didRenderFaces}runTask(t){if(this.coverage===0||A(this._vao))return void(this._didRenderFaces=!0);const e=this._ensureNoiseTexture().textureAtlas;if(A(e))return void(this._didRenderFaces=!0);const i=this.rctx.getViewport();this.rctx.setViewport(0,0,this._cubeMapSize,this._cubeMapSize),this.rctx.bindFramebuffer(this.frameBufferCube,!1,34069);const r=this._getTechnique(this._raymarchingStepType),s=r.program;this.rctx.useProgram(s),s.bindTexture(e,"cloudShapeTexture"),s.setUniform1f("cloudRadius",this._cloudRadius),s.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize),s.setUniform1f("power",this._power),s.setUniform1f("sigmaE",this._sigmaE),s.setUniform1f("density",this._density),s.setUniform1f("cloudSize",this._cloudSize),s.setUniform1f("detailSize",this._detailSize),s.setUniform1f("smoothness",this._smoothness),s.setUniform1f("cloudHeight",this._cloudHeight),s.setUniform1f("coverage",this._coverage),this.rctx.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),r.bindPipelineState(this.rctx);for(let n=0;n<5;n++){const o=bke[n],a=wke[n];lJ(this._viewMatrix,this._eye,o,a),Ka(this._viewMat3,this._viewMatrix),s.setUniformMatrix3fv("viewMatrix",this._viewMat3);const l=34069+n;this.frameBufferCube.framebufferTexture2D(this.frameBufferCube.colorAttachment.glName,this.rctx.gl,36064,l),this.rctx.gl.drawArrays(this.rctx.gl.TRIANGLE_STRIP,0,4),this.rctx.gl.flush()}this.rctx.setViewport(i.x,i.y,i.width,i.height),this.requestRender(),this._didRenderFaces=!0,t.madeProgress()}get test(){return{coverage:this._coverage,density:this.remap(this._density,0,.3,0,1),absorption:this._sigmaE-1,cloudSize:1-this.remap(this._cloudSize,0,.02,0,1),detailSize:1-this.remap(this._detailSize,0,.2,0,1),smoothness:1-this.remap(this._smoothness,0,.5,0,1),cloudHeight:this.remap(this._cloudHeight,0,1500,0,1)}}};u([d({constructOnly:!0})],_d.prototype,"rctx",void 0),u([d({constructOnly:!0})],_d.prototype,"view",void 0),u([d({constructOnly:!0})],_d.prototype,"requestRender",void 0),u([d()],_d.prototype,"_frameTask",void 0),u([d()],_d.prototype,"_didRenderFaces",void 0),u([d({readOnly:!0})],_d.prototype,"running",null),_d=u([R("esri.views.3d.environment.CloudsGenerator")],_d);const bke=[xt(1,0,0),xt(-1,0,0),xt(0,1,0),xt(0,-1,0),xt(0,0,1)],wke=[xt(0,1,0),xt(0,1,0),xt(0,0,-1),xt(0,0,1),xt(0,1,0)];class LE{constructor(e,i,r,s,n,o,a,l,c=.5){this.coverage=e,this.density=i,this.absorption=r,this.cloudSize=s,this.detailSize=n,this.smoothness=o,this.cloudHeight=a,this.raymarchingStepType=l,this.median=c}}const YS={sunny:new LE([.1,.7],[.02,.02],[0,0],[.86,.86],[.8,.8],[.5,.5],[.05,.05],0),cloudy:new LE([.24,.7],[.135,.2],[0,0],[.5,.5],[.65,.7],[.3,.3],[1,1],2),rainy:new LE([.5,.9],[.2,.5],[.3,.6],[.4,.4],[.7,.7],[.5,.5],[1,1],2),foggy:new LE([.8,.8],[.5,.5],[0,0],[.85,.85],[.75,.75],[.8,.8],[.3,.3],1)};function xke(t){const e=new pi;return e.attributes.add("position","vec2"),e.include(fd,{attributeTextureCoordinates:1}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3"),e.vertex.uniforms.add("projectionInverse","mat4"),e.vertex.uniforms.add("viewInverse","mat4"),e.vertex.code.add(x`void main(void) {
vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),e.fragment.uniforms.add("lightingMainDirection","vec3").add("atmosphereC","float").add("cameraPosition","vec3").add("nearFar","vec2").add("depthTex","sampler2D").add("strength","float").add("fogAmount","float"),e.include(oV),e.fragment.include(Lr),e.fragment.code.add(x`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),e.fragment.code.add(x`
    vec4 applyFog(float dist, vec3 rayDir){
      bool sky = false;

      if(dist == -1.0){
        vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
        dist = 0.1 * rayAtmosphereIntersect.y;
        sky = true;
      }

      float fogAmount = fogAmount * (1.0 - exp(-dist * strength));

      float sunAmount = max(0.0, dot(rayDir, lightingMainDirection));

      float lightAngle = max(0.0, dot(normalize(cameraPosition + dist * rayDir), lightingMainDirection));
      ${t.haze?x`vec3 fogColor = mix(vec3(0.0), vec3(0.24, 0.44, 0.8), lightAngle);`:x`vec3 fogColor = mix(vec3(0.1), vec3(1.5), lightAngle);`}

      float phase = sky ? pow(sunAmount, 16.0) : 0.0;
      vec3 col = (lightAngle * vec3(1.0, 0.6, 0.3) * phase + fogColor) * fogAmount;
      return vec4(col, fogAmount);
    }
    `),e.fragment.code.add(x`
    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture2D(depthTex, vuv0).r;
      float zNorm = 2.0 * depthSample - 1.0;
      float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
      if(depthSample < 1.0 && depthSample > 0.0){
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;
        cameraSpaceRay *= linDepth;
        terrainDepth = max(0.0, length(cameraSpaceRay));
      }

      ${t.haze?x`
          if(terrainDepth == -1.0){
            gl_FragColor = vec4(0);
            return;
          }`:""}

      vec4 fog = applyFog(terrainDepth, rayDir);

      gl_FragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
    }
  `),e}const Ske=Object.freeze({__proto__:null,build:xke});class XS extends Si{initializeProgram(e){const i=XS.shader.get(),r=this.configuration,s=i.build({haze:r.haze});return new fi(e.rctx,s,Ht)}initializePipeline(){return this.configuration.haze?_t({blending:Xs(1,0,769,1),colorWrite:Pt}):_t({blending:Xs(770,0,771,1),colorWrite:Pt})}}XS.shader=new vi(Ske,()=>import("./Fog.glsl.c8f42279.js"));class TV extends tr{constructor(){super(...arguments),this.haze=!1}}u([X()],TV.prototype,"haze",void 0);class Tke{constructor(e,i){this._projectionInverse=be(),this._viewInverse=be(),this._nearFar=ke(),this._darkenHaze=!1,this._hazeMultiplier=1,this._strength=4e-6;const r=e.renderContext.rctx;this._vao=vn(r,GS),this._shaderTechniqueRepository=e.shaderTechniqueRep;const s=Ut(i.spatialReference);this._planetRadius=s.radius,this._atmosphereRadius=s.radius+TE}set strength(e){this._strength=e}get strength(){return this._strength}get foggyWeatherTechnique(){if(A(this._foggyWeatherTechnique)){const e=new TV;e.haze=!1,this._foggyWeatherTechnique=this._shaderTechniqueRepository.acquire(XS,e)}return this._foggyWeatherTechnique}get distanceFogTechnique(){if(A(this._distanceFogTechnique)){const e=new TV;e.haze=!0,this._distanceFogTechnique=this._shaderTechniqueRepository.acquire(XS,e)}return this._distanceFogTechnique}destroy(){this._distanceFogTechnique=nr(this._distanceFogTechnique),this._foggyWeatherTechnique=nr(this._foggyWeatherTechnique),this._vao=Ge(this._vao)}when(){return Promise.resolve()}render(e,i,r){if(this._darkenHaze=r,this._update(e.camera,i),this._fogAmount<=0)return!1;const s=e.rctx,n=e.offscreenRenderingHelper,o=i?this.foggyWeatherTechnique:this.distanceFogTechnique;return s.useProgram(o.program),o.bindPipelineState(s),n.renderDepthDetached(()=>{o.program.bindTexture(n.depthTexture,"depthTex"),this._renderFog(o.program,e)}),!0}_renderFog(e,i){if(A(this._vao))return!1;const r=i.rctx;return i.scenelightingData.setLightDirectionUniform(e),e.setUniform3fv("cameraPosition",i.camera.eye),e.setUniformMatrix4fv("projectionInverse",this._projectionInverse),e.setUniformMatrix4fv("viewInverse",this._viewInverse),e.setUniform2fv("nearFar",this._nearFar),e.setUniform1f("atmosphereC",this._atmosphereC),e.setUniform1f("strength",this._strength),e.setUniform1f("fogAmount",this._hazeMultiplier*this._fogAmount),r.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(5,0,4),!0}_update(e,i){if(A(e))return;Fi(this._projectionInverse,e.projectionMatrix),Fi(this._viewInverse,e.viewMatrix),si(this._nearFar,e.near,e.far);const r=Te(e.eye),s=r*r;this._atmosphereC=s-this._atmosphereRadius*this._atmosphereRadius,this._fogAmount=i?1-Ag(3e3,6e3,Math.abs(r-this._planetRadius)):1-Ag(7e3,1e4,Math.abs(r-this._planetRadius)),this._hazeMultiplier=this._darkenHaze?Et(.4,1,Ag(9500,10500,r-this._planetRadius)):1}static isSupported(e){return e.capabilities.depthTexture}}async function tl(t,e){const{data:i}=await vt(t,E({responseType:"image"},e));return i}function Ss(t,e){e.linearDepth?t.vertex.code.add(x`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = (-eye.z - nearFar[0]) / (nearFar[1] - nearFar[0]) ;
return proj * eye;
}`):t.vertex.code.add(x`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}function Cke(t){const e=new pi;if(t.geometry===2)e.attributes.add("position","vec2"),e.varyings.add("color","vec4"),e.vertex.uniforms.add("lightingMainDirection","vec3").add("cameraPosition","vec3").add("undergroundFadeAlpha","float"),e.vertex.code.add(x`void main(void) {
float ndotl = dot(normalize(cameraPosition), lightingMainDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),e.fragment.code.add(x`void main() {
gl_FragColor = color;
}`);else{e.include(Ss,{linearDepth:!1}),e.attributes.add("position","vec3"),e.varyings.add("vtc","vec2"),e.varyings.add("falloff","float");const i=t.geometry===1;e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("lightingMainDirection","vec3"),i||(e.varyings.add("innerFactor","float"),e.vertex.uniforms.add("silCircleCenter","vec3").add("silCircleV1","vec3").add("silCircleV2","vec3").add("texV","vec2").add("innerScale","float"));const r=6.2831853,s=1/128;e.vertex.code.add(x`
		void main(void) {
      ${i?x`
      vec3 pos = position;
      float ndotl = lightingMainDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:x`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${x.float(r*s)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightingMainDirection);
      vtc.x = position.x  * ${x.float(s)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),e.fragment.uniforms.add("tex","sampler2D"),i||e.fragment.uniforms.add("altitudeFade","float"),e.fragment.code.add(x`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${i?x`gl_FragColor = atmosphereColor;`:x`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return e}const Mke=Object.freeze({__proto__:null,build:Cke});class K_ extends Si{initializeProgram(e){const i=K_.shader.get(),r=this.configuration,s=i.build({geometry:r.geometry});return new fi(e.rctx,s,Ht)}initializePipeline(){return this.configuration.geometry===1?_t({blending:Xs(770,1,771,771),culling:hV,depthTest:{func:515},colorWrite:Pt}):_t({blending:Xs(770,1,771,771),depthTest:{func:515},colorWrite:Pt})}}K_.shader=new vi(Mke,()=>import("./SimpleAtmosphere.glsl.fa424fce.js"));class kE extends tr{constructor(){super(...arguments),this.geometry=0}}u([X({count:3})],kE.prototype,"geometry",void 0);const zne="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAXVJREFUeNq0k9GWhDAIQ3PjzP9/cuehFqhW19mz++IhkCZAq1prsqT+kSQS9g8Vnqp6VGVWkYVktR6tj3Gr968nLnfwlHzHYyHapkKS73bPd/39eI38AYWj24OGvqdwWjZ3l8IDgacXyl1Dj9tdLOzZiicj+P1YcGk0H2O2vN/VQpTveEHmPHQxZxYlqsQdhUeuCWREuDEvAjqlCqDIMYwIo2ijR1HdYUS58dQrKpgQ0EGeMocsTNXrxzyOhS9kfzlWjn82YuWLqwAnvfNEWJFjYXkJCT0s7AmS0NG4x7Lt6Cpy2MiVPBZmS668QT5AR1cevp7b6CpzQ/ZSNH0vmhy5CsNtdax0MBpXDBiFsrDiMSLKMc8b6hH93bNbEpRsIyHDUhNcfTyeKF16PC7c/2QdczvUnvOB1ylZHVFSMtd5s8C2IW/7w6hwM5GLavLCd1zkiFjB+BwH1DSgctQ7mPOimBLJrw35beSXkd8BM/cCqbXWPgMA+GQQ5sIgkfAAAAAASUVORK5CYII=";function il(t,e=0){const i=t.stride;return t.fieldNames.filter(r=>{const s=t.fields.get(r).optional;return!(s&&s.glPadding)}).map(r=>{const s=t.fields.get(r),n=s.constructor.ElementCount,o=Pke(s.constructor.ElementType),a=s.offset,l=!(!s.optional||!s.optional.glNormalized);return{name:r,stride:i,count:n,type:o,offset:a,normalized:l,divisor:e}})}function Pke(t){const e=Ake[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const Ake={u8:5121,u16:5123,u32:5125,i8:5120,i16:5122,i32:5124,f32:5126};class CV{constructor(e,i,r=0,s,n){this.TypedArrayConstructor=e,this.elementCount=9;const o=this.TypedArrayConstructor;s===void 0&&(s=9*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new e(this.buffer,s,this.stride,s+r*this.stride)}getMat(e,i){let r=e*this.typedBufferStride;for(let s=0;s<9;s++)i[s]=this.typedBuffer[r++];return i}setMat(e,i){let r=e*this.typedBufferStride;for(let s=0;s<9;s++)this.typedBuffer[r++]=i[s]}get(e,i){return this.typedBuffer[e*this.typedBufferStride+i]}set(e,i,r){this.typedBuffer[e*this.typedBufferStride+i]=r}copyFrom(e,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=e*this.typedBufferStride,a=r*i.typedBufferStride;for(let l=0;l<9;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}}CV.ElementCount=9;class MV{constructor(e,i,r=0,s,n){this.TypedArrayConstructor=e,this.elementCount=16;const o=this.TypedArrayConstructor;s===void 0&&(s=16*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new e(this.buffer,s,this.stride,s+r*this.stride)}getMat(e,i){let r=e*this.typedBufferStride;for(let s=0;s<16;s++)i[s]=this.typedBuffer[r++];return i}setMat(e,i){let r=e*this.typedBufferStride;for(let s=0;s<16;s++)this.typedBuffer[r++]=i[s]}get(e,i){return this.typedBuffer[e*this.typedBufferStride+i]}set(e,i,r){this.typedBuffer[e*this.typedBufferStride+i]=r}copyFrom(e,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=e*this.typedBufferStride,a=r*i.typedBufferStride;for(let l=0;l<16;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}}MV.ElementCount=16;class bd{constructor(e,i,r=0,s,n){this.TypedArrayConstructor=e,this.elementCount=1;const o=this.TypedArrayConstructor;s===void 0&&(s=o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new e(this.buffer,s,this.stride,s+r*this.stride)}get(e){return this.typedBuffer[e*this.typedBufferStride]}set(e,i){this.typedBuffer[e*this.typedBufferStride]=i}get buffer(){return this.typedBuffer.buffer}}bd.ElementCount=1;class wd{constructor(e,i,r=0,s,n){this.TypedArrayConstructor=e,this.elementCount=2;const o=this.TypedArrayConstructor;s===void 0&&(s=2*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new e(this.buffer,s,this.stride,s+r*this.stride)}getVec(e,i){return e*=this.typedBufferStride,si(i,this.typedBuffer[e],this.typedBuffer[e+1])}setVec(e,i){e*=this.typedBufferStride,this.typedBuffer[e++]=i[0],this.typedBuffer[e]=i[1]}get(e,i){return this.typedBuffer[e*this.typedBufferStride+i]}set(e,i,r){this.typedBuffer[e*this.typedBufferStride+i]=r}setValues(e,i,r){e*=this.typedBufferStride,this.typedBuffer[e++]=i,this.typedBuffer[e]=r}copyFrom(e,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=e*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}wd.ElementCount=2;class xd{constructor(e,i,r=0,s,n){this.TypedArrayConstructor=e,this.elementCount=3;const o=this.TypedArrayConstructor;s===void 0&&(s=3*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new e(this.buffer,s,this.stride,s+r*this.stride)}getVec(e,i){return e*=this.typedBufferStride,ne(i,this.typedBuffer[e],this.typedBuffer[e+1],this.typedBuffer[e+2])}setVec(e,i){e*=this.typedBufferStride,this.typedBuffer[e++]=i[0],this.typedBuffer[e++]=i[1],this.typedBuffer[e]=i[2]}get(e,i){return this.typedBuffer[e*this.typedBufferStride+i]}set(e,i,r){this.typedBuffer[e*this.typedBufferStride+i]=r}setValues(e,i,r,s){e*=this.typedBufferStride,this.typedBuffer[e++]=i,this.typedBuffer[e++]=r,this.typedBuffer[e]=s}copyFrom(e,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=e*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}xd.ElementCount=3;class Sd{constructor(e,i,r=0,s,n){this.TypedArrayConstructor=e,this.elementCount=4;const o=this.TypedArrayConstructor;s===void 0&&(s=4*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new e(this.buffer,s,this.stride,s+r*this.stride)}getVec(e,i){return e*=this.typedBufferStride,Ls(i,this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e])}setVec(e,i){e*=this.typedBufferStride,this.typedBuffer[e++]=i[0],this.typedBuffer[e++]=i[1],this.typedBuffer[e++]=i[2],this.typedBuffer[e]=i[3]}get(e,i){return this.typedBuffer[e*this.typedBufferStride+i]}set(e,i,r){this.typedBuffer[e*this.typedBufferStride+i]=r}setValues(e,i,r,s,n){e*=this.typedBufferStride,this.typedBuffer[e++]=i,this.typedBuffer[e++]=r,this.typedBuffer[e++]=s,this.typedBuffer[e]=n}copyFrom(e,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=e*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}Sd.ElementCount=4;class KS extends bd{constructor(e,i=0,r,s){super(Float32Array,e,i,r,s),this.elementType="f32"}static fromTypedArray(e,i){return new KS(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}KS.ElementType="f32";class rl extends wd{constructor(e,i=0,r,s){super(Float32Array,e,i,r,s),this.elementType="f32"}slice(e,i){return this.sliceBuffer(rl,e,i)}static fromTypedArray(e,i){return new rl(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}rl.ElementType="f32";class Wt extends xd{constructor(e,i=0,r,s){super(Float32Array,e,i,r,s),this.elementType="f32"}slice(e,i){return this.sliceBuffer(Wt,e,i)}static fromTypedArray(e,i){return new Wt(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}Wt.ElementType="f32";class Zr extends Sd{constructor(e,i=0,r,s){super(Float32Array,e,i,r,s),this.elementType="f32"}slice(e,i){return this.sliceBuffer(Zr,e,i)}static fromTypedArray(e,i){return new Zr(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}Zr.ElementType="f32";class Mc extends CV{constructor(e,i=0,r,s){super(Float32Array,e,i,r,s),this.elementType="f32"}slice(e,i){return this.sliceBuffer(Mc,e,i)}static fromTypedArray(e,i){return new Mc(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}Mc.ElementType="f32";class Hf extends CV{constructor(e,i=0,r,s){super(Float64Array,e,i,r,s),this.elementType="f64"}slice(e,i){return this.sliceBuffer(Hf,e,i)}static fromTypedArray(e,i){return new Hf(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}Hf.ElementType="f64";class eb extends MV{constructor(e,i=0,r,s){super(Float32Array,e,i,r,s),this.elementType="f32"}slice(e,i){return this.sliceBuffer(eb,e,i)}static fromTypedArray(e,i){return new eb(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}eb.ElementType="f32";class Wf extends MV{constructor(e,i=0,r,s){super(Float64Array,e,i,r,s),this.elementType="f64"}slice(e,i){return this.sliceBuffer(Wf,e,i)}static fromTypedArray(e,i){return new Wf(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}Wf.ElementType="f64";class tb extends bd{constructor(e,i=0,r,s){super(Float64Array,e,i,r,s),this.elementType="f64"}slice(e,i){return this.sliceBuffer(tb,e,i)}static fromTypedArray(e,i){return new tb(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}tb.ElementType="f64";class ib extends wd{constructor(e,i=0,r,s){super(Float64Array,e,i,r,s),this.elementType="f64"}slice(e,i){return this.sliceBuffer(ib,e,i)}static fromTypedArray(e,i){return new ib(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}ib.ElementType="f64";class ir extends xd{constructor(e,i=0,r,s){super(Float64Array,e,i,r,s),this.elementType="f64"}slice(e,i){return this.sliceBuffer(ir,e,i)}static fromTypedArray(e,i){return new ir(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}ir.ElementType="f64";class m0 extends Sd{constructor(e,i=0,r,s){super(Float64Array,e,i,r,s),this.elementType="f64"}slice(e,i){return this.sliceBuffer(m0,e,i)}static fromTypedArray(e,i){return new m0(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}m0.ElementType="f64";class Td extends bd{constructor(e,i=0,r,s){super(Uint8Array,e,i,r,s),this.elementType="u8"}slice(e,i){return this.sliceBuffer(Td,e,i)}static fromTypedArray(e,i){return new Td(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}Td.ElementType="u8";class g0 extends wd{constructor(e,i=0,r,s){super(Uint8Array,e,i,r,s),this.elementType="u8"}slice(e,i){return this.sliceBuffer(g0,e,i)}static fromTypedArray(e,i){return new g0(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}g0.ElementType="u8";class Zf extends xd{constructor(e,i=0,r,s){super(Uint8Array,e,i,r,s),this.elementType="u8"}slice(e,i){return this.sliceBuffer(Zf,e,i)}static fromTypedArray(e,i){return new Zf(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}Zf.ElementType="u8";class Hn extends Sd{constructor(e,i=0,r,s){super(Uint8Array,e,i,r,s),this.elementType="u8"}slice(e,i){return this.sliceBuffer(Hn,e,i)}static fromTypedArray(e,i){return new Hn(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}Hn.ElementType="u8";class y0 extends bd{constructor(e,i=0,r,s){super(Uint16Array,e,i,r,s),this.elementType="u16"}slice(e,i){return this.sliceBuffer(y0,e,i)}static fromTypedArray(e,i){return new y0(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}y0.ElementType="u16";class rb extends wd{constructor(e,i=0,r,s){super(Uint16Array,e,i,r,s),this.elementType="u16"}slice(e,i){return this.sliceBuffer(rb,e,i)}static fromTypedArray(e,i){return new rb(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}rb.ElementType="u16";class v0 extends xd{constructor(e,i=0,r,s){super(Uint16Array,e,i,r,s),this.elementType="u16"}slice(e,i){return this.sliceBuffer(v0,e,i)}static fromTypedArray(e,i){return new v0(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}v0.ElementType="u16";class Jf extends Sd{constructor(e,i=0,r,s){super(Uint16Array,e,i,r,s),this.elementType="u16"}slice(e,i){return this.sliceBuffer(Jf,e,i)}static fromTypedArray(e,i){return new Jf(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}Jf.ElementType="u16";class _0 extends bd{constructor(e,i=0,r,s){super(Uint32Array,e,i,r,s),this.elementType="u32"}slice(e,i){return this.sliceBuffer(_0,e,i)}static fromTypedArray(e,i){return new _0(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}_0.ElementType="u32";class sb extends wd{constructor(e,i=0,r,s){super(Uint32Array,e,i,r,s),this.elementType="u32"}slice(e,i){return this.sliceBuffer(sb,e,i)}static fromTypedArray(e,i){return new sb(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}sb.ElementType="u32";class eT extends xd{constructor(e,i=0,r,s){super(Uint32Array,e,i,r,s),this.elementType="u32"}slice(e,i){return this.sliceBuffer(eT,e,i)}static fromTypedArray(e,i){return new eT(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}eT.ElementType="u32";class tT extends Sd{constructor(e,i=0,r,s){super(Uint32Array,e,i,r,s),this.elementType="u32"}slice(e,i){return this.sliceBuffer(tT,e,i)}static fromTypedArray(e,i){return new tT(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}tT.ElementType="u32";class nb extends bd{constructor(e,i=0,r,s){super(Int8Array,e,i,r,s),this.elementType="i8"}slice(e,i){return this.sliceBuffer(nb,e,i)}static fromTypedArray(e,i){return new nb(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}nb.ElementType="i8";class b0 extends wd{constructor(e,i=0,r,s){super(Int8Array,e,i,r,s),this.elementType="i8"}slice(e,i){return this.sliceBuffer(b0,e,i)}static fromTypedArray(e,i){return new b0(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}b0.ElementType="i8";class iT extends xd{constructor(e,i=0,r,s){super(Int8Array,e,i,r,s),this.elementType="i8"}slice(e,i){return this.sliceBuffer(iT,e,i)}static fromTypedArray(e,i){return new iT(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}iT.ElementType="i8";class rT extends Sd{constructor(e,i=0,r,s){super(Int8Array,e,i,r,s),this.elementType="i8"}slice(e,i){return this.sliceBuffer(rT,e,i)}static fromTypedArray(e,i){return new rT(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}rT.ElementType="i8";class sT extends bd{constructor(e,i=0,r,s){super(Int16Array,e,i,r,s),this.elementType="i16"}slice(e,i){return this.sliceBuffer(sT,e,i)}static fromTypedArray(e,i){return new sT(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}sT.ElementType="i16";class w0 extends wd{constructor(e,i=0,r,s){super(Int16Array,e,i,r,s),this.elementType="i16"}slice(e,i){return this.sliceBuffer(w0,e,i)}static fromTypedArray(e,i){return new w0(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}w0.ElementType="i16";class nT extends xd{constructor(e,i=0,r,s){super(Int16Array,e,i,r,s),this.elementType="i16"}slice(e,i){return this.sliceBuffer(nT,e,i)}static fromTypedArray(e,i){return new nT(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}nT.ElementType="i16";class oT extends Sd{constructor(e,i=0,r,s){super(Int16Array,e,i,r,s),this.elementType="i16"}slice(e,i){return this.sliceBuffer(oT,e,i)}static fromTypedArray(e,i){return new oT(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}oT.ElementType="i16";class aT extends bd{constructor(e,i=0,r,s){super(Int32Array,e,i,r,s),this.elementType="i32"}slice(e,i){return this.sliceBuffer(aT,e,i)}static fromTypedArray(e,i){return new aT(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}aT.ElementType="i32";class lT extends wd{constructor(e,i=0,r,s){super(Int32Array,e,i,r,s),this.elementType="i32"}slice(e,i){return this.sliceBuffer(lT,e,i)}static fromTypedArray(e,i){return new lT(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}lT.ElementType="i32";class cT extends xd{constructor(e,i=0,r,s){super(Int32Array,e,i,r,s),this.elementType="i32"}slice(e,i){return this.sliceBuffer(cT,e,i)}static fromTypedArray(e,i){return new cT(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}cT.ElementType="i32";class uT extends Sd{constructor(e,i=0,r,s){super(Int32Array,e,i,r,s),this.elementType="i32"}slice(e,i){return this.sliceBuffer(uT,e,i)}static fromTypedArray(e,i){return new uT(e.buffer,e.byteOffset,i,e.byteOffset+e.byteLength)}}uT.ElementType="i32";function Vne(t){switch(t){case"u8":case"i8":return 1;case"u16":case"i16":return 2;case"u32":case"i32":case"f32":return 4;case"f64":return 8;default:return}}function $ke(t){switch(t){case"u8":case"u16":case"u32":return!1;case"i8":case"i16":case"i32":case"f32":case"f64":return!0;default:return}}function Eke(t){switch(t){case"u8":case"u16":case"u32":case"i8":case"i16":case"i32":return!0;case"f32":case"f64":return!1;default:return}}function Oke(t){switch(t){case"u8":return 255;case"u16":return 65535;case"u32":return 4294967295;case"i8":return 127;case"i16":return 32767;case"i32":return 2147483647;case"f32":return 3402823e32;case"f64":return 179769e303;default:return}}class zE{constructor(e,i){this.layout=e,this.buffer=typeof i=="number"?new ArrayBuffer(i*e.stride):i;for(const r of e.fieldNames){const s=e.fields.get(r);this[r]=new s.constructor(this.buffer,s.offset,this.stride)}}get stride(){return this.layout.stride}get count(){return this.buffer.byteLength/this.stride}get byteLength(){return this.buffer.byteLength}getField(e,i){const r=this[e];return r&&r.elementCount===i.ElementCount&&r.elementType===i.ElementType?r:null}slice(e,i){return new zE(this.layout,this.buffer.slice(e*this.stride,i*this.stride))}copyFrom(e,i,r,s){const n=this.stride;if(n%4==0){const o=new Uint32Array(e.buffer,i*n,s*n/4);new Uint32Array(this.buffer,r*n,s*n/4).set(o)}else{const o=new Uint8Array(e.buffer,i*n,s*n);new Uint8Array(this.buffer,r*n,s*n).set(o)}}}class PV{constructor(){this.stride=0,this.fields=new Map,this.fieldNames=[]}vec2f(e,i){return this.appendField(e,rl,i),this}vec2f64(e,i){return this.appendField(e,ib,i),this}vec3f(e,i){return this.appendField(e,Wt,i),this}vec3f64(e,i){return this.appendField(e,ir,i),this}vec4f(e,i){return this.appendField(e,Zr,i),this}vec4f64(e,i){return this.appendField(e,m0,i),this}mat3f(e,i){return this.appendField(e,Mc,i),this}mat3f64(e,i){return this.appendField(e,Hf,i),this}mat4f(e,i){return this.appendField(e,eb,i),this}mat4f64(e,i){return this.appendField(e,Wf,i),this}vec4u8(e,i){return this.appendField(e,Hn,i),this}f32(e,i){return this.appendField(e,KS,i),this}f64(e,i){return this.appendField(e,tb,i),this}u8(e,i){return this.appendField(e,Td,i),this}u16(e,i){return this.appendField(e,y0,i),this}i8(e,i){return this.appendField(e,nb,i),this}vec2i8(e,i){return this.appendField(e,b0,i),this}vec2i16(e,i){return this.appendField(e,w0,i),this}vec2u8(e,i){return this.appendField(e,g0,i),this}vec4u16(e,i){return this.appendField(e,Jf,i),this}u32(e,i){return this.appendField(e,_0,i),this}appendField(e,i,r){const s=i.ElementCount*Vne(i.ElementType),n=this.stride;this.fields.set(e,{size:s,constructor:i,offset:n,optional:r}),this.stride+=s,this.fieldNames.push(e)}alignTo(e){return this.stride=Math.floor((this.stride+e-1)/e)*e,this}hasField(e){return this.fieldNames.indexOf(e)>=0}createBuffer(e){return new zE(this,e)}createView(e){return new zE(this,e)}clone(){const e=new PV;return e.stride=this.stride,e.fields=new Map,this.fields.forEach((i,r)=>e.fields.set(r,i)),e.fieldNames=this.fieldNames.slice(),e.BufferType=this.BufferType,e}}function zr(){return new PV}function Qf(t,e,i){t.setUniform3f("camPos",i[3]-e[0],i[7]-e[1],i[11]-e[2])}function Pc(t,e){t.setUniformMatrix4fv("proj",e)}function Rke(t,e){t.setUniform2fv("nearFar",e)}function Nne(t,e,i){Vs(jne,i,e),t.setUniform3fv("localOrigin",e),t.setUniformMatrix4fv("view",jne)}function Yf(t,e){Nne(t,e.origin,e.camera.viewMatrix)}function Une(t,e){t.setUniform4fv("viewport",e.camera.fullViewport)}const jne=uS();var AV;(function(t){function e(o,a){const l=o[a],c=o[a+1],h=o[a+2];return Math.sqrt(l*l+c*c+h*h)}function i(o,a){const l=o[a],c=o[a+1],h=o[a+2],p=1/Math.sqrt(l*l+c*c+h*h);o[a]*=p,o[a+1]*=p,o[a+2]*=p}function r(o,a,l){o[a]*=l,o[a+1]*=l,o[a+2]*=l}function s(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]+l[c],h[p+1]=o[a+1]+l[c+1],h[p+2]=o[a+2]+l[c+2]}function n(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]-l[c],h[p+1]=o[a+1]-l[c+1],h[p+2]=o[a+2]-l[c+2]}t.length=e,t.normalize=i,t.scale=r,t.add=s,t.subtract=n})(AV||(AV={}));const bn=Ot();class Ike{constructor(e){this.message=e}toString(){return`AssertException: ${this.message}`}}function Ze(t,e){if(!t){e=e||"assert";const i=new Error(e);throw i.stack&&console.log(i.stack),new Ike(e)}}function ob(t,e){t||(e=e||"",console.warn("Verify failed: "+e+`
`+new Error("verify").stack))}function Bne(t,e,i,r){let s,n=(i[0]-t[0])/e[0],o=(r[0]-t[0])/e[0];n>o&&(s=n,n=o,o=s);let a=(i[1]-t[1])/e[1],l=(r[1]-t[1])/e[1];if(a>l&&(s=a,a=l,l=s),n>l||a>o)return!1;a>n&&(n=a),l<o&&(o=l);let c=(i[2]-t[2])/e[2],h=(r[2]-t[2])/e[2];return c>h&&(s=c,c=h,h=s),!(n>h||c>o)&&(h<o&&(o=h),!(o<0))}function VE(t,e,i,r,s,n=ke()){const o=(r[s]-i[s])*(e[0]-t[0])-(r[0]-i[0])*(e[s]-t[s]),a=(r[0]-i[0])*(t[s]-i[s])-(r[s]-i[s])*(t[0]-i[0]);if(o===0)return!1;const l=a/o;return n[0]=t[0]+l*(e[0]-t[0]),n[1]=t[s]+l*(e[s]-t[s]),!0}function Gne(t,e,i,r,s){s||(s=t),bn[0]=t[0],bn[1]=t[1],bn[2]=t[2],bn[3]=1,Va(bn,bn,e),s.length>2&&(s[2]=-bn[2]),Va(bn,bn,i),Ze(bn[3]!==0),s[0]=bn[0]/bn[3],s[1]=bn[1]/bn[3],s[2]=bn[2]/bn[3],s[0]=(.5*s[0]+.5)*r[2]+r[0],s[1]=(.5*s[1]+.5)*r[3]+r[1]}function Dke(t,e){return Math.log(t)/Math.log(e)}function qne(t,e,i,r){t[12]=e,t[13]=i,t[14]=r}function Hne(t){return t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[7]===0&&t[8]===0&&t[9]===0&&t[10]===1&&t[11]===0&&t[15]===1}function Fke(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/e)}function Lke(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/i)}function kke(t,e,i){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}function zke(t,e,i){return 2*Math.atan(i*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}function $V(t,e,i,r,s){const n=t;t[11]===0?(r[0]=2/(e*n[0]),r[1]=2/(i*n[5]),r[2]=(1+n[12])/n[0],r[3]=(1+n[13])/n[5],si(s,0,1)):(r[0]=-2/(e*n[0]),r[1]=-2/(i*n[5]),r[2]=(1-n[8])/n[0],r[3]=(1-n[9])/n[5],si(s,1,0))}class NE{constructor(e,i,r,s){this.primitiveIndices=e,this._numIndexPerPrimitive=i,this.indices=r,this.position=s,this.center=$(),Ze(e.length>=1),Ze(r.length%this._numIndexPerPrimitive==0),Ze(r.length>=e.length*this._numIndexPerPrimitive),Ze(s.size===3||s.size===4);const{data:n,size:o}=s,a=e.length;let l=o*r[this._numIndexPerPrimitive*e[0]];x0.clear(),x0.push(l),this.bbMin=De(n[l],n[l+1],n[l+2]),this.bbMax=br(this.bbMin);for(let h=0;h<a;++h){const p=this._numIndexPerPrimitive*e[h];for(let f=0;f<this._numIndexPerPrimitive;++f){l=o*r[p+f],x0.push(l);let g=n[l];this.bbMin[0]=Math.min(g,this.bbMin[0]),this.bbMax[0]=Math.max(g,this.bbMax[0]),g=n[l+1],this.bbMin[1]=Math.min(g,this.bbMin[1]),this.bbMax[1]=Math.max(g,this.bbMax[1]),g=n[l+2],this.bbMin[2]=Math.min(g,this.bbMin[2]),this.bbMax[2]=Math.max(g,this.bbMax[2])}}jr(this.center,this.bbMin,this.bbMax,.5),this.radius=.5*Math.max(Math.max(this.bbMax[0]-this.bbMin[0],this.bbMax[1]-this.bbMin[1]),this.bbMax[2]-this.bbMin[2]);let c=this.radius*this.radius;for(let h=0;h<x0.length;++h){l=x0.getItemAt(h);const p=n[l]-this.center[0],f=n[l+1]-this.center[1],g=n[l+2]-this.center[2],y=p*p+f*f+g*g;if(y<=c)continue;const v=Math.sqrt(y),b=.5*(v-this.radius);this.radius=this.radius+b,c=this.radius*this.radius;const w=b/v;this.center[0]+=p*w,this.center[1]+=f*w,this.center[2]+=g*w}x0.clear()}getCenter(){return this.center}getBSRadius(){return this.radius}getBBMin(){return this.bbMin}getBBMax(){return this.bbMax}getChildren(){if(this._children)return this._children;if(cn(this.bbMin,this.bbMax)>1){const e=jr($(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,r=new Uint8Array(i),s=new Array(8);for(let c=0;c<8;++c)s[c]=0;const{data:n,size:o}=this.position;for(let c=0;c<i;++c){let h=0;const p=this._numIndexPerPrimitive*this.primitiveIndices[c];let f=o*this.indices[p],g=n[f],y=n[f+1],v=n[f+2];for(let b=1;b<this._numIndexPerPrimitive;++b){f=o*this.indices[p+b];const w=n[f],S=n[f+1],T=n[f+2];w<g&&(g=w),S<y&&(y=S),T<v&&(v=T)}g<e[0]&&(h|=1),y<e[1]&&(h|=2),v<e[2]&&(h|=4),r[c]=h,++s[h]}let a=0;for(let c=0;c<8;++c)s[c]>0&&++a;if(a<2)return;const l=new Array(8);for(let c=0;c<8;++c)l[c]=s[c]>0?new Uint32Array(s[c]):void 0;for(let c=0;c<8;++c)s[c]=0;for(let c=0;c<i;++c){const h=r[c];l[h][s[h]++]=this.primitiveIndices[c]}this._children=new Array(8);for(let c=0;c<8;++c)l[c]!==void 0&&(this._children[c]=new NE(l[c],this._numIndexPerPrimitive,this.indices,this.position))}return this._children}static prune(){x0.prune()}}const x0=new ct({deallocator:null});class ab{constructor(){this.id=On()}unload(){}}function Wne(t,e,i){const r=H_(t,e),s=H_(e,i),n=H_(i,t),o=(r+s+n)/2,a=o*(o-r)*(o-s)*(o-n);return a<=0?0:Math.sqrt(a)}function Vke(t,e,i){return ue(EV,e,t),ue(Zne,i,t),Te(Ye(EV,EV,Zne))/2}new Yh(ff);new Yh(()=>({p0:null,p1:null,p2:null}));const EV=$(),Zne=$();let Xf=(()=>{const t=new Uint32Array(131072);for(let e=0;e<t.length;++e)t[e]=e;return t})();const Jne=new Uint16Array([0]),UE=(()=>{const t=new Uint16Array(65536);for(let e=0;e<t.length;++e)t[e]=e;return t})();function lb(t){if(t===1)return Jne;if(t<UE.length)return new Uint16Array(UE.buffer,0,t);if(t>Xf.length){const e=Math.max(2*Xf.length,t);Xf=new Uint32Array(e);for(let i=0;i<Xf.length;i++)Xf[i]=i}return new Uint32Array(Xf.buffer,0,t)}function dat(t){if(t===1)return new Uint16Array(Jne);if(t<UE.length)return new Uint16Array(UE.slice(0,t));if(t>Xf.length){const e=new Uint32Array(t);for(let i=0;i<e.length;i++)e[i]=i;return e}return new Uint32Array(Xf.slice(0,t))}function Qne(t,e,i){if(!t)return!1;const{size:r,data:s}=t;ne(i,0,0,0),ne(sl,0,0,0);let n=0,o=0;for(let a=0;a<e.length-2;a+=3){const l=e[a+0]*r,c=e[a+1]*r,h=e[a+2]*r;ne(Jr,s[l+0],s[l+1],s[l+2]),ne(Cd,s[c+0],s[c+1],s[c+2]),ne(jE,s[h+0],s[h+1],s[h+2]);const p=Vke(Jr,Cd,jE);p?(de(Jr,Jr,Cd),de(Jr,Jr,jE),se(Jr,Jr,1/3*p),de(i,i,Jr),n+=p):(de(sl,sl,Jr),de(sl,sl,Cd),de(sl,sl,jE),o+=3)}return(o!==0||n!==0)&&(n!==0?(se(i,i,1/n),!0):o!==0&&(se(i,sl,1/o),!0))}function Yne(t,e,i){if(!t||!e)return!1;const{size:r,data:s}=t;ne(i,0,0,0);let n=-1,o=0;for(let a=0;a<e.length;a++){const l=e[a]*r;n!==l&&(i[0]+=s[l+0],i[1]+=s[l+1],i[2]+=s[l+2],o++),n=l}return o>1&&se(i,i,1/o),o>0}function OV(t,e,i,r){if(!t)return!1;const{size:s,data:n}=t;ne(r,0,0,0),ne(sl,0,0,0);let o=0,a=0;const l=e?e.length-1:n.length/s-1,c=l+(i?2:0);for(let h=0;h<c;h+=2){const p=h<l?h:l,f=h<l?h+1:0,g=(e?e[p]:p)*s,y=(e?e[f]:f)*s;Jr[0]=n[g+0],Jr[1]=n[g+1],Jr[2]=n[g+2],Cd[0]=n[y+0],Cd[1]=n[y+1],Cd[2]=n[y+2],se(Jr,de(Jr,Jr,Cd),.5);const v=CF(Jr,Cd);v>0?(de(r,r,se(Jr,Jr,v)),o+=v):(de(sl,sl,Jr),a++)}return o!==0?(se(r,r,1/o),!0):a!==0&&(se(r,sl,1/a),!0)}const Jr=$(),Cd=$(),jE=$(),sl=$();class zi extends ab{constructor(e,i=[],r=0,s=-1){super(),this._primitiveType=r,this.edgeIndicesLength=s,this.type=2,this._vertexAttributes=new Map,this._indices=new Map,this._boundingInfo=null;for(const[n,o]of e)o&&this._vertexAttributes.set(n,E({},o));if(i==null||i.length===0){const n=Nke(this._vertexAttributes),o=lb(n);this.edgeIndicesLength=this.edgeIndicesLength<0?n:this.edgeIndicesLength;for(const a of this._vertexAttributes.keys())this._indices.set(a,o)}else for(const[n,o]of i)o&&(this._indices.set(n,Uke(o)),n==="position"&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._indices.get(n).length:this.edgeIndicesLength))}get vertexAttributes(){return this._vertexAttributes}getMutableAttribute(e){const i=this._vertexAttributes.get(e);return i&&!i.exclusive&&(i.data=Array.from(i.data),i.exclusive=!0),i}get indices(){return this._indices}get indexCount(){const e=this._indices.values().next().value;return e?e.length:0}get primitiveType(){return this._primitiveType}get faceCount(){return this.indexCount/3}get boundingInfo(){return A(this._boundingInfo)&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(e){return this.primitiveType===0?this.computeAttachmentOriginTriangles(e):this.computeAttachmentOriginPoints(e)}computeAttachmentOriginTriangles(e){const i=this.indices.get("position"),r=this.vertexAttributes.get("position");return Qne(r,i,e)}computeAttachmentOriginPoints(e){const i=this.indices.get("position"),r=this.vertexAttributes.get("position");return Yne(r,i,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.indices.get("position");if(e.length===0)return null;const i=this.primitiveType===0?3:1;Ze(e.length%i==0,"Indexing error: "+e.length+" not divisible by "+i);const r=lb(e.length/i),s=this.vertexAttributes.get("position");return new NE(r,i,e,s)}}function Nke(t){const e=t.values().next().value;return e==null?0:e.data.length/e.size}function Uke(t){if(t.BYTES_PER_ELEMENT===Uint16Array.BYTES_PER_ELEMENT)return t;for(const e of t)if(e>=65536)return t;return new Uint16Array(t)}const cb=AV;var RV,IV,DV,FV;(function(t){const e=.5,i=[[-e,-e,e],[e,-e,e],[e,e,e],[-e,e,e],[-e,-e,-e],[e,-e,-e],[e,e,-e],[-e,e,-e]],r=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],s=[0,0,1,0,1,1,0,1],n=new Uint16Array([0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5]),o=new Uint16Array(36);for(let c=0;c<6;c++)for(let h=0;h<6;h++)o[6*c+h]=c;const a=new Uint16Array(36);for(let c=0;c<6;c++)a[6*c+0]=0,a[6*c+1]=1,a[6*c+2]=2,a[6*c+3]=2,a[6*c+4]=3,a[6*c+5]=0;function l(c){Array.isArray(c)||(c=[c,c,c]);const h=new Array(24);for(let p=0;p<8;p++)h[3*p]=i[p][0]*c[0],h[3*p+1]=i[p][1]*c[1],h[3*p+2]=i[p][2]*c[2];return new zi([["position",{size:3,data:h,exclusive:!0}],["normal",{size:3,data:r}],["uv0",{size:2,data:s}]],[["position",n],["normal",o],["uv0",a]])}t.createGeometry=l})(RV||(RV={})),function(t){const e=.5,i=[[-e,0,-e],[e,0,-e],[e,0,e],[-e,0,e],[0,-e,0],[0,e,0]],r=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],s=new Uint16Array([5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0]),n=new Uint16Array([0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7]);function o(a){Array.isArray(a)||(a=[a,a,a]);const l=new Array(18);for(let c=0;c<6;c++)l[3*c]=i[c][0]*a[0],l[3*c+1]=i[c][1]*a[1],l[3*c+2]=i[c][2]*a[2];return new zi([["position",{size:3,data:l,exclusive:!0}],["normal",{size:3,data:r}]],[["position",s],["normal",n]])}t.createGeometry=o}(IV||(IV={})),function(t){const e=.5,i=0,r=xt(-e,i,-e),s=xt(e,i,-e),n=xt(0,i,e),o=xt(0,i+e,0),a=li(),l=li(),c=li(),h=li(),p=li();ue(a,r,o),ue(l,r,s),Ye(c,a,l),_e(c,c),ue(a,s,o),ue(l,s,n),Ye(h,a,l),_e(h,h),ue(a,n,o),ue(l,n,r),Ye(p,a,l),_e(p,p);const f=[r,s,n,o],g=[0,-1,0,c[0],c[1],c[2],h[0],h[1],h[2],p[0],p[1],p[2]],y=[0,1,2,3,1,0,3,2,1,3,0,2],v=[0,0,0,1,1,1,2,2,2,3,3,3];function b(w){Array.isArray(w)||(w=[w,w,w]);const S=new Array(12);for(let T=0;T<4;T++)S[3*T]=f[T][0]*w[0],S[3*T+1]=f[T][1]*w[1],S[3*T+2]=f[T][2]*w[2];return new zi([["position",{size:3,data:S,exclusive:!0}],["normal",{size:3,data:g}]],[["position",new Uint16Array(y)],["normal",new Uint16Array(v)]])}t.createGeometry=b}(DV||(DV={})),function(t){function e(T,C,M,P={uv:!0}){const F=-Math.PI,z=2*Math.PI,D=-Math.PI/2,U=Math.PI,G=Math.max(3,Math.floor(C)),k=Math.max(2,Math.floor(M)),j=(G+1)*(k+1),V=new Float32Array(3*j),q=new Float32Array(3*j),J=new Float32Array(2*j),O=[];let L=0;for(let Y=0;Y<=k;Y++){const H=[],K=Y/k,fe=D+K*U,ce=Math.cos(fe);for(let me=0;me<=G;me++){const Ie=me/G,He=F+Ie*z,$e=Math.cos(He)*ce,Le=Math.sin(fe),Ei=-Math.sin(He)*ce;V[3*L]=$e*T,V[3*L+1]=Le*T,V[3*L+2]=Ei*T,q[3*L]=$e,q[3*L+1]=Le,q[3*L+2]=Ei,J[2*L]=Ie,J[2*L+1]=K,H.push(L),++L}O.push(H)}const N=new Uint32Array(2*G*(k-1)*3);L=0;for(let Y=0;Y<k;Y++)for(let H=0;H<G;H++){const K=O[Y][H],fe=O[Y][H+1],ce=O[Y+1][H+1],me=O[Y+1][H];Y===0?(N[L++]=K,N[L++]=ce,N[L++]=me):Y===k-1?(N[L++]=K,N[L++]=fe,N[L++]=ce):(N[L++]=K,N[L++]=fe,N[L++]=ce,N[L++]=ce,N[L++]=me,N[L++]=K)}const B=[["position",N],["normal",N]],W=[["position",{size:3,data:V,exclusive:!0}],["normal",{size:3,data:q,exclusive:!0}]];return P.uv&&(W.push(["uv0",{size:2,data:J,exclusive:!0}]),B.push(["uv0",N])),P.offset&&(B[0][0]="offset",W[0][0]="offset",B.push(["position",new Uint32Array(N.length)]),W.push(["position",{size:3,data:Float64Array.from(P.offset),exclusive:!0}])),new zi(W,B)}function i(T,C,M){const P=T;let F,z;if(M)F=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],z=new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1]);else{const V=P*(1+Math.sqrt(5))/2;F=[-P,V,0,P,V,0,-P,-V,0,P,-V,0,0,-P,V,0,P,V,0,-P,-V,0,P,-V,V,0,-P,V,0,P,-V,0,-P,-V,0,P],z=new Uint32Array([0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1])}for(let V=0;V<F.length;V+=3)cb.scale(F,V,T/cb.length(F,V));let D={};function U(V,q){V>q&&([V,q]=[q,V]);const J=V.toString()+"."+q.toString();if(D[J])return D[J];let O=F.length;return F.length+=3,cb.add(F,3*V,F,3*q,F,O),cb.scale(F,O,T/cb.length(F,O)),O/=3,D[J]=O,O}for(let V=0;V<C;V++){const q=z.length,J=new Uint32Array(4*q);for(let O=0;O<q;O+=3){const L=z[O],N=z[O+1],B=z[O+2],W=U(L,N),Y=U(N,B),H=U(B,L),K=4*O;J[K]=L,J[K+1]=W,J[K+2]=H,J[K+3]=N,J[K+4]=Y,J[K+5]=W,J[K+6]=B,J[K+7]=H,J[K+8]=Y,J[K+9]=W,J[K+10]=Y,J[K+11]=H}z=J,D={}}const G=new Float32Array(F);for(let V=0;V<G.length;V+=3)cb.normalize(G,V);const k=[["position",z],["normal",z]],j=[["position",{size:3,data:new Float32Array(F),exclusive:!0}],["normal",{size:3,data:G,exclusive:!0}]];return new zi(j,k)}function r(T,C,M,P,F,z,D){const U=C?[C[0],C[1],C[2]]:[0,0,0],G=T?[T[0],T[1],T[2]]:[0,0,1];z=z||[0,0];const k=M?[255*M[0],255*M[1],255*M[2],M.length>3?255*M[3]:255]:[255,255,255,255],j=P!=null&&P.length===2?P:[1,1],V=[["position",{size:3,data:U,exclusive:!0}],["normal",{size:3,data:G,exclusive:!0}],["uv0",{size:z.length,data:z}],["color",{size:4,data:k,exclusive:!0}],["size",{size:2,data:j}]];if(F!=null){const q=new Float32Array([F[0],F[1],F[2],F[3]]);V.push(["auxpos1",{size:4,data:q}])}if(D!=null){const q=new Float32Array([D[0],D[1],D[2],D[3]]);V.push(["auxpos2",{size:4,data:q}])}return new zi(V,null,1)}function s(T,C,M,P,F,z,D,U){if(T!=null){const{data:G}=U.getMutableAttribute("normal");G[0]=T[0],G[1]=T[1],G[2]=T[2]}if(C!=null){const{data:G}=U.getMutableAttribute("position");G[0]=C[0],G[1]=C[1],G[2]=C[2]}if(M!=null){const{data:G}=U.getMutableAttribute("color");G[0]=M[0],G[1]=M[1],G[2]=M[2],G[3]=M[3]}if(P!=null){const{data:G}=U.getMutableAttribute("size");G[0]=P[0],G[1]=P[1]}if(F!=null){const{data:G}=U.getMutableAttribute("auxpos1");G[0]=F[0],G[1]=F[1],G[2]=F[2],G[3]=F[3]}if(z!=null){const{data:G}=U.getMutableAttribute("uv0");G[0]=z[0],G[1]=z[1]}if(D!=null){const{data:G}=U.getMutableAttribute("auxpos2");G[0]=D[0],G[1]=D[1],G[2]=D[2],G[3]=D[3]}}function n(T,C){const M=new Float32Array(3*T.length),P=new Float32Array(C?3*T.length:3),F=new Uint32Array(T.length),z=new Uint32Array(T.length);for(let D=0;D<T.length;D++)M[3*D]=T[D][0],M[3*D+1]=T[D][1],M[3*D+2]=T[D][2],C&&(P[3*D]=C[D][0],P[3*D+1]=C[D][1],P[3*D+2]=C[D][2]),F[D]=D,z[D]=0;return C||(P[0]=0,P[1]=1,P[2]=0),new zi([["position",{size:3,data:M,exclusive:!0}],["normal",{size:3,data:P,exclusive:!0}],["uv0",{size:2,data:[0,0],exclusive:!0}]],[["position",F],["normal",C?F:z],["uv0",z]],1)}function o(){const T=[0,0,0,0,0,100,100,0,0],C=new Uint16Array([0,1,2]),M=[0,1,0],P=new Uint16Array([0,0,0]),F=[0,0],z=new Uint16Array([0,0,0]);return new zi([["position",{size:3,data:T,exclusive:!0}],["normal",{size:3,data:M,exclusive:!0}],["uv0",{size:2,data:F,exclusive:!0}]],[["position",C],["normal",P],["uv0",z]])}t.createBoxGeometry=RV.createGeometry,t.createDiamondGeometry=IV.createGeometry,t.createTetrahedronGeometry=DV.createGeometry,t.createSphereGeometry=e,t.createPolySphereGeometry=i,t.createPointGeometry=r,t.updatePointGeometry=s,t.createPointArrayGeometry=n,t.createTriangleGeometry=o;const a=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function l(T=a){const C=new Array(12);for(let z=0;z<4;z++)for(let D=0;D<3;D++)C[3*z+D]=T[z][D];const M=new Uint32Array([0,1,2,2,3,0]),P=[0,0,1],F=new Uint32Array([0,0,0,0,0,0]);return new zi([["position",{size:3,data:C,exclusive:!0}],["normal",{size:3,data:P,exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1],exclusive:!0}],["color",{size:4,data:[255,255,255,255],exclusive:!0}]],[["position",M],["normal",F],["uv0",M],["color",F]])}function c(T,C,M,P,F=!0,z=!0){let D=0;const U=C,G=T;let k=xt(0,D,0),j=xt(0,D+G,0),V=xt(0,-1,0),q=xt(0,1,0);P&&(D=G,j=xt(0,0,0),k=xt(0,D,0),V=xt(0,1,0),q=xt(0,-1,0));const J=[j,k],O=[V,q],L=M+2,N=Math.sqrt(G*G+U*U);if(P)for(let ce=M-1;ce>=0;ce--){const me=ce*(2*Math.PI/M),Ie=xt(Math.cos(me)*U,D,Math.sin(me)*U);J.push(Ie);const He=xt(G*Math.cos(me)/N,-U/N,G*Math.sin(me)/N);O.push(He)}else for(let ce=0;ce<M;ce++){const me=ce*(2*Math.PI/M),Ie=xt(Math.cos(me)*U,D,Math.sin(me)*U);J.push(Ie);const He=xt(G*Math.cos(me)/N,U/N,G*Math.sin(me)/N);O.push(He)}const B=new Uint32Array(2*(M+2)*3),W=new Uint32Array(2*(M+2)*3);let Y=0,H=0;if(F){for(let ce=3;ce<J.length;ce++)B[Y++]=1,B[Y++]=ce-1,B[Y++]=ce,W[H++]=0,W[H++]=0,W[H++]=0;B[Y++]=J.length-1,B[Y++]=2,B[Y++]=1,W[H++]=0,W[H++]=0,W[H++]=0}if(z){for(let ce=3;ce<J.length;ce++)B[Y++]=ce,B[Y++]=ce-1,B[Y++]=0,W[H++]=ce,W[H++]=ce-1,W[H++]=1;B[Y++]=0,B[Y++]=2,B[Y++]=J.length-1,W[H++]=1,W[H++]=2,W[H++]=O.length-1}const K=new Float32Array(3*L);for(let ce=0;ce<L;ce++)K[3*ce]=J[ce][0],K[3*ce+1]=J[ce][1],K[3*ce+2]=J[ce][2];const fe=new Float32Array(3*L);for(let ce=0;ce<L;ce++)fe[3*ce]=O[ce][0],fe[3*ce+1]=O[ce][1],fe[3*ce+2]=O[ce][2];return new zi([["position",{size:3,data:K,exclusive:!0}],["normal",{size:3,data:fe,exclusive:!0}]],[["position",B],["normal",W]])}function h(T,C,M,P,F,z){const D=P?IE(P):xt(1,0,0),U=F?IE(F):xt(0,0,0);z=z==null||z;const G=li();_e(G,D);const k=li();se(k,G,Math.abs(T));const j=li();se(j,k,-.5),de(j,j,U);const V=xt(0,1,0);Math.abs(1-ye(G,V))<.2&&ne(V,0,0,1);const q=li();Ye(q,G,V),_e(q,q),Ye(V,q,G);const J=2*M+(z?2:0),O=M+(z?2:0),L=new Float32Array(3*J),N=new Float32Array(3*O),B=new Float32Array(2*J),W=new Uint32Array(3*M*(z?4:2)),Y=new Uint32Array(3*M*(z?4:2));z&&(L[3*(J-2)+0]=j[0],L[3*(J-2)+1]=j[1],L[3*(J-2)+2]=j[2],B[2*(J-2)]=0,B[2*(J-2)+1]=0,L[3*(J-1)+0]=L[3*(J-2)+0]+k[0],L[3*(J-1)+1]=L[3*(J-2)+1]+k[1],L[3*(J-1)+2]=L[3*(J-2)+2]+k[2],B[2*(J-1)]=1,B[2*(J-1)+1]=1,N[3*(O-2)+0]=-G[0],N[3*(O-2)+1]=-G[1],N[3*(O-2)+2]=-G[2],N[3*(O-1)+0]=G[0],N[3*(O-1)+1]=G[1],N[3*(O-1)+2]=G[2]);const H=function(me,Ie,He){W[me]=Ie,Y[me]=He};let K=0;const fe=li(),ce=li();for(let me=0;me<M;me++){const Ie=me*(2*Math.PI/M);se(fe,V,Math.sin(Ie)),se(ce,q,Math.cos(Ie)),de(fe,fe,ce),N[3*me+0]=fe[0],N[3*me+1]=fe[1],N[3*me+2]=fe[2],se(fe,fe,C),de(fe,fe,j),L[3*me+0]=fe[0],L[3*me+1]=fe[1],L[3*me+2]=fe[2],B[2*me+0]=me/M,B[2*me+1]=0,L[3*(me+M)+0]=L[3*me+0]+k[0],L[3*(me+M)+1]=L[3*me+1]+k[1],L[3*(me+M)+2]=L[3*me+2]+k[2],B[2*(me+M)+0]=me/M,B[2*me+1]=1;const He=(me+1)%M;H(K++,me,me),H(K++,me+M,me),H(K++,He,He),H(K++,He,He),H(K++,me+M,me),H(K++,He+M,He)}if(z){for(let me=0;me<M;me++){const Ie=(me+1)%M;H(K++,J-2,O-2),H(K++,me,O-2),H(K++,Ie,O-2)}for(let me=0;me<M;me++){const Ie=(me+1)%M;H(K++,me+M,O-1),H(K++,J-1,O-1),H(K++,Ie+M,O-1)}}return new zi([["position",{size:3,data:L,exclusive:!0}],["normal",{size:3,data:N,exclusive:!0}],["uv0",{size:2,data:B,exclusive:!0}]],[["position",W],["normal",Y],["uv0",W]])}function p(T,C,M,P,F){M=M||10,P=P==null||P,Ze(T.length>1);const z=[[0,0,0]],D=[],U=[];for(let G=0;G<M;G++){D.push([0,-G-1,-(G+1)%M-1]);const k=G/M*2*Math.PI;U.push([Math.cos(k)*C,Math.sin(k)*C])}return t.createPathExtrusionGeometry(U,T,z,D,P,F)}function f(T,C,M,P,F,z=xt(0,0,0)){const D=T.length,U=new Float32Array(C.length*D*3+(6*M.length||0)),G=new Float32Array(C.length*D*3+(M?6:0)),k=(C.length-1)*D*6+3*P.length*2,j=new Uint32Array(k),V=new Uint32Array(k);let q=0,J=0,O=0,L=0;const N=li(),B=li(),W=li(),Y=li(),H=li(),K=li(),fe=li(),ce=$(),me=li(),Ie=li(),He=li(),$e=li(),Le=li(),Ei=Mt();ne(me,0,1,0),ue(B,C[1],C[0]),_e(B,B),F?(de(ce,C[0],z),_e(W,ce)):ne(W,0,0,1),S(B,W,me,me,H,W,Xne),re(Y,W),re($e,H);for(let lt=0;lt<M.length;lt++)se(K,H,M[lt][0]),se(ce,W,M[lt][2]),de(K,K,ce),de(K,K,C[0]),U[q++]=K[0],U[q++]=K[1],U[q++]=K[2];G[J++]=-B[0],G[J++]=-B[1],G[J++]=-B[2];for(let lt=0;lt<P.length;lt++)j[O++]=P[lt][0]>0?P[lt][0]:-P[lt][0]-1+M.length,j[O++]=P[lt][1]>0?P[lt][1]:-P[lt][1]-1+M.length,j[O++]=P[lt][2]>0?P[lt][2]:-P[lt][2]-1+M.length,V[L++]=0,V[L++]=0,V[L++]=0;let rr=M.length;const Or=M.length-1;for(let lt=0;lt<C.length;lt++){let wC=!1;lt>0&&(re(N,B),lt<C.length-1?(ue(B,C[lt+1],C[lt]),_e(B,B)):wC=!0,de(Ie,N,B),_e(Ie,Ie),de(He,C[lt-1],Y),k1(C[lt],Ie,Ei),vy(Ei,Ko(He,N),ce)?(ue(ce,ce,C[lt]),_e(W,ce),Ye(H,Ie,W),_e(H,H)):S(Ie,Y,$e,me,H,W,Xne),re(Y,W),re($e,H)),F&&(de(ce,C[lt],z),_e(Le,ce));for(let qc=0;qc<D;qc++)if(se(K,H,T[qc][0]),se(ce,W,T[qc][1]),de(K,K,ce),_e(fe,K),G[J++]=fe[0],G[J++]=fe[1],G[J++]=fe[2],de(K,K,C[lt]),U[q++]=K[0],U[q++]=K[1],U[q++]=K[2],!wC){const Nw=(qc+1)%D;j[O++]=rr+qc,j[O++]=rr+D+qc,j[O++]=rr+Nw,j[O++]=rr+Nw,j[O++]=rr+D+qc,j[O++]=rr+D+Nw;for(let Uw=0;Uw<6;Uw++)V[L++]=j[O-6+Uw]-Or}rr+=D}const us=C[C.length-1];for(let lt=0;lt<M.length;lt++)se(K,H,M[lt][0]),se(ce,W,M[lt][1]),de(K,K,ce),de(K,K,us),U[q++]=K[0],U[q++]=K[1],U[q++]=K[2];const yr=J/3;G[J++]=B[0],G[J++]=B[1],G[J++]=B[2];const Rr=rr-D;for(let lt=0;lt<P.length;lt++)j[O++]=P[lt][0]>=0?rr+P[lt][0]:-P[lt][0]-1+Rr,j[O++]=P[lt][2]>=0?rr+P[lt][2]:-P[lt][2]-1+Rr,j[O++]=P[lt][1]>=0?rr+P[lt][1]:-P[lt][1]-1+Rr,V[L++]=yr,V[L++]=yr,V[L++]=yr;return new zi([["position",{size:3,data:U,exclusive:!0}],["normal",{size:3,data:G,exclusive:!0}]],[["position",j],["normal",V]])}function g(T,C,M){Ze(T.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),Ze(T[0].length===3,"createPolylineGeometry(): malformed vertex"),Ze(C==null||C.length===T.length,"createPolylineGeometry: need same number of points and normals"),Ze(C==null||C[0].length===3,"createPolylineGeometry(): malformed normal");const P=new Float64Array(3*T.length),F=new Uint32Array(2*(T.length-1));let z=0,D=0;for(let k=0;k<T.length;k++){for(let j=0;j<3;j++)P[z++]=T[k][j];k>0&&(F[D++]=k-1,F[D++]=k)}const U=[],G=[];if(U.push(["position",F]),G.push(["position",{size:3,data:P,exclusive:!0}]),C){const k=new Float32Array(3*C.length);let j=0;for(let V=0;V<T.length;V++)for(let q=0;q<3;q++)k[j++]=C[V][q];U.push(["normal",F]),G.push(["normal",{size:3,data:k,exclusive:!0}])}return M&&(G.push(["color",{size:4,data:M}]),U.push(["color",lb(M.length/4)])),new zi(G,U,2)}function y(T,C,M,P,F=0){const z=new Array(18),D=[[-C,F,P/2],[M,F,P/2],[0,T+F,P/2],[-C,F,-P/2],[M,F,-P/2],[0,T+F,-P/2]],U=new Uint16Array([0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5]);for(let G=0;G<6;G++)z[3*G]=D[G][0],z[3*G+1]=D[G][1],z[3*G+2]=D[G][2];return new zi([["position",{size:3,data:z,exclusive:!0}]],[["position",U]])}function v(T,C){const M=T.getMutableAttribute("position").data;for(let P=0;P<M.length;P+=3){const F=M[P],z=M[P+1],D=M[P+2];ne(ub,F,z,D),Oe(ub,ub,C),M[P]=ub[0],M[P+1]=ub[1],M[P+2]=ub[2]}}function b(T,C=T){const M=T.vertexAttributes,P=M.get("position").data,F=M.get("normal").data;if(F){const z=C.getMutableAttribute("normal").data;for(let D=0;D<F.length;D+=3){const U=F[D+1];z[D+1]=-F[D+2],z[D+2]=U}}if(P){const z=C.getMutableAttribute("position").data;for(let D=0;D<P.length;D+=3){const U=P[D+1];z[D+1]=-P[D+2],z[D+2]=U}}return C}function w(T,C,M,P,F){return!(Math.abs(ye(C,T))>F)&&(Ye(M,T,C),_e(M,M),Ye(P,M,T),_e(P,P),!0)}function S(T,C,M,P,F,z,D){return w(T,C,F,z,D)||w(T,M,F,z,D)||w(T,P,F,z,D)}t.createSquareGeometry=l,t.createConeGeometry=c,t.createCylinderGeometry=h,t.createTubeGeometry=p,t.createPathExtrusionGeometry=f,t.createPolylineGeometry=g,t.createExtrudedTriangle=y,t.transformInPlace=v,t.cgToGIS=b,t.makeOrthoBasisDirUp=w,t.makeOrthoBasisDirUpFallback=S}(FV||(FV={}));const Xne=.99619469809,ub=li(),Oo=FV,jke=le.getLogger("esri.views.3d.environment.PanoramicAtmosphere");class Bke{constructor(){this.type="panoramic",this._atmosphereTechniqueConfig=new kE,this._readyResolver=Th(),this._readyController=new AbortController}destroy(){this._readyResolver.reject(),this._texture=Ge(this._texture),this._vao=Ge(this._vao),this._readyController=Rl(this._readyController)}when(){return this._readyResolver.promise}initializeRenderContext(e){this._atmosphereTechniqueConfig.geometry=1,this._atmosphereTechnique=e.shaderTechniqueRep.acquire(K_,this._atmosphereTechniqueConfig);const i=e.renderContext.rctx;this._vao=this._createVertexArrayObject(i),this._vaoCount=xs(this._vao,"geometry"),tl(zne,{signal:this._readyController.signal}).then(r=>{this._texture=new qe(i,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},r),e.requestRender(),this._readyController=null,this._readyResolver.resolve()}).catch(r=>{bi(r)||jke.error("Unable to initialize atmosphere: image request failed",r),this._readyResolver.reject()})}get canRender(){return this._texture!=null}render(e){const i=e.rctx,r=this._atmosphereTechnique.program;return i.useProgram(r),this._atmosphereTechnique.bindPipelineState(i),r.bindTexture(this._texture,"tex"),Pc(r,e.camera.projectionMatrix),Gke(Kne,e.camera.viewMatrix),r.setUniformMatrix4fv("view",Kne),r.setUniform4f("color",1,1,1,1),e.scenelightingData.setLightDirectionUniform(r),i.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(4,0,this._vaoCount),!0}renderHaze(){return!1}_createVertexArrayObject(e){const i=Oo.createPolySphereGeometry(1,2,!1),r=i.indices.get("position");for(let a=0;a<r.length;a+=3){const l=r[a];r[a]=r[a+2],r[a+2]=l}const s=i.vertexAttributes.get("position").data,n=eoe.createBuffer(r.length),o=n.position;for(let a=0;a<r.length;++a){const l=3*r[a];o.set(a,0,s[l]),o.set(a,1,s[l+1]),o.set(a,2,s[l+2])}return new Tr(e,Ht,{geometry:il(eoe)},{geometry:Nt.createVertex(e,35044,n.buffer)})}}function Gke(t,e){ji(t,e),t[12]=0,t[13]=0,t[14]=0,t[15]=1}const Kne=be(),eoe=zr().vec3f("position"),qke="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==",Hke=le.getLogger("esri.views.3d.environment.SimpleAtmosphere"),BE=128,toe=-rV,ioe=0,LV=50,Wke=()=>1-511/512,Zke=jM([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class Jke{constructor(e){this.view=e,this.type="simple",this._renderData={texV:ke(),silCircleCenter:$(),silCircleV1:$(),silCircleV2:$(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this._readyResolver=Th(),this._readyController=new AbortController,this.texV1=1,this.isOnMars=$h(e.spatialReference);const i=Ut(e.spatialReference);this.planetRadius=i.radius,this.outerRimWidth=i.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+toe)/this.planetRadius,this.middleRimFactor=(this.planetRadius+ioe)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=ioe/this.outerRimWidth,this.texVScale=this.texV1-this.texV0}destroy(){this._readyResolver.reject(),this._cameraChangeHandle=ln(this._cameraChangeHandle),this._texture=Ge(this._texture),this._fadeVao=Ge(this._fadeVao),this._vao=Ge(this._vao),this._readyController=Rl(this._readyController)}when(){return this._readyResolver.promise}initializeRenderContext(e){this._shaderTechniqueRepository=e.shaderTechniqueRep;const i=e.renderContext.rctx;this._cameraChangeHandle=Ke(this.view,"state.camera",()=>e.requestRender(),!0),this._vao=this._createRibbon(i),this._vaoCount=xs(this._vao,"geometry"),this._fadeVao=vn(i),this._fadeVaoCount=xs(this._fadeVao,"geometry"),tl(this.isOnMars?qke:zne,{signal:this._readyController.signal}).then(r=>{this._texture=new qe(i,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},r),e.requestRender(),this._readyController=null,this._readyResolver.resolve()}).catch(r=>{bi(r)||Hke.error("Unable to initialize simple atmosphere: image request failed",r),this._readyResolver.reject(r)})}get atmosphereConeTechnique(){if(A(this._atmosphereConeTechnique)){const e=new kE;e.geometry=0,this._atmosphereConeTechnique=this._shaderTechniqueRepository.acquire(K_,e)}return this._atmosphereConeTechnique}get atmosphereUndergroundTechnique(){if(A(this._atmosphereUndergroundTechnique)){const e=new kE;e.geometry=2,this._atmosphereUndergroundTechnique=this._shaderTechniqueRepository.acquire(K_,e)}return this._atmosphereUndergroundTechnique}get canRender(){return this._texture!=null}render(e){this._update(e.camera);const i=e.rctx;if(this.atmosphereConeTechnique.bindPipelineState(i),this._renderData.undergroundFadeAlpha<1){const r=this.atmosphereConeTechnique.program;i.useProgram(r),r.setUniformMatrix4fv("proj",e.camera.projectionMatrix),r.setUniformMatrix4fv("view",e.camera.viewMatrix),r.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),r.setUniform3fv("silCircleV1",this._renderData.silCircleV1),r.setUniform3fv("silCircleV2",this._renderData.silCircleV2),r.setUniform2fv("texV",this._renderData.texV),r.bindTexture(this._texture,"tex"),e.scenelightingData.setLightDirectionUniform(r),r.setUniform1f("altitudeFade",this._renderData.altitudeFade),r.setUniform1f("innerScale",this._renderData.innerScale),i.bindVAO(this._vao),i.drawArrays(4,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const r=this.atmosphereUndergroundTechnique.program;i.useProgram(r),r.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),e.scenelightingData.setLightDirectionUniform(r),r.setUniform3fv("cameraPosition",e.camera.eye),i.bindVAO(this._fadeVao),i.drawArrays(5,0,this._fadeVaoCount)}return!0}renderHaze(){return!1}_update(e){const i=$(),r=this.planetRadius,s=Te(e.eye),n=s-r;if(n<0){const g=Math.min(-n/5e3,1);this._renderData.undergroundFadeAlpha=g}else this._renderData.undergroundFadeAlpha=0;const o=Math.max(LV,n),a=r+toe;this._renderData.innerScale=Qke(r+o,r,a)-1,this._renderData.altitudeFade=Dse(n),se(i,e.eye,(r+LV)/s),roe(i,e.center,e.up,r,this._renderData);const l=this._computeScreenRimWidth(e,i,e.up,this._renderData),c=Wke(),h=Zke(n);let p=this.texV0+c*this.texVScale,f=this.texV0+l*h*this.texVScale;if(n>LV){roe(e.eye,e.center,e.up,r,this._renderData);const g=this._computeScreenRimWidth(e,e.eye,e.up,this._renderData),y=Re((g-1.5)/(l-1.5),0,1);p=this.texV0+y*c*this.texVScale,f=this.texV0+Et(this.texV1,l*h,y)*this.texVScale}si(this._renderData.texV,p,f)}_createRibbon(e){const i=new Float32Array(3+3*BE*3),r=new Uint32Array(3*BE*5);i[0]=0,i[1]=0,i[2]=-1;for(let o=0;o<BE;o++){const a=9*o+3;i[a+0]=o,i[a+1]=this.innerRimFactor,i[a+2]=-1,i[a+3]=o,i[a+4]=this.middleRimFactor,i[a+5]=0,i[a+6]=o,i[a+7]=this.outerRimFactor,i[a+8]=1;const l=3*o+1,c=o===BE-1?1:l+3,h=15*o;r[h+0]=l,r[h+1]=l+1,r[h+2]=c+1,r[h+3]=c+1,r[h+4]=c,r[h+5]=l,r[h+6]=l+1,r[h+7]=l+2,r[h+8]=c+2,r[h+9]=c+2,r[h+10]=c+1,r[h+11]=l+1,r[h+12]=l,r[h+13]=c,r[h+14]=0}const s=soe.createBuffer(r.length),n=s.position;for(let o=0;o<r.length;++o){const a=3*r[o];n.set(o,0,i[a]),n.set(o,1,i[a+1]),n.set(o,2,i[a+2])}return new Tr(e,Ht,{geometry:il(soe)},{geometry:Nt.createVertex(e,35044,s.buffer)})}_computeScreenRimWidth(e,i,r,s){return de(hT,s.silCircleCenter,s.silCircleV2),se(zV,hT,this.outerRimFactor),VP(kV,i,hT,r),Gne(hT,kV,e.projectionMatrix,e.viewport),Gne(zV,kV,e.projectionMatrix,e.viewport),qt(hT,zV)/e.height}}function roe(t,e,i,r,s){const n=Te(t),o=r*Math.sqrt(n*n-r*r)/n,a=Math.sqrt(r*r-o*o),l=s.silCircleV1,c=s.silCircleV2;return se(s.silCircleCenter,t,a/n),Ye(l,t,e),un(l)<1&&Ye(l,t,i),se(l,l,o/Te(l)),Ye(c,l,t),se(c,c,o/Te(c)),o}const kV=be(),hT=$(),zV=$();function Qke(t,e,i){return t*t/(Math.sqrt(t*t-e*e)*Math.sqrt(t*t-i*i)+e*i)}const soe=zr().vec3f("position");function VV(t){const e=x`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,i=x`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;t.vertex.code.add(e),t.vertex.code.add(i),t.fragment.code.add(e),t.fragment.code.add(i)}function Yke(){const t=new pi;return t.attributes.add("position","vec3"),t.attributes.add("color","vec4"),t.attributes.add("size","float"),t.varyings.add("vcolor","vec4"),t.varyings.add("vsize","float"),t.vertex.uniforms.add("transform","mat4").add("viewport","vec4").add("pixelRatio","float"),t.include(VV),t.vertex.code.add(x`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),t.fragment.code.add(x`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),t}const Xke=Object.freeze({__proto__:null,build:Yke});class GE extends Si{initializeProgram(e){const i=GE.shader.get().build();return new fi(e.rctx,i,Ht)}initializePipeline(){return _t({blending:Xs(770,1,771,771),depthTest:{func:515},colorWrite:Pt})}bindPass(e){const i=this.makeInfiniteProjectionMatrix(e.camera.projectionMatrix,e.camera.near,Kke);wi(i,i,e.camera.viewMatrix),wi(i,i,e.modelMatrix),this.program.setUniformMatrix4fv("transform",i),this.program.setUniform4fv("viewport",e.camera.fullViewport),this.program.setUniform1f("pixelRatio",e.camera.pixelRatio)}makeInfiniteProjectionMatrix(e,i,r){const s=24e-8;return ji(r,e),r[10]=s-1,r[11]=-1,r[14]=(s-2)*i,r}}GE.shader=new vi(Xke,()=>import("./Stars.glsl.2c2fde58.js"));const Kke=be(),eze=le.getLogger("esri.views.3d.environment.Stars");let Kf=class extends ve{constructor(t){super(t),this._loadDataTask=null,this._numPoints=0,this._renderParameter={camera:null,modelMatrix:be()},this._updatingTracking=new zh}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return _(this._loadDataTask)&&!this._loadDataTask.finished}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=Rl(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=Ge(this._technique),this._vao=Ge(this._vao)}render(t){const{rctx:e,camera:i}=t;if(this._ensureResources(e),A(this._technique)||A(this._vao))return!1;const r=this._technique.program;return e.useProgram(r),this._renderParameter.camera=i,this._technique.bindPass(this._renderParameter),this._technique.bindPipelineState(e),e.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),e.drawArrays(0,0,this._numPoints),!0}_ensureResources(t){if(_(this._technique)||A(hb))return;this._technique=new GE({rctx:t,viewingMode:this.view.state.viewingMode},null),this._numPoints=hb.byteLength/noe;const e=new Float32Array(hb,0,2*this._numPoints),i=new Uint8Array(hb,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(t,e,i,this._numPoints),this._updatingTracking.add(this.view,"environment.lighting.date",r=>this._update(r),2)}_computeDayDuration(t){const e=t,i=new Date(t.getFullYear(),0,1,11,58,56);return(+e-+i)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+i)}_update(t){if(!t)return;const e=(t.getHours()/12+t.getMinutes()/60*(2/24)+t.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(t),r=this._renderParameter.modelMatrix;ji(r,rze),ly(r,r,-i*Math.PI),wi(r,ize,r),ly(r,r,-e*Math.PI),this.requestRender()}_hexToRGB(t){return[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]}_unpackUint8Attributes(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]}_createVertexArrayObject(t,e,i,r){const s=ooe.createBuffer(r),n=s.position,o=s.color,a=s.size;for(let l=0;l<r;l++){const c=e[2*l+0],h=e[2*l+1];n.set(l,0,-Math.cos(c)*Math.sin(h)),n.set(l,1,-Math.sin(c)*Math.sin(h)),n.set(l,2,-Math.cos(h));const p=this._unpackUint8Attributes(i[l]),f=this._hexToRGB(tze[p[1]]);o.set(l,0,255*f[0]),o.set(l,1,255*f[1]),o.set(l,2,255*f[2]),o.set(l,3,255),a.set(l,p[0])}return new Tr(t,Ht,{geometry:il(ooe)},{geometry:Nt.createVertex(t,35044,s.buffer)})}_createLoadDataTask(){if(_(hb))return null;const t=Jw(async e=>{const{data:i}=await K1e("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});this._verifyStarData(i),hb=i});return t.promise.catch(e=>{bi(e)||eze.error(e)}).then(()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))}),t}_verifyStarData(t){if(!t)throw new Q("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=t.byteLength/noe;if(e%1!=0||e>5e4||e<5e3)throw new Q("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};u([d({constructOnly:!0})],Kf.prototype,"view",void 0),u([d({constructOnly:!0})],Kf.prototype,"requestRender",void 0),u([d({readOnly:!0})],Kf.prototype,"updating",null),u([d()],Kf.prototype,"_loadDataTask",void 0),u([d()],Kf.prototype,"_updatingTracking",void 0),Kf=u([R("esri.views.3d.environment.Stars")],Kf);const tze=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],ize=b6(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),rze=b6(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),noe=9,ooe=zr().vec3f("position").vec4u8("color").f32("size");let hb=null;const sze=[12,13];let Wn=class extends ve{constructor(t){super(t),this._handles=new dt,this._context=null,this._pendingAtmosphere=null,this._atmosphere=null,this._stars=null,this._clouds=null,this._cloudComposition=null,this._fog=null}get atmosphereType(){return _(this._pendingAtmosphere)?this._pendingAtmosphere.type:_(this._atmosphere)?this._atmosphere.type:"none"}get canRender(){var t;return!((t=this.view.basemapTerrain)==null||!t.renderer.canRender)||this.view.viewingMode!=="global"}get needsLinearDepth(){return this._selectAtmosphereType()==="realistic"}get updating(){return _(this._pendingAtmosphere)||_(this._stars)&&this._stars.updating||_(this._clouds)&&this._clouds.running}get weatherEnabled(){var t;return!((t=this.view.environmentManager)==null||!t.weatherEnabled)}initialize(){this.view._stage.addRenderPlugin(sze,this)}destroy(){this._pendingAtmosphere=tt(this._pendingAtmosphere),this.uninitializeRenderContext(),this._handles=tt(this._handles),this.view&&this.view._stage!=null&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))}initializeRenderContext(t=null){this._context=t,this._handles.add([NF(this.view,"basemapTerrain",()=>this._updateBasemapTerrain(),!0),hn(()=>({viewingMode:this.view.viewingMode,atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality}),()=>this._updateAtmosphere(),VF),hn(()=>this._starsCreationParameters,e=>this._createOrDestroyStars(e),{sync:!0,initial:!0,equals:oD}),hn(()=>this._cloudsCreationParameters,e=>this._createOrDestroyClouds(e),{sync:!0,initial:!0,equals:oD}),hn(()=>this._fogCreationParameters,e=>this._createOrDestroyFog(e),{sync:!0,initial:!0,equals:oD}),hn(()=>this._weatherUpdateParameters,e=>{this._updateWeather(e),this._updateFog(e)},VF)])}uninitializeRenderContext(){this._stars=tt(this._stars),this._atmosphere=tt(this._atmosphere),this._clouds=tt(this._clouds),this._cloudComposition=tt(this._cloudComposition),this._fog=tt(this._fog)}render(t){if(t.pass!==0)return!1;let e=!1;switch(t.slot){case 12:_(this._stars)&&this._stars.render(t)&&(e=!0),_(this._atmosphere)&&this._atmosphere.canRender&&(this._atmosphere.render(t)&&(e=!0),_(this._clouds)&&_(this._clouds.cubeMap)&&!this._clouds.running&&_(this._cloudComposition)&&(this.view.environment.weather.type!=="sunny"||this.view.environment.weather.cloudCover!==0)&&(this._cloudComposition.render(t,this._clouds.cubeMap,_(this.view.animation),this._clouds.coverage,this._clouds.absorption)&&(e=!0),this._cloudComposition.isFading()&&this._setNeedsRender()));break;case 13:if(_(this._atmosphere)&&this._atmosphere.canRender){const i=this.weatherEnabled?this.view.environment.weather.type:"disabled";this._atmosphere.renderHaze(t,i==="rainy")&&(e=!0),_(this._fog)&&(i!=="foggy"&&this._selectAtmosphereType()==="realistic"||this._fog.render(t,i==="foggy",i==="rainy")&&(e=!0))}break;default:return!1}return e}get _cloudsCreationParameters(){return this.weatherEnabled?{view:this.view,viewingMode:this.view.state.viewingMode,rctx:_(this._context)?this._context.renderContext.rctx:null,radius:Ut(this.view.spatialReference).radius}:null}_createOrDestroyClouds(t){this._clouds=tt(this._clouds),this._cloudComposition=tt(this._cloudComposition),vp(t,({view:e,viewingMode:i,rctx:r,radius:s})=>{this._clouds=new _d({rctx:r,view:e,requestRender:()=>this._setNeedsRender()}),this._cloudComposition=new B6e(r,i,s,Te(e.state.camera.eye)-s)}),this._setNeedsRender()}get _weatherUpdateParameters(){const t=this.weatherEnabled?this.view.environment.weather:null;return A(t)?null:{type:t.type,presetAdjustment:t.type==="foggy"?t.fogStrength:t.cloudCover}}_updateWeather(t){if(A(t)||A(this._clouds))return;const e=YS[t.type].median;for(const i in YS[t.type])if(i==="raymarchingStepType")this._clouds[i]=YS[t.type][i];else if(i!=="median"){const r=YS[t.type][i],s=Et(r[0],r[1],e);this._clouds[i]=t.presetAdjustment<.5?Et(r[0],s,2*t.presetAdjustment):Et(s,r[1],2*(t.presetAdjustment-.5))}}_setNeedsRender(){_(this._context)&&this._context.requestRender()}get _starsCreationParameters(){var t,e,i;return{view:this.view,starsEnabled:(t=(e=this.view)==null||(i=e.environment)==null?void 0:i.starsEnabled)!=null&&t}}_createOrDestroyStars({view:t,starsEnabled:e}){e&&A(this._stars)?(this._stars=new Kf({view:t,requestRender:()=>this._setNeedsRender()}),this._setNeedsRender()):!e&&_(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())}_updateFog(t){A(this._fog)||A(t)||(t.type==="foggy"?this._fog.strength=Et(3e-5,.005,t.presetAdjustment**3):this._fog.strength=4e-6)}get _fogCreationParameters(){return!this.weatherEnabled||A(this._context)?null:{view:this.view,context:this._context}}_createOrDestroyFog(t){this.weatherEnabled&&A(this._fog)?(vp(t,({view:e,context:i})=>{this._fog=new Tke(i,e)}),this._updateFog(this._weatherUpdateParameters),this._setNeedsRender()):_(this._fog)&&(this._fog.destroy(),this._fog=null,this._setNeedsRender())}_updateAtmosphere(){const t=this._selectAtmosphereType();if(this.atmosphereType===t)return;_(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const e=this._getAtmosphereClass();if(!e)return _(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const i=new e(this.view);_(this._context)&&i.initializeRenderContext(this._context),A(this._atmosphere)&&(this._atmosphere=i,this._setNeedsRender()),this._pendingAtmosphere=i,i.when().then(()=>{_(this._atmosphere)&&this._pendingAtmosphere&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()}).catch(()=>{this._pendingAtmosphere===i&&(this._pendingAtmosphere=null)})}_getAtmosphereClass(){switch(this._selectAtmosphereType()){case"none":return null;case"realistic":return yne;case"panoramic":return Bke;case"simple":return Jke;default:return}}_selectAtmosphereType(){const t=this.view.get("environment.atmosphereEnabled"),e=this.view.get("environment.atmosphere.quality"),i=this.view.viewingMode;return!t||e==null||Eh(this.view.spatialReference)?"none":i==="local"?"panoramic":e==="high"&&_(this._context)&&yne.isSupported(this._context)&&yM(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=_(this._atmosphere)&&this.atmosphereType==="simple")}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType()}}};u([d({constructOnly:!0})],Wn.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],Wn.prototype,"updating",null),u([d()],Wn.prototype,"_pendingAtmosphere",void 0),u([d()],Wn.prototype,"_stars",void 0),u([d()],Wn.prototype,"_clouds",void 0),u([d()],Wn.prototype,"_cloudComposition",void 0),u([d()],Wn.prototype,"_fog",void 0),u([d()],Wn.prototype,"weatherEnabled",null),u([d()],Wn.prototype,"_cloudsCreationParameters",null),u([d()],Wn.prototype,"_weatherUpdateParameters",null),u([d()],Wn.prototype,"_starsCreationParameters",null),u([d()],Wn.prototype,"_fogCreationParameters",null),Wn=u([R("esri.views.3d.environment.EnvironmentRenderer")],Wn);function aoe(t,e,i){return nze(t,e.longitude,e.latitude,i.longitude,i.latitude)}function nze(t,e,i,r,s){const n=nt(i),o=nt(s),a=n-o,l=nt(e)-nt(r),c=Math.sin(a/2),h=Math.sin(l/2),p=2*Bl(Math.sqrt(c*c+Math.cos(n)*Math.cos(o)*h*h))*t;return Math.round(1e4*p)/1e4}function oze(t,e,i){const r=e.spatialReference,s=Ut(r),n=new je(e.x,t.y,r),o=new je(i.x,t.y,r),a=new je(t.x,e.y,r),l=new je(t.x,i.y,r);return{lon:aoe(s.radius,n,o),lat:aoe(s.radius,a,l)}}function aze(t,e,i){const r=e/i,s=nt(t),n=Math.sin(r/2),o=Math.cos(s),a=2*Bl(Math.sqrt(n*n/(o*o)));return go(a)}function lze(t,e){let i=t/15;return e||(i=Math.round(i)),i}function loe(t,e){e||(e={hours:0,minutes:0,seconds:0}),e.hours=lze(t[0],!0);const i=e.hours%1;e.hours-=i,e.minutes=60*i;const r=e.minutes%1;return e.minutes-=r,e.seconds=Math.round(60*r),e}var coe,uoe,hoe,doe={exports:{}};coe=doe,uoe=function(){var t=Math.PI,e=Math.sin,i=Math.cos,r=Math.tan,s=Math.asin,n=Math.atan2,o=Math.acos,a=t/180,l=864e5,c=2440588,h=2451545,p={dec:0,ra:0};function f(O){return O.valueOf()/l-.5+c}function g(O){return new Date((O+.5-c)*l)}function y(O){return f(O)-h}var v=23.4397*a;function b(O,L){return n(e(O)*i(v)-r(L)*e(v),i(O))}function w(O,L){return s(e(L)*i(v)+i(L)*e(v)*e(O))}function S(O,L,N){return n(e(O),i(O)*e(L)-r(N)*i(L))}function T(O,L,N){return s(e(L)*e(N)+i(L)*i(N)*i(O))}function C(O,L){return a*(280.16+360.9856235*O)-L}function M(O){return a*(357.5291+.98560028*O)}function P(O){return a*(1.9148*e(O)+.02*e(2*O)+3e-4*e(3*O))}function F(O,L){return O+L+102.9372*a+t}function z(O,L){var N=M(O),B=F(N,P(N));return L||(L={dec:0,ra:0}),L.dec=w(B,0),L.ra=b(B,0),L}var D={POLAR_EXCEPTION:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(O,L,N,B){var W=a*-N,Y=a*L,H=y(O),K=z(H,p),fe=C(H,W)-K.ra;return B||(B={azimuth:0,altitude:0}),B.azimuth=S(fe,Y,K.dec),B.altitude=T(fe,Y,K.dec),B}},U=[[-.83,"sunrise","sunset"]];D.addTime=function(O,L,N){U.push([O,L,N])};var G=9e-4;function k(O,L){return Math.round(O-G-L/(2*t))}function j(O,L,N){return G+(O+L)/(2*t)+N}function V(O,L,N){return h+O+.0053*e(L)-.0069*e(2*N)}function q(O,L,N){return o((e(O)-e(L)*e(N))/(i(L)*i(N)))}function J(O){var L=a*(134.963+13.064993*O),N=a*(93.272+13.22935*O),B=a*(218.316+13.176396*O)+6.289*a*e(L),W=5.128*a*e(N),Y=385001-20905*i(L);return{ra:b(B,W),dec:w(B,W),dist:Y}}return D.getTimes=function(O,L,N){var B=a*-N,W=a*L,Y=k(y(O),B),H=j(0,B,Y),K=M(H),fe=P(K),ce=F(K,fe),me=w(ce,0),Ie=V(H,K,ce);function He(Rr){return V(j(q(Rr,W,me),B,Y),K,ce)}function $e(Rr){var lt=(e(Rr)-e(W)*e(me))/(i(W)*i(me));return lt<-1?D.POLAR_EXCEPTION.MIDNIGHT_SUN:lt>1?D.POLAR_EXCEPTION.POLAR_NIGHT:D.POLAR_EXCEPTION.NORMAL}var Le,Ei,rr,Or,us,yr={solarNoon:g(Ie),nadir:g(Ie-.5),polarException:D.POLAR_EXCEPTION.NORMAL};for(Le=0,Ei=U.length;Le<Ei;Le+=1)us=Ie-((Or=He((rr=U[Le])[0]*a))-Ie),yr[rr[1]]=g(us),yr[rr[2]]=g(Or);return yr.polarException=$e(U[0][0]*a),yr},D.getMoonPosition=function(O,L,N){var B=a*-N,W=a*L,Y=y(O),H=J(Y),K=C(Y,B)-H.ra,fe=T(K,W,H.dec);return fe+=.017*a/r(fe+10.26*a/(fe+5.1*a)),{azimuth:S(K,W,H.dec),altitude:fe,distance:H.dist}},D.getMoonFraction=function(O){var L=y(O),N=z(L),B=J(L),W=149598e3,Y=o(e(N.dec)*e(B.dec)+i(N.dec)*i(B.dec)*i(N.ra-B.ra)),H=n(W*e(Y),B.dist-W*i(Y));return(1+i(H))/2},D},(hoe=uoe())!==void 0&&(coe.exports=hoe);const S0=doe.exports,em={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function cze(t,e,i,r,s){const n=e[2];ne(r.ambient.color,1,1,1),r.ambient.intensity=em.global.ambient,ne(r.direct.color,1,1,1),r.direct.intensity=em.global.direct;const o=Re((Math.abs(n)-em.local.altitude)/(em.global.altitude-em.local.altitude),0,1);r.globalFactor=o;const a=S0.getTimes(t,e[1],e[0]);if(o<1){const l=yze(t,a,s);jr(r.ambient.color,l.ambient.color,r.ambient.color,o),r.ambient.intensity=Et(l.ambient.intensity,r.ambient.intensity,o),jr(r.direct.color,l.direct.color,r.direct.color,o),r.direct.intensity=Et(l.direct.intensity,r.direct.intensity,o)}r.noonFactor=mze(t,a),uze(t,e,i,r.direct.directionToLightSource)}function uze(t,e,i,r){const s=fze,n=Di(pze);if(i===1)S0.getPosition(t,0,0,s),ne(r,0,0,-1),$1(n,n,-s.azimuth),zP(n,n,-s.altitude),Oe(r,r,n);else{const o=em.planarDirection,a=o.globalAngles,l=e[2];let c=(Math.abs(l)-o.localAltitude)/(o.globalAltitude-o.localAltitude);c=Re(c,0,1),c<1?(S0.getPosition(t,e[1],e[0],s),s.azimuth=(1-c)*s.azimuth+c*a.azimuth,s.altitude=(1-c)*s.altitude+c*a.altitude):(s.azimuth=a.azimuth,s.altitude=a.altitude),ne(r,0,-1,0),ly(n,n,-s.azimuth),$1(n,n,-s.altitude),Oe(r,r,n)}}function hze(t,e){if(e===1)return!0;const i=em.planarDirection;return Math.abs(t)<i.localAltitude}const dze=De(.5773502691896258,-.5773502691896258,.5773502691896258);class poe{constructor(){this.ambient={color:De(1,1,1),intensity:.55},this.direct={color:De(1,1,1),intensity:.55,directionToLightSource:br(dze)},this.noonFactor=.5,this.globalFactor=0}}const pze=be(),fze={azimuth:0,altitude:0};function mze(t,e){const i=t.valueOf();let r,s;e.polarException===S0.POLAR_EXCEPTION.MIDNIGHT_SUN?(r=i-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,s=r+432e6):e.polarException===S0.POLAR_EXCEPTION.POLAR_NIGHT?(r=i-2,s=i-1):(r=e.sunrise.valueOf(),s=e.sunset.valueOf());const n=r+(s-r)/2;return 1-Re(Math.abs(i-n)/432e5,0,1)}function gze(t){switch(t){case"disabled":case"sunny":return{direct:1,ambient:1};case"cloudy":return{direct:.8,ambient:1.1};case"rainy":return{direct:.4,ambient:1};case"foggy":return{direct:.3,ambient:1.6}}}function yze(t,e,i){const r=t.valueOf();let s,n;e.polarException===S0.POLAR_EXCEPTION.MIDNIGHT_SUN?(s=r-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,n=s+432e6):e.polarException===S0.POLAR_EXCEPTION.POLAR_NIGHT?(s=r-2,n=r-1):(s=e.sunrise.valueOf(),n=e.sunset.valueOf());const o=n-s,a=s+o/2,l=o/4,c=a-l,h=a+l,p=.06*o,f=s-p/2,g=s+p/2,y=n-p/2,v=n+p/2,b=em.local,w=[.01,b.ambientAtNight],S=[.8,.8,1],T=[.01,.01,.01],C=[b.directAtTwilight,b.ambientAtTwilight],M=[1,.6,.5],P=[.8,.8,1],F=[.9*b.directAtNoon,b.ambientAtNoon],z=[1,.98,.98],D=[.98,.98,1],U=[b.directAtNoon,b.ambientAtNoon],G=[1,1,1],k=[1,1,1],j=F,V=z,q=D,J=C,O=M,L=P;let N,B,W=[0,0],Y=[0,0,0],H=[0,0,0];r<f||r>v?(W=w,Y=T,H=S,B="night"):r<g?(N=g-f,W=Ts(r-f,N,w,C),Y=Ts(r-f,N,T,M),H=Ts(r-f,N,S,P),B="sun rising"):r<c?(N=c-g,W=Ts(r-g,N,C,F),Y=Ts(r-g,N,M,z),H=Ts(r-g,N,P,D),B="early morning"):r<a?(N=a-c,W=Ts(r-c,N,F,U),Y=Ts(r-c,N,z,G),H=Ts(r-c,N,D,k),B="late morning"):r<h?(N=h-a,W=Ts(r-a,N,U,j),Y=Ts(r-a,N,G,V),H=Ts(r-a,N,k,q),B="early afternoon"):r<y?(N=y-h,W=Ts(r-h,N,j,J),Y=Ts(r-h,N,V,O),H=Ts(r-h,N,q,L),B="late afternoon"):r<v&&(N=v-y,W=Ts(r-y,N,J,w),Y=Ts(r-y,N,O,T),H=Ts(r-y,N,L,S),B="sun setting");const K=De(Y[0],Y[1],Y[2]),fe=De(H[0],H[1],H[2]),ce=gze(i);return{direct:{intensity:W[0]*ce.direct,color:K},ambient:{intensity:W[1]*ce.ambient,color:fe},timeOfDay:B}}function Ts(t,e,i,r){const s=[];for(let n=0;n<i.length;n++)s[n]=(r[n]-i[n])*t/e+i[n];return s}class NV{constructor(e=$()){this.intensity=e}}class foe{constructor(e=$(),i=De(.57735,.57735,.57735)){this.intensity=e,this.direction=i}}class UV{constructor(e=$(),i=De(.57735,.57735,.57735),r=!0){this.intensity=e,this.direction=i,this.castShadows=r}}class moe{constructor(){this.r=[0],this.g=[0],this.b=[0]}}let ju=class extends Ci.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new dt,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new UV,this._ambientLight=new NV,this._moonLight=new foe,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){var t;return(t=this._renderer)==null?void 0:t.view}get updating(){var t;return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||(t=this._renderer)!=null&&t.updating)}get weatherEnabled(){var t,e,i;return((t=this._view)==null?void 0:t.environment.atmosphereEnabled)&&!this._disableWeather&&((e=this._view)==null||(i=e.state)==null?void 0:i.viewingMode)===1&&yM(this._view.spatialReference)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(t){this._renderer||(this._renderer=new Wn({view:t}),this._viewHandles.add([t.watch("environment.lighting.date",e=>this._lightingDateHandler(e),!0),t.watch("stationary",()=>this._interactingStationaryHandler()),t.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],()=>this._updateRenderParamsHandler(),!0),t.watch("spatialReference",()=>this._resetReferencePosition(!0),!0),t.watch("environment.weather.type",()=>this._updateLightParams(),!0),this.watch("weatherEnabled",()=>this._updateLightParams(),!0),Ke(t,"viewingMode",()=>this._resetReferencePosition(!0),!0),Ke(t,"environment.lighting.cameraTrackingEnabled",e=>this._updateCameraTracking(e),!0),Ke(t,"state.camera",()=>this._cameraHandler(),!0),this.watch("disableQueries",()=>this._cameraHandler())]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"))}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=tt(this._renderer)}_updateCameraTracking(t){if(this._trackingEnabled=t,t)this._cameraHandler();else{const e=this._view.environment.lighting;e&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(t){if(!t)return;const e=this._view.environment.lighting;if(!e.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!fy(i)){const r=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(r))return void this._requestReferencePositionUpdate(r)}if(this._preupdateTracking(t),_(this._referencePosWGS84Comparable)){const r=loe(this._referencePosWGS84Comparable,yoe);_(r)&&(e.autoUpdate(null,r),this._trackingEnabled&&(e.positionTimezoneInfo.autoUpdated=!0))}}this._updateLightParams(t)}_preupdateTracking(t){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(t)}_cameraHandler(t=null){const e=this._view;if(!e.ready)return;const i=e.stateManager.camera;i&&(this._cameraHandlerClientSide(i,t)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(t,e){const i=yM(this._view.spatialReference);if(i&&!fy(this._view.spatialReference))return!1;const r=t.position;return A(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=$()),i?wSe(r,this._referencePosWGS84Comparable):ne(this._referencePosWGS84Comparable,r.longitude,r.latitude,r.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,e)||this._updateLightParams(e),!0}_cameraHandlerServerSide(t){const e=t.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(e))&&this._requestReferencePositionUpdate(e,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=e.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLightParams(t){const e=this._view,i=e.environment.lighting,r=t||i.date,s=e._stage,n=this._referencePosWGS84Comparable,o=_(n)?goe:vze;if(_(n)){const f=this.weatherEnabled?e.environment.weather.type:"disabled";cze(r,n,e.state.viewingMode,goe,f)}const a=this._mainLight,l=o.direct;se(a.intensity,l.color,l.intensity*Math.PI),re(a.direction,l.directionToLightSource);const c=this._ambientLight;se(c.intensity,o.ambient.color,o.ambient.intensity);const h=this._moonLight;jr(h.intensity,bze,wze,o.globalFactor);const p=(1-.5*o.globalFactor)*(1-.4*o.noonFactor*(1-o.globalFactor));se(h.intensity,h.intensity,p),re(h.direction,l.directionToLightSource),s.renderView.updateLightSources([a,c,h],1-o.noonFactor,o.globalFactor),this._updateRenderParamsHandler()}_autoUpdateTimezone(t,e=null){if(!this._view.environment.lighting.cameraTrackingEnabled||A(t))return!1;const i=_ze;i.setTime((e||this._view.environment.lighting.date).getTime());const r=loe(t,yoe);if(A(r))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const n=i.getUTCHours()-(r.hours-s.hours),o=i.getUTCMinutes()-(r.minutes-s.minutes),a=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(n),i.setUTCMinutes(o),i.setUTCSeconds(a),!e&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParamsHandler(){const t=this._view._stage;if(!t)return;const e=xh(this._referencePosWGS84Comparable,!0,s=>hze(s[2],this._view.state.viewingMode)),i=this._view.environment.background,r=i instanceof Cse?{type:"color",color:S6(Ae.toUnitRGBA(i.color))}:{type:"color",color:Bt(0,0,0,1)};t.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&e,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:r})}_resetReferencePosition(t=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),t&&this._cameraHandler()}_requestReferencePositionUpdate(t,e=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(t):this._referencePosMapCoordsRequested=t.clone(),this._referencePosResetPreserveAbsoluteTime=!!e,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const i=this._referencePosUpdateQuery=Zw(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===i){const s=()=>this._referencePosUpdateQuery!==i;return this._doReferencePositionUpdateQuery(s)}}).catch(s=>{s.name==="mapcoordshelper:missing-geometry-service"&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===i&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),r=this._referencePosUpdateTimer=Zw(this._referencePointUpdateInterval).then(()=>{this._referencePosUpdateTimer===r&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(t){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const e=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!t()&&!isNaN(e[0])&&!isNaN(e[1])){const i=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=e[0],this._referencePosWGS84Comparable[1]=e[1],this._referencePosWGS84Comparable[2]=i):this._referencePosWGS84Comparable=[e[0],e[1],i],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const t=this._referencePosMapCoordsRequested;t&&this._requestReferencePositionUpdate(t,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(t){if(this._referencePosMapCoords){let e=this._referencePosMapCoords.distance(t);return this._view.mapCoordsHelper&&(e*=this._view.mapCoordsHelper.unitInMeters),e>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const t=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,t}get test(){const t=this;return{get renderer(){return t._renderer},set referencePointUpdateInterval(e){t._referencePointUpdateInterval=e},set referencePointUpdateDistThreshold(e){t._referencePointUpdateDistThreshold=e},set referencePosUpdateTimer(e){t._referencePosUpdateTimer=e},set referencePointUpdateDelay(e){t._referencePointUpdateDelay=e},set disableWeather(e){t._disableWeather=e}}}};u([d({type:Boolean,readOnly:!0})],ju.prototype,"updating",null),u([d()],ju.prototype,"disableQueries",void 0),u([d()],ju.prototype,"_disableWeather",void 0),u([d()],ju.prototype,"weatherEnabled",null),u([d()],ju.prototype,"referencePositionWGS84Comparable",null),u([d()],ju.prototype,"_renderer",void 0),u([d()],ju.prototype,"_referencePosWGS84Comparable",void 0),ju=u([R("esri.views.3d.environment.SceneViewEnvironmentManager")],ju);const goe=new poe,vze=new poe,_ze=new Date,yoe={hours:0,minutes:0,seconds:0},bze=De(.22,.22,.33),wze=De(.22,.22,.22);function dT(t,e){return(t&e)!=0}function qE(t,e,i,r,s,n){t!==0&&(i?(n.min=Math.min(n.min,e),n.max=Math.max(n.max,e)):r!=null?(n.min-=Math.max(0,(e-n.min)*(1-r)),n.max+=Math.max(0,(e-n.max)*(1-r))):s&&(n.min-=Math.max(0,e-n.min-s),n.max+=Math.max(0,e-n.max-s)))}const tm={selection:0,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0};function voe(t,e,i,r){return e=e||t.viewForward,re(r,e),se(r,r,Math.sign(ye(e,i))),r}function xze(t,e,i,r){return Pze(t,e,i,Cze(r,e,i,!0))}function Sze(t,e,i,r){const s=ye(i,ue(t,r,e));return de(t,e,se(t,i,s))}const Tze={dir:$(),len:0,clip:ke()};function Cze(t,e,i,r){const s=Tze;return t?(i&&r&&(s.len=qt(e,i)),re(s.dir,t)):r?(s.len=qt(e,i),ue(s.dir,i,e),se(s.dir,s.dir,1/s.len)):(ue(s.dir,i,e),_e(s.dir,s.dir)),s}function Mze(t,e,i){const r=ye(Li(t),i.dir),s=-hi(t,e);if(s<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return s>0;if((s<0||r<0)&&!(s<0&&r<0))return!0;const n=s/r;return r>0?n<i.clip[1]&&(i.clip[1]=n):n>i.clip[0]&&(i.clip[0]=n),i.clip[0]<=i.clip[1]}function Pze(t,e,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let s=0;s<t.length;s++)if(!Mze(t[s],e,r))return!1;return!0}function Aze(t,e,i=tm){const r=jV(t,e,i);if(r===0)return!1;const s=t.renderCoordsHelper,n=s.getAltitude(e.eye)+r,o=voe(e,i.interactionDirection,Oze(t,e,Math.sign(r),Fze),Dze),a=re(Lze,e.viewForward),l=s.intersectInfiniteManifold(Ko(e.eye,o),n,BV);return e.eye=_(l)?l:s.setAltitude(BV,n,e.eye),e.center=Sze(BV,e.eye,a,e.center),!0}function jV(t,e,i=tm){if(!$ze(t,i))return 0;const r=Rze(t.state.constraints.altitude,Ize);Eze(t,i,r);const s=t.renderCoordsHelper.getAltitude(e.eye),n=Re(s,r.min,r.max)-s;return Math.abs(n)<=1e-6?0:n}function $ze(t,e){const i=t.state.constraints.altitude;return!(!t.state.isGlobal||!i)&&(e.interactionType!==2||!dT(e.selection,1))}function Eze(t,e,i){const r=e.interactionType;if(r===0)return;const{min:s,max:n}=i,{interactionStartCamera:o,interactionFactor:a}=e,l=r===2||r===1,c=jV(t,o),h=c===0?0:t.renderCoordsHelper.getAltitude(o.eye);i.min=s,i.max=n,qE(c,h,l,a,.05*h,i)}function Oze(t,e,i,r){return t.renderCoordsHelper.worldUpAtPosition(e.eye,r),se(r,r,i),r}function Rze(t,e){return e.min=t.min,e.max=t.max,e}const Ize={min:0,max:0},Dze=$(),Fze=$(),Lze=$(),BV=$();function GV(t,e,i=tm){if(!t.state.isLocal)return 0;const r=t.state.constraints.distance;if(!t.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;HE.min=0,HE.max=r,zze(t,i,HE);const s=qV(t,e),n=HE.max-s;return n>=-1e-6?0:n}function kze(t,e,i=tm){const r=GV(t,e,i);if(r===0)return!1;const s=t.pointsOfInterest.surfaceOrigin,n=qV(t,e)+r,o=re(Nze,e.eye),a=voe(e,i.interactionDirection,Vze(t,e,Bze),jze);if(!mf(iQ(s.renderLocation,n),Ko(e.eye,a),WE))return!1;e.eye=WE;const l=ue(Uze,e.eye,o);e.center=de(WE,e.center,l);const c=t.renderCoordsHelper.getAltitude(e.center),h=t.renderCoordsHelper.intersectInfiniteManifold(e.ray,c,WE);return _(h)&&(e.center=h),!0}function zze(t,e,i){const r=e.interactionType;if(r===0)return;const{min:s,max:n}=i,{interactionStartCamera:o,interactionFactor:a}=e,l=r===1||r===4,c=GV(t,o),h=c===0?0:qV(t,o);i.min=s,i.max=n,qE(c,h,l,a,.05*h,i)}function qV(t,e){const i=t.pointsOfInterest.surfaceOrigin;return qt(e.eye,i.renderLocation)}function Vze(t,e,i){const r=t.pointsOfInterest.surfaceOrigin;return Lh(i,e.eye,r.renderLocation)}const HE={min:0,max:0},Nze=$(),Uze=$(),jze=$(),Bze=$(),WE=$();class Gze{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2}}function Bu(t){return _(t)&&_(t.dist)}function _oe(t){return(e,i,r)=>(jr(woe,e,i,r),!N6(t,woe))}function boe(t){return Bu(t)&&t.intersector===0&&!!t.target}function HV(t){return Bu(t)&&t.intersector===1&&!!t.target&&_(t.target.center)}const woe=$();class qze{constructor(){this._transform=be(),this._transformInverse=new ZE({value:this._transform},Fi,be),this._transformInverseTranspose=new ZE(this._transformInverse,Nn,be),this._transformTranspose=new ZE({value:this._transform},Nn,be),this._transformInverseRotation=new ZE({value:this._transform},$ne,Ai)}invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){ji(this._transform,e)}multiplyTransform(e){wi(this._transform,this._transform,e)}set(e){ji(this._transform,e),this.invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,i){this.setTransformMatrix(e),this.multiplyTransform(i),this.invalidateLazyTransforms()}}class ZE{constructor(e,i,r){this.original=e,this.update=i,this.dirty=!0,this.transform=r()}invalidate(){this.dirty=!0}get value(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform}}class Hze{constructor(e=0){this.offset=e,this.tmpVertex=$()}applyToVertex(e,i,r){const s=e+this.localOrigin[0],n=i+this.localOrigin[1],o=r+this.localOrigin[2],a=this.offset/Math.sqrt(s*s+n*n+o*o);return this.tmpVertex[0]=e+s*a,this.tmpVertex[1]=i+n*a,this.tmpVertex[2]=r+o*a,this.tmpVertex}applyToAabb(e){const i=e[0]+this.localOrigin[0],r=e[1]+this.localOrigin[1],s=e[2]+this.localOrigin[2],n=e[3]+this.localOrigin[0],o=e[4]+this.localOrigin[1],a=e[5]+this.localOrigin[2],l=this.offset/Math.sqrt(i*i+r*r+s*s);e[0]+=i*l,e[1]+=r*l,e[2]+=s*l;const c=this.offset/Math.sqrt(n*n+o*o+a*a);return e[3]+=n*c,e[4]+=o*c,e[5]+=a*c,e}}class Wze{constructor(e=0){this.offset=e,this.componentLocalOriginLength=0,this.tmpVertex=$(),this.mbs=Ot(),this.obb={center:$(),halfSize:li(),quaternion:null}}set localOrigin(e){this.componentLocalOriginLength=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}applyToVertex(e,i,r){const s=e,n=i,o=r+this.componentLocalOriginLength,a=this.offset/Math.sqrt(s*s+n*n+o*o);return this.tmpVertex[0]=e+s*a,this.tmpVertex[1]=i+n*a,this.tmpVertex[2]=r+o*a,this.tmpVertex}applyToAabb(e){const i=e[0],r=e[1],s=e[2]+this.componentLocalOriginLength,n=e[3],o=e[4],a=e[5]+this.componentLocalOriginLength,l=this.offset/Math.sqrt(i*i+r*r+s*s);e[0]+=i*l,e[1]+=r*l,e[2]+=s*l;const c=this.offset/Math.sqrt(n*n+o*o+a*a);return e[3]+=n*c,e[4]+=o*c,e[5]+=a*c,e}applyToMbs(e){const i=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),r=this.offset/i;return this.mbs[0]=e[0]+e[0]*r,this.mbs[1]=e[1]+e[1]*r,this.mbs[2]=e[2]+e[2]*r,this.mbs[3]=e[3]+e[3]*this.offset/i,this.mbs}applyToObb(e){const i=e.center,r=this.offset/Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);this.obb.center[0]=i[0]+i[0]*r,this.obb.center[1]=i[1]+i[1]*r,this.obb.center[2]=i[2]+i[2]*r,Ep(this.obb.halfSize,e.halfSize,e.quaternion),de(this.obb.halfSize,this.obb.halfSize,e.center);const s=this.offset/Math.sqrt(this.obb.halfSize[0]*this.obb.halfSize[0]+this.obb.halfSize[1]*this.obb.halfSize[1]+this.obb.halfSize[2]*this.obb.halfSize[2]);return this.obb.halfSize[0]+=this.obb.halfSize[0]*s,this.obb.halfSize[1]+=this.obb.halfSize[1]*s,this.obb.halfSize[2]+=this.obb.halfSize[2]*s,ue(this.obb.halfSize,this.obb.halfSize,e.center),qS(Coe,e.quaternion),Ep(this.obb.halfSize,this.obb.halfSize,Coe),this.obb.halfSize[0]*=this.obb.halfSize[0]<0?-1:1,this.obb.halfSize[1]*=this.obb.halfSize[1]<0?-1:1,this.obb.halfSize[2]*=this.obb.halfSize[2]<0?-1:1,this.obb.quaternion=e.quaternion,this.obb}}class Zze{constructor(e=0){this.offset=e,this.sphere=rs(),this.tmpVertex=$()}applyToVertex(e,i,r){const s=this.objectTransform.transform;let n=s[0]*e+s[4]*i+s[8]*r+s[12],o=s[1]*e+s[5]*i+s[9]*r+s[13],a=s[2]*e+s[6]*i+s[10]*r+s[14];const l=this.offset/Math.sqrt(n*n+o*o+a*a);n+=n*l,o+=o*l,a+=a*l;const c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*n+c[4]*o+c[8]*a+c[12],this.tmpVertex[1]=c[1]*n+c[5]*o+c[9]*a+c[13],this.tmpVertex[2]=c[2]*n+c[6]*o+c[10]*a+c[14],this.tmpVertex}applyToMinMax(e,i){const r=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*r,e[1]+=e[1]*r,e[2]+=e[2]*r;const s=this.offset/Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);i[0]+=i[0]*s,i[1]+=i[1]*s,i[2]+=i[2]*s}applyToAabb(e){const i=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*i,e[1]+=e[1]*i,e[2]+=e[2]*i;const r=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*r,e[4]+=e[4]*r,e[5]+=e[5]*r,e}applyToBoundingSphere(e){const i=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),r=this.offset/i;return this.sphere[0]=e[0]+e[0]*r,this.sphere[1]=e[1]+e[1]*r,this.sphere[2]=e[2]+e[2]*r,this.sphere[3]=e[3]+e[3]*this.offset/i,this.sphere}}const xoe=new Zze;function WV(t){return _(t)?(xoe.offset=t,xoe):null}const Soe=new Wze;function pat(t){return _(t)?(Soe.offset=t,Soe):null}const Toe=new Hze;function Jze(t){return _(t)?(Toe.offset=t,Toe):null}const T0="terrain",Coe=pf();function JE(t,e,i){for(let r=0;r<i;++r)e[2*r]=t[r],e[2*r+1]=t[r]-e[2*r]}function Qze(t,e,i,r){for(let s=0;s<r;++s)Moe[0]=t[s],JE(Moe,ZV,1),e[s]=ZV[0],i[s]=ZV[1]}const Moe=new Float64Array(1),ZV=new Float32Array(2);function JV(t,e){return A(t)&&(t=[]),t.push(e),t}function QV(t,e){if(A(t))return null;const i=t.filter(r=>r!==e);return i.length===0?null:i}function pT(t){return!!_(t)&&!t.visible}function Yze(t,e,i){const r=t.origin.vec3;qne(YV,-r[0],-r[1],-r[2]),_(t.transformation)?wi(e,YV,t.transformation):ji(e,YV),i&&(Fi(i,e),Nn(i,i))}function Xze(t,e,i,r,s){QE[0]=t.get(e,0),QE[1]=t.get(e,1),QE[2]=t.get(e,2),JE(QE,C0,3),i.set(s,0,C0[0]),r.set(s,0,C0[1]),i.set(s,1,C0[2]),r.set(s,1,C0[3]),i.set(s,2,C0[4]),r.set(s,2,C0[5])}const QE=new Float64Array(3),C0=new Float32Array(6),YV=be(),db=1e-5;class Kze{constructor(e){this.options=new Gze,this._results=new e8e,this.transform=new qze,this.tolerance=db,this.verticalOffset=null,this._ray=vs(),this._rayEnd=$(),this._rayBeginTransformed=$(),this._rayEndTransformed=$(),this.viewingMode=e==null?1:e}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,i,r){this.resetWithRay(HSe(e,i,this._ray),r)}resetWithRay(e,i){this.camera=i,e!==this._ray&&YP(e,this._ray),this.options.verticalOffset!==0?this.viewingMode===2?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,de(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,i,r,s,n){this.point=i,this.filterPredicate=s,this.tolerance=r==null?db:r;const o=WV(this.verticalOffset);if(_(e)&&e.length>0){const a=n?l=>{n(l)&&this.intersectObject(l)}:l=>{this.intersectObject(l)};for(const l of e){const c=l.getSpatialQueryAccelerator&&l.getSpatialQueryAccelerator();_(c)?(_(o)?c.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,a,o):c.forEachAlongRay(this._ray.origin,this._ray.direction,a),this.options.selectionMode&&this.options.hud&&c.forEachDegenerateObject(a)):l.objects.forAll(h=>a(h))}}this.sortResults()}intersectObject(e){const i=e.geometryRecords;if(!i)return;const r=e.transformation,s=WV(this.verticalOffset);for(const n of i){const{geometry:o,material:a,instanceParameters:l}=n;if(pT(l))continue;const c=o.id;this.transform.setAndInvalidateLazyTransforms(r,n.getShaderTransformation()),Oe(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),Oe(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const h=this.transform.transform;_(s)&&(s.objectTransform=this.transform),a.intersect(o,l,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(p,f,g,y,v,b)=>{if(p>=0){if(_(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,p))return;if(y){if(this._results.hud.dist==null||p<this._results.hud.dist){const S={object:e,geometryId:c,triangleNr:g,center:b};this._results.hud.set(1,S,p,f,Dr,v)}return}const w=S=>S.set(0,{object:e,geometryId:c,triangleNr:g},p,f,h,v);if((this._results.min.drapedLayerOrder==null||v>=this._results.min.drapedLayerOrder)&&(this._results.min.dist==null||p<this._results.min.dist)&&w(this._results.min),this.options.store!==0&&(this._results.max.drapedLayerOrder==null||v<this._results.max.drapedLayerOrder)&&(this._results.max.dist==null||p>this._results.max.dist)&&w(this._results.max),this.options.store===2){const S=YE(this._ray);S.set(0,{object:e,geometryId:c,triangleNr:g},p,f,h),this._results.all.push(S)}}},n.shaderTransformation)}}sortResults(){this._results.all.sort((e,i)=>e.dist!==i.dist?st(e.dist,0)-st(i.dist,0):e.drapedLayerOrder!==i.drapedLayerOrder?st(e.drapedLayerOrder,Number.MAX_VALUE)-st(i.drapedLayerOrder,Number.MAX_VALUE):st(i.drapedLayerGraphicOrder,Number.MIN_VALUE)-st(e.drapedLayerGraphicOrder,Number.MIN_VALUE))}}function nl(t){return new Kze(t)}class e8e{constructor(){this._min=new fT(vs()),this._max=new fT(vs()),this._hud=new fT(vs()),this._ground=new fT(vs())}get min(){return this._min}get max(){return this._max}get hud(){return this._hud}get ground(){return this._ground}init(e){this._min.init(e),this._max.init(e),this._hud.init(e),this._ground.init(e),this.all=[]}}class fT{constructor(e){this.intersector=0,this.normal=$(),this.transformation=be(),this._ray=vs(),this.init(e)}get ray(){return this._ray}get distanceInRenderSpace(){return _(this.dist)?(se(XE,this.ray.direction,this.dist),Te(XE)):null}getIntersectionPoint(e){return!!Bu(this)&&(se(XE,this.ray.direction,this.dist),de(e,this.ray.origin,XE),!0)}getTransformedNormal(e){return re(mT,this.normal),mT[3]=0,Va(mT,mT,this.transformation),re(e,mT),_e(e,e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=0,YP(e,this._ray)}set(e,i,r,s,n,o,a){this.intersector=e,this.dist=r,re(this.normal,st(s,hH)),ji(this.transformation,st(n,Dr)),this.target=i,this.drapedLayerOrder=o,this.drapedLayerGraphicOrder=a}copy(e){YP(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,re(this.normal,e.normal),ji(this.transformation,e.transformation)}}function YE(t){return new fT(t)}const XE=$(),mT=Ot();function Poe(t,e,i,r){return _(t.renderCoordsHelper.fromRenderCoords(e.eye,eO,r))&&K5(i,eO)}function KE(t,e){return t.elevationProvider?st(t.elevationProvider.getElevation(e[0],e[1],e[2],t.renderCoordsHelper.spatialReference,"ground"),0):0}function M0(t,e,i,r){const s=t.state.camera.clone();e&&(s.eye=e,s.center=i,s.up=r),t8e(t,s.ray,im)||re(im,s.center);const n=t.state.constraints,o=n.minimumPoiDistance;if(cn(s.eye,im)<o){const a=n.collision.enabled;re(P0,s.viewForward),se(P0,P0,o),a?s.eye=ue(eO,im,P0):de(im,s.eye,P0);const l=t.renderCoordsHelper,c=l.getAltitude(s.eye),h=n.collision.elevationMargin;a&&c<h&&(ue(P0,im,s.eye),s.eye=l.setAltitude(eO,h,s.eye),de(im,s.eye,P0))}return s.center=im,s}function Aoe(t,e,i){if(!t.state.isGlobal)return!1;const r=KE(t,e),s=t.stateManager.constraintsManager.nearFarHeuristic,{far:n}=s.compute(e,i,t.renderDataExtent,r,r8e),o=n*n;return cn(e,i)>o}function t8e(t,e,i){let r=$oe[t.viewingMode];r||(r=nl(t.state.viewingMode),r.options.backfacesTerrain=!t.state.isGlobal,r.options.invisibleTerrain=!0,$oe[t.viewingMode]=r);const{isGlobal:s}=t.state;return!(!t.sceneIntersectionHelper.intersectRay(e,r,i)||Aoe(t,e.origin,i))||!(!t.renderCoordsHelper.intersectManifold(e,0,i)||Aoe(t,e.origin,i))||!!s&&i8e(e,i,Ut(t.spatialReference).radius)}function i8e(t,e,i){const r=ye(t.origin,t.origin)-i*i,s=r>0?Math.sqrt(r)/3:1;return se(e,t.direction,s/Te(t.direction)),de(e,e,t.origin),!0}const $oe={},eO=$(),im=$(),P0=$(),r8e={near:0,far:0};function pb(t,e,i=0){const r=t.state.constraints;if(!r.collision.enabled)return!1;const s=KE(t,e.eye),n=t.renderCoordsHelper.getAltitude(e.eye),o=s+r.collision.elevationMargin;if(n>=o)return!1;const a=Te(e.eye);if(ue(tO,e.center,e.eye),e.eye=t.renderCoordsHelper.setAltitude(s8e,o,e.eye),i===1)e.center=de(tO,e.eye,tO);else if(i===2){const l=(a-n+o)/a;e.center=se(tO,e.center,l)}return!0}const tO=$(),s8e=$();function rm(t,e,i){t.worldUpAtPosition(e,Eoe),ue(XV,i,e);const r=Te(XV);return r===0?0:ar(ye(XV,Eoe)/r)}const Eoe=$(),XV=$();function Ooe(t,e,i=tm,r=!0){yT.eyeCenterDistance=0,yT.requiresTwoSteps=!1;const s=KV(t,e,i,void 0,yT);if(s===0)return!1;switch(Di(fb),Bi(fb,fb,-s,e.viewRight),i.tiltMode){case 1:Oe(sm,e.viewForward,fb),se(sm,sm,yT.eyeCenterDistance),e.center=de(nm,e.eye,sm);break;case 0:ue(sm,e.center,e.eye),Oe(sm,sm,fb),e.eye=ue(nm,e.center,sm);break;default:kn(i.tiltMode)}return e.up=Oe(nm,e.up,fb),!yT.requiresTwoSteps||!r||Ooe(t,e,i,!1)}function KV(t,e,i=tm,r=tm,s){if(!t.state.constraints.tilt)return 0;const n=e.distance,o=t.state.constraints.tilt(n,f8e);return p8e(t,i,o),r.interactionType===2&&dT(r.selection,2)&&Roe(t,r.interactionStartCamera,o),i.tiltMode===1||r.tiltMode===1?o8e(t,e,o,s):n8e(t,e,o)}function n8e(t,e,i){const r=rm(t.renderCoordsHelper,e.center,e.eye),s=r-Re(r,i.min,i.max);return gT(s)?s:0}function o8e(t,e,i,r){switch(r&&(r.requiresTwoSteps=!1),t.viewingMode){case"global":return l8e(t,e,i,r);case"local":return a8e(t,e,i,r);default:return void kn(t.viewingMode)}}function a8e(t,e,i,r){const s=rm(t.renderCoordsHelper,e.center,e.eye),n=Re(s,i.min,i.max),o=s-n;if(!gT(o))return 0;if(r){const a=t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=t.renderCoordsHelper.getAltitude(e.eye)-a,c=Math.cos(n);Math.abs(c)>1e-4?r.eyeCenterDistance=l/c:r.eyeCenterDistance=e.distance}return o}function l8e(t,e,i,r){const s=c8e(t,e,m8e),n=Re(s.tiltAtCenter,i.min,i.max);if(!gT(s.tiltAtCenter-n))return 0;let o,a;return s.centerIsOnSurface?(o=u8e(s),a=h8e(s,o)):(o=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),r&&o<Math.PI/2&&(r.requiresTwoSteps=!0,o=Math.PI/2-1e-5),a=d8e(s,o)),r&&(r.eyeCenterDistance=eN(s,o)),a}function c8e(t,e,i){const r=t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+Ut(t.spatialReference).radius,n=t.renderCoordsHelper.intersectManifold(e.ray,r,nm);return i.eyeCenterDistance=e.distance,i.centerIsOnSurface=!1,_(n)?(i.eyeCenterDistance=qt(e.eye,n),i.tiltAtCenter=rm(t.renderCoordsHelper,n,e.eye),i.centerIsOnSurface=!0):t.state.isLocal?i.tiltAtCenter=rm(t.renderCoordsHelper,e.center,e.eye):(L1(KP(s),e.ray,nm),i.eyeCenterDistance=qt(e.eye,nm),i.tiltAtCenter=ar(-ye(e.viewForward,_e(nm,nm)))),i.radius=s,i.eyeRadius=Te(e.eye),i.constraints=t.state.constraints,i}function gT(t){return Math.abs(t)>1e-9}function u8e(t){const{constraints:e,eyeCenterDistance:i,tiltAtCenter:r}=t;let s=r,n=e.clampTilt(i,r);const o=eN(t,n);if(e.clampTilt(o,r)===n)return n;let a=0;for(;a<10&&gT(n-s);){const l=(s+n)/2,c=eN(t,l);gT(e.clampTilt(c,l)-l)?s=l:n=l,a++}return n}function eN(t,e){if(!t.centerIsOnSurface)return t.eyeCenterDistance;const i=Math.PI-Re(e,0,Math.PI),r=Bl(t.radius/t.eyeRadius*Math.sin(i)),s=Math.PI-i-r,n=Math.sin(s)/Math.sin(i);if(t.eyeRadius<t.radius&&n>1){const o=Math.PI-r,a=Math.PI-i-o;return Math.sin(a)/Math.sin(i)*t.eyeRadius}return n*t.eyeRadius}function h8e(t,e){const i=Bl(t.radius/t.eyeRadius*Math.sin(t.tiltAtCenter)),r=Bl(t.radius/t.eyeRadius*Math.sin(e));return t.eyeRadius>t.radius?i-r:r-i}function d8e(t,e){return t.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}function p8e(t,e,i){if(e.interactionType===0)return;const{interactionStartCamera:r,interactionFactor:s}=e,{min:n,max:o}=i,a=KV(t,r,tm,e),l=a===0?0:rm(t.renderCoordsHelper,r.center,r.eye);i.min=n,i.max=o,e.interactionType===2?(dT(e.selection,2)&&Roe(t,r,i),qE(a,l,!0,s,Ioe,i)):qE(a,l,!1,s,Ioe,i)}function Roe(t,e,i){if(t.state.isLocal)return;const r=t.state.constraints;if(!r.altitude)return;const s=un(e.center),n=Math.sqrt(s),o=e.distance,a=Ut(t.spatialReference).radius,l=r.altitude.min+a,c=r.altitude.max+a,h=(l*l-o*o-s)/(-2*n*o),p=(c*c-o*o-s)/(-2*n*o);i.min=Math.max(i.min,Math.min(Math.PI-ar(p),i.max)),i.max=Math.min(i.max,Math.PI-ar(h))}const sm=$(),fb=be(),nm=$(),Ioe=nt(5),f8e={min:0,max:0},m8e={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},yT={eyeCenterDistance:0,requiresTwoSteps:!1};function g8e(t){return t}const iO=t=>t*t,tN=t=>1-iO(1-t),y8e=t=>t<.5?iO(2*t)/2:(tN(2*(t-.5))+1)/2,iN=t=>t*t*t,Doe=t=>1-iN(1-t),Foe=t=>t<.5?iN(2*t)/2:(Doe(2*(t-.5))+1)/2,rN=t=>t*t*t*t,Loe=t=>1-rN(1-t),v8e=t=>t<.5?rN(2*t)/2:(Loe(2*(t-.5))+1)/2,sN=t=>t*t*t*t*t,koe=t=>1-sN(1-t),_8e=t=>t<.5?sN(2*t)/2:(koe(2*(t-.5))+1)/2,nN=t=>1-Math.cos(t*Math.PI/2),zoe=t=>1-nN(1-t),b8e=t=>t<.5?nN(2*t)/2:(zoe(2*(t-.5))+1)/2,oN=t=>2**(10*(t-1)),vT=t=>1-oN(1-t),w8e=t=>t<.5?oN(2*t)/2:(vT(2*(t-.5))+1)/2,aN=t=>-(Math.sqrt(1-t*t)-1),Voe=t=>1-aN(1-t),x8e=t=>t<.5?aN(2*t)/2:(Voe(2*(t-.5))+1)/2;function ol(t){const e=2*(t-Math.sqrt((t-1)*t)),i=e/2/t;return r=>r<i?t*r*r:e*r-e+1}function al(t,e){return(i,r)=>i<e?e*t(i/e,r):1-t((1-i)/(1-e),r)*(1-e)}const S8e=al(ol(1),1),T8e=al(ol(1),0),Noe=al(ol(1),.5),C8e=al(ol(2),1),M8e=al(ol(2),0),P8e=al(ol(2),.5),A8e=al(ol(3),1),$8e=al(ol(3),0),E8e=al(ol(3),.5),O8e=al(ol(4),1),R8e=al(ol(4),0),I8e=al(ol(4),.5),D8e={linear:g8e,"in-quad":iO,"out-quad":tN,"in-out-quad":y8e,"in-coast-quad":S8e,"out-coast-quad":T8e,"in-out-coast-quad":Noe,"in-cubic":iN,"out-cubic":Doe,"in-out-cubic":Foe,"in-coast-cubic":C8e,"out-coast-cubic":M8e,"in-out-coast-cubic":P8e,"in-quart":rN,"out-quart":Loe,"in-out-quart":v8e,"in-coast-quart":A8e,"out-coast-quart":$8e,"in-out-coast-quart":E8e,"in-quint":sN,"out-quint":koe,"in-out-quint":_8e,"in-coast-quint":O8e,"out-coast-quint":R8e,"in-out-coast-quint":I8e,"in-sine":nN,"out-sine":zoe,"in-out-sine":b8e,"in-expo":oN,"out-expo":vT,"in-out-expo":w8e,"in-circ":aN,"out-circ":Voe,"in-out-circ":x8e};function Hi(t,e,i=z8e,r=e){let s=!1;r!==e&&r.copyFrom(e),r.computeUp(t.state.viewingMode);for(let a=0;a<V8e;a++){let l=0;for(const c of k8e)if(dT(i.selection,c.type)){const h=Math.abs(c.error(t,r,i));c.apply(t,r,i)&&(s=!0,l+=h)}if(l===0)break}const n=dT(i.selection,8),o=F8e(i.interactionType,t);return n&&pb(t,r,o)&&(s=!0),s&&r.computeUp(t.state.viewingMode),s}function F8e(t,e){switch(t){case 4:return 1;case 5:return e.state.isGlobal?2:1;default:return 0}}function Ac(t,e){const i=typeof t=="number"?t:H_(t,e),r=Math.min(1,i/150);return Foe(r)}function L8e(t,e,i){return KV(t,e,i)*e.distance}const k8e=[{type:1,error:L8e,apply:Ooe},{type:2,error:jV,apply:Aze},{type:4,error:GV,apply:kze}],z8e={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},V8e=5,da=$(),Ro=$(),om=$(),Ks=$(),A0=$(),N8e=$(),pa={upward:De(0,0,1),forward:De(0,1,0),sideway:De(1,0,0)},Uoe=Ai();class joe{constructor(e=1){this.viewingMode=e,this.center=$(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=br(pa.forward)}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,i){if(i||(i={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===1){const n=(Te(this.center)+Te(e.center))/2;i.pan=KF(this.center,e.center)*n}else i.pan=qt(this.center,e.center);let r=Math.abs(e.yaw-this.yaw);r>=Math.PI&&(r=2*Math.PI-r);const s=Math.abs(e.pitch-this.pitch);return i.rotate=Math.max(r,s),i.sourceZoom=this.distance,i.targetZoom=e.distance,i}interpolate(e,i,r){this.viewingMode===1?Gbe(e.center,i.center,r.pan,this.center):jr(this.center,e.center,i.center,r.pan),this.distance=Et(e.distance,i.distance,r.zoom),this.pitch=Et(e.pitch,i.pitch,r.rotate);let s=e.yaw;const n=i.yaw;Math.abs(n-s)>=Math.PI&&(s+=2*(s<n?1:-1)*Math.PI),this.yaw=Et(s,n,r.rotate)}copyFrom(e){re(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,re(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const i=this._lookAtOrientation(e.center,Uoe);re(this.center,e.center),ue(Ks,e.center,e.eye),fo(Ks,Ks,i),fo(A0,e.up,i),this.distance=Te(Ks),Ks[0]/=this.distance,Ks[1]/=this.distance,Ks[2]/=this.distance,this.pitch=this._eyeUpToPitch(Ks),this.yaw=this._eyeUpToYaw(Ks,A0),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const i=this._lookAtOrientation(this.center,Uoe);el(i,i),this._axisAngleVec3(pa.sideway,this.pitch-Math.PI/2,pa.forward,Ks),this._axisAngleVec3(pa.upward,this.yaw,Ks),this._axisAngleVec3(pa.sideway,this.pitch-Math.PI/2,pa.upward,A0),this._axisAngleVec3(pa.upward,this.yaw,A0),se(Ks,Ks,this.distance),fo(Ks,Ks,i),fo(A0,A0,i),e.center=this.center,e.eye=ue(Ks,this.center,Ks),e.up=A0}_axisAngleVec3(e,i,r,s=r){const n=Math.cos(i),o=Math.sin(i);return se(da,r,n),Ye(Ro,e,r),se(Ro,Ro,o),se(om,e,(1-n)*ye(e,r)),de(s,de(s,da,Ro),om)}_lookAtOrientation(e,i=Ai()){return this._upAtLookAt(e,om),Ye(da,this.lookAtDirection,om),_e(da,da),da[0]===0&&da[1]===0&&da[2]===0&&re(da,pa.sideway),Ye(Ro,om,da),_e(Ro,Ro),i[0]=da[0],i[1]=Ro[0],i[2]=om[0],i[3]=da[1],i[4]=Ro[1],i[5]=om[1],i[6]=da[2],i[7]=Ro[2],i[8]=om[2],i}_upAtLookAt(e,i){return this.viewingMode===2?re(i,pa.upward):_e(i,e)}_eyeUpToPitch(e){return Math.PI-KF(pa.upward,e)}_eyeUpToYaw(e,i){const r=N8e;return Math.abs(i[2])<.5?(re(r,i),e[2]>0&&se(r,r,-1)):re(r,e),Ye(Ro,r,pa.upward),_e(Ro,Ro),KF(pa.sideway,Ro,pa.upward)}}function lN(t){return t?{ray:vs(t.ray),c0:t.c0,c1:t.c1}:{ray:vs(),c0:0,c1:Number.MAX_VALUE}}function U8e(t,e=lN()){return YP(t,e.ray),e.c0=0,e.c1=Number.MAX_VALUE,e}function j8e(t,e,i=lN()){const r=Te(t.vector);return tQ(t.origin,e,i.ray),i.c0=0,i.c1=r,i}new Yh(()=>({c0:0,c1:0,ray:null}));function mb(t){return t?[Mt(t[0]),Mt(t[1]),Mt(t[2]),Mt(t[3]),Mt(t[4]),Mt(t[5])]:[Mt(),Mt(),Mt(),Mt(),Mt(),Mt()]}function Boe(){return[$(),$(),$(),$(),$(),$(),$(),$()]}function rO(t,e=mb()){for(let i=0;i<6;i++)tA(t[i],e[i])}function Goe(t,e,i,r=Z8e){const s=wi(C6.get(),e,t);Fi(s,s);for(let n=0;n<8;++n){const o=Va(T6.get(),W8e[n],s);ne(r[n],o[0]/o[3],o[1]/o[3],o[2]/o[3])}qoe(i,r)}function qoe(t,e){Us(e[4],e[0],e[3],t[0]),Us(e[1],e[5],e[6],t[1]),Us(e[4],e[5],e[1],t[2]),Us(e[3],e[2],e[6],t[3]),Us(e[0],e[1],e[2],t[4]),Us(e[5],e[4],e[7],t[5])}function am(t,e){for(let i=0;i<6;i++){const r=t[i];if(r[0]*e[0]+r[1]*e[1]+r[2]*e[2]+r[3]>=e[3])return!1}return!0}function B8e(t,e){return Woe(t,U8e(e,Zoe.get()))}function G8e(t,e,i){return Woe(t,j8e(e,i,Zoe.get()))}function Hoe(t,e){for(let i=0;i<6;i++)if(hi(t[i],e)>0)return!1;return!0}function q8e(t,e){for(let i=0;i<6;i++)if(hTe(t[i],e))return!1;return!0}function Woe(t,e){for(let i=0;i<6;i++)if(!dTe(t[i],e))return!1;return!0}const H8e={bottom:[5,1,0,4],near:[0,1,2,3],far:[5,4,7,6],right:[1,5,6,2],left:[4,0,3,7],top:[7,3,2,6]},W8e=[Bt(-1,-1,-1,1),Bt(1,-1,-1,1),Bt(1,1,-1,1),Bt(-1,1,-1,1),Bt(-1,-1,1,1),Bt(1,-1,1,1),Bt(1,1,1,1),Bt(-1,1,1,1)],Zoe=new Yh(lN),Z8e=Boe(),J8e=le.getLogger("esri.views.3d.webgl-engine.lib.Camera");class Zt{constructor(e=null,i=null,r=null){this._viewUp=$(),this._viewForward=$(),this._viewRight=$(),this._ray=vs(),this._viewport=Bt(0,0,1,1),this._padding=Bt(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Qt(1,1e3),this._viewDirty=!0,this._viewMatrix=be(),this._projectionDirty=!0,this._projectionMatrix=be(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=be(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=be(),this._frustumDirty=!0,this._frustum=mb(),this._fullViewport=Ot(),this.pixelRatio=1,this.relativeElevation=0,_(e)&&re(this._ray.origin,e),this._center=_(i)?br(i):$(),this._up=_(r)?br(r):De(0,0,1)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center)}get ray(){return ue(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){ji(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){this._padding[0]===e[0]&&this._padding[1]===e[1]&&this._padding[2]===e[2]&&this._padding[3]===e[3]||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),Ln(this._padding,e),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&(wi(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const e=this.width,i=this.height,r=this.near*Math.tan(this.fovY/2),s=r*this.aspect;aJ(this._projectionMatrix,-s*(1+2*this._padding[3]/e),s*(1+2*this._padding[1]/e),-r*(1+2*this._padding[2]/i),r*(1+2*this._padding[0]/i),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(e){ji(this._projectionMatrix,e),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(e){this._fov=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return kke(this._fov,this.width,this.height)}set fovX(e){this._fov=Fke(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return zke(this._fov,this.width,this.height)}set fovY(e){this._fov=Lke(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return qt(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Fi(this._viewInverseTransposeMatrix,this.viewMatrix),Nn(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const i=2*e-1;return 2*this.near*this.far/(this.far+this.near-i*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){re(this._ray.origin,e.eye),re(this._center,e.center),re(this._up,e.up),Ln(this._viewport,e.viewport),Ln(this._padding,e.padding),os(this._nearFar,e.nearFar),this._fov=e.fov,this.relativeElevation=e.relativeElevation;const i=e;return this._viewDirty=i._viewDirty,this._viewDirty||(ji(this._viewMatrix,e.viewMatrix),re(this._viewRight,e.viewRight),re(this._viewUp,e.viewUp),re(this._viewForward,e.viewForward)),i._projectionDirty?this._projectionDirty=!0:(ji(this._projectionMatrix,e.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=i._frustumDirty,this._frustumDirty||(rO(e.frustum,this._frustum),this._frustumDirty=!1),i._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(ji(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Ln(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return new Zt().copyFrom(this)}equals(e){return mo(this.eye,e.eye)&&mo(this._center,e.center)&&mo(this._up,e.up)&&Pg(this._viewport,e.viewport)&&Pg(this._padding,e.padding)&&Rse(this._nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}almostEquals(e){if(this.pixelRatio!==e.pixelRatio||Math.abs(e.fov-this._fov)>=.001)return!1;const i=5e-4,r=1-1e-10;eu(en,e.eye,e.center),eu(cN,this.eye,this._center);const s=ye(en,cN),n=AF(en),o=AF(cN);return s*s>=r*n*o&&MF(e.eye,this.eye)<Math.max(n,o)*i*i&&OM(e.padding,this._padding)<.5&&OM(e.viewport,this._viewport)<.5}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(e))}viewDirectionDistance(e){return Math.abs(y2(this.viewForward,ue(en,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,i){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(i||1)))}getScreenCenter(e=Ii()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,i=.5,r=.5){return e[0]=this.padding[3]+this.width*i,e[1]=this.padding[2]+this.height*r,e[2]=.5,e}setGLViewport(e){const i=this.viewport,r=this.padding;e.setViewport(i[0]-r[3],i[1]-r[2],i[2]+r[1]+r[3],i[3]+r[0]+r[2])}applyProjection(e,i,r=!1){e!==At&&re(At,e),At[3]=1,r&&(i[2]=-At[2]),Va(At,At,this.projectionMatrix),se(At,At,1/Math.abs(At[3]));const s=this.fullViewport;return i[0]=Et(0,s[0]+s[2],.5+.5*At[0]),i[1]=Et(0,s[1]+s[3],.5+.5*At[1]),r||(i[2]=.5*(At[2]+1)),i}projectToScreen(e,i){this.projectToRenderScreen(e,uN),this.renderToScreen(uN,i)}projectToRenderScreen(e,i){if(At[0]=e[0],At[1]=e[1],At[2]=e[2],At[3]=1,Va(At,At,this.viewProjectionMatrix),At[3]===0)return null;se(At,At,1/Math.abs(At[3]));const r=this.fullViewport;return"x"in i?(i.x=Et(0,r[0]+r[2],.5+.5*At[0]),i.y=Et(0,r[1]+r[3],.5+.5*At[1])):(i[0]=Et(0,r[0]+r[2],.5+.5*At[0]),i[1]=Et(0,r[1]+r[3],.5+.5*At[1]),i.length>2&&(i[2]=.5*(At[2]+1))),i}unprojectFromScreen(e,i){return this.unprojectFromRenderScreen(this.screenToRender(e,uN),i)}unprojectFromRenderScreen(e,i){if(wi(sO,this.projectionMatrix,this.viewMatrix),!Fi(sO,sO))return null;const r=this.fullViewport;return At[0]=2*(e[0]-r[0])/r[2]-1,At[1]=2*(e[1]-r[1])/r[3]-1,At[2]=2*e[2]-1,At[3]=1,Va(At,At,sO),At[3]===0?null:(i[0]=At[0]/At[3],i[1]=At[1]/At[3],i[2]=At[2]/At[3],i)}constrainWindowSize(e,i,r,s=r){const n=e*this.pixelRatio,o=i*this.pixelRatio,a=Math.max(n-r/2,0),l=Math.max(this.fullHeight-o-s/2,0),c=-Math.min(n-r/2,0),h=-Math.min(this.fullHeight-o-s/2,0);return[a,l,r-c- -Math.min(this.fullWidth-n-r/2,0),s-h- -Math.min(o-s/2,0)]}computeUp(e){e===1?this.computeUpGlobal():this.computeUpLocal()}screenToRender(e,i){const r=e[0]*this.pixelRatio,s=this.fullHeight-e[1]*this.pixelRatio;return i[0]=r,i[1]=s,i}renderToScreen(e,i){const r=e[0]/this.pixelRatio,s=(this.fullHeight-e[1])/this.pixelRatio;i[0]=r,i[1]=s}computeUpGlobal(){ue(en,this.center,this.eye);const e=Te(this.center);e<1?(ne(this._up,0,0,1),this._markViewDirty()):Math.abs(ye(en,this.center))>.9999*Te(en)*e||(Ye(this._up,en,this.center),Ye(this._up,this._up,en),_e(this._up,this._up),this._markViewDirty())}computeUpLocal(){Lh(en,this.eye,this.center),Math.abs(en[2])<=.9999&&(se(en,en,en[2]),ne(this._up,-en[0],-en[1],1-en[2]),_e(this._up,this._up),this._markViewDirty())}_compareAndSetView(e,i){typeof e[0]=="number"&&isFinite(e[0])&&typeof e[1]=="number"&&isFinite(e[1])&&typeof e[2]=="number"&&isFinite(e[2])?mo(e,i)||(re(i,e),this._markViewDirty()):J8e.warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Goe(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(VP(this._viewMatrix,this.eye,this._center,this._up),ne(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),ne(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),ne(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const At=Ot(),sO=be(),en=$(),cN=$(),uN=ys(),nO={desiredScreenFlow:2,minDuration:Ft(500),maxDuration:Ft(8e3)};class hN{constructor(e){this.createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:nO.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new hN(this.createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,i,r){this.source!==e&&this.source.copyFrom(e),this.target!==i&&this.target.copyFrom(i),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=r.desiredScreenFlow!=null?r.desiredScreenFlow:nO.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const i=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/i}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}class Q8e{constructor(){this.segments=[]}get time(){return this.segments.reduce((e,i)=>Ll(e+i.time),Ll(0))}interpolateComponentsAt(e,i){e=Math.min(Math.max(e,0),1),e*=this.time;let r=0,s=0;const n=this.definition;for(let o=0;o<this.segments.length;o++){const a=this.segments[o],l=a.definition;if(e<=a.time||o===this.segments.length-1){i=this.segmentInterpolateComponentsAt(a,e/a.time,i),n.hasPan?i.pan=(r+l.compared.pan*i.pan)/n.compared.pan:i.pan=1,n.hasRotate?i.rotate=(s+l.compared.rotate*i.rotate)/n.compared.rotate:i.rotate=1;const c=i.zoom*(l.compared.targetZoom-l.compared.sourceZoom)+l.compared.sourceZoom,h=this.segments[0].definition.compared.sourceZoom,p=this.segments[this.segments.length-1].definition.compared.targetZoom;return n.hasZoom?i.zoom=(c-h)/(p-h):i.zoom=1,i}e-=a.time,r+=l.compared.pan,s+=l.compared.rotate}}segmentInterpolateComponentsAt(e,i,r){return e.interpolateComponentsAt(i,r)}}class dN{constructor(e){e&&this.update(e)}get time(){return this._time}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,i=e.compared,r=i.sourceZoom,s=i.targetZoom;this._zoomSign=r>s?1:-1,this._panPixelsAtSource=i.pan*e.source.pixelsPerPanAtZoom(r);const n=(e.source.pixelsPerRotateAtZoom(r)+e.target.pixelsPerRotateAtZoom(s))/2;this._rotatePixels=i.rotate*n}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom,{hasZoom:r,hasPan:s,hasRotate:n}=this.definition;let o=0,a=0;r&&(s&&(o=(i/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(a=this._zoomSign*(Math.log(e/i)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(r&&s&&n){const c=o+a+o*a;this._zoomPixelFlow=o*a/c*l,this._panPixelFlow=a/c*l,this._rotatePixelFlow=o/c*l}else if(r&&s){const c=1+o;this._zoomPixelFlow=o/c*l,this._panPixelFlow=1/c*l}else if(r&&n){const c=1+a;this._zoomPixelFlow=a/c*l,this._rotatePixelFlow=1/c*l}else if(s&&n){const c=this._panPixelsAtSource/this._rotatePixels,h=1+c;this._panPixelFlow=c/h*l,this._rotatePixelFlow=1/h*l}else s?this._panPixelFlow=l:r?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);this._time=n?this.rotateTime:r?this.zoomTime:s?this.panTime:Ll(0)}get rotateTime(){return this.definition.hasRotate?Ll(this._rotatePixels/this._rotatePixelFlow):Ll(0)}get zoomTime(){return this.definition.hasZoom?Ll(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):Ll(0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,i=e*this._panPixelsAtSource;return Ll(Math.log(i*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return Ll(this._panPixelsAtSource/this._panPixelFlow)}return Ll(0)}_interpolateComponentsZoom(e){if(e===0||e===1)return e;if(this.definition.hasZoom){const i=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom;return(i*(i/r)**-e-i)/(r-i)}return e}_interpolateComponentsPan(e){if(e===0||e===1)return e;if(this.definition.hasPan&&this.definition.hasZoom){const i=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(i*e*this._time)-1))/(i*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,i){e=Math.min(Math.max(e,0),1);const r=this._interpolateComponentsZoom(e),s=this._interpolateComponentsPan(e),n=this._interpolateComponentsRotate(e);return i?(i.zoom=r,i.pan=s,i.rotate=n):i={zoom:r,pan:s,rotate:n},i}}function Y8e(t,e,i){const r=e-t.compared.sourceZoom,s=t.halfWindowPanAtZoom(r);return-t.halfWindowSize*(i.ascensionFactor*Math.LN2*t.compared.pan+s)*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2*s)}function X8e(t,e,i){const r=1/e,s=Math.log(t.compared.sourceZoom*r),n=1/t.desiredPixelFlow,o=1/Math.LN2,a=e-t.compared.sourceZoom,l=1/a,c=(i.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(a))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*r*n*o*l*c-t.halfWindowSize*s*n*o*l+t.halfWindowSize*s*n*o*c/(a*a)}function K8e(t,e,i){const r=e-t.compared.sourceZoom,s=1/r,n=1/e,o=Math.log(t.compared.sourceZoom*n),a=(i.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(r))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*s*(-2*s*n*a+2*s*o+2*n-2*o*a/(r*r)-a/(e*e))/(t.desiredPixelFlow*Math.LN2)}function e9e(t,e){return-t.halfWindowSize*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2)}function t9e(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function i9e(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}function r9e(t,e,i){return-t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e))}function s9e(t,e,i){return t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e))}function n9e(t,e,i){return-2*t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e*e))}function o9e(t,e,i){return t.halfWindowSize*(-t.halfWindowPanAtZoom(e)-i.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*t.halfWindowPanAtZoom(-e+t.compared.targetZoom))}function a9e(t,e,i){const r=Math.log(e/t.compared.targetZoom),s=1/t.desiredPixelFlow,n=1/Math.LN2,o=-e+t.compared.targetZoom,a=1/o,l=(-t.halfWindowPanAtZoom(e)-i.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return-t.halfWindowSize*r*s*n*a+t.halfWindowSize*r*s*n*l/(o*o)+t.halfWindowSize*s*n*a*l/e}function l9e(t,e,i){const r=e-t.compared.targetZoom,s=1/r,n=1/e,o=Math.log(e/t.compared.targetZoom),a=(t.halfWindowPanAtZoom(e)+i.descensionFactor*Math.LN2*t.compared.pan-t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*s*(-2*s*n*a-2*s*o+2*n+2*o*a/(r*r)-a/(e*e))/(t.desiredPixelFlow*Math.LN2)}function c9e(t,e){return t.halfWindowSize*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2)}function u9e(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function h9e(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}function d9e(t){const e=Math.LN2*t.compared.pan,i=t.compared.sourceZoom-t.compared.targetZoom,r=t.halfWindowPanAtZoom(i),s=t.halfWindowSize*Math.log(t.compared.sourceZoom/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*r);return t.compared.sourceZoom<=t.compared.targetZoom?s*(e-r):s*(e+r)}function p9e(t,e){let i=f9e(t,e);const r={ascensionFactor:e.ascensionFactor!=null?e.ascensionFactor:.5,descensionFactor:e.descensionFactor!=null?e.descensionFactor:.5},s=r.ascensionFactor===0,n=r.descensionFactor===0,o=s?e9e:Y8e,a=s?t9e:X8e,l=s?i9e:K8e,c=n?c9e:o9e,h=n?u9e:a9e,p=n?h9e:l9e,f=C=>o(t,C,r)+r9e(t,C,r)+c(t,C,r),g=C=>a(t,C,r)+s9e(t,C,r)+h(t,C,r),y=C=>l(t,C,r)+n9e(t,C,r)+p(t,C,r);let v=f(i);const b=d9e(t);let w;const S=e.maximumIterations||20,T=e.maximumDistance!=null?e.maximumDistance:1/0;for(w=0;w<S;w++){const C=1e-6,M=(g(i)+C)/y(i);if(isNaN(M)||i>=T&&M<0){if(!isFinite(T))return null;i=T,v=f(i);break}if(i-=M,i<t.compared.sourceZoom||i<t.compared.targetZoom)return null;const P=f(i);if(Math.abs(P-v)/v<=.005)break;v=P}return v>b*(1-.3)||i<t.compared.sourceZoom||i<t.compared.targetZoom?null:i}function f9e(t,e){const i=Math.max(t.compared.sourceZoom,t.compared.targetZoom),r=t.source.zoomAtPixelsPerPan(t.desiredPixelFlow/t.compared.pan)/2;return r<i?e.maximumDistance!=null?i+(e.maximumDistance-i)/2:1.5*i:e.maximumDistance?Math.min(e.maximumDistance,r):r}class m9e extends Q8e{constructor(e,i){super(),this._preallocSegments=[new dN,new dN,new dN],this.update(e,i)}update(e,i){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let r=null;i&&i.apex&&(r=p9e(e,i.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,r==null?this._updateWithoutApex():this._updateWithApex(r,i.apex)}segmentInterpolateComponentsAt(e,i,r){return r=e.interpolateComponentsAt(i,r),e===this._ascensionSegment?r.zoom=tN(r.zoom):e===this._descensionSegment&&(r.zoom=iO(r.zoom)),r}_updateWithApex(e,i){const[r,s,n]=this._preallocSegments,o=i.ascensionFactor!=null?i.ascensionFactor:.5,a=Math.min(1-o,i.ascensionFactor!=null?i.descensionFactor:.5),l=1-o-a;r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.update(),this._ascensionSegment=r,this.segments.push(r),l>0&&(s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.copyFrom(this.definition),s.definition.compared.sourceZoom=e,s.definition.compared.targetZoom=e,s.definition.compared.pan=this.definition.compared.pan*l,s.definition.compared.rotate=this.definition.compared.rotate*l,s.update(),this.segments.push(s)),n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.sourceZoom=e,n.definition.compared.pan=this.definition.compared.pan*a,n.definition.compared.rotate=this.definition.compared.rotate*a,n.update(),this._descensionSegment=n,this.segments.push(n)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}const g9e={zoom:0,pan:0,rotate:0};class y9e{constructor(e){this.createCamera=e,this._time=Ft(0),this.definition=new hN(e),this.path=new m9e}get time(){return this._time}update(e,i,r){this.definition.update(e,i,r),this.path.update(this.definition,r),this._time=this._applyTimeSettings(vG(this.path.time),r),this._easing=r.easing?r.easing:this._time>=1e3?Noe:vT}cameraAt(e,i){i=i||this.createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const r=this.path.interpolateComponentsAt(e,g9e);return i.interpolate(this.definition.source,this.definition.target,r),i}_normalizedEasing(e){const i=this._easing(0,this._time),r=this._easing(1,this._time);return(this._easing(e,this._time)-i)/(r-i)}_applyTimeSettings(e,i){const r=i.speedFactor!=null?i.speedFactor:1;i.duration!=null?e=i.duration:i.speedFactor!=null&&(e=Ft(e/r));const s=i.minDuration!=null?i.minDuration:nO.minDuration/r,n=i.maxDuration!=null?i.maxDuration:nO.maxDuration/r;return Ft(Math.min(Math.max(s,e),n))}}const v9e=$();class _9e{constructor(e){this.currentTime=Ft(0),this._animation=new y9e(()=>new joe(e)),this._current=new joe(e)}get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}update(e,i,r){const s=this._animation.definition.source,n=this._animation.definition.target,o=ue(v9e,i.center,e.center),a=Te(o);a>=1e-5?(o[0]/=a,o[1]/=a,o[2]/=a):(o[0]=0,o[1]=1,o[0]=0),re(s.lookAtDirection,o),re(n.lookAtDirection,o),s.copyFromRenderCamera(e),n.copyFromRenderCamera(i),this._current.copyFrom(s),this._animation.update(s,n,r),this.currentTime=Ft(0),e.almostEquals(i)&&(this.currentTime=this._animation.time)}cameraAt(e,i){return this._animation.cameraAt(e,this._current),i=i||new Zt,this._current.copyToRenderCamera(i),i}step(e,i){return this.finished||(this.currentTime=Ft(this.currentTime+vG(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,i)}}var Ti;(function(t){t.Ready="ready",t.Rejected="rejected",t.Running="running",t.Stopped="stopped",t.Finished="finished"})(Ti||(Ti={}));let $0=class extends ve{constructor(){super(...arguments),this.state=Ti.Ready}get active(){return this.state===Ti.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=Ti.Stopped,!0)}finishController(){this.state=Ti.Finished}get steppingFinished(){return!1}};u([d({readOnly:!0})],$0.prototype,"active",null),u([d()],$0.prototype,"state",void 0),$0=u([R("esri.views.3d.state.controllers.CameraController")],$0);let _T=class extends $0{get canStop(){return!0}set asyncResult(t){this._asyncResult&&(this._asyncResult.reject($t()),this._asyncResult=null),this.state===Ti.Finished||this.state===Ti.Stopped?this.state===Ti.Finished?t.resolve():t.reject($t()):this._asyncResult=t}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=Ti.Running,_(this.viewAnimation)&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!_(this.viewAnimation)||this.state!==Ti.Ready&&this.state!==Ti.Running||(this.viewAnimation.state===j_.State.FINISHED?this.finish():this.viewAnimation.state===j_.State.STOPPED&&(this.state=Ti.Stopped))}onControllerEnd(){_(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===Ti.Finished?this.viewAnimation.finish():this.state===Ti.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===Ti.Finished?this._asyncResult.resolve():this._asyncResult.reject($t()))}finish(){this.finishController()}};_T=u([R("esri.views.3d.state.controllers.AnimationController")],_T);let Md=class extends _T{constructor(t){super(t),this.view=null,this.mode="interaction",this.hasTarget=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new _9e(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new j_}get isInteractive(){return this.mode==="interaction"}begin(t,e){this.hasTarget=!0;const i=this.animationSettings(e);oO.copyFrom(this.view.state.camera);const r=nl(this.view.state.viewingMode);this.intersectionHelper.intersectRay(oO.ray,r,Joe)&&(oO.center=Joe),this.animation.update(oO,t,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(t,e){this.hasTarget&&this.animation.step(t,e)}onControllerEnd(t){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,t),this.animation.currentTime=this.animation.time),super.onControllerEnd(t)}animationSettings(t={}){return he(E({apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0}},t),{easing:typeof t.easing=="string"?D8e[t.easing]:t.easing})}};u([d({constructOnly:!0})],Md.prototype,"view",void 0),u([d({constructOnly:!0})],Md.prototype,"mode",void 0),Md=u([R("esri.views.3d.state.controllers.PointToPointAnimationController")],Md);const oO=new Zt,Joe=$();function Qoe(t,e,i){return b9e(t,t.screenToRender(e,Bh(Me.get())),i)}function b9e(t,e,i){const r=Bh(os(Me.get(),e));if(r[2]=0,!t.unprojectFromRenderScreen(r,i.origin))return null;const s=Bh(os(Me.get(),e));s[2]=1;const n=t.unprojectFromRenderScreen(s,Me.get());return A(n)?null:(ue(i.direction,n,i.origin),i)}function gb(t,e,i){return pN(t,t.screenToRender(e,Bh(Me.get())),i)}function pN(t,e,i){re(i.origin,t.eye);const r=ne(Me.get(),e[0],e[1],1),s=t.unprojectFromRenderScreen(r,Me.get());return A(s)?null:(ue(i.direction,s,i.origin),i)}function fN(t,e,i,r){const s=gb(e,i,w9e);return mf(t,s,r)}const w9e=vs(),Yoe=30,aO=[1,3e8],Xoe=70;function E0(t,e,i){return i[0]=e[0]/(t.fullWidth/t.pixelRatio),i[1]=e[1]/(t.fullHeight/t.pixelRatio),i}function mN(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function lm(t,e,i){const r=C6.get();Di(r),Bi(r,r,i[3],fV(i)),ue(Jt,t.eye,e),Oe(Jt,Jt,r),t.eye=de(Jt,Jt,e),ue(Jt,t.center,e),Oe(Jt,Jt,r),t.center=de(Jt,Jt,e),t.up=Oe(Jt,t.up,r)}function x9e(t,e,i,r){return vy(t,Qoe(e,i,wN),r)}function gN(t,e,i,r){return vy(t,gb(e,i,wN),r)}function yN(t,e,i,r){const s=Me.get();let n=1-i;ue(s,e,t.eye);const o=Te(s);let a=o*(1-n);n>=0&&a<r&&(a=r,n=-(a-o)/o),Math.abs(o-a)<1e-6||(se(s,s,n),t.eye=de(Jt,t.eye,s),t.center=jr(Jt,t.center,e,n))}function Koe(t,e,i){e.getScreenCenter(eae),fN(t,e,eae,Jt)&&(e.center=Jt);const r=e.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const n=se(Me.get(),e.viewForward,s);e.eye=ue(Jt,e.center,n)}const eae=Ii();function vN(t,e){ne(e,0,0,0);for(const i of t)de(e,e,i);se(e,e,1/t.length)}function lO(t,e,i,r){return Math.sin(t/Te(e))*(i+r.radius)}function tae(t,e,i,r){return lO(Math.PI/2,e,i,r)+(t-Math.PI/2)}var as;(function(t){t[t.Vertical=0]="Vertical",t[t.Horizontal=1]="Horizontal"})(as||(as={}));const iae={Elevation:3e4,Angle:nt(6)},bT={Pole:.95,Angle:nt(18),Tilt:45},rae=nt(80);function sae(t,e,i,r,s){const n=$(),o=rs();let a=!0,l=!0;return t.intersectScreen(i,n)?o[3]=Te(n):(l=!1,e.aboveGround?o[3]=Math.max(Te(e.center),.9*s.radius):o[3]=Te(e.eye)-e.relativeElevation,r?wT(o,e,i,n):a=fN(o,e,i,n)),{sphere:o,scenePickPoint:a?n:null,hasGeometryIntersection:l}}function cO(t,e,i,r){return Te(t.eye)-r.radius>iae.Elevation?as.Horizontal:i?(gb(t,e,_ae),-Math.sign(t.relativeElevation)*(.5*Math.PI+P6(t.eye,_ae.direction))<iae.Angle?as.Vertical:as.Horizontal):as.Vertical}function nae(t,e,i){ue(_N,i,e),t.eye=ue(Jt,t.eye,_N),t.center=ue(Jt,t.center,_N)}const _N=$();function wT(t,e,i,r){const s=gb(e,i,wN);return!A(s)&&(L1(t,s,uO),mf(t,s,r)?!(cn(uO,s.origin)<cn(r,s.origin))||(re(r,uO),!1):(ue(yb,e.eye,e.center),_e(yb,yb),hQ(yb,-ye(_e(yb,yb),uO),oae),vy(oae,s,r),!1))}const uO=$(),yb=$(),oae=Mt();function aae(t,e,i,r,s,n){let o;if(Ye(gO,t,e),ue(fO,t,e),Te(t)<=s||!r.aboveGround){Ye(i,fO,r.eye);const a=ye(t,e)/(Te(t)*Te(e)),l=Math.cos(Re(Vp.normalize(nt(n)),0,rae));o=-ar(a)-Math.max(0,Te(e)-s)/(l*s)}else ue(lae,r.eye,r.center),Ye(i,fO,lae),o=-Te(fO)/s;return _e(i,i),se(i,i,Te(gO)),o}const lae=$();function cae(t,e,i,r){let s,n;const o=Math.cos(Re(Vp.normalize(nt(r)),0,rae));return s=e>i?-(e-i)/(o*i):e<-i?Math.PI-(e+i)/(o*i):ar(e/i),n=t>i?-(t-i)/(o*i):t<-i?Math.PI-(t+i)/(o*i):ar(t/i),(n-s)*i}function S9e(t,e,i,r,s,n,o,a,l,c){const h=cae(t[2],e[2],o[3],l),p=c?cae(t[0],e[0],o[3],180):e[0]-t[0],f=Math.sin(a)*p-Math.cos(a)*h,g=Math.cos(a)*p+Math.sin(a)*h;_e(Jt,s);const y=c?f/Math.sqrt(Math.abs(o[3]**2-ye(i,Jt)**2)):f/o[3],v=g/Math.sqrt(Math.abs(o[3]**2-ye(i,r)**2));si(n,y,v)}function uae(t,e,i,r,s,n,o,a,l,c){Ye(gO,t,e),q6(n.up,n.eye,hO,dO,pO),q6([0,0,1],n.eye,Pd,cm,fae),re(i,cm),re(r,Pd),_e(i,i),se(i,i,Te(gO)),EQ(t,_e(dO,dO),_e(pO,pO),_e(hO,hO),mae),EQ(e,dO,pO,hO,gae),S9e(mae,gae,t,Pd,cm,s,o,a,l,c)}function T9e(t,e,i,r,s,n,o){Di(um),Di(hm),Di(dm),Bi(um,um,s,r),Bi(hm,hm,o,n),wi(dm,um,hm),ue(e,t,i),Oe(e,e,dm),de(e,e,i)}function hae(t,e,i,r,s,n){Di(um),Di(hm),Di(dm),Bi(um,um,r,i),Bi(hm,hm,n,s),wi(dm,um,hm),ue(Jt,t.eye,e),Oe(Jt,Jt,dm),t.eye=de(Jt,Jt,e),ue(Jt,t.center,e),Oe(Jt,Jt,dm),t.center=de(Jt,Jt,e),ue(Jt,t.up,e),Oe(Jt,Jt,dm),t.up=de(Jt,Jt,e)}function bN(t,e,i,r,s,n,o=bT.Pole,a=bT.Angle){const l=Math.abs(r)>Math.PI-a||Math.abs(r)<a,c=Math.abs(t[2])<i*o||Math.abs(e)>i;return!!(l&&c&&n.aboveGround&&s<bT.Tilt)}function dae(t,e,i,r,s,n){if(n)WS(i,r,yae),lm(e,t,yae);else{const o=aae(i,r,vae,e,t[3],s);lm(e,t,HS(vae,o))}}function pae(t,e,i,r,s,n,o){const a=o?20:1,l=1e-12;let c,h;re(O0,r),mO.copyFrom(e);for(let p=0;p<a&&cn(i,O0)>l&&(c=cn(i,O0),uae(i,O0,cm,Pd,xT,mO,t,s,n,o),hae(mO,t,Pd,xT[1],cm,xT[0]),T9e(O0,O0,t,Pd,xT[1],cm,xT[0]),h=cn(i,O0),h<c||p===0);p++)e.copyFrom(mO)}function C9e(t,e,i,r,s,n,o){bN(i,ye(e.up,i),t[3],-Vp.normalize(nt(s)),n,e,bT.Pole,bT.Angle)?pae(t,e,i,r,-Vp.normalize(nt(s)),n,o):dae(t,e,i,r,n,o)}function M9e(t,e,i,r,s,n){const{eye:o}=t;q6([0,0,1],o,Pd,cm,fae);const a=e.translation[0]*i.pan,l=s.mode==="zoom"?0:e.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-ye(t.center,Pd)**2/Te(t.center)**2)),.5),h=(Math.sin(n)*l+Math.cos(n)*a)/c,p=-Math.cos(n)*l+Math.sin(n)*a;switch(Bi(r.pan.matrix,r.pan.matrix,h,Pd),r.pan.enabled=!0,s.mode){case"pan":Bi(r.pan.matrix,r.pan.matrix,p,cm),r.pan.enabled=!0;break;case"zoom":r.zoom=-e.translation[1]*i.zoom}}function P9e(t,e,i,r,s){const{eye:n,viewRight:o}=t,a=Ye(Me.get(),o,n),l=e.translation[0]*i.pan;switch(l!==0&&(Bi(r.pan.matrix,r.pan.matrix,-l,a),r.pan.enabled=!0),s.mode){case"pan":{const c=e.translation[1]*i.pan;c!==0&&(Bi(r.pan.matrix,r.pan.matrix,c,o),r.pan.enabled=!0);break}case"zoom":r.zoom=-e.translation[1]*i.zoom}}function A9e(t,e,i,r,s,n,o,a,l){bN(t.center,ye(t.up,t.center),Te(t.center),-Vp.normalize(nt(n)),o,e)?M9e(e,i,r,a,l,-Vp.normalize(nt(s))):P9e(e,i,r,a,l)}const Pd=$(),cm=$(),fae=$(),hO=$(),dO=$(),pO=$(),mae=$(),gae=$(),xT=ke(),yae=Q_(),um=be(),hm=be(),dm=be(),O0=$(),Jt=$(),fO=$(),mO=new Zt,gO=$(),vae=$(),wN={origin:$(),direction:$()},_ae={origin:$(),direction:$()},bae=.6,xN=4,$9e=12,E9e=60,O9e=20;let yO=class extends Md{constructor(){super(...arguments),this.zoomLocation=$(),this.tmpCamera=new Zt,this.tmpViewDir=$(),this.tmpRayDir={origin:$(),direction:$()},this.targetOnSphere=$(),this.tmpCenter=$(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:null,interactionStartCamera:new Zt,interactionDirection:null,tiltMode:0},this.sphere=rs()}initialize(){this.intersector=nl(this.view.state.viewingMode)}zoomStep(t,e){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r);let s=!1,n=!1;this.intersectionHelper.intersectScreen(e,this.zoomLocation)&&(s=t>0,n=!0),this.tmpCamera.copyFrom(i.camera),s?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:re(this.zoomLocation,this.tmpCamera.center),this.updateCamera(this.tmpCamera,t,this.zoomLocation,e,n),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:Ft(600),easing:vT}}updateCamera(t,e,i,r,s){const n=Ut(this.view.spatialReference);if(cO(t,r,s,n)===as.Horizontal||ae("disable-feature:context-navigation")){let o=bae**e;this.sphere[3]=Te(i),ue(this.tmpViewDir,t.center,t.eye);const a=Te(this.tmpViewDir);let l=a*o;if(o<=1&&l<xN&&(l=xN,o=l/a),Math.abs(a-l)<1e-6)return;const c=Te(t.center);if(this.sphere[3]!==c){const h=this.sphere[3]+o*(c-this.sphere[3]);t.center=se(vO,t.center,h/c)}se(this.tmpViewDir,this.tmpViewDir,-o),t.eye=de(vO,t.center,this.tmpViewDir),Hi(this.view,t,this.constraintOptions),cn(i,t.center)>1e-12&&fN(this.sphere,t,r,this.targetOnSphere)&&C9e(this.sphere,t,i,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let o=bae**Math.abs(e);const a=e>0?1:-1;let l;gb(t,r,this.tmpRayDir),_e(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(l=Math.abs(this.view.camera.position.z));let c=Math.max($9e*l,O9e);const h=this.view._stage.renderView.getMinimalDepthForArea(null,r[0],r[1],this.view.state.camera,E9e);c=c>h?h:c,se(this.tmpRayDir.direction,this.tmpRayDir.direction,c),de(i,this.tmpRayDir.origin,this.tmpRayDir.direction);let p=c*o;const f=Math.max(xN,1.01*t.nearFar[0]);if(e>0&&p<f&&(p=f,o=p/c),Math.abs(c-p)<1e-6)return;se(this.tmpRayDir.direction,this.tmpRayDir.direction,a*(1-o)),t.eye=de(vO,t.eye,this.tmpRayDir.direction),t.center=de(vO,t.center,this.tmpRayDir.direction)}pb(this.view,t)}};yO=u([R("esri.views.3d.state.controllers.global.ZoomStepController")],yO);const vO=$(),R9e=.6,I9e=4,D9e=60,F9e=14,L9e=20;let _O=class extends Md{constructor(){super(...arguments),this.zoomLocation=$(),this.tmpCamera=new Zt,this.tmpRayDir=$(),this.tmpCenter=$(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:null,interactionStartCamera:new Zt,interactionDirection:null,tiltMode:0}}zoomStep(t,e){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r),this.tmpCamera.copyFrom(i.camera);const s=nl(this.view.state.viewingMode);t>0?(this.intersectionHelper.intersectScreenFreePointFallback(e,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:re(this.zoomLocation,this.tmpCamera.center);const n=R9e**t;if(!w8()){let o=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),e[0],e[1],this.view.state.camera,D9e);const a=Math.max(F9e*Math.abs(this.view.camera.position.z),L9e);if(o=o?Math.min(o,a):a,o){const l=$();ue(l,this.zoomLocation,this.tmpCamera.eye),o<Te(l)&&(_e(l,l),de(this.zoomLocation,this.tmpCamera.eye,se(l,l,o)))}}this.updateCamera(this.tmpCamera,n,this.zoomLocation),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:Ft(600),easing:vT}}updateCamera(t,e,i){ue(this.tmpRayDir,i,t.eye);const r=Te(this.tmpRayDir);let s=r*e;const n=e<=1,o=Math.max(I9e,1.01*t.nearFar[0]);n&&s<o&&(s=o,e=s/r),Math.abs(r-s)<1e-6||(se(this.tmpRayDir,this.tmpRayDir,e),t.eye=ue(wae,i,this.tmpRayDir),t.center=jr(wae,t.center,i,1-e),Hi(this.view,t,this.constraintOptions))}};_O=u([R("esri.views.3d.state.controllers.local.ZoomStepController")],_O);const wae=$();function k9e(t,e){switch(e){case"primary":return t.pointerType==="touch"||t.button===0;case"secondary":return t.pointerType!=="touch"&&t.button===2;case"tertiary":return t.pointerType!=="touch"&&t.button===1}}function SN(t,e){if(t.pointerType==="touch")return!1;switch(e){case"primary":return t.button===0;case"secondary":return t.button===2;case"tertiary":return t.button===1}}class z9e extends bs{constructor(e,i){super(!0),this.view=e,this.registerIncoming("double-click",i,r=>this.handleDoubleClick(r))}handleDoubleClick(e){const i=e.data;if(k9e(i,"primary")){const r=this.view.state.isGlobal?new yO({view:this.view,mode:"animation"}):new _O({view:this.view,mode:"animation"});this.view.state.switchCameraController(r),r.zoomStep(Math.log(.5)/Math.log(.6),Ii(i.x,i.y)),e.stopPropagation()}}}let pm=class extends $0{constructor(){super(...arguments),this.startCamera=new Zt,this.currentCamera=new Zt}get isInteractive(){return!0}stepController(t,e){e.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(e)}onControllerStart(t){this.state=Ti.Running,this.startCamera.copyFrom(t),this.currentCamera.copyFrom(t)}onControllerEnd(t){t.copyViewFrom(this.currentCamera)}};pm=u([R("esri.views.3d.state.controllers.InteractiveController")],pm);const V9e=7,TN=90;let vb=class extends pm{constructor(t){super(t),this.view=null,this.pivot=0,this.lastPoint=ke(),this.tmpWorldUp=$(),this.tmpViewDir=$(),this.tmpRotCurPoint=ke(),this.tmpTransf=be(),this.tmpAxis=$(),this.tmpPivotPoint=$(),this.pivotPos=$(),this.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale=this.pivot===0?3:1.5}begin(t){if(this.active){switch(this.pivot){case 1:re(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case 0:this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos)||re(this.pivotPos,this.startCamera.center),ae("disable-feature:context-navigation")||this.constrainPivotPoint(t),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11}this.constraintOptions.interactionStartCamera=this.startCamera,E0(this.startCamera,t,this.lastPoint)}}constrainPivotPoint(t){const e=this.startCamera,i=$();ue(i,this.pivotPos,e.eye);let r=Te(i);this.view.camera.position.hasZ&&(r=Math.min(r,V9e*Math.abs(this.view.camera.position.z)));const s=Ut(this.view.spatialReference),n=Ii(e.width/e.pixelRatio*.5,e.height/e.pixelRatio*.5),o=cO(this.startCamera,n,!0,s);let a=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,2.5*TN,TN),l=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),t[0],t[1],e,TN);a===void 0&&l===void 0||(a=a===void 0?l:a,l=l===void 0||o===as.Horizontal?a:l,r=a>l?l:a),_e(i,i),re(this.pivotPos,de(this.tmpPivotPoint,e.eye,se(this.tmpPivotPoint,i,r)))}update(t){if(this.active){switch(this.pivot){case 1:this.currentCamera.center=this.applyRotation(this.currentCamera,t,this.currentCamera.center,this.pivotPos);break;case 0:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this.applyRotation(this.currentCamera,t,this.currentCamera.eye,this.pivotPos)}Hi(this.view,this.currentCamera,this.constraintOptions)}}end(){this.active&&this.finishController()}applyRotation(t,e,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this.tmpWorldUp),E0(t,e,this.tmpRotCurPoint);let s=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,n=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;ue(this.tmpViewDir,i,r);const o=Te(this.tmpViewDir),a=ar(ye(this.tmpViewDir,this.tmpWorldUp)/o);if(this.pivot===1){s*=-.5;const l=.5*Math.PI-a,c=.5*Math.PI*.99;s=l-Math.max(-c,Math.min(c,l+s))}return s=Re(s+a,ws.min,ws.max)-a,Di(this.tmpTransf),Ye(this.tmpAxis,t.up,this.tmpViewDir),this.pivot===0&&(n=-n),Bi(this.tmpTransf,this.tmpTransf,n,this.tmpWorldUp),Bi(this.tmpTransf,this.tmpTransf,s,this.tmpAxis),Oe(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),t.up=Oe(CN,t.up,this.tmpTransf),de(CN,r,this.tmpViewDir),os(this.lastPoint,this.tmpRotCurPoint),CN}};u([d({constructOnly:!0})],vb.prototype,"view",void 0),u([d()],vb.prototype,"pivot",void 0),vb=u([R("esri.views.3d.state.controllers.RotateController")],vb);const CN=$();class MN extends bs{constructor(e,i,r,s){super(!0),this.view=e,this.pointerAction=i,this.pivot=r,this.registerIncoming("drag",s,n=>this.handleDrag(n))}handleDrag(e){const i=e.data;if(i.pointers.size>1||!SN(e.data,this.pointerAction))return;const r=Ii(i.center.x,i.center.y);switch(i.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new vb({view:this.view,pivot:this.pivot}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(r);break;case"update":this.cameraController&&this.cameraController.update(r);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}let bO=class extends pm{constructor(t){super(t),this.view=null,this.pickPoint=$(),this.tmpP0=ke(),this.panAxisAngle=Q_(),this.tmpRayDir=$(),this.targetOnSphere=$(),this.tmpRay={origin:$(),direction:$()},this.dragBeginPoint=Ii(),this.normalizedAnchorPoint=ke(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},this.sphere=rs(),this.hasPickPoint=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;os(this.dragBeginPoint,t),E0(this.startCamera,t,this.normalizedAnchorPoint);const e=Ut(this.view.spatialReference),i=sae(this.intersectionHelper,this.startCamera,t,!1,e);if(this.navMode=cO(this.startCamera,t,i.hasGeometryIntersection,e),this.navMode===as.Horizontal||ae("disable-feature:context-navigation"))this.hasPickPoint=!!i.scenePickPoint,this.pickPoint=i.scenePickPoint,this.sphere=i.sphere;else{let r;gb(this.startCamera,t,this.tmpRay),_e(this.tmpRay.direction,this.tmpRay.direction),this.view.camera.position.hasZ&&(r=Math.abs(this.view.camera.position.z));let s=Re(Yoe*r,aO[0],aO[1]);const n=this.view._stage.renderView.getMinimalDepthForArea(null,t[0],t[1],this.view.state.camera,Xoe);s=s>n?n:s,this.hasPickPoint=!0,se(this.tmpRay.direction,this.tmpRay.direction,s),de(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction)}this.constraintOptions.interactionStartCamera=this.startCamera}update(t){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this.navMode===as.Horizontal||ae("disable-feature:context-navigation")){ue(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const e=Te(this.tmpRayDir);E0(this.currentCamera,t,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=e*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(e-r)<1e-6)return;if(this.hasPickPoint&&r<e){const n=1-(1-r/e)*(1-this.sphere[3]/Te(this.currentCamera.center));this.currentCamera.center=se(wO,this.currentCamera.center,n)}se(this.tmpRayDir,this.tmpRayDir,-r/e),this.currentCamera.eye=de(wO,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=Ac(this.dragBeginPoint,t),Hi(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&(wT(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),WS(this.pickPoint,this.targetOnSphere,this.panAxisAngle),lm(this.currentCamera,this.sphere,this.panAxisAngle))}else{const e=Te(this.tmpRay.direction);E0(this.currentCamera,t,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=e*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(e-r)<1e-6)return;se(this.tmpRayDir,this.tmpRay.direction,1-r/e),this.currentCamera.eye=de(wO,this.currentCamera.eye,this.tmpRayDir),this.currentCamera.center=de(wO,this.currentCamera.center,this.tmpRayDir)}pb(this.view,this.currentCamera)}}end(){this.active&&this.finishController()}};u([d({constructOnly:!0})],bO.prototype,"view",void 0),bO=u([R("esri.views.3d.state.controllers.global.ZoomController")],bO);const wO=$();let xO=class extends pm{constructor(t){super(t),this.view=null,this.tmpP=$(),this.tmpDir=$(),this.tmpN=$(),this.tmpP0=ke(),this.tmpPoi=$(),this.tmpRayDir=$(),this.dragBeginPoint=Ii(),this.normalizedAnchorPoint=ke(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:$(),tiltMode:0},this.plane=Mt()}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;let e;os(this.dragBeginPoint,t),E0(this.startCamera,t,this.normalizedAnchorPoint),this.intersectionHelper.intersectScreenFreePointFallback(t,this.tmpP),ue(this.tmpDir,this.tmpP,this.startCamera.eye),_e(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(e=Math.abs(this.view.camera.position.z));let i=Re(Yoe*e,aO[0],aO[1]);const r=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),t[0],t[1],this.view.state.camera,Xoe);i=i>r?r:i,se(this.tmpDir,this.tmpDir,i),de(this.tmpP,this.startCamera.eye,this.tmpDir),ue(this.tmpN,this.startCamera.eye,this.startCamera.center),_e(this.tmpN,this.tmpN),this.tmpN[1]<0&&Fs(this.tmpN,this.tmpN),k1(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.startCamera}update(t){if(!this.active)return;x9e(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||re(this.tmpPoi,this.currentCamera.center),E0(this.currentCamera,t,this.tmpP0);let e=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);os(this.normalizedAnchorPoint,this.tmpP0),ue(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const i=Te(this.tmpRayDir);let r=i*(1-e);re(this.constraintOptions.interactionDirection,this.tmpRayDir),se(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,Math.sign(e)/i);const s=this.view.state.constraints.minimumPoiDistance;e>=0&&r<s&&(r=s,e=-(r-i)/i),Math.abs(i-r)<1e-6||(se(this.tmpRayDir,this.tmpRayDir,e),this.currentCamera.eye=de(R0,this.currentCamera.eye,this.tmpRayDir),jr(R0,this.currentCamera.center,this.tmpPoi,e),this.tmpPoi[2]>this.startCamera.center[2]?R0[2]=Math.max(this.startCamera.center[2],R0[2]):R0[2]=Math.min(this.startCamera.center[2],R0[2]),this.currentCamera.center=R0,this.constraintOptions.interactionFactor=Ac(this.dragBeginPoint,t),Hi(this.view,this.currentCamera,this.constraintOptions))}end(){this.active&&this.finishController()}};u([d({constructOnly:!0})],xO.prototype,"view",void 0),xO=u([R("esri.views.3d.state.controllers.local.ZoomController")],xO);const R0=$();class N9e extends bs{constructor(e,i,r){super(!0),this.view=e,this.pointerAction=i,this.registerIncoming("drag",r,s=>this.handleDrag(s))}handleDrag(e){const i=e.data;if(i.pointers.size>1||!SN(e.data,this.pointerAction))return;const r=Ii(i.center.x,i.center.y);switch(i.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.view.state.isGlobal?this.cameraController=new bO({view:this.view}):this.cameraController=new xO({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(r);break;case"update":this.cameraController&&this.cameraController.update(r);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}const U9e=$(),SO=$();function PN(){return{direction:$(),up:$()}}function xae(t,e,i,r,s){let n=_e(U9e,t),o=ye(n,r);const a=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(ye(e,r)),o<.99?(re(n,e),a&&se(n,n,-1)):n=null);let l=0;if(n){se(SO,r,ye(r,n)),ue(n,n,SO);const h=ye(n,s)/(Te(n)*Te(s));Ye(SO,n,s),l=(ye(SO,r)>0?1:-1)*go(ar(h))}const c=go(ar(-ye(r,t)/Te(t)));return i?(i.heading=l,i.tilt=c,i):{heading:l,tilt:c}}const Sae=De(0,1,0),Tae=De(0,0,1),I0=be(),Ad=$(),$d=$();function Cae(t,e,i,r=PN()){Di(I0);const{direction:s,up:n}=r;return ly(I0,I0,-nt(e)),$1(I0,I0,nt(i)),Oe(s,Tae,I0),se(s,s,-1),Oe(n,Sae,I0),r}function j9e(t,e,i,r){return xae(e,i,r,Tae,Sae)}function B9e(t,e,i,r){const s=Cae(t,i,r),n=$();return se(n,s.direction,-e),de(n,n,t),{up:s.up,eye:n,heading:i,tilt:r}}function G9e(t){return go(t)}function q9e(t){return nt(t)}function Mae(t,e,i,r,s){const n=t.renderSpatialReference,o=t.map&&t.spatialReference||e.spatialReference;return Gr(e,Ad,n),Gr(e,$d,n),Ad[0]-=i/2,$d[0]+=i/2,Ad[1]-=r/2,$d[1]+=r/2,Ns(Ad,n,Ad,o),Ns($d,n,$d,o),s?(s.xmin=Ad[0],s.ymin=Ad[1],s.xmax=$d[0],s.ymax=$d[1],s.spatialReference=o):s=new ht(Ad[0],Ad[1],$d[0],$d[1],o),s}const H9e=Object.freeze({__proto__:null,headingTiltToDirectionUp:Cae,directionToHeadingTilt:j9e,eyeForCenterWithHeadingTilt:B9e,lookAtTiltToEyeTilt:G9e,eyeTiltToLookAtTilt:q9e,toExtent:Mae}),Pae=De(0,0,1),Aae=_e($(),De(1,1,1)),W9e=new zp(-180,180),D0=be(),fm=$(),_b=$();function $ae(t,e,i,r=PN()){Ye(fm,t,Pae),ye(fm,fm)===0&&Ye(fm,t,Aae),Di(D0),Bi(D0,D0,-nt(e),t),Bi(D0,D0,-nt(i),fm);const{up:s,direction:n}=r;return Ye(s,fm,t),_e(s,s),Oe(s,s,D0),_e(n,t),Fs(n,n),Oe(n,n,D0),r}function Z9e(t,e,i,r){const s=fm,n=_b;return _e(s,t),Ye(_b,s,Pae),ye(_b,_b)===0&&Ye(_b,s,Aae),Ye(n,_b,s),xae(e,i,r,s,n)}function J9e(t,e,i,r){const s={eye:$(),up:null,tilt:r,heading:i},n=fm;n[0]=t[0],n[1]=t[2],n[2]=-t[1];const o=e,a=nt(i),l=nt(r),c=Math.sin(a),h=Math.cos(a),p=Math.sin(l),f=Math.cos(l),g=Te(n);let y;if(Math.abs(l)<1e-8)y=o+g;else{const J=g/p,O=Bl(o/J),L=Math.PI-l-O;y=J*Math.sin(L)}const v=f*o,b=o*o*(p*p),w=h*h*b,S=y-v,T=S*S,C=w*(w+T-n[1]*n[1]);if(C<0)return se(s.eye,n,y/g),s.tilt=0,s;const M=Math.sqrt(C),P=n[1]*S,F=w+T;let z;if(z=h>0?-M+P:M+P,Math.abs(F)<1e-8)return g<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=o):se(s.eye,n,y/g),s.tilt=0,AN(s.eye),$N(s,t);s.eye[1]=z/F;const D=c*c*b,U=p*o,G=h*U*s.eye[1],k=s.eye[1]*s.eye[1],j=1-k,V=Math.sqrt(j),q=w*k+D-2*G*V*S+j*T;return Math.abs(q)<1e-8?(se(s.eye,n,y/g),s.tilt=0,AN(s.eye),$N(s,t)):(s.eye[0]=(j*(y*n[0]-v*n[0])-U*V*(n[0]*s.eye[1]*h+n[2]*c))/q,s.eye[2]=(j*(y*n[2]-v*n[2])-U*V*(n[2]*s.eye[1]*h-n[0]*c))/q,se(s.eye,s.eye,y),AN(s.eye),$N(s,t))}function AN(t){const e=t[1];t[1]=-t[2],t[2]=e}function $N(t,e){const i=$ae(e,t.heading,t.tilt);return t.up=i.up,t}function Q9e(t,e,i){const r=Te(e),s=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-t)),n=Bl(i/(s/Math.sin(t)));return go(t-n)}function Y9e(t,e,i){const r=nt(t),s=Te(e);return Bl(i/(s/Math.sin(r)))+r}function Eae(t,e,i,r,s){let n,o,a,l;const c=e.latitude,h=e.longitude,p=aze(c,i,Ut(t.spatialReference).radius)/2;n=h-p,o=h+p;const f=nt(c),g=Ut(t.spatialReference).radius,y=(1+Math.sin(f))/(1-Math.sin(f)),v=(y+1)*Math.tan(r/g/2),b=v*v;function w(T){const C=Math.PI/2;return(T=qbe.normalize(T,-C))>C&&(T=Math.PI-T),T}if(a=1.5*Math.PI-2*Math.atan(.5*(v+Math.sqrt(4*y+b))),l=a+r/g,a=w(a),l=w(l),l<a){const T=l;l=a,a=T}if(a=Math.max(go(a),-90),l=Math.min(go(l),90),o=W9e.monotonic(n,o),o-n>180){const T=(o-n-180)/2;n+=T,o-=T}const S=t.spatialReference&&t.spatialReference.isGeographic?t.spatialReference:Ue.WGS84;return s?(s.xmin=n,s.ymin=a,s.xmax=o,s.ymax=l,s.spatialReference=S):s=new ht(n,a,o,l,S),t.spatialReference&&t.spatialReference.isWebMercator&&Ih(s,!1,s),s}const X9e=Object.freeze({__proto__:null,headingTiltToDirectionUp:$ae,directionToHeadingTilt:Z9e,eyeForCenterWithHeadingTilt:J9e,lookAtTiltToEyeTilt:Q9e,eyeTiltToLookAtTilt:Y9e,toExtent:Eae});function TO(t,e){return t!=null&&(e==null||(e===2?!t.isGeographic||t.isWGS84||t.wkid===4490:t.isWebMercator||t.isWGS84||t.wkid===4490||t.wkid===104971||t.wkid===104905||t.wkid===104903))}const Oae=le.getLogger("esri.views.3d.support.cameraUtils"),Rae=39.37,Iae=96,EN=1,K9e=8,eVe=5,Dae=1,Fae=$(),CO=$(),tVe={heading:0,tilt:0},Ed=new je,iVe=new zp(-20037508342788905e-9,20037508342788905e-9),rVe=new zp(-180,180);function ST(t){return t.spatialReference||Ue.WGS84}function bb(t){return t.viewingMode==="global"?X9e:H9e}function sVe(t,e,i,r,s){return bb(t).headingTiltToDirectionUp(e,i,r,s)}function Od(t,e){if(A(e))return null;const i=t.renderSpatialReference,r=bb(t).headingTiltToDirectionUp,s=$();if(!Gr(e.position,s,i))return null;const n=r(s,e.heading,e.tilt);se(n.direction,n.direction,t.state.camera.distance),de(n.direction,n.direction,s);const o=M0(t,s,n.direction,n.up);return o.fov=nt(e.fov),o}const wb=$();function xb(t,e,i){const r=t.renderSpatialReference,s=MO(t,e.eye,e.viewForward,e.up,tVe);let n=ST(t);return Ns(e.eye,r,wb,n)||(n=Ue.WGS84,Ns(e.eye,r,wb,n)),A(i)?new yo(new je(wb,n),s.heading,s.tilt,go(e.fov)):(i.position.x=wb[0],i.position.y=wb[1],i.position.z=wb[2],i.position.spatialReference=n,i.heading=s.heading,i.tilt=s.tilt,i.fov=go(e.fov),i)}function ON(t,e,i){const r=t.state.camera,s=r.width/2/r.pixelRatio;return t.renderCoordsHelper.viewingMode===1&&i!=null&&(e*=Math.cos(nt(i))),e/=t.renderCoordsHelper.unitInMeters,s/(Iae*Rae/e)/Math.tan(r.fovX/2)}function F0(t,e,i){const r=t.state.camera,s=e*Math.tan(r.fovX/2),n=r.width/2/r.pixelRatio;let o=Iae*Rae/(n/s);return t.renderCoordsHelper.viewingMode===1&&(o/=Math.cos(nt(i))),o*=t.renderCoordsHelper.unitInMeters,o}function Lae(t,e,i,r,s,n){return kae(t,e,ON(t,i,e.latitude),r,s,n)}function kae(t,e,i,r,s,n){if(L0(n)){const a=new Sb(n.signal);return TT(t,r.heading,r.tilt,e,i,s,a),void a.resolver.promise.then(l=>{const c=AO(t,l,r.fov);if(!A(c))return n.resolver.resolve(c);n.resolver.reject()},l=>n.resolver.reject(l))}const o=TT(t,r.heading,r.tilt,e,i,s);return AO(t,o,r.fov,n)}function MO(t,e,i,r,s){return bb(t).directionToHeadingTilt(e,i,r,s)}function nVe(t,e){return!!(t.basemapTerrain&&t.renderCoordsHelper.fromRenderCoords(e,Ed,t.spatialReference)&&st(wc(t.elevationProvider,Ed),0)>Ed.z-Dae)}async function oVe(t,e,i){if(!t.renderCoordsHelper.fromRenderCoords(e,Ed,t.spatialReference))return!1;const r=await t.elevationProvider.queryElevation(Ed.x,Ed.y,Ed.z,Ed.spatialReference,"ground",i);return st(r,0)>Ed.z-Dae}async function aVe(t,e,i){const r=$();if(e)if(e instanceof je){if(Gr(e,r,t.renderSpatialReference),e.z==null&&t.basemapTerrain!=null){const s=await t.elevationProvider.queryElevation(e.x,e.y,e.z,e.spatialReference,"ground",i);return _(s)&&t.renderCoordsHelper.setAltitude(r,s),r}}else re(r,e);else re(r,t.state.camera.center);return r}function lVe(t,e){const i=$();if(e&&e instanceof je){if(Gr(e,i,t.renderSpatialReference),e.z==null&&t.basemapTerrain!=null){const r=wc(t.elevationProvider,e);_(r)&&t.renderCoordsHelper.setAltitude(i,r)}}else re(i,e||t.state.camera.center);return i}function TT(t,e,i,r,s,n,o){const a=r&&r instanceof je?r:null;if(L0(o))return aVe(t,r,o.signal).then(c=>{RN(t,e,i,a,c,s,n,o)},c=>o.resolver.reject(c)),null;const l=lVe(t,r);return RN(t,e,i,a,l,s,n,o)}function RN(t,e,i,r,s,n,o,a){if(A(r)){const p=t.renderSpatialReference;if(r=nf(s,p,ST(t)),A(r))return null}n=Math.max(n,t.state.constraints.minimumPoiDistance);const l=hVe(t,e,i,s,n,o),c=(0,bb(t).eyeForCenterWithHeadingTilt)(s,n,l.heading,l.tilt);if(o===1&&t.viewingMode==="global"&&i>0){const p=()=>{const g=zae(t,s,n,pVe(t,n,i,s));return RN(t,e,g,r,s,n,o=i-g<1?0:1,a)},f=t.map.ground.navigationConstraint;if(!f||f.type==="stay-above"){if(nVe(t,c.eye))return p();if(L0(a))return oVe(t,c.eye,a.signal).then(g=>g?p():(a.resolver.resolve({eye:c.eye,up:c.up,center:br(s),heading:c.heading,tilt:c.tilt}),null)),null}}const h=!a||L0(a)?{center:$(),eye:$(),up:$(),tilt:0,heading:0}:a;return h.eye=c.eye,h.up=c.up,h.center=br(s),h.heading=c.heading,h.tilt=c.tilt,L0(a)&&a.resolver.resolve(h),h}function CT(t,e,i,r,s,n=null){const o=e.zmax!=null&&e.zmin!=null;let a,l,c;if(t.state.isGlobal){if(!TO(e.spatialReference,1))return L0(n)&&n.resolver.reject(),null;const w=new je(e.xmin,e.ymin,e.spatialReference),S=new je(e.xmax,e.ymax,e.spatialReference),T=e.spatialReference.isGeographic?rVe:iVe;a=new je({x:T.center(w.x,S.x),y:(S.y+w.y)/2,z:o?(e.zmax+e.zmin)/2:null,spatialReference:e.spatialReference});const C=Ut(e.spatialReference),M=oze(a,w,S);l=M.lon,c=M.lat,T.diff(w.x,S.x)>T.range/2&&(l+=C.halfCircumference),l=Math.min(l,C.halfCircumference),c=Math.min(c,C.halfCircumference)}else{const w=st(t.renderSpatialReference,e.spatialReference);w.equals(e.spatialReference)||(e=f2(e,w)),l=e.xmax-e.xmin,c=e.ymax-e.ymin;const S=o?(e.zmax+e.zmin)/2:null;a=new je({x:e.xmin+.5*l,y:e.ymin+.5*c,z:S,spatialReference:w})}const h=o?e.zmax-e.zmin:0,p=t.state.camera,f=1/Math.tan(p.fovX/2),g=1/Math.tan(p.fovY/2),y=1/Math.tan(p.fov/2),v=Math.max(.5*l*f,.5*c*g,.5*h*y)/EN;if(L0(n)){const w=new Sb(n.signal);return TT(t,i,r,a,v,s,w),void w.resolver.promise.then(S=>{const T=AO(t,S,t.camera.fov);if(!A(T))return n.resolver.resolve(T);n.resolver.reject()},S=>n.resolver.reject(S))}const b=TT(t,i,r,a,v,s);return AO(t,b,t.camera.fov,n)}function cVe(t,e,i){const r=t.renderSpatialReference,s=nf(i,r,ST(t));if(A(s))return null;const n=Math.tan(e.fovX/2),o=Math.tan(e.fovY/2),a=CF(e.eye,i),l=2*a*n*EN,c=2*a*o*EN;return t.viewingMode==="global"?Eae(t,s,l,c):Mae(t,s,l,c)}function uVe(t,e,i){const r=t.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(i/r)/Math.LN2>K9e)return!0;const s=t.renderSpatialReference,n=ST(t),o=nf(e,s,n),a=nf(t.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s,n);if(A(o)||A(a))return!1;const l=Math.tan(.5*t.state.camera.fov)*r;return a.distance(o)/l>eVe}function hVe(t,e,i,r,s,n){let o=0;return n===1&&uVe(t,r,s)?(e=0,o=dVe(t,s,i,r)):o=IN(t,r,s,i),o=t.state.constraints.clampTilt(s,o),{heading:e,tilt:i=zae(t,r,s,o)}}const PO=.7;function dVe(t,e,i,r){const s=t.state.constraints.tilt(e);s.max=Math.min(s.max,.5*Math.PI);const n=s.min*(1-PO)+s.max*PO,o=IN(t,r,e,i);return Math.min(o,n)}function pVe(t,e,i,r){const s=t.state.constraints.tilt(e);let n=IN(t,r,e,i);return n=Math.min(n,.5*Math.PI),s.min*(1-PO)+n*PO}function zae(t,e,i,r){return bb(t).lookAtTiltToEyeTilt(r,e,i)}function IN(t,e,i,r){return bb(t).eyeTiltToLookAtTilt(r,e,i)}function AO(t,e,i,r){if(A(e))return null;const s=t.renderSpatialReference,n=nf(e.eye,s,ST(t));return A(n)?null:_(r)?(r.position=n,r.heading=e.heading,r.tilt=e.tilt,r.fov=i,r):new yo(n,e.heading,e.tilt,i)}function Vae(t,e){var i;const r=(i=t.basemapTerrain)==null?void 0:i.tilingScheme;if(r)return r.levelAtScale(e);Oae.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function Nae(t,e){var i;const r=(i=t.basemapTerrain)==null?void 0:i.tilingScheme;if(r)return r.scaleAtLevel(e);Oae.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function fVe(t,e){return t.spatialReference?IQ(e,t.spatialReference):void 0}function Uae(t,e,i){const r=t.renderSpatialReference;let s,n;e||(e=t.state.camera);const o=Ue.WGS84;return e instanceof yo?(s=e.position.latitude,Gr(e.position,Fae,r),Gr(i,CO,r),n=qt(Fae,CO)):(Ns(e.center,r,CO,o),s=CO[1],n=e.distance),F0(t,n,s)}class Sb{constructor(e){this.signal=e,this.resolver=Th()}}function L0(t){return t&&"resolver"in t}function $c(t){let e=t*t;return t<0&&(e*=-1),e}function jae(t,e,i){const r=i,s=t.state,n=t.device,o=e.tiltDirection==="forward-down"?1:-1,a=1;return n.deviceType==="standard"?(r.translation[0]=$c(s.axes[0]),r.translation[1]=$c(s.axes[1]),r.translation[2]=$c(s.buttons[7])-$c(s.buttons[6]),r.heading=$c(s.axes[2]),r.tilt=$c(s.axes[3])):n.deviceType==="spacemouse"&&(r.translation[0]=1.2*$c(s.axes[0]),r.translation[1]=1.2*$c(s.axes[1]),r.translation[2]=2*-$c(s.axes[2]),r.heading=1.2*$c(s.axes[5]),r.tilt=1.2*$c(s.axes[3])),r.tilt*=o,se(r.translation,r.translation,a),r}function Bae(t,e){const i=e;return i.translation[0]=t[1]-t[0],i.translation[1]=t[3]-t[2],i.translation[2]=t[4]-t[5],i.heading=t[7]-t[6],i.tilt=t[8]-t[9],i.zoom=t[10]-t[11],i}function DN(t){return t.translation[0]===0&&t.translation[1]===0&&t.translation[2]===0&&t.heading===0&&t.tilt===0&&t.zoom===0}let mm=class extends pm{constructor(t){super(t),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new Zt,this.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new Zt,interactionFactor:0,interactionDirection:null,tiltMode:1}}handleEventGamepad(t){const e=jae(t,this.view.navigation.gamepad,this.transformation);(t.action==="end"||DN(e))&&this.finishController()}activateDirection(t){this.keysButtonState[t]=1,Bae(this.keysButtonState,this.transformation)}deactivateDirection(t){this.keysButtonState[t]=0;const e=Bae(this.keysButtonState,this.transformation);DN(e)&&this.finishController()}onControllerStart(t){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(t)}updateFilteredSurfaceElevation(t){const e=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this.filteredSurfaceElevation+=i*(e-this.filteredSurfaceElevation)*t}stepController(t,e){this.updateStartHeading(),this.updateFilteredSurfaceElevation(t),this.currentCamera.copyViewFrom(e),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(t,this.currentCamera,k0),this.applyDisabledMovementTypes(k0),this.applyPan(k0.pan),this.applyRotate(k0.rotate),this.applyZoom(k0.zoom),this.applyAscend(k0.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,Hi(this.view,this.currentCamera,this.constraintOptions),super.stepController(t,e)}updateStartHeading(){this.transformation.heading!==0&&(this.headingStart=this.view.camera.heading)}applyRotate(t){if(!t.enabled)return;const e=this.currentCamera;ue(Zn,e.center,e.eye),Oe(Zn,Zn,t.matrix),e.center=de(Zn,Zn,e.eye),e.up=Oe(Zn,e.up,t.matrix),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,Hi(this.view,e,this.constraintOptions)}applyPan(t,e=this.currentCamera){!t.enabled||(e.eye=Oe(Zn,e.eye,t.matrix),e.center=Oe(Zn,e.center,t.matrix),this.view.state.isGlobal&&(e.up=Oe(Zn,e.up,t.matrix)),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,Hi(this.view,e,this.constraintOptions))}applyZoom(t){if(!t)return;const e=this.currentCamera.viewForward;this.currentCamera.eye=de(Zn,this.currentCamera.eye,se(Me.get(),e,t)),re(MT,e),Fs(MT,MT),this.constraintOptions.interactionDirection=MT,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,Hi(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}applyAscend(t){if(!t)return;const e=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Me.get());if(this.constraintOptions.interactionDirection=re(MT,e),this.view.state.isGlobal){const i=Te(this.currentCamera.eye),r=(i+t)/i;this.currentCamera.eye=se(Zn,this.currentCamera.eye,r),this.currentCamera.center=se(Zn,this.currentCamera.center,r)}else{const i=se(Me.get(),e,t);this.currentCamera.eye=de(Zn,this.currentCamera.eye,i),this.currentCamera.center=de(Zn,this.currentCamera.center,i)}this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,Hi(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,Hi(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}calculateControlTransformation(t,e,i){wVe(i);const r=this.computeVelocities(t);this.view.state.isLocal?this.calculateControlTransformationLocal(r,e,i):this.calculateControlTransformationGlobal(r,e,i)}updateCameraCenter(){const t=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,e=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=e.intersectManifoldClosestSilhouette(i,t,Zn)}calculateControlTransformationLocal(t,e,i){const{viewRight:r,viewForward:s}=e,n=this.transformation,o=this.view.navigation.gamepad,a=ne(Me.get(),s[0],s[1],0);_e(a,a);const l=n.translation[0]*t.pan;if(l!==0){const y=se(Me.get(),r,l);Vs(i.pan.matrix,i.pan.matrix,y),i.pan.enabled=!0}switch(o.mode){case"pan":{const y=-n.translation[1]*t.pan;if(y!==0){const v=se(Me.get(),a,y);Vs(i.pan.matrix,i.pan.matrix,v),i.pan.enabled=!0}i.zoom=n.zoom*t.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*t.zoom;break;default:kn(o.mode)}const c=n.translation[2]*t.ascend;i.ascend=c;const h=-n.heading*t.rotate;h!==0&&(Bi(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(e.eye,Me.get())),i.rotate.enabled=!0);const p=n.tilt*t.rotate,f=rm(this.view.renderCoordsHelper,e.center,e.eye),g=Re(f+p,ws.min,ws.max)-f;g&&(Bi(i.rotate.matrix,i.rotate.matrix,g,r),i.rotate.enabled=!0)}calculateControlTransformationGlobal(t,e,i){const{eye:r,viewRight:s}=e,n=this.transformation,o=this.view.navigation.gamepad,a=Ye(Me.get(),s,r);_e(a,a),Fs(a,a),A9e(this.startCamera,e,n,t,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,o),this.tmpCamera.copyFrom(this.currentCamera),this.applyPan(k0.pan,this.tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=n.translation[2]*t.ascend;i.ascend=c;const h=-n.heading*t.rotate;h!==0&&(Bi(i.rotate.matrix,i.rotate.matrix,h,this.tmpCamera.eye),i.rotate.enabled=!0);const p=n.tilt*t.rotate,f=this.clampTiltDeltaGlobalToValidRange(p,e.ray,l);f!==0&&(Bi(i.rotate.matrix,i.rotate.matrix,f,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=n.zoom*t.zoom}clampTiltDeltaGlobalToValidRange(t,e,i){const r=Ut(this.view.spatialReference),s=lO(ws.min,e.origin,i,r);let n=0,o=0;const a=Me.get();if(this.view.renderCoordsHelper.intersectManifold(e,i,a)){const l=rm(this.view.renderCoordsHelper,a,e.origin);n=lO(l,e.origin,i,r),o=lO(ws.max,e.origin,i,r)}else{L1(KP(i+r.radius),e,a);const l=ar(-ye(e.direction,_e(a,a)));n=tae(l,e.origin,i,r),o=tae(ws.max,e.origin,i,r)}return Re(n+t,s,o)-n}getPointAbsoluteSurfaceElevation(t,e,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(t),n=e+Math.abs(s-e);return r.setAltitude(i,n,t),n}clampedDistanceToSurface(t,e){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=sVe(this.view,e,0,Gae,bVe),n=i.intersectManifoldClosestSilhouette(Ko(e,s),t,Me.get()),o=qt(e,n),a=i.intersectManifoldClosestSilhouette(Ko(e,Lh(Me.get(),e,r.center)),t,Me.get()),l=qt(e,a);return Math.min(o,l)}computeHeadingRotateRadius(t){const{renderCoordsHelper:e,state:i}=this.view,{camera:r,isGlobal:s}=i,n=e.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,Me.get());if(s){const o=ue(Me.get(),t,n),a=Te(o);se(o,o,1/a);const l=_e(Me.get(),t),c=ar(ye(l,o));return a*Math.sin(Math.min(gVe,c))}{const o=re(Me.get(),t);return e.setAltitude(o,this.filteredSurfaceElevation),qt(n,o)}}minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:yVe}computeVelocities(t){const e=this.filteredSurfaceElevation,i=e+Ut(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,n=Me.get(),o=this.getPointAbsoluteSurfaceElevation(r.eye,e,n),a=this.clampedDistanceToSurface(e,n),l=r.width/2,c=qae*r.width,h=qae*r.width,p=a*Math.tan(.5*r.fovX)/l,f=p/i,g=p/this.computeHeadingRotateRadius(n),y=o-e;return{pan:(s?f:p)*c*t,ascend:Math.max(this.minimumAscendVelocity()*t,2**(c*t/l)*y-y),zoom:2**(c*t/l)*a-a,rotate:Re(g*h,vVe,_Ve)*t}}applyDisabledMovementTypes(t){!_(this.disableMovements)||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(t.zoom=this.disableMovements.zoom?0:t.zoom,t.ascend=this.disableMovements.ascend?0:t.ascend,t.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Di(t.pan.matrix),t.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Di(t.rotate.matrix))}static activatesFor(t,e){const i=jae(e,t.navigation.gamepad,mVe);return!(e.action==="end"||DN(i))}};u([d({constructOnly:!0})],mm.prototype,"view",void 0),u([d({constructOnly:!0})],mm.prototype,"gamepadDevice",void 0),u([d({constructOnly:!0})],mm.prototype,"disableMovements",void 0),mm=u([R("esri.views.3d.state.controllers.GamepadKeyboardController")],mm);const mVe={translation:[0,0,0],heading:0,tilt:0,zoom:0},Gae=80,gVe=nt(Gae),qae=.75,yVe=5,vVe=nt(30),_Ve=nt(80),k0={zoom:0,ascend:0,pan:{enabled:!1,matrix:be()},rotate:{enabled:!1,matrix:be()}},Zn=$(),MT=$(),bVe=PN();function wVe(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,Di(t.pan.matrix),t.rotate.enabled=!1,Di(t.rotate.matrix)}class xVe extends bs{constructor(e){super(!0),this.view=e,this.watchHandles=new dt,this.handle=this.registerIncoming("gamepad",i=>this.handleEventGamepad(i)),this.handle.pause()}onInstall(e){super.onInstall(e),this.watchHandles.add([Ke(this.view.navigation.gamepad,"enabled",i=>{i?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null))}),this.view.navigation.gamepad.watch("device",i=>{this.cameraControllerGamepad&&i&&this.cameraControllerGamepad.gamepadDevice!==i&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null)})])}onUninstall(){this.watchHandles.removeAll(),super.onUninstall()}handleEventGamepad(e){const i=this.view.navigation.gamepad.device;if(i&&e.data.device!==i)return;const r=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(r||mm.activatesFor(this.view,e.data)){if(!r){const s=new mm({view:this.view,gamepadDevice:e.data.device});this.view.state.switchCameraController(s)&&(this.cameraControllerGamepad=s)}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===e.data.device&&this.cameraControllerGamepad.handleEventGamepad(e.data)}}}class SVe extends bs{constructor(e,i){super(!0),this.view=e,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this.keyToNumber={[i.left]:0,[i.right]:1,[i.forward]:2,[i.backward]:3,[i.up]:4,[i.down]:5,[i.headingLeft]:6,[i.headingRight]:7,[i.tiltUp]:8,[i.tiltDown]:9,[i.zoomIn]:10,[i.zoomOut]:11},this.registerIncoming("key-down",null,r=>this.handleKeyDown(r)),this.registerIncoming("key-up",null,r=>this.handleKeyUp(r)),this.registerIncoming("blur",null,()=>this.handleBlur())}handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const i=this.keyToNumber[e.data.key];i!=null&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new mm({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(i),e.stopPropagation()))}handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null)}handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const i=this.keyToNumber[e.data.key];i!=null&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(i),e.stopPropagation())}}class TVe extends bs{constructor(e,i){super(!0),this.view=e,this.registerIncoming("mouse-wheel",i,r=>this.handleMouseWheel(r))}handleMouseWheel(e){if(!this.view.navigation.mouseWheelZoomEnabled)return;const i=e.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new yO({view:this.view,mode:"interaction"}):new _O({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*i.deltaY,Ii(i.x,i.y)),e.preventDefault(),e.stopPropagation()}}class $O{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let gm=class extends _T{constructor(t){super(t),this.view=null,this.beginCamera=new Zt,this.elapsedTimeSec=0,this.constraintOptions={selection:15,interactionType:4,interactionFactor:0,interactionStartCamera:new Zt,interactionDirection:null,tiltMode:0}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new j_}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(t){this.beginCamera.copyFrom(t),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(t)}stepController(t,e){e.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=t,this.momentumStep(this.elapsedTimeSec,e),Hi(this.view,e,this.constraintOptions)}};u([d({constructOnly:!0})],gm.prototype,"view",void 0),gm=u([R("esri.views.3d.state.controllers.momentum.MomentumController")],gm);let PT=class extends gm{constructor(t){super(t),this.interactionType=4,this.tmpPan=$()}momentumStep(t,e){const i=this.momentum.value(t);se(this.tmpPan,this.momentum.direction,i),e.eye=ue(Hae,e.eye,this.tmpPan),e.center=ue(Hae,e.center,this.tmpPan),this.constraintOptions.interactionDirection=this.tmpPan}};u([d({constructOnly:!0})],PT.prototype,"momentum",void 0),PT=u([R("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],PT);const Hae=$(),CVe=$(),EO=$();let OO=class extends gm{constructor(t){super(t),this.interactionType=4}momentumStep(t,e){const i=this.momentum.value1(t),r=this.momentum.value2(t);re(EO,e.eye),_e(EO,EO),Ye(this.momentum.axis2,EO,this.momentum.axis1),hae(e,CVe,this.momentum.axis1,i,this.momentum.axis2,r)}};u([d({constructOnly:!0})],OO.prototype,"momentum",void 0),OO=u([R("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],OO);let z0=class extends gm{constructor(t){super(t),this.interactionType=2}set center(t){this._set("center",br(t))}set axis(t){this._set("axis",br(t))}momentumStep(t,e){const i=this.momentum.value(t);lm(e,this.center,HS(this.axis,i))}};u([d({constructOnly:!0})],z0.prototype,"momentum",void 0),u([d({constructOnly:!0})],z0.prototype,"center",null),u([d({constructOnly:!0})],z0.prototype,"axis",null),z0=u([R("esri.views.3d.state.controllers.momentum.MomentumController")],z0);let Tb=class extends gm{constructor(t){super(t),this.interactionType=1,this.constraintOptions.interactionDirection=$()}set zoomCenter(t){this._set("zoomCenter",br(t))}momentumStep(t,e){re(this.constraintOptions.interactionDirection,e.eye);const i=this.momentum.valueDelta(0,t);yN(e,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=Lh(this.constraintOptions.interactionDirection,e.eye,this.constraintOptions.interactionDirection)}};u([d({constructOnly:!0})],Tb.prototype,"momentum",void 0),u([d({constructOnly:!0})],Tb.prototype,"zoomCenter",null),Tb=u([R("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Tb);let V0=class extends gm{constructor(t){super(t),this.interactionType=1,this.radius=0,this.tmpSceneCenter=$(),this.tmpZoomAxisAngle=Q_(),this.sphere=rs()}set screenCenter(t){this._set("screenCenter",Ii(t[0],t[1]))}set sceneCenter(t){this._set("sceneCenter",br(t))}initialize(){this.sphere[3]=this.radius}momentumStep(t,e){const i=this.momentum.valueDelta(0,t);Koe(this.sphere,e,i),this.constraintOptions.interactionType=1,Hi(this.view,e,this.constraintOptions),wT(this.sphere,e,this.screenCenter,this.tmpSceneCenter),WS(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),lm(e,this.sphere,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=4}};u([d({constructOnly:!0})],V0.prototype,"momentum",void 0),u([d({constructOnly:!0})],V0.prototype,"screenCenter",null),u([d({constructOnly:!0})],V0.prototype,"sceneCenter",null),u([d({constructOnly:!0})],V0.prototype,"radius",void 0),V0=u([R("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],V0);class Ec{constructor(e){this.gain=e}update(e){if(this.hasLastValue){const i=this.computeDelta(e);this.updateDelta(i)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return this.lastValue!==void 0}get hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(e){return e-this.lastValue}updateDelta(e){this.hasFilteredDelta?this.filteredDelta=(1-this.gain)*this.filteredDelta+this.gain*e:this.filteredDelta=e}}class RO{constructor(e,i,r){this._initialVelocity=e,this._stopVelocity=i,this._friction=r,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,i){const r=this.value(e);return this.value(e+i)-r}valueFromInitialVelocity(e,i){i=Math.min(i,this.duration);const r=1-this.friction;return e*(r**i-1)/Math.log(r)}}class MVe extends RO{constructor(e,i,r,s,n){super(e,i,r),this.sceneVelocity=s,this.direction=n}value(e){return super.valueFromInitialVelocity(this.sceneVelocity,e)}}class Wae{constructor(e=300,i=12,r=.84){this.minimumInitialVelocity=e,this.stopVelocity=i,this.friction=r,this.enabled=!0,this.time=new Ec(.6),this.screen=[new Ec(.4),new Ec(.4)],this.scene=[new Ec(.6),new Ec(.6),new Ec(.6)],this.tmpDirection=$()}add(e,i,r){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(r)<.015)return;this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.scene[0].update(i[0]),this.scene[1].update(i[1]),this.scene[2].update(i[2]),this.time.update(r)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,i=this.screen[1].filteredDelta,r=Math.sqrt(e*e+i*i)/this.time.filteredDelta;return Math.abs(r)<this.minimumInitialVelocity?null:this.createMomentum(r,this.stopVelocity,this.friction)}createMomentum(e,i,r){ne(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const s=Te(this.tmpDirection);s>0&&se(this.tmpDirection,this.tmpDirection,1/s);const n=s/this.time.filteredDelta;return new MVe(e,i,r,n,this.tmpDirection)}}class Zae{constructor(e){this.gain=e}update(e){this.hasFilteredValue?this.filteredValue=(1-this.gain)*this.filteredValue+this.gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}}const Jae=1e-5;class PVe extends RO{constructor(e,i,r,s,n,o=0,a){super(e,i,r),this.angularVelocity1=s,this.axis1=n,this.angularVelocity2=o,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this.angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class AVe{constructor(e=300,i=12,r=.84){this.minimumInitialVelocity=e,this.stopVelocity=i,this.friction=r,this.enabled=!0,this.tmpAxis1=$(),this.tmpAxis2=$(),this.tmpAngles=ke(),this.time=new Ec(.3),this.screen=[new Ec(.4),new Ec(.4)],this.angle1=new Zae(.6),this.angle2=new Zae(.6),this.axis1=$(),this.axis2=$(),this.lastScene=$()}addMomentumDirectRotation(e,i,r,s,n,o){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(r)<.01)return;let a=aae(this.lastScene,i,this.tmpAxis2,s,n,o);this.angle2.update(0),un(this.tmpAxis2)<Jae?a=0:_e(this.axis1,this.tmpAxis2),this.angle1.update(a),re(this.lastScene,i)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(r)}}addMomentumPreserveHeading(e,i,r,s,n,o,a){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(r)<.01)return;uae(this.lastScene,i,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,s,n,o,a,!1),un(this.tmpAxis2)<Jae?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),_e(this.axis1,this.tmpAxis1),_e(this.axis2,this.tmpAxis2)),re(this.lastScene,i)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(r)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,i=this.screen[1].filteredDelta,r=Math.sqrt(e*e+i*i)/this.time.filteredDelta;return Math.abs(r)<this.minimumInitialVelocity?null:this.createMomentum(r,this.stopVelocity,this.friction)}createMomentum(e,i,r){const s=this.angle1.filteredValue/this.time.filteredDelta,n=this.angle2.filteredValue/this.time.filteredDelta;return new PVe(e,i,r,s,this.axis1,n,this.axis2)}}class Qae{constructor(e=2.5,i=.01,r=.95,s=12){this.minimumInitialVelocity=e,this.stopVelocity=i,this.friction=r,this.maxVelocity=s,this.enabled=!0,this.value=new Ec(.8),this.time=new Ec(.3)}add(e,i){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;if(this.value.hasFilteredDelta){const r=this.value.computeDelta(e);this.value.filteredDelta*r<0&&this.value.reset()}}this.time.update(i),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=Re(e,-this.maxVelocity,this.maxVelocity),Math.abs(e)<this.minimumInitialVelocity?null:this.createMomentum(e,this.stopVelocity,this.friction)}createMomentum(e,i,r){return new RO(e,i,r)}}class Yae extends Qae{constructor(e=3,i=.01,r=.95,s=12){super(e,i,r,s)}add(e,i){if(this.value.hasLastValue){const r=this.value.lastValue;let s=e-r;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;e=r+s}super.add(e,i)}}class $Ve extends RO{constructor(e,i,r){super(e,i,r)}value(e){const i=super.value(e);return Math.exp(i)}valueDelta(e,i){const r=super.value(e),s=super.value(e+i)-r;return Math.exp(s)}}class Xae extends Qae{constructor(e=2.5,i=.01,r=.95,s=12){super(e,i,r,s)}add(e,i){super.add(Math.log(e),i)}createMomentum(e,i,r){return new $Ve(e,i,r)}}let IO=class extends pm{constructor(t){super(t),this.view=null,this.smoothRotation=new $O(.05),this.rotationAxis=$(),this.panningPlane=Mt(),this.smoothScaling=new $O(.05),this.zoomCenterScreen=Ii(),this.zoomMomentumEstimator=new Xae,this.rotationMomentumEstimator=new Yae,this.panSphericalMomentumEstimator=new AVe,this.panPlanarMomentumEstimator=new Wae,this.adjustedSphere=rs(),this.tmp3d=$(),this.tmpScreenPointArray=Ii(),this.beginScreenPoint=Ii(),this.beginScenePoint=$(),this.screenPickPoint=Ii(),this.navMode=as.Horizontal,this.tmpInteractionDirection=$(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new Zt,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;const e=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=e,this.rotationMomentumEstimator.enabled=e,this.panPlanarMomentumEstimator.enabled=e,this.panSphericalMomentumEstimator.enabled=e,this.beginHeading=-Vp.normalize(nt(this.view.camera.heading)),this.beginRadius=t.radius,this.pointerCount=t.pointers.size,this.beginAngle=t.angle,this.smoothRotation.reset(),Gh(t.center,this.screenPickPoint),os(this.beginScreenPoint,this.screenPickPoint);const i=Ut(this.view.spatialReference),r=sae(this.intersectionHelper,this.startCamera,this.screenPickPoint,!0,i);this.scenePickPoint=r.scenePickPoint,this.sphere=r.sphere,re(this.beginScenePoint,this.scenePickPoint),this.navMode=cO(this.startCamera,this.screenPickPoint,r.hasGeometryIntersection,i),this.navMode===as.Vertical&&this.preparePlanarPanMode(t),this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}preparePlanarPanMode(t){const e=Fs(this.tmp3d,this.startCamera.viewForward);k1(this.scenePickPoint,e,this.panningPlane);const i=Ii(this.screenPickPoint[0],0),r=$(),s=Te(this.startCamera.eye);this.adjustedSphere[3]=s<this.sphere[3]?s-100:this.sphere[3],wT(this.adjustedSphere,this.startCamera,i,r);const n=ys();this.startCamera.projectToRenderScreen(r,n);const o=.9*n[1];if(this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],o),this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint)&&k1(this.scenePickPoint,Li(this.panningPlane),this.panningPlane),!w8()){const l=$(),c=$(),h=$(),p=80,f=5,g=50;ue(l,this.scenePickPoint,this.currentCamera.eye),_e(l,l);const y=f*Math.max(Math.abs(this.view.camera.position.z),g),v=this.view._stage.renderView.getMinimalDepthForArea(null,this.screenPickPoint[0],this.screenPickPoint[1],this.view.state.camera,p),b=v?Math.min(v,y):y;re(h,de(c,this.currentCamera.eye,se(c,l,b))),this.panningPlane[3]=-ye(this.panningPlane,h),this.startCamera.center=de(c,this.startCamera.eye,se(c,this.startCamera.viewForward,b))}const a=Gh(t.center,this.tmpScreenPointArray);gN(this.panningPlane,this.startCamera,a,this.beginScenePoint)}update(t){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const e=t.pointers.size>1;this.navMode===as.Horizontal?(e&&this.zoomSpherical(t),this.panningSpherical(t),e&&this.rotateSpherical(t)):(e&&this.zoomPlanar(t),this.panningPlanar(t),e&&this.rotatePlanar(t))}end(t){t.pointers.size===this.pointerCount&&this.update(t),this.finishController();const e=this.zoomMomentumEstimator.evaluateMomentum();if(e)return this.navMode===as.Horizontal?new V0({view:this.view,momentum:e,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere[3]}):new Tb({view:this.view,momentum:e,zoomCenter:this.beginScenePoint});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new z0({view:this.view,momentum:i,center:this.sphere,axis:this.rotationAxis});if(this.navMode===as.Horizontal){const r=this.panSphericalMomentumEstimator.evaluateMomentum();if(r)return new OO({view:this.view,momentum:r})}else{const r=this.panPlanarMomentumEstimator.evaluateMomentum();if(r)return new PT({view:this.view,momentum:r})}return null}zoomSpherical(t){const e=this.beginRadius/t.radius,i=.001875*Math.min(Math.max(t.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(e),Koe(this.sphere,this.currentCamera,this.smoothScaling.value),Gh(t.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*t.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Ac(t.radius-this.beginRadius),Hi(this.view,this.currentCamera,this.constraintOptions)}panningSpherical(t){const e=Gh(t.center,this.tmpScreenPointArray);wT(this.sphere,this.currentCamera,e,this.tmp3d),bN(this.beginScenePoint,ye(this.currentCamera.up,this.beginScenePoint),this.sphere[3],this.beginHeading,this.view.camera.tilt,this.startCamera)?(pae(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(e,this.tmp3d,.001*t.timestamp,this.startCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(dae(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(e,this.tmp3d,.001*t.timestamp,this.startCamera,this.sphere[3],this.view.camera.tilt)),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Ac(this.screenPickPoint,e),Hi(this.view,this.currentCamera,this.constraintOptions)}rotateSpherical(t){_e(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||Fs(this.rotationAxis,this.rotationAxis);const e=this.smoothRotation.value,i=e+mN(t.angle-e),r=.00125*Math.min(Math.max(t.radius,40),120);this.smoothRotation.gain=r,this.smoothRotation.update(i);const s=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(s,.001*t.timestamp),lm(this.currentCamera,this.sphere,HS(this.rotationAxis,s)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Ac(t.radius*i),Hi(this.view,this.currentCamera,this.constraintOptions)}panningPlanar(t){const e=Gh(t.center,this.tmpScreenPointArray);gN(this.panningPlane,this.currentCamera,e,this.tmp3d)&&(nae(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(e,this.tmp3d,.001*t.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Ac(this.beginScreenPoint,e),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),Hi(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)}zoomPlanar(t){const e=this.beginRadius/t.radius,i=.001875*Math.min(Math.max(t.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(e),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*t.timestamp),yN(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Ac(t.radius-this.beginRadius),Hi(this.view,this.currentCamera,this.constraintOptions)}rotatePlanar(t){re(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||Fs(this.rotationAxis,this.rotationAxis);const e=this.smoothRotation.value;let i=t.angle-e;i=mN(i);const r=e+i,s=.00125*Math.min(Math.max(t.radius,40),120);this.smoothRotation.gain=s,this.smoothRotation.update(r);const n=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(n,.001*t.timestamp),lm(this.currentCamera,this.sphere,HS(this.rotationAxis,n)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Ac(t.radius*n),Hi(this.view,this.currentCamera,this.constraintOptions)}};u([d({constructOnly:!0})],IO.prototype,"view",void 0),IO=u([R("esri.views.3d.state.controllers.global.PinchAndPanController")],IO);const Kae=De(0,0,1),EVe={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI},OVe=80;let DO=class extends pm{constructor(t){super(t),this.view=null,this.rotationValueSmooth=new $O(.05),this.scalingValueSmooth=new $O(.05),this.planeHorizontal=Mt(),this.planeVertical=Mt(),this.rotationMomentumEstimator=new Yae,this.panMomentumEstimator=new Wae(300,12,.9),this.zoomMomentumEstimator=new Xae,this.beginCenter=$(),this.tmpPoints=[],this.beginCenterScreen=Ii(),this.tmpCentroid3d=$(),this.tmpCentroid2d=Ii(),this.tmp2d=Ii(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new Zt,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;const e=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=e,this.rotationMomentumEstimator.enabled=e,this.panMomentumEstimator.enabled=e,this.beginRadius=t.radius,this.pointerCount=t.pointers.size,this.beginAngle=t.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),Gh(t.center,this.beginCenterScreen),hQ(Kae,0,this.planeHorizontal);const i=$();this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,i);const r=$();Fs(r,this.startCamera.viewForward);const s=$();re(s,Kae);const n=ye(r,s),o=Bl(n<0?-n:n);if(this.panMode=o>=EVe.ANGLE_THRESHOLD?as.Horizontal:as.Vertical,I6(this.planeHorizontal,i,this.planeHorizontal),this.startCamera.aboveGround||D6(this.planeHorizontal,this.planeHorizontal),this.panMode===as.Vertical){if(se(s,s,n),ue(this.planeVertical,r,s),_e(this.planeVertical,this.planeVertical),I6(this.planeVertical,i,this.planeVertical),!w8()){const a=$(),l=$(),c=$();ue(a,i,this.currentCamera.eye),_e(a,a);const h=5*Math.max(Math.abs(this.view.camera.position.z),50),p=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),this.beginCenterScreen[0],this.beginCenterScreen[1],this.view.state.camera,OVe),f=p?Math.min(p,h):h;re(c,de(l,this.currentCamera.eye,se(l,a,f))),this.planeVertical[3]=-ye(this.planeVertical,c)}this.computePlanePoints(t.pointers,this.planeVertical,this.startCamera,this.tmpPoints),vN(this.tmpPoints,this.beginCenter)}else this.computePlanePoints(t.pointers,this.planeHorizontal,this.startCamera,this.tmpPoints),vN(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}update(t){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const e=t.pointers.size>1,i=this.panMode===as.Horizontal?this.planeHorizontal:this.planeVertical,r=this.beginCenter;if(e){const s=this.beginRadius/t.radius,n=.001875*Math.min(Math.max(t.radius,40),120);this.scalingValueSmooth.gain=n,this.scalingValueSmooth.update(s),yN(this.currentCamera,r,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*t.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Ac(Math.abs(t.radius-this.beginRadius)),Hi(this.view,this.currentCamera,this.constraintOptions)}if(this.computePlanePoints(t.pointers,i,this.currentCamera,this.tmpPoints),vN(this.tmpPoints,this.tmpCentroid3d),Gh(t.center,this.tmpCentroid2d),nae(this.currentCamera,r,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*t.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Ac(this.beginCenterScreen,this.tmpCentroid2d),Hi(this.view,this.currentCamera,this.constraintOptions),e){const s=this.planeHorizontal,n=r,o=this.rotationValueSmooth.value,a=o+mN(t.angle-o),l=.00125*Math.min(Math.max(t.radius,40),120);this.rotationValueSmooth.gain=l,this.rotationValueSmooth.update(a);const c=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(c,.001*t.timestamp),lm(this.currentCamera,n,HS(s,c)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Ac(Math.abs(t.radius*c)),Hi(this.view,this.currentCamera,this.constraintOptions)}}end(t){t.pointers.size===this.pointerCount&&this.update(t),this.finishController();const e=this.zoomMomentumEstimator.evaluateMomentum();if(e)return new Tb({view:this.view,momentum:e,zoomCenter:this.beginCenter});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new z0({view:this.view,momentum:i,center:this.beginCenter,axis:Li(this.planeHorizontal)});const r=this.panMomentumEstimator.evaluateMomentum();return r?new PT({view:this.view,momentum:r}):null}computePlanePoints(t,e,i,r){r.length=t.size;const s=this.tmp2d;let n=0;return t.forEach(o=>{s[0]=o.x,s[1]=o.y,r[n]===void 0&&(r[n]=$()),gN(e,i,s,r[n]),n+=1}),r}};u([d({constructOnly:!0})],DO.prototype,"view",void 0),DO=u([R("esri.views.3d.state.controllers.local.PinchAndPanController")],DO);class ele extends bs{constructor(e,i,r){super(!0),this.view=e,this.pointerAction=i,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",r,s=>this.handleDrag(s))}handleDrag(e){if(e.data.pointerType==="mouse"&&!SN(e.data,this.pointerAction))return;const i=e.timestamp-this.lastEndTimestamp,r=40,s=this.momentum&&this.momentum.active&&i<r;switch(e.data.action){case"start":case"update":if(s)break;this.controller&&this.controller.active?e.data.timestamp-this.lastTimestamp>2&&(this.controller.update(e.data),this.lastTimestamp=e.timestamp):this.startController(e);break;case"end":case"removed":this.endController(e,!0);break;case"added":this.endController(e,!1),this.startController(e)}e.stopPropagation()}endController(e,i){if(this.controller&&this.controller.active){this.lastEndTimestamp=e.timestamp;const r=this.controller.end(e.data);i&&r&&(this.momentum=r,this.view.state.switchCameraController(this.momentum))}this.controller=null}startController(e){this.controller=this.createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(e.data),this.lastTimestamp=e.timestamp}createController(){return this.view.state.isGlobal?new IO({view:this.view}):new DO({view:this.view})}}class RVe extends bs{constructor(e,i){super(!0),this.view=e,this.registerIncoming("pointer-down",i,()=>this.view.state.stopActiveCameraController())}}class tle extends bs{constructor(e,i){super(!0),this.key=e,this.registerIncoming("key-down",i,r=>this._handleKeyDown(r))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}class IVe extends tle{constructor(e,i,r){super(i,r),this.view=e}activate(){this.view.goTo({heading:0}).catch(()=>{})}}class DVe extends tle{constructor(e,i,r){super(i,r),this.view=e}activate(){this.view.goTo({tilt:0}).catch(()=>{})}}class FVe extends bs{constructor(e,i=!1){super(!0),this.view=e,this.invert=i,this.registerIncoming("vertical-two-finger-drag",r=>this.handleTwoFinger(r))}handleTwoFinger(e){var i,r,s;const n=this.invert?-1:1,o=Ii(0,e.data.delta*n);switch(e.data.action){case"begin":(i=this.cameraController)==null||i.end(),this.cameraController=new vb({view:this.view,pivot:0}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(o);break;case"update":(r=this.cameraController)==null||r.update(o);break;case"end":(s=this.cameraController)==null||s.end(),this.cameraController=null}}}function ile(t){const e=t.native;return e?{buttons:e.buttons.map(i=>i.pressed?i.value?i.value:1:0),axes:e.axes.map(i=>zVe(i,t.axisThreshold))}:{buttons:[],axes:[]}}function LVe(t,e){if(t.axes.length!==e.axes.length||t.buttons.length!==e.buttons.length)return!1;for(let i=0;i<t.axes.length;i++)if(t.axes[i]!==e.axes[i])return!1;for(let i=0;i<t.buttons.length;i++)if(t.buttons[i]!==e.buttons[i])return!1;return!0}function kVe(t){for(let e=0;e<t.axes.length;e++)if(t.axes[e]!==0)return!1;for(let e=0;e<t.buttons.length;e++)if(t.buttons[e]!==0)return!1;return!0}function zVe(t,e){const i=Math.abs(t);return i<e?0:Math.sign(t)*(i-e)/(1-e)}class VVe{constructor(e,i){this.element=e,this.input=i,this._hasEventListeners=!1,this.onConnectGamepad=n=>{this.connectGamepad(n.gamepad)},this.onDisconnectGamepad=n=>{const o=n.gamepad,a=o.index,l=this.inputDevices[a];l&&(this.emitGamepadEvent(o,ile(l),!1),this.inputDevices.splice(a,1),this.latestUpdate.splice(a,1),this.input.gamepad.devices.remove(l),this.ensurePollingState())},this.frameTask=null,this.latestUpdate=new Array,this.inputDevices=new Array,this.callback=null;const r="getGamepads"in window.navigator,s=window.isSecureContext;this.supported=r&&s,this.supported&&(this.forEachGamepad(n=>this.connectGamepad(n)),window.addEventListener("gamepadconnected",this.onConnectGamepad),window.addEventListener("gamepaddisconnected",this.onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this.onConnectGamepad),window.removeEventListener("gamepaddisconnected",this.onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get eventsEnabled(){return this.supported&&this.inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this.callback=e}connectGamepad(e){const i=new j9(e);i.deviceType!=="unknown"&&(this.inputDevices[e.index]=i,this.input.gamepad.devices.add(i)),this.ensurePollingState()}ensurePollingState(){this.eventsEnabled?this.startPolling():this.stopPolling()}startPolling(){this.frameTask==null&&(this.frameTask=gg({update:()=>this.readGamepadState()}))}stopPolling(){this.frameTask!=null&&(this.frameTask.remove(),this.frameTask=null,this.latestUpdate=new Array)}readGamepadState(){const e=document.hasFocus(),i=this.element.contains(document.activeElement),r=this.input.gamepad.enabledFocusMode==="document"&&!e||this.input.gamepad.enabledFocusMode==="view"&&!i;this.forEachGamepad(s=>{const n=this.inputDevices[s.index];if(!n)return;const o=this.latestUpdate[s.index],a=ile(n),l=r||kVe(a);o&&(o.timestamp===s.timestamp||!o.active&&l||LVe(o.state,a))||this.emitGamepadEvent(s,a,!l)})}forEachGamepad(e){const i=window.navigator.getGamepads();for(let r=0;r<i.length;r++){const s=i[r];this.validate(s)&&e(s)}}emitGamepadEvent(e,i,r){const s=this.latestUpdate[e.index],n=s&&s.active;if(!n&&!r)return;const o=!n&&r?"start":n&&r?"update":"end";this.latestUpdate[e.index]={timestamp:e.timestamp,state:i,active:r},this.callback&&this.callback({device:this.inputDevices[e.index],state:i,action:o})}validate(e){if(!e||!e.connected)return!1;for(let i=0;i<e.axes.length;i++)if(isNaN(e.axes[i]))return!1;return!0}}const rle=ae("trident"),sle=ae("edge"),NVe=ae("chrome"),UVe=ae("ff"),jVe=ae("safari"),Cb={touchNone:"esri-view-surface--touch-none",touchPan:"esri-view-surface--touch-pan"};class FO{constructor(e,i){this.input=i,this._active={},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=e,e.getAttribute("tabindex")||e.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new VVe(e,this.input),this._gamepadSource.onEvent=r=>this._callback("gamepad",r)}destroy(){this._callback=null,this.activeEvents=null,this._activePointerCaptures.forEach(e=>{this._releasePointerCaptureSafe(e)}),this._gamepadSource&&(this._gamepadSource.destroy(),this._gamepadSource=null),this._activePointerCaptures=null,this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(e){this._browserTouchPanningEnabled=e,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(e){this._callback=e}set activeEvents(e){for(const i in this._active)if(!e||!e.has(i)){const r=this._active[i];this._element.removeEventListener(FN[i],r),delete this._active[i]}e&&e.forEach(i=>{if(!this._active[i]&&FN[i]){const r=(this._eventHandlers[i]||this._handleDefault).bind(this,i);this._element.addEventListener(FN[i],r),this._active[i]=r}}),this._gamepadSource.hasEventListeners=e&&e.has("gamepad")}setPointerCapture(e,i){i?(this._element.setPointerCapture(e.pointerId),this._activePointerCaptures.add(e.pointerId)):(this._releasePointerCaptureSafe(e.pointerId),this._activePointerCaptures.delete(e.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?Cb.touchNone:Cb.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?Cb.touchPan:Cb.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(Cb.touchNone),this._element.classList.remove(Cb.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_releasePointerCaptureSafe(e){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(e))return;this._element.releasePointerCapture(e)}catch{}}_updateNormalizedPointerLikeEvent(e,i){const r=Zre(this._element,e);return FO.test.disableSubpixelCoordinates&&(r.x=Math.round(r.x),r.y=Math.round(r.y)),i.x=r.x,i.y=r.y,i}_handleKey(e,i){const r=yFe(i);r&&e==="key-up"&&this._keyDownState.delete(r);const s={native:i,key:r,repeat:r&&this._keyDownState.has(r)};r&&e==="key-down"&&this._keyDownState.add(s.key),this._callback(e,s)}_handlePointer(e,i){const r=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,pointerType:i.pointerType,button:i.button,buttons:i.buttons,eventId:this._eventId++});this._callback(e,r)}_handlePointerPreventDefault(e,i){const r=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,pointerType:i.pointerType,button:i.button,buttons:i.buttons,eventId:this._eventId++});i.preventDefault(),this._callback(e,r)}_handleMouseWheel(e,i){let r=i.deltaY;switch(i.deltaMode){case 0:(rle||sle)&&(r=r/document.documentElement.clientHeight*600);break;case 1:r*=30;break;case 2:r*=900}rle||sle?r*=.7:NVe||jVe?r*=.6:UVe&&(r*=1.375);const s=100,n=Math.abs(r);if(n>s){const a=.02;r=r/n*200/(1+Math.exp(-a*(n-s)))}const o=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,deltaY:r});this._callback(e,o)}_handlePointerCaptureLost(e,i){this._activePointerCaptures.delete(i.pointerId),this._handleDefault(e,i)}_handleDefault(e,i){const r={native:i};i.preventDefault(),this._callback(e,r)}_preventAltKeyDefault(e){e.key==="Alt"&&e.preventDefault()}_preventMultiTouchPanning(e){e.touches.length>1&&e.preventDefault()}}FO.test={disableSubpixelCoordinates:!1};const FN={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};class BVe extends bs{constructor(){super(!0),this.registerIncoming("context-menu",e=>{e.data.native.preventDefault()})}}function nle(t,e){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}function GVe(t,e){const i=e.x-t.x,r=e.y-t.y;return Math.sqrt(i*i+r*r)}function qVe(t,e){if(e?(e.radius=0,e.center.x=0,e.center.y=0):e={radius:0,center:Zl()},t.length===0)return e;if(t.length===1)return e.center.x=t[0].x,e.center.y=t[0].y,e;if(t.length===2){const[T,C]=t,[M,P]=[C.x-T.x,C.y-T.y];return e.radius=Math.sqrt(M*M+P*P)/2,e.center.x=(T.x+C.x)/2,e.center.y=(T.y+C.y)/2,e}let i=0,r=0;for(let T=0;T<t.length;T++)i+=t[T].x,r+=t[T].y;i/=t.length,r/=t.length;const s=t.map(T=>T.x-i),n=t.map(T=>T.y-r);let o=0,a=0,l=0,c=0,h=0,p=0,f=0;for(let T=0;T<s.length;T++){const C=s[T],M=n[T],P=C*C,F=M*M;o+=P,a+=F,l+=C*M,c+=P*C,h+=F*M,p+=C*F,f+=M*P}const g=.5*(c+p),y=.5*(h+f),v=o*a-l*l,b=(g*a-y*l)/v,w=(o*y-l*g)/v,S=Zl(b+i,w+r);return{radius:Math.sqrt(b*b+w*w+(o+a)/t.length),center:S}}class HVe extends bs{constructor(e){super(!1),this.navigationTouch=e,this.startStateModifiers=new Set,this.activePointerMap=new Map,this.isDragging=!1,this.isCurrentDragSuppressed=!1,this.drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this.handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this.handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this.handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this.handlePointerUpAndPointerLost.bind(this))}createPayload(e,i,r,s){return{action:e,pointerType:this.pointerType,button:this.mouseButton,buttons:i.buttons,timestamp:s,pointers:WVe(this.activePointerMap),pointer:i,angle:r.angle,radius:r.radius,center:r.center}}addPointer(e){const i=e.native.pointerId,r=LO(this.activePointerMap).angle,s={event:e,initialAngle:0,lastAngle:0};this.activePointerMap.set(i,s);const n=kO(s,ole(this.activePointerMap));s.initialAngle=n,s.lastAngle=n,this.updatePointerAngles(r)}updatePointer(e){if(e&&e.x==null&&e.y==null)return;const i=e.native.pointerId,r=this.activePointerMap.get(i);r?r.event=e:this.addPointer(e)}removePointer(e){const i=LO(this.activePointerMap).angle;this.activePointerMap.delete(e),this.updatePointerAngles(i)}updatePointerAngles(e){const i=LO(this.activePointerMap);this.activePointerMap.forEach(r=>{r.initialAngle=kO(r,i)-e,r.lastAngle=kO(r,i)-e})}emitEvent(e,i,r){const s=LO(this.activePointerMap);this.drag.emit(this.createPayload(e,i,s,r),void 0,this.startStateModifiers)}handlePointerUpAndPointerLost(e){const i=e.data.native.pointerId,r=Ft(e.timestamp);this.activePointerMap.get(i)&&(this.activePointerMap.size===1?(this.updatePointer(e.data),!this.isCurrentDragSuppressed&&this.emitEvent("end",e.data,r),this.isDragging=!1,this.isCurrentDragSuppressed=!1,this.removePointer(i)):(this.removePointer(i),this.emitEvent("removed",e.data,Ft(e.timestamp))))}handlePointerDrag(e){const i=e.data,r=i.currentEvent,s=Ft(e.timestamp);switch(i.action){case"start":case"update":this.isDragging?this.activePointerMap.has(r.native.pointerId)?(this.updatePointer(r),!this.isCurrentDragSuppressed&&this.emitEvent("update",r,s)):(this.addPointer(r),this.emitEvent("added",r,s),this.isCurrentDragSuppressed=this.isSuppressed):(this.updatePointer(r),this.pointerType=e.data.startEvent.pointerType,this.mouseButton=e.data.startEvent.button,this.startStateModifiers=e.modifiers,this.isDragging=!0,this.isCurrentDragSuppressed=this.isSuppressed,!this.isCurrentDragSuppressed&&this.emitEvent("start",r,s))}}get isSuppressed(){return this.navigationTouch&&!this.navigationTouch.browserTouchPanEnabled&&this.pointerType==="touch"&&this.activePointerMap.size===1}}function ole(t){const e=[];return t.forEach(i=>{e.push(Zl(i.event.x,i.event.y))}),qVe(e)}function LO(t){const e=ole(t);let i=0;return t.forEach(r=>{let s=kO(r,e),n=s-r.lastAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;s=r.lastAngle+n,r.lastAngle=s,i+=s-r.initialAngle}),i/=t.size||1,{angle:i,radius:e.radius,center:e.center}}function WVe(t){const e=new Map;return t.forEach((i,r)=>e.set(r,i.event)),e}function kO(t,e){const i=t.event,r=i.x-e.center.x,s=i.y-e.center.y;return Math.atan2(s,r)}var ale;(function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right",t[t.Back=3]="Back",t[t.Forward=4]="Forward",t[t.Undefined=-1]="Undefined"})(ale||(ale={}));const ym={maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};class ZVe extends bs{constructor(e=ym.maximumDoubleClickDelay,i=ym.maximumDoubleClickDistance,r=ym.maximumDoubleTouchDelay,s=ym.maximumDoubleTouchDistance,n=BC){super(!1),this.maximumDoubleClickDelay=e,this.maximumDoubleClickDistance=i,this.maximumDoubleTouchDelay=r,this.maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",this._handleImmediateClick.bind(this)),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("drag",this._handleDrag.bind(this))}onUninstall(){this._pointerState.forEach(e=>{e.doubleClickTimeout!=null&&(e.doubleClickTimeout.remove(),e.doubleClickTimeout=null)})}get hasPendingInputs(){return vr(this._pointerState,e=>e.doubleClickTimeout!=null)}_pointerId(e){const i=e.native;return i.pointerType==="mouse"?`${i.pointerId}:${i.button}`:`${i.pointerType}`}_handleImmediateClick(e){const i=e.data,r=this._pointerId(i),s=this._pointerState.get(r);if(s){const n=i.native.pointerType==="touch"?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;nle(s.event.data,i)>n?(this._clearDoubleClickTimeout(r,!0),this._startClick(e)):(this._clearDoubleClickTimeout(r,!1),this._doubleClick.emit(s.event.data,void 0,s.event.modifiers))}else this._startClick(e)}_startClick(e){const i=this._pointerId(e.data),r=e.data.native.pointerType==="touch"?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;this._pointerState.set(i,{event:e,doubleClickTimeout:this._clock.setTimeout(()=>this._doubleClickTimeoutExceeded(i),r)}),this.refreshHasPendingInputs()}_handlePointerDrag(e){const i=this._pointerId(e.data.currentEvent);this._clearDoubleClickTimeout(i,!0)}_handleDrag(e){const i=this._pointerId(e.data.pointer);this._clearDoubleClickTimeout(i,!0)}_clearDoubleClickTimeout(e,i){const r=this._pointerState.get(e);r&&(r.doubleClickTimeout.remove(),r.doubleClickTimeout=null,i&&this._doubleClickTimeoutExceeded(e),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const i=this._pointerState.get(e);this._click.emit(i.event.data,void 0,i.event.modifiers),i.doubleClickTimeout=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}}class JVe extends bs{constructor(e=ym.maximumDoubleClickDelay,i=ym.maximumDoubleClickDistance,r=ym.maximumDoubleTouchDelay,s=ym.maximumDoubleTouchDistance,n=BC){super(!1),this.maximumDoubleClickDelay=e,this.maximumDoubleClickDistance=i,this.maximumDoubleTouchDelay=r,this.maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",o=>{this._handlePointerLoss(o,"pointer-up")}),this.registerIncoming("pointer-capture-lost",o=>{this._handlePointerLoss(o,"pointer-capture-lost")}),this.registerIncoming("pointer-cancel",o=>{this._handlePointerLoss(o,"pointer-cancel")})}onUninstall(){this._pointerState.forEach(e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()}),super.onUninstall()}_handlePointerDown(e){const i=e.data,r=this._pointerId(i);if(!this._pointerState.has(r)){const s={downButton:i.native.button,immediateDoubleClick:null};this._pointerState.set(r,s),this.startCapturingPointer(i.native)}}_handlePointerLoss(e,i){const r=e.data,s=this._pointerId(r),n=this._pointerState.get(s);if(n&&i==="pointer-up"&&n.downButton===r.native.button){const o=n.immediateDoubleClick;if(o){o.timeoutHandle.remove();const a=e.data.native.pointerType==="touch"?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;nle(o,e.data)>a?this._startImmediateDoubleClick(e,n):(this._immediateDoubleClick.emit(e.data,void 0,o.modifiers),this._removeState(r))}else this._startImmediateDoubleClick(e,n)}}_startImmediateDoubleClick(e,i){const r=e.data.native.pointerType==="touch"?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;i.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout(()=>this._removeState(e.data),r)}}_pointerId(e){const i=e.native;return i.pointerType==="mouse"?`${i.pointerId}:${i.button}`:`${i.pointerType}`}_removeState(e){const i=this._pointerId(e);this._pointerState.delete(i),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}}const AT={maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500};class QVe extends bs{constructor(e=AT.maximumClickDelay,i=AT.movementUntilMouseDrag,r=AT.movementUntilPenDrag,s=AT.movementUntilTouchDrag,n=AT.holdDelay,o=BC){super(!1),this.maximumClickDelay=e,this.movementUntilMouseDrag=i,this.movementUntilPenDrag=r,this.movementUntilTouchDrag=s,this.holdDelay=n,this._clock=o,this._pointerState=new Map,this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",a=>{this._handlePointerLoss(a,"pointer-up")}),this.registerIncoming("pointer-capture-lost",a=>{this._handlePointerLoss(a,"pointer-capture-lost")}),this.registerIncoming("pointer-cancel",a=>{this._handlePointerLoss(a,"pointer-cancel")}),this._moveHandle=this.registerIncoming("pointer-move",this._handlePointerMove.bind(this)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach(e=>{e.holdTimeout!=null&&(e.holdTimeout.remove(),e.holdTimeout=null)}),super.onUninstall()}_handlePointerDown(e){const i=e.data,r=i.native.pointerId;let s=null;this._pointerState.size===0&&(s=this._clock.setTimeout(()=>{const o=this._pointerState.get(r);if(o){if(!o.isDragging){const a=o.previousEvent;this._pointerHold.emit(a,void 0,e.modifiers),o.holdEmitted=!0}o.holdTimeout=null}},this.holdDelay));const n={startEvent:i,previousEvent:i,startTimestamp:e.timestamp,isDragging:!1,downButton:i.native.button,holdTimeout:s,modifiers:new Set};this._pointerState.set(r,n),this.startCapturingPointer(i.native),this._moveHandle.resume(),this._pointerState.size>1&&this.startDragging(e)}_createPointerDragData(e,i,r){return{action:e,startEvent:i.startEvent,previousEvent:i.previousEvent,currentEvent:r}}_handlePointerMove(e){const i=e.data,r=i.native.pointerId,s=this._pointerState.get(r);s&&(s.isDragging?this._pointerDrag.emit(this._createPointerDragData("update",s,i),void 0,s.modifiers):GVe(i,s.startEvent)>this._getDragThreshold(i.native.pointerType)&&this.startDragging(e),s.previousEvent=i)}_getDragThreshold(e){switch(e){case"touch":return this.movementUntilTouchDrag;case"pen":return this.movementUntilPenDrag;default:return this.movementUntilMouseDrag}}startDragging(e){const i=e.data,r=i.native.pointerId;this._pointerState.forEach(s=>{s.holdTimeout!=null&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging||(s.modifiers=e.modifiers,s.isDragging=!0,r===s.startEvent.native.pointerId?this._pointerDrag.emit(this._createPointerDragData("start",s,i)):this._pointerDrag.emit(this._createPointerDragData("start",s,s.previousEvent),e.timestamp))})}_handlePointerLoss(e,i){const r=e.data,s=r.native.pointerId,n=this._pointerState.get(s);n&&(n.holdTimeout!=null&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging?this._pointerDrag.emit(this._createPointerDragData("end",n,i==="pointer-up"?r:n.previousEvent),void 0,n.modifiers):i==="pointer-up"&&n.downButton===r.native.button&&e.timestamp-n.startTimestamp<=this.maximumClickDelay&&!n.holdEmitted&&this._immediateClick.emit(r),this._pointerState.delete(s),this.stopCapturingPointer(r.native),this._pointerState.size===0&&this._moveHandle.pause())}}class YVe{constructor(e){this.callbacks=e,this.currentCount=0,this.callbacks.condition||(this.callbacks.condition=()=>!0)}handle(e){const i=e.data,r=i.pointers.size;switch(i.action){case"start":this.currentCount=r,this.emitStart(e);break;case"added":this.emitEnd(this.previousEvent),this.currentCount=r,this.emitStart(e);break;case"update":this.emitUpdate(e);break;case"removed":this.startEvent&&this.emitEnd(this.previousEvent),this.currentCount=r,this.emitStart(e);break;case"end":this.emitEnd(e),this.currentCount=0}this.previousEvent=e}emitStart(e){this.startEvent=e,this.callbacks.condition(this.currentCount,e)&&this.callbacks.start(this.currentCount,e,this.startEvent)}emitUpdate(e){this.callbacks.condition(this.currentCount,e)&&this.callbacks.update(this.currentCount,e,this.startEvent)}emitEnd(e){this.callbacks.condition(this.currentCount,e)&&this.callbacks.end(this.currentCount,e,this.startEvent),this.startEvent=null}}class XVe extends bs{constructor(e=20,i=40){super(!1),this._threshold=e,this._maxDelta=i,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new YVe({start:(r,s)=>this.observeStart(r,s),update:(r,s,n)=>this.observeUpdate(r,s,n),end:(r,s)=>this.observeEnd(s)}),this.registerIncoming("drag",r=>this.dragEventSeparator.handle(r))}get failed(){return this.state==="failed"}observeStart(e,i){e===1&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),i.stopPropagation()),this.state=e===2?"ready":"failed"}observeUpdate(e,i,r){if(this.state!=="failed"&&e===2)return this.state==="active"?(this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void i.stopPropagation()):void(this.checkMovementWithinLimits(i.data,r.data)?this.checkVerticalThresholdReached(i.data,r.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=i.data.center,this._artificalDrag.emit({action:"end",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),i.stopPropagation()):this.state="failed")}observeEnd(e){this.state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",e.stopPropagation())}checkMovementWithinLimits(e,i){let r=-1/0,s=1/0,n=-1/0,o=1/0;i.pointers.forEach(v=>{r=Math.max(r,v.x),s=Math.min(s,v.x),n=Math.max(n,v.y),o=Math.min(o,v.y)});let a=-1/0,l=1/0,c=-1/0,h=1/0;e.pointers.forEach(v=>{a=Math.max(a,v.x),l=Math.min(l,v.x),c=Math.max(c,v.y),h=Math.min(h,v.y)});const p=r-s,f=n-o,g=a-l,y=c-h;return Math.abs(e.center.x-i.center.x)<this._threshold&&Math.abs(g-p)<=this._maxDelta&&Math.abs(y-f)<=this._maxDelta}checkVerticalThresholdReached(e,i){let r=Math.abs(e.center.y-i.center.y);return e.pointers.forEach((s,n)=>{const o=i.pointers.get(n);r=Math.min(r,Math.abs(s.y-o.y))}),r>=this._threshold}}let Rd=class extends ve{constructor(){super(...arguments),this._handles=new dt}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(t){t!=="pan"&&t!=="rotate"||t===this._get("primaryDragAction")||(this._set("primaryDragAction",t),this._updateMode())}get mode(){return this._get("mode")}set mode(t){t!=="default"&&t!=="pro"||t===this._get("mode")||(this._set("mode",t),this._updateMode())}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null)}connect(){const t=this.view;this._source=new FO(this.view.surface,t.input);const e=[new JVe,new QVe,new ZVe,new HVe(this.view.navigation),new XVe],i=new t0({eventSource:this._source,recognizers:e});this._inputManager=i,i.installHandlers("prevent-context-menu",[new BVe],If.INTERNAL),this._modeDragPan=new ele(t,"primary"),this._modeDragRotate=new MN(t,"secondary",0),this._modeDragZoom=new N9e(t,"tertiary");const r={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};i.installHandlers("navigation",[new RVe(t),new z9e(t),new xVe(t),new SVe(t,r.pan),new TVe(t),new DVe(t,r.resetTilt),new IVe(t,r.resetHeading),new MN(t,"primary",1,[r.lookAround]),new MN(t,"secondary",0,[r.lookAround]),new ele(t,"tertiary",[r.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new FVe(t)],If.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),Ke(this.view.navigation,"browserTouchPanEnabled",s=>{this._source.browserTouchPanningEnabled=!s})}_updateMode(){const t=this.mode,e=this.primaryDragAction,i=LN.get(t).get(e);this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom)}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};u([d()],Rd.prototype,"view",void 0),u([d({value:"pan"})],Rd.prototype,"primaryDragAction",null),u([d({value:"default"})],Rd.prototype,"mode",null),u([d({readOnly:!0,aliasOf:"_inputManager.hasPendingInputs"})],Rd.prototype,"hasPendingInputs",void 0),u([d({readOnly:!0,aliasOf:"_inputManager.latestPointerType"})],Rd.prototype,"latestPointerType",void 0),u([d()],Rd.prototype,"_inputManager",void 0),Rd=u([R("esri.views.3d.input.SceneInputManager")],Rd);const LN=new Map,kN=new Map,zN=new Map;kN.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),kN.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),zN.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),zN.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),LN.set("default",kN),LN.set("pro",zN);const KVe=Rd;let Wi=class extends ve{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1}};u([d()],Wi.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),u([d()],Wi.prototype,"SCENEVIEW_LOCKING_LOG",void 0),u([d()],Wi.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),u([d()],Wi.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),u([d()],Wi.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),u([d()],Wi.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),u([d()],Wi.prototype,"DECONFLICTOR_SHOW_GRID",void 0),u([d()],Wi.prototype,"LABELS_SHOW_BORDER",void 0),u([d()],Wi.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),u([d()],Wi.prototype,"OVERLAY_SHOW_CENTER",void 0),u([d()],Wi.prototype,"SHOW_POI",void 0),u([d()],Wi.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),u([d()],Wi.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),u([d()],Wi.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),u([d()],Wi.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),u([d()],Wi.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),u([d()],Wi.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),u([d()],Wi.prototype,"I3S_TREE_SHOW_TILES",void 0),u([d()],Wi.prototype,"I3S_SHOW_MODIFICATIONS",void 0),u([d()],Wi.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),u([d()],Wi.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),u([d()],Wi.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),Wi=u([R("esri.views.3d.support.DebugFlags")],Wi);const Kt=new Wi;let fa,Mb,VN=!1,NN=!1,UN=!1,jN=!1,$T=null;function eNe(t,e){if(!NN||!Mb)return;lle();const i=Mb;let r=0;for(let s=0;s<t.accBinsNumX;s++)for(let n=0;n<t.accBinsNumY;n++){const o=t.accBins[s][t.accBinsNumY-1-n];r+=o.length;const a=s*t.accBinsSizeX,l=(s+1)*t.accBinsSizeX,c=n*t.accBinsSizeY,h=(n+1)*t.accBinsSizeY;i.fillText(o.length.toFixed(),a+5,c+15),cle(a,l,c,h,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+e.size,70,50),i.fillText("total numTests: "+t.accNumTests,70,30)}function tNe(t){UN=Kt.DECONFLICTOR_SHOW_VISIBLE,jN=Kt.DECONFLICTOR_SHOW_INVISIBLE,VN=UN||jN,NN=Kt.DECONFLICTOR_SHOW_GRID,$T=null,VN||NN?$T=()=>iNe(t):fa&&(fa.parentElement.removeChild(fa),fa=null)}function lle(){$T&&($T(),$T=null)}function iNe(t){fa==null&&(fa=document.createElement("canvas"),fa.setAttribute("id","canvas2d"),t.surface.parentElement.style.position="relative",t.surface.parentElement.appendChild(fa));const e=t.width*t.pixelRatio,i=t.height*t.pixelRatio;fa.setAttribute("width",`${e}px`),fa.setAttribute("height",`${i}px`),fa.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${t.width}px;height:${t.height}px`),Mb=fa.getContext("2d"),Mb.clearRect(0,0,t.width,t.height),Mb.font="12px Arial"}function cle(t,e,i,r,s){lle();const n=fa.height,o=Mb;o.beginPath(),o.lineWidth=1,o.strokeStyle=s,o.moveTo(t,n-i),o.lineTo(e,n-i),o.stroke(),o.lineTo(e,n-r),o.stroke(),o.lineTo(e,n-i),o.stroke(),o.lineTo(t,n-i),o.stroke(),o.lineTo(t,n-i),o.stroke(),o.closePath()}function rNe(t,e){VN&&(e&&UN||!e&&jN)&&cle(t.aabr[0],t.aabr[2],t.aabr[1],t.aabr[3],e?"green":"red")}function ule(t,e){return new zO(t,mle,e)}function sNe(t,e){const{curvatureDependent:i,scaleStart:r,scaleFallOffRange:s}=mle;return new zO(t,{curvatureDependent:{min:{curvature:i.min.curvature,tiltAngle:i.min.tiltAngle,scaleFallOffFactor:GN.curvatureDependent.min.scaleFallOffFactor},max:{curvature:i.max.curvature,tiltAngle:i.max.tiltAngle,scaleFallOffFactor:GN.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:s,minPixelSize:GN.minPixelSize},e)}function nNe(t){return Math.abs(t*t*t)}function hle(t,e,i){const r=i.parameters,s=i.paddingPixelsOverride;return ET.scale=Math.min(r.divisor/(e-r.offset),1),ET.factor=nNe(t),ET.minPixelSize=r.minPixelSize,ET.paddingPixels=s,ET}function dle(t,e){return t===0?e.minPixelSize:e.minPixelSize*(1+2*e.paddingPixels/t)}function BN(t,e){return Math.max(Et(t*e.scale,t,e.factor),dle(t,e))}function oNe(t,e,i){const r=hle(t,e,i);return r.minPixelSize=0,r.paddingPixels=0,BN(1,r)}function ple(t,e,i,r){r.scale=oNe(t,e,i),r.factor=0,r.minPixelSize=i.parameters.minPixelSize,r.paddingPixels=i.paddingPixelsOverride}function fle(t,e,i=[0,0]){const r=Math.min(Math.max(e.scale,dle(t[1],e)/t[1]),1);return i[0]=t[0]*r,i[1]=t[1]*r,i}function aNe(t,e,i,r){return BN(t,hle(e,i,r))}class zO{constructor(e,i,r,s=lNe(),n){this.viewingMode=e,this.description=i,this.ellipsoidRadius=r,this.parameters=s,this._paddingPixelsOverride=n,this.viewingMode===2?(this.coverageCompensation=this.surfaceCoverageCompensationLocal,this.calculateCurvatureDependentParameters=this.calculateCurvatureDependentParametersLocal):(this.coverageCompensation=this.surfaceCoverageCompensationGlobal,this.calculateCurvatureDependentParameters=this.calculateCurvatureDependentParametersGlobal)}get paddingPixelsOverride(){return this._paddingPixelsOverride||this.parameters.paddingPixels}update(e){return(!this.parameters||this.parameters.camera.fovY!==e.fovY||this.parameters.camera.distance!==e.distance)&&(this.calculateParameters(e,this.ellipsoidRadius,this.parameters),!0)}overridePadding(e){return e!==this.paddingPixelsOverride?new zO(this.viewingMode,this.description,this.ellipsoidRadius,this.parameters,e):this}calculateParameters(e,i,r){const{scaleStart:s,scaleFallOffRange:n,minPixelSize:o}=this.description,{fovY:a,distance:l}=e,c=this.calculateCurvatureDependentParameters(e,i),h=this.coverageCompensation(e,i,c),{tiltAngle:p,scaleFallOffFactor:f}=c,g=Math.sin(p)*l,y=.5*Math.PI-p-a*(.5-s*h),v=g/Math.cos(y),b=y+a*n*h,w=(v-f*(g/Math.cos(b)))/(1-f);return r.camera.fovY=e.fovY,r.camera.distance=e.distance,r.offset=w,r.divisor=v-w,r.minPixelSize=o,r}calculateCurvatureDependentParametersLocal(e,i,r=gle){return r.tiltAngle=this.description.curvatureDependent.min.tiltAngle,r.scaleFallOffFactor=this.description.curvatureDependent.min.scaleFallOffFactor,r}calculateCurvatureDependentParametersGlobal(e,i,r=gle){const s=this.description.curvatureDependent,n=1+e.distance/i,o=Math.sqrt(n*n-1),[a,l]=[s.min.curvature,s.max.curvature],c=Re((o-a)/(l-a),0,1),[h,p]=[s.min,s.max];return r.tiltAngle=Et(h.tiltAngle,p.tiltAngle,c),r.scaleFallOffFactor=Et(h.scaleFallOffFactor,p.scaleFallOffFactor,c),r}surfaceCoverageCompensationLocal(e,i,r){return(e.fovY-r.tiltAngle)/e.fovY}surfaceCoverageCompensationGlobal(e,i,r){const s=i*i,n=r.tiltAngle+.5*Math.PI,{fovY:o,distance:a}=e,l=a*a+s-2*Math.cos(n)*a*i,c=Math.sqrt(l),h=Math.sqrt(l-s);return(Math.acos(h/c)-Math.asin(i/(c/Math.sin(n)))+.5*o)/o}}const mle={curvatureDependent:{min:{curvature:nt(10),tiltAngle:nt(12),scaleFallOffFactor:.5},max:{curvature:nt(70),tiltAngle:nt(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},GN={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};function lNe(){return{camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0}}const ET={scale:0,factor:0,minPixelSize:0,paddingPixels:0},gle={tiltAngle:0,scaleFallOffFactor:0};function cNe(t){return t instanceof Float32Array&&t.length>=16}function uNe(t){return Array.isArray(t)&&t.length>=16}function hNe(t){return cNe(t)||uNe(t)}class yle{constructor(e,i){this._material=e,this._repository=i,this._map=new Map}destroy(){this._map.forEach((e,i)=>{_(e)&&this._repository.release(this._material,N0(i))})}load(e,i){this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,N0(i)));const r=this._map.get(i);if(_(r)){if(r.ensureResources(e)===2)return r;this._repository.requestRender()}return null}}function N0(t){switch(t){default:case 0:return 0;case 1:return 7;case 4:case 7:case 6:return 3;case 3:return 2;case 2:return 1;case 5:return 4}}class vm{constructor(e){this._material=e.material,this._techniqueRep=e.techniqueRep,this._output=e.output}dispose(){this._techniqueRep.release(this._technique)}get technique(){return this._technique}ensureTechnique(e,i,r=this._output){return this._technique=this._techniqueRep.releaseAndAcquire(e,this._material.getTechniqueConfig(r,i),this._technique),this._technique}ensureResources(e){return 2}}class vle extends vm{constructor(e){super(e),this._numLoading=0,this._disposed=!1,this._textureRepository=e.textureRep,this._textureId=e.textureId,this._acquire(e.textureId).then(i=>this._texture=i),this._acquire(e.normalTextureId).then(i=>this._textureNormal=i),this._acquire(e.emissiveTextureId).then(i=>this._textureEmissive=i),this._acquire(e.occlusionTextureId).then(i=>this._textureOcclusion=i),this._acquire(e.metallicRoughnessTextureId).then(i=>this._textureMetallicRoughness=i)}dispose(){this._texture=nr(this._texture),this._textureNormal=nr(this._textureNormal),this._textureEmissive=nr(this._textureEmissive),this._textureOcclusion=nr(this._textureOcclusion),this._textureMetallicRoughness=nr(this._textureMetallicRoughness),this._disposed=!0}ensureResources(e){return this._numLoading===0?2:1}updateTexture(e){(A(this._texture)||e!==this._texture.id)&&(this._texture=nr(this._texture),this._textureId=e,this._acquire(this._textureId).then(i=>this._texture=i))}bindTextures(e){_(this._texture)&&e.bindTexture(this._texture.glTexture,"tex"),_(this._textureNormal)&&e.bindTexture(this._textureNormal.glTexture,"normalTexture"),_(this._textureEmissive)&&e.bindTexture(this._textureEmissive.glTexture,"texEmission"),_(this._textureOcclusion)&&e.bindTexture(this._textureOcclusion.glTexture,"texOcclusion"),_(this._textureMetallicRoughness)&&e.bindTexture(this._textureMetallicRoughness.glTexture,"texMetallicRoughness")}bindTextureScale(e){const i=_(this._texture)?this._texture.glTexture:null;_(i)&&i.descriptor.textureCoordinateScaleFactor?e.setUniform2fv("textureCoordinateScaleFactor",i.descriptor.textureCoordinateScaleFactor):e.setUniform2f("textureCoordinateScaleFactor",1,1)}_acquire(e){return A(e)?Promise.resolve(null):(++this._numLoading,this._textureRepository.acquire(e).then(i=>this._disposed?(nr(i),null):i).finally(()=>--this._numLoading))}}const VO=lr();function NO(t,e,i,r,s,n,o){if(!pT(e))if(t.boundingInfo){Ze(t.primitiveType===0);const a=i.tolerance;_le(t.boundingInfo,r,s,a,n,o)}else{const a=t.indices.get("position"),l=t.vertexAttributes.get("position");OT(r,s,0,a.length/3,a,l,void 0,n,o)}}const dNe=$();function _le(t,e,i,r,s,n){if(A(t))return;const o=Sle(e,i,dNe);if(ZW(VO,t.getBBMin()),JW(VO,t.getBBMax()),_(s)&&s.applyToAabb(VO),qN(VO,e,o,r)){const{primitiveIndices:a,indices:l,position:c}=t,h=a?a.length:l.length/3;if(h>yNe){const p=t.getChildren();if(p!==void 0){for(let f=0;f<8;++f)p[f]!==void 0&&_le(p[f],e,i,r,s,n);return}}OT(e,i,0,h,l,c,a,s,n)}}const ble=$();function OT(t,e,i,r,s,n,o,a,l){if(o)return pNe(t,e,i,r,s,n,o,a,l);const c=n.data,h=n.stride||n.size,p=t[0],f=t[1],g=t[2],y=e[0]-p,v=e[1]-f,b=e[2]-g;for(let w=i,S=3*i;w<r;++w){let T=h*s[S++],C=c[T++],M=c[T++],P=c[T];T=h*s[S++];let F=c[T++],z=c[T++],D=c[T];T=h*s[S++];let U=c[T++],G=c[T++],k=c[T];_(a)&&([C,M,P]=a.applyToVertex(C,M,P,w),[F,z,D]=a.applyToVertex(F,z,D,w),[U,G,k]=a.applyToVertex(U,G,k,w));const j=F-C,V=z-M,q=D-P,J=U-C,O=G-M,L=k-P,N=v*L-O*b,B=b*J-L*y,W=y*O-J*v,Y=j*N+V*B+q*W;if(Math.abs(Y)<=Number.EPSILON)continue;const H=p-C,K=f-M,fe=g-P,ce=H*N+K*B+fe*W;if(Y>0){if(ce<0||ce>Y)continue}else if(ce>0||ce<Y)continue;const me=K*q-V*fe,Ie=fe*j-q*H,He=H*V-j*K,$e=y*me+v*Ie+b*He;if(Y>0){if($e<0||ce+$e>Y)continue}else if($e>0||ce+$e<Y)continue;const Le=(J*me+O*Ie+L*He)/Y;Le>=0&&l(Le,RT(j,V,q,J,O,L,ble),w,!1)}}function pNe(t,e,i,r,s,n,o,a,l){const c=n.data,h=n.stride||n.size,p=t[0],f=t[1],g=t[2],y=e[0]-p,v=e[1]-f,b=e[2]-g;for(let w=i;w<r;++w){const S=o[w];let T=3*S,C=h*s[T++],M=c[C++],P=c[C++],F=c[C];C=h*s[T++];let z=c[C++],D=c[C++],U=c[C];C=h*s[T];let G=c[C++],k=c[C++],j=c[C];_(a)&&([M,P,F]=a.applyToVertex(M,P,F,w),[z,D,U]=a.applyToVertex(z,D,U,w),[G,k,j]=a.applyToVertex(G,k,j,w));const V=z-M,q=D-P,J=U-F,O=G-M,L=k-P,N=j-F,B=v*N-L*b,W=b*O-N*y,Y=y*L-O*v,H=V*B+q*W+J*Y;if(Math.abs(H)<=Number.EPSILON)continue;const K=p-M,fe=f-P,ce=g-F,me=K*B+fe*W+ce*Y;if(H>0){if(me<0||me>H)continue}else if(me>0||me<H)continue;const Ie=fe*J-q*ce,He=ce*V-J*K,$e=K*q-V*fe,Le=y*Ie+v*He+b*$e;if(H>0){if(Le<0||me+Le>H)continue}else if(Le>0||me+Le<H)continue;const Ei=(O*Ie+L*He+N*$e)/H;Ei>=0&&l(Ei,RT(V,q,J,O,L,N,ble),S,!1)}}const wle=$(),xle=$();function RT(t,e,i,r,s,n,o){return ne(wle,t,e,i),ne(xle,r,s,n),Ye(o,wle,xle),_e(o,o),o}function Sle(t,e,i){return ne(i,1/(e[0]-t[0]),1/(e[1]-t[1]),1/(e[2]-t[2]))}function qN(t,e,i,r){return HN(t,e,i,r,1/0)}function HN(t,e,i,r,s){const n=(t[0]-r-e[0])*i[0],o=(t[3]+r-e[0])*i[0];let a=Math.min(n,o),l=Math.max(n,o);const c=(t[1]-r-e[1])*i[1],h=(t[4]+r-e[1])*i[1];if(l=Math.min(l,Math.max(c,h)),l<0||(a=Math.max(a,Math.min(c,h)),a>l))return!1;const p=(t[2]-r-e[2])*i[2],f=(t[5]+r-e[2])*i[2];return l=Math.min(l,Math.max(p,f)),!(l<0)&&(a=Math.max(a,Math.min(p,f)),!(a>l)&&a<s)}function Tle(t,e,i,r,s){let n=(i.screenLength||0)*t.pixelRatio;s&&(n=aNe(n,r,e,s));const o=n*Math.tan(.5*t.fovY)/(.5*t.fullHeight);return Re(o*e,i.minWorldLength||0,i.maxWorldLength!=null?i.maxWorldLength:1/0)}function IT(t,e,i){if(!t)return;const r=t.parameters,s=t.paddingPixelsOverride;e.setUniform4f(i,r.divisor,r.offset,r.minPixelSize,s)}function Cle(t,e){const i=e?Cle(e):{};for(const r in t){let s=t[r];s&&s.forEach&&(s=gNe(s)),s==null&&r in i||(i[r]=s)}return i}function fNe(t,e){let i=!1;for(const r in e){const s=e[r];s!==void 0&&(i=!0,Array.isArray(s)?t[r]=s.slice():t[r]=s)}return i}function mNe(t,e,i,r,s,n){if(!e.options.selectionMode)return;const o=t.vertexAttributes.get("position").data,a=t.vertexAttributes.get("size"),l=a&&a.data[0],c=r[0],h=r[1],p=((l+s)/2+4)*t.screenToWorldRatio;let f=Number.MAX_VALUE,g=0;for(let y=0;y<o.length-5;y+=3){const v=o[y],b=o[y+1],w=c-v,S=h-b,T=o[y+3]-v,C=o[y+4]-b,M=Re((T*w+C*S)/(T*T+C*C),0,1),P=T*M-w,F=C*M-S,z=P*P+F*F;z<f&&(f=z,g=y/3)}f<p*p&&n(i.dist,i.normal,g,!1)}function gNe(t){const e=[];return t.forEach(i=>e.push(i)),e}const WN={multiply:1,ignore:2,replace:3,tint:4},yNe=1e3;class Id extends ab{constructor(e,i){super(),this.type=3,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._insertOrder=0,this._vertexAttributeLocations=Ht,this._parameters=Cle(e,i),this.validateParameters(this._parameters)}dispose(){}get parameters(){return this._parameters}update(e){return!1}setParameters(e){fNe(this._parameters,e)&&(this.validateParameters(this._parameters),this.parametersChanged())}validateParameters(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.parametersChanged())}shouldRender(e){return this.isVisible()&&this.isVisibleInPass(e.pass)&&(this.renderOccluded&e.renderOccludedMask)!=0}isVisibleInPass(e){return!0}get renderOccluded(){return this.parameters.renderOccluded}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this.parametersChanged())}get insertOrder(){return this._insertOrder}set insertOrder(e){e!==this._insertOrder&&(this._insertOrder=e,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){_(this.repository)&&this.repository.materialChanged(this)}}const Gu={renderOccluded:1};function vNe(t,e,i,r){const s=i.typedBuffer,n=i.typedBufferStride,o=t.length;r*=n;for(let a=0;a<o;++a){const l=2*t[a];s[r]=e[l],s[r+1]=e[l+1],r+=n}}function Mle(t,e,i,r,s){const n=i.typedBuffer,o=i.typedBufferStride,a=t.length;if(r*=o,s==null||s===1)for(let l=0;l<a;++l){const c=3*t[l];n[r]=e[c],n[r+1]=e[c+1],n[r+2]=e[c+2],r+=o}else for(let l=0;l<a;++l){const c=3*t[l];for(let h=0;h<s;++h)n[r]=e[c],n[r+1]=e[c+1],n[r+2]=e[c+2],r+=o}}function Pb(t,e,i,r,s=1){const n=i.typedBuffer,o=i.typedBufferStride,a=t.length;if(r*=o,s===1)for(let l=0;l<a;++l){const c=4*t[l];n[r]=e[c],n[r+1]=e[c+1],n[r+2]=e[c+2],n[r+3]=e[c+3],r+=o}else for(let l=0;l<a;++l){const c=4*t[l];for(let h=0;h<s;++h)n[r]=e[c],n[r+1]=e[c+1],n[r+2]=e[c+2],n[r+3]=e[c+3],r+=o}}function UO(t,e,i,r,s,n=1){if(!i)return void Mle(t,e,r,s,n);const o=r.typedBuffer,a=r.typedBufferStride,l=t.length,c=i[0],h=i[1],p=i[2],f=i[4],g=i[5],y=i[6],v=i[8],b=i[9],w=i[10],S=i[12],T=i[13],C=i[14];if(s*=a,n===1)for(let M=0;M<l;++M){const P=3*t[M],F=e[P],z=e[P+1],D=e[P+2];o[s]=c*F+f*z+v*D+S,o[s+1]=h*F+g*z+b*D+T,o[s+2]=p*F+y*z+w*D+C,s+=a}else for(let M=0;M<l;++M){const P=3*t[M],F=e[P],z=e[P+1],D=e[P+2],U=c*F+f*z+v*D+S,G=h*F+g*z+b*D+T,k=p*F+y*z+w*D+C;for(let j=0;j<n;++j)o[s]=U,o[s+1]=G,o[s+2]=k,s+=a}}function ZN(t,e,i,r,s,n=1){if(!i)return void Mle(t,e,r,s,n);const o=i,a=r.typedBuffer,l=r.typedBufferStride,c=t.length,h=o[0],p=o[1],f=o[2],g=o[4],y=o[5],v=o[6],b=o[8],w=o[9],S=o[10],T=!YL(o),C=1e-6,M=1-C;if(s*=l,n===1)for(let P=0;P<c;++P){const F=3*t[P],z=e[F],D=e[F+1],U=e[F+2];let G=h*z+g*D+b*U,k=p*z+y*D+w*U,j=f*z+v*D+S*U;if(T){const V=G*G+k*k+j*j;if(V<M&&V>C){const q=1/Math.sqrt(V);G*=q,k*=q,j*=q}}a[s+0]=G,a[s+1]=k,a[s+2]=j,s+=l}else for(let P=0;P<c;++P){const F=3*t[P],z=e[F],D=e[F+1],U=e[F+2];let G=h*z+g*D+b*U,k=p*z+y*D+w*U,j=f*z+v*D+S*U;if(T){const V=G*G+k*k+j*j;if(V<M&&V>C){const q=1/Math.sqrt(V);G*=q,k*=q,j*=q}}for(let V=0;V<n;++V)a[s+0]=G,a[s+1]=k,a[s+2]=j,s+=l}}function _Ne(t,e,i,r,s,n=1){if(!i)return void Pb(t,e,r,s,n);const o=i,a=r.typedBuffer,l=r.typedBufferStride,c=t.length,h=o[0],p=o[1],f=o[2],g=o[4],y=o[5],v=o[6],b=o[8],w=o[9],S=o[10],T=!YL(o),C=1e-6,M=1-C;if(s*=l,n===1)for(let P=0;P<c;++P){const F=4*t[P],z=e[F],D=e[F+1],U=e[F+2],G=e[F+3];let k=h*z+g*D+b*U,j=p*z+y*D+w*U,V=f*z+v*D+S*U;if(T){const q=k*k+j*j+V*V;if(q<M&&q>C){const J=1/Math.sqrt(q);k*=J,j*=J,V*=J}}a[s+0]=k,a[s+1]=j,a[s+2]=V,a[s+3]=G,s+=l}else for(let P=0;P<c;++P){const F=4*t[P],z=e[F],D=e[F+1],U=e[F+2],G=e[F+3];let k=h*z+g*D+b*U,j=p*z+y*D+w*U,V=f*z+v*D+S*U;if(T){const q=k*k+j*j+V*V;if(q<M&&q>C){const J=1/Math.sqrt(q);k*=J,j*=J,V*=J}}for(let q=0;q<n;++q)a[s+0]=k,a[s+1]=j,a[s+2]=V,a[s+3]=G,s+=l}}function jO(t,e,i,r,s,n=1){const o=r.typedBuffer,a=r.typedBufferStride,l=t.length;if(s*=a,n===1){if(i===4)for(let c=0;c<l;++c){const h=4*t[c];o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=e[h+3],s+=a}else if(i===3)for(let c=0;c<l;++c){const h=3*t[c];o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=255,s+=a}}else if(i===4)for(let c=0;c<l;++c){const h=4*t[c];for(let p=0;p<n;++p)o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=e[h+3],s+=a}else if(i===3)for(let c=0;c<l;++c){const h=3*t[c];for(let p=0;p<n;++p)o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=255,s+=a}}function BO(t,e,i,r,s,n){for(const o of e.fieldNames){const a=t.vertexAttributes.get(o),l=t.indices.get(o);if(a&&l)switch(o){case"position":{Ze(a.size===3);const c=s.getField(o,Wt);c&&UO(l,a.data,i,c,n);break}case"normal":{Ze(a.size===3);const c=s.getField(o,Wt);c&&ZN(l,a.data,r,c,n);break}case"uv0":{Ze(a.size===2);const c=s.getField(o,rl);c&&vNe(l,a.data,c,n);break}case"color":{Ze(a.size===3||a.size===4);const c=s.getField(o,Hn);c&&jO(l,a.data,a.size,c,n);break}case"symbolColor":{Ze(a.size===3||a.size===4);const c=s.getField(o,Hn);c&&jO(l,a.data,a.size,c,n);break}case"tangent":{Ze(a.size===4);const c=s.getField(o,Zr);c&&_Ne(l,a.data,r,c,n);break}}}}function Zi(t,e){if(e.slicePlaneEnabled){t.extensions.add("GL_OES_standard_derivatives"),e.sliceEnabledForVertexPrograms&&(t.vertex.uniforms.add("slicePlaneOrigin","vec3"),t.vertex.uniforms.add("slicePlaneBasis1","vec3"),t.vertex.uniforms.add("slicePlaneBasis2","vec3")),t.fragment.uniforms.add("slicePlaneOrigin","vec3"),t.fragment.uniforms.add("slicePlaneBasis1","vec3"),t.fragment.uniforms.add("slicePlaneBasis2","vec3");const i=x`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
#define rejectBySlice(_pos_) sliceByPlane(_pos_)
#define discardBySlice(_pos_) { if (sliceByPlane(_pos_)) discard; }`,r=x`vec4 applySliceHighlight(vec4 color, vec3 pos) {
SliceFactors factors = calculateSliceFactors(pos);
if (sliceByFactors(factors)) {
return color;
}
const float HIGHLIGHT_WIDTH = 1.0;
const vec4 HIGHLIGHT_COLOR = vec4(0.0, 0.0, 0.0, 0.3);
factors.front /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.front);
factors.side0 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side0);
factors.side1 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side1);
factors.side2 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side2);
factors.side3 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side3);
float highlightFactor = (1.0 - step(0.5, factors.front))
* (1.0 - step(0.5, factors.side0))
* (1.0 - step(0.5, factors.side1))
* (1.0 - step(0.5, factors.side2))
* (1.0 - step(0.5, factors.side3));
return mix(color, vec4(HIGHLIGHT_COLOR.rgb, color.a), highlightFactor * HIGHLIGHT_COLOR.a);
}`,s=e.sliceHighlightDisabled?x`#define highlightSlice(_color_, _pos_) (_color_)`:x`
        ${r}
        #define highlightSlice(_color_, _pos_) (sliceEnabled() ? applySliceHighlight(_color_, _pos_) : (_color_))
      `;e.sliceEnabledForVertexPrograms&&t.vertex.code.add(i),t.fragment.code.add(i),t.fragment.code.add(s)}else{const i=x`#define rejectBySlice(_pos_) false
#define discardBySlice(_pos_) {}
#define highlightSlice(_color_, _pos_) (_color_)`;e.sliceEnabledForVertexPrograms&&t.vertex.code.add(i),t.fragment.code.add(i)}}function _m(t,e,i){Ab(t,e,i.slicePlane,i.origin)}function Ab(t,e,i,r){e.slicePlaneEnabled&&(_(i)?(r?(ue(Ple,i.origin,r),t.setUniform3fv("slicePlaneOrigin",Ple)):t.setUniform3fv("slicePlaneOrigin",i.origin),t.setUniform3fv("slicePlaneBasis1",i.basis1),t.setUniform3fv("slicePlaneBasis2",i.basis2)):(t.setUniform3fv("slicePlaneBasis1",Fn),t.setUniform3fv("slicePlaneBasis2",Fn),t.setUniform3fv("slicePlaneOrigin",Fn)))}const Ple=$();function JN(t){t.vertex.code.add(x`float screenSizePerspectiveMinSize(float size, vec4 factor) {
float nonZeroSize = 1.0 - step(size, 0.0);
return (
factor.z * (
1.0 +
nonZeroSize *
2.0 * factor.w / (
size + (1.0 - nonZeroSize)
)
)
);
}`),t.vertex.code.add(x`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),t.vertex.code.add(x`vec4 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec4 params) {
return vec4(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z,
params.w
);
}`),t.vertex.code.add(x`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec4 factor) {
return max(mix(size * factor.x, size, factor.y), screenSizePerspectiveMinSize(size, factor));
}`),t.vertex.code.add(x`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),t.vertex.code.add(x`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec4 factor) {
return mix(size * clamp(factor.x, screenSizePerspectiveMinSize(size.y, factor) / size.y, 1.0), size, factor.y);
}`),t.vertex.code.add(x`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function bNe(t,e){if(e.screenSizePerspective){IT(e.screenSizePerspective,t,"screenSizePerspective");const i=e.screenSizePerspectiveAlignment||e.screenSizePerspective;IT(i,t,"screenSizePerspectiveAlignment")}}function Ale(t,e){const i=t;i.include(JN),i.attributes.add("position","vec3"),i.attributes.add("normal","vec3"),i.attributes.add("auxpos1","vec4"),i.vertex.uniforms.add("proj","mat4"),i.vertex.uniforms.add("view","mat4"),i.vertex.uniforms.add("viewNormal","mat4"),i.vertex.uniforms.add("viewport","vec4"),i.vertex.uniforms.add("camPos","vec3"),i.vertex.uniforms.add("polygonOffset","float"),i.vertex.uniforms.add("cameraGroundRelative","float"),i.vertex.uniforms.add("pixelRatio","float"),i.vertex.uniforms.add("perDistancePixelRatio","float"),i.vertex.uniforms.add("uRenderTransparentlyOccludedHUD","float"),e.verticalOffsetEnabled&&i.vertex.uniforms.add("verticalOffset","vec4"),e.screenSizePerspectiveEnabled&&i.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4"),i.vertex.uniforms.add("hudVisibilityTexture","sampler2D"),i.vertex.constants.add("smallOffsetAngle","float",.984807753012208),i.vertex.code.add(x`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),i.vertex.code.add(x`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),e.isDraped||i.vertex.code.add(x`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`),i.vertex.code.add(x`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${e.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(camPos - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${e.screenSizePerspectiveEnabled&&(e.verticalOffsetEnabled||e.screenCenterOffsetUnitsEnabled===1)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${e.verticalOffsetEnabled?e.screenSizePerspectiveEnabled?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${e.verticalOffsetEnabled?x`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${e.screenCenterOffsetUnitsEnabled!==1?x`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${e.screenCenterOffsetUnitsEnabled===1?e.screenSizePerspectiveEnabled?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${e.screenCenterOffsetUnitsEnabled===1?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),i.vertex.code.add(x`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (uRenderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * uRenderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}function $le(t,e){t.setUniform1f("uRenderTransparentlyOccludedHUD",e.renderTransparentlyOccludedHUD===0?1:e.renderTransparentlyOccludedHUD===1?0:.75)}function Ele(t){t.include(Lr),t.uniforms.add("geometryDepthTexture","sampler2D"),t.uniforms.add("cameraNearFar","vec2"),t.code.add(x`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, cameraNearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}function Ole(t,e){e.multipassGeometryEnabled&&e.geometryLinearDepthTexture&&t.bindTexture(e.geometryLinearDepthTexture,"geometryDepthTexture")}function wNe(t,e){e.multipassGeometryEnabled&&t.vertex.include(Ele),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(x`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${e.multipassGeometryEnabled?x`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${e.multipassTerrainEnabled?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),e.multipassTerrainEnabled&&t.fragment.include(Lr),t.fragment.uniforms.add("terrainDepthTexture","sampler2D"),t.fragment.uniforms.add("cameraNearFar","vec2"),t.fragment.uniforms.add("inverseViewport","vec2"),t.fragment.include(zu),t.fragment.code.add(x`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${e.multipassTerrainEnabled?x`

          vec2 uv = gl_FragCoord.xy * inverseViewport;

          //Read the rgba data from the texture linear depth
          vec4 terrainDepthData = texture2D(terrainDepthTexture, uv);

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), cameraNearFar);

          //If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          //Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `)}const xNe=Bt(1,1,0,1),Rle=Bt(1,0,1,1);function Dd(t){t.fragment.uniforms.add("depthTex","sampler2D"),t.fragment.uniforms.add("highlightViewportPixelSz","vec4"),t.fragment.constants.add("occludedHighlightFlag","vec4",xNe).add("unoccludedHighlightFlag","vec4",Rle),t.fragment.code.add(x`void outputHighlight() {
vec4 fragCoord = gl_FragCoord;
float sceneDepth = texture2D(depthTex, (fragCoord.xy - highlightViewportPixelSz.xy) * highlightViewportPixelSz.zw).r;
if (fragCoord.z > sceneDepth + 5e-7) {
gl_FragColor = occludedHighlightFlag;
}
else {
gl_FragColor = unoccludedHighlightFlag;
}
}`)}function Fd(t,e){t.bindTexture(e.highlightDepthTexture,"depthTex"),t.setUniform4f("highlightViewportPixelSz",0,0,e.inverseViewport[0],e.inverseViewport[1])}function $b(t,e){e.vvInstancingEnabled&&(e.vvSize||e.vvColor)&&t.attributes.add("instanceFeatureAttribute","vec4"),e.vvSize?(t.vertex.uniforms.add("vvSizeMinSize","vec3"),t.vertex.uniforms.add("vvSizeMaxSize","vec3"),t.vertex.uniforms.add("vvSizeOffset","vec3"),t.vertex.uniforms.add("vvSizeFactor","vec3"),t.vertex.uniforms.add("vvSymbolRotationMatrix","mat3"),t.vertex.uniforms.add("vvSymbolAnchor","vec3"),t.vertex.code.add(x`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),t.vertex.code.add(x`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${e.vvInstancingEnabled?x`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):t.vertex.code.add(x`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),e.vvColor?(t.vertex.constants.add("vvColorNumber","int",8),t.vertex.code.add(x`
      uniform float vvColorValues[vvColorNumber];
      uniform vec4 vvColorColors[vvColorNumber];

      vec4 vvGetColor(vec4 featureAttribute, float values[vvColorNumber], vec4 colors[vvColorNumber]) {
        float value = featureAttribute.y;
        if (value <= values[0]) {
          return colors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (values[i] >= value) {
            float f = (value - values[i-1]) / (values[i] - values[i-1]);
            return mix(colors[i-1], colors[i], f);
          }
        }
        return colors[vvColorNumber - 1];
      }

      ${e.vvInstancingEnabled?x`
      vec4 vvColor() {
        return vvGetColor(instanceFeatureAttribute, vvColorValues, vvColorColors);
      }`:""}
    `)):t.vertex.code.add(x`vec4 vvColor() { return vec4(1.0); }`)}function QN(t,e){e.vvSizeEnabled&&(t.setUniform3fv("vvSizeMinSize",e.vvSizeMinSize),t.setUniform3fv("vvSizeMaxSize",e.vvSizeMaxSize),t.setUniform3fv("vvSizeOffset",e.vvSizeOffset),t.setUniform3fv("vvSizeFactor",e.vvSizeFactor)),e.vvColorEnabled&&(t.setUniform1fv("vvColorValues",e.vvColorValues),t.setUniform4fv("vvColorColors",e.vvColorColors))}function SNe(t,e){QN(t,e),e.vvOpacityEnabled&&(t.setUniform1fv("vvOpacityValues",e.vvOpacityValues),t.setUniform1fv("vvOpacityOpacities",e.vvOpacityOpacities))}function TNe(t,e){QN(t,e),e.vvSizeEnabled&&(t.setUniform3fv("vvSymbolAnchor",e.vvSymbolAnchor),t.setUniformMatrix3fv("vvSymbolRotationMatrix",e.vvSymbolRotationMatrix))}const GO=.1,tn=.001;function bm(t,e){const i=t.fragment;switch(e.alphaDiscardMode){case 0:i.code.add(x`
        #define discardOrAdjustAlpha(color) { if (color.a < ${x.float(tn)}) { discard; } }
      `);break;case 1:i.code.add(x`void discardOrAdjustAlpha(inout vec4 color) {
color.a = 1.0;
}`);break;case 2:i.uniforms.add("textureAlphaCutoff","float"),i.code.add(x`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } else { color.a = 1.0; } }`);break;case 3:t.fragment.uniforms.add("textureAlphaCutoff","float"),t.fragment.code.add(x`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } }`)}}function CNe(t){const e=new pi,i=t.signedDistanceFieldEnabled;if(e.include(VV),e.include(Ale,t),e.include(Zi,t),t.output===6)return e.include(wNe,t),e;e.include(JN),e.fragment.include(zu),e.fragment.include(yd),e.include($b,t),e.varyings.add("vcolor","vec4"),e.varyings.add("vtc","vec2"),e.varyings.add("vsize","vec2"),t.binaryHighlightOcclusionEnabled&&e.varyings.add("voccluded","float"),e.vertex.uniforms.add("screenOffset","vec2").add("anchorPos","vec2").add("textureCoordinateScaleFactor","vec2").add("materialColor","vec4"),i&&e.vertex.uniforms.add("outlineColor","vec4"),t.screenSizePerspectiveEnabled&&e.vertex.uniforms.add("screenSizePerspective","vec4"),(t.debugDrawBorder||t.binaryHighlightOcclusionEnabled)&&e.varyings.add("debugBorderCoords","vec4"),e.attributes.add("uv0","vec2"),e.attributes.add("color","vec4"),e.attributes.add("size","vec2"),e.attributes.add("auxpos2","vec4"),e.vertex.code.add(x`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${t.screenSizePerspectiveEnabled?x`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:x`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${t.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${t.occlusionTestEnabled||t.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${t.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const r=x`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPos) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,s=t.pixelSnappingEnabled?i?x`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:x`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:x`posProj += quadOffset;`;e.vertex.code.add(x`
      ${t.occlusionTestEnabled?"if (visible) {":""}
      ${r}
      ${t.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

      bool alphaDiscard = vcolor.a < ${x.float(tn)};
      ${i?`alphaDiscard = alphaDiscard && outlineColor.a < ${x.float(tn)};`:""}
      if (alphaDiscard) {
        // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      } else {
        ${s}
        gl_Position = posProj;
      }

      vtc = uv * textureCoordinateScaleFactor;

      ${t.debugDrawBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
      vsize = inputSize;
      ${t.occlusionTestEnabled?x`} else { vtc = vec2(0.0);
        ${t.debugDrawBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
    }
    `),e.fragment.uniforms.add("tex","sampler2D"),i&&(e.fragment.uniforms.add("outlineColor","vec4"),e.fragment.uniforms.add("outlineSize","float"));const n=t.debugDrawBorder?x`(isBorder > 0.0 ? 0.0 : ${x.float(GO)})`:x.float(GO),o=x`
    ${t.debugDrawBorder?x`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${i?x`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = 128.0;
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${n} ||
          fillPixelColor.a + outlinePixelColor.a < ${x.float(tn)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${n}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:x`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${n}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    ${t.debugDrawBorder?x`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder);`:""}
  `;return t.output===7&&e.fragment.code.add(x`
      void main() {
        ${o}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),t.output===0&&e.fragment.code.add(x`
    void main() {
      ${o}
      ${t.FrontFacePass?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),t.output===4&&(e.include(Dd),e.fragment.code.add(x`
    void main() {
      ${o}
      ${t.binaryHighlightOcclusionEnabled?x`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),e}function Ile(t,e,i){t.setUniform4fv("materialColor",e.color),e.textureIsSignedDistanceField&&(e.outlineColor[3]<=0||e.outlineSize<=0?(t.setUniform4fv("outlineColor",I1),t.setUniform1f("outlineSize",0)):(t.setUniform4fv("outlineColor",e.outlineColor),t.setUniform1f("outlineSize",e.outlineSize))),t.setUniform2f("screenOffset",2*e.screenOffset[0]*i,2*e.screenOffset[1]*i),t.setUniform2fv("anchorPos",qO(e))}function qO(t,e=PNe){return t.textureIsSignedDistanceField?MNe(t.anchorPos,t.distanceFieldBoundingBox,e):os(e,t.anchorPos),e}function MNe(t,e,i){i[0]=t[0]*(e[2]-e[0])+e[0],i[1]=t[1]*(e[3]-e[1])+e[1]}const PNe=ke(),ANe=Object.freeze({__proto__:null,build:CNe,bindHUDMaterialUniforms:Ile,calculateAnchorPosForRendering:qO});function Dle(t,e){const i=t.vertex.code;e.verticalOffsetEnabled?(t.vertex.uniforms.add("verticalOffset","vec4"),e.screenSizePerspectiveEnabled&&(t.include(JN),t.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4")),i.add(x`
    vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
      float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
      ${e.viewingMode===1?x`vec3 worldNormal = normalize(worldPos + localOrigin);`:x`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
      ${e.screenSizePerspectiveEnabled?x`
          float cosAngle = dot(worldNormal, normalize(worldPos - camPos));
          float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:x`
          float verticalOffsetScreenHeight = verticalOffset.x;`}
      // Screen sized offset in world space, used for example for line callouts
      float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
      return worldNormal * worldOffset;
    }

    vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
      return worldPos + calculateVerticalOffset(worldPos, localOrigin);
    }
    `)):i.add(x`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}function YN(t,e,i){if(!e.verticalOffset)return;const r=$Ne(e.verticalOffset,i.camera.fovY,i.camera.fullViewport[3]),s=i.camera.pixelRatio||1;t.setUniform4f("verticalOffset",r.screenLength*s,r.perDistance,r.minWorldLength,r.maxWorldLength)}function $Ne(t,e,i,r=ENe){return r.screenLength=t.screenLength,r.perDistance=Math.tan(.5*e)/(.5*i),r.minWorldLength=t.minWorldLength,r.maxWorldLength=t.maxWorldLength,r}const ENe={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0};function ll(t,e){t.fragment.uniforms.add("terrainDepthTexture","sampler2D"),t.fragment.uniforms.add("cameraNearFar","vec2"),t.fragment.uniforms.add("inverseViewport","vec2"),t.fragment.code.add(x`
    // Compare the linearized depths of fragment and terrain. Discard fragments on the wrong side of the terrain.
    void terrainDepthTest(vec4 fragCoord, float fragmentDepth){

      float terrainDepth = linearDepthFromTexture(terrainDepthTexture, fragCoord.xy * inverseViewport, cameraNearFar);
      if(fragmentDepth ${e.cullAboveGround?">":"<="} terrainDepth){
        discard;
      }
    }
  `)}function wm(t,e){e.multipassTerrainEnabled&&e.terrainLinearDepthTexture&&t.bindTexture(e.terrainLinearDepthTexture,"terrainDepthTexture")}const qu=Xs(770,1,771,771),ONe=Qa(1,1),Fle=Qa(0,771);function xm(t){return t===2?null:t===1?Fle:ONe}function XN(t){return t===2?$o:null}const HO=5e5,WO={factor:-1,units:-2};function ZO(t){return t?WO:null}function U0(t){return t===3||t===2?513:515}class DT extends Si{initializeProgram(e){const i=DT.shader.get(),r=this.configuration,s=i.build({output:r.output,FrontFacePass:r.transparencyPassType===2,viewingMode:e.viewingMode,occlusionTestEnabled:r.occlusionTestEnabled,signedDistanceFieldEnabled:r.sdf,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,debugDrawBorder:r.debugDrawBorder,binaryHighlightOcclusionEnabled:r.binaryHighlightOcclusion,screenCenterOffsetUnitsEnabled:r.screenCenterOffsetUnitsEnabled,screenSizePerspectiveEnabled:r.screenSizePerspective,verticalOffsetEnabled:r.verticalOffset,pixelSnappingEnabled:r.pixelSnappingEnabled,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!1,isDraped:r.isDraped,multipassGeometryEnabled:r.multipassGeometryEnabled,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new fi(e.rctx,s,Ht)}bindPass(e,i){Pc(this.program,i.camera.projectionMatrix),this.program.setUniform1f("cameraGroundRelative",i.camera.aboveGround?1:-1),this.program.setUniform1f("perDistancePixelRatio",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",i.camera.viewInverseTransposeMatrix),this.program.setUniform1f("polygonOffset",e.shaderPolygonOffset),YN(this.program,e,i),bNe(this.program,e),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio||1),Une(this.program,i),this.configuration.output===6?(this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Ole(this.program,i),wm(this.program,i)):($le(this.program,i),Ile(this.program,e,i.camera.pixelRatio||1),QN(this.program,e),this.configuration.occlusionTestEnabled&&this.program.bindTexture(i.hudVisibilityTexture,"hudVisibilityTexture")),this.configuration.output===4&&Fd(this.program,i)}bindDraw(e){Yf(this.program,e),Qf(this.program,e.origin,e.camera.viewInverseTransposeMatrix),_m(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e){const i=this.configuration,r=e===3,s=e===2,n=515,o=this.configuration.polygonOffsetEnabled&&RNe,a=(r||s)&&i.output!==4?(i.depthEnabled||i.output===6)&&$o:null;return _t({blending:i.output===0||i.output===7||i.output===4?r?INe:xm(e):null,depthTest:{func:n},depthWrite:a,colorWrite:Pt,polygonOffset:o})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return this.configuration.output===6?0:4}}DT.shader=new vi(ANe,()=>import("./HUDMaterial.glsl.ff0c6920.js"));const RNe={factor:0,units:-4},INe=Qa(1,771);class Qr extends tr{constructor(){super(...arguments),this.output=0,this.occlusionTestEnabled=!0,this.sdf=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.screenSizePerspective=!1,this.screenCenterOffsetUnitsEnabled=0,this.debugDrawBorder=!1,this.binaryHighlightOcclusion=!0,this.slicePlaneEnabled=!1,this.polygonOffsetEnabled=!1,this.depthEnabled=!0,this.transparencyPassType=3,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.multipassGeometryEnabled=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([X({count:8})],Qr.prototype,"output",void 0),u([X()],Qr.prototype,"occlusionTestEnabled",void 0),u([X()],Qr.prototype,"sdf",void 0),u([X()],Qr.prototype,"vvSize",void 0),u([X()],Qr.prototype,"vvColor",void 0),u([X()],Qr.prototype,"verticalOffset",void 0),u([X()],Qr.prototype,"screenSizePerspective",void 0),u([X({count:2})],Qr.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([X()],Qr.prototype,"debugDrawBorder",void 0),u([X()],Qr.prototype,"binaryHighlightOcclusion",void 0),u([X()],Qr.prototype,"slicePlaneEnabled",void 0),u([X()],Qr.prototype,"polygonOffsetEnabled",void 0),u([X()],Qr.prototype,"depthEnabled",void 0),u([X({count:4})],Qr.prototype,"transparencyPassType",void 0),u([X()],Qr.prototype,"pixelSnappingEnabled",void 0),u([X()],Qr.prototype,"isDraped",void 0),u([X()],Qr.prototype,"multipassGeometryEnabled",void 0),u([X()],Qr.prototype,"multipassTerrainEnabled",void 0),u([X()],Qr.prototype,"cullAboveGround",void 0);class Eb extends Id{constructor(e){super(e,BNe),this.techniqueConfig=new Qr}getTechniqueConfig(e,i){return this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?1:0,this.techniqueConfig.polygonOffsetEnabled=this.parameters.polygonOffset,this.techniqueConfig.isDraped=this.parameters.isDraped,this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this.techniqueConfig.sdf=this.parameters.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.parameters.vvColorEnabled,e===0&&(this.techniqueConfig.debugDrawBorder=!!this.parameters.debugDrawBorder),e===4&&(this.techniqueConfig.binaryHighlightOcclusion=this.parameters.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.parameters.depthEnabled,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.multipassGeometryEnabled=i.multipassGeometryEnabled,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}intersect(e,i,r,s,n,o,a,l,c){_(c)?this.intersectDrapedHudGeometry(e,o,a,l,c):this.intersectHudGeometry(e,i,r,s,a,l)}intersectDrapedHudGeometry(e,i,r,s,n){const o=e.vertexAttributes.get("position"),a=e.vertexAttributes.get("size"),l=this.parameters,c=qO(l);let h=1,p=1;if(_(s)){const g=s(Nle);h=g[0],p=g[5]}h*=e.screenToWorldRatio,p*=e.screenToWorldRatio;const f=UNe*e.screenToWorldRatio;for(let g=0;g<o.data.length/o.size;g++){const y=g*o.size,v=o.data[y],b=o.data[y+1],w=g*a.size;let S;Sm[0]=a.data[w]*h,Sm[1]=a.data[w+1]*p,l.textureIsSignedDistanceField&&(S=l.outlineSize*e.screenToWorldRatio/2),kle(i,v,b,Sm,f,S,l,c)&&r(n.dist,n.normal,-1,!0)}}intersectHudGeometry(e,i,r,s,n,o){if(!s.options.selectionMode||!s.options.hud||pT(i))return;const a=this.parameters;let l=1,c=1;if(Ka(e7,r),_(o)){const S=o(Nle);l=S[0],c=S[5],LNe(e7)}const h=e.vertexAttributes.get("position"),p=e.vertexAttributes.get("size"),f=e.vertexAttributes.get("normal"),g=e.vertexAttributes.get("auxpos1");Ze(h.size>=3);const y=s.point,v=s.camera,b=qO(a);l*=v.pixelRatio,c*=v.pixelRatio;const w=this.parameters.centerOffsetUnits==="screen";for(let S=0;S<h.data.length/h.size;S++){const T=S*h.size;ne(wn,h.data[T],h.data[T+1],h.data[T+2]),Oe(wn,wn,r);const C=S*p.size;Sm[0]=p.data[C]*l,Sm[1]=p.data[C+1]*c,Oe(wn,wn,v.viewMatrix);const M=S*g.size;if(ne(Oc,g.data[M+0],g.data[M+1],g.data[M+2]),!w&&(wn[0]+=Oc[0],wn[1]+=Oc[1],Oc[2]!==0)){const F=Oc[2];_e(Oc,wn),ue(wn,wn,se(Oc,Oc,F))}const P=S*f.size;if(ne(FT,f.data[P],f.data[P+1],f.data[P+2]),this.normalAndViewAngle(FT,e7,v,t7),this.applyVerticalOffsetTransformationView(wn,t7,v,KN),v.applyProjection(wn,j0),j0[0]>-1){let F=Math.floor(j0[0])+this.parameters.screenOffset[0],z=Math.floor(j0[1])+this.parameters.screenOffset[1];w&&(F+=Oc[0],Oc[1]!==0&&(z+=BN(Oc[1],KN.factorAlignment))),fle(Sm,KN.factor,Sm);const D=NNe*v.pixelRatio;let U;if(a.textureIsSignedDistanceField&&(U=a.outlineSize*v.pixelRatio/2),kle(y,F,z,Sm,D,U,a,b)){const G=s.ray;if(Oe(Vle,wn,Fi(VNe,v.viewMatrix)),j0[0]=y[0],j0[1]=y[1],v.unprojectFromRenderScreen(j0,wn)){const k=$();re(k,G.direction);const j=1/Te(k);se(k,k,j),n(qt(G.origin,wn)*j,k,-1,!0,1,Vle)}}}}}computeAttachmentOrigin(e,i){const r=e.vertexAttributes;if(!r)return!1;const s=r.get("position"),n=e.indices.get("position");return Yne(s,n,i)}createBufferWriter(){return new qNe(this)}normalAndViewAngle(e,i,r,s){return hNe(i)&&(i=Ka(zNe,i)),fo(s.normal,e,i),Oe(s.normal,s.normal,r.viewInverseTransposeMatrix),s.cosAngle=ye(zle,jNe),s}updateScaleInfo(e,i,r){const s=this.parameters;s.screenSizePerspective?ple(r,i,s.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),s.screenSizePerspectiveAlignment?ple(r,i,s.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}applyShaderOffsetsView(e,i,r,s,n,o,a){const l=this.normalAndViewAngle(i,r,n,t7);return this.applyVerticalGroundOffsetView(e,l,n,a),this.applyVerticalOffsetTransformationView(a,l,n,o),this.applyPolygonOffsetView(a,l,s[3],n,a),this.applyCenterOffsetView(a,s,a),a}applyShaderOffsetsNDC(e,i,r,s,n){return this.applyCenterOffsetNDC(e,i,r,s),_(n)&&re(n,s),this.applyPolygonOffsetNDC(s,i,r,s),s}applyPolygonOffsetView(e,i,r,s,n){const o=s.aboveGround?1:-1;let a=Math.sign(r);a===0&&(a=o);const l=o*a;if(this.parameters.shaderPolygonOffset<=0)return re(n,e);const c=Re(Math.abs(i.cosAngle),.01,1),h=1-Math.sqrt(1-c*c)/c/s.viewport[2];return se(n,e,l>0?h:1/h),n}applyVerticalGroundOffsetView(e,i,r,s){const n=Te(e),o=r.aboveGround?1:-1,a=.5*r.computeRenderPixelSizeAtDist(n),l=se(wn,i.normal,o*a);return de(s,e,l),s}applyVerticalOffsetTransformationView(e,i,r,s){const n=this.parameters;if(!n.verticalOffset||!n.verticalOffset.screenLength){if(n.screenSizePerspective||n.screenSizePerspectiveAlignment){const c=Te(e);this.updateScaleInfo(s,c,i.cosAngle)}else s.factor.scale=1,s.factorAlignment.scale=1;return e}const o=Te(e),a=n.screenSizePerspectiveAlignment||n.screenSizePerspective,l=Tle(r,o,n.verticalOffset,i.cosAngle,a);return this.updateScaleInfo(s,o,i.cosAngle),se(i.normal,i.normal,l),de(e,e,i.normal)}applyCenterOffsetView(e,i,r){const s=this.parameters.centerOffsetUnits!=="screen";return r!==e&&re(r,e),s&&(r[0]+=i[0],r[1]+=i[1],i[2]&&(_e(FT,r),de(r,r,se(FT,FT,i[2])))),r}applyCenterOffsetNDC(e,i,r,s){const n=this.parameters.centerOffsetUnits!=="screen";return s!==e&&re(s,e),n||(s[0]+=i[0]/r.fullWidth*2,s[1]+=i[1]/r.fullHeight*2),s}applyPolygonOffsetNDC(e,i,r,s){const n=this.parameters.shaderPolygonOffset;if(e!==s&&re(s,e),n){const o=r.aboveGround?1:-1,a=o*Math.sign(i[3]);s[2]-=(a||o)*n}return s}requiresSlot(e,i){const r=N0(i);if(r===0||r===7){if(e===20)return!0;const s=this.parameters.drawInSecondSlot?17:16;return this.parameters.occlusionTest&&e===11||e===s}return e===(this.parameters.drawInSecondSlot?17:16)||e===20}createGLMaterial(e){return e.output===0||e.output===7?new DNe(e):e.output===4?new Lle(e):null}calculateRelativeScreenBounds(e,i,r=pt()){return FNe(this.parameters,e,i,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r}}class Lle extends vle{constructor(e){super(E(E({},e),e.material.parameters))}updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this.selectProgram(e)}selectProgram(e){return this.ensureTechnique(DT,e)}beginSlot(e){return this.updateParameters(e)}bind(e,i){this.bindTextures(i.program),this.bindTextureScale(i.program),i.bindPass(this._material.parameters,e)}}class DNe extends Lle{isOcclusionSlot(e){return e.slot===11&&this._material.parameters.occlusionTest&&(this._output===0||this._output===7)}selectProgram(e){return this.ensureTechnique(DT,e,this.isOcclusionSlot(e)?6:this._output)}bind(e,i){this.isOcclusionSlot(e)||(this.bindTextures(i.program),this.bindTextureScale(i.program)),i.bindPass(this._material.parameters,e)}}function FNe(t,e,i,r=kNe){return os(r,t.anchorPos),r[0]*=-e[0],r[1]*=-e[1],r[0]+=t.screenOffset[0]*i,r[1]+=t.screenOffset[1]*i,r}function LNe(t){const e=t[0],i=t[1],r=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=1/Math.sqrt(e*e+i*i+r*r),p=1/Math.sqrt(s*s+n*n+o*o),f=1/Math.sqrt(a*a+l*l+c*c);return t[0]=e*h,t[1]=i*h,t[2]=r*h,t[3]=s*p,t[4]=n*p,t[5]=o*p,t[6]=a*f,t[7]=l*f,t[8]=c*f,t}function kle(t,e,i,r,s,n,o,a){let l=e-s-(a[0]>0?r[0]*a[0]:0),c=l+r[0]+2*s,h=i-s-(a[1]>0?r[1]*a[1]:0),p=h+r[1]+2*s;if(o.textureIsSignedDistanceField){const f=o.distanceFieldBoundingBox;l+=r[0]*f[0],h+=r[1]*f[1],c-=r[0]*(1-f[2]),p-=r[1]*(1-f[3]),l-=n,c+=n,h-=n,p+=n}return t[0]>l&&t[0]<c&&t[1]>h&&t[1]<p}const KN={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},kNe=ke(),wn=$(),FT=$(),j0=ys(),zle=$(),Vle=$(),e7=Ai(),zNe=Ai(),VNe=be(),Oc=$(),t7={normal:zle,cosAngle:0},Nle=be(),NNe=1,UNe=2,Sm=[0,0],jNe=De(0,0,1),BNe=E({texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:Qt(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,pixelSnappingEnabled:!0,debugDrawBorder:!1,isDraped:!1},Gu),GNe=zr().vec3f("position").vec3f("normal").vec2f("uv0").vec4u8("color").vec2f("size").vec4f("auxpos1").vec4f("auxpos2");class qNe{constructor(e){this.material=e,this.vertexBufferLayout=GNe}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get("position").length}write(e,i,r,s){UO(i.indices.get("position"),i.vertexAttributes.get("position").data,e.transformation,r.position,s,6),ZN(i.indices.get("normal"),i.vertexAttributes.get("normal").data,e.invTranspTransformation,r.normal,s,6);{const n=i.vertexAttributes.get("uv0").data;let o,a,l,c;if(n==null||n.length<4){const g=this.material.parameters;o=0,a=0,l=g.texCoordScale[0],c=g.texCoordScale[1]}else o=n[0],a=n[1],l=n[2],c=n[3];l=Math.min(1.99999,l+1),c=Math.min(1.99999,c+1);const h=i.indices.get("position").length,p=r.uv0;let f=s;for(let g=0;g<h;++g)p.set(f,0,o),p.set(f,1,a),f+=1,p.set(f,0,l),p.set(f,1,a),f+=1,p.set(f,0,l),p.set(f,1,c),f+=1,p.set(f,0,l),p.set(f,1,c),f+=1,p.set(f,0,o),p.set(f,1,c),f+=1,p.set(f,0,o),p.set(f,1,a),f+=1}jO(i.indices.get("color"),i.vertexAttributes.get("color").data,4,r.color,s,6);{const n=i.indices.get("size"),o=i.vertexAttributes.get("size").data,a=n.length,l=r.size;let c=s;for(let h=0;h<a;++h){const p=o[2*n[h]],f=o[2*n[h]+1];for(let g=0;g<6;++g)l.set(c,0,p),l.set(c,1,f),c+=1}}i.indices.get("auxpos1")&&i.vertexAttributes.get("auxpos1")&&Pb(i.indices.get("auxpos1"),i.vertexAttributes.get("auxpos1").data,r.auxpos1,s,6),i.indices.get("auxpos2")&&i.vertexAttributes.get("auxpos2")&&Pb(i.indices.get("auxpos2"),i.vertexAttributes.get("auxpos2").data,r.auxpos2,s,6)}}const Hu=$(),Ob=Ot(),LT=Ot(),i7=$(),HNe=be(),WNe=rs(),r7=vs(),ZNe=$(),JNe=pt();class QNe{constructor(){this.aabr=pt(),this.distance=0,this.culled=!1,this.visible=!1}}class YNe{constructor(e,i,r={}){this.graphics3DGraphic=e,this.slicePlaneEnabled=i,this.info=r}}class XNe{constructor(){this.active=new Map,this.visible=new Map}clear(){this.active.clear(),this.visible.clear()}}class KNe{}class e7e{constructor(){this.sortArray=new ct({allocator:e=>e||new KNe})}}class Ule{constructor(){this.camera=new Zt,this.slicePlane=_y(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),V1(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Rb=class extends ve{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new Ule,this._state=0,this.graphics=new XNe,this.iterators=new e7e,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==0||this._dirty}get updatingProgress(){if(!this.updating)return 1;const t=this._state/4;return this._dirty?.5*t:t}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(t){switch(this._state){case 0:this.startUpdate(),t.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(t))return;case 2:if(this._state=2,!this.sortVisibleGraphics(t))return;case 3:if(this._state=3,!this.deconflictVisibleGraphics(t))return;default:eNe(this,this.graphics.visible),this._state=0,this.notifyChange("updating")}}modifyGraphics(t,e){e?t.forEach(i=>this.addToActiveGraphics(i)):t.forEach(i=>this.removeFromActiveGraphics(i)),this.setDirty()}layerSupportsDeconfliction(t){if(A(t)||t.type!=="object3d")return!1;const e=t.stageObject;return(e?e.geometryRecords.length:0)!==1?!1:e.geometryRecords[0].material instanceof Eb}startUpdate(){tNe(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:t,fullHeight:e}=this._runningViewState.camera;this.initBins(t,e),this.resetIterators()}addToActiveGraphics(t){t.info[this.visibilityGroup]=new QNe,this.graphics.active.set(t.graphics3DGraphic.graphic.uid,t),this.setDirty()}removeFromActiveGraphics(t){this.removeFromVisibleGraphics(t),t7e(t,this.visibilityGroup),delete t.info[this.visibilityGroup],this.graphics.active.delete(t.graphics3DGraphic.graphic.uid),this.setDirty()}addToVisibleGraphics(t){this.graphics.visible.set(t.graphics3DGraphic.graphic.uid,t)}removeFromVisibleGraphics(t){this.graphics.visible.delete(t.graphics3DGraphic.graphic.uid)}processActiveGraphics(t){const e=this.ensureActiveGraphicsIterator(),i=Fi(HNe,this._runningViewState.camera.projectionMatrix),r=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._runningViewState.camera.relativeElevation>0?WNe:null;let s=0;for(_(r)&&(Oe(r,Fn,this._runningViewState.camera.viewMatrix),r[3]=Ut(this.view.spatialReference).radius,s=aQ(r,Fn));!t.done;){t.madeProgress();const n=e.next();if(n.done)return this.resetActiveGraphicsIterator(),!0;const o=n.value,a=o&&o.info[this.visibilityGroup];a&&(this.collectGraphics3DGraphics(o,i,r,s),a.culled?this.removeFromVisibleGraphics(o):this.addToVisibleGraphics(o))}return!1}sortVisibleGraphics(t){const e=this.ensureSortGraphicsIterator();for(;!t.done;){const i=e.next();if(t.madeProgress(),i.done)return this.resetSortGraphicsIterator(),!0}return!1}deconflictVisibleGraphics(t){const e=this.ensureVisibleGraphicsIterator(),i=this.visibilityGroup===1;for(;!t.done;){t.madeProgress();const r=e.next();if(r.done)return this.resetVisibleGraphicsIterator(),!0;const s=r.value,n=s.info[this.visibilityGroup];if(!n||n.culled)continue;const o=s.graphics3DGraphic,a=(!i||o.isVisible())&&!this.isConflicted(s);a&&this.addToBins(s),n.visible=a,this.setGraphicVisibility(s,a),rNe(n,a)}return!1}resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null}ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=jle(this.graphics.active)),this.iterators.active}resetActiveGraphicsIterator(){this.iterators.active=null}ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=jle(this.graphics.visible)),this.iterators.visible}resetVisibleGraphicsIterator(){this.iterators.visible=null}ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=i7e(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}resetSortGraphicsIterator(){this.iterators.sort=null}collectGraphics3DGraphics(t,e,i,r){const s=t.graphics3DGraphic;if(s.destroyed)return;const n=t.info[this.visibilityGroup];if(!s.isVisible(0,3))return void(n.culled=!0);const o=this.getGraphicsLayers(s);ja(n.aabr);let a=null;for(const l of o){if(!this.layerSupportsDeconfliction(l))continue;const c=l.stageObject.geometryRecords[0].material;if(A(a)){if(a=this.getProjectionInfo(l,e,n7e),a.isOutsideScreen||this.isCulledBySlice(t,Hu)||_(i)&&this.isCulledByHorizon(a,i,r))return void(n.culled=!0);!Kt.TESTS_DISABLE_OPTIMIZATIONS&&n.visible&&(a.distance*=.7)}this.expandBoundingRect(n,l,c,a)}A(a)?n.culled=!0:(n.distance=a.distance,n.culled=!1)}getProjectionInfo(t,e,i){const r=this._runningViewState.camera,s=t.stageObject,n=s.geometryRecords[0],o=n.material,a=ea(s.boundingVolumeWorldSpace.bounds);Oe(Hu,a,r.viewMatrix);const l=n.geometry.vertexAttributes,c=l.get("normal").data,h=l.get("auxpos1").data;return o.applyShaderOffsetsView(Hu,c,s.transformation,h,r,i.scaleInfo,Hu),Ls(Ob,Hu[0],Hu[1],Hu[2],1),Va(LT,Ob,r.projectionMatrix),se(i.positionNDC,LT,1/LT[3]),o.applyShaderOffsetsNDC(i.positionNDC,h,r,i.positionNDC,i7),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(i7[2]),i.distance=i7[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),Ls(LT,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),Va(Ob,LT,e),gx(Ob,Ob,1/Ob[3]),ne(i.positionView,Hu[0],Hu[1],Hu[2]),i}isCulledByHorizon(t,e,i){return re(r7.direction,t.positionView),ne(r7.origin,0,0,0),!!mf(e,r7,ZNe)&&t.distanceWithoutPolygonOffset>i}isCulledBySlice(t,e){return t.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&N6(this._runningViewState.slicePlane,e)}expandBoundingRect(t,e,i,{positionNDC:r,scaleInfo:s}){const n=this._runningViewState.camera,o=e.getScreenSize(r7e);fle(o,s.factor,o),o[0]*=n.pixelRatio,o[1]*=n.pixelRatio;const a=hP(i.calculateRelativeScreenBounds(o,s.factorAlignment.scale,JNe),Et(0,n.fullWidth,.5+.5*r[0]),Et(0,n.fullHeight,.5+.5*r[1])),l=this.iconMarginFactor;if(l!==0){const c=l*Math.min(Hh(a),Gg(a));a[0]-=c,a[1]-=c,a[2]+=c,a[3]+=c}Gp(t.aabr,a,t.aabr)}isConflicted(t){const e=t.graphics3DGraphic.graphic.uid,i=t.info[this.visibilityGroup];for(let r=Math.floor(i.aabr[0]/this.accBinsSizeX);r<=Math.floor(i.aabr[2]/this.accBinsSizeX);r++)if(!(r<0||r>=this.accBinsNumX))for(let s=Math.floor(i.aabr[1]/this.accBinsSizeY);s<=Math.floor(i.aabr[3]/this.accBinsSizeY);s++){if(s<0||s>=this.accBinsNumY)continue;const n=this.accBins[r][s];for(let o=0;o<n.length;o++){const a=n.data[o],l=a.info[this.visibilityGroup];if(l&&l.visible&&a.graphics3DGraphic.graphic.uid!==e&&(this.accNumTests++,cP(l.aabr,i.aabr)))return!0}}return!1}initBins(t,e){if(this.accBins==null){this.accBins=[];for(let i=0;i<this.accBinsNumX;i++){this.accBins.push([]);const r=this.accBins[this.accBins.length-1];for(let s=0;s<this.accBinsNumY;s++)r.push(new ct)}}else for(let i=0;i<this.accBinsNumX;i++)for(let r=0;r<this.accBinsNumY;r++)this.accBins[i][r].clear();this.accBinsSizeX=t/this.accBinsNumX,this.accBinsSizeY=e/this.accBinsNumY,this.accNumTests=0}addToBins(t){const e=t.info[this.visibilityGroup],i=Math.floor(e.aabr[0]/this.accBinsSizeX),r=Math.floor(e.aabr[2]/this.accBinsSizeX),s=Math.floor(e.aabr[1]/this.accBinsSizeY),n=Math.floor(e.aabr[3]/this.accBinsSizeY);for(let o=i;o<=r;o++)if(!(o<0||o>=this.accBinsNumX))for(let a=s;a<=n;a++)a<0||a>=this.accBinsNumY||this.accBins[o][a].push(t)}setGraphicVisibility(t,e){const i=t.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(3,e,this.visibilityGroup),this.visibilityGroup===1&&this.view.labeler.setLabelGraphicVisibility(i,e))}};function t7e(t,e){const i=t.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(3,e)}function*jle(t){if(Map.prototype.entries){const e=t.entries();for(let i=e.next();!i.done;i=e.next())yield i.value[1]}else yield*t.values()}function*i7e(t,e,i){e.clear(),t.forEach((s,n)=>{const o=e.pushNew();o.id=n,o.prio=s.info?-s.info[i].distance:Number.MAX_VALUE}),yield;const r=e.iterableSort((s,n)=>n.prio-s.prio);for(let s=r.next();!s.done;s=r.next())yield;e.forAll(s=>{const n=t.get(s.id);n&&(t.delete(s.id),t.set(s.id,n))}),e.clear()}u([d({constructOnly:!0})],Rb.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],Rb.prototype,"updating",null),Rb=u([R("esri.views.3d.layers.graphics.Deconflictor")],Rb);const r7e=ke();class s7e{constructor(){this.positionView=$(),this.positionNDC=$(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}const n7e=new s7e,o7e=2e3;let JO=class extends Rb{constructor(){super(...arguments),this.visibilityGroup=1,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(t){if(this.parent.running)return;const e=performance.now();(t.state===2||e-this._lastDeconfliction>o7e)&&(super.runTask(t),this.state===0&&(this._lastDeconfliction=e))}enabledChanged(t,e){this.modifyGraphics(e,t.labelsEnabled)}getGraphicsLayers(t){return t.labelGraphics}};u([d({constructOnly:!0})],JO.prototype,"parent",void 0),JO=u([R("esri.views.3d.layers.graphics.LabelDeconflictor")],JO);let s7=class extends Rb{constructor(){super(...arguments),this._handles=new dt,this._contexts=new Map,this._viewState=new Ule,this.visibilityGroup=0,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([this.view.watch("state.camera",()=>{this.updateViewState(),this.setDirty()}),this.view.watch("map.ground.opacity",(t,e)=>{t!==1&&e!==1||this.setDirty()}),Ke(this.view,"slicePlane",()=>{this.updateSlicePlane(),this.slicePlaneChanged()})]),this._frameTask=this.view.resourceController.scheduler.registerTask(Qe.GRAPHICS_DECONFLICTOR,this),this._labels=new JO({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(t){this._iconMarginFactor=t,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(t){super.runTask(t),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(t,e){const i=!(this._graphicSupportsDeconfliction(e)&&n7(t));e.setVisibilityFlag(3,i,0)}updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this.updateSlicePlane())}updateSlicePlane(){const t=this.view?this.view.slicePlane:null;_(t)&&xQ(t,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=_(t)}slicePlaneChanged(){vr(this._contexts,(t,e)=>e.symbolCreationContext.slicePlaneEnabled)&&this.setDirty()}addGraphicsOwner(t){let e=this._contexts.get(t);return e==null&&(e=new Map,this._contexts.set(t,e),this.setDirty()),{addGraphic:i=>this.addGraphic(t,e,i),removeGraphic:i=>this.removeGraphic(e,i),labelingInfoChange:()=>this._labels.enabledChanged(t,e),featureReductionChange:()=>this.enabledChanged(t,e),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(t,e),clear:()=>e.forEach(i=>this.removeGraphic(e,i.graphics3DGraphic))}}removeGraphicsOwner(t){const e=this._contexts.get(t);e&&(e.forEach(i=>this.removeGraphic(e,i.graphics3DGraphic)),this._contexts.delete(t),this.setDirty())}addGraphic(t,e,i){const r=i.graphic.uid,s=new YNe(i,t.symbolCreationContext.slicePlaneEnabled);e.set(r,s),n7(t)&&this.addToActiveGraphics(s),t.labelsEnabled&&this._labels.addToActiveGraphics(s)}removeGraphic(t,e){const i=e.graphic.uid,r=t.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),t.delete(i),this.setDirty())}enabledChanged(t,e){const i=n7(t);i||a7e(t),this.modifyGraphics(e,i)}_slicePlaneEnabledChanged(t,e){const i=t.symbolCreationContext.slicePlaneEnabled;e.forEach(r=>r.slicePlaneEnabled=i),this.setDirty()}getGraphicsLayers(t){return t.graphics}_graphicSupportsDeconfliction(t){if(t.isDraped)return!1;const e=t.graphics;if(!e||!e.length)return!1;for(const i of e)if(this.layerSupportsDeconfliction(i))return!0;return!1}};function n7(t){const e=t.layer;return!(!e||!e.featureReduction||e.featureReduction.type!=="selection")}function a7e(t){const e=t.graphics3DGraphics;e&&e.forEach(i=>i.clearVisibilityFlag(3))}s7=u([R("esri.views.3d.layers.graphics.GraphicsDeconflictor")],s7);function l7e(t){return 32+t.length}function c7e(){return 16}function Ble(t){if(!t)return 0;let e=32;for(const i in t)if(t.hasOwnProperty(i)){const r=t[i];switch(typeof r){case"string":e+=l7e(r);break;case"number":e+=c7e();break;case"boolean":e+=4}}return e}function fat(t,e){return 32+t.length*e}const o7=(t,e,i)=>[e,i],Ib=(t,e,i)=>[e,i,t[2]],a7=(t,e,i)=>[e,i,t[2],t[3]];function mat(t){return t?{originPosition:t.originPosition==="upper-left"?"upperLeft":t.originPosition==="lower-left"?"lowerLeft":t.originPosition,scale:t.tolerance?[t.tolerance,t.tolerance]:[1,1],translate:_(t.extent)?[t.extent.xmin,t.extent.ymax]:[0,0]}:null}function Gle({scale:t,translate:e},i){return i*t[0]+e[0]}function qle({scale:t,translate:e},i){return e[1]-i*t[1]}function Hle(t,e,i){const r=new Array(i.length);if(!i.length)return r;const[s,n]=t.scale;let o=Gle(t,i[0][0]),a=qle(t,i[0][1]);r[0]=e(i[0],o,a);for(let l=1;l<i.length;l++){const c=i[l];o+=c[0]*s,a-=c[1]*n,r[l]=e(c,o,a)}return r}function Wle(t,e,i){const r=new Array(i.length);for(let s=0;s<i.length;s++)r[s]=Hle(t,e,i[s]);return r}function u7e(t,e,i,r){return Hle(t,i?r?a7:Ib:r?Ib:o7,e)}function h7e(t,e,i,r){return Wle(t,i?r?a7:Ib:r?Ib:o7,e)}function d7e(t,e,i,r){return Wle(t,i?r?a7:Ib:r?Ib:o7,e)}function Zle(t,e,i,r,s){return _(i)&&(e.points=u7e(t,i.points,r,s)),e}function Jle(t,e,i,r,s){return A(i)||(e.x=Gle(t,i.x),e.y=qle(t,i.y),e!==i&&(r&&(e.z=i.z),s&&(e.m=i.m))),e}function Qle(t,e,i,r,s){return _(i)&&(e.rings=d7e(t,i.rings,r,s)),e}function Yle(t,e,i,r,s){return _(i)&&(e.paths=h7e(t,i.paths,r,s)),e}function Xle(t,e){if(t===e)return!0;if(t==null||e==null||t.length!==e.length)return!1;for(let i=0;i<t.length;i++){const r=t[i],s=e[i];if(r.length!==s.length)return!1;for(let n=0;n<r.length;n++)if(r[n]!==s[n])return!1}return!0}function Kle(t,e){if(t===e)return!0;if(t==null||e==null||t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!Xle(t[i],e[i]))return!1;return!0}function p7e(t,e){return!!kT(t.spatialReference,e.spatialReference)&&t.x===e.x&&t.y===e.y&&t.z===e.z&&t.m===e.m}function f7e(t,e){return t.hasZ===e.hasZ&&t.hasM===e.hasM&&!!kT(t.spatialReference,e.spatialReference)&&Kle(t.paths,e.paths)}function m7e(t,e){return t.hasZ===e.hasZ&&t.hasM===e.hasM&&!!kT(t.spatialReference,e.spatialReference)&&Kle(t.rings,e.rings)}function g7e(t,e){return t.hasZ===e.hasZ&&t.hasM===e.hasM&&!!kT(t.spatialReference,e.spatialReference)&&Xle(t.points,e.points)}function y7e(t,e){return t.hasZ===e.hasZ&&t.hasM===e.hasM&&!!kT(t.spatialReference,e.spatialReference)&&t.xmin===e.xmin&&t.ymin===e.ymin&&t.zmin===e.zmin&&t.xmax===e.xmax&&t.ymax===e.ymax&&t.zmax===e.zmax}function kT(t,e){return t===e||t&&e&&t.equals(e)}function v7e(t,e){if(t===e)return!0;if(A(t)||A(e)||t.type!==e.type)return!1;switch(t.type){case"point":return p7e(t,e);case"extent":return y7e(t,e);case"polyline":return f7e(t,e);case"polygon":return m7e(t,e);case"multipoint":return g7e(t,e);case"mesh":return!1;default:return}}function _7e(t,e){if(t===e)return!0;if(!t||!e)return!1;const i=Object.keys(t),r=Object.keys(e);if(i.length!==r.length)return!1;for(const s of i)if(t[s]!==e[s])return!1;return!0}function gat(t,e){return t===e||t!=null&&e!=null&&t.objectId===e.objectId&&!!v7e(t.geometry,e.geometry)&&!!_7e(t.attributes,e.attributes)}class yat{constructor(e,i,r){this.uid=e,this.geometry=i,this.attributes=r,this.visible=!0,this.objectId=null,this.centroid=null}}function vat(t){return _(t.geometry)}class _at{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}}function bat(t){const e=eW.fromJSON(t.geometryType),i=Ue.fromJSON(t.spatialReference),r=t.transform,s=t.features.map(n=>{const o=b7e(n,e,i,t.objectIdFieldName),a=o.geometry;if(_(a)&&r)switch(a.type){case"point":o.geometry=Jle(r,a,a,a.hasZ,a.hasM);break;case"multipoint":o.geometry=Zle(r,a,a,a.hasZ,a.hasM);break;case"polygon":o.geometry=Qle(r,a,a,a.hasZ,a.hasM);break;case"polyline":o.geometry=Yle(r,a,a,a.hasZ,a.hasM);break;case"extent":case"mesh":o.geometry=a}return o});return{geometryType:e,features:s,spatialReference:i,fields:t.fields?t.fields.map(n=>t_.fromJSON(n)):null,objectIdFieldName:t.objectIdFieldName,globalIdFieldName:t.globalIdFieldName,geohashFieldName:t.geohashFieldName,geometryProperties:t.geometryProperties,hasZ:t.hasZ,hasM:t.hasM,exceededTransferLimit:t.exceededTransferLimit,transform:null}}function b7e(t,e,i,r){return{uid:On(),objectId:r&&t.attributes?t.attributes[r]:null,attributes:t.attributes,geometry:w7e(t.geometry,e,i),visible:!0}}function w7e(t,e,i){if(A(t))return null;switch(e){case"point":{const r=t;return{x:r.x,y:r.y,z:r.z,m:r.m,hasZ:r.z!=null,hasM:r.m!=null,type:"point",spatialReference:i}}case"polyline":{const r=t;return{paths:r.paths,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"polyline",spatialReference:i}}case"polygon":{const r=t;return{rings:r.rings,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"polygon",spatialReference:i}}case"multipoint":{const r=t;return{points:r.points,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"multipoint",spatialReference:i}}}}function Ld(t,e,i,r){return{x:t,y:e,z:i,hasZ:i!=null,hasM:!1,spatialReference:r,type:"point"}}function x7e(t){if(A(t))return 0;let e=32;switch(t.type){case"point":e+=42;break;case"polyline":case"polygon":{let i=0;const r=2+(t.hasZ?1:0)+(t.hasM?1:0),s=t.type==="polyline"?t.paths:t.rings;for(const n of s)i+=n.length;e+=8*i*r+64,e+=128*i,e+=34,e+=32*(s.length+1);break}case"multipoint":{const i=2+(t.hasZ?1:0)+(t.hasM?1:0),r=t.points.length;e+=8*r*i+64,e+=128*r,e+=34,e+=32;break}case"extent":e+=98,t.hasM&&(e+=32),t.hasZ&&(e+=32);break;case"mesh":e+=EC(t.vertexAttributes.position),e+=EC(t.vertexAttributes.normal),e+=EC(t.vertexAttributes.uv),e+=EC(t.vertexAttributes.tangent)}return e}function wat(t){let e=32;return e+=Ble(t.attributes),e+=3,e+=8+x7e(t.geometry),e}function S7e(t){if(A(t))return 0;switch(t.type){case"point":return 1;case"polyline":{let e=0;for(const i of t.paths)e+=i.length;return e}case"polygon":{let e=0;for(const i of t.rings)e+=i.length;return e}case"multipoint":return t.points.length;case"extent":return 2;case"mesh":{const e=t.vertexAttributes&&t.vertexAttributes.position;return e?e.length/3:0}default:return}}function xat(t){if(A(t))return!1;switch(t.type){case"extent":case"point":return!0;case"polyline":for(const e of t.paths)if(e.length>0)return!0;return!1;case"polygon":for(const e of t.rings)if(e.length>0)return!0;return!1;case"multipoint":return t.points.length>0;case"mesh":return!t.loaded||t.vertexAttributes.position.length>0}}function Sat(t,e){switch(ii(e),t.type==="mesh"&&(t=t.extent),t.type){case"point":e[0]=e[3]=t.x,e[1]=e[4]=t.y,t.hasZ&&(e[2]=e[5]=t.z);break;case"polyline":for(let i=0;i<t.paths.length;i++)tL(e,t.paths[i],t.hasZ);break;case"polygon":for(let i=0;i<t.rings.length;i++)tL(e,t.rings[i],t.hasZ);break;case"multipoint":tL(e,t.points,t.hasZ);break;case"extent":e[0]=t.xmin,e[1]=t.ymin,e[3]=t.xmax,e[4]=t.ymax,t.zmin!=null&&(e[2]=t.zmin),t.zmax!=null&&(e[5]=t.zmax)}}function T7e(t,e){switch(ja(e),t.type==="mesh"&&(t=t.extent),t.type){case"point":e[0]=e[2]=t.x,e[1]=e[3]=t.y;break;case"polyline":for(let i=0;i<t.paths.length;i++)Q5(e,t.paths[i]);break;case"polygon":for(let i=0;i<t.rings.length;i++)Q5(e,t.rings[i]);break;case"multipoint":Q5(e,t.points);break;case"extent":e[0]=t.xmin,e[1]=t.ymin,e[2]=t.xmax,e[3]=t.ymax}}function Tat(t,e){return t.objectId!=null?t.objectId:t.attributes&&e?t.attributes[e]:null}lr();pt();function ece(t){return"declaredClass"in t}function tce(t){return"declaredClass"in t}function C7e(t){return"declaredClass"in t}function M7e(t,e){if(!t)return null;if(C7e(t))return t;const i=new pn({layer:e,sourceLayer:e});return i.visible=t.visible,i.symbol=ie(t.symbol),i.attributes=ie(t.attributes),i.geometry=ice(t.geometry),i}function ice(t){return A(t)?null:ece(t)?t:Lp(P7e(t))}function P7e(t){const e=t.spatialReference.toJSON();switch(t.type){case"point":{const{x:i,y:r,z:s,m:n}=t;return{x:i,y:r,z:s,m:n,spatialReference:e}}case"polygon":{const{rings:i,hasZ:r,hasM:s}=t;return{rings:rce(i),hasZ:r,hasM:s,spatialReference:e}}case"polyline":{const{paths:i,hasZ:r,hasM:s}=t;return{paths:rce(i),hasZ:r,hasM:s,spatialReference:e}}case"extent":{const{xmin:i,xmax:r,ymin:s,ymax:n,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:h,hasM:p}=t;return{xmin:i,xmax:r,ymin:s,ymax:n,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:h,hasM:p,spatialReference:e}}case"multipoint":{const{points:i,hasZ:r,hasM:s}=t;return{points:nce(i)?sce(i):i,hasZ:r,hasM:s,spatialReference:e}}default:return}}function rce(t){return A7e(t)?t.map(e=>sce(e)):t}function sce(t){return t.map(e=>kye(e))}function A7e(t){for(const e of t)if(e.length!==0)return nce(e);return!1}function nce(t){return t.length&&(UB(t[0])||jB(t[0]))}function $7e(t,e){if(!t)return null;let i;if(tce(t)){if(e==null)return t.clone();if(tce(e))return e.copy(t)}return e!=null?(i=e,i.x=t.x,i.y=t.y,i.spatialReference=t.spatialReference,t.hasZ?(i.z=t.z,i.hasZ=t.hasZ):(i.z=null,i.hasZ=!1),t.hasM?(i.m=t.m,i.hasM=!0):(i.m=null,i.hasM=!1)):(i=Ld(t.x,t.y,t.z,t.spatialReference),t.hasM&&(i.m=t.m,i.hasM=!0)),i}const E7e=le.getLogger("esri.layers.support.labelFormatUtils"),oce={type:"simple",evaluate:()=>null},O7e={getAttribute:(t,e)=>t.field(e)};async function ace(t,e,i){if(!t||!t.symbol)return oce;const r=t.where,s=Q$(t),n=r?await import("./WhereClause.34680e97.js"):null;let o;if(s.type==="arcade"){const a=await Zbe(s.expression,i,e);o={type:"arcade",evaluate(l){try{const c=a.evaluate({$feature:"attributes"in l?a.repurposeFeature(l):a.repurposeAdapter(l)});if(c!=null)return c.toString()}catch{E7e.error(new Q("bad-arcade-expression","Encountered an error when evaluating label expression for feature",{feature:l,expression:s}))}return null},needsHydrationToEvaluate:()=>_9(s.expression)==null}}else o={type:"simple",evaluate:a=>s.expression.replace(/{[^}]*}/g,l=>{const c=l.slice(1,-1),h=e.get(c);if(!h)return l;let p=null;return"attributes"in a?a&&a.attributes&&(p=a.attributes[h.name]):p=a.field(h.name),p==null?"":lce(p,h)})};if(r){let a;try{a=n.WhereClause.create(r,e)}catch{return oce}const l=o.evaluate;o.evaluate=c=>{const h="attributes"in c?void 0:O7e;return a.testFeature(c,h)?l(c):null}}return o}function lce(t,e){if(t==null)return"";const i=e.domain;if(i){if(i.type==="codedValue"||i.type==="coded-value"){const s=t;for(const n of i.codedValues)if(n.code===s)return n.name}else if(i.type==="range"){const s=+t,n="range"in i?i.range[0]:i.minValue,o="range"in i?i.range[1]:i.maxValue;if(n<=s&&s<=o)return i.name}}let r=t;return e.type==="date"||e.type==="esriFieldTypeDate"?r=Nh(r,p5("short-date")):BM(e)&&(r=Uh(+r)),r||""}var Cat=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",createLabelFunction:ace,formatField:lce});function l7(t,e){if(t.type==="point")return Tm(t,e,!1);if(ece(t))switch(t.type){case"extent":return Tm(t.center,e,!1);case"polygon":return Tm(t.centroid,e,!1);case"polyline":return Tm(cce(t),e,!0);case"mesh":return Tm(t.origin,e,!1)}else switch(t.type){case"extent":return Tm(R7e(t),e,!0);case"polygon":return Tm(I7e(t),e,!0);case"polyline":return Tm(cce(t),e,!0)}}function cce(t){const e=t.paths[0];if(!e||e.length===0)return null;const i=zH(e,kH(e)/2);return Ld(i[0],i[1],i[2],t.spatialReference)}function R7e(t){const e=isFinite(t.zmin);return Ld(.5*(t.xmax+t.xmin),.5*(t.ymax+t.ymin),e?.5*(t.zmax+t.zmin):void 0,t.spatialReference)}function I7e(t){const e=t.rings[0];if(!e||e.length===0)return null;const i=VH(t.rings,t.hasZ);return Ld(i[0],i[1],i[2],t.spatialReference)}function Tm(t,e,i){const r=i?t:$7e(t);return e&&t?ySe(t,r,e)?r:null:r}function Mat(t,e,i,r=0){if(t){e||(e=pt());const s=t;let n=.5*s.width*(i-1),o=.5*s.height*(i-1);return s.width<1e-7*s.height?n+=o/20:s.height<1e-7*s.width&&(o+=n/20),Ls(e,s.xmin-n-r,s.ymin-o-r,s.xmax+n+r,s.ymax+o+r),e}return null}function uce(t,e){for(let i=0;i<t.geometries.length;++i){const r=t.geometries[i].getMutableAttribute("auxpos1");r&&r.data[3]!==e&&(r.data[3]=e,t.geometryVertexAttrsUpdated(t.geometryRecords[i]))}}function zT(t,e){const i=x6(wu);return _(t)&&(i[0]=t[0],i[1]=t[1],i[2]=t[2]),_(e)?i[3]=e:_(t)&&t.length>3&&(i[3]=t[3]),i}function Pat(t,e,i,r,s,n=[0,0,0,0]){for(let o=0;o<3;++o)_(t)&&t[o]!=null?n[o]=t[o]:_(i)&&i[o]!=null?n[o]=i[o]:n[o]=s[o];return _(e)?n[3]=e:_(r)?n[3]=r:n[3]=s[3],n}function hce(t=Kc,e,i,r=1){const s=new Array(3);if(A(e)||A(i))s[0]=1,s[1]=1,s[2]=1;else{let n,o=0;for(let a=2;a>=0;a--){const l=t[a];let c;const h=l!=null,p=a===0&&!n&&!h,f=i[a];l==="symbol-value"||p?c=f!==0?e[a]/f:1:h&&l!=="proportional"&&isFinite(l)&&(c=f!==0?l/f:1),c!=null&&(s[a]=c,n=c,o=Math.max(o,Math.abs(c)))}for(let a=2;a>=0;a--)s[a]==null?s[a]=n:s[a]===0&&(s[a]=.001*o)}for(let n=2;n>=0;n--)s[n]/=r;return Dn(s)}function D7e(t){return t.isPrimitive!=null}function QO(t){return D7e(t)&&(t=[t.width,t.depth,t.height]),YO(t)?null:"Symbol sizes may not be negative values"}function YO(t){if(Array.isArray(t)){for(const e of t)if(!YO(e))return!1;return!0}return t==null||t>=0}function F7e(t,e,i,r=be()){const s=t||0,n=e||0,o=i||0;return s!==0&&ly(r,r,-s/180*Math.PI),n!==0&&$1(r,r,n/180*Math.PI),o!==0&&zP(r,r,o/180*Math.PI),r}function c7(t,e){return e.minDemResolution!=null?e.minDemResolution:mP(t)?e.minDemResolutionForPoints:.01*nxe(t)}const VT={"bottom-left":Qt(0,0),bottom:Qt(.5,0),"bottom-right":Qt(1,0),left:Qt(0,.5),center:Qt(.5,.5),right:Qt(1,.5),"top-left":Qt(0,1),top:Qt(.5,1),"top-right":Qt(1,1)};function dce(t,e,i,r,s,n,o,a,l,c,h){const p=B7e[h.mode];let f,g,y=0;if(Mi(t,e,i,r,l.spatialReference,s,a))return p.requiresAlignment(h)?(y=p.applyElevationAlignmentBuffer(r,s,n,o,a,l,c,h),f=n,g=o):(f=r,g=s),Mi(f,l.spatialReference,g,n,c.spatialReference,o,a)?y:void 0}function kd(t,e,i,r,s){const n=(lE(t)?t.z:$re(t)?t.array[t.offset+2]:t[2])||0;switch(i.mode){case"on-the-ground":{const o=st(wc(e,t,"ground"),0);return s.verticalDistanceToGround=0,s.sampledElevation=o,void(s.z=o)}case"relative-to-ground":{const o=st(wc(e,t,"ground"),0),a=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"relative-to-scene":{const o=st(wc(e,t,"scene"),0),a=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"absolute-height":{const o=i.geometryZWithOffset(n,r),a=st(wc(e,t,"ground"),0);return s.verticalDistanceToGround=o-a,s.sampledElevation=a,void(s.z=o)}default:return kn(i.mode),void(s.z=0)}}function L7e(t,e,i,r){return kd(t,e,i,r,Db),Db.z}function NT(t,e,i){return e==null||i==null?t.definedChanged:e==="on-the-ground"&&i==="on-the-ground"?t.staysOnTheGround:e===i||e!=="on-the-ground"&&i!=="on-the-ground"?$i.UPDATE:t.onTheGroundChanged}function cl(t){return t==="relative-to-ground"||t==="relative-to-scene"}function Cm(t){return t!=="absolute-height"}function k7e(t,e,i,r,s){kd(e,i,s,r,Db),uce(t,Db.verticalDistanceToGround);const n=Db.sampledElevation,o=ji(G7e,t.transformation);return XO[0]=e.x,XO[1]=e.y,XO[2]=Db.z,rc(e.spatialReference,XO,o,r.spatialReference)?t.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),n}function z7e(t,e,i,r,s,n){let o=0;const a=n.spatialReference;e*=3,r*=3;for(let l=0;l<s;++l){const c=t[e+0],h=t[e+1],p=t[e+2],f=st(n.getElevation(c,h,p,a,"ground"),0);o+=f,i[r+0]=c,i[r+1]=h,i[r+2]=f,e+=3,r+=3}return o/s}function V7e(t,e,i,r,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;e*=3,r*=3;for(let f=0;f<s;++f){const g=t[e+0],y=t[e+1],v=t[e+2],b=st(n.getElevation(g,y,v,p,"ground"),0);l+=b,i[r+0]=g,i[r+1]=y,i[r+2]=h==null?v+b+c:b+c,e+=3,r+=3}return l/s}function N7e(t,e,i,r,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;e*=3,r*=3;for(let f=0;f<s;++f){const g=t[e+0],y=t[e+1],v=t[e+2],b=st(n.getElevation(g,y,v,p,"scene"),0);l+=b,i[r+0]=g,i[r+1]=y,i[r+2]=h==null?v+b+c:b+c,e+=3,r+=3}return l/s}function U7e(t){const e=t.meterUnitOffset,i=t.featureExpressionInfoContext;return e!==0||i!=null}function j7e(t,e,i,r,s,n,o,a){const l=a.calculateOffsetRenderUnits(o),c=a.featureExpressionInfoContext;e*=3,r*=3;for(let h=0;h<s;++h){const p=t[e+0],f=t[e+1],g=t[e+2];i[r+0]=p,i[r+1]=f,i[r+2]=c==null?g+l:l,e+=3,r+=3}return 0}class UT{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}var $i;(function(t){t[t.NONE=0]="NONE",t[t.UPDATE=1]="UPDATE",t[t.RECREATE=2]="RECREATE"})($i||($i={}));const B7e={"absolute-height":{applyElevationAlignmentBuffer:j7e,requiresAlignment:U7e},"on-the-ground":{applyElevationAlignmentBuffer:z7e,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:V7e,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:N7e,requiresAlignment:()=>!0}},G7e=be(),Db=new UT,XO=$();function u7(t,e,i,r){const s=t.stageObject,n=i.spatialReference,o=s.geometryRecords,a=e.mode!=="absolute-height";let l=0;for(const c of o){const h=c.geometry,p=c.getShaderTransformation();ul[0]=p[12],ul[1]=p[13],ul[2]=p[14],h.invalidateBoundingInfo();const f=h.getMutableAttribute("position"),g=f.data,y=h.vertexAttributes.get("mapPos").data,v=f.size,b=g.length/v,w=new Are(y,n);let S=0,T=!1,C=0;for(let M=0;M<b;M++){if(Fb[0]=g[S],Fb[1]=g[S+1],Fb[2]=g[S+2],kd(w,i,e,r,Qn),a&&(C+=Qn.sampledElevation),Kt.TESTS_DISABLE_OPTIMIZATIONS)g[S]=w.array[w.offset],g[S+1]=w.array[w.offset+1],g[S+2]=Qn.z,Mi(g,n,S,g,r.spatialReference,S,1),g[S]-=ul[0],g[S+1]-=ul[1],g[S+2]-=ul[2],T=!0;else{Jn[0]=g[S]+ul[0],Jn[1]=g[S+1]+ul[1],Jn[2]=g[S+2]+ul[2],r.setAltitude(Jn,Qn.z),g[S]=Jn[0]-ul[0],g[S+1]=Jn[1]-ul[1],g[S+2]=Jn[2]-ul[2];const P=h7/r.unitInMeters;(Math.abs(Fb[0]-g[S])>=P||Math.abs(Fb[1]-g[S+1])>=P||Math.abs(Fb[2]-g[S+2])>=P)&&(T=!0)}S+=v,w.offset+=3}l+=C/b,T&&s.geometryVertexAttrsUpdated(c)}return l/o.length}function jT(t,e,i,r){const s=t.stageObject,n=e.centerPointInElevationSR;let o=0;s.metadata.usesVerticalDistanceToGround?(kd(n,i,e,r,Qn),uce(s,Qn.verticalDistanceToGround),o=Qn.sampledElevation):(kd(n,i,e,r,Qn),e.mode!=="absolute-height"&&(o=Qn.sampledElevation));const a=ji(q7e,s.transformation),l=ne(pce,a[12],a[13],a[14]);Kt.TESTS_DISABLE_OPTIMIZATIONS?(Jn[0]=n.x,Jn[1]=n.y,Jn[2]=Qn.z,rc(n.spatialReference,Jn,a,r.spatialReference)&&(s.transformation=a)):r.setAltitudeOfTransformation(Qn.z,a);const c=h7/r.unitInMeters;return(Math.abs(a[12]-l[0])>=c||Math.abs(a[13]-l[1])>=c||Math.abs(a[14]-l[2])>=c)&&(s.transformation=a),o}const q7e=be();function H7e(t,e,i,r){const s=t.graphics3DSymbolLayer.lodRenderer;if(A(s))return 0;const n=e.centerPointInElevationSR;kd(n,i,e,r,Qn);const o=e.mode!=="absolute-height"?Qn.sampledElevation:0,a=s.instanceData,l=t.instanceIndex,c=W7e;a.getGlobalTransform(l,c);const h=ne(pce,c[12],c[13],c[14]);Kt.TESTS_DISABLE_OPTIMIZATIONS?(Jn[0]=n.x,Jn[1]=n.y,Jn[2]=Qn.z,rc(n.spatialReference,Jn,c,r.spatialReference)&&a.setGlobalTransform(l,c)):r.setAltitudeOfTransformation(Qn.z,c);const p=h7/r.unitInMeters;return(Kt.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(c[12]-h[0])>=p||Math.abs(c[13]-h[1])>=p||Math.abs(c[14]-h[2])>=p)&&a.setGlobalTransform(l,c),o}const h7=.01,Jn=$(),ul=$(),Fb=$(),W7e=be(),pce=$(),Qn=new UT,Z7e=le.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function J7e(t){return{cachedResult:t.cachedResult,arcade:t.arcade?{func:t.arcade.func,context:t.arcade.modules.arcadeUtils.createExecContext(null,{sr:t.arcade.context.spatialReference}),modules:t.arcade.modules}:null}}function Aat(t){const e=t&&t.expression;if(typeof e=="string"){const i=gce(e);if(i!=null)return{cachedResult:i}}return null}async function $at(t,e,i){const r=t&&t.expression;if(typeof r!="string")return null;const s=gce(r);if(s!=null)return{cachedResult:s};const n=await su(),o=n.arcadeUtils,a=o.createSyntaxTree(r);return o.dependsOnView(a)?(i!=null&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(a),context:o.createExecContext(null,{sr:e}),modules:n}}}function fce(t,e,i){return t.arcadeUtils.createFeature(e.attributes,e.geometry,i)}function d7(t,e){if(t!=null&&!mce(t)){if(!e||!t.arcade)return void Z7e.errorOncePerTick("Arcade support required but not provided");const i=e;i._geometry&&(i._geometry=ice(i._geometry)),t.arcade.modules.arcadeUtils.updateExecContext(t.arcade.context,e)}}function Q7e(t){if(t!=null){if(mce(t))return t.cachedResult;const e=t.arcade;let i=t.arcade.modules.arcadeUtils.executeFunction(e.func,e.context);return typeof i!="number"&&(t.cachedResult=0,i=0),i}return 0}function Eat(t,e=!1){let i=t&&t.featureExpressionInfo;const r=i&&i.expression;return e||r==="0"||(i=null),i}const Y7e={cachedResult:0};function mce(t){return t.cachedResult!=null}function gce(t){return t==="0"?0:null}class ma{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=g4e(e)}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,i){const r=this.calculateOffsetRenderUnits(i);return this.featureExpressionInfoContext!=null?r:e+r}calculateOffsetRenderUnits(e){let i=this._meterUnitOffset;const r=this.featureExpressionInfoContext;return r!=null&&(i+=Q7e(r)*this._metersPerElevationInfoUnit),i/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=m4e(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=st(e.offset,0)}updateFeatureExpressionInfoContext(e,i,r){if(A(e))return void(this._featureExpressionInfoContext=null);const s=e&&e.arcade;s&&_(i)&&_(r)?(this._featureExpressionInfoContext=J7e(e),d7(this._featureExpressionInfoContext,fce(s.modules,i,r))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const i=new ma;return _(e)&&i.setFromElevationInfo(e),i}}class Wu{constructor(e,i,r,s,n,o,a,l=null){this.graphics3DSymbolLayer=e,this.stageObject=i,this._uniqueGeometries=r,this._uniqueMaterials=s,this._uniqueTextures=n,this.elevationAligner=o,this.elevationContext=a,this._edgeState=l,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1,this.graphics3DSymbolLayer=e,this.stageObject=i}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(e,i){this._stageLayer=i,this._stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.addMany(this._uniqueTextures),e.load(this._uniqueTextures),e.add(this.stageObject)}destroy(){const e=this._stage;this._stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.removeMany(this._uniqueTextures)),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const i=this._stage.renderView.ensureEdgeView();i.hasObject(this.stageObject)&&i.removeObject(this.stageObject),this.stageObject.dispose(),this._visible=!1,this._stageLayer=null,this._stage=null}layerOpacityChanged(e,i){if(A(this._edgeState))return;const r=yce(this._edgeState.baseMaterial);let s=!1;for(const n of this._edgeState.edgeMaterials)n.objectTransparency!==r&&(n.objectTransparency=r,s=!0);s&&this.resetEdgeObject(i),this._stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,i){A(this._edgeState)||(this._stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:e},!i),this._edgeState.properties.slicePlaneEnabled=e)}setVisibility(e){if(this._stage!=null&&this._visible!==e&&(this._visible=e,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this._stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),_(this._edgeState))){const i=this._stage.renderView.ensureEdgeView();i.hasObject(this.stageObject)?i.updateObjectVisibility(this.stageObject,e):e&&this.addOrUpdateEdgeObject(i,!1)}}get visible(){return this._visible}alignWithElevation(e,i,r,s){this.elevationAligner!=null&&(_(r)&&d7(this.elevationContext.featureExpressionInfoContext,r),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e,i),this.resetEdgeObject(s))}getCenterObjectSpace(e=$()){return re(e,ea(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=lr()){const i=this.stageObject.boundingVolumeObjectSpace;return ZW(e,i.min),JW(e,i.max),e}computeAttachmentOrigin(e){if(this.useObjectOriginAsAttachmentOrigin){const i=this.stageObject.transformation;e.render.origin[0]+=i[12],e.render.origin[1]+=i[13],e.render.origin[2]+=i[14],e.render.num++}else for(const i of this.stageObject.geometryRecords)i.computeAttachmentOrigin(zd)&&(Oe(zd,zd,this.stageObject.transformation),de(e.render.origin,e.render.origin,zd),e.render.num++)}async getProjectedBoundingBox(e,i,r,s,n){const o=this.getBoundingBoxObjectSpace(n),a=X7e,l=mP(o)?1:a.length;for(let h=0;h<l;h++){const p=a[h];Mm[0]=o[p[0]],Mm[1]=o[p[1]],Mm[2]=o[p[2]],Oe(Mm,Mm,this.stageObject.transformation),B0[3*h+0]=Mm[0],B0[3*h+1]=Mm[1],B0[3*h+2]=Mm[2]}if(!e(B0,0,l))return null;ii(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],B0[h+p]),o[p+3]=Math.max(o[p+3],B0[h+p]);c&&r.push({location:B0.slice(h,h+3),screenSpaceBoundingRect:c})}if(i&&i.service&&this.elevationContext.mode!=="absolute-height"){Yl(o,zd);const h=this.elevationContext.mode==="relative-to-scene"?"scene":"ground";let p=0;if(i.useViewElevation)p=st(i.service.getElevation(zd[0],zd[1],h),0);else try{const f=c7(o,i);p=st(await i.service.queryElevation(zd[0],zd[1],s,f,h),0)}catch{}WW(o,0,0,-this.alignedSampledElevation+p)}return o}addObjectState(e,i){e===0&&i.addObject(this.stageObject,this.stageObject.highlight()),e===1&&i.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(e){if(A(this._edgeState))return;const i=this._stage.renderView.ensureEdgeView();this._visible?this.addOrUpdateEdgeObject(i,e):i.removeObject(this.stageObject)}addOrUpdateEdgeObject(e,i){const r=this._edgeState;if(A(r))return;const s=yce(r.baseMaterial);for(const n of r.edgeMaterials)n.objectTransparency=s;e.addOrUpdateObject3D(this.stageObject,r.edgeMaterials,r.properties,!i).then(()=>{var n;return(n=this._stageLayer)==null?void 0:n.sync()})}}function yce(t){return t.isVisible?t.parameters.transparent?1:2:0}const B0=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Mm=$(),zd=$(),X7e=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];class p7{constructor(e){this.schedule=e,this._loadStatus=0,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,i){return this._loadStatus===1?(e&&e(),at(this._loader)):this._loadStatus===2?(i&&i(this._loadError),at(this._loader)):(A(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=1},r=>{throw this._loadError=r,this._abortController=null,this._loadStatus=2,!bi(r)&&this.logger&&r.message&&this.logger.warn(r.message),r})),this._loader.then(e,i).catch(()=>{}),this._loader)}abortLoad(){_(this._abortController)?this._abortController=Rl(this._abortController):this._loadStatus===0&&(this._loadStatus=2),this._loader=null}}function K7e(t){switch(t){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function vce(t,e){const i=(r,s,n=!1)=>({levels:r.map(o=>{const a=s(o.tesselation);return n&&Oo.cgToGIS(a),{components:[{geometry:a,material:e}],faceCount:a.indexCount/3,minScreenSpaceRadius:o.minScreenSpaceRadius}})});switch(t){case"sphere":return i([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],r=>Oo.createPolySphereGeometry(.5,r,!0));case"cube":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Oo.createBoxGeometry(1));case"cone":return i(f7,r=>Oo.createConeGeometry(1,.5,r,!1),!0);case"inverted-cone":return i(f7,r=>Oo.createConeGeometry(1,.5,r,!0),!0);case"cylinder":return i(f7,r=>Oo.createCylinderGeometry(1,.5,r,[0,0,1],[0,0,.5]));case"tetrahedron":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Oo.createTetrahedronGeometry(1),!0);case"diamond":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Oo.createDiamondGeometry(1),!0);default:return}}const f7=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function eUe(t){return t.type==="fill"}function tUe(t){return t.type==="extrude"}function iUe(t){return t&&t.enabled&&(tUe(t)||eUe(t))&&_(t.edges)}function rUe(t){return t&&t.enabled&&t.edges||null}function _ce(t,e){return sUe(rUe(t),e)}function sUe(t,e){if(A(t))return null;const i=_(t.color)?S6(Ae.toUnitRGBA(t.color)):Bt(0,0,0,0),r=zs(t.size),s=zs(t.extensionLength);switch(t.type){case"solid":return nUe(E({color:i,size:r,extensionLength:s},e));case"sketch":return oUe(E({color:i,size:r,extensionLength:s},e));default:return}}function nUe(t){return he(E(E({},aUe),t),{type:"solid"})}function oUe(t){return he(E(E({},lUe),t),{type:"sketch"})}const aUe={color:Bt(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2},lUe={color:Bt(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2};function KO(t){const e=[];return t.levels.forEach(i=>{i.components.forEach(r=>{e.push(r.material)})}),MC(e)}function cUe(t){const e=new Array;return t.levels.forEach(i=>{i.components.forEach(r=>{r.textures&&e.push(...r.textures)})}),MC(e)}function m7(t){const e=[];return t.components.forEach(i=>{e.push(i.geometry)}),MC(e)}function uUe(t){const e=[];return t.levels.forEach(i=>{i.components.forEach(r=>{e.push(r.geometry)})}),MC(e)}function hUe(t){return m7(t).reduce((e,i)=>e+i.indexCount/3,0)}const g7={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function Oat(t){return t.type==="web-style"?g7:y7(t.symbolLayers.toArray().map(e=>wce(t,e)))}function y7(t){let e=0,i=0,r=0,s=!1,n=0;const o={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const a of t)A(a)||(e+=a.primitivesPerFeature,i+=a.primitivesPerCoordinate,r+=a.drawCallsPerFeature,o.bytesPerFeature+=a.memory.bytesPerFeature,o.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.bytesPerCoordinate+=a.memory.bytesPerCoordinate,o.draped.bytesPerFeature+=a.memory.bytesPerFeature,o.draped.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.draped.bytesPerCoordinate+=a.memory.bytesPerCoordinate,s=s||a.estimated,++n);return{primitivesPerFeature:e,primitivesPerCoordinate:i,drawCallsPerFeature:r,estimated:s,memory:o,numComplexities:n}}function Rat(t){const e=y7(t);return e.numComplexities>0&&(e.primitivesPerFeature/=e.numComplexities,e.primitivesPerCoordinate/=e.numComplexities,e.drawCallsPerFeature/=e.numComplexities,e.memory.bytesPerFeature/=e.numComplexities,e.memory.bytesPerFeatureLabel/=e.numComplexities,e.memory.bytesPerCoordinate/=e.numComplexities,e.memory.draped.bytesPerFeature/=e.numComplexities,e.memory.draped.bytesPerFeatureLabel/=e.numComplexities,e.memory.draped.bytesPerCoordinate/=e.numComplexities),e}const bce={};function wce(t,e){const i=xce(t,e),r=iUe(e)?2:0;switch(e.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:r,estimated:!1,memory:i};case"fill":return t.type==="mesh-3d"?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:r,estimated:!1,memory:i}:_(e.outline)&&e.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:i}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:i};case"object":return e.resource&&e.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:i}:he(E({},dUe(e.resource&&e.resource.primitive||iZ)),{memory:i});case"path":{const s=3,n=3,o=10;let a=0,l=0;switch(e.profile){case"circle":a=o;break;case"quad":a=4;break;default:return void kn(e.profile)}switch(e.join){case"round":l=s;break;case"miter":case"bevel":l=1;break;default:return void kn(e.join)}const c=2*a,h=a*l*2;let p=-2*h-c;switch(e.cap){case"none":break;case"butt":case"square":p+=2*(a-1);break;case"round":p+=2*(a*(n-1)*2+a);break;default:return}return{primitivesPerFeature:p,primitivesPerCoordinate:h+c,drawCallsPerFeature:0,estimated:!1,memory:i}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:i};default:return}}function xce(t,e){const i=t.type==="point-3d";switch(e.type){case"extrude":return e.edges&&e.edges.size>0?Yn.EXTRUDE_EDGES:Yn.EXTRUDE;case"fill":return _(e.outline)&&e.outline.size>0?Yn.FILL_OUTLINE:Yn.FILL;case"water":return Yn.FILL;case"line":return e.join==="round"?Yn.LINE_ROUND:Yn.LINE_MITER;case"path":switch(e.join){case"round":switch(e.profile){case"circle":return Yn.PATH_ROUND_CIRCLE;case"quad":return Yn.PATH_ROUND_QUAD;default:return void kn(e.profile)}case"miter":case"bevel":switch(e.profile){case"circle":return Yn.PATH_MITER_CIRCLE;case"quad":return Yn.PATH_MITER_QUAD;default:return void kn(e.profile)}default:return void kn(e.join)}case"object":return i?Yn.OBJECT_POINT:Yn.OBJECT_POLYGON;case"icon":case"text":return i?Yn.ICON_POINT:Yn.ICON_POLYGON;default:return}}function dUe(t){let e=bce[t];if(e)return e;const i=vce(t,null);return e={primitivesPerFeature:m7(i.levels[0]).reduce((r,s)=>r+s.indices.get("position").length/3,0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},bce[t]=e,e}const Yn={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}},eR=le.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class Zu extends p7{constructor(e,i,r,s){super(r.schedule),this._context=r,this._elevationInfoOverride=null,this.complexity=null,this.logger=eR,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=e,this.symbolLayer=i,this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new ma,this.complexity=this.computeComplexity(),this._updateDrivenProperties(s.ignoreDrivers),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,i,r,s){const n=e.projectionSuccess,o="polygons"in e?e.polygons:null,a=`${s} geometry failed to be created`;let l=null;n?!i.length||i.length===1&&!i[0].length?l=`${a} (no ${r} were defined)`:Array.isArray(i)&&Array.isArray(i[0])?o&&o.length===0&&r==="rings"&&i.length>0&&i[0].length>2&&(l=`${a} (filled rings should use clockwise winding - try reversing the order of vertices)`):l=`${a} (${r} should be defined as a 2D array)`:l=`${a} (failed to project geometry to view spatial reference)`,l&&eR.warnOncePerTick(l)}_validateGeometry(e,i=null,r=null){if(_(i)&&!i.includes(e.type))return this.logger.warn("unsupported geometry type for "+r+` symbol: ${e.type}`),!1;if(e.type==="point"){const s=e;if(!isFinite(s.x)||!isFinite(s.y))return eR.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return pUe}_defaultElevationInfoZ(){return fUe}_updateElevationContext(){_(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,i=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||i.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,i){const r=at(e.geometry),s=this.getDefaultElevationInfo(r);i.unit=this._elevationContext.unit!=null?this._elevationContext.unit:s.unit,i.mode=this.getGeometryElevationMode(r,s),i.offsetMeters=st(this._elevationContext.meterUnitOffset,st(s.offset,0));const n=!this._elevationOptions.supportsOnTheGround&&i.mode==="on-the-ground";n&&(i.mode="relative-to-ground",i.offsetMeters=0);const o=n?Y7e:this._elevationContext.featureExpressionInfoContext;return i.updateFeatureExpressionInfoContext(o,e,this._context.layer),i}prepareSymbolLayerPatch(e){}updateGeometry(e,i){return!1}onRemoveGraphic(e){}_updateDrivenProperties(e){const i={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};if(e)return void(this._drivenProperties=i);const r=this._context.renderer;r&&"visualVariables"in r&&r.visualVariables&&r.visualVariables.forEach(s=>{switch(s.type){case"color":if(i.color=!0,s.stops)for(let n=0;n<s.stops.length;n++){const o=s.stops[n].color;o&&(i.opacity=!0,o.a<1&&(i.opacityAlwaysOpaque=!1))}break;case"opacity":i.opacity=!0,i.opacityAlwaysOpaque=!1;break;case"size":i.size=!0}}),this._drivenProperties=i}_getLayerOpacity(){if(this._context.layerView&&"fullOpacity"in this._context.layerView)return this._context.layerView.fullOpacity;const e=this._context.layer.opacity;return e==null?1:e}_getCombinedOpacity(e,i=Sce){let r=1;return this.draped||(r*=this._getLayerOpacity()),this._drivenProperties.opacity||(_(e)?r*=e.a:i.hasIntrinsicColor||(r=0)),r}_getCombinedOpacityAndColor(e,i=Sce){const r=this._getCombinedOpacity(e,i);if(this._drivenProperties.color)return zT(null,r);const s=_(e)?Ae.toUnitRGB(e):Kc;return zT(s,r)}_getVertexOpacityAndColor(e,i=null){const r=this._drivenProperties.color?e.color:null,s=this._drivenProperties.opacity?e.opacity:null,n=zT(r,s);return _(i)&&(n[0]*=i,n[1]*=i,n[2]*=i,n[3]*=i),n}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return wce(this.symbol,this.symbolLayer)}globalPropertyChanged(e,i,r){switch(e){case"opacity":return this.layerOpacityChanged(i,r);case"elevationInfo":{const s=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(i,r,s)!==$i.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(i,r);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(e,i,r){let s=$i.UPDATE;return e.forEach(n=>{const o=i(n);if(_(o)){const a=n.graphic;this.setGraphicElevationContext(a,o.elevationContext),o.needsElevationUpdates=r(o.elevationContext.mode)}else s=$i.RECREATE}),s}applyRendererDiff(e,i){return 0}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const i=this._fastUpdates.visualVariables,r=i.size?Vd(i.size.field,e):0,s=i.color?Vd(i.color.field,e):0,n=i.opacity?Vd(i.opacity.field,e):0;return Bt(r,s,n,0)}get draped(){return this._draped}ensureDrapedStatus(e){return this._draped==null?(this._draped=e,!0):(e!==this.draped&&eR.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}}function Vd(t,e){const i=t!=null?e.attributes[t]:0;return i!=null&&isFinite(i)?i:0}const pUe={mode:"on-the-ground",offset:0,unit:"meters"},fUe={mode:"absolute-height",offset:0,unit:"meters"},Sce={hasIntrinsicColor:!1};class G0{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(e,i,r,s,n,o){this.id=On(),this.geometry=e,this.material=i,this.transformation=r,this.instanceParameters=s,this.origin=n,this._shaderTransformation=o,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return _(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(e){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,e):this.geometry.computeAttachmentOrigin(e))&&(Oe(e,e,this.getStaticTransformation()),!0)}}G0.pool=new Xi(G0);class tR{constructor(e){this.channel=e,this.id=On()}}class Nd extends ab{constructor(e={}){super(),this.type=1,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=be(),this._bvObjectSpace=new Cce,this._bvWorldSpace=new Cce,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=e.castShadow==null||e.castShadow,this.metadata=e.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new Tce),this.transformation=be();const{geometries:i,materials:r,transformations:s,origins:n}=e;if(Array.isArray(i)){Ze(r.length===i.length,"Object3D: materials don't match geometries"),Ze(s.length===i.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=i.length,this._geometries.length=i.length;for(let o=0;o<i.length;o++)this._geometries[o]=i[o],this._geometryRecords[o]=G0.pool.acquire(i[o],r[o],my(s[o]),{highlights:null,occludees:null,visible:this._visible},n&&n[o])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(e){ji(this._objectTransformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){Ze(this._parentLayer==null||e==null,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e,i,r,s,n){r=r||Dr,this._geometries.push(e);const o=G0.pool.acquire(e,i,r,{highlights:null,occludees:null,visible:this._visible},s,n);return this._geometryRecords.push(o),this._hasVolatileTransformation=this._hasVolatileTransformation||_(o.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:o}),this._invalidateBoundingVolume(),o}removeGeometry(e){const i=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=_(i.shaderTransformation)?this._geometryRecords.some(r=>_(r.shaderTransformation)):this._hasVolatileTransformation,i.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:i}),this._invalidateBoundingVolume(),i}removeAllGeometries(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(e){this._emit("vertexAttrsUpdated",{object:this,record:e}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(e){if(this._visible!==e){this._visible=e;for(const i of this._geometryRecords)i.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new tR(1);for(const i of this._geometryRecords)i.instanceParameters.occludees=JV(i.instanceParameters.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const i of this._geometryRecords)i.instanceParameters.occludees=QV(i.instanceParameters.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new tR(0);for(const i of this._geometryRecords)i.instanceParameters.highlights=JV(i.instanceParameters.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const i of this._geometryRecords)i.instanceParameters.highlights=QV(i.instanceParameters.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,i){return wi(st(i,be()),this.transformation,e.getStaticTransformation())}getCombinedShaderTransformation(e,i){return i=i||be(),wi(i,this.transformation,e.getShaderTransformation()),i}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let s=0;s<this._geometryRecords.length;++s){const n=this._geometries[s],o=this._geometryRecords[s],a=n.boundingInfo;_(a)&&(this._calculateTransformedBoundingVolume(a,this._bvObjectSpace,o.getShaderTransformation()),this._calculateTransformedBoundingVolume(a,this._bvWorldSpace,this.getCombinedShaderTransformation(o)))}jr(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),jr(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=$(),i=$(),r=Rg(this.transformation);for(let s=0;s<this._geometryRecords.length;++s){const n=this._geometries[s].boundingInfo;if(A(n))continue;const o=this._geometryRecords[s].getShaderTransformation(),a=Rg(o);Oe(e,n.getCenter(),o);const l=qt(e,this._bvObjectSpace.bounds),c=n.getBSRadius()*a;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],l+c),Oe(i,e,this.transformation);const h=qt(i,this._bvWorldSpace.bounds),p=c*r;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],h+p)}this._bvDirty=!1}_calculateTransformedBoundingVolume(e,i,r){const s=e.getBBMin(),n=e.getBBMax(),o=br(s),a=br(n);Oe(o,o,r),Oe(a,a,r);for(let l=0;l<3;++l)i.min[l]=Math.min(i.min[l],o[l],a[l]),i.max[l]=Math.max(i.max[l],o[l],a[l]);for(let l=0;l<3;++l){re(o,s),re(a,n),o[l]=n[l],a[l]=s[l],Oe(o,o,r),Oe(a,a,r);for(let c=0;c<3;++c)i.min[c]=Math.min(i.min[c],o[c],a[c]),i.max[c]=Math.max(i.max[c],o[c],a[c])}}_invalidateBoundingVolume(){this._bvDirty=!0,_(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(e,i){_(this._parentLayer)&&this._parentLayer.events.emit(e,i)}get test(){const e=this;return{hasGeometry:i=>e._geometries.indexOf(i)>-1,getGeometryIndex:i=>e._geometries.indexOf(i)}}}class Tce{constructor(){this.min=De(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=De(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class Cce extends Tce{constructor(){super(...arguments),this.bounds=rs()}init(){ne(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),ne(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),sQ(this.bounds)}}const Pm=$();function v7(t,e,i,r,s,n,o,a){const l=i?i.length:0,c=t.clippingExtent;if(Gr(e,Pm,t.elevationProvider.spatialReference),_(c)&&!iL(c,Pm))return null;const h=t.renderCoordsHelper.spatialReference;Gr(e,Pm,h);const p=t.localOriginFactory.getOrigin(Pm),f=new Nd({castShadow:!1,metadata:{layerUid:n,graphicUid:o,usesVerticalDistanceToGround:!0}});for(let g=0;g<l;g++){const y=Dr;f.addGeometry(i[g],r[g],y,p,a)}return{object:f,sampledElevation:k7e(f,e,t.elevationProvider,t.renderCoordsHelper,s)}}function BT(t,e,i){const r=t.elevationContext,s=i.spatialReference;Gr(e,Pm,s),r.centerPointInElevationSR=Ld(Pm[0],Pm[1],e.hasZ?Pm[2]:0,s)}function GT(t){switch(t.type){case"point":return t;case"polygon":case"extent":return l7(t);case"polyline":{const e=t.paths[0];if(!e||e.length===0)return null;const i=zH(e,kH(e)/2);return Ld(i[0],i[1],i[2],t.spatialReference)}case"mesh":return t.origin}return null}function _7(){return new Float32Array(2)}function mUe(t){const e=new Float32Array(2);return e[0]=t[0],e[1]=t[1],e}function hl(t,e){const i=new Float32Array(2);return i[0]=t,i[1]=e,i}function gUe(t,e){return new Float32Array(t,e,2)}function Mce(){return _7()}function Pce(){return hl(1,1)}function Ace(){return hl(1,0)}function $ce(){return hl(0,1)}const yUe=Mce(),vUe=Pce(),_Ue=Ace(),bUe=$ce();Object.freeze({__proto__:null,create:_7,clone:mUe,fromValues:hl,createView:gUe,zeros:Mce,ones:Pce,unitX:Ace,unitY:$ce,ZEROS:yUe,ONES:vUe,UNIT_X:_Ue,UNIT_Y:bUe});function wUe(t){const e=new pi;return e.include(VV),e.include(Ale,t),e.include(Zi,t),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("lineSize","float").add("pixelToNDC","vec2").add("borderSize","float").add("screenOffset","vec2"),e.varyings.add("coverageSampling","vec4"),e.varyings.add("lineSizes","vec2"),t.multipassGeometryEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(x`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${t.occlusionTestEnabled?x`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${t.screenSizePerspectiveEnabled?x`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:x`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${t.multipassGeometryEnabled?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${t.depthHudEnabled?t.depthHudAlignStartEnabled?x`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:x`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${t.screenSizePerspectiveEnabled?x`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:x`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),e.fragment.uniforms.add("color","vec4"),e.fragment.uniforms.add("borderColor","vec4"),t.multipassGeometryEnabled&&(e.fragment.include(Ele,t),e.fragment.uniforms.add("inverseViewport","vec2")),e.fragment.code.add(x`
    void main() {
      ${t.multipassGeometryEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = color.a * borderColor.a * coverage.y;
      float colorAlpha = color.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${t.depthHudEnabled?x`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:x`
      // Compute the finalRgb, but keep it pre-multiplied (for unpre-multiplied you
      // need to divide by finalAlpha). We avoid the division here by setting the
      // appropriate blending function in the material.
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, color.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),e}var iR;function Ece(t,e,i){i.length===3?t.setUniform4f(e,i[0],i[1],i[2],1):t.setUniform4fv(e,i)}(function(t){function e(i,r,s){Ece(i,"color",r.color),i.setUniform1f("pixelRatio",s),i.setUniform2f("screenOffset",r.screenOffset[0]*s,r.screenOffset[1]*s),r.borderColor!==null?(Ece(i,"borderColor",r.borderColor),i.setUniform1f("borderSize",s)):(i.setUniform4f("borderColor",0,0,0,0),i.setUniform1f("borderSize",0))}t.bindUniforms=e})(iR||(iR={}));const xUe=Object.freeze({__proto__:null,build:wUe,get LineCallout(){return iR}});class rR extends Si{initializeProgram(e){const i=rR.shader.get(),r=this.configuration,s=i.build({occlusionTestEnabled:r.occlusionTestEnabled,verticalOffsetEnabled:r.verticalOffset,screenSizePerspectiveEnabled:r.screenSizePerspective,depthHudEnabled:r.depthHudEnabled,depthHudAlignStartEnabled:r.depthHudAlignStartEnabled,screenCenterOffsetUnitsEnabled:r.screenCenterOffsetUnitsEnabled,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,viewingMode:e.viewingMode,isDraped:!1,multipassGeometryEnabled:r.multipassGeometryEnabled});return new fi(e.rctx,s,Ht)}bindPass(e,i){Pc(this.program,i.camera.projectionMatrix),iR.bindUniforms(this.program,e,i.camera.pixelRatio||1),YN(this.program,e,i),$le(this.program,i),this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Ole(this.program,i),this.program.bindTexture(i.hudVisibilityTexture,"hudVisibilityTexture"),this.program.setUniform1f("cameraGroundRelative",i.camera.aboveGround?1:-1),this.program.setUniform1f("polygonOffset",e.shaderPolygonOffset),Une(this.program,i),this.program.setUniform1f("perDistancePixelRatio",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",i.camera.viewInverseTransposeMatrix),this.program.setUniform2f("pixelToNDC",2/i.camera.fullViewport[2],2/i.camera.fullViewport[3]);const r=i.camera.pixelRatio||1;this.program.setUniform1f("lineSize",Math.ceil(e.size)*r),IT(e.screenSizePerspective,this.program,"screenSizePerspectiveAlignment")}bindDraw(e){Yf(this.program,e),Qf(this.program,e.origin,e.camera.viewInverseTransposeMatrix),_m(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e){const i=e?519:513;return this.configuration.depthHudEnabled?_t({depthTest:{func:i},depthWrite:$o}):_t({blending:Xs(1,770,771,771),depthTest:{func:i},colorWrite:Pt})}initializePipeline(){return this.setPipelineState(this.configuration.multipassGeometryEnabled)}}rR.shader=new vi(xUe,()=>import("./LineCallout.glsl.f72c1f79.js"));class Ud extends tr{constructor(){super(...arguments),this.occlusionTestEnabled=!0,this.verticalOffset=!1,this.screenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.screenCenterOffsetUnitsEnabled=0,this.slicePlaneEnabled=!1,this.multipassGeometryEnabled=!1}}u([X()],Ud.prototype,"occlusionTestEnabled",void 0),u([X()],Ud.prototype,"verticalOffset",void 0),u([X()],Ud.prototype,"screenSizePerspective",void 0),u([X()],Ud.prototype,"depthHudEnabled",void 0),u([X()],Ud.prototype,"depthHudAlignStartEnabled",void 0),u([X({count:2})],Ud.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([X()],Ud.prototype,"slicePlaneEnabled",void 0),u([X()],Ud.prototype,"multipassGeometryEnabled",void 0);class q0 extends Id{constructor(e){super(e,TUe),this.techniqueConfig=new Ud,this._uniqueMaterialIdentifier=q0.uniqueMaterialIdentifier(this.parameters)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}getPassParameters(){return this.parameters}getTechniqueConfig(e,i){const r=(i==null?void 0:i.slot)!==18;return this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.depthHudEnabled=r,this.techniqueConfig.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this.techniqueConfig.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?1:0,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.multipassGeometryEnabled=!!i&&i.multipassGeometryEnabled,this.techniqueConfig}intersect(){}requiresSlot(e){switch(e){case 18:case 19:return!0}return!1}createGLMaterial(e){return e.output===0?new SUe(e):null}createBufferWriter(){return new MUe}validateParameters(e){const i=q0.uniqueMaterialIdentifier(e);i!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=i)}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}}class SUe extends vm{updateParameters(e){return this.ensureTechnique(rR,e)}beginSlot(e){return this.updateParameters(e)}bind(e,i){i.bindPass(this._material.getPassParameters(),e)}}const TUe=E({verticalOffset:null,screenSizePerspective:null,screenOffset:[0,0],color:[0,0,0,1],size:1,borderColor:null,occlusionTest:!1,shaderPolygonOffset:1e-5,depthHUDAlignStart:!1,centerOffsetUnits:"world",slicePlaneEnabled:!1},Gu),CUe=zr().vec3f("position").vec3f("normal").vec2f("uv0").vec4f("auxpos1"),Oce=[hl(0,0),hl(1,0),hl(0,1),hl(1,0),hl(1,1),hl(0,1)];class MUe{constructor(){this.vertexBufferLayout=CUe}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get("position").length}write(e,i,r,s){UO(i.indices.get("position"),i.vertexAttributes.get("position").data,e.transformation,r.position,s,6),ZN(i.indices.get("normal"),i.vertexAttributes.get("normal").data,e.invTranspTransformation,r.normal,s,6),Pb(i.indices.get("auxpos1"),i.vertexAttributes.get("auxpos1").data,r.auxpos1,s,6);for(let n=0;n<Oce.length;++n)r.uv0.setVec(s+n,Oce[n])}}class sR extends Zu{constructor(e,i){super(e,null,i,$Ue),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new q0(this.materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}perInstanceMaterialParameters(e){const i=this.materialParameters;return i.screenOffset=e.screenOffset||[0,0],i.centerOffsetUnits=e.centerOffsetUnits||"world",i}get materialParameters(){const e=this.symbol,i=e.callout,r=_(i.color)?Ae.toUnitRGBA(i.color):[0,0,0,0];r[3]*=this._getLayerOpacity();const s=zs(i.size||0);let n=null;if(e.verticalOffset){const{screenLength:p,minWorldLength:f,maxWorldLength:g}=e.verticalOffset;n={screenLength:zs(p),minWorldLength:f||0,maxWorldLength:g!=null?g:1/0}}const o=_(i.border)&&_(i.border.color)?Ae.toUnitRGBA(i.border.color):null,a=e.symbolLayers.getItemAt(0).type==="object",l=!a,c=a?0:void 0,h=e.type==="label-3d";return{color:r,size:s,verticalOffset:n,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:o,occlusionTest:l,shaderPolygonOffset:c,depthHUDAlignStart:h,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:Gu.renderOccluded}}_defaultElevationInfoNoZ(){return AUe}createGraphics3DGraphic(e){const i=e.renderingInfo,r=e.graphic,s=this.setGraphicElevationContext(r,new ma,i.elevationOffset||0),n=i.symbol,o=this._elevationContext.mode==="on-the-ground"&&(n.type==="cim"||!n.symbolLayers.some(l=>l.type==="object"||l.type==="text"));if(n.type!=="label-3d"&&o)return null;const a=l7(r.geometry);return A(a)?null:this._createAs3DShape(a,s,i,r.uid)}layerOpacityChanged(){return A(this._material)||this._material.setParameters(this.materialParameters),!0}layerElevationInfoChanged(e,i,r){const s=this._elevationContext.mode,n=NT(sR.elevationModeChangeTypes,r,s);return n!==$i.UPDATE||e.forEach(o=>{const a=i(o);_(a)&&this.updateGraphicElevationContext(o.graphic,a)}),n}slicePlaneEnabledChanged(){return A(this._material)||this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}setGraphicElevationContext(e,i,r=0){const s=super.setGraphicElevationContext(e,i);return s.addOffsetRenderUnits(r),s}updateGraphicElevationContext(e,i){this.setGraphicElevationContext(e,i.elevationContext,i.metadata.elevationOffset),i.needsElevationUpdates=cl(i.elevationContext.mode)}updateGeometry(e,i){return!1}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:g7.memory}}createVertexData(e){const{translation:i,centerOffset:r}=e;return[["position",i?{size:3,data:[i[0],i[1],i[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0}],["normal",{size:3,data:[0,0,1],exclusive:!0}],["auxpos1",r?{size:4,data:[r[0],r[1],r[2],r[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0}]]}_getOrCreateMaterial(e){const i=this.perInstanceMaterialParameters(e),r=q0.uniqueMaterialIdentifier(i);if(_(this._material)&&r===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(e.materialCollection){let s=e.materialCollection.get(r);return A(s)&&(s=new q0(i),e.materialCollection.add(r,s)),{material:s,isUnique:!1}}return{material:new q0(i),isUnique:!0}}_createAs3DShape(e,i,r,s){const n=[new zi(this.createVertexData(r),PUe,1)],o=this._getOrCreateMaterial(r),a=v7(this._context,e,n,[o.material],i,this._context.layer.uid,s);if(a===null)return null;const l=new Wu(this,a.object,n,o.isUnique?[o.material]:null,null,jT,i);return l.metadata={elevationOffset:r.elevationOffset||0},l.alignedSampledElevation=a.sampledElevation,l.needsElevationUpdates=cl(i.mode),BT(l,e,this._context.elevationProvider),l}}sR.elevationModeChangeTypes={definedChanged:$i.UPDATE,staysOnTheGround:$i.UPDATE,onTheGroundChanged:$i.RECREATE};const b7=new Uint16Array([0]),PUe=[["position",b7],["normal",b7],["auxpos1",b7]],AUe={mode:"relative-to-ground",offset:0},$Ue={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},Rce=le.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function EUe(t,e){if(!AL(t))return Rce.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${t.type}' does not support callouts`),null;if(!t.callout)return null;const i=OUe[t.callout.type];return i?new i(t,e):(Rce.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${t.callout.type}`),null)}const OUe={line:sR};class RUe{constructor(e,i,r){this.graphic=e,this.renderingInfo=i,this.layer=r}}const Ice=new Xi(Array,t=>fP(t,XW),null,10,5),IUe=pt();class DUe{constructor(e,i,r,s,n){this.graphic=e,this.graphics3DSymbol=i,this.graphics=r,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=FUe(2,4),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++i.referenced,this._featureExpressionFeature=n?fce(n,e,s):null;for(const o of r)_(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(e,i,r){this._layer=i,this._stage=e,this.forEachSymbolLayerGraphic(s=>{s.initialize(e,i,r),s.setVisibility(this.isVisible())})}destroy(){this.forEachSymbolLayerGraphic(e=>e.destroy()),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.graphics==null}clearLabelGraphics(){this.forEachLabelGraphic(e=>e.destroy()),this._labelGraphics.length=0}addLabelGraphic(e,i,r){this._labelGraphics.push(e),e.initialize(i,r),e.setVisibility(this.isVisible(1))}addAuxiliaryGraphic(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))}get isDraped(){let e=!1;return this.forEachSymbolLayerGraphic(i=>{i.type==="draped"&&(e=!0)}),e}isVisible(e=0,i){for(let r=0;r<=e;r++){const s=this._visibilityFlags[r];for(let n=0;n<s.length;++n)if(s[n]===!1&&n!==i)return!1}return!0}hasVisibilityFlag(e,i){return this._visibilityFlags[i][e]!=null}setVisibilityFlag(e,i,r){const s=this.isVisible(r);this._visibilityFlags[r][e]=i;const n=this.isVisible(r);if(s===n)return!1;if(r===1)this.forEachLabelGraphic(o=>o.setVisibility(n));else{this.forEachSymbolLayerGraphic(a=>a.setVisibility(n));const o=this.isVisible(1);this.forEachLabelGraphic(a=>a.setVisibility(o))}return!0}clearVisibilityFlag(e,i=0){return this.setVisibilityFlag(e,void 0,i)}computeExtent(e){if(!this._extent){const i=this.graphic.geometry;if(A(i))return!1;this._extent=pt(),T7e(i,this._extent);const r=i.spatialReference;if(!r.equals(e)&&!WP(this._extent,r,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,i){return _(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===i||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,i),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=i),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(e,i,r){let s=e.geometry;return s.type!=="mesh"&&s.type!=="extent"||(s=Zo.fromExtent(s.type==="mesh"?s.extent:s)),OAe(s,i,r)}get usedMemory(){let e=Ble(this.graphic.attributes);return this.forEachSymbolLayerGraphic(i=>{const r=i.graphics3DSymbolLayer.complexity;if(A(r))return;const s=i.type==="draped"?r.memory.draped:r.memory;e+=s.bytesPerFeature,s.bytesPerCoordinate&&(e+=S7e(this.graphic.geometry)*s.bytesPerCoordinate)}),e}computeAttachmentOrigin(){const e={render:{origin:$(),num:0},draped:{origin:ke(),num:0}};for(const i of this.graphics)A(i)||i.computeAttachmentOrigin(e);return e.render.num&&se(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&Ao(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,i,r,s,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?ii(n.boundingBox):n.boundingBox=ii(),n.requiresDrapedElevation=!1,await cM(this.graphics,async o=>{if(A(o))return;const a=o.type==="draped"?i:e,l=Ice.acquire(),c=await o.getProjectedBoundingBox(a,r,n.screenSpaceObjects,s,l);isFinite(c[2])&&isFinite(c[5])||(n.requiresDrapedElevation=!0),c&&g1(n.boundingBox,l),Ice.release(l)}),rxe(n.boundingBox)||Y5(rL(n.boundingBox,IUe))?n:null}needsElevationUpdates(){for(const e of this.graphics)if(_(e)&&(e.type==="object3d"||e.type==="lod-instance")&&e.needsElevationUpdates)return!0;for(const e of this._labelGraphics)if(e&&e.needsElevationUpdates)return!0;return!1}alignWithElevation(e,i,r){this.forEachRenderedGraphic(s=>{s.type!=="object3d"&&s.type!=="lod-instance"||s.alignWithElevation(e,i,this._featureExpressionFeature,r)})}addObjectStateSet(e,i){this.forEachSymbolLayerGraphic(r=>r.addObjectState(e,i))}removeObjectState(e){this.forEachSymbolLayerGraphic(i=>i.removeObjectState(e))}forEachGraphicList(e,i){e.forEach(r=>r&&i(r))}forEachSymbolLayerGraphic(e){this.forEachGraphicList(this.graphics,e),this.forEachGraphicList(this._auxiliaryGraphics,e)}forEachLabelGraphic(e){this.forEachGraphicList(this._labelGraphics,e)}forEachRenderedGraphic(e){this.forEachSymbolLayerGraphic(e),this.forEachLabelGraphic(e)}}function FUe(t,e){const i=new Array(t);for(let r=0;r<i.length;r++)i[r]=new Array(e);return i}var Dce,Fce,Lce,kce={exports:{}};Dce=kce,Fce=function(){function t(O,L,N){N=N||2;var B,W,Y,H,K,fe,ce,me=L&&L.length,Ie=me?L[0]*N:O.length,He=e(O,0,Ie,N,!0),$e=[];if(!He||He.next===He.prev)return $e;if(me&&(He=l(O,L,He,N)),O.length>80*N){B=Y=O[0],W=H=O[1];for(var Le=N;Le<Ie;Le+=N)(K=O[Le])<B&&(B=K),(fe=O[Le+1])<W&&(W=fe),K>Y&&(Y=K),fe>H&&(H=fe);ce=(ce=Math.max(Y-B,H-W))!==0?1/ce:0}return r(He,$e,N,B,W,ce),$e}function e(O,L,N,B,W){var Y,H;if(W===J(O,L,N,B)>0)for(Y=L;Y<N;Y+=B)H=j(Y,O[Y],O[Y+1],H);else for(Y=N-B;Y>=L;Y-=B)H=j(Y,O[Y],O[Y+1],H);if(H&&M(H,H.next)){var K=H.next;V(H),H=K}return H}function i(O,L){if(!O)return O;L||(L=O);var N,B=O;do if(N=!1,B.steiner||!M(B,B.next)&&C(B.prev,B,B.next)!==0)B=B.next;else{var W=B.prev;if(V(B),(B=L=W)===B.next)break;N=!0}while(N||B!==L);return L}function r(O,L,N,B,W,Y,H){if(O){!H&&Y&&y(O,B,W,Y);for(var K,fe,ce=O;O.prev!==O.next;)if(K=O.prev,fe=O.next,Y?n(O,B,W,Y):s(O))L.push(K.i/N),L.push(O.i/N),L.push(fe.i/N),V(O),O=fe.next,ce=fe.next;else if((O=fe)===ce){H?H===1?r(O=o(i(O),L,N),L,N,B,W,Y,2):H===2&&a(O,L,N,B,W,Y):r(i(O),L,N,B,W,Y,1);break}}}function s(O){var L=O.prev,N=O,B=O.next;if(C(L,N,B)>=0)return!1;for(var W=O.next.next;W!==O.prev;){if(S(L.x,L.y,N.x,N.y,B.x,B.y,W.x,W.y)&&C(W.prev,W,W.next)>=0)return!1;W=W.next}return!0}function n(O,L,N,B){var W=O.prev,Y=O,H=O.next;if(C(W,Y,H)>=0)return!1;for(var K=W.x<Y.x?W.x<H.x?W.x:H.x:Y.x<H.x?Y.x:H.x,fe=W.y<Y.y?W.y<H.y?W.y:H.y:Y.y<H.y?Y.y:H.y,ce=W.x>Y.x?W.x>H.x?W.x:H.x:Y.x>H.x?Y.x:H.x,me=W.y>Y.y?W.y>H.y?W.y:H.y:Y.y>H.y?Y.y:H.y,Ie=b(K,fe,L,N,B),He=b(ce,me,L,N,B),$e=O.prevZ,Le=O.nextZ;$e&&$e.z>=Ie&&Le&&Le.z<=He;){if($e!==O.prev&&$e!==O.next&&S(W.x,W.y,Y.x,Y.y,H.x,H.y,$e.x,$e.y)&&C($e.prev,$e,$e.next)>=0||($e=$e.prevZ,Le!==O.prev&&Le!==O.next&&S(W.x,W.y,Y.x,Y.y,H.x,H.y,Le.x,Le.y)&&C(Le.prev,Le,Le.next)>=0))return!1;Le=Le.nextZ}for(;$e&&$e.z>=Ie;){if($e!==O.prev&&$e!==O.next&&S(W.x,W.y,Y.x,Y.y,H.x,H.y,$e.x,$e.y)&&C($e.prev,$e,$e.next)>=0)return!1;$e=$e.prevZ}for(;Le&&Le.z<=He;){if(Le!==O.prev&&Le!==O.next&&S(W.x,W.y,Y.x,Y.y,H.x,H.y,Le.x,Le.y)&&C(Le.prev,Le,Le.next)>=0)return!1;Le=Le.nextZ}return!0}function o(O,L,N){var B=O;do{var W=B.prev,Y=B.next.next;!M(W,Y)&&P(W,B,B.next,Y)&&U(W,Y)&&U(Y,W)&&(L.push(W.i/N),L.push(B.i/N),L.push(Y.i/N),V(B),V(B.next),B=O=Y),B=B.next}while(B!==O);return i(B)}function a(O,L,N,B,W,Y){var H=O;do{for(var K=H.next.next;K!==H.prev;){if(H.i!==K.i&&T(H,K)){var fe=k(H,K);return H=i(H,H.next),fe=i(fe,fe.next),r(H,L,N,B,W,Y),void r(fe,L,N,B,W,Y)}K=K.next}H=H.next}while(H!==O)}function l(O,L,N,B){var W,Y,H,K=[];for(W=0,Y=L.length;W<Y;W++)(H=e(O,L[W]*B,W<Y-1?L[W+1]*B:O.length,B,!1))===H.next&&(H.steiner=!0),K.push(w(H));for(K.sort(c),W=0;W<K.length;W++)N=i(N=p(K[W],N),N.next);return N}function c(O,L){return O.x-L.x}function h(O){if(O.next.prev===O)return O;let L=O;for(;;){const N=L.next;if(N.prev===L||N===L||N===O)break;L=N}return L}function p(O,L){var N=f(O,L);if(!N)return L;var B=k(N,O),W=i(N,N.next);let Y=h(B);return i(Y,Y.next),W=h(W),h(L===N?W:L)}function f(O,L){var N,B=L,W=O.x,Y=O.y,H=-1/0;do{if(Y<=B.y&&Y>=B.next.y&&B.next.y!==B.y){var K=B.x+(Y-B.y)*(B.next.x-B.x)/(B.next.y-B.y);if(K<=W&&K>H){if(H=K,K===W){if(Y===B.y)return B;if(Y===B.next.y)return B.next}N=B.x<B.next.x?B:B.next}}B=B.next}while(B!==L);if(!N)return null;if(W===H)return N;var fe,ce=N,me=N.x,Ie=N.y,He=1/0;B=N;do W>=B.x&&B.x>=me&&W!==B.x&&S(Y<Ie?W:H,Y,me,Ie,Y<Ie?H:W,Y,B.x,B.y)&&(fe=Math.abs(Y-B.y)/(W-B.x),U(B,O)&&(fe<He||fe===He&&(B.x>N.x||B.x===N.x&&g(N,B)))&&(N=B,He=fe)),B=B.next;while(B!==ce);return N}function g(O,L){return C(O.prev,O,L.prev)<0&&C(L.next,O,O.next)<0}function y(O,L,N,B){var W=O;do{if(W.z===null&&(W.z=b(W.x,W.y,L,N,B)),W.prev.next!==W||W.next.prev!==W)return W.prev.next=W,W.next.prev=W,y(O,L,N,B);W.prevZ=W.prev,W.nextZ=W.next,W=W.next}while(W!==O);W.prevZ.nextZ=null,W.prevZ=null,v(W)}function v(O){var L,N,B,W,Y,H,K,fe,ce=1;do{for(N=O,O=null,Y=null,H=0;N;){for(H++,B=N,K=0,L=0;L<ce&&(K++,B=B.nextZ);L++);for(fe=ce;K>0||fe>0&&B;)K!==0&&(fe===0||!B||N.z<=B.z)?(W=N,N=N.nextZ,K--):(W=B,B=B.nextZ,fe--),Y?Y.nextZ=W:O=W,W.prevZ=Y,Y=W;N=B}Y.nextZ=null,ce*=2}while(H>1);return O}function b(O,L,N,B,W){return(O=1431655765&((O=858993459&((O=252645135&((O=16711935&((O=32767*(O-N)*W)|O<<8))|O<<4))|O<<2))|O<<1))|(L=1431655765&((L=858993459&((L=252645135&((L=16711935&((L=32767*(L-B)*W)|L<<8))|L<<4))|L<<2))|L<<1))<<1}function w(O){var L=O,N=O;do(L.x<N.x||L.x===N.x&&L.y<N.y)&&(N=L),L=L.next;while(L!==O);return N}function S(O,L,N,B,W,Y,H,K){return(W-H)*(L-K)-(O-H)*(Y-K)>=0&&(O-H)*(B-K)-(N-H)*(L-K)>=0&&(N-H)*(Y-K)-(W-H)*(B-K)>=0}function T(O,L){return O.next.i!==L.i&&O.prev.i!==L.i&&!D(O,L)&&(U(O,L)&&U(L,O)&&G(O,L)&&(C(O.prev,O,L.prev)||C(O,L.prev,L))||M(O,L)&&C(O.prev,O,O.next)>0&&C(L.prev,L,L.next)>0)}function C(O,L,N){return(L.y-O.y)*(N.x-L.x)-(L.x-O.x)*(N.y-L.y)}function M(O,L){return O.x===L.x&&O.y===L.y}function P(O,L,N,B){var W=z(C(O,L,N)),Y=z(C(O,L,B)),H=z(C(N,B,O)),K=z(C(N,B,L));return W!==Y&&H!==K||!(W!==0||!F(O,N,L))||!(Y!==0||!F(O,B,L))||!(H!==0||!F(N,O,B))||!(K!==0||!F(N,L,B))}function F(O,L,N){return L.x<=Math.max(O.x,N.x)&&L.x>=Math.min(O.x,N.x)&&L.y<=Math.max(O.y,N.y)&&L.y>=Math.min(O.y,N.y)}function z(O){return O>0?1:O<0?-1:0}function D(O,L){var N=O;do{if(N.i!==O.i&&N.next.i!==O.i&&N.i!==L.i&&N.next.i!==L.i&&P(N,N.next,O,L))return!0;N=N.next}while(N!==O);return!1}function U(O,L){return C(O.prev,O,O.next)<0?C(O,L,O.next)>=0&&C(O,O.prev,L)>=0:C(O,L,O.prev)<0||C(O,O.next,L)<0}function G(O,L){var N=O,B=!1,W=(O.x+L.x)/2,Y=(O.y+L.y)/2;do N.y>Y!=N.next.y>Y&&N.next.y!==N.y&&W<(N.next.x-N.x)*(Y-N.y)/(N.next.y-N.y)+N.x&&(B=!B),N=N.next;while(N!==O);return B}function k(O,L){var N=new q(O.i,O.x,O.y),B=new q(L.i,L.x,L.y),W=O.next,Y=L.prev;return O.next=L,L.prev=O,N.next=W,W.prev=N,B.next=N,N.prev=B,Y.next=B,B.prev=Y,B}function j(O,L,N,B){var W=new q(O,L,N);return B?(W.next=B.next,W.prev=B,B.next.prev=W,B.next=W):(W.prev=W,W.next=W),W}function V(O){O.next.prev=O.prev,O.prev.next=O.next,O.prevZ&&(O.prevZ.nextZ=O.nextZ),O.nextZ&&(O.nextZ.prevZ=O.prevZ)}function q(O,L,N){this.i=O,this.x=L,this.y=N,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function J(O,L,N,B){for(var W=0,Y=L,H=N-B;Y<N;Y+=B)W+=(O[H]-O[Y])*(O[Y+1]+O[H+1]),H=Y;return W}return t.deviation=function(O,L,N,B){var W=L&&L.length,Y=W?L[0]*N:O.length,H=Math.abs(J(O,0,Y,N));if(W)for(var K=0,fe=L.length;K<fe;K++){var ce=L[K]*N,me=K<fe-1?L[K+1]*N:O.length;H-=Math.abs(J(O,ce,me,N))}var Ie=0;for(K=0;K<B.length;K+=3){var He=B[K]*N,$e=B[K+1]*N,Le=B[K+2]*N;Ie+=Math.abs((O[He]-O[Le])*(O[$e+1]-O[He+1])-(O[He]-O[$e])*(O[Le+1]-O[He+1]))}return H===0&&Ie===0?0:Math.abs((Ie-H)/H)},t.flatten=function(O){for(var L=O[0][0].length,N={vertices:[],holes:[],dimensions:L},B=0,W=0;W<O.length;W++){for(var Y=0;Y<O[W].length;Y++)for(var H=0;H<L;H++)N.vertices.push(O[W][Y][H]);W>0&&(B+=O[W-1].length,N.holes.push(B))}return N},t},(Lce=Fce())!==void 0&&(Dce.exports=Lce);const Lb=kce.exports,nR=le.getLogger("esri.views.3d.support.buffer.math");function qT(t,e,i){if(t.count!==e.count)return void nR.error("source and destination buffers need to have the same number of elements");const r=t.count,s=i[0],n=i[1],o=i[2],a=i[4],l=i[5],c=i[6],h=i[8],p=i[9],f=i[10],g=i[12],y=i[13],v=i[14],b=t.typedBuffer,w=t.typedBufferStride,S=e.typedBuffer,T=e.typedBufferStride;for(let C=0;C<r;C++){const M=C*w,P=C*T,F=S[P],z=S[P+1],D=S[P+2];b[M]=s*F+a*z+h*D+g,b[M+1]=n*F+l*z+p*D+y,b[M+2]=o*F+c*z+f*D+v}}function H0(t,e,i){if(t.count!==e.count)return void nR.error("source and destination buffers need to have the same number of elements");const r=t.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],g=t.typedBuffer,y=t.typedBufferStride,v=e.typedBuffer,b=e.typedBufferStride;for(let w=0;w<r;w++){const S=w*y,T=w*b,C=v[T],M=v[T+1],P=v[T+2];g[S]=s*C+a*M+h*P,g[S+1]=n*C+l*M+p*P,g[S+2]=o*C+c*M+f*P}}function w7(t,e,i){const r=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=i*o[h],s[c+1]=i*o[h+1],s[c+2]=i*o[h+2]}}function x7(t,e){const i=Math.min(t.count,e.count),r=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride;for(let a=0;a<i;a++){const l=a*s,c=a*o,h=n[c],p=n[c+1],f=n[c+2],g=Math.sqrt(h*h+p*p+f*f);if(g>0){const y=1/g;r[l]=y*h,r[l+1]=y*p,r[l+2]=y*f}}}function LUe(t,e,i){const r=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=o[h]>>i,s[c+1]=o[h+1]>>i,s[c+2]=o[h+2]>>i}}Object.freeze({__proto__:null,transformMat4:qT,transformMat3:H0,scale:w7,normalize:x7,shiftRight:LUe});function oR(t,e){if(!t||t.symbol)return null;const i=e&&e.renderer;return t&&_(i)&&i.getObservationRenderer?i.getObservationRenderer(t):i}function kUe(t,e){if(_(t.symbol))return t.symbol;const i=oR(t,e);return _(i)&&i.type!=="dot-density"?i.getSymbol(t,e):null}function Iat(t,e){const i=oR(t,e),r=kUe(t,e);if(A(r))return null;const s={renderer:i,symbol:r};if(A(i)||!("visualVariables"in i)||!i.visualVariables)return s;const n=s8(i,t,e),o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)switch(a.type){case"color":s.color=l.toRgba();break;case"size":if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;switch(c){case"width":o[0]=h;break;case"depth":o[1]=h;break;case"height":o[2]=h;break;case"width-and-depth":o[0]=o[1]=h;break;default:o[0]=o[1]=o[2]=h}}break;case"opacity":s.opacity=l;break;case"rotation":switch(a.axis){case"tilt":s.tilt=l;break;case"roll":s.roll=l;break;default:s.heading=l}}return o[0]==="proportional"&&o[1]==="proportional"&&o[2]==="proportional"||(s.size=o),s}async function zUe(t,e){if(_(t.symbol))return t.symbol;const i=oR(t,e);return _(i)&&i.getSymbolAsync(t,he(E({},e),{abortOptions:{signal:e.signal}}))}async function Dat(t,e){const i=oR(t,e),r=await zUe(t,e);if(!r)return null;const s={renderer:i,symbol:r};if(!i||!("visualVariables"in i)||!i.visualVariables)return s;const n=s8(i,t,e),o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)if(a.type==="color")s.color=Ae.toUnitRGBA(l);else if(a.type==="size")if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;c==="width"?o[0]=h:c==="depth"?o[1]=h:c==="height"?o[2]=h:o[0]=o[1]=c==="width-and-depth"?h:o[2]=h}else a.type==="opacity"?s.opacity=l:a.type==="rotation"&&a.axis==="tilt"?s.tilt=l:a.type==="rotation"&&a.axis==="roll"?s.roll=l:a.type==="rotation"&&(s.heading=l);return(isFinite(o[0])||isFinite(o[1])||isFinite(o[2]))&&(s.size=o),s}function VUe(t,e=0){const i=t[e];return typeof i=="number"&&isFinite(i)?i:null}function NUe(t){for(let e=0;e<3;e++){const i=t[e];if(typeof i=="number")return isFinite(i)?i:0}return 0}function zce(t,e,i){var r;const s=t.byteLength/(4*e),n=new Uint32Array(t,0,s*e);let o=new Uint32Array(s);const a=(r=i==null?void 0:i.minReduction)!=null?r:0,l=(i==null?void 0:i.originalIndices)||null,c=l?l.length:0,h=(i==null?void 0:i.componentOffsets)||null;let p=0;if(h)for(let P=0;P<h.length-1;P++){const F=h[P+1]-h[P];F>p&&(p=F)}else p=s;const f=Math.floor(1.1*p)+1;(Ju==null||Ju.length<2*f)&&(Ju=new Uint32Array(Op(2*f)));for(let P=0;P<2*f;P++)Ju[P]=0;let g=0;const y=!!h&&!!l,v=y?c:s,b=y?new Uint32Array(c):null,w=1.96;let S=a!==0?Math.ceil(4*w*w/(a*a)*a*(1-a)):v,T=1,C=h?h[1]:v;for(let P=0;P<v;P++){if(P===S){const k=1-g/P;if(k+w*Math.sqrt(k*(1-k)/P)<a)return null;S*=2}if(P===C){for(let k=0;k<2*f;k++)Ju[k]=0;if(l)for(let k=h[T-1];k<h[T];k++)b[k]=o[l[k]];C=h[++T]}const F=y?l[P]:P,z=F*e,D=BUe(n,z,e);let U=D%f,G=g;for(;Ju[2*U+1]!==0;){if(Ju[2*U]===D){const k=Ju[2*U+1]-1;if(UUe(n,z,k*e,e)){G=o[k];break}}U++,U>=f&&(U-=f)}G===g&&(Ju[2*U]=D,Ju[2*U+1]=F+1,g++),o[F]=G}if(a!==0&&1-g/s<a)return null;if(y){for(let P=h[T-1];P<b.length;P++)b[P]=o[l[P]];o=b}const M=new Uint32Array(e*g);g=0;for(let P=0;P<v;P++)o[P]===g&&(jUe(n,(y?l[P]:P)*e,M,g*e,e),g++);if(l&&!y){const P=new Uint32Array(c);for(let F=0;F<P.length;F++)P[F]=o[l[F]];o=P}return{buffer:M.buffer,indices:o,uniqueCount:g}}function UUe(t,e,i,r){for(let s=0;s<r;s++)if(t[e+s]!==t[i+s])return!1;return!0}function jUe(t,e,i,r,s){for(let n=0;n<s;n++)i[r+n]=t[e+n]}function BUe(t,e,i){let r=0;for(let s=0;s<i;s++)r=t[e+s]+r|0,r=r+(r<<11)+(r>>>2)|0;return r>>>0}let Ju=null;function Fat(t){const e=HT(t.rings,t.hasZ,1),i=[];let r=0,s=0;for(const a of e.polygons){const l=a.count,c=a.index,h=new Float64Array(e.position.buffer,3*c*e.position.BYTES_PER_ELEMENT,3*l),p=a.holeIndices.map(g=>g-c),f=new Uint32Array(Lb(h,p,3));i.push({position:h,faces:f}),r+=h.length,s+=f.length}const n=GUe(i,r,s),o=zce(n.position.buffer,6,{originalIndices:n.faces});return n.position=new Float64Array(o.buffer),n.faces=o.indices,n}function GUe(t,e,i){if(t.length===1)return t[0];const r=new Float64Array(e),s=new Uint32Array(i);let n=0,o=0,a=0;for(const l of t){for(let c=0;c<l.position.length;c++)r[n++]=l.position[c];for(let c=0;c<l.faces.length;c++)s[o++]=l.faces[c]+a;a=n/3}return{position:r,faces:s}}function HT(t,e,i){const r=t.length,s=new Array(r),n=new Array(r),o=new Array(r);let a=0,l=0,c=0,h=0;for(let g=0;g<r;++g)h+=t[g].length;const p=new Float64Array(3*h);let f=0;for(let g=r-1;g>=0;g--){const y=t[g],v=i===1&&qUe(y);if(v&&r!==1)s[a++]=y;else{let b=y.length;for(let S=0;S<a;++S)b+=s[S].length;const w={index:f,pathLengths:new Array(a+1),count:b,holeIndices:new Array(a)};w.pathLengths[0]=y.length,y.length>0&&(o[c++]={index:f,count:y.length}),f=v?aR(y,y.length-1,-1,p,f,y.length,e):aR(y,0,1,p,f,y.length,e);for(let S=0;S<a;++S){const T=s[S];w.holeIndices[S]=f,w.pathLengths[S+1]=T.length,T.length>0&&(o[c++]={index:f,count:T.length}),f=aR(T,0,1,p,f,T.length,e)}a=0,w.count>0&&(n[l++]=w)}}for(let g=0;g<a;++g){const y=s[g];y.length>0&&(o[c++]={index:f,count:y.length}),f=aR(y,0,1,p,f,y.length,e)}return l<r&&(n.length=l),c<r&&(o.length=c),{position:p,polygons:n,outlines:o}}function aR(t,e,i,r,s,n,o){s*=3;for(let a=0;a<n;++a){const l=t[e];r[s++]=l[0],r[s++]=l[1],r[s++]=o?l[2]:0,e+=i}return s/3}function qUe(t){return!BF(t,!1,!1)}class HUe{constructor(e,i){this.vec3=e,this.id=i}}function WT(t,e,i,r){return new HUe(De(t,e,i),r)}class Vce{constructor(e,i){this.index=e,this.renderTargets=i,this.extent=pt(),this.resolution=0,this.renderLocalOrigin=WT(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries={extents:[pt(),pt(),pt()],numViews:0},this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(i.renderTargets.length).fill(!1)}getValidTarget(e){return this.validTargets[e]?this.renderTargets.getTarget(e):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const i=e===1?this.renderTargets.getTarget(0):e===2?this.renderTargets.getTarget(2):this.renderTargets.getTarget(4);return i?i.getTexture():null}getNormalTexture(e){const i=e===1?this.renderTargets.getTarget(3):null;return i?i.getTexture():null}draw(e,i){const r=this.computeRenderTargetValidityBitfield(),s=this.needsColorWithoutRasterImage;for(const n of this.renderTargets.renderTargets)n.type===1&&s===!1?this.validTargets[n.type]=!1:this.validTargets[n.type]=e.drawTarget(this,n,i);return r^this.computeRenderTargetValidityBitfield()?0:1}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[0]|+e[1]<<1|+e[2]<<2|+e[3]<<3|+e[4]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const i=.001*e.range;if(this.extent[0]-i<=e.min){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];hP(this.extent,e.range,0,r)}if(this.extent[2]+i>=e.max){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];hP(this.extent,-e.range,0,r)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,Bp(this.canvasGeometries.extents[0],this.extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const i=this.canvasGeometries.extents[e];if(i[0]!==i[2]&&i[1]!==i[3])return!0}return!1}applyViewport(e){e.setViewport(this.index===0?0:this.resolution,0,this.resolution,this.resolution)}}function WUe(t,e,i){return Math.min(Op(Math.max(t,e)+256),i)}class Nce{constructor(e,i){this.size=_7(),this._fbo=null,this._fbo=new ci(e,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:i,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=Ge(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return this._fbo!==null}resize(e,i){this.size[0]=e,this.size[1]=i,this._fbo.resize(this.size[0],this.size[1])}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}disposeRenderTargetMemory(){var e;(e=this._fbo)==null||e.resize(0,0)}get gpuMemoryUsage(){var e,i;return(e=(i=this._fbo)==null?void 0:i.gpuMemoryUsage)!=null?e:0}}class ZUe{constructor(e){const i=(r,s,n=!0)=>({type:s,fbo:new Nce(e,n),renderPass:r,valid:!1,lastUsed:1/0});this.renderTargets=[i(0,0),i(0,1),i(5,2,!1),i(3,3),i(0,4)]}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,i,r){if(e)i.lastUsed=r;else if(r-i.lastUsed>JUe)i.fbo.disposeRenderTargetMemory(),i.lastUsed=1/0;else if(i.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce((e,i)=>e+i.fbo.gpuMemoryUsage,0)}}const JUe=1e3;class Uce{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return this._outer.size===0}get(e,i){var r;return(r=this._outer.get(e))==null?void 0:r.get(i)}set(e,i,r){const s=this._outer.get(e);s?s.set(i,r):this._outer.set(e,new Map([[i,r]]))}delete(e,i){const r=this._outer.get(e);r&&(r.delete(i),r.size===0&&this._outer.delete(e))}forEach(e){this._outer.forEach((i,r)=>e(i,r))}}class QUe{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class jce{constructor(e){this._context=e,this._perConstructorInstances=new Uce,this._frameCounter=0,this._keepAliveFrameCount=Bce}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach(e=>e.forEach(i=>i.technique.dispose())),this._perConstructorInstances.clear()}acquire(e,i){const r=i.key;let s=this._perConstructorInstances.get(e,r);if(A(s)){const n=new e(this._context,i,()=>this.release(n));s=new QUe(n),this._perConstructorInstances.set(e,r,s)}return++s.refCount,s.technique}releaseAndAcquire(e,i,r){if(_(r)){if(i.key===r.key)return r;r.release()}return this.acquire(e,i)}release(e){if(A(e)||this._perConstructorInstances.empty)return;const i=this._perConstructorInstances.get(e.constructor,e.key);A(i)||(--i.refCount,i.refCount===0&&(i.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==Bce&&this._perConstructorInstances.forEach((e,i)=>{e.forEach((r,s)=>{r.refCount===0&&r.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(r.technique.dispose(),this._perConstructorInstances.delete(i,s))})})}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach((i,r)=>{const s=async(n,o)=>{const a=o.shader;a&&(await a.reload(),n.forEach(l=>{l.technique.reload(this._context)}))};e.push(s(i,r))}),await Promise.all(e)}}const Bce=-1,lR=t=>{class e extends t{constructor(){super(...arguments),this._isDisposed=!1}dispose(){for(const s of(r=this._managedDisposables)!=null?r:[]){var r;const n=this[s];this[s]=null,n&&typeof n.dispose=="function"&&n.dispose()}this._isDisposed=!0}get isDisposed(){return this._isDisposed}}return e};class cR extends lR(class{}){}function Cs(){return(t,e)=>{var i,r;t.hasOwnProperty("_managedDisposables")||(t._managedDisposables=(i=(r=t._managedDisposables)==null?void 0:r.slice())!=null?i:[]),t._managedDisposables.unshift(e)}}const YUe=le.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository");class XUe{constructor(e){this._glMaterial=e,this.refCnt=0,this._glMaterial=e}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,Ze(this.refCnt>=0)}getRefCnt(){return this.refCnt}get glMaterial(){return this._glMaterial}}class Gce{constructor(e,i,r,s){this._textureRepository=e,this._techniqueRepository=i,this.materialChanged=r,this.requestRender=s,this._id2glMaterialRef=new Uce}dispose(){this._textureRepository.dispose()}acquire(e,i){this._ownMaterial(e);let r=this._id2glMaterialRef.get(i,e.id);if(A(r)){const s=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:i});r=new XUe(s),this._id2glMaterialRef.set(i,e.id,r)}return r.incRefCnt(),r.glMaterial}release(e,i){const r=this._id2glMaterialRef.get(i,e.id);_(r)&&(r.decRefCnt(),r.getRefCnt()===0&&(Ge(r.glMaterial),this._id2glMaterialRef.delete(i,e.id)))}_ownMaterial(e){_(e.repository)&&e.repository!==this&&YUe.error("Material is already owned by a different material repository"),e.repository=this}}const KUe=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"];class qce{constructor(e,i){this._objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new Vi,this._objectCount=0,i&&(i.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=i.maximumObjectsPerNode),i.maximumDepth!==void 0&&(this._maximumDepth=i.maximumDepth))}get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}destroy(){this._degenerateObjects.clear(),Vi.clearPool(),T7[0]=null,W0.prune(),Z0.prune()}add(e,i=e.length){this._objectCount+=i,this._grow(e,i);const r=Vi.acquire();for(let s=0;s<i;s++){const n=e[s];this._isDegenerate(n)?this._degenerateObjects.add(n):(r.init(this._root),this._add(n,r))}Vi.release(r)}remove(e,i=null){this._objectCount-=e.length;const r=Vi.acquire();for(const s of e){const n=_(i)?i:F1(this._objectToBoundingSphere(s),sje);ZT(n[3])?(r.init(this._root),this._remove(s,n,r)):this._degenerateObjects.delete(s)}Vi.release(r),this._shrink()}update(e,i){if(!ZT(i[3])&&this._isDegenerate(e))return;const r=rje(e);this.remove(r,i),this.add(r)}forEachAlongRay(e,i,r){const s=Ko(e,i);this._forEachNode(this._root,n=>{if(!this._intersectsNode(s,n))return!1;const o=n.node;return o.terminals.forAll(a=>{this._intersectsObject(s,a)&&r(a)}),o.residents!==null&&o.residents.forAll(a=>{this._intersectsObject(s,a)&&r(a)}),!0})}forEachAlongRayWithVerticalOffset(e,i,r,s){const n=Ko(e,i);this._forEachNode(this._root,o=>{if(!this._intersectsNodeWithOffset(n,o,s))return!1;const a=o.node;return a.terminals.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&r(l)}),a.residents!==null&&a.residents.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&r(l)}),!0})}forEach(e){this._forEachNode(this._root,i=>{const r=i.node;return r.terminals.forAll(e),r.residents!==null&&r.residents.forAll(e),!0}),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,i,r,s=()=>!0,n=1/0){let o=1/0,a=1/0,l=null;const c=S7(e,i),h=p=>{if(--n,!s(p))return;const f=this._objectToBoundingSphere(p);if(!am(r,f))return;const g=Am(e,i,ea(f)),y=g-f[3],v=g+f[3];y<o&&(o=y,a=v,l=p)};return this._forEachNodeDepthOrdered(this._root,p=>{if(n<=0||!am(r,p.bounds)||(se(dl,c,p.halfSize),de(dl,dl,p.bounds),Am(e,i,dl)>a))return!1;const f=p.node;return f.terminals.forAll(g=>h(g)),f.residents!==null&&f.residents.forAll(g=>h(g)),!0},e,i),l}forEachInDepthRange(e,i,r,s,n,o,a){let l=-1/0,c=1/0;const h={setRange:v=>{r===1?(l=Math.max(l,v.near),c=Math.min(c,v.far)):(l=Math.max(l,-v.far),c=Math.min(c,-v.near))}};h.setRange(s);const p=Am(i,r,e),f=S7(i,r),g=S7(i,-r),y=v=>{if(!a(v))return;const b=this._objectToBoundingSphere(v),w=ea(b),S=Am(i,r,w)-p,T=S-b[3],C=S+b[3];T>c||C<l||!am(o,b)||n(v,h)};this._forEachNodeDepthOrdered(this._root,v=>{if(!am(o,v.bounds)||(se(dl,f,v.halfSize),de(dl,dl,v.bounds),Am(i,r,dl)-p>c)||(se(dl,g,v.halfSize),de(dl,dl,v.bounds),Am(i,r,dl)-p<l))return!1;const b=v.node;return b.terminals.forAll(w=>y(w)),b.residents!==null&&b.residents.forAll(w=>y(w)),!0},i,r)}forEachNode(e){this._forEachNode(this._root,i=>e(i.node,i.bounds,i.halfSize))}_intersectsNode(e,i){return uR(i.bounds,2*-i.halfSize,ga),uR(i.bounds,2*i.halfSize,ya),Bne(e.origin,e.direction,ga,ya)}_intersectsNodeWithOffset(e,i,r){return uR(i.bounds,2*-i.halfSize,ga),uR(i.bounds,2*i.halfSize,ya),r.applyToMinMax(ga,ya),Bne(e.origin,e.direction,ga,ya)}_intersectsObject(e,i){const r=this._objectToBoundingSphere(i);return!(r[3]>0)||$6(r,e)}_intersectsObjectWithOffset(e,i,r){const s=this._objectToBoundingSphere(i);return!(s[3]>0)||$6(r.applyToBoundingSphere(s),e)}_forEachNode(e,i){let r=Vi.acquire().init(e);const s=[r];for(;s.length!==0;){if(r=s.pop(),i(r)&&!r.isLeaf())for(let n=0;n<r.node.children.length;n++)r.node.children[n]&&s.push(Vi.acquire().init(r).advance(n));Vi.release(r)}}_forEachNodeDepthOrdered(e,i,r,s=1){let n=Vi.acquire().init(e);const o=[n];for(ije(r,s,Qce);o.length!==0;){if(n=o.pop(),i(n)&&!n.isLeaf())for(let a=7;a>=0;--a){const l=Qce[a];n.node.children[l]&&o.push(Vi.acquire().init(n).advance(l))}Vi.release(n)}}_remove(e,i,r){W0.clear();const s=r.advanceTo(i,(n,o)=>{W0.push(n.node),W0.push(o)})?r.node.terminals:r.node.residents;if(s.removeUnordered(e),s.length===0)for(let n=W0.length-2;n>=0;n-=2){const o=W0.data[n],a=W0.data[n+1];if(!this._purge(o,a))break}}_nodeIsEmpty(e){if(e.terminals.length!==0)return!1;if(e.residents!==null)return e.residents.length===0;for(let i=0;i<e.children.length;i++)if(e.children[i])return!1;return!0}_purge(e,i){return i>=0&&(e.children[i]=null),!!this._nodeIsEmpty(e)&&(e.residents===null&&(e.residents=new ct({shrink:!0})),!0)}_add(e,i){i.advanceTo(this._objectToBoundingSphere(e))?i.node.terminals.push(e):(i.node.residents.push(e),i.node.residents.length>this._maximumObjectsPerNode&&i.depth<this._maximumDepth&&this._split(i))}_split(e){const i=e.node.residents;e.node.residents=null;for(let r=0;r<i.length;r++){const s=Vi.acquire().init(e);this._add(i.getItemAt(r),s),Vi.release(s)}}_grow(e,i){if(i!==0&&(Hce(e,i,r=>this._objectToBoundingSphere(r),Qu),ZT(Qu[3])&&!this._fitsInsideTree(Qu)))if(this._nodeIsEmpty(this._root.node))F1(Qu,this._root.bounds),this._root.halfSize=1.25*Qu[3];else{const r=this._rootBoundsForRootAsSubNode(Qu);this._placingRootViolatesMaxDepth(r)?this._rebuildTree(Qu,r):this._growRootAsSubNode(r),Vi.release(r)}}_rebuildTree(e,i){re(M7,i.bounds),M7[3]=i.halfSize,Hce([e,M7],2,s=>s,P7);const r=Vi.acquire().init(this._root);this._root.initFrom(null,P7,1.25*P7[3]),this._forEachNode(r,s=>(this.add(s.node.terminals.data,s.node.terminals.length),s.node.residents!==null&&this.add(s.node.residents.data,s.node.residents.length),!0)),Vi.release(r)}_placingRootViolatesMaxDepth(e){const i=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let r=0;return this._forEachNode(this._root,s=>(r=Math.max(r,s.depth),r+i<=this._maximumDepth)),r+i>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const i=e[3],r=e;let s=-1/0;const n=this._root.bounds,o=this._root.halfSize;for(let a=0;a<3;a++){const l=n[a]-o-(r[a]-i),c=r[a]+i-(n[a]+o),h=Math.max(0,Math.ceil(l/(2*o))),p=Math.max(0,Math.ceil(c/(2*o)))+1,f=2**Math.ceil(Math.log(h+p)*Math.LOG2E);s=Math.max(s,f),hR[a].min=h,hR[a].max=p}for(let a=0;a<3;a++){let l=hR[a].min,c=hR[a].max;const h=(s-(l+c))/2;l+=Math.ceil(h),c+=Math.floor(h);const p=n[a]-o-l*o*2;C7[a]=p+(c+l)*o}return C7[3]=s*o*Jce,Vi.acquire().initFrom(null,C7,s*o,0)}_growRootAsSubNode(e){const i=this._root.node;re(Qu,this._root.bounds),Qu[3]=this._root.halfSize,this._root.init(e),e.advanceTo(Qu,null,!0),e.node.children=i.children,e.node.residents=i.residents,e.node.terminals=i.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(e===-1)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let e=null;const i=this._root.node.children;let r=0,s=0;for(;s<i.length&&e==null;)r=s++,e=i[r];for(;s<i.length;)if(i[s++])return-1;return r}_isDegenerate(e){return!ZT(this._objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const i=this._root.bounds,r=this._root.halfSize;return e[3]<=r&&e[0]>=i[0]-r&&e[0]<=i[0]+r&&e[1]>=i[1]-r&&e[1]<=i[1]+r&&e[2]>=i[2]-r&&e[2]<=i[2]+r}}class Vi{constructor(){this.bounds=rs(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,i,r,s=this.depth){return this.node=_(e)?e:Vi.createEmptyNode(),_(i)&&F1(i,this.bounds),this.halfSize=r,this.depth=s,this}advance(e){let i=this.node.children[e];i||(i=Vi.createEmptyNode(),this.node.children[e]=i),this.node=i,this.halfSize/=2,this.depth++;const r=Wce[e];return this.bounds[0]+=r[0]*this.halfSize,this.bounds[1]+=r[1]*this.halfSize,this.bounds[2]+=r[2]*this.halfSize,this.bounds[3]=this.halfSize*Jce,this}advanceTo(e,i,r=!1){for(;;){if(this.isTerminalFor(e))return i&&i(this,-1),!0;if(this.isLeaf()){if(!r)return i&&i(this,-1),!1;this.node.residents=null}const s=this._childIndex(e);i&&i(this,s),this.advance(s)}}isLeaf(){return this.node.residents!=null}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const i=this.bounds;return(i[0]<e[0]?1:0)+(i[1]<e[1]?2:0)+(i[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new ct({shrink:!0}),residents:new ct({shrink:!0})}}static acquire(){return Vi._pool.acquire()}static release(e){Vi._pool.release(e)}static clearPool(){Vi._pool.prune()}}function eje(t,e){t[0]=Math.min(t[0],e[0]-e[3]),t[1]=Math.min(t[1],e[1]-e[3]),t[2]=Math.min(t[2],e[2]-e[3])}function tje(t,e){t[0]=Math.max(t[0],e[0]+e[3]),t[1]=Math.max(t[1],e[1]+e[3]),t[2]=Math.max(t[2],e[2]+e[3])}function uR(t,e,i){i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e}function Hce(t,e,i,r){if(e===1){const s=i(t[0]);F1(s,r)}else{ga[0]=1/0,ga[1]=1/0,ga[2]=1/0,ya[0]=-1/0,ya[1]=-1/0,ya[2]=-1/0;for(let s=0;s<e;s++){const n=i(t[s]);ZT(n[3])&&(eje(ga,n),tje(ya,n))}jr(r,ga,ya,.5),r[3]=Math.max(ya[0]-ga[0],ya[1]-ga[1],ya[2]-ga[2])/2}}function ije(t,e,i){if(!Z0.length)for(let r=0;r<8;++r)Z0.push({index:0,distance:0});for(let r=0;r<8;++r){const s=Wce[r];Z0.data[r].index=r,Z0.data[r].distance=Am(t,e,s)}Z0.sort((r,s)=>r.distance-s.distance);for(let r=0;r<8;++r)i[r]=Z0.data[r].index}function S7(t,e){let i=1/0,r=null;for(let s=0;s<8;++s){const n=Am(t,e,Zce[s]);n<i&&(i=n,r=Zce[s])}return r}function Am(t,e,i){return e*(t[0]*i[0]+t[1]*i[1]+t[2]*i[2])}function ZT(t){return!isNaN(t)&&t!==-1/0&&t!==1/0&&t>0}Vi._pool=new Xi(Vi);const Wce=[De(-1,-1,-1),De(1,-1,-1),De(-1,1,-1),De(1,1,-1),De(-1,-1,1),De(1,-1,1),De(-1,1,1),De(1,1,1)],Zce=[De(-1,-1,-1),De(-1,-1,1),De(-1,1,-1),De(-1,1,1),De(1,-1,-1),De(1,-1,1),De(1,1,-1),De(1,1,1)],Jce=Math.sqrt(3),T7=[null];function rje(t){return T7[0]=t,T7}const C7=rs(),dl=$(),ga=$(),ya=$(),W0=new ct,sje=rs(),Qu=rs(),M7=rs(),P7=rs(),hR=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],Z0=new ct,Qce=[0,0,0,0,0,0,0,0];class Yce extends ab{constructor(e,i=""){var r,s,n;super(),this.apiLayerUid=i,this.type=0,this.events=new Ci,this.isSliceable=!1,this._objects=new ct,this._stageHandles=new dt,this.apiLayerUid=i,this.isVisible=(r=e==null?void 0:e.isVisible)==null||r,this.isPickable=(s=e==null?void 0:e.isPickable)==null||s,this.updatePolicy=(n=e==null?void 0:e.updatePolicy)!=null?n:0}get objects(){return this._objects}destroy(){this.detachStage(),this._stage=null}attachStage(e){this.detachStage(),this._stage=e;for(const i of KUe)this._stageHandles.add(this.events.on(i,r=>e.handleEvent(i,r)))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),_(this._octree)&&this._octree.add([e])}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),_(this._octree)&&this._octree.remove([e]))}addMany(e){this._objects.pushArray(e);for(const i of e)i.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),_(this._octree)&&this._octree.add(e)}removeMany(e){const i=new Array;if(this._objects.removeUnorderedMany(e,e.length,i),i.length!==0){for(const r of i)r.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:i}),_(this._octree)&&this._octree.remove(i)}}sync(){_(this._stage)&&this.updatePolicy!==1&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(e,i){_(this._octree)&&this._octree.update(e,i)}getSpatialQueryAccelerator(){return A(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=tt(this._octree)}_createOctree(){this._octree=new qce(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)}}function dR(t){return _(t)&&t.type===0}var A7;(function(t){t.Default={vvSizeEnabled:!1,vvSizeMinSize:xt(1,1,1),vvSizeMaxSize:xt(100,100,100),vvSizeOffset:xt(0,0,0),vvSizeFactor:xt(1,1,1),vvSizeValue:xt(1,1,1),vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvOpacityEnabled:!1,vvOpacityValues:[0,0,0,0,0,0,0,0],vvOpacityOpacities:[1,1,1,1,1,1,1,1],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:Ai()}})(A7||(A7={}));const Xce=A7;function nje(t,e){t.vertex.uniforms.add("intrinsicWidth","float"),e.vvSize?(t.attributes.add("sizeFeatureAttribute","float"),t.vertex.uniforms.add("vvSizeMinSize","vec3"),t.vertex.uniforms.add("vvSizeMaxSize","vec3"),t.vertex.uniforms.add("vvSizeOffset","vec3"),t.vertex.uniforms.add("vvSizeFactor","vec3"),t.vertex.code.add(x`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(t.attributes.add("size","float"),t.vertex.code.add(x`float getSize(){
return intrinsicWidth * size;
}`)),e.vvOpacity?(t.attributes.add("opacityFeatureAttribute","float"),t.vertex.constants.add("vvOpacityNumber","int",8),t.vertex.code.add(x`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):t.vertex.code.add(x`vec4 applyOpacity( vec4 color ){
return color;
}`),e.vvColor?(t.attributes.add("colorFeatureAttribute","float"),t.vertex.constants.add("vvColorNumber","int",8),t.vertex.code.add(x`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(t.attributes.add("color","vec4"),t.vertex.code.add(x`vec4 getColor(){
return applyOpacity(color);
}`))}function J0(t,e){t.fragment.include(zu),e.output===3?(t.extensions.add("GL_OES_standard_derivatives"),t.fragment.code.add(x`float _calculateFragDepth(const in float depth) {
const float SLOPE_SCALE = 2.0;
const float BIAS = 2.0 * .000015259;
float m = max(abs(dFdx(depth)), abs(dFdy(depth)));
float result = depth + SLOPE_SCALE * m + BIAS;
return clamp(result, .0, .999999);
}
void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_calculateFragDepth(_linearDepth));
}`)):e.output===1&&t.fragment.code.add(x`void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_linearDepth);
}`)}function Kce(t,e){t.constants.add("stippleAlphaColorDiscard","float",.001),t.constants.add("stippleAlphaHighlightDiscard","float",.5),e.stippleEnabled?oje(t,e):aje(t)}function oje(t,e){const i=!(e.draped&&e.stipplePreferContinuous);t.fragment.include(zu),t.vertex.uniforms.add("stipplePatternPixelSize","float"),t.vertex.uniforms.add("pixelRatio","float"),e.draped?t.vertex.uniforms.add("worldToScreenRatio","float"):(t.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),t.vertex.uniforms.add("camPos","vec3"),t.vertex.code.add(x`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - camPos);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),t.varyings.add("vStippleDistance","float"),e.stippleRequiresClamp&&t.varyings.add("vStippleDistanceLimits","vec2"),t.vertex.code.add(x`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${lje};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),t.vertex.code.add(x`
  ${e.stippleRequiresStretchMeasure?x`vec3`:x`vec2`} computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {
  `),i&&t.vertex.code.add(x`
      if (segmentLengthPseudoScreen >= patternLength) {

        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        ${e.stippleRequiresStretchMeasure?x`return vec3(0.0, segmentLengthScreenRounded, repetitions / flooredRepetitions);`:x`return vec2(0.0, segmentLengthScreenRounded);`}
      }
    `),t.vertex.code.add(x`
      ${e.stippleRequiresStretchMeasure?x`return vec3(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen, 1.0)`:x`return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen)`};
    }
  `),t.fragment.uniforms.add("stipplePatternTexture","sampler2D"),t.fragment.uniforms.add("stipplePatternSDFNormalizer","float"),t.fragment.uniforms.add("stipplePatternTextureSize","float"),t.fragment.uniforms.add("stipplePatternPixelSizeInv","float"),e.stippleOffColorEnabled&&t.fragment.uniforms.add("stippleOffColor","vec4"),t.fragment.code.add(x`float padTexture(float u) {
return (u * stipplePatternTextureSize + 1.0)/(stipplePatternTextureSize + 2.0);
}`),t.fragment.code.add(x`
    float getStippleSDF(out bool isClamped) {
      ${e.stippleRequiresClamp?x`
          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;`:x`
          float stippleDistanceClamped = vStippleDistance;
          isClamped = false;`}

      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;
      ${e.stippleScaleWithLineWidth?x`u *= vLineSizeInv;`:""}
      u = padTexture(fract(u));

      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));
      return (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;
    }

    float getStippleSDF() {
      bool ignored;
      return getStippleSDF(ignored);
    }

    float getStippleAlpha() {
      bool isClamped;
      float stippleSDF = getStippleSDF(isClamped);

      float antiAliasedResult = ${e.stippleScaleWithLineWidth?x`clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);`:x`clamp(stippleSDF + 0.5, 0.0, 1.0);`}

      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
    }
  `),e.stippleOffColorEnabled?t.fragment.code.add(x`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`):t.fragment.code.add(x`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}function aje(t){t.fragment.code.add(x`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}const lje=x.float(.4),pR=1;function cje(t){const e=new pi,i=t.stippleEnabled&&t.roundCaps,r=t.falloffEnabled||i,s=t.innerColorEnabled,n=t.stippleEnabled&&t.stippleScaleWithLineWidth||t.roundCaps,o=t.stippleEnabled&&t.stippleScaleWithLineWidth;return e.extensions.add("GL_OES_standard_derivatives"),e.include($E),e.include(nje,t),e.include(Kce,he(E({},t),{stippleRequiresStretchMeasure:i})),t.output===1&&e.include(J0,t),e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraNearFar","vec2").add("pixelRatio","float").add("miterLimit","float").add("screenSize","vec2"),e.attributes.add("position","vec3"),e.attributes.add("subdivisionFactor","float"),e.attributes.add("uv0","vec2"),e.attributes.add("auxpos1","vec3"),e.attributes.add("auxpos2","vec3"),e.varyings.add("vColor","vec4"),e.varyings.add("vpos","vec3"),e.varyings.add("linearDepth","float"),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),n&&e.varyings.add("vLineWidth","float"),o&&e.varyings.add("vLineSizeInv","float"),s&&e.varyings.add("vLineDistance","float"),r&&e.varyings.add("vLineDistanceNorm","float"),t.falloffEnabled&&e.fragment.uniforms.add("falloff","float"),t.innerColorEnabled&&(e.fragment.uniforms.add("innerColor","vec4"),e.fragment.uniforms.add("innerWidth","float")),t.roundCaps&&e.varyings.add("vCapPosition","vec2"),i&&e.varyings.add("vStipplePatternStretch","float"),e.vertex.code.add(x`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),e.vertex.code.add(x`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= screenSize / posNdc.w;
return posNdc;
}`),e.vertex.code.add(x`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = cameraNearFar[0] * 0.99;

      //current pos behind ncp --> we need to clip
      if(pos.z > -cameraNearFar[0]) {
        if (!isStartVertex) {
          //previous in front of ncp
          if(prev.z < -cameraNearFar[0]) {
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
        //next in front of ncp
        if(isStartVertex) {
          if(next.z < -cameraNearFar[0]) {
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        //previous behind ncp
        if (prev.z > -cameraNearFar[0]) {
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        //next behind ncp
        if (next.z > -cameraNearFar[0]) {
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${t.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
`),e.vertex.code.add(x`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;
    vpos = position;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${n?x`vLineWidth = lineWidth;`:""}
      ${o?x`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);

      clipAndTransform(pos, prev, next, isStartVertex);

      vec2 left = (pos.xy - prev.xy);
      vec2 right = (next.xy - pos.xy);

      float leftLen = length(left);
      float rightLen = length(right);
  `),t.stippleEnabled&&e.vertex.code.add(x`float isEndVertex = float(!isStartVertex);
vec4 segmentInfo = mix(vec4(pos.xy, right), vec4(prev.xy, left), isEndVertex);
vec2 segmentOrigin = segmentInfo.xy;
vec2 segment = segmentInfo.zw;`),e.vertex.code.add(x`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),t.roundJoins?e.vertex.code.add(x`
        vec2 startDir;
        vec2 endDir;

        if (leftLen < 0.001) {
          startDir = right;
        }
        else{
          startDir = left;
        }
        startDir = normalize(startDir);
        startDir = PERPENDICULAR(startDir);

        if (rightLen < 0.001) {
          endDir = left;
        }
        else{
          endDir = right;
        }
        endDir = normalize(endDir);
        endDir = PERPENDICULAR(endDir);

        float factor = ${t.stippleEnabled?x`min(1.0, subdivisionFactor * ${x.float((pR+2)/(pR+1))})`:x`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):e.vertex.code.add(x`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = normalize(joinDisplacementDir);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`),e.vertex.code.add(x`displacementLen = lineWidth;
}
} else {
if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = isStartVertex ? right : left;
}
joinDisplacementDir = normalize(joinDisplacementDir);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
displacementLen = lineWidth;
capDisplacementDir = isStartVertex ? -right : left;
capDisplacementDir *= subdivisionFactor;
}`),e.vertex.code.add(x`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${r||s?x`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${s?x`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${r?x`vLineDistanceNorm = lineDistNorm;`:""}

    ${t.roundCaps?x`vCapPosition = isJoin ? vec2(0.0) : dpos;`:""}

    pos.xy += dpos;
  `),t.stippleEnabled&&(t.draped||e.vertex.code.add(x`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),e.vertex.code.add(x`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));`),t.draped?e.vertex.code.add(x`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):e.vertex.code.add(x`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),e.vertex.code.add(x`
      float patternLength = ${t.stippleScaleWithLineWidth?"lineSize * ":""} stipplePatternPixelSize;

      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader
      // The 0.5 factor on the screen length is to correct for pixel ratio (it is calculated at double resolution)
      ${i?x`
            vec3 stippleSegmentInfo = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
            vStippleDistanceLimits = stippleSegmentInfo.xy;
            vStipplePatternStretch = stippleSegmentInfo.z;`:x`
            vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);`}

      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);

      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)
      if (segmentLengthScreenDouble >= 0.001) {
        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the
        // original vertex positions, and slightly outside of that range at the displaced positions
        vec2 stippleDisplacement = pos.xy - segmentOrigin;
        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);

        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)
        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
      }

      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance
      vStippleDistanceLimits *= pos.w;
      vStippleDistance *= pos.w;
    `)),e.vertex.code.add(x`pos.xy = pos.xy / screenSize * pos.w;
vColor = getColor();
vColor.a *= coverage;
gl_Position = pos;
}
}`),t.multipassTerrainEnabled&&(e.fragment.include(Lr),e.include(ll,t)),e.include(Zi,t),e.fragment.uniforms.add("intrinsicColor","vec4"),e.fragment.include(yd),e.fragment.code.add(x`
  void main() {
    discardBySlice(vpos);
    ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
  `),t.roundCaps&&e.fragment.code.add(x`
    float fragmentRadius = length(vCapPosition);
    float fragmentSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
    float capCoverage = clamp(0.5 - fragmentSDF, 0.0, 1.0);
    if (capCoverage < ${x.float(tn)}) {
      discard;
    }
  `),i?e.fragment.code.add(x`
      vec2 stipplePosition = vec2(
        max(1.0 - getStippleSDF() * 2.0 * vStipplePatternStretch, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${x.float(tn)}, stippleCoverage);
    `):e.fragment.code.add(x`float stippleAlpha = getStippleAlpha();`),e.fragment.code.add(x`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);
vec4 color = intrinsicColor * vColor;`),e.fragment.uniforms.add("pixelRatio","float"),t.innerColorEnabled&&e.fragment.code.add(x`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`),e.fragment.code.add(x`vec4 finalColor = blendStipple(color, stippleAlpha);`),t.falloffEnabled&&e.fragment.code.add(x`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`),e.fragment.code.add(x`
    if (finalColor.a < ${x.float(tn)}) {
      discard;
    }

    ${t.output===7?x`gl_FragColor = vec4(finalColor.a);`:""}
    ${t.output===0?x`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===0&&t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${t.output===4?x`gl_FragColor = vec4(1.0);`:""}
    ${t.output===1?x`outputDepth(linearDepth);`:""}
  }
  `),e}const uje=Object.freeze({__proto__:null,NUM_ROUND_JOIN_SUBDIVISIONS:pR,build:cje}),eue={func:513},tue={func:519},$m={mask:255},hje={mask:0},dje=t=>({function:{func:517,ref:t,mask:t},operation:{fail:7680,zFail:7680,zPass:7680}}),pje=t=>({function:{func:519,ref:t,mask:t},operation:{fail:7680,zFail:7680,zPass:7681}}),Q0={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:0}},kb={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7681}},fje={function:{func:514,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}},mje={function:{func:517,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}},iue=new Map([["position",0],["subdivisionFactor",1],["uv0",2],["auxpos1",3],["auxpos2",4],["size",6],["sizeFeatureAttribute",6],["color",5],["colorFeatureAttribute",5],["opacityFeatureAttribute",7]]);class fR extends Si{constructor(e,i,r){super(e,i,r),this.stippleTextureRepository=e.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==4}initializeProgram(e){const i=fR.shader.get(),r=this.configuration,s=i.build({OITEnabled:r.transparencyPassType===0,output:r.output,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:r.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:r.stippleOffColorEnabled,stippleRequiresClamp:!0,stippleScaleWithLineWidth:r.stippleScaleWithLineWidth,stipplePreferContinuous:r.stipplePreferContinuous,roundCaps:r.roundCaps,roundJoins:r.roundJoins,vvColor:r.vvColor,vvSize:r.vvSize,vvInstancingEnabled:!0,vvOpacity:r.vvOpacity,falloffEnabled:r.falloffEnabled,innerColorEnabled:r.innerColorEnabled,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new fi(e.rctx,s,iue)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,i){if(Pc(this.program,i.camera.projectionMatrix),this.configuration.output===4&&Fd(this.program,i),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),wm(this.program,i)),this.program.setUniform1f("intrinsicWidth",e.width),this.program.setUniform4fv("intrinsicColor",e.color),this.program.setUniform1f("miterLimit",e.join!=="miter"?0:e.miterLimit),this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio),this.program.setUniform2f("screenSize",i.camera.fullViewport[2],i.camera.fullViewport[3]),SNe(this.program,e),this.stipplePattern!==e.stipplePattern){const r=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,r),this.stipplePattern=r}if(this.stippleEnabled){const{pixelSize:r,sdfNormalizer:s,pixels:n}=_(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};if(this.program.setUniform1f("stipplePatternSDFNormalizer",s),this.program.setUniform1f("stipplePatternTextureSize",n),this.program.setUniform1f("stipplePatternPixelSize",r),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/i.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/i.camera.perScreenPixelRatio),this.configuration.stippleOffColorEnabled){const o=at(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",o[0],o[1],o[2],o.length>3?o[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",e.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",st(e.innerColor,e.color)),this.program.setUniform1f("innerWidth",e.innerWidth*i.camera.pixelRatio))}bindDraw(e){Yf(this.program,e),this.stippleEnabled&&!this.configuration.draped&&Qf(this.program,e.origin,e.camera.viewInverseTransposeMatrix),_m(this.program,this.configuration,e),this.program.rebindTextures()}makePipelineState(e,i){const r=this.configuration,s=e===3,n=e===2;return _t({blending:r.output===0||r.output===7?s?qu:xm(e):null,depthTest:{func:U0(e)},depthWrite:s?!r.transparent&&r.writeDepth&&$o:XN(e),colorWrite:Pt,stencilWrite:r.sceneHasOcludees?$m:null,stencilTest:r.sceneHasOcludees?i?kb:Q0:null,polygonOffset:s||n?r.polygonOffset&&rue:WO})}initializePipeline(){const e=this.configuration,i=e.polygonOffset&&rue;return e.occluder&&(this._occluderPipelineTransparent=_t({blending:qu,polygonOffset:i,depthTest:tue,depthWrite:null,colorWrite:Pt,stencilWrite:null,stencilTest:mje}),this._occluderPipelineOpaque=_t({blending:qu,polygonOffset:i,depthTest:tue,depthWrite:null,colorWrite:Pt,stencilWrite:hje,stencilTest:fje}),this._occluderPipelineMaskWrite=_t({blending:null,polygonOffset:i,depthTest:eue,depthWrite:null,colorWrite:null,stencilWrite:$m,stencilTest:kb})),this._occludeePipelineState=this.makePipelineState(this.configuration.transparencyPassType,!0),this.makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return 5}getPipelineState(e,i){return i?this._occludeePipelineState:this.configuration.occluder?e===10?this._occluderPipelineTransparent:e===9?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,i)}}fR.shader=new vi(uje,()=>import("./RibbonLine.glsl.89bd44e7.js"));const rue={factor:0,units:-4};class gr extends tr{constructor(){super(...arguments),this.output=0,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.polygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.roundCaps=!1,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([X({count:8})],gr.prototype,"output",void 0),u([X()],gr.prototype,"occluder",void 0),u([X()],gr.prototype,"slicePlaneEnabled",void 0),u([X()],gr.prototype,"transparent",void 0),u([X()],gr.prototype,"polygonOffset",void 0),u([X()],gr.prototype,"writeDepth",void 0),u([X()],gr.prototype,"draped",void 0),u([X()],gr.prototype,"stippleEnabled",void 0),u([X()],gr.prototype,"stippleOffColorEnabled",void 0),u([X()],gr.prototype,"stippleScaleWithLineWidth",void 0),u([X()],gr.prototype,"stipplePreferContinuous",void 0),u([X()],gr.prototype,"roundCaps",void 0),u([X()],gr.prototype,"roundJoins",void 0),u([X()],gr.prototype,"vvSize",void 0),u([X()],gr.prototype,"vvColor",void 0),u([X()],gr.prototype,"vvOpacity",void 0),u([X()],gr.prototype,"falloffEnabled",void 0),u([X()],gr.prototype,"innerColorEnabled",void 0),u([X()],gr.prototype,"sceneHasOcludees",void 0),u([X({count:4})],gr.prototype,"transparencyPassType",void 0),u([X()],gr.prototype,"multipassTerrainEnabled",void 0),u([X()],gr.prototype,"cullAboveGround",void 0);const gje=le.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");class mR extends Id{constructor(e){super(e,vje),this._vertexAttributeLocations=iue,this.techniqueConfig=new gr,this.layout=this.createLayout()}isClosed(e,i){return nue(this.parameters,e,i)}dispose(){}getPassParameters(){return this.parameters}getTechniqueConfig(e,i){this.techniqueConfig.output=e,this.techniqueConfig.draped=i.slot===20;const r=_(this.parameters.stipplePattern);return this.techniqueConfig.stippleEnabled=r,this.techniqueConfig.stippleOffColorEnabled=r&&_(this.parameters.stippleOffColor),this.techniqueConfig.stippleScaleWithLineWidth=r&&this.parameters.stippleScaleWithLineWidth,this.techniqueConfig.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.roundJoins=this.parameters.join==="round",this.techniqueConfig.roundCaps=this.parameters.cap===2,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.parameters.innerWidth>0&&_(this.parameters.innerColor),this.techniqueConfig.falloffEnabled=this.parameters.falloff>0,this.techniqueConfig.occluder=this.parameters.renderOccluded===8,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}intersect(e,i,r,s,n,o,a,l,c){_(c)?this.intersectDrapedLineGeometry(e,s,c,o,a):this.intersectLineGeometry(e,i,r,s,a)}intersectDrapedLineGeometry(e,i,r,s,n){if(!i.options.selectionMode)return;const o=e.vertexAttributes.get("position").data,a=e.vertexAttributes.get("size");let l=this.parameters.width;if(this.parameters.vvSizeEnabled){const y=e.vertexAttributes.get("sizeFeatureAttribute").data[0];l*=Re(this.parameters.vvSizeOffset[0]+y*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else a&&(l*=a.data[0]);const c=s[0],h=s[1],p=(l/2+4)*e.screenToWorldRatio;let f=Number.MAX_VALUE,g=0;for(let y=0;y<o.length-5;y+=3){const v=o[y],b=o[y+1],w=c-v,S=h-b,T=o[y+3]-v,C=o[y+4]-b,M=Re((T*w+C*S)/(T*T+C*C),0,1),P=T*M-w,F=C*M-S,z=P*P+F*F;z<f&&(f=z,g=y/3)}f<p*p&&n(r.dist,r.normal,g,!1)}intersectLineGeometry(e,i,r,s,n){if(!s.options.selectionMode||pT(i))return;if(!Hne(r))return void gje.error("intersection assumes a translation-only matrix");const o=e.vertexAttributes,a=o.get("position").data;let l=this.parameters.width;if(this.parameters.vvSizeEnabled){const w=o.get("sizeFeatureAttribute").data[0];l*=Re(this.parameters.vvSizeOffset[0]+w*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else o.has("size")&&(l*=o.get("size").data[0]);const c=s.camera,h=bje;os(h,s.point);const p=l*c.pixelRatio/2+4*c.pixelRatio;ne(JT[0],h[0]-p,h[1]+p,0),ne(JT[1],h[0]+p,h[1]+p,0),ne(JT[2],h[0]+p,h[1]-p,0),ne(JT[3],h[0]-p,h[1]-p,0);for(let w=0;w<4;w++)if(!c.unprojectFromRenderScreen(JT[w],jd[w]))return;Us(c.eye,jd[0],jd[1],E7),Us(c.eye,jd[1],jd[2],O7),Us(c.eye,jd[2],jd[3],R7),Us(c.eye,jd[3],jd[0],I7);let f=Number.MAX_VALUE,g=0;const y=$7(this.parameters,o,e.indices)?a.length-2:a.length-5;for(let w=0;w<y;w+=3){Xn[0]=a[w]+r[12],Xn[1]=a[w+1]+r[13],Xn[2]=a[w+2]+r[14];const S=(w+3)%a.length;if(Kn[0]=a[S]+r[12],Kn[1]=a[S+1]+r[13],Kn[2]=a[S+2]+r[14],hi(E7,Xn)<0&&hi(E7,Kn)<0||hi(O7,Xn)<0&&hi(O7,Kn)<0||hi(R7,Xn)<0&&hi(R7,Kn)<0||hi(I7,Xn)<0&&hi(I7,Kn)<0)continue;if(c.projectToRenderScreen(Xn,X0),c.projectToRenderScreen(Kn,K0),X0[2]<0&&K0[2]>0){ue(Yu,Xn,Kn);const C=c.frustum,M=-hi(C[4],Xn)/ye(Yu,Li(C[4]));se(Yu,Yu,M),de(Xn,Xn,Yu),c.projectToRenderScreen(Xn,X0)}else if(X0[2]>0&&K0[2]<0){ue(Yu,Kn,Xn);const C=c.frustum,M=-hi(C[4],Kn)/ye(Yu,Li(C[4]));se(Yu,Yu,M),de(Kn,Kn,Yu),c.projectToRenderScreen(Kn,K0)}else if(X0[2]<0&&K0[2]<0)continue;X0[2]=0,K0[2]=0;const T=M6(gy(X0,K0,lue),h);T<f&&(f=T,re(oue,Xn),re(aue,Kn),g=w/3)}const v=s.rayBegin,b=s.rayEnd;if(f<p*p){let w=Number.MAX_VALUE;if(KJ(gy(oue,aue,lue),gy(v,b,wje),Y0)){ue(Y0,Y0,v);const S=Te(Y0);se(Y0,Y0,1/S),w=S/qt(v,b)}n(w,Y0,g,!1)}}computeAttachmentOrigin(e,i){const r=e.vertexAttributes;if(!r)return null;const s=e.indices,n=r.get("position");return OV(n,s?s.get("position"):null,s&&$7(this.parameters,r,s),i)}createLayout(){const e=zr().vec3f("position").f32("subdivisionFactor").vec2f("uv0").vec3f("auxpos1").vec3f("auxpos2");return this.parameters.vvSizeEnabled?e.f32("sizeFeatureAttribute"):e.f32("size"),this.parameters.vvColorEnabled?e.f32("colorFeatureAttribute"):e.vec4f("color"),this.parameters.vvOpacityEnabled&&e.f32("opacityFeatureAttribute"),e}createBufferWriter(){return new _je(this.layout,this.parameters)}requiresSlot(e,i){if(e===20)return!0;if(this.parameters.renderOccluded===8)return e===2||e===9||e===10;const r=N0(i);return r===0||r===7?e===(this.parameters.writeDepth?4:7):e===2}createGLMaterial(e){return e.output===0||e.output===7||e.output===4||e.output===1?new yje(e):null}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),this.requiresTransparent(e)&&(e.transparent=!0)}requiresTransparent(e){return!!((e.color&&e.color[3])<1||e.innerWidth>0&&this.colorRequiresTransparent(e.innerColor)||e.stipplePattern&&this.colorRequiresTransparent(e.stippleOffColor)||e.falloff>0)}colorRequiresTransparent(e){return _(e)&&e[3]<1&&e[3]>0}}class yje extends vm{updateParameters(e){return this.ensureTechnique(fR,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==0&&this._output!==7||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,i){i.bindPass(this._material.getPassParameters(),e)}}const vje=E(E({width:0,color:[1,1,1,1],join:"miter",cap:0,miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleOffColor:null,stippleScaleWithLineWidth:!1,stipplePreferContinuous:!0,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1},Gu),Xce.Default);class _je{constructor(e,i){this.parameters=i,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const r=i.stipplePattern?1:0;switch(this.parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=pR+r}}isClosed(e){return $7(this.parameters,e.vertexAttributes,e.indices)}numCapSubdivisions(e){if(this.isClosed(e))return 0;switch(this.parameters.cap){case 1:case 2:return 1;default:return 0}}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const i=2*this.numCapSubdivisions(e)+2,r=e.indices.get("position").length/2+1,s=this.isClosed(e);let n=s?2:2*i;const o=s?0:1,a=s?r:r-1;if(e.vertexAttributes.has("subdivisions")){const l=e.vertexAttributes.get("subdivisions").data;for(let c=o;c<a;++c)n+=4+2*l[c]}else n+=(a-o)*(2*this.numJoinSubdivisions+4);return n+=2,n}write(e,i,r,s){var n;const o=xje,a=Sje,l=Tje,c=i.vertexAttributes.get("position").data,h=i.indices&&i.indices.get("position"),p=(n=i.vertexAttributes.get("distanceToStart"))==null?void 0:n.data,f=this.numCapSubdivisions(i);h&&h.length!==2*(c.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let g=null;i.vertexAttributes.has("subdivisions")&&(g=i.vertexAttributes.get("subdivisions").data);let y=1,v=0;this.parameters.vvSizeEnabled?v=i.vertexAttributes.get("sizeFeatureAttribute").data[0]:i.vertexAttributes.has("size")&&(y=i.vertexAttributes.get("size").data[0]);let b=[1,1,1,1],w=0;this.parameters.vvColorEnabled?w=i.vertexAttributes.get("colorFeatureAttribute").data[0]:i.vertexAttributes.has("color")&&(b=i.vertexAttributes.get("color").data);let S=0;this.parameters.vvOpacityEnabled&&(S=i.vertexAttributes.get("opacityFeatureAttribute").data[0]);const T=c.length/3,C=e.transformation,M=new Float32Array(r.buffer),P=this.vertexBufferLayout.stride/4;let F=s*P;const z=F;let D=0;const U=(q,J,O,L,N,B,W)=>{if(M[F++]=J[0],M[F++]=J[1],M[F++]=J[2],M[F++]=L,M[F++]=W,M[F++]=N,M[F++]=q[0],M[F++]=q[1],M[F++]=q[2],M[F++]=O[0],M[F++]=O[1],M[F++]=O[2],this.parameters.vvSizeEnabled?M[F++]=v:M[F++]=y,this.parameters.vvColorEnabled)M[F++]=w;else{const Y=Math.min(4*B,b.length-4);M[F++]=b[Y+0],M[F++]=b[Y+1],M[F++]=b[Y+2],M[F++]=b[Y+3]}this.parameters.vvOpacityEnabled&&(M[F++]=S)};F+=P,ne(a,c[0],c[1],c[2]),C&&Oe(a,a,C);const G=this.isClosed(i);if(G){const q=c.length-3;ne(o,c[q],c[q+1],c[q+2]),C&&Oe(o,o,C)}else{re(o,a),ne(l,c[3],c[4],c[5]),C&&Oe(l,l,C);for(let q=0;q<f;++q){const J=1-q/f;U(o,a,l,J,-4,0,D),U(o,a,l,J,4,0,D)}U(o,a,l,0,-4,0,D),U(o,a,l,0,4,0,D),re(o,a),re(a,l)}const k=G?0:1,j=G?T:T-1,V=p?(q,J,O)=>D=p[O]:(q,J,O)=>D+=qt(q,J);for(let q=k;q<j;q++){const J=(q+1)%T*3;ne(l,c[J+0],c[J+1],c[J+2]),C&&Oe(l,l,C),V(o,a,q),U(o,a,l,0,-1,q,D),U(o,a,l,0,1,q,D);const O=g?g[q]:this.numJoinSubdivisions;for(let L=0;L<O;++L){const N=(L+1)/(O+1);U(o,a,l,N,-1,q,D),U(o,a,l,N,1,q,D)}U(o,a,l,1,-2,q,D),U(o,a,l,1,2,q,D),re(o,a),re(a,l)}if(G)ne(l,c[3],c[4],c[5]),C&&Oe(l,l,C),D=V(o,a,j),U(o,a,l,0,-1,k,D),U(o,a,l,0,1,k,D);else{D=V(o,a,j),U(o,a,l,0,-5,j,D),U(o,a,l,0,5,j,D);for(let q=0;q<f;++q){const J=(q+1)/f;U(o,a,l,J,-5,j,D),U(o,a,l,J,5,j,D)}}sue(M,z+P,M,z,P),F=sue(M,F-P,M,F,P)}}function sue(t,e,i,r,s){for(let n=0;n<s;n++)i[r++]=t[e++];return r}function $7(t,e,i){return nue(t,e.get("position").data,i?i.get("position"):null)}function nue(t,e,i){return!!t.isClosed&&(i?i.length>2:e.length>6)}const Xn=$(),Kn=$(),Yu=$(),Y0=$(),bje=$(),X0=ys(),K0=ys(),oue=$(),aue=$(),lue=ff(),wje=ff(),xje=$(),Sje=$(),Tje=$(),JT=[ys(),ys(),ys(),ys()],jd=[$(),$(),$(),$()],E7=Mt(),O7=Mt(),R7=Mt(),I7=Mt();class D7{constructor(e,i=125e4){this._originSR=e,this._gridSize=i,this._origins=new Map,this._objects=new Map,this._rootOriginId="root/"+On()}getOrigin(e){const i=this._origins.get(this._rootOriginId);if(i==null){if(_(gR))return this._origins.set(this._rootOriginId,WT(gR[0],gR[1],gR[2],this._rootOriginId)),this.getOrigin(e);const h=WT(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,h),h}const r=this._gridSize,s=Math.round(e[0]/r),n=Math.round(e[1]/r),o=Math.round(e[2]/r),a=`${s}/${n}/${o}`;let l=this._origins.get(a);const c=.5*r;if(ue(ls,e,i.vec3),ls[0]=Math.abs(ls[0]),ls[1]=Math.abs(ls[1]),ls[2]=Math.abs(ls[2]),ls[0]<c&&ls[1]<c&&ls[2]<c){if(l){const h=Math.max(...ls);if(ue(ls,e,l.vec3),ls[0]=Math.abs(ls[0]),ls[1]=Math.abs(ls[1]),ls[2]=Math.abs(ls[2]),Math.max(...ls)<h)return l}return i}return l||(l=WT(s*r,n*r,o*r,a),this._origins.set(a,l)),l}_drawOriginBox(e,i=[1,1,0,1]){const r=window.view,s=r._stage,n=i.toString();if(!this._objects.has(n)){this._material=new mR({width:2,color:i}),s.add(this._material);const g=new Yce({isPickable:!1}),y=new Nd({castShadow:!1});s.add(y),g.add(y),s.add(g),this._objects.set(n,y)}const o=this._objects.get(n),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],l=a.length,c=new Array(3*l),h=new Uint16Array(2*(l-1)),p=.5*this._gridSize;for(let g=0;g<l;g++)c[3*g+0]=e[0]+(1&a[g]?p:-p),c[3*g+1]=e[1]+(2&a[g]?p:-p),c[3*g+2]=e[2]+(4&a[g]?p:-p),g>0&&(h[2*g+0]=g-1,h[2*g+1]=g);Mi(c,this._originSR,0,c,r.renderSpatialReference,0,l);const f=new zi([["position",{size:3,data:c,exclusive:!0}]],[["position",h]],2);s.add(f),o.addGeometry(f,this._material,Dr)}}let gR=null;const ls=$();class cue{constructor(e){this.rctx=e,this.camera=null,this.lastFrameCamera=new Zt,this.pass=0,this.slot=2,this.highlightDepthTexture=null,this.renderOccludedMask=uue,this.hasOccludees=!1}resetRenderOccludedMask(){this.renderOccludedMask=uue}get isHighlightPass(){return this.pass===5}}class Cje extends cue{constructor(e,i,r,s,n,o){super(e),this.offscreenRenderingHelper=i,this.scenelightingData=r,this.shadowMap=s,this.ssaoHelper=n,this.sliceHelper=o}}const uue=13;class hue{constructor(){this.adds=new ct,this.removes=new ct,this.updates=new ct({allocator:e=>e||new Mje,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class Mje{}class Pje{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function due(t){const e=new Map,i=r=>{let s=e.get(r);return s||(s=new Pje,e.set(r,s)),s};return t.adds.forAll(r=>{F7(r)&&i(r.material).adds.push(r)}),t.removes.forAll(r=>{F7(r)&&i(r.material).removes.push(r)}),t.updates.forAll(r=>{F7(r.renderGeometry)&&i(r.renderGeometry.material).updates.push(r)}),e}function F7(t){return t.data.indexCount>=1}class Aje{constructor(){this.enabled=!0,this._time=0}get time(){return Ft(this._time)}advance(e){return _(e.forcedTime)?this._time!==e.forcedTime&&(this._time=e.forcedTime,!0):!(!this.enabled||e.dt===0)&&(this._time+=e.dt,!0)}}function Bd(t){t.fragment.include(zu),t.fragment.uniforms.add("uShadowMapTex","sampler2D"),t.fragment.uniforms.add("uShadowMapNum","int"),t.fragment.uniforms.add("uShadowMapDistance","vec4"),t.fragment.uniforms.add("uShadowMapMatrix","mat4",4),t.fragment.uniforms.add("uDepthHalfPixelSz","float"),t.fragment.code.add(x`int chooseCascade(float _linearDepth, out mat4 mat) {
vec4 distance = uShadowMapDistance;
float depth = _linearDepth;
int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;
mat = i == 0 ? uShadowMapMatrix[0] : i == 1 ? uShadowMapMatrix[1] : i == 2 ? uShadowMapMatrix[2] : uShadowMapMatrix[3];
return i;
}
vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
vec4 lv = mat * vec4(_vpos, 1.0);
lv.xy /= lv.w;
return 0.5 * lv.xyz + vec3(0.5);
}
vec2 cascadeCoordinates(int i, vec3 lvpos) {
return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;
}
float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {
return rgba2float(texture2D(_depthTex, uv));
}
float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {
return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;
}
float filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {
float texSize = 0.5 / halfPixelSize;
vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);
float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);
float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float readShadowMap(const in vec3 _vpos, float _linearDepth) {
mat4 mat;
int i = chooseCascade(_linearDepth, mat);
if (i >= uShadowMapNum) { return 0.0; }
vec3 lvpos = lightSpacePosition(_vpos, mat);
if (lvpos.z >= 1.0) { return 0.0; }
if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }
vec2 uv = cascadeCoordinates(i, lvpos);
return filterShadow(uv, lvpos, uDepthHalfPixelSz, uShadowMapTex);
}`)}function $je(t,e){e.shadowMappingEnabled&&(e.shadowMap.bind(t),e.shadowMap.bindView(t,e.origin))}function Eje(t,e,i){e.shadowMappingEnabled&&e.shadowMap.bindView(t,i)}function Oje(t,e){e.shadowMappingEnabled&&e.shadowMap.bindView(t,e.origin)}function Rje(t){t.fragment.uniforms.add("lastFrameColorMap","sampler2D"),t.fragment.uniforms.add("reprojectionMat","mat4"),t.fragment.uniforms.add("rpProjectionMat","mat4"),t.fragment.code.add(x`vec2 reprojectionCoordinate(vec3 projectionCoordinate)
{
vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
reprojectedCoord.xy /= reprojectedCoord.w;
return reprojectedCoord.xy * 0.5 + 0.5;
}`)}function Ije(t,e){t.bindTexture(e.lastFrameColorTexture,"lastFrameColorMap"),t.setUniformMatrix4fv("reprojectionMat",e.reprojectionMatrix),t.setUniformMatrix4fv("rpProjectionMat",e.camera.projectionMatrix)}function Dje(t,e){t.fragment.uniforms.add("nearFar","vec2"),t.fragment.uniforms.add("depthMapView","sampler2D"),t.fragment.uniforms.add("ssrViewMat","mat4"),t.fragment.uniforms.add("invResolutionHeight","float"),t.fragment.include(Lr),t.include(Rje),t.fragment.code.add(x`
  const int maxSteps = ${e.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function L7(t,e){e.ssrEnabled&&(t.bindTexture(e.linearDepthTexture,"depthMapView"),t.setUniform2fv("nearFar",e.camera.nearFar),t.setUniformMatrix4fv("ssrViewMat",e.camera.viewMatrix),t.setUniform1f("invResolutionHeight",1/e.camera.height),Ije(t,e))}function Fje(t){t.fragment.code.add(x`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function Lje(t){t.fragment.code.add(x`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function pue(t){t.fragment.uniforms.add("texWaveNormal","sampler2D"),t.fragment.uniforms.add("texWavePerturbation","sampler2D"),t.fragment.uniforms.add("waveParams","vec4"),t.fragment.uniforms.add("waveDirection","vec2"),t.include(Fje),t.fragment.code.add(x`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}function kje(t,e){t.setUniform4f("waveParams",e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset),t.setUniform2f("waveDirection",e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity)}function QT(t,e){e.output===0&&e.receiveShadows?(t.varyings.add("linearDepth","float"),t.vertex.code.add(x`void forwardLinearDepth() { linearDepth = gl_Position.w; }`)):e.output===1||e.output===3?(t.varyings.add("linearDepth","float"),t.vertex.uniforms.add("cameraNearFar","vec2"),t.vertex.code.add(x`void forwardLinearDepth() {
linearDepth = (-position_view().z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);
}`)):t.vertex.code.add(x`void forwardLinearDepth() {}`)}function Em(t,e){e.viewingMode===1?t.vertex.code.add(x`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):t.vertex.code.add(x`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),e.viewingMode===1?t.vertex.code.add(x`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):t.vertex.code.add(x`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}function zje(t){const e=t.fragment.code;e.add(x`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)
{
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),e.add(x`float integratedRadiance(float cosTheta2, float roughness)
{
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),e.add(x`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)
{
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)}function yR(t,e){const i=t.fragment.code;t.include($E),e.pbrMode===3||e.pbrMode===4?(i.add(x`
    struct PBRShadingWater
    {
        float NdotL;   // cos angle between normal and light direction
        float NdotV;   // cos angle between normal and view direction
        float NdotH;   // cos angle between normal and half vector
        float VdotH;   // cos angle between view direction and half vector
        float LdotH;   // cos angle between light direction and half vector
        float VdotN;   // cos angle between view direction and normal vector
    };

    float dtrExponent = ${e.useCustomDTRExponentForWater?"2.2":"2.0"};
    `),i.add(x`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),i.add(x`float normalDistributionWater(float NdotH, float roughness)
{
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),i.add(x`float geometricOcclusionKelemen(float LoH)
{
return 0.25 / (LoH * LoH);
}`),i.add(x`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)
{
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}
vec3 tonemapACES(const vec3 x) {
return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);
}`)):e.pbrMode!==1&&e.pbrMode!==2||(t.include(zje),i.add(x`struct PBRShadingInfo
{
float NdotL;
float NdotV;
float NdotH;
float VdotH;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),i.add(x`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),i.add(x`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`),i.add(x`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`),i.add(x`float gamutMapChanel(float x, vec2 p){
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),i.add(x`vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){
vec3 outColor;
vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));
outColor.x = gamutMapChanel(inColor.x, p) ;
outColor.y = gamutMapChanel(inColor.y, p) ;
outColor.z = gamutMapChanel(inColor.z, p) ;
return outColor;
}`))}function fue(t,e){t.include(yR,e),t.include(oV),t.include(Lje),e.ssrEnabled&&t.include(Dje,e),t.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.775).add("waterSeeColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]),t.fragment.code.add(x`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),t.fragment.code.add(x`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {
float reflectionHit = 0.;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}`),e.ssrEnabled?t.fragment.code.add(x`vec4 viewPosition = vec4(positionView.xyz, 1.0);
vec3 viewDir = normalize(viewPosition.xyz);
vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);
float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);
vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));
vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;
}
float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);
return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);
}`):t.fragment.code.add(x`return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);
}`)}function Vje(t){const e=new pi;return e.include(Ss,{linearDepth:!1}),e.attributes.add("position","vec3"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),e.vertex.uniforms.add("waterColor","vec4"),t.output!==0&&t.output!==7||(e.include(Em,t),e.include(QT,t),e.varyings.add("vuv","vec2"),e.varyings.add("vpos","vec3"),e.varyings.add("vnormal","vec3"),e.varyings.add("vtbnMatrix","mat3"),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(x`
      void main(void) {
        if (waterColor.a < ${x.float(tn)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${t.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${t.output===0?"forwardLinearDepth();":""}
      }
    `)),t.multipassTerrainEnabled&&(e.fragment.include(Lr),e.include(ll,t)),t.output===7&&(e.include(Zi,t),e.fragment.uniforms.add("waterColor","vec4"),e.fragment.code.add(x`
        void main() {
          discardBySlice(vpos);
          ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),t.output===0&&(e.include(pue,t),e.include(Zi,t),t.receiveShadows&&e.include(Bd,t),e.include(fue,t),e.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),e.fragment.include(yd),e.fragment.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - camPos);
        float shadow = ${t.receiveShadows?x`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.output===2&&(e.include(Em,t),e.include(pue,t),e.include(Zi,t),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),e.vertex.code.add(x`
        void main(void) {
          if (waterColor.a < ${x.float(tn)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),e.fragment.uniforms.add("timeElapsed","float"),e.fragment.code.add(x`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),t.output===5&&(e.varyings.add("vpos","vec3"),e.vertex.code.add(x`
        void main(void) {
          if (waterColor.a < ${x.float(tn)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),e.fragment.uniforms.add("waterColor","vec4"),e.fragment.code.add(x`void main() {
gl_FragColor = waterColor;
}`)),t.output===4&&(e.include(Dd),e.varyings.add("vpos","vec3"),e.vertex.code.add(x`
      void main(void) {
        if (waterColor.a < ${x.float(tn)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),e.include(Zi,t),e.fragment.code.add(x`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),e}const Nje=Object.freeze({__proto__:null,build:Vje});class vR extends Si{constructor(e,i,r){super(e,i,r),this._textureRepository=e.waterTextureRepository}initializeProgram(e){const i=vR.shader.get(),r=this.configuration,s=i.build({OITEnabled:r.transparencyPassType===0,output:r.output,viewingMode:e.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:r.useSSR,highStepCount:!0,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new fi(e.rctx,s,Ht)}bindPass(e,i){Pc(this.program,i.camera.projectionMatrix),i.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),wm(this.program,i)),this.configuration.output===0&&(i.lighting.setUniforms(this.program,!1),L7(this.program,i)),this.configuration.output!==0&&this.configuration.output!==2||(kje(this.program,e),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",e.color),this.configuration.output===4&&Fd(this.program,i)}bindDraw(e){Yf(this.program,e),this.program.rebindTextures(),this.configuration.output!==0&&this.configuration.output!==7||Qf(this.program,e.origin,e.camera.viewInverseTransposeMatrix),this.configuration.output===0&&$je(this.program,e),this.configuration.output!==0&&this.configuration.output!==7&&this.configuration.output!==4||_m(this.program,this.configuration,e)}setPipelineState(e){const i=this.configuration,r=e===3,s=e===2;return _t({blending:i.output!==2&&i.output!==4&&i.transparent?r?qu:xm(e):null,depthTest:{func:U0(e)},depthWrite:r?i.writeDepth&&$o:XN(e),colorWrite:Pt,polygonOffset:r||s?null:ZO(i.enableOffset)})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}vR.shader=new vi(Nje,()=>import("./WaterSurface.glsl.503aebc1.js"));class pl extends tr{constructor(){super(...arguments),this.output=0,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([X({count:8})],pl.prototype,"output",void 0),u([X()],pl.prototype,"receiveShadows",void 0),u([X()],pl.prototype,"slicePlaneEnabled",void 0),u([X()],pl.prototype,"transparent",void 0),u([X()],pl.prototype,"enableOffset",void 0),u([X()],pl.prototype,"writeDepth",void 0),u([X()],pl.prototype,"useSSR",void 0),u([X()],pl.prototype,"isDraped",void 0),u([X({count:4})],pl.prototype,"transparencyPassType",void 0),u([X()],pl.prototype,"multipassTerrainEnabled",void 0),u([X()],pl.prototype,"cullAboveGround",void 0);class mue extends vm{updateParameters(e){return this.ensureTechnique(vR,e)}setElapsedTimeUniform(e){const i=.001*this._material.animation.time;e.setUniform1f("timeElapsed",i*this._material.parameters.animationSpeed)}_updateShadowState(e){e.shadowMappingEnabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMappingEnabled})}_updateSSRState(e){e.ssrEnabled!==this._material.parameters.ssrEnabled&&this._material.setParameters({ssrEnabled:e.ssrEnabled})}ensureResources(e){const i=this._techniqueRep.constructionContext.waterTextureRepository;return i.ready||i.updating||i.loadTextures(e),i.ready?2:1}beginSlot(e){return this._output===0&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}bind(e,i){i.bindPass(this._material.parameters,e),this._output!==2&&this._output!==0||this.setElapsedTimeUniform(i.program)}}const Uje=zr().vec3f("position"),jje=zr().vec3f("position").vec2f("uv0"),gue=zr().vec3f("position").vec4u8("color");class _R{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,i,r,s){BO(i,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,s)}}const yue=E({waveStrength:.06,waveTextureRepeat:32,waveDirection:Qt(1,0),waveVelocity:.05,flowStrength:.015,flowOffset:-.5,animationSpeed:.35,color:[0,0,0,0],transparent:!0,writeDepth:!0,slicePlaneEnabled:!1,isDraped:!1,receiveShadows:!0,ssrEnabled:!1},Gu),Bje={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}};class vue extends Id{constructor(e){super(e,yue),this._techniqueConfig=new pl,this.animation=new Aje}getTechniqueConfig(e,i){return this._techniqueConfig.output=e,this._techniqueConfig.writeDepth=this.parameters.writeDepth,this._techniqueConfig.receiveShadows=this.parameters.receiveShadows,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.transparent=this.parameters.transparent,this._techniqueConfig.useSSR=this.parameters.ssrEnabled,this._techniqueConfig.isDraped=this.parameters.isDraped,this._techniqueConfig.transparencyPassType=i.transparencyPassType,this._techniqueConfig.enableOffset=i.camera.relativeElevation<HO,this._techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this._techniqueConfig.cullAboveGround=i.cullAboveGround,this._techniqueConfig}update(e){const i=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*i<Gje;const r=this.animation.advance(e);return this.animation.enabled&&r}intersect(e,i,r,s,n,o,a){NO(e,i,s,n,o,void 0,a)}requiresSlot(e,i){switch(N0(i)){case 2:return e===21;case 0:if(this.parameters.isDraped)return e===20;break;case 4:return e===2||e===20}let r=2;return this.parameters.transparent&&(r=this.parameters.writeDepth?4:7),e===r}createGLMaterial(e){if(e.output===0&&this.parameters.isDraped)return e.output=5,new mue(e);switch(e.output){case 0:case 2:case 4:case 7:return new mue(e)}return null}createBufferWriter(){return new _R(jje)}}const Gje=35e3;class _ue{constructor(e){this.first=e.from,this.count=e.to-e.from}}class YT{constructor(e=0,i=0){this.from=e,this.to=i}}class qje extends YT{constructor(e,i,r,s,n,o){super(i,r),this.id=e,this.isVisible=s,this.hasHighlights=n,this.hasOccludees=o}}function bue(t){return Array.from(t.values()).sort(Hje)}function Hje(t,e){return t.from===e.from?t.to-e.to:t.from-e.from}function bR(t,e){if(t.length===0)return void t.push(new _ue(e));const i=t[t.length-1];if(Wje(i,e)){const r=e.from-i.first+e.to-e.from;i.count=r}else t.push(new _ue(e))}function Wje(t,e){return t.first+t.count>=e.from}class Zje{constructor(e,i){this._pool=e,this._size=0,this._buffer=e.newBuffer(k7(i))}dispose(){this._buffer=this._pool.deleteBuffer(this._buffer),this._size=0}release(){this.erase(0,this._size),this.dispose()}get vao(){return this._buffer.vao}get array(){return this._buffer.array}get size(){return this._size}grow(e){this._resize(this._size+e,!0).dispose()}alloc(e){return this._resize(e,!1)}_resize(e,i){let r;const s=Jje(this._buffer.length,this._size,e);if(this._buffer.length!==s){const o=this._pool.newBuffer(s);i&&(o.array.set(this._buffer.array.subarray(0,Math.min(this._size,s))),o.vao.vertexBuffers.geometry.setSubData(o.array,0,0,o.array.byteLength)),r=this._buffer,this._buffer=o}const n=this._size;return this._size=e,r?{dispose:()=>{r.array.fill(0,0,n),this._pool.deleteBuffer(r)},copy:(o,a,l)=>this._buffer.array.set(r.array.subarray(a,l),o),hasNewBuffer:!0}:{dispose:()=>{},copy:(o,a,l)=>{o!==a&&this._buffer.array.copyWithin(o,a,l)},hasNewBuffer:!1}}erase(e,i){this._buffer.array.fill(0,e,i)}}const wue=65536;function k7(t){return Math.ceil(t/wue)*wue}function Jje(t,e,i){return e<=i?t>=i?t:k7(Math.max(2*t,i)):t<=2*i?t:k7(i)}class Qje{constructor(e,i,r,s){this.vao=new Tr(e,i,{geometry:r},{geometry:Nt.createVertex(e,35044)}),this.array=new Float32Array(s),this.vao.vertexBuffers.geometry.setData(this.array)}dispose(){this.vao.dispose(!0)}get length(){return this.array.length}}const Yje=C$+1;class Xje{constructor(e,i,r){this._rctx=e,this._locations=i,this._layout=r,this._cache=e.newCache(`MergedRenderer pool ${On()}`,Kje)}dispose(){this._cache.destroy()}newBuffer(e){const i=e.toString(),r=this._cache.pop(i);if(_(r)){const s=r.pop();return r.length>0&&this._cache.put(i,r,s.array.byteLength*r.length,Yje),s}return new Qje(this._rctx,this._locations,this._layout,e)}deleteBuffer(e){const i=e.array.byteLength,r=e.array.length.toString(),s=this._cache.pop(r);return _(s)?(s.push(e),this._cache.put(r,s,i*s.length,-1)):this._cache.put(r,[e],i,-1),null}}function Kje(t,e){if(e===0)return void t.forEach(s=>s.dispose());const i=t.pop(),r=t.length*i.array.byteLength;return i.dispose(),r}class xue{constructor(e,i,r){this._rctx=e,this._materialRepository=i,this._material=r,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new ct,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new yle(this._material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._bufferPool=new Xje(e,r.vertexAttributeLocations,il(this._bufferWriter.vertexBufferLayout))}dispose(){this._glMaterials.destroy(),this._dataByOrigin.forEach(e=>e.buffer.dispose()),this._dataByOrigin.clear(),this._bufferPool.dispose()}get isEmpty(){return this._dataByOrigin.size===0}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this._material instanceof vue}get rendersOccluded(){return!this.isEmpty&&this._material.renderOccluded!==1}modify(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()}addAndRemoveGeometries(e,i){const r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,n=this._dataByOrigin,o=tBe(e,i);o.forEach((a,l)=>{o.delete(l);const c=a.toAdd.reduce((w,S)=>w+r.elementCount(S.data),0);let h=n.get(l);if(h==null)Ze(a.toRemove.length===0),h=new rBe(a.origin,new Zje(this._bufferPool,c*s)),n.set(l,h);else if(a.toAdd.length===0&&h.instances.size===a.toRemove.length)return h.buffer.dispose(),void n.delete(l);let p=0;h.instances.forEach(w=>p+=w.to-w.from);const f=a.toRemove.reduce((w,S)=>w+r.elementCount(S.data),0),g=h.buffer.size,y=(p+c-f)*s,v=nBe;if(y<g/2?this.removeAndRebuild(h,a.toRemove,s,y,v):a.toRemove.length>0&&this.remove(h,a.toRemove,s,v),a.toAdd.length>0){const w=oBe;qne(w,-a.origin[0],-a.origin[1],-a.origin[2]),this.add(h,a.toAdd,s,w,v)}const b=h.buffer.vao.vertexBuffers.geometry;Cue(v),v.forAll(({from:w,to:S})=>{if(w<S){const T=h.buffer.array,C=4,M=w*C,P=S*C;b.setSubData(T,M,M,P)}}),v.clear(),h.drawCommandsDirty=!0})}updateGeometries(e){const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4;for(const s of e){const n=s.renderGeometry,o=this._dataByOrigin.get(n.origin.id),a=o&&o.instances.get(n.id);if(!a)return;const l=s.updateType;if(1&l&&(a.isVisible=n.instanceParameters.visible),9&l){const c=n.instanceParameters.visible;a.hasHighlights=!!n.instanceParameters.highlights&&c}if(16&l&&(a.hasOccludees=!!n.instanceParameters.occludees),6&l){const{array:c,vao:h}=o.buffer;Yze(n,z7,XT),i.write({transformation:z7,invTranspTransformation:XT},n.data,i.vertexBufferLayout.createView(c.buffer),a.from),Ze(a.from+i.elementCount(n.data)===a.to,"material VBO layout has changed"),h.vertexBuffers.geometry.setSubData(c,a.from*r*4,a.from*r*4,a.to*r*4)}o.drawCommandsDirty=!0}}updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(i=>{i.hasHiddenInstances=!1,i.hasHighlights=!1,i.hasOccludees=!1,vr(i.instances,r=>(r.isVisible?(r.hasHighlights&&(this._hasHighlights=!0,i.hasHighlights=!0),r.hasOccludees&&(this._hasOccludees=!0,i.hasOccludees=!0)):i.hasHiddenInstances=!0,i.hasHiddenInstances&&i.hasHighlights&&i.hasOccludees))});const e=i=>{if(i.drawCommandsDefault=null,i.drawCommandsHighlight=null,i.drawCommandsOccludees=null,i.drawCommandsShadowHighlightRest=null,i.instances.size===0)return;if(!Tue(i)){const s=this._bufferWriter.vertexBufferLayout.stride,n=4*i.buffer.size/s;return void(i.drawCommandsDefault=[{first:0,count:n}])}const r=bue(i.instances);i.drawCommandsDefault=[],i.drawCommandsHighlight=[],i.drawCommandsOccludees=[],i.drawCommandsShadowHighlightRest=[];for(const s of r)s.isVisible&&(s.hasOccludees?bR(i.drawCommandsOccludees,s):bR(i.drawCommandsDefault,s),s.hasHighlights?bR(i.drawCommandsHighlight,s):bR(i.drawCommandsShadowHighlightRest,s))};this._dataByOrigin.forEach(i=>{i.drawCommandsDirty&&(e(i),i.drawCommandsDirty=!1)})}updateLogic(e){return this._material.update(e)}render(e,i,r){if(e!=null&&!this._material.requiresSlot(e,i))return!1;const s=i===5||i===7;if(s&&!this._hasHighlights)return!1;const n=i===6,o=!(s||n);if(this._dataByOrigin.forEach(h=>{if(s&&!h.hasHighlights)return;const p=(s?h.drawCommandsHighlight:n&&Tue(h)?h.drawCommandsShadowHighlightRest:h.drawCommandsDefault)||null,f=o&&h.drawCommandsOccludees||null;(_(p)||_(f))&&this._renderCommandData.push(new sBe(h.origin,h.buffer,p,f))}),this._renderCommandData.length===0)return!1;const a=this._rctx,l=this._glMaterials.load(a,i);if(A(l))return this._renderCommandData.clear(),!1;const c=l.beginSlot(r);return c.bindPipelineState(a,e,!1),a.useProgram(c.program),l.bind(r,c),this._renderCommandData.forAll(({origin:h,buffer:p,renderCommands:f,occludeeCommands:g})=>{r.origin=h,c.bindDraw(r),c.ensureAttributeLocations(p.vao),a.bindVAO(p.vao);const y=c.primitiveType;_(f)&&this.renderCommands(a,y,f),_(g)&&(c.bindPipelineState(a,e,!0),this.renderCommands(a,y,g),c.bindPipelineState(a,e,!1))}),this._renderCommandData.clear(),!0}renderCommands(e,i,r){for(let s=0;s<r.length;s++)e.drawArrays(i,r[s].first,r[s].count)}removeAndRebuild(e,i,r,s,n){for(const h of i)e.instances.delete(h.id);const o=bue(e.instances);e.instances.clear();const a=e.buffer.size,l=e.buffer.alloc(s);let c=0;for(const h of o){const p=h.from*r,f=h.to*r;l.copy(c,p,f),h.from=c/r,c+=f-p,h.to=c/r,e.instances.set(h.id,h)}n.push(new YT(0,l.hasNewBuffer?e.buffer.array.length:a)),l.dispose(),e.buffer.erase(c,n.back().to),e.holes.clear()}remove(e,i,r,s){for(const n of i){const o=n.id,a=e.instances.get(o),l=a.from*r,c=a.to*r;e.buffer.erase(l,c),e.holes.push(new YT(a.from,a.to)),e.instances.delete(o),s.push(new YT(l,c))}Cue(e.holes)}add(e,i,r,s,n){const o=this._bufferWriter;let a=o.vertexBufferLayout.createView(e.buffer.array.buffer);for(const l of i){const c=_(l.transformation)?wi(z7,s,l.transformation):s;Fi(XT,c);const h=Nn(XT,XT),p=o.elementCount(l.data),f=p*r;let g=iBe(e.holes,p);A(g)&&(g=e.buffer.size/r,e.buffer.grow(f),a=o.vertexBufferLayout.createView(e.buffer.array.buffer)),o.write({transformation:c,invTranspTransformation:h},l.data,a,g);const y=l.instanceParameters.visible,v=!!l.instanceParameters.highlights&&y,b=!!l.instanceParameters.occludees,w=new qje(l.id,g,g+p,y,v,b);Ze(e.instances.get(l.id)==null),e.instances.set(l.id,w),n.push(new YT(w.from*r,w.to*r))}}get test(){return{material:this._material,glMaterials:this._glMaterials}}}class eBe{constructor(e){this.origin=e,this.toAdd=new Array,this.toRemove=new Array}}function tBe(t,e){const i=new Map;for(const r of t)Sue(i,r,!0);for(const r of e)Sue(i,r,!1);return i}function Sue(t,e,i){const r=e.origin;if(A(r))return;let s=t.get(r.id);s==null&&(s=new eBe(r.vec3),t.set(r.id,s)),i?s.toAdd.push(e):s.toRemove.push(e)}function Tue(t){return t.hasOccludees||t.hasHighlights||t.hasHiddenInstances}function iBe(t,e){let i;if(!t.some(s=>!(s.to-s.from<e)&&(i=s,!0)))return null;const r=i.from;return i.from+=e,i.from>=i.to&&t.removeUnordered(i),r}function Cue(t){const e=new Map;t.forAll(r=>e.set(r.from,r));let i=!0;for(;i;)i=!1,t.forEach(r=>{const s=e.get(r.to);s&&(r.to=s.to,e.delete(s.from),t.removeUnordered(s),i=!0)})}class rBe{constructor(e,i){this.origin=e,this.buffer=i,this.instances=new Map,this.holes=new ct({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1}}class sBe{constructor(e,i,r,s){this.origin=e,this.buffer=i,this.renderCommands=r,this.occludeeCommands=s}}const nBe=new ct({deallocator:null}),oBe=be(),z7=be(),XT=be();let zb=class extends ve{constructor(){super(...arguments),this._pending=new aBe,this._changes=new hue,this._materialRenderers=new Map,this._sortedMaterialRenderers=new ct,this._hasHighlights=!1,this._hasWater=!1}dispose(){this._changes.prune(),this._materialRenderers.forEach(t=>t.dispose()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return vr(this._materialRenderers,t=>t.rendersOccluded)}get isEmpty(){return!this.updating&&this._materialRenderers.size===0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const t=due(this._changes);let e=!1,i=!1,r=!1;return t.forEach((s,n)=>{let o=this._materialRenderers.get(n);if(!o&&s.adds.length>0&&(o=new xue(this.rctx,this.materialRepository,n),this._materialRenderers.set(n,o),e=!0,i=!0,r=!0),!o)return;const a=i||o.hasHighlights,l=r||o.hasWater;o.modify(s),i=i||a!==o.hasHighlights,r=r||l!==o.hasWater,o.isEmpty&&(this._materialRenderers.delete(n),o.dispose(),e=!0)}),this._changes.clear(),e&&this.updateSortedMaterialRenderers(),i&&(this._hasHighlights=vr(this._materialRenderers,s=>s.hasHighlights)),r&&(this._hasWater=vr(this._materialRenderers,s=>s.hasWater)),this.notifyChange("updating"),!0}add(t){if(t.length===0)return;const e=this._pending.empty;for(const i of t)this._pending.adds.add(i);e&&this.notifyChange("updating")}remove(t){const e=this._pending.empty;for(const i of t)this._pending.adds.has(i)?(this._pending.removed.add(i),this._pending.adds.delete(i)):this._pending.removed.has(i)||this._pending.removes.add(i);e&&!this._pending.empty&&this.notifyChange("updating")}modify(t,e){const i=this._changes.updates.length===0;for(const r of t){const s=this._changes.updates.pushNew();s.renderGeometry=r,s.updateType=e}i&&this._changes.updates.length>0&&this.notifyChange("updating")}updateLogic(t){let e=!1;return this._sortedMaterialRenderers.forAll(({materialRenderer:i})=>e=i.updateLogic(t)||e),e}render(t,e){for(let i=0;i<this._sortedMaterialRenderers.length;i++){const r=this._sortedMaterialRenderers.data[i];r.material.shouldRender(t)&&r.materialRenderer.render(e.slot,t.pass,e)}}updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let t=0;this._materialRenderers.forEach((e,i)=>{i.insertOrder=t++,this._sortedMaterialRenderers.push({material:i,materialRenderer:e})}),this._sortedMaterialRenderers.sort((e,i)=>{const r=i.material.renderPriority-e.material.renderPriority;return r!==0?r:e.material.insertOrder-i.material.insertOrder})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let t=0;t<this._changes.updates.length;){const e=this._changes.updates.data[t];this._pending.has(e.renderGeometry)?this._changes.updates.removeUnorderedIndex(t):t++}this._pending.clear()}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};u([d()],zb.prototype,"rctx",void 0),u([d()],zb.prototype,"materialRepository",void 0),u([d()],zb.prototype,"updating",null),zb=u([R("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],zb);class aBe{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}function KT(t){t.attributes.add("position","vec2"),t.varyings.add("uv","vec2"),t.vertex.code.add(x`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      uv = position * 0.5 + vec2(0.5);
    }
  `)}function lBe(){const t=new pi;return t.include(KT),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("color","vec4"),t.fragment.code.add(x`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * color;
}`),t}const cBe=Object.freeze({__proto__:null,build:lBe});class e3 extends Si{initializeProgram(e){const i=e3.shader.get().build();return new fi(e.rctx,i,Ht)}initializePipeline(){return this.configuration.hasAlpha?_t({blending:Xs(770,1,771,771),colorWrite:Pt}):_t({colorWrite:Pt})}}e3.shader=new vi(cBe,()=>import("./TextureOnly.glsl.40d73882.js"));class V7 extends tr{constructor(){super(...arguments),this.hasAlpha=!1}}u([X()],V7.prototype,"hasAlpha",void 0);function uBe(t,e,i){(i=i||t).length=t.length;for(let r=0;r<t.length;r++)i[r]=t[r]*e[r];return i}function N7(t,e,i){(i=i||t).length=t.length;for(let r=0;r<t.length;r++)i[r]=t[r]*e;return i}function Vb(t,e,i){(i=i||t).length=t.length;for(let r=0;r<t.length;r++)i[r]=t[r]+e[r];return i}function Mue(t){return(t+1)*(t+1)}function hBe(t){return Re(Math.floor(Math.sqrt(t)-1),0,2)}function Pue(t,e,i){const r=t[0],s=t[1],n=t[2],o=i||[];return o.length=Mue(e),e>=0&&(o[0]=.28209479177),e>=1&&(o[1]=.4886025119*r,o[2]=.4886025119*n,o[3]=.4886025119*s),e>=2&&(o[4]=1.09254843059*r*s,o[5]=1.09254843059*s*n,o[6]=.31539156525*(3*n*n-1),o[7]=1.09254843059*r*n,o[8]=.54627421529*(r*r-s*s)),o}function dBe(t,e){const i=Mue(t),r=e||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let s=0;s<i;s++)r.r[s]=r.g[s]=r.b[s]=0;return r}function pBe(t,e){const i=hBe(e.r.length);for(const r of t)Fs(U7,r.direction),Pue(U7,i,Gd),uBe(Gd,wR),N7(Gd,r.intensity[0],Nb),Vb(e.r,Nb),N7(Gd,r.intensity[1],Nb),Vb(e.g,Nb),N7(Gd,r.intensity[2],Nb),Vb(e.b,Nb);return e}function fBe(t,e){Pue(U7,0,Gd);for(const i of t)e.r[0]+=Gd[0]*wR[0]*i.intensity[0]*4*Math.PI,e.g[0]+=Gd[0]*wR[0]*i.intensity[1]*4*Math.PI,e.b[0]+=Gd[0]*wR[0]*i.intensity[2]*4*Math.PI;return e}function mBe(t,e,i,r){dBe(e,r),ne(i.intensity,0,0,0);let s=!1;const n=gBe,o=yBe,a=vBe;n.length=0,o.length=0,a.length=0;for(const l of t)l instanceof UV&&!s?(re(i.direction,l.direction),i.intensity[0]=l.intensity[0],i.intensity[1]=l.intensity[1],i.intensity[2]=l.intensity[2],i.castShadows=l.castShadows,s=!0):l instanceof UV||l instanceof foe?n.push(l):l instanceof NV?o.push(l):l instanceof moe&&a.push(l);pBe(n,r),fBe(o,r);for(const l of a)Vb(r.r,l.r),Vb(r.g,l.g),Vb(r.b,l.b)}const gBe=[],yBe=[],vBe=[],Gd=[0],Nb=[0],U7=$(),wR=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class Aue{constructor(){this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:$(),ambient:{color:$(),intensity:1},diffuse:{color:$(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new moe,this._mainLight={intensity:$(),direction:De(1,0,0),castShadows:!1}}get lightingMainDirection(){return this._mainLight.direction}setLightDirectionUniform(e){e.setUniform3fv("lightingMainDirection",this._mainLight.direction)}setUniforms(e,i=!1){const r=i?(1-this.groundLightingFactor)*(1-this.globalFactor):0;e.setUniform1f("lightingFixedFactor",r),e.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),e.setUniform1f("ambientBoostFactor",this._ambientBoost);const s=this._sphericalHarmonics;this._shOrder===0?e.setUniform3f("lightingAmbientSH0",s.r[0],s.g[0],s.b[0]):this._shOrder===1?(e.setUniform4f("lightingAmbientSH_R",s.r[0],s.r[1],s.r[2],s.r[3]),e.setUniform4f("lightingAmbientSH_G",s.g[0],s.g[1],s.g[2],s.g[3]),e.setUniform4f("lightingAmbientSH_B",s.b[0],s.b[1],s.b[2],s.b[3])):this._shOrder===2&&(e.setUniform3f("lightingAmbientSH0",s.r[0],s.g[0],s.b[0]),e.setUniform4f("lightingAmbientSH_R1",s.r[1],s.r[2],s.r[3],s.r[4]),e.setUniform4f("lightingAmbientSH_G1",s.g[1],s.g[2],s.g[3],s.g[4]),e.setUniform4f("lightingAmbientSH_B1",s.b[1],s.b[2],s.b[3],s.b[4]),e.setUniform4f("lightingAmbientSH_R2",s.r[5],s.r[6],s.r[7],s.r[8]),e.setUniform4f("lightingAmbientSH_G2",s.g[5],s.g[6],s.g[7],s.g[8]),e.setUniform4f("lightingAmbientSH_B2",s.b[5],s.b[6],s.b[7],s.b[8]))}set(e){mBe(e,this._shOrder,this._mainLight,this._sphericalHarmonics),re(this._oldSunlight.direction,this._mainLight.direction);const i=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*i,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*i,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*i,se(this._oldSunlight.diffuse.color,this._mainLight.intensity,i),re(xR,this._oldSunlight.diffuse.color),se(xR,xR,this._ambientBoost*this.globalFactor),de(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,xR)}get old(){return this._oldSunlight}}const xR=$();function ev(t,e,i=0){const r=Re(t,0,wBe);for(let s=0;s<4;s++)e[i+s]=Math.floor(256*xBe(r*_Be[s]))}function j7(t,e=0){let i=0;for(let r=0;r<4;r++)i+=t[e+r]*bBe[r];return i}const _Be=[1,256,65536,16777216],bBe=[1/256,1/65536,1/16777216,1/4294967296],wBe=j7(new Uint8ClampedArray([255,255,255,255]));function xBe(t){return t-Math.floor(t)}class $ue{constructor(e){this._rctx=e,this.cache=new Map}dispose(){this.cache.forEach(e=>e.texture=Ge(e.texture)),this.cache.clear()}acquire(e){if(A(e))return null;const i=this.patternId(e),r=this.cache.get(i);if(r)return r.refCount++,r.bind;const s=e.pixelRatio,{encodedData:n,sdfNormalizer:o,pixels:a,paddedPixels:l}=SBe(e.pattern,s),c=a/s,h={refCount:1,texture:null,bind:p=>(A(h.texture)&&(h.texture=new qe(this._rctx,{width:l,height:1,internalFormat:6408,pixelFormat:6408,dataType:5121,wrapMode:33071},n)),p.bindTexture(h.texture,"stipplePatternTexture"),{pixelSize:c,sdfNormalizer:o,pixels:a})};return this.cache.set(i,h),h.bind}release(e){if(A(e))return;const i=this.patternId(e),r=this.cache.get(i);r&&(r.refCount--,r.refCount===0&&(_(r.texture)&&r.texture.dispose(),this.cache.delete(i)))}swap(e,i){const r=this.acquire(i);return this.release(e),r}patternId(e){return`${e.pattern.join(",")}-r${e.pixelRatio}`}}function SBe(t,e){const i=t.map(y=>Math.round(y*e)),r=1/e,s=Math.floor(i.reduce((y,v)=>y+v)),n=i.reduce((y,v)=>Math.max(y,v)),o=(Math.floor(.5*(n-1))+.5)*r,a=[];let l=1;for(const y of i){for(let v=0;v<y;v++){const b=l*(Math.min(v,y-1-v)+.5)*r/o*.5+.5;a.push(b)}l=-l}const c=Math.round(i[0]/2),h=[...a.slice(c),...a.slice(0,c)],p=s+2,f=new Uint8Array(4*p);let g=4;for(const y of h)ev(y,f,g),g+=4;return f.copyWithin(0,g-4,g),f.copyWithin(g,4,8),{encodedData:f,sdfNormalizer:o,paddedPixels:p,pixels:s}}const Eue=le.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let Rc=class extends lR(ve){constructor(t){super(t),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new Aue,this._handles=new dt,this._frameTask=N_,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new ct,this._geometries=new Map,this.worldToPCSRatio=1,this.events=new Ci,this.longitudeCyclical=null}initialize(){const t=this.view._stage.renderView;this._rctx=t.renderingContext,this._renderContext=new cue(this._rctx);const e=t.waterTextureRepository;this._stippleTextureRepository=new $ue(t.renderingContext),this._shaderTechniqueRepository=new jce({rctx:this._rctx,viewingMode:2,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:e}),this._handles.add([Ke(e,"loadingState",()=>this.events.emit("content-changed")),Ke(this,"spatialReference",i=>this._localOrigins=new D7(i))]),this._materialRepository=new Gce(t.textureRepository,this._shaderTechniqueRepository,i=>{(i.renderOccluded&CR)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating")},()=>this.events.emit("content-changed")),this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new NV(De(1,1,1))]),this._bindParameters={slot:20,highlightDepthTexture:gne(this._rctx),camera:tv,inverseViewport:ke(),origin:null,screenToWorldRatio:null,screenToPCSRatio:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:Dr,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null},this._frameTask=this.view.resourceController.scheduler.registerTask(Qe.STAGE,this),this._handles.add(this._frameTask)}dispose(){this._handles.destroy(),this._layerRenderers.forEach(t=>t.dispose()),this._layerRenderers.clear(),this._debugTextureTechnique=nr(this._debugTextureTechnique),this._debugPatternTexture=Ge(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=Ge(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Ge(this._shaderTechniqueRepository),this._temporaryFBO=Ge(this._temporaryFBO),this._quadVAO=Ge(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedLayerRenderersDirty||this._frameTask.updating||vr(this._layerRenderers,t=>t.updating)}get hasOverlays(){return _(this._overlays)&&_(this._overlayRenderTarget)}get gpuMemoryUsage(){return _(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(t){let e=!1;if(_(this._overlayRenderTarget))for(const i of this._overlayRenderTarget.renderTargets){const r=this.overlays[0].validTargets[i.type]||!this.overlays[1].validTargets[i.type];e=this._overlayRenderTarget.validateUsageForTarget(r,i,t)||e}return e}get overlays(){return st(this._overlays,[])}ensureDrapeTargets(t){_(this._overlays)&&this._overlays.forEach(e=>{e.hasTargetWithoutRasterImage=xG(t,i=>i.drapeTargetType===1)})}ensureDrapeSources(t){_(this._overlays)&&this._overlays.forEach(e=>{e.hasDrapedFeatureSource=vr(t,(i,r)=>r.drapeSourceType===1),e.hasDrapedRasterSource=vr(t,(i,r)=>r.drapeSourceType===0)})}ensureOverlays(t,e){A(this._overlays)&&(this._overlayRenderTarget=new ZUe(this._rctx),this._overlays=[new Vce(0,this._overlayRenderTarget),new Vce(1,this._overlayRenderTarget)]),this.ensureDrapeTargets(t),this.ensureDrapeSources(e)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=Ge(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(t,e=()=>!0){this._frameTask.processQueue(t),t.done||this._processLayers(t,e)}_processLayers(t,e){let i=!1;for(const[r,s]of this._layerRenderers){if(t.done)break;(r.destroyed||e(r))&&(s.commitChanges()&&(i=!0,t.madeProgress()),s.isEmpty&&(i=!0,this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(r),this._handles.remove(r)))}this.updateSortedLayerRenderers(),i&&(_(this._overlays)&&this._layerRenderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}processSyncLayers(){this._processLayers(V_,t=>t.updatePolicy===1)}addGeometries(t,e,i){for(const r of t)A(r.origin)&&(r.origin=this._localOrigins.getOrigin(r.boundingSphere)),this._geometries.set(r.id,r);this.ensureLayerRenderer(e).add(t),i===2&&this.notifyGraphicGeometryChanged(t,e)}removeGeometries(t,e,i){for(const s of t)this._geometries.delete(at(s.id));const r=this._layerRenderers.get(e);r&&(r.remove(t),i===2&&this.notifyGraphicGeometryChanged(t,e))}updateGeometries(t,e,i){const r=this._layerRenderers.get(e);if(r)switch(r.modify(t,i),i){case 4:case 2:return this.notifyGraphicGeometryChanged(t,e);case 1:return this.notifyGraphicVisibilityChanged(t,e)}else Eue.warn("Attempted to update geometry for nonexistent layer")}notifyGraphicGeometryChanged(t,e){if(A(e.notifyGraphicGeometryChanged))return;let i;for(const r of t){const s=r.graphicUid;_(s)&&s!==i&&(e.notifyGraphicGeometryChanged(s),i=s)}}notifyGraphicVisibilityChanged(t,e){if(A(e.notifyGraphicVisibilityChanged))return;let i;for(const r of t){const s=r.graphicUid;_(s)&&s!==i&&(e.notifyGraphicVisibilityChanged(s),i=s)}}updateHighlights(t,e){const i=this._layerRenderers.get(e);i?i.modify(t,8):Eue.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return this._geometries.size===0&&!Kt.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateLogic(t){let e=!1;return this._layerRenderers.forEach(i=>e=i.updateLogic(t)||e),e}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawTarget(t,e,i){const r=t.canvasGeometries;if(r.numViews===0)return!1;this._screenToWorldRatio=i*t.mapUnitsPerPixel;const s=e.renderPass;if(this.isEmpty()||s===5&&!this.hasHighlights||s===3&&!this.hasWater||!t.hasSomeSizedView())return!1;const n=e.fbo;if(!n.isValid())return!1;const o=2*t.resolution,a=t.resolution;n.resize(o,a);const l=this._rctx;tv.pixelRatio=t.pixelRatio*i,this._renderContext.pass=s,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=s===3?21:20,t.applyViewport(this._rctx),n.bind(l),t.index===0&&(l.setClearColor(0,0,0,0),l.clearSafe(16384));const c=e.type===1?2:e.type===4?1:0;if(c===1&&(this._renderContext.renderOccludedMask=CR),Kt.OVERLAY_DRAW_DEBUG_TEXTURE&&c!==1)for(let h=0;h<r.numViews;h++)this.setViewParameters(r.extents[h],t,tv),this.drawDebugTexture(t.resolution,TBe[t.index]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll(({layerView:h,renderer:p})=>{if(c===2&&_(h)&&h.drapeSourceType===0)return;const f=_(h)&&_(h.fullOpacity)&&h.fullOpacity<1&&s===0;f&&(this.bindTemporaryFramebuffer(this._rctx,o,a),l.clearSafe(16384));for(let g=0;g<r.numViews;g++)this.setViewParameters(r.extents[g],t,tv),p.render(this._renderContext,this._bindParameters);f&&_(this._temporaryFBO)&&(n.bind(l),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),2,at(at(h).fullOpacity),3,t.index))}),l.bindFramebuffer(null),n.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(t,e,i){A(this._temporaryFBO)&&(this._temporaryFBO=new Nce(t,!1)),this._temporaryFBO.resize(e,i),this._temporaryFBO.bind(t)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}intersect(t,e,i,r){let s=0;this._geometries.forEach(n=>{if(r&&!r(n))return;this._intersectRenderGeometry(n,i,e,0,t,s);const o=this.longitudeCyclical;o&&(n.boundingSphere[0]-n.boundingSphere[3]<o.min&&this._intersectRenderGeometry(n,i,e,o.range,t,s),n.boundingSphere[0]+n.boundingSphere[3]>o.max&&this._intersectRenderGeometry(n,i,e,-o.range,t,s)),s++})}_intersectRenderGeometry(t,e,i,r,s,n){if(!t.instanceParameters.visible)return;let o=0;_(t.transformation)&&(r+=t.transformation[12],o=t.transformation[13]),SR[0]=i[0]-r,SR[1]=i[1]-o,SR[2]=1,TR[0]=i[0]-r,TR[1]=i[1]-o,TR[2]=0,t.screenToWorldRatio=this._screenToWorldRatio,t.material.intersect(t,null,t.getShaderTransformation(),s,SR,TR,(a,l,c)=>{CBe(e,c,t.material.renderPriority,n,s,t.layerUid,t.graphicUid)},t.calculateShaderTransformation,e)}ensureLayerRenderer(t){let e=this._layerRenderers.get(t);return e||(e=new zb({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(t,e),this._sortedLayerRenderersDirty=!0,"fullOpacity"in t&&this._handles.add(t.watch("fullOpacity",()=>this.events.emit("content-changed")),t),this._handles.add(Ke(e,"updating",()=>this.notifyChange("updating")),t)),e}updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty||(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),this._layerRenderers.size===0))return;const t=new Set(this._layerRenderers.values());this.view.allLayerViews.forEach(e=>{const i=e,r=this._layerRenderers.get(i);r&&(this._sortedLayerRenderers.push(new Oue(i,r)),t.delete(r))}),t.forEach(e=>this._sortedLayerRenderers.push(new Oue(null,e)))}setViewParameters(t,e,i){i.viewport[0]=i.viewport[1]=0,i.viewport[2]=i.viewport[3]=e.resolution,JL(i.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],i.near,i.far),Di(i.viewMatrix),Vs(i.viewMatrix,i.viewMatrix,[-t[0],-t[1],0]),this._renderContext.camera=i,this._bindParameters.camera=i,this._bindParameters.inverseViewport[0]=1/i.fullViewport[2],this._bindParameters.inverseViewport[1]=1/i.fullViewport[3]}updateHasWater(){const t=vr(this._layerRenderers,e=>e.hasWater);t!==this._hasWater&&(this._hasWater=t,this.events.emit("has-water",t))}updateHasHighlights(){const t=vr(this._layerRenderers,e=>e.hasHighlights);t!==this._hasHighlights&&(this._hasHighlights=t,this.events.emit("has-highlights",t))}updateRendersOccluded(){const t=vr(this._layerRenderers,e=>e.rendersOccluded);t!==this._rendersOccluded&&(this._rendersOccluded=t,this.events.emit("renders-occluded",t))}drawDebugTexture(t,e){const i=this._rctx;this.ensureDebugPatternResources(t,t);const r=this._debugTextureTechnique.program;i.useProgram(r),this._debugTextureTechnique.bindPipelineState(i),r.setUniform4f("color",e[0],e[1],e[2],1),r.bindTexture(this._debugPatternTexture,"tex"),i.bindVAO(this._quadVAO),i.drawArrays(5,0,xs(this._quadVAO,"geometry"))}ensureDebugPatternResources(t,e){if(this._debugPatternTexture)return;const i=new Uint8Array(t*e*4);let r=0;for(let n=0;n<e;n++)for(let o=0;o<t;o++){const a=Math.floor(o/10),l=Math.floor(n/10);a<2||l<2||10*a>t-20||10*l>e-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&a&&1&l?1&o^1&n?0:255:1&a^1&l?0:128)}this._debugPatternTexture=new qe(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:t,height:e},i);const s=new V7;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(e3,s),this._quadVAO=vn(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};u([d()],Rc.prototype,"_frameTask",void 0),u([d()],Rc.prototype,"_sortedLayerRenderersDirty",void 0),u([Cs()],Rc.prototype,"_shaderTechniqueRepository",void 0),u([Cs()],Rc.prototype,"_stippleTextureRepository",void 0),u([d({constructOnly:!0})],Rc.prototype,"view",void 0),u([d()],Rc.prototype,"worldToPCSRatio",void 0),u([d()],Rc.prototype,"spatialReference",void 0),u([d({type:Boolean,readOnly:!0})],Rc.prototype,"updating",null),Rc=u([R("esri.views.3d.terrain.OverlayRenderer")],Rc);class Oue{constructor(e,i){this.layerView=e,this.renderer=i}}const TBe=[[1,.5,.5],[.5,.5,1]];function CBe(t,e,i,r,s,n,o){const a={layerUid:n,graphicUid:o,triangleNr:e},l=c=>{c.set(3,a,t.dist,t.normal,t.transformation,i,r)};if((s.results.min.drapedLayerOrder==null||i>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==0&&(s.results.max.drapedLayerOrder==null||i<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===2){const c=YE(s.ray);l(c),s.results.all.push(c)}}const tv=new Zt;tv.near=1,tv.far=1e4,tv.relativeElevation=null;const SR=$(),TR=$(),B7=-2,CR=4;function Rue(t){const e=[["position",t.indices]],i=[["position",{size:3,data:t.attributeData.position,exclusive:!0}]];return _(t.attributeData.color)&&(i.push(["color",{size:4,data:t.attributeData.color,exclusive:!0}]),e.push(["color",new Uint32Array(t.indices.length)])),_(t.attributeData.uvMapSpace)&&(i.push(["uvMapSpace",{size:4,data:t.attributeData.uvMapSpace,exclusive:!0}]),e.push(["uvMapSpace",t.indices])),_(t.attributeData.boundingRect)&&(i.push(["boundingRect",{size:9,data:t.attributeData.boundingRect,exclusive:!0}]),e.push(["boundingRect",t.indices])),_(t.attributeData.mapPosition)&&(i.push(["mapPos",{size:3,data:t.attributeData.mapPosition,exclusive:!0}]),e.push(["mapPos",t.indices])),new zi(i,e)}function Iue(t){const e=[["position",t.indices],["uv0",t.indices]],i=[["position",{size:3,data:t.attributeData.position,exclusive:!0}],["uv0",{size:2,data:t.attributeData.uv0,exclusive:!0}]];return _(t.attributeData.mapPosition)&&(i.push(["mapPos",{size:3,data:t.attributeData.mapPosition,exclusive:!0}]),e.push(["mapPos",t.indices])),new zi(i,e)}function t3(t){switch(t.type){case"extent":if(t instanceof ht)return Zo.fromExtent(t);break;case"polygon":return t}return null}function G7(t,e,i,r){const s=HT(t.rings,t.hasZ,1),n=new Float64Array(s.position.length),o=dce(s.position,t.spatialReference,0,n,0,s.position,0,s.position.length/3,e,i,r),a=o!=null;return{position:s.position,mapPosition:n,polygons:Lue(s.polygons,s.position,n),outlines:Fue(s.outlines,s.position,n),projectionSuccess:a,sampledElevation:o}}function Due(t,e){const i=HT(t.rings,!1,1),r=Mi(i.position,t.spatialReference,0,i.position,e,0,i.position.length/3);for(let s=2;s<i.position.length;s+=3)i.position[s]=B7;return{position:i.position,polygons:Lue(i.polygons,i.position),outlines:Fue(i.outlines,i.position),projectionSuccess:r}}function Fue(t,e,i){const r=new Array;for(const{index:s,count:n}of t){if(n<=1)continue;const o=3*s,a=o+3*n;r.push({index:s,count:n,position:e.subarray(o,a),mapPosition:i?i.subarray(o,a):void 0})}return r}function Lue(t,e,i){const r=new Array;for(const{index:s,count:n,holeIndices:o,pathLengths:a}of t){if(n<=1)continue;const l=3*s,c=l+3*n,h=o.map(p=>p-s);r.push({index:s,count:n,holeIndices:h,pathLengths:a,position:e.subarray(l,c),mapPosition:i?i.subarray(l,c):void 0})}return r}function q7({code:t},e){e.doublePrecisionRequiresObfuscation?t.add(x`vec3 dpPlusFrc(vec3 a, vec3 b) {
return mix(a, a + b, vec3(notEqual(b, vec3(0))));
}
vec3 dpMinusFrc(vec3 a, vec3 b) {
return mix(vec3(0), a - b, vec3(notEqual(a, b)));
}
vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = dpPlusFrc(hiA, hiB);
vec3 e = dpMinusFrc(t1, hiA);
vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
return t1 + t2;
}`):t.add(x`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = hiA + hiB;
vec3 e = t1 - hiA;
vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
return t1 + t2;
}`)}function MR(t){return!!ae("force-double-precision-obfuscation")||t.driverTest.doublePrecisionRequiresObfuscation}function i3(t,e){e.instanced&&e.instancedDoublePrecision&&(t.attributes.add("modelOriginHi","vec3"),t.attributes.add("modelOriginLo","vec3"),t.attributes.add("model","mat3"),t.attributes.add("modelNormal","mat3")),e.instancedDoublePrecision&&(t.vertex.include(q7,e),t.vertex.uniforms.add("viewOriginHi","vec3"),t.vertex.uniforms.add("viewOriginLo","vec3"));const i=[x`
    vec3 calculateVPos() {
      ${e.instancedDoublePrecision?"return model * localPosition().xyz;":"return localPosition().xyz;"}
    }
    `,x`
    vec3 subtractOrigin(vec3 _pos) {
      ${e.instancedDoublePrecision?x`
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -modelOriginHi, -modelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `,x`
    vec3 dpNormal(vec4 _normal) {
      ${e.instancedDoublePrecision?"return normalize(modelNormal * _normal.xyz);":"return normalize(_normal.xyz);"}
    }
    `,x`
    vec3 dpNormalView(vec4 _normal) {
      ${e.instancedDoublePrecision?"return normalize((viewNormal * vec4(modelNormal * _normal.xyz, 1.0)).xyz);":"return normalize((viewNormal * _normal).xyz);"}
    }
    `,e.vertexTangents?x`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${e.instancedDoublePrecision?"return vec4(modelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}

    }
    `:x``];t.vertex.code.add(i[0]),t.vertex.code.add(i[1]),t.vertex.code.add(i[2]),e.output===2&&t.vertex.code.add(i[3]),t.vertex.code.add(i[4])}(function(t){class e{}function i(r,s){Qze(s,kue,zue,3),r.setUniform3fv("viewOriginHi",kue),r.setUniform3fv("viewOriginLo",zue)}t.Uniforms=e,t.bindCustomOrigin=i})(i3||(i3={}));const kue=$(),zue=$();function Vue(t){t.extensions.add("GL_EXT_shader_texture_lod"),t.extensions.add("GL_OES_standard_derivatives"),t.fragment.code.add(x`#ifndef GL_EXT_shader_texture_lod
float calcMipMapLevel(const vec2 ddx, const vec2 ddy) {
float deltaMaxSqr = max(dot(ddx, ddx), dot(ddy, ddy));
return max(0.0, 0.5 * log2(deltaMaxSqr));
}
#endif
vec4 textureAtlasLookup(sampler2D texture, vec2 textureSize, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
#ifdef GL_EXT_shader_texture_lod
return texture2DGradEXT(texture, uvAtlas, dUVdx, dUVdy);
#else
vec2 dUVdxAuto = dFdx(uvAtlas);
vec2 dUVdyAuto = dFdy(uvAtlas);
float mipMapLevel = calcMipMapLevel(dUVdx * textureSize, dUVdy * textureSize);
float autoMipMapLevel = calcMipMapLevel(dUVdxAuto * textureSize, dUVdyAuto * textureSize);
return texture2D(texture, uvAtlas, mipMapLevel - autoMipMapLevel);
#endif
}`)}function H7(t,e){t.include(fd,e),t.fragment.code.add(x`
  struct TextureLookupParameter {
    vec2 uv;
    ${e.supportsTextureAtlas?"vec2 size;":""}
  } vtc;
  `),e.attributeTextureCoordinates===1&&t.fragment.code.add(x`vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
return texture2D(tex, params.uv);
}`),e.attributeTextureCoordinates===2&&(t.include(Vue),t.fragment.code.add(x`vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
return textureAtlasLookup(tex, params.size, params.uv, vuvRegion);
}`))}const Lat=xt(0,.6,.2);function W7(t,e){const i=t.fragment,r=e.hasMetalnessAndRoughnessTexture||e.hasEmissionTexture||e.hasOcclusionTexture;e.pbrMode===1&&r&&t.include(H7,e),e.pbrMode!==2?(e.pbrMode===0&&i.code.add(x`float getBakedOcclusion() { return 1.0; }`),e.pbrMode===1&&(i.uniforms.add("emissionFactor","vec3"),i.uniforms.add("mrrFactors","vec3"),i.code.add(x`vec3 mrr;
vec3 emission;
float occlusion;`),e.hasMetalnessAndRoughnessTexture&&(i.uniforms.add("texMetallicRoughness","sampler2D"),e.supportsTextureAtlas&&i.uniforms.add("texMetallicRoughnessSize","vec2"),i.code.add(x`void applyMetallnessAndRoughness(TextureLookupParameter params) {
vec3 metallicRoughness = textureLookup(texMetallicRoughness, params).rgb;
mrr[0] *= metallicRoughness.b;
mrr[1] *= metallicRoughness.g;
}`)),e.hasEmissionTexture&&(i.uniforms.add("texEmission","sampler2D"),e.supportsTextureAtlas&&i.uniforms.add("texEmissionSize","vec2"),i.code.add(x`void applyEmission(TextureLookupParameter params) {
emission *= textureLookup(texEmission, params).rgb;
}`)),e.hasOcclusionTexture?(i.uniforms.add("texOcclusion","sampler2D"),e.supportsTextureAtlas&&i.uniforms.add("texOcclusionSize","vec2"),i.code.add(x`void applyOcclusion(TextureLookupParameter params) {
occlusion *= textureLookup(texOcclusion, params).r;
}
float getBakedOcclusion() {
return occlusion;
}`)):i.code.add(x`float getBakedOcclusion() { return 1.0; }`),i.code.add(x`
    void applyPBRFactors() {
      mrr = mrrFactors;
      emission = emissionFactor;
      occlusion = 1.0;
      ${r?"vtc.uv = vuv0;":""}
      ${e.hasMetalnessAndRoughnessTexture?e.supportsTextureAtlas?"vtc.size = texMetallicRoughnessSize; applyMetallnessAndRoughness(vtc);":"applyMetallnessAndRoughness(vtc);":""}
      ${e.hasEmissionTexture?e.supportsTextureAtlas?"vtc.size = texEmissionSize; applyEmission(vtc);":"applyEmission(vtc);":""}
      ${e.hasOcclusionTexture?e.supportsTextureAtlas?"vtc.size = texOcclusionSize; applyOcclusion(vtc);":"applyOcclusion(vtc);":""}
    }
  `))):i.code.add(x`const vec3 mrr = vec3(0.0, 0.6, 0.2);
const vec3 emission = vec3(0.0);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`)}function Nue(t,e,i=!1){i||(t.setUniform3fv("mrrFactors",e.mrrFactors),t.setUniform3fv("emissionFactor",e.emissiveFactor))}function Uue(t){t.vertex.code.add(x`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)}function MBe(t){const e=x`vec3 decodeNormal(vec2 f) {
float z = 1.0 - abs(f.x) - abs(f.y);
return vec3(f + sign(f) * min(z, 0.0), z);
}`;t.fragment.code.add(e),t.vertex.code.add(e)}function PR(t,e){e.normalType===0&&(t.attributes.add("normal","vec3"),t.vertex.code.add(x`vec3 normalModel() {
return normal;
}`)),e.normalType===1&&(t.include(MBe),t.attributes.add("normalCompressed","vec2"),t.vertex.code.add(x`vec3 normalModel() {
return decodeNormal(normalCompressed);
}`)),e.normalType===3&&(t.extensions.add("GL_OES_standard_derivatives"),t.fragment.code.add(x`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`))}function AR(t){t.attributes.add("position","vec3"),t.vertex.code.add(x`vec3 positionModel() { return position; }`)}function jue(t){t.vertex.code.add(x`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${x.int(1)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${x.int(3)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${x.int(4)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${x.int(1)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}function Bue(t,e){e.symbolColor?(t.include(jue),t.attributes.add("symbolColor","vec4"),t.varyings.add("colorMixMode","mediump float")):t.fragment.uniforms.add("colorMixMode","int"),e.symbolColor?t.vertex.code.add(x`int symbolColorMixMode;
vec4 getSymbolColor() {
return decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;
}
void forwardColorMixMode() {
colorMixMode = float(symbolColorMixMode) + 0.5;
}`):t.vertex.code.add(x`vec4 getSymbolColor() { return vec4(1.0); }
void forwardColorMixMode() {}`)}function iv(t,e){e.attributeColor?(t.attributes.add("color","vec4"),t.varyings.add("vColor","vec4"),t.vertex.code.add(x`void forwardVertexColor() { vColor = color; }`),t.vertex.code.add(x`void forwardNormalizedVertexColor() { vColor = color * 0.003921568627451; }`)):t.vertex.code.add(x`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}function eo(t,e){t.include(AR),t.vertex.include(q7,e),t.varyings.add("vPositionWorldCameraRelative","vec3"),t.varyings.add("vPosition_view","vec3"),t.vertex.uniforms.add("uTransform_WorldFromModel_RS","mat3"),t.vertex.uniforms.add("uTransform_WorldFromModel_TH","vec3"),t.vertex.uniforms.add("uTransform_WorldFromModel_TL","vec3"),t.vertex.uniforms.add("uTransform_WorldFromView_TH","vec3"),t.vertex.uniforms.add("uTransform_WorldFromView_TL","vec3"),t.vertex.uniforms.add("uTransform_ViewFromCameraRelative_RS","mat3"),t.vertex.uniforms.add("uTransform_ProjFromView","mat4"),t.vertex.code.add(x`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = uTransform_WorldFromModel_RS * positionModel();
vec3 transform_CameraRelativeFromModel = dpAdd(
uTransform_WorldFromModel_TL,
uTransform_WorldFromModel_TH,
-uTransform_WorldFromView_TL,
-uTransform_WorldFromView_TH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 position_view() {
return uTransform_ViewFromCameraRelative_RS * positionWorldCameraRelative();
}
void forwardPosition() {
vPositionWorldCameraRelative = positionWorldCameraRelative();
vPosition_view = position_view();
gl_Position = uTransform_ProjFromView * vec4(vPosition_view, 1.0);
}
vec3 positionWorld() {
return uTransform_WorldFromView_TL + vPositionWorldCameraRelative;
}`),t.fragment.uniforms.add("uTransform_WorldFromView_TL","vec3"),t.fragment.code.add(x`vec3 positionWorld() {
return uTransform_WorldFromView_TL + vPositionWorldCameraRelative;
}`)}(function(t){class e{constructor(){this.worldFromModel_RS=Ai(),this.worldFromModel_TH=$(),this.worldFromModel_TL=$()}}t.ModelTransform=e;class i{constructor(){this.worldFromView_TH=$(),this.worldFromView_TL=$(),this.viewFromCameraRelative_RS=Ai(),this.projFromView=be()}}function r(n,o){n.setUniformMatrix3fv("uTransform_WorldFromModel_RS",o.worldFromModel_RS),n.setUniform3fv("uTransform_WorldFromModel_TH",o.worldFromModel_TH),n.setUniform3fv("uTransform_WorldFromModel_TL",o.worldFromModel_TL)}function s(n,o){n.setUniform3fv("uTransform_WorldFromView_TH",o.worldFromView_TH),n.setUniform3fv("uTransform_WorldFromView_TL",o.worldFromView_TL),n.setUniformMatrix4fv("uTransform_ProjFromView",o.projFromView),n.setUniformMatrix3fv("uTransform_ViewFromCameraRelative_RS",o.viewFromCameraRelative_RS)}t.ViewProjectionTransform=i,t.bindModelTransform=r,t.bindViewProjTransform=s})(eo||(eo={}));function rv(t,e){e.normalType===0||e.normalType===1?(t.include(PR,e),t.varyings.add("vNormalWorld","vec3"),t.varyings.add("vNormalView","vec3"),t.vertex.uniforms.add("uTransformNormal_GlobalFromModel","mat3"),t.vertex.uniforms.add("uTransformNormal_ViewFromGlobal","mat3"),t.vertex.code.add(x`void forwardNormal() {
vNormalWorld = uTransformNormal_GlobalFromModel * normalModel();
vNormalView = uTransformNormal_ViewFromGlobal * vNormalWorld;
}`)):e.normalType===2?(t.include(eo,e),t.varyings.add("vNormalWorld","vec3"),t.vertex.code.add(x`
    void forwardNormal() {
      vNormalWorld = ${e.viewingMode===1?x`normalize(vPositionWorldCameraRelative);`:x`vec3(0.0, 0.0, 1.0);`}
    }
    `)):t.vertex.code.add(x`void forwardNormal() {}`)}(function(t){function e(i,r){i.setUniformMatrix4fv("viewNormal",r)}t.bindUniforms=e})(rv||(rv={}));function Gue(t,e){const i=t.vertex.code,r=t.fragment.code;e.output!==1&&e.output!==3||(t.include(Ss,{linearDepth:!0}),t.include(fd,e),t.include($b,e),t.include(J0,e),t.include(Zi,e),t.vertex.uniforms.add("cameraNearFar","vec2"),t.varyings.add("depth","float"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),i.add(x`void main(void) {
vpos = calculateVPos();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPositionWithDepth(proj, view, vpos, cameraNearFar, depth);
forwardTextureCoordinates();
}`),t.include(bm,e),r.add(x`
      void main(void) {
        discardBySlice(vpos);
        ${e.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputDepth(depth);
      }
    `)),e.output===2&&(t.include(Ss,{linearDepth:!1}),t.include(PR,e),t.include(rv,e),t.include(fd,e),t.include($b,e),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vPositionView","vec3"),i.add(x`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        ${e.normalType===0?x`
        vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:""}
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, vpos);
        forwardTextureCoordinates();
      }
    `),t.include(Zi,e),t.include(bm,e),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}

        ${e.normalType===3?x`
            vec3 normal = screenDerivativeNormal(vPositionView);`:x`
            vec3 normal = normalize(vNormalWorld);
            if (gl_FrontFacing == false) normal = -normal;`}
        gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
      }
    `)),e.output===4&&(t.include(Ss,{linearDepth:!1}),t.include(fd,e),t.include($b,e),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),i.add(x`void main(void) {
vpos = calculateVPos();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPosition(proj, view, vpos);
forwardTextureCoordinates();
}`),t.include(Zi,e),t.include(bm,e),t.include(Dd),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputHighlight();
      }
    `))}function que(t,e){const i=t.fragment;e.vertexTangents?(t.attributes.add("tangent","vec4"),t.varyings.add("vTangent","vec4"),e.doubleSidedMode===2?i.code.add(x`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):i.code.add(x`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):(t.extensions.add("GL_OES_standard_derivatives"),i.code.add(x`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`)),e.attributeTextureCoordinates!==0&&(t.include(H7,e),i.uniforms.add("normalTexture","sampler2D"),i.uniforms.add("normalTextureSize","vec2"),i.code.add(x`
    vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
      vtc.uv = uv;
      ${e.supportsTextureAtlas?"vtc.size = normalTextureSize;":""}
      vec3 rawNormal = textureLookup(normalTexture, vtc).rgb * 2.0 - 1.0;
      return tangentSpace * rawNormal;
    }
  `))}function $R(t,e){const i=t.fragment;e.receiveAmbientOcclusion?(i.uniforms.add("ssaoTex","sampler2D"),i.uniforms.add("viewportPixelSz","vec4"),i.code.add(x`float evaluateAmbientOcclusion() {
return 1.0 - texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
}
float evaluateAmbientOcclusionInverse() {
float ssao = texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
return viewportPixelSz.z < 0.0 ? 1.0 : ssao;
}`)):i.code.add(x`float evaluateAmbientOcclusion() { return 0.0; }
float evaluateAmbientOcclusionInverse() { return 1.0; }`)}function r3(t,e){const i=t.fragment;t.include(mV),t.include($R,e),e.pbrMode!==0&&t.include(yR,e),t.include(Pne,e),e.receiveShadows&&t.include(Bd,e),i.uniforms.add("lightingGlobalFactor","float"),i.uniforms.add("ambientBoostFactor","float"),t.include($E),i.code.add(x`
    const float GAMMA_SRGB = 2.1;
    const float INV_GAMMA_SRGB = 0.4761904;
    ${e.pbrMode===0?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);"}
  `),i.code.add(x`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${e.viewingMode===1?x`normalize(vPosWorld)`:x`vec3(0.0, 0.0, 1.0)`}, lightingMainDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),i.code.add(x`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * lightingMainIntensity;
}`),e.pbrMode===0||e.pbrMode===4?i.code.add(x`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)
{
vec3 mainLighting = evaluateMainLighting(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`):e.pbrMode!==1&&e.pbrMode!==2||(i.code.add(x`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)
{
vec3 viewDirection = -viewDir;
vec3 mainLightDirection = lightingMainDirection;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);
inputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);
inputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),i.code.add(x`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),i.code.add(x`vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);
ambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = abs(dot(normal, ambientDir));
vec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * lightingMainIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),i.code.add(x`vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
vec3 mainLightRadianceComponent = normalDistribution(inputs.NdotH, inputs.roughness) * lightingMainIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = calculateAmbientRadiance(ssao) + additionalLight;
inputs.skyRadianceToSurface = ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;
inputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);`),i.code.add(x`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${e.pbrMode===2?x`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:x`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `))}function Hue(t,e){const i=t.fragment;i.code.add(x`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),e.doubleSidedMode===1?i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`):e.doubleSidedMode===2?i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`):i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`)}function Wue(t,e){const i=x`
  /*
  *  ${e.name}
  *  ${e.output===0?"RenderOutput: Color":e.output===1?"RenderOutput: Depth":e.output===3?"RenderOutput: Shadow":e.output===2?"RenderOutput: Normal":e.output===4?"RenderOutput: Highlight":""}
  */
  `;CE()&&(t.fragment.code.add(i),t.vertex.code.add(i))}function s3(t){t.include(yd),t.code.add(x`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${x.int(1)}) {
        return allMixed;
      }
      else if (mode == ${x.int(2)}) {
        return internalMixed;
      }
      else if (mode == ${x.int(3)}) {
        return externalColor;
      }
      else {
        // tint (or something invalid)
        float vIn = rgb2v(internalMixed);
        vec3 hsvTint = rgb2hsv(externalColor);
        vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
        return hsv2rgb(hsvOut);
      }
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${x.int(2)}) {
        return internalMixed;
      }
      else if (mode == ${x.int(3)}) {
        return externalOpacity;
      }
      else {
        // multiply or tint (or something invalid)
        return allMixed;
      }
    }
  `)}function PBe(t){const e=new pi,i=e.vertex.code,r=e.fragment.code;return e.include(Wue,{name:"Default Material Shader",output:t.output}),e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),e.include(AR),e.varyings.add("vpos","vec3"),e.include($b,t),e.include(i3,t),e.include(Dle,t),t.output!==0&&t.output!==7||(e.include(PR,t),e.include(Ss,{linearDepth:!1}),t.normalType===0&&t.offsetBackfaces&&e.include(Uue),e.include(que,t),e.include(rv,t),t.instancedColor&&e.attributes.add("instanceColor","vec4"),e.varyings.add("localvpos","vec3"),e.include(fd,t),e.include(QT,t),e.include(Bue,t),e.include(iv,t),e.vertex.uniforms.add("externalColor","vec4"),e.varyings.add("vcolorExt","vec4"),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),i.add(x`
      void main(void) {
        forwardNormalizedVertexColor();
        vcolorExt = externalColor;
        ${t.instancedColor?"vcolorExt *= instanceColor;":""}
        vcolorExt *= vvColor();
        vcolorExt *= getSymbolColor();
        forwardColorMixMode();

        if (vcolorExt.a < ${x.float(tn)}) {
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        }
        else {
          vpos = calculateVPos();
          localvpos = vpos - view[3].xyz;
          vpos = subtractOrigin(vpos);
          ${t.normalType===0?x`
          vNormalWorld = dpNormal(vvLocalNormal(normalModel()));`:""}
          vpos = addVerticalOffset(vpos, localOrigin);
          ${t.vertexTangents?"vTangent = dpTransformVertexTangent(tangent);":""}
          gl_Position = transformPosition(proj, view, vpos);
          ${t.normalType===0&&t.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, camPos);":""}
        }

        ${t.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        forwardLinearDepth();
        forwardTextureCoordinates();
      }
    `)),t.output===7&&(e.include(Zi,t),e.include(bm,t),t.multipassTerrainEnabled&&(e.fragment.include(Lr),e.include(ll,t)),e.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),e.fragment.include(s3),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        ${t.attributeColor?x`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        gl_FragColor = vec4(opacity_);
      }
    `)),t.output===0&&(e.include(Zi,t),e.include(r3,t),e.include($R,t),e.include(bm,t),t.receiveShadows&&e.include(Bd,t),t.multipassTerrainEnabled&&(e.fragment.include(Lr),e.include(ll,t)),e.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),e.include(W7,t),e.include(yR,t),e.fragment.include(s3),e.include(Hue,t),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        shadingParams.viewDirection = normalize(vpos - camPos);
        ${t.normalType===3?x`
        vec3 normal = screenDerivativeNormal(localvpos);`:x`
        shadingParams.normalView = vNormalWorld;
        vec3 normal = shadingNormal(shadingParams);`}
        ${t.pbrMode===1?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${t.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":t.viewingMode===1?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${t.attributeColor?x`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${t.hasNormalTexture?x`
              mat3 tangentSpace = ${t.vertexTangents?"computeTangentSpace(normal);":"computeTangentSpace(normal, vpos, vuv0);"}
              vec3 shadedNormal = computeTextureNormal(tangentSpace, vuv0);`:"vec3 shadedNormal = normal;"}
        ${t.pbrMode===1||t.pbrMode===2?t.viewingMode===1?x`vec3 normalGround = normalize(vpos + localOrigin);`:x`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:x``}
        ${t.pbrMode===1||t.pbrMode===2?x`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.include(Gue,t),e}const ABe=Object.freeze({__proto__:null,build:PBe});class n3 extends Si{initializeProgram(e){const i=n3.shader.get(),r=this.configuration,s=i.build({OITEnabled:r.transparencyPassType===0,output:r.output,viewingMode:e.viewingMode,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:r.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:r.symbolColors,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!0,instanced:r.instanced,instancedColor:r.instancedColor,instancedDoublePrecision:r.instancedDoublePrecision,pbrMode:r.usePBR?r.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:r.hasMetalnessAndRoughnessTexture,hasEmissionTexture:r.hasEmissionTexture,hasOcclusionTexture:r.hasOcclusionTexture,hasNormalTexture:r.hasNormalTexture,hasColorTexture:r.hasColorTexture,receiveAmbientOcclusion:r.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:r.normalsTypeDerivate?3:0,doubleSidedMode:r.doubleSidedMode,vertexTangents:r.vertexTangents,attributeTextureCoordinates:r.hasMetalnessAndRoughnessTexture||r.hasEmissionTexture||r.hasOcclusionTexture||r.hasNormalTexture||r.hasColorTexture?1:0,textureAlphaPremultiplied:r.textureAlphaPremultiplied,attributeColor:r.vertexColors,screenSizePerspectiveEnabled:r.screenSizePerspective,verticalOffsetEnabled:r.verticalOffset,offsetBackfaces:r.offsetBackfaces,doublePrecisionRequiresObfuscation:MR(e.rctx),alphaDiscardMode:r.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new fi(e.rctx,s,Ht)}bindPass(e,i){var r,s;Pc(this.program,i.camera.projectionMatrix);const n=this.configuration.output;(this.configuration.output===1||i.multipassTerrainEnabled||n===3)&&this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),wm(this.program,i)),n===7&&(this.program.setUniform1f("opacity",e.opacity),this.program.setUniform1f("layerOpacity",e.layerOpacity),this.program.setUniform4fv("externalColor",e.externalColor),this.program.setUniform1i("colorMixMode",WN[e.colorMixMode])),n===0?(i.lighting.setUniforms(this.program,!1),this.program.setUniform3fv("ambient",e.ambient),this.program.setUniform3fv("diffuse",e.diffuse),this.program.setUniform4fv("externalColor",e.externalColor),this.program.setUniform1i("colorMixMode",WN[e.colorMixMode]),this.program.setUniform1f("opacity",e.opacity),this.program.setUniform1f("layerOpacity",e.layerOpacity),this.configuration.usePBR&&Nue(this.program,e,this.configuration.isSchematic)):n===4&&Fd(this.program,i),TNe(this.program,e),YN(this.program,e,i),IT(e.screenSizePerspective,this.program,"screenSizePerspectiveAlignment"),e.textureAlphaMode!==2&&e.textureAlphaMode!==3||this.program.setUniform1f("textureAlphaCutoff",e.textureAlphaCutoff),(r=i.shadowMap)==null||r.bind(this.program),(s=i.ssaoHelper)==null||s.bind(this.program,i.camera)}bindDraw(e){const i=this.configuration.instancedDoublePrecision?De(e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]):e.origin;Nne(this.program,i,e.camera.viewMatrix),this.program.rebindTextures(),(this.configuration.output===0||this.configuration.output===7||this.configuration.output===1&&this.configuration.screenSizePerspective||this.configuration.output===2&&this.configuration.screenSizePerspective||this.configuration.output===4&&this.configuration.screenSizePerspective)&&Qf(this.program,i,e.camera.viewInverseTransposeMatrix),this.configuration.output===2&&this.program.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),this.configuration.instancedDoublePrecision&&i3.bindCustomOrigin(this.program,i),Ab(this.program,this.configuration,e.slicePlane,i),this.configuration.output===0&&Eje(this.program,e,i)}setPipeline(e,i){const r=this.configuration,s=e===3,n=e===2;return _t({blending:r.output!==0&&r.output!==7||!r.transparent?null:s?qu:xm(e),culling:$Be(r)&&PE(r.cullFace),depthTest:{func:U0(e)},depthWrite:s||n?r.writeDepth&&$o:null,colorWrite:Pt,stencilWrite:r.sceneHasOcludees?$m:null,stencilTest:r.sceneHasOcludees?i?kb:Q0:null,polygonOffset:s||n?null:ZO(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipeline(this.configuration.transparencyPassType,!0),this.setPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,i){return i?this._occludeePipelineState:super.getPipelineState(e,i)}}function $Be(t){return t.cullFace?t.cullFace!==0:!t.slicePlaneEnabled&&!t.transparent&&!t.doubleSidedMode}n3.shader=new vi(ABe,()=>import("./DefaultMaterial.glsl.98ef795b.js"));class Gt extends tr{constructor(){super(...arguments),this.output=0,this.alphaDiscardMode=1,this.doubleSidedMode=0,this.isSchematic=!1,this.vertexColors=!1,this.offsetBackfaces=!1,this.symbolColors=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.sliceHighlightDisabled=!1,this.receiveAmbientOcclusion=!1,this.screenSizePerspective=!1,this.textureAlphaPremultiplied=!1,this.hasColorTexture=!1,this.usePBR=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.instanced=!1,this.instancedColor=!1,this.instancedDoublePrecision=!1,this.vertexTangents=!1,this.normalsTypeDerivate=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparent=!1,this.enableOffset=!0,this.cullFace=0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([X({count:8})],Gt.prototype,"output",void 0),u([X({count:4})],Gt.prototype,"alphaDiscardMode",void 0),u([X({count:3})],Gt.prototype,"doubleSidedMode",void 0),u([X()],Gt.prototype,"isSchematic",void 0),u([X()],Gt.prototype,"vertexColors",void 0),u([X()],Gt.prototype,"offsetBackfaces",void 0),u([X()],Gt.prototype,"symbolColors",void 0),u([X()],Gt.prototype,"vvSize",void 0),u([X()],Gt.prototype,"vvColor",void 0),u([X()],Gt.prototype,"verticalOffset",void 0),u([X()],Gt.prototype,"receiveShadows",void 0),u([X()],Gt.prototype,"slicePlaneEnabled",void 0),u([X()],Gt.prototype,"sliceHighlightDisabled",void 0),u([X()],Gt.prototype,"receiveAmbientOcclusion",void 0),u([X()],Gt.prototype,"screenSizePerspective",void 0),u([X()],Gt.prototype,"textureAlphaPremultiplied",void 0),u([X()],Gt.prototype,"hasColorTexture",void 0),u([X()],Gt.prototype,"usePBR",void 0),u([X()],Gt.prototype,"hasMetalnessAndRoughnessTexture",void 0),u([X()],Gt.prototype,"hasEmissionTexture",void 0),u([X()],Gt.prototype,"hasOcclusionTexture",void 0),u([X()],Gt.prototype,"hasNormalTexture",void 0),u([X()],Gt.prototype,"instanced",void 0),u([X()],Gt.prototype,"instancedColor",void 0),u([X()],Gt.prototype,"instancedDoublePrecision",void 0),u([X()],Gt.prototype,"vertexTangents",void 0),u([X()],Gt.prototype,"normalsTypeDerivate",void 0),u([X()],Gt.prototype,"writeDepth",void 0),u([X()],Gt.prototype,"sceneHasOcludees",void 0),u([X()],Gt.prototype,"transparent",void 0),u([X()],Gt.prototype,"enableOffset",void 0),u([X({count:3})],Gt.prototype,"cullFace",void 0),u([X({count:4})],Gt.prototype,"transparencyPassType",void 0),u([X()],Gt.prototype,"multipassTerrainEnabled",void 0),u([X()],Gt.prototype,"cullAboveGround",void 0);function EBe(t){const e=new pi,i=e.vertex.code,r=e.fragment.code;return e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),e.include(AR),e.varyings.add("vpos","vec3"),e.include($b,t),e.include(i3,t),e.include(Dle,t),t.output!==0&&t.output!==7||(e.include(PR,t),e.include(Ss,{linearDepth:!1}),t.offsetBackfaces&&e.include(Uue),t.instancedColor&&e.attributes.add("instanceColor","vec4"),e.varyings.add("vNormalWorld","vec3"),e.varyings.add("localvpos","vec3"),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),e.include(fd,t),e.include(QT,t),e.include(Bue,t),e.include(iv,t),e.vertex.uniforms.add("externalColor","vec4"),e.varyings.add("vcolorExt","vec4"),i.add(x`
        void main(void) {
          forwardNormalizedVertexColor();
          vcolorExt = externalColor;
          ${t.instancedColor?"vcolorExt *= instanceColor;":""}
          vcolorExt *= vvColor();
          vcolorExt *= getSymbolColor();
          forwardColorMixMode();

          if (vcolorExt.a < ${x.float(tn)}) {
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          }
          else {
            vpos = calculateVPos();
            localvpos = vpos - view[3].xyz;
            vpos = subtractOrigin(vpos);
            vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            ${t.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, camPos);":""}
          }
          ${t.multipassTerrainEnabled?x`depth = (view * vec4(vpos, 1.0)).z;`:""}
          forwardLinearDepth();
          forwardTextureCoordinates();
        }
      `)),t.output===7&&(e.include(Zi,t),e.include(bm,t),t.multipassTerrainEnabled&&(e.fragment.include(Lr),e.include(ll,t)),e.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),e.fragment.uniforms.add("view","mat4"),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),e.fragment.include(s3),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        ${t.attributeColor?x`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}

        gl_FragColor = vec4(opacity_);
      }
    `)),t.output===0&&(e.include(Zi,t),e.include(r3,t),e.include($R,t),e.include(bm,t),t.receiveShadows&&e.include(Bd,t),t.multipassTerrainEnabled&&(e.fragment.include(Lr),e.include(ll,t)),e.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),e.fragment.uniforms.add("view","mat4"),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),e.include(W7,t),e.include(yR,t),e.fragment.include(s3),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        vec3 viewDirection = normalize(vpos - camPos);
        ${t.pbrMode===1?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${t.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":t.viewingMode===1?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${t.attributeColor?x`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${x`
        vec3 shadedNormal = normalize(vNormalWorld);
        albedo_ *= 1.2;
        vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
        float alignmentLightView = clamp(dot(viewForward, -lightingMainDirection), 0.0, 1.0);
        float transmittance = 1.0 - clamp(dot(viewForward, shadedNormal), 0.0, 1.0);
        float treeRadialFalloff = vColor.r;
        float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
        additionalLight += backLightFactor * lightingMainIntensity;`}
        ${t.pbrMode===1||t.pbrMode===2?t.viewingMode===1?x`vec3 normalGround = normalize(vpos + localOrigin);`:x`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:x``}
        ${t.pbrMode===1||t.pbrMode===2?x`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.include(Gue,t),e}const OBe=Object.freeze({__proto__:null,build:EBe});class ER extends n3{initializeProgram(e){const i=ER.shader.get(),r=this.configuration,s=i.build({OITEnabled:r.transparencyPassType===0,output:r.output,viewingMode:e.viewingMode,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:r.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:r.symbolColors,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!0,instanced:r.instanced,instancedColor:r.instancedColor,instancedDoublePrecision:r.instancedDoublePrecision,pbrMode:r.usePBR?1:0,hasMetalnessAndRoughnessTexture:!1,hasEmissionTexture:!1,hasOcclusionTexture:!1,hasNormalTexture:!1,hasColorTexture:r.hasColorTexture,receiveAmbientOcclusion:r.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:0,doubleSidedMode:2,vertexTangents:!1,attributeTextureCoordinates:r.hasColorTexture?1:0,textureAlphaPremultiplied:r.textureAlphaPremultiplied,attributeColor:r.vertexColors,screenSizePerspectiveEnabled:r.screenSizePerspective,verticalOffsetEnabled:r.verticalOffset,offsetBackfaces:r.offsetBackfaces,doublePrecisionRequiresObfuscation:MR(e.rctx),alphaDiscardMode:r.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new fi(e.rctx,s,Ht)}}ER.shader=new vi(OBe,()=>import("./RealisticTree.glsl.d5e57db4.js"));class sv extends Id{constructor(e){super(e,IBe),this.supportsEdges=!0,this.techniqueConfig=new Gt,this.vertexBufferLayout=FBe(this.parameters),this.instanceBufferLayout=e.instanced?Zue(this.parameters):null}isVisibleInPass(e){return e!==4&&e!==6&&e!==7||this.parameters.castShadows}isVisible(){const e=this.parameters;if(!super.isVisible()||e.layerOpacity===0)return!1;const i=e.instanced,r=e.vertexColors,s=e.symbolColors,n=!!i&&i.indexOf("color")>-1,o=e.vvColorEnabled,a=e.colorMixMode==="replace",l=e.opacity>0,c=e.externalColor&&e.externalColor[3]>0;return r&&(n||o||s)?!!a||l:r?a?c:l:n||o||s?!!a||l:a?c:l}getTechniqueConfig(e,i){return this.techniqueConfig.output=e,this.techniqueConfig.hasNormalTexture=!!this.parameters.normalTextureId,this.techniqueConfig.hasColorTexture=!!this.parameters.textureId,this.techniqueConfig.vertexTangents=this.parameters.vertexTangents,this.techniqueConfig.instanced=!!this.parameters.instanced,this.techniqueConfig.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.verticalOffset=this.parameters.verticalOffset!==null,this.techniqueConfig.screenSizePerspective=this.parameters.screenSizePerspective!==null,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sliceHighlightDisabled=this.parameters.sliceHighlightDisabled,this.techniqueConfig.alphaDiscardMode=this.parameters.textureAlphaMode,this.techniqueConfig.normalsTypeDerivate=this.parameters.normals==="screenDerivative",this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.cullFace=this.parameters.slicePlaneEnabled?0:this.parameters.cullFace,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,e!==0&&e!==7||(this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.symbolColors=this.parameters.symbolColors,this.parameters.treeRendering?this.techniqueConfig.doubleSidedMode=2:this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?1:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?2:0,this.techniqueConfig.instancedColor=!!this.parameters.instanced&&this.parameters.instanced.indexOf("color")>-1,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=!!i.ssaoEnabled&&this.parameters.receiveSSAO,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this.techniqueConfig.usePBR=this.parameters.usePBR,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.parameters.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this.techniqueConfig.isSchematic=this.parameters.usePBR&&this.parameters.isSchematic,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<HO),this.techniqueConfig}intersect(e,i,r,s,n,o,a){if(this.parameters.verticalOffset!==null){const l=s.camera;ne(J7,r[12],r[13],r[14]);let c=null;switch(s.viewingMode){case 1:c=_e(Jue,J7);break;case 2:c=re(Jue,zBe)}let h=0;if(this.parameters.verticalOffset!==null){const p=ue(VBe,J7,l.eye),f=Te(p),g=se(p,p,1/f);let y=null;this.parameters.screenSizePerspective&&(y=ye(c,g)),h+=Tle(l,f,this.parameters.verticalOffset,y,this.parameters.screenSizePerspective)}se(c,c,h),fo(Z7,c,s.transform.inverseRotation),n=ue(LBe,n,Z7),o=ue(kBe,o,Z7)}NO(e,i,s,n,o,WV(s.verticalOffset),a)}requiresSlot(e){return e===(this.parameters.transparent?this.parameters.writeDepth?4:7:2)||e===20}createGLMaterial(e){return e.output===0||e.output===7||e.output===1||e.output===2||e.output===3||e.output===4?new RBe(e):null}createBufferWriter(){return new DBe(this.vertexBufferLayout,this.instanceBufferLayout)}}class RBe extends vle{constructor(e){super(E(E({},e),e.material.parameters))}updateParameters(e){const i=this._material.parameters;return this.updateTexture(i.textureId),this.ensureTechnique(i.treeRendering?ER:n3,e)}_updateShadowState(e){e.shadowMappingEnabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMappingEnabled})}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==0&&this._output!==7||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)}bind(e,i){i.bindPass(this._material.parameters,e),this.bindTextures(i.program)}}const IBe=E({textureId:void 0,initTextureTransparent:!1,isSchematic:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],mrrFactors:[0,1,.5],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:2,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,receiveShadows:!0,castShadows:!0,shadowMappingEnabled:!1,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,sliceHighlightDisabled:!1,offsetTransparentBackfaces:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:Ai(),transparent:!1,writeDepth:!0,textureAlphaMode:0,textureAlphaCutoff:GO,textureAlphaPremultiplied:!1,sceneHasOcludees:!1},Gu);class DBe{constructor(e,i){this.vertexBufferLayout=e,this.instanceBufferLayout=i}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,i,r,s){BO(i,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,s)}}function FBe(t){const e=t.textureId||t.normalTextureId||t.metallicRoughnessTextureId||t.emissiveTextureId||t.occlusionTextureId,i=zr().vec3f("position").vec3f("normal");return t.vertexTangents&&i.vec4f("tangent"),e&&i.vec2f("uv0"),t.vertexColors&&i.vec4u8("color"),t.symbolColors&&i.vec4u8("symbolColor"),i}function Zue(t){let e=zr();return e=t.instancedDoublePrecision?e.vec3f("modelOriginHi").vec3f("modelOriginLo").mat3f("model").mat3f("modelNormal"):e.mat4f("model").mat4f("modelNormal"),t.instanced&&t.instanced.indexOf("color")>-1&&(e=e.vec4f("instanceColor")),t.instanced&&t.instanced.indexOf("featureAttribute")>-1&&(e=e.vec4f("instanceFeatureAttribute")),e}const LBe=$(),kBe=$(),zBe=De(0,0,1),Jue=$(),Z7=$(),J7=$(),VBe=$(),NBe=["polygon","extent"];class UBe extends Zu{constructor(e,i,r,s){super(e,i,r,s),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const a=QO(this._getSymbolSize());if(a)throw new Q("graphics3dextrudesymbollayer:invalid-size",a)}const e=or(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(e),r=Dn(i),s=i[3],n=s<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:r,ambient:r,opacity:s,transparent:n,cullFace:n?0:2,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new sv(o),this._bottomMaterial=new sv(he(E({},o),{cullFace:2})),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(e){const i=e.graphic;if(!this._validateGeometry(i.geometry,NBe,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(i,new ma);return this._createAs3DShape(i,e.renderingInfo,r,s,i.uid)}layerOpacityChanged(e,i){const r=or(this.symbolLayer,"material","color"),s=this._getCombinedOpacity(r),n=s<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:s,transparent:n}),this._bottomMaterial.setParameters({opacity:s,transparent:n});const o=this._getLayerOpacity();return e.forEach(a=>{const l=i(a);_(l)&&l.layerOpacityChanged(o,this._context.isAsync)}),!0}layerElevationInfoChanged(e,i){return this.updateGraphics3DGraphicElevationInfo(e,i,Cm)}slicePlaneEnabledChanged(e,i){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach(r=>{const s=i(r);_(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}_getExtrusionSize(e){let i;var r;return e.size&&this._drivenProperties.size?i=(r=VUe(e.size,2))!=null?r:0:i=this._getSymbolSize(),i/=this._context.renderCoordsHelper.unitInMeters,i}applyRendererDiff(){return 1}_getSymbolSize(){var e;return(e=this.symbolLayer.size)!=null?e:1}_createAs3DShape(e,i,r,s,n){const o=t3(e.geometry);if(A(o))return null;const a=G7(o,this._context.elevationProvider,this._context.renderCoordsHelper,s);if(this._logGeometryCreationWarnings(a,o.rings,"rings","ExtrudeSymbol3DLayer"),o.rings.length===0||!o.rings.some(q=>q.length>0))return null;const l=l7(o);if(A(l))return null;const c=new Array,h=new Array,p=new Array,f=lr(),g=be(),y=$(),v=this._context.renderCoordsHelper.viewingMode===1;v||this._context.renderCoordsHelper.worldUpAtPosition(null,y),rc(o.spatialReference,[l.x,l.y,0],g,this._context.renderCoordsHelper.spatialReference);const b=be();Fi(b,g);const w=Ai();X_(w,b);const{polygons:S,mapPosition:T,position:C}=a,M=C.length/3,P=new Float64Array(3*M*6),F=new Float64Array(3*M*6),z=new Float64Array(3*M*6),D=new Float64Array(1*M*6);let U=0;for(let q=0;q<S.length;++q){const J=S[q],O=J.count;if(this._context.clippingExtent&&(ii(f),Ql(f,J.mapPosition),!Xl(f,this._context.clippingExtent)))continue;const L=Lb(J.mapPosition,J.holeIndices,3);if(L.length===0)continue;const N=3*O*2+L.length,B=new Uint32Array(N),W=new Uint32Array(L.length),Y=6*O,H=3*P.BYTES_PER_ELEMENT,K=new ir(P.buffer,U*H,H,(U+Y)*H),fe=3*F.BYTES_PER_ELEMENT,ce=new ir(F.buffer,U*fe,fe,(U+Y)*fe),me=new Float64Array(z.buffer,3*U*z.BYTES_PER_ELEMENT,3*Y),Ie=new Float64Array(D.buffer,1*U*D.BYTES_PER_ELEMENT,1*Y),He=this._getExtrusionSize(i);jBe(C,T,L,J,K.typedBuffer,me,ce.typedBuffer,Ie,0,B,W,He,y,v),qT(K,K,b),H0(ce,ce,w),U+=6*O;const $e=this._createExtrudeGeometry(B,B.length-W.length,{positions:K.typedBuffer,elevation:me,normals:ce.typedBuffer,heights:Ie},r);c.push($e),h.push(this._material),p.push(Dr);const Le=this._createExtrudeGeometry(W,0,{positions:K.typedBuffer,elevation:me,normals:ce.typedBuffer,heights:Ie},r);c.push(Le),h.push(this._bottomMaterial),p.push(Dr)}if(c.length===0)return null;const G=new Nd({geometries:c,materials:h,transformations:p,metadata:{layerUid:this._context.layer.uid,graphicUid:n,isElevationSource:!0}});G.transformation=g;const k=_ce(this.symbolLayer,{opacity:this._getLayerOpacity()}),j=_(k)?{baseMaterial:this._material,edgeMaterials:[k],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,V=new Wu(this,G,c,null,null,qBe,s,j);return V.alignedSampledElevation=a.sampledElevation,V.needsElevationUpdates=Cm(s.mode),V}_createExtrudeGeometry(e,i,r,s){const n=new Uint32Array(e.length),o=[["position",{size:3,data:r.positions,exclusive:!0}],["normal",{size:3,data:r.normals,exclusive:!0}],["color",{size:4,data:s,exclusive:!0}],["size",{size:1,data:r.heights,exclusive:!0}]],a=[["position",e],["normal",e],["color",n]];return r.elevation&&(o.push(["mapPos",{size:3,data:r.elevation}]),a.push(["mapPos",e])),new zi(o,a,0,i)}}function jBe(t,e,i,r,s,n,o,a,l,c,h,p,f,g){const y=i.length/3;let v=0,b=2*r.count;BBe(t,e,r.index,r.count,i,0,y,s,n,o,a,l,c,h,b,p,f,g),l+=2*r.count,b=0,Que(s,n,a,o,v,r.pathLengths[0],r.count,l,c,b,p),l+=4*r.pathLengths[0],b+=2*r.pathLengths[0],v+=r.pathLengths[0];for(let w=1;w<r.pathLengths.length;++w)Que(s,n,a,o,v,r.pathLengths[w],r.count,l,c,b,p),l+=4*r.pathLengths[w],b+=2*r.pathLengths[w],v+=r.pathLengths[w]}function BBe(t,e,i,r,s,n,o,a,l,c,h,p,f,g,y,v,b,w){re(to,b);const S=v>0?1:-1;let T=3*i,C=p,M=3*C,P=p+r,F=3*P;for(let U=0;U<r;++U)w&&(to[0]=t[T+0],to[1]=t[T+1],to[2]=t[T+2],_e(to,to)),a[M+0]=t[T+0],a[M+1]=t[T+1],a[M+2]=t[T+2],l[M+0]=e[T+0],l[M+1]=e[T+1],l[M+2]=e[T+2],c[M+0]=-S*to[0],c[M+1]=-S*to[1],c[M+2]=-S*to[2],h[C]=0,a[F+0]=t[T+0]+v*to[0],a[F+1]=t[T+1]+v*to[1],a[F+2]=t[T+2]+v*to[2],l[F+0]=e[T+0],l[F+1]=e[T+1],l[F+2]=e[T+2],c[F+0]=S*to[0],c[F+1]=S*to[1],c[F+2]=S*to[2],h[P]=v,M+=3,F+=3,T+=3,C+=1,P+=1;T=3*n,M=0,F=3*y;const z=v<0?ihe:the,D=v<0?the:ihe;for(let U=0;U<o;++U)g[M+0]=s[T+z[0]],g[M+1]=s[T+z[1]],g[M+2]=s[T+z[2]],f[F+0]=s[T+D[0]]+r,f[F+1]=s[T+D[1]]+r,f[F+2]=s[T+D[2]]+r,M+=3,F+=3,T+=3}function OR(t,e,i,r,s,n,o){r[n]=r[o],o*=3,t[(n*=3)+0]=t[o+0],t[n+1]=t[o+1],t[n+2]=t[o+2],e[n+0]=e[o+0],e[n+1]=e[o+1],e[n+2]=e[o+2],i[n+0]=s[0],i[n+1]=s[1],i[n+2]=s[2]}const o3=$();function Que(t,e,i,r,s,n,o,a,l,c,h){let p=s,f=s+1,g=s+o,y=s+o+1,v=a,b=a+1,w=a+2*n,S=a+2*n+1;h<0&&(p=s+o+1,y=s),c*=3;for(let T=0;T<n;++T)T===n-1&&(h>0?(f=s,y=s+o):(f=s,p=s+o)),GBe(t,p,f,g,o3),OR(t,e,r,i,o3,v,p),OR(t,e,r,i,o3,b,f),OR(t,e,r,i,o3,w,g),OR(t,e,r,i,o3,S,y),l[c++]=v,l[c++]=w,l[c++]=S,l[c++]=v,l[c++]=S,l[c++]=b,p++,f++,g++,y++,v+=2,b+=2,w+=2,S+=2}const Q7=$(),Yue=$(),Xue=$(),Kue=$(),ehe=$();function GBe(t,e,i,r,s){e*=3,i*=3,r*=3,ne(Q7,t[e++],t[e++],t[e++]),ne(Yue,t[i++],t[i++],t[i++]),ne(Xue,t[r++],t[r++],t[r++]),ue(Kue,Yue,Q7),ue(ehe,Xue,Q7),Ye(s,ehe,Kue),_e(s,s)}const Ub=$();function qBe(t,e,i,r){const s=t.stageObject,n=s.geometryRecords,o=n.length,a=e.mode!=="absolute-height";let l=0;const c=s.transformation,h=Fi(be(),c);for(let p=0;p<o;p+=2){const f=n[p].geometry,g=f.getMutableAttribute("position").data,y=f.vertexAttributes.get("size").data,v=f.vertexAttributes.get("mapPos").data,b=new Are(v),w=g.length/3;let S=0,T=!1,C=0;const M=i.spatialReference;for(let P=0;P<w;P++){Ub[0]=g[S],Ub[1]=g[S+1],Ub[2]=g[S+2],kd(b,i,e,r,RR),a&&(C+=RR.sampledElevation),Kt.TESTS_DISABLE_OPTIMIZATIONS?(ne(Io,b.array[b.offset+0],b.array[b.offset+1],RR.z+y[S/3]),r.toRenderCoords(Io,M,Io),Oe(Io,Io,h)):(ne(Io,g[S+0],g[S+1],g[S+2]),Oe(Io,Io,c),r.setAltitude(Io,RR.z+y[S/3]),Oe(Io,Io,h)),g[S]=Io[0],g[S+1]=Io[1],g[S+2]=Io[2];const F=HBe/r.unitInMeters;(Math.abs(Ub[0]-g[S])>=F||Math.abs(Ub[1]-g[S+1])>=F||Math.abs(Ub[2]-g[S+2])>=F)&&(T=!0),b.offset+=3,S+=3}T&&(f.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(n[p]),n[p+1].geometry.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(n[p+1])),l+=C/w}return l/o}const Io=$(),to=$(),RR=new UT,the=[0,2,1],ihe=[0,1,2],HBe=.01;function WBe(t,e,i,r,s){const n=t.referencesGeometry()&&s?ZBe(e,r,s):e,o=t.repurposeFeature(n);try{return t.evaluate(he(E({},i),{$feature:o}))}catch(a){return le.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}const Y7=new Map;function ZBe(t,e,i){const{transform:r,hasZ:s,hasM:n}=i;Y7.has(e)||Y7.set(e,JBe(e));const o=Y7.get(e)(t.geometry,r,s,n);return he(E({},t),{geometry:o})}function JBe(t){const e={};switch(t){case"esriGeometryPoint":return(i,r,s,n)=>Jle(r,e,i,s,n);case"esriGeometryPolygon":return(i,r,s,n)=>Qle(r,e,i,s,n);case"esriGeometryPolyline":return(i,r,s,n)=>Yle(r,e,i,s,n);case"esriGeometryMultipoint":return(i,r,s,n)=>Zle(r,e,i,s,n);default:return le.getLogger("esri.views.2d.support.arcadeOnDemand").error(new Q("mapview-arcade",`Unable to handle geometryType: ${t}`)),i=>i}}const kat=1.2,QBe=I1,YBe=wu;class IR{constructor(e,i,r){this.graphics3DSymbolLayer=e,this.renderGeometries=i,this.boundingBox=r,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._layerView=null,this.isElevationSource=!1}initialize(e,i,r){this.stage=e,this._layerView=r,this._overlayRenderer=this._layerView.view.basemapTerrain.overlayManager.renderer}setVisibility(e){if(this.stage!=null&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._layerView,1);if(e||this._addedToStage){for(const i of this.renderGeometries)i.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._layerView,1)}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._layerView,4),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=$()){return ne(e,0,0,0)}getBoundingBoxObjectSpace(e=lr()){return ii(e)}addObjectState(e,i){e===0&&(this.renderGeometries.forEach(r=>{const s=r.addHighlight();i.addRenderGeometry(r,s,this)}),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView))}removeObjectState(e){this.renderGeometries.forEach(i=>{e.removeRenderGeometry(i)})}removeRenderGeometryObjectState(e,i){e.removeHighlight(i),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView)}computeAttachmentOrigin(e){for(const i of this.renderGeometries)i.computeAttachmentOrigin(jb)&&(e.draped.origin[0]+=jb[0],e.draped.origin[1]+=jb[1],e.draped.num++)}async getProjectedBoundingBox(e,i,r,s,n){ii(n);for(let o=0;o<this.renderGeometries.length;o++){const a=this.renderGeometries[o];this._getRenderGeometryProjectedBoundingRect(a,e,rhe,r),txe(n,rhe)}if(i){let o;Yl(n,jb);const a=c7(n,i);try{o=await i.service.queryElevation(jb[0],jb[1],s,a,"ground")}catch{}_(o)&&(n[2]=Math.min(n[2],o),n[5]=Math.max(n[5],o))}return n}_getRenderGeometryProjectedBoundingRect(e,i,r,s){if(this.boundingBox)fP(Xu,this.boundingBox);else{const n=e.boundingSphere,o=n[3];Xu[0]=n[0]-o,Xu[1]=n[1]-o,Xu[2]=n[2]-o,Xu[3]=n[0]+o,Xu[4]=n[1]+o,Xu[5]=n[2]+o}return i(Xu,0,2),this.calculateRelativeScreenBounds&&s.push({location:Yl(Xu),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),rL(Xu,r)}}const rhe=pt(),Xu=lr(),jb=$();function XBe(t,e){const i=t,r=new Uint8Array(4*i*i),s=i/2-.5,n=e/2;for(let o=0;o<i;o++)for(let a=0;a<i;a++){const l=a+i*o,c=a-s,h=o-s;let p=Math.sqrt(c*c+h*h)-n;p=p/t+.5,ev(p,r,4*l)}return r}function KBe(t,e){return she(t,e,!1)}function eGe(t,e){return she(t,e,!0)}function tGe(t,e){return nhe(t,e,!1)}function iGe(t,e){return nhe(t,e,!0)}function rGe(t,e){const i=new Uint8Array(4*t*t),r=1,s=-.5,n=Math.sqrt(r*r+s*s),o=(t-e)/2;for(let a=0;a<t;a++)for(let l=0;l<t;l++){const c=a*t+l,h=(l-o)/e,p=(a-o+.75)/e,f=-(r*h+s*p)/n,g=(r*(h-1)+s*-p)/n,y=-p,v=Math.max(f,g,y);ev(v*e/t+.5,i,4*c)}return i}function she(t,e,i){i&&(e/=Math.SQRT2);const r=new Uint8Array(4*t*t);for(let s=0;s<t;s++)for(let n=0;n<t;n++){let o=n-.5*t+.25,a=.5*t-s-.75;const l=s*t+n;if(i){const h=(o+a)/Math.SQRT2;a=(a-o)/Math.SQRT2,o=h}let c=Math.max(Math.abs(o),Math.abs(a))-.5*e;c=c/t+.5,ev(c,r,4*l)}return r}function nhe(t,e,i){i&&(e*=Math.SQRT2);const r=.5*e,s=new Uint8Array(4*t*t);for(let n=0;n<t;n++)for(let o=0;o<t;o++){let a=o-.5*t,l=.5*t-n-1;const c=n*t+o;if(i){const p=(a+l)/Math.SQRT2;l=(l-a)/Math.SQRT2,a=p}let h;a=Math.abs(a),l=Math.abs(l),h=a>l?a>r?Math.sqrt((a-r)*(a-r)+l*l):l:l>r?Math.sqrt(a*a+(l-r)*(l-r)):a,h=h/t+.5,ev(h,s,4*c)}return s}function a3(t){return t!=null}function Bb(t){return typeof t=="number"}function DR(t){return typeof t=="string"}function sGe(t){return t==null||DR(t)}function Cr(t,e){t&&t.push(e)}function nGe(t,e,i,r=be()){const s=t||0,n=e||0,o=i||0;return s!==0&&ly(r,r,-s/180*Math.PI),n!==0&&$1(r,r,n/180*Math.PI),o!==0&&zP(r,r,o/180*Math.PI),r}function Om(t,e,i,r,s){const n=t.minSize,o=t.maxSize;if(t.expression)return Cr(s,"Could not convert size info: expression not supported"),!1;if(t.useSymbolValue){const a=r.symbolSize[i];return e.minSize[i]=a,e.maxSize[i]=a,e.offset[i]=e.minSize[i],e.factor[i]=0,e.type[i]=1,!0}if(a3(t.field))return a3(t.stops)?t.stops.length===2&&Bb(t.stops[0].size)&&Bb(t.stops[1].size)?(ohe(t.stops[0].size,t.stops[1].size,t.stops[0].value,t.stops[1].value,e,i),e.type[i]=1,!0):(Cr(s,"Could not convert size info: stops only supported with 2 elements"),!1):Bb(n)&&Bb(o)&&a3(t.minDataValue)&&a3(t.maxDataValue)?(ohe(n,o,t.minDataValue,t.maxDataValue,e,i),e.type[i]=1,!0):x_[t.valueUnit]!=null?(e.minSize[i]=-1/0,e.maxSize[i]=1/0,e.offset[i]=0,e.factor[i]=1/x_[t.valueUnit],e.type[i]=1,!0):t.valueUnit==="unknown"?(Cr(s,"Could not convert size info: proportional size not supported"),!1):(Cr(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!a3(t.field)){if(t.stops&&t.stops[0]&&Bb(t.stops[0].size))return e.minSize[i]=t.stops[0].size,e.maxSize[i]=t.stops[0].size,e.offset[i]=e.minSize[i],e.factor[i]=0,e.type[i]=1,!0;if(Bb(n))return e.minSize[i]=n,e.maxSize[i]=n,e.offset[i]=n,e.factor[i]=0,e.type[i]=1,!0}return Cr(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function ohe(t,e,i,r,s,n){const o=Math.abs(r-i)>0?(e-t)/(r-i):0;s.minSize[n]=o>0?t:e,s.maxSize[n]=o>0?e:t,s.offset[n]=t-i*o,s.factor[n]=o}function oGe(t,e,i,r){if(t.normalizationField||t.valueRepresentation)return Cr(r,"Could not convert size info: unsupported property"),null;if(!sGe(t.field))return Cr(r,"Could not convert size info: field is not a string"),null;if(e.size){if(t.field)if(e.size.field){if(t.field!==e.size.field)return Cr(r,"Could not convert size info: multiple fields in use"),null}else e.size.field=t.field}else e.size={field:t.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[0,0,0]};let s;switch(t.axis){case"width":return s=Om(t,e.size,0,i,r),s?e:null;case"height":return s=Om(t,e.size,2,i,r),s?e:null;case"depth":return s=Om(t,e.size,1,i,r),s?e:null;case"width-and-depth":return s=Om(t,e.size,0,i,r),s&&Om(t,e.size,1,i,r),s?e:null;case null:case void 0:case"all":return s=Om(t,e.size,0,i,r),s=s&&Om(t,e.size,1,i,r),s=s&&Om(t,e.size,2,i,r),s?e:null;default:return Cr(r,`Could not convert size info: unknown axis "${t.axis}""`),null}}function aGe(t,e,i){for(let s=0;s<3;++s){let n=e.unitInMeters;t.type[s]===1&&(n*=e.modelSize[s],t.type[s]=2),t.minSize[s]=t.minSize[s]/n,t.maxSize[s]=t.maxSize[s]/n,t.offset[s]=t.offset[s]/n,t.factor[s]=t.factor[s]/n}let r;if(t.type[0]!==0)r=0;else if(t.type[1]!==0)r=1;else{if(t.type[2]===0)return Cr(i,"No size axis contains a valid size or scale"),!1;r=2}for(let s=0;s<3;++s)t.type[s]===0&&(t.minSize[s]=t.minSize[r],t.maxSize[s]=t.maxSize[r],t.offset[s]=t.offset[r],t.factor[s]=t.factor[r],t.type[s]=t.type[r]);return!0}function ahe(t,e,i){t[4*e+0]=i.r/255,t[4*e+1]=i.g/255,t[4*e+2]=i.b/255,t[4*e+3]=i.a}function lGe(t,e,i){if(t.normalizationField)return Cr(i,"Could not convert color info: unsupported property"),null;if(DR(t.field)){if(!t.stops)return Cr(i,"Could not convert color info: missing stops or colors"),null;{if(t.stops.length>8)return Cr(i,"Could not convert color info: too many color stops"),null;e.color={field:t.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const r=t.stops;for(let s=0;s<8;++s){const n=r[Math.min(s,r.length-1)];e.color.values[s]=n.value,ahe(e.color.colors,s,n.color)}}}else{if(!(t.stops&&t.stops.length>=0))return Cr(i,"Could not convert color info: no field and no colors/stops"),null;{const r=t.stops&&t.stops.length>=0&&t.stops[0].color;e.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)e.color.values[s]=1/0,ahe(e.color.colors,s,r)}}return e}function cGe(t,e,i){if(t.normalizationField)return Cr(i,"Could not convert opacity info: unsupported property"),null;if(DR(t.field)){if(!t.stops)return Cr(i,"Could not convert opacity info: missing stops or opacities"),null;{if(t.stops.length>8)return Cr(i,"Could not convert opacity info: too many opacity stops"),null;e.opacity={field:t.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const r=t.stops;for(let s=0;s<8;++s){const n=r[Math.min(s,r.length-1)];e.opacity.values[s]=n.value,e.opacity.opacityValues[s]=n.opacity}}}else{if(!(t.stops&&t.stops.length>=0))return Cr(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const r=t.stops&&t.stops.length>=0&&t.stops[0].opacity;e.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)e.opacity.values[s]=1/0,e.opacity.opacityValues[s]=r}}return e}function X7(t,e,i){const r=i===2&&t.rotationType==="arithmetic";e.offset[i]=r?90:0,e.factor[i]=r?-1:1,e.type[i]=1}function uGe(t,e,i){if(!DR(t.field))return Cr(i,"Could not convert rotation info: field is not a string"),null;if(e.rotation){if(t.field)if(e.rotation.field){if(t.field!==e.rotation.field)return Cr(i,"Could not convert rotation info: multiple fields in use"),null}else e.rotation.field=t.field}else e.rotation={field:t.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(t.axis){case"tilt":return X7(t,e.rotation,0),e;case"roll":return X7(t,e.rotation,1),e;case null:case void 0:case"heading":return X7(t,e.rotation,2),e;default:return Cr(i,`Could not convert rotation info: unknown axis "${t.axis}""`),null}}function lhe(t,e,i){if(!t)return null;const r=!e.supportedTypes||!!e.supportedTypes.size,s=!e.supportedTypes||!!e.supportedTypes.color,n=!e.supportedTypes||!!e.supportedTypes.rotation,o=!!e.supportedTypes&&!!e.supportedTypes.opacity,a=t.reduce((l,c)=>{if(!l)return l;if(c.valueExpression)return Cr(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(c.type){case"size":return r?oGe(c,l,e,i):l;case"color":return s?lGe(c,l,i):l;case"opacity":return o?cGe(c,l,i):null;case"rotation":return n?uGe(c,l,i):l;default:return null}},{size:null,color:null,opacity:null,rotation:null});return!(t.length>0&&a)||a.size||a.color||a.opacity||a.rotation?a&&a.size&&!aGe(a.size,e,i)?null:a:null}function K7(t){return t&&t.size!=null}function l3(t,e){if(!t)return{enabled:!1};if(Kt.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const i=lhe(t.visualVariables,e);return i?{enabled:!0,visualVariables:i,materialParameters:che(i,e),requiresShaderTransformation:K7(i)}:{enabled:!1}}function c3(t,e,i){if(!e||!t.enabled)return!1;const r=t.visualVariables,s=lhe(e.visualVariables,i);return!!s&&!!(FR(r.size,s.size,"size")&&FR(r.color,s.color,"color")&&FR(r.rotation,s.rotation,"rotation")&&FR(r.opacity,s.opacity,"opacity"))&&(t.visualVariables=s,t.materialParameters=che(s,i),t.requiresShaderTransformation=K7(s),!0)}function FR(t,e,i){if(!!t!=!!e||t&&t.field!==e.field)return!1;if(t&&i==="rotation"){const r=t,s=e;for(let n=0;n<3;n++)if(r.type[n]!==s.type[n]||r.offset[n]!==s.offset[n]||r.factor[n]!==s.factor[n])return!1}return!0}function che(t,e){const i={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=K7(t);return t&&t.size?(i.vvSizeEnabled=!0,i.vvSizeMinSize=t.size.minSize,i.vvSizeMaxSize=t.size.maxSize,i.vvSizeOffset=t.size.offset,i.vvSizeFactor=t.size.factor):t&&r&&(i.vvSizeValue=e.transformation.scale),t&&r&&(i.vvSymbolAnchor=e.transformation.anchor,i.vvSymbolRotationMatrix=Ai(),Di(u3),nGe(e.transformation.rotation[2],e.transformation.rotation[0],e.transformation.rotation[1],u3),Ka(i.vvSymbolRotationMatrix,u3)),t&&t.color&&(i.vvColorEnabled=!0,i.vvColorValues=t.color.values,i.vvColorColors=t.color.colors),t&&t.opacity&&(i.vvOpacityEnabled=!0,i.vvOpacityValues=t.opacity.values,i.vvOpacityOpacities=t.opacity.opacityValues),i}var LR;(function(t){const e=be(),i=$();function r(n,o,a){if(!n.vvSizeEnabled)return a;ji(e,a);const l=n.vvSymbolRotationMatrix;_u(u3,l[0],l[1],l[2],0,l[3],l[4],l[5],0,l[6],l[7],l[8],0,0,0,0,1),wi(e,e,u3);for(let c=0;c<3;++c){const h=n.vvSizeOffset[c]+o[0]*n.vvSizeFactor[c];i[c]=Re(h,n.vvSizeMinSize[c],n.vvSizeMaxSize[c])}return kP(e,e,i),Vs(e,e,n.vvSymbolAnchor),e}function s(n,o,a){if(!o.vvSizeEnabled)return ne(n,1,1,1);for(let l=0;l<3;++l){const c=o.vvSizeOffset[l]+a[0]*o.vvSizeFactor[l];n[l]=Re(c,o.vvSizeMinSize[l],o.vvSizeMaxSize[l])}return n}t.evaluateModelTransform=r,t.evaluateModelTransformScale=s})(LR||(LR={}));const u3=be(),eU=LR.evaluateModelTransform,hGe=LR.evaluateModelTransformScale;class Gb{constructor(e,i,r=null,s=null,n=On(),o=null,a=null,l=!1){this.data=e,this.material=i,this.layerUid=r,this.graphicUid=s,this.id=n,this.boundingInfo=o,this.calculateShaderTransformation=a,this.castShadow=l,this.boundingSphere=Ot(),this.instanceParameters={highlights:null,occludees:null,visible:!0},this._transformation=be(),this._shaderTransformationDirty=!0}get transformation(){return this._transformation}updateTransformation(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(e,i,r=Rg(e)){A(this.boundingInfo)||(Oe(i,this.boundingInfo.getCenter(),e),i[3]=this.boundingInfo.getBSRadius()*r)}get hasShaderTransformation(){return _(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return A(this.calculateShaderTransformation)?st(this.transformation,Dr):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=be()),ji(this._shaderTransformation,this.calculateShaderTransformation(st(this.transformation,Dr))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&(_(this._transformation)&&Oe(e,e,this._transformation),!0);const i=this.indices.get("position"),r=this.vertexAttributes.get("position");return!!Qne(r,i,e)&&(_(this._transformation)&&Oe(e,e,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const e=new tR(0),i=this.instanceParameters;return i.highlights=JV(i.highlights,e),e}removeHighlight(e){const i=this.instanceParameters;i.highlights=QV(i.highlights,e)}}function dGe(){if(A(tU)){const t=e=>kt(`esri/libs/basisu/${e}`);tU=import("./basis_transcoder.bb6da93b.js").then(e=>e.b).then(({default:e})=>e({locateFile:t}).then(i=>(i.initializeBasis(),delete i.then,i)))}return tU}let tU,Ic=null,kR=null;async function uhe(){return A(kR)&&(kR=dGe(),Ic=await kR),kR}function pGe(t,e){if(A(Ic))return t.byteLength;const i=new Ic.BasisFile(new Uint8Array(t)),r=dhe(i)?hhe(i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),e):0;return i.close(),i.delete(),r}function fGe(t,e){if(A(Ic))return t.byteLength;const i=new Ic.KTX2File(new Uint8Array(t)),r=phe(i)?hhe(i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),e):0;return i.close(),i.delete(),r}function hhe(t,e,i,r,s){const n=dne(e?37496:37492),o=s&&t>1?(4**t-1)/(3*4**(t-1)):1;return Math.ceil(i*r*n*o)}function dhe(t){return t.getNumImages()>=1&&!t.isUASTC()}function phe(t){return t.getFaces()>=1&&t.isETC1S()}async function mGe(t,e,i){A(Ic)&&(Ic=await uhe());const r=new Ic.BasisFile(new Uint8Array(i));if(!dhe(r))return null;r.startTranscoding();const s=fhe(t,e,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(n,o)=>r.getImageTranscodedSizeInBytes(0,n,o),(n,o,a)=>r.transcodeImage(a,0,n,o,0,0));return r.close(),r.delete(),s}async function gGe(t,e,i){A(Ic)&&(Ic=await uhe());const r=new Ic.KTX2File(new Uint8Array(i));if(!phe(r))return null;r.startTranscoding();const s=fhe(t,e,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(n,o)=>r.getImageTranscodedSizeInBytes(n,0,0,o),(n,o,a)=>r.transcodeImage(a,n,0,0,o,0,-1,-1));return r.close(),r.delete(),s}function fhe(t,e,i,r,s,n,o,a){const{compressedTextureETC:l,compressedTextureS3TC:c}=t.capabilities,[h,p]=l?r?[1,37496]:[0,37492]:c?r?[3,33779]:[2,33776]:[13,6408],f=e.hasMipmap?i:Math.min(1,i),g=[];for(let w=0;w<f;w++)g.push(new Uint8Array(o(w,h))),a(w,h,g[w]);const y=g.length>1,v=y?9987:9729,b=he(E({},e),{samplingMode:v,hasMipmap:y,internalFormat:p,width:s,height:n});return new qe(t,b,{type:"compressed",levels:g})}const h3=le.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),yGe=542327876,vGe=131072,_Ge=4;function iU(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function bGe(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)}const wGe=iU("DXT1"),xGe=iU("DXT3"),SGe=iU("DXT5"),TGe=31,CGe=0,MGe=1,PGe=2,AGe=3,$Ge=4,EGe=7,OGe=20,RGe=21;function IGe(t,e,i){const{textureData:r,internalFormat:s,width:n,height:o}=DGe(i,e.hasMipmap);return e.samplingMode=r.levels.length>1?9987:9729,e.hasMipmap=r.levels.length>1,e.internalFormat=s,e.width=n,e.height=o,new qe(t,e,r)}function DGe(t,e){const i=new Int32Array(t,0,TGe);if(i[CGe]!==yGe)return h3.error("Invalid magic number in DDS header"),null;if(!(i[OGe]&_Ge))return h3.error("Unsupported format, must contain a FourCC code"),null;const r=i[RGe];let s,n;switch(r){case wGe:s=8,n=33776;break;case xGe:s=16,n=33778;break;case SGe:s=16,n=33779;break;default:return h3.error("Unsupported FourCC code:",bGe(r)),null}let o=1,a=i[$Ge],l=i[AGe];(3&a)==0&&(3&l)==0||(h3.warn("Rounding up compressed texture size to nearest multiple of 4."),a=a+3&-4,l=l+3&-4);const c=a,h=l;let p,f;i[PGe]&vGe&&e!==!1&&(o=Math.max(1,i[EGe])),o===1||Kv(a)&&Kv(l)||(h3.warn("Ignoring mipmaps of non power of two sized compressed texture."),o=1);let g=i[MGe]+4;const y=[];for(let v=0;v<o;++v)f=(a+3>>2)*(l+3>>2)*s,p=new Uint8Array(t,g,f),y.push(p),g+=f,a=Math.max(1,a>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:y},internalFormat:n,width:c,height:h}}class Mr extends ab{constructor(e,i){super(),this.data=e,this.type=4,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new Ci,this.params=i||{},this.params.mipmap=this.params.mipmap!==!1,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:10497,t:10497},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||1,this.estimatedTexMemRequired=Mr.estimateTexMemRequired(this.data,this.params),this.startPreload()}startPreload(){const e=this.data;A(e)||(e instanceof HTMLVideoElement?this.startPreloadVideoElement(e):e instanceof HTMLImageElement&&this.startPreloadImageElement(e))}startPreloadVideoElement(e){Zv(e.src)||e.preload==="auto"&&e.crossOrigin||(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src)}startPreloadImageElement(e){Jc(e.src)||Zv(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static estimateTexMemRequired(e,i){if(A(e))return 0;if(Bw(e)||dg(e))return i.encoding===Mr.KTX2_ENCODING?fGe(e,i.mipmap):i.encoding===Mr.BASIS_ENCODING?pGe(e,i.mipmap):e.byteLength;const{width:r,height:s}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?Mr.getDataDimensions(e):i;return(i.mipmap?4/3:1)*r*s*(i.components||4)||0}dispose(){this.data=void 0}get width(){return this.params.width}get height(){return this.params.height}createDescriptor(e){var i;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:(i=this.params.maxAnisotropy)!=null?i:this.params.mipmap?e.parameters.maxMaxAnisotropy:1}}get glTexture(){return this._glTexture}load(e,i){if(_(this._glTexture))return this._glTexture;if(_(this._loadingPromise))return this._loadingPromise;const r=this.data;return A(r)?(this._glTexture=new qe(e,this.createDescriptor(e),null),this._glTexture):typeof r=="string"?this.loadFromURL(e,i,r):r instanceof Image?this.loadFromImageElement(e,i,r):r instanceof HTMLVideoElement?this.loadFromVideoElement(e,i,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this.loadFromImage(e,r,i):(Bw(r)||dg(r))&&this.params.encoding===Mr.DDS_ENCODING?this.loadFromDDSData(e,r):(Bw(r)||dg(r))&&this.params.encoding===Mr.KTX2_ENCODING?this.loadFromKTX2(e,r):(Bw(r)||dg(r))&&this.params.encoding===Mr.BASIS_ENCODING?this.loadFromBasis(e,r):dg(r)?this.loadFromPixelData(e,r):Bw(r)?this.loadFromPixelData(e,new Uint8Array(r)):null}get requiresFrameUpdates(){return this.data instanceof HTMLVideoElement}frameUpdate(e,i,r){if(!(this.data instanceof HTMLVideoElement)||A(this._glTexture)||this.data.readyState<2||r===this.data.currentTime)return r;if(_(this._powerOfTwoStretchInfo)){const{framebuffer:s,vao:n,sourceTexture:o}=this._powerOfTwoStretchInfo;o.setData(this.data),this.drawStretchedTexture(e,i,s,n,o,this._glTexture)}else{const{width:s,height:n}=this.data,{width:o,height:a}=this._glTexture.descriptor;s!==o||n!==a?this._glTexture.updateData(0,0,0,Math.min(s,o),Math.min(n,a),this.data):this._glTexture.setData(this.data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.data.currentTime}loadFromDDSData(e,i){return this._glTexture=IGe(e,this.createDescriptor(e),i),this._glTexture}loadFromKTX2(e,i){return this.loadAsync(()=>gGe(e,this.createDescriptor(e),i).then(r=>(this._glTexture=r,r)))}loadFromBasis(e,i){return this.loadAsync(()=>mGe(e,this.createDescriptor(e),i).then(r=>(this._glTexture=r,r)))}loadFromPixelData(e,i){Ze(this.params.width>0&&this.params.height>0);const r=this.createDescriptor(e);return r.pixelFormat=this.params.components===1?6409:this.params.components===3?6407:6408,r.width=this.params.width,r.height=this.params.height,this._glTexture=new qe(e,r,i),this._glTexture}loadFromURL(e,i,r){return this.loadAsync(async s=>{const n=await tl(r,{signal:s});return this.loadFromImage(e,n,i)})}loadFromImageElement(e,i,r){return r.complete?this.loadFromImage(e,r,i):this.loadAsync(async s=>{const n=await Oq(r,r.src,!1,s);return this.loadFromImage(e,n,i)})}loadFromVideoElement(e,i,r){return r.readyState>=2?this.loadFromImage(e,r,i):this.loadFromVideoElementAsync(e,i,r)}loadFromVideoElementAsync(e,i,r){return this.loadAsync(s=>new Promise((n,o)=>{const a=()=>{r.removeEventListener("loadeddata",l),r.removeEventListener("error",c),ln(h)},l=()=>{r.readyState>=2&&(a(),n(this.loadFromImage(e,r,i)))},c=p=>{a(),o(p||new Q("Failed to load video"))};r.addEventListener("loadeddata",l),r.addEventListener("error",c);const h=ps(s,()=>c($t()))}))}loadFromImage(e,i,r){const s=Mr.getDataDimensions(i);this.params.width=s.width,this.params.height=s.height;const n=this.createDescriptor(e);return n.pixelFormat=this.params.components===3?6407:6408,!this.requiresPowerOfTwo(e,n)||Kv(s.width)&&Kv(s.height)?(n.width=s.width,n.height=s.height,this._glTexture=new qe(e,n,i),this._glTexture):(this._glTexture=this.makePowerOfTwoTexture(e,i,s,n,r),this._glTexture)}loadAsync(e){const i=new AbortController;this._loadingController=i;const r=e(i.signal);this._loadingPromise=r;const s=()=>{this._loadingController===i&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(s,s),r}requiresPowerOfTwo(e,i){const r=33071,s=typeof i.wrapMode=="number"?i.wrapMode===r:i.wrapMode.s===r&&i.wrapMode.t===r;return!Eo(e.gl)&&(i.hasMipmap||!s)}makePowerOfTwoTexture(e,i,r,s,n){const{width:o,height:a}=r,l=Op(o),c=Op(a);let h;switch(s.width=l,s.height=c,this.params.powerOfTwoResizeMode){case 2:s.textureCoordinateScaleFactor=[o/l,a/c],h=new qe(e,s),h.updateData(0,0,0,o,a,i);break;case 1:case null:case void 0:h=this.stretchToPowerOfTwo(e,i,s,n());break;default:kn(this.params.powerOfTwoResizeMode)}return s.hasMipmap&&h.generateMipmap(),h}stretchToPowerOfTwo(e,i,r,s){const n=new qe(e,r),o=new ci(e,{colorTarget:0,depthStencilTarget:0},n),a=new qe(e,{target:3553,pixelFormat:r.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},i),l=vn(e),c=e.getBoundFramebufferObject();return this.drawStretchedTexture(e,s,o,l,a,n),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:l,sourceTexture:a,framebuffer:o}:(l.dispose(!0),a.dispose(),o.detachColorTexture(),o.dispose()),e.bindFramebuffer(c),n}drawStretchedTexture(e,i,r,s,n,o){e.bindFramebuffer(r);const a=e.getViewport();e.setViewport(0,0,o.descriptor.width,o.descriptor.height);const l=i.program;e.useProgram(l),l.setUniform4f("color",1,1,1,1),l.bindTexture(n,"tex"),e.bindVAO(s),i.bindPipelineState(e),e.drawArrays(5,0,xs(s,"geometry")),e.bindFramebuffer(null),e.setViewport(a.x,a.y,a.width,a.height)}unload(){if(_(this._powerOfTwoStretchInfo)){const{framebuffer:e,vao:i,sourceTexture:r}=this._powerOfTwoStretchInfo;i.dispose(!0),r.dispose(),e.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(_(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),_(this._loadingController)){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}}Mr.DDS_ENCODING="image/vnd-ms.dds",Mr.KTX2_ENCODING="image/ktx2",Mr.BASIS_ENCODING="image/x.basis";const FGe=be(),mhe=De(0,0,1),LGe=16,kGe=1.5,d3=128,Rm=.5,zGe=[Rm/2,Rm/2,1-Rm/2,1-Rm/2],VGe=[d3*Rm,d3*Rm];class p3 extends Zu{constructor(e,i,r,s){super(e,i,r,s),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}getCachedSize(){return{size:this._getIconSize()}}async doLoad(e){this._validateOrThrow();const i=this._prepareMaterialParameters(),r=this._getPrimitive();if(_(r))this._prepareResourcesPrimitive(i,r);else{const s=iFe(this.symbol,this.symbolLayer),n=pM(s);n&&n.mediaType==="application/json"?await this._prepareResourcesCIM(i,JSON.parse(n.data),e):await this._prepareResourcesHref(i,s,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=QO(this._getIconSize());if(e)throw new Q("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,i=Math.round(e.size!=null?zs(e.size):LGe);return this._drivenProperties.size?Math.max(i,64):i}_generateTextureCIM(e){const i=this._getGraphicHash(e);let r=i===""?null:this._cimSymbolTextures.get(i);if(!r){const s={scaleFactor:this._cimScaleFactorOrFunction},n=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,"esriGeometryPoint",s,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",n.anchorPosition);const o={width:n.imageData.width,height:n.imageData.height,powerOfTwoResizeMode:2};r=new Mr(n.imageData,o),this._cimSymbolTextures.set(i,r),this._context.stage.add(r)}return r}_computeSize(e,i){const r=e.width/e.height;return r>1?[i,Math.round(i/r)]:[Math.round(i*r),i]}_prepareMaterialParameters(){const e={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},i=this.symbol;if(NGe(i)){const{screenLength:r,minWorldLength:s,maxWorldLength:n}=i.verticalOffset;e.verticalOffset={screenLength:zs(r),minWorldLength:s||0,maxWorldLength:n!=null?n:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,i){const r=this._getOutlineSize();if(rU(i)&&r===0)throw new Error("Nothing to render");this._outlineSize=r,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;const s=this._context.sharedResources.textures.fromData(i,()=>UGe(i));this._texture=s.texture,this._releaseTexture=s,e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=zGe,e.textureId=this._texture.id;const n=this._getIconSize();this._size=[n,n],this._symbolTextureRatio=1/Rm,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,i,r){if(!ae("esri-canvas-svg-support")&&QD(i))throw new Q("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const s=this._getIconSize(),n=s*this._context.layerView.view.pixelRatio,o=await zl(this._context.sharedResources.textures.fromUrl(i,n,{signal:r}));if(o.ok===!1)throw Wc(o.error),new Q("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${i})`);this._releaseTexture=o.value;const a=o.value.texture,l=a.params;this._size=this._computeSize(l,s),e.textureId=a.id,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,i,r){const s=new p1({data:i});if(!this._context.sharedResources.cimSymbolRasterizer){const h=(await import("./CIMSymbolRasterizer.98240089.js")).CIMSymbolRasterizer;Dt(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new h(this._context.renderCoordsHelper.spatialReference,!0))}const n=this._context.layer.fields?this._context.layer.fields.map(h=>h.toJSON()):null;let o,a;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(s,n,this._context.renderer&&this._context.renderer.type==="dictionary"?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&this._context.renderer.type==="dictionary"&&this._context.renderer.scaleExpression){const h=this._context.renderer;if(isNaN(h.scaleExpression)){const p=h.scaleExpression,f=await Jbe(p,this._context.layer.spatialReference,n);a=(g,y,v)=>{const b=WBe(f,g,{$view:v},"esriGeometryPoint",y);return b!==null?b:1}}else o=Number(h.scaleExpression)}this._cimScaleFactorOrFunction=o||a||1;const l=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];Dt(r);const c=this._context.layer.fieldsIndex;this._cimRequiredFields=l.map(h=>c.get(h).name),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||bxe}_getOutlineSize(){let e=0;const i=this.symbolLayer;return _(i.outline)&&i.outline.size!=null?Math.max(zs(i.outline.size),0):(e=rU(this._getPrimitive())?kGe:0,Math.max(e,0))}_getOutlineColor(){const e=this._getLayerOpacity(),i=this.symbolLayer,r=or(i,"outline","color");if(_(r)){const s=Ae.toUnitRGB(r),n=r.a*e;return[s[0],s[1],s[2],n]}return[0,0,0,0]}_getFillColor(){if(rU(this._getPrimitive()))return QBe;const e=A(this._getPrimitive()),i=or(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(i,{hasIntrinsicColor:e})}_getAnchorPos(e,i){return e==="relative"?Qt((i.x||0)+.5,.5-(i.y||0)):e in VT?VT[e]:VT.center}_createMaterialAndAddToStage(e,i){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=l3(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(e,this._fastUpdates.materialParameters),this._cimLayers){let r=this._cimSymbolMaterials.get(e.textureId);return r||(r=new Eb(e),this._cimSymbolMaterials.set(e.textureId,r),i.add(r)),r}return this._material=new Eb(e),i.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial(e=>this._context.stage.remove(e)),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(e=>this._context.stage.remove(e)),this._cimSymbolTextures.clear(),this._releaseTexture=nr(this._releaseTexture)}_getScaleFactor(e,i){if(this._drivenProperties.size&&e.size){for(let r=0;r<3;r++){const s=e.size[r];s&&s!=="symbol-value"&&s!=="proportional"&&(e.size[r]=zs(s))}if(e.size[0]==="symbol-value")return 1;if(isFinite(+e.size[0]))return+e.size[0]/i;if(isFinite(+e.size[2]))return+e.size[2]/i}return 1}createGraphics3DGraphic(e){const i=e.graphic;if(!this._validateGeometry(i.geometry))return null;let r,s;if(this._cimLayers){if(!this._cimLayers.length)return null;const p=this._generateTextureCIM(i),f=E({textureId:p.id},this._cimMaterialParametersInfo);s=this._createMaterialAndAddToStage(f,this._context.stage),r=[p.params.width,p.params.height]}else r=this._size,s=at(this._material);const n=GT(i.geometry);if(A(n))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const o=e.renderingInfo,a=this._getVertexOpacityAndColor(o);let l=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const p=r[0]>r[1]?r[0]:r[1];l=this._getScaleFactor(o,p)}l*=this._symbolTextureRatio;const c=[r[0]*l,r[1]*l],h=this.setGraphicElevationContext(i,new ma);return this.ensureDrapedStatus(h.mode==="on-the-ground")&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(i,n,s,a,c,e.layer.uid):this._createAs3DShape(i,n,s,a,c,h,i.uid)}layerOpacityChanged(){const e=this._getFillColor(),i=this._getOutlineColor();return this._forEachMaterial(r=>{r.setParameters({color:e}),r.setParameters({outlineColor:i})}),!0}layerElevationInfoChanged(e,i,r){const s=this._elevationContext.mode,n=NT(p3.elevationModeChangeTypes,r,s);if(n!==$i.UPDATE)return n;const o=cl(s)||s==="absolute-height";return this.updateGraphics3DGraphicElevationInfo(e,i,()=>o)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(e=>{e.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}applyRendererDiff(e,i){for(const r in e.diff){if(r!=="visualVariables"||!c3(this._fastUpdates,i,this._fastVisualVariableConvertOptions()))return 0;_(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return 2}_defaultElevationInfoNoZ(){return jGe}_createAs3DShape(e,i,r,s,n,o,a){const l=this.getFastUpdateAttrValues(e),c=l?g=>eU(this._fastUpdates.materialParameters,l,g):null,h=[Oo.createPointGeometry(mhe,null,s,n,BGe,null,l)],p=v7(this._context,i,h,[r],o,this._context.layer.uid,a,c);if(p===null)return null;const f=new Wu(this,p.object,h,null,null,jT,o);return f.alignedSampledElevation=p.sampledElevation,f.needsElevationUpdates=cl(o.mode)||o.mode==="absolute-height",f.getScreenSize=this._createScreenSizeGetter(n,c),f.calculateRelativeScreenBounds=g=>r.calculateRelativeScreenBounds(f.getScreenSize(),1,g),BT(f,i,this._context.elevationProvider),f}_createAsOverlay(e,i,r,s,n,o){r.renderPriority=this._renderPriority;const a=Ot();Gr(i,a,this._context.overlaySR),a[2]=B7;const l=this._context.clippingExtent;if(_(l)&&!iL(l,a))return null;const c=this.getFastUpdateAttrValues(e),h=c?y=>eU(this._fastUpdates.materialParameters,c,y):null,p=Oo.createPointGeometry(mhe,a,s,n,null,null,c),f=new Gb(p,r,o,e.uid);a[3]=0,Ln(f.boundingSphere,a),f.calculateShaderTransformation=h;const g=new IR(this,[f],null);return g.getScreenSize=this._createScreenSizeGetter(n,h),g.calculateRelativeScreenBounds=y=>r.calculateRelativeScreenBounds(g.getScreenSize(),1,y),g}_createScreenSizeGetter(e,i){const r=this._outlineSize+2;if(this._fastUpdates.enabled){const s=e[0]/this._symbolTextureRatio,n=e[1]/this._symbolTextureRatio;return(o=ke())=>{const a=i(FGe);return o[0]=a[0]*s+r,o[1]=a[5]*n+r,o}}{const s=e[0]/this._symbolTextureRatio+r,n=e[1]/this._symbolTextureRatio+r;return(o=ke())=>(o[0]=s,o[1]=n,o)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],i=De(e,e,e),r=au(1),s=e*r;return{modelSize:i,symbolSize:De(s,s,s),unitInMeters:r,transformation:{anchor:Fn,scale:Kc,rotation:Fn}}}_getGraphicHash(e){let i="";for(const r of this._cimRequiredFields)i+=r+e.attributes[r];return i}_forEachMaterial(e){_(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)}}function NGe(t){return t&&t.type==="point-3d"&&t.hasVisibleVerticalOffset()}function rU(t){return!!_(t)&&(t==="cross"||t==="x")}function UGe(t){let e;const i=d3,r=i*Rm;switch(t){case"circle":e=XBe(i,r);break;case"square":e=KBe(i,r);break;case"kite":e=eGe(i,r);break;case"cross":e=tGe(i,r);break;case"x":e=iGe(i,r);break;case"triangle":e=rGe(i,r)}return new Mr(e,{mipmap:!1,wrap:{s:33071,t:33071},width:d3,height:d3,components:4,noUnpackFlip:!0})}p3.PRIMITIVE_SIZE=VGe,p3.elevationModeChangeTypes={definedChanged:$i.UPDATE,staysOnTheGround:$i.NONE,onTheGroundChanged:$i.RECREATE};const jGe={mode:"relative-to-ground",offset:0},BGe=Bt(0,0,0,1);function sU(t){const e=[],i=[];HGe(t,i,e);const r=i[0][1].data,s=e[0][1].length,n=new Uint16Array(s);return WGe(t,i,e),ZGe(t,i,e,n),QGe(t,i,e,n),JGe(t,i,e,n),YGe(t,i,e,n),XGe(t,i,e,n),KGe(t,i,e,r),eqe(t,i,e,r),new zi(i,e,2)}function GGe(t,e,i,r){const s=t.type==="polygon"?1:0,n=t.type==="polygon"?t.rings:t.paths,{position:o,outlines:a}=HT(n,t.hasZ,s),l=new Float64Array(o.length),c=dce(o,t.spatialReference,0,l,0,o,0,o.length/3,e,i,r),h=c!=null;return{lines:h?ghe(a,o,l):[],projectionSuccess:h,sampledElevation:c}}function ghe(t,e,i){const r=new Array;for(const{index:s,count:n}of t){if(n<=1)continue;const o=3*s,a=o+3*n;r.push({position:e.subarray(o,a),mapPosition:i?i.subarray(o,a):void 0})}return r}function qGe(t,e){const i=t.type==="polygon"?1:0,r=t.type==="polygon"?t.rings:t.paths,{position:s,outlines:n}=HT(r,!1,i),o=Mi(s,t.spatialReference,0,s,e,0,s.length/3);for(let a=2;a<s.length;a+=3)s[a]=B7;return{lines:o?ghe(n,s):[],projectionSuccess:o}}function HGe(t,e,i){const{attributeData:{position:r},removeDuplicateStartEnd:s}=t,n=iqe(r)&&s===1,o=r.length/3-(n?1:0),a=new Uint32Array(2*(o-1)),l=n?nD(r,0,r.length-3):r;let c=0;for(let h=0;h<o-1;h++)a[c++]=h,a[c++]=h+1;e.push(["position",{size:3,data:l,exclusive:n}]),i.push(["position",a])}function WGe(t,e,i){const r=t.attributeData.mapPosition;A(r)||(i.push(["mapPos",i[0][1]]),e.push(["mapPos",{size:3,data:r}]))}function ZGe(t,e,i,r){if(_(t.attributeData.colorFeature))return;const s=t.attributeData.color;e.push(["color",{size:4,data:st(s,YBe)}]),i.push(["color",r])}function JGe(t,e,i,r){const s=t.attributeData.colorFeature;A(s)||(e.push(["colorFeatureAttribute",{size:1,data:new Float32Array([s])}]),i.push(["color",r]))}function QGe(t,e,i,r){if(_(t.attributeData.sizeFeature))return;const s=t.attributeData.size;e.push(["size",{size:1,data:[st(s,1)]}]),i.push(["size",r])}function YGe(t,e,i,r){const s=t.attributeData.sizeFeature;A(s)||(e.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([s])}]),i.push(["sizeFeatureAttribute",r]))}function XGe(t,e,i,r){const s=t.attributeData.opacityFeature;A(s)||(e.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([s])}]),i.push(["opacityFeatureAttribute",r]))}function KGe(t,e,i,r){if(t.join!=="round")return;const s=r.length/3,n=new Float32Array(s),o=yhe,a=vhe;ne(o,0,0,0);const l=st(t.uniformSize,1);for(let c=-1;c<s;++c){const h=c<0?s+c:c,p=(c+1)%s;if(ne(a,r[3*p+0]-r[3*h+0],r[3*p+1]-r[3*h+1],r[3*p+2]-r[3*h+2]),_e(a,a),c>=0){const f=1*((Math.PI-ar(ye(o,a)))*rqe)*tqe(l);n[c]=Math.max(Math.floor(f),0)}se(o,a,-1)}e.push(["subdivisions",{size:1,data:n}]),i.push(["subdivisions",i[0][1]])}function eqe(t,e,i,r){if(A(t.overlayInfo)||t.overlayInfo.renderCoordsHelper.viewingMode!==1||!t.overlayInfo.spatialReference.isGeographic)return;const s=new Float64Array(r.length),n=Ut(t.overlayInfo.spatialReference);for(let f=0;f<s.length;f+=3)u6(r,f,s,f,n);const o=r.length/3,a=new Float32Array(o+1);let l=yhe,c=vhe,h=0,p=0;ne(l,s[p++],s[p++],s[p++]),a[0]=0;for(let f=1;f<o+1;++f)f===o&&(p=0),ne(c,s[p++],s[p++],s[p++]),h+=Ise(l,c),a[f]=h,[l,c]=[c,l];e.push(["distanceToStart",{size:1,data:a}]),i.push(["distanceToStart",i[0][1]])}function tqe(t){return 1.863798+-2.0062872/(1+t/18.2313)**.8856294}function iqe(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}const yhe=$(),vhe=$(),rqe=4/Math.PI;function _he(t){switch(t){case"butt":return 0;case"square":return 1;case"round":return 2;default:return null}}const rn={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},sqe={dash:rn.dash,"dash-dot":[...rn.dash,...rn.dot],dot:rn.dot,"long-dash":rn["long-dash"],"long-dash-dot":[...rn["long-dash"],...rn.dot],"long-dash-dot-dot":[...rn["long-dash"],...rn.dot,...rn.dot],none:null,"short-dash":rn["short-dash"],"short-dash-dot":[...rn["short-dash"],...rn["short-dot"]],"short-dash-dot-dot":[...rn["short-dash"],...rn["short-dot"],...rn["short-dot"]],"short-dot":rn["short-dot"],solid:null},nqe=8;function oqe(t,e=2){return A(t)?t:{pattern:t.slice(),pixelRatio:e}}function zat(t,e=2){return{pattern:[t,t],pixelRatio:e}}function bhe(t){return _(t)&&t.type==="style"?oqe(sqe[t.style],nqe):null}const aqe=["polyline","polygon","extent"];class zR extends Zu{constructor(e,i,r,s){super(e,i,r,s),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=l3(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=this.symbolLayer.size!=null?this.symbolLayer.size:au(1);if(e<0)throw new Q("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e}}getMaterialParameters(e){const i=or(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(i);this._patternHidesLine&&(r[3]=0);const s=r[3],n={width:1,color:r,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:_he(this.symbolLayer.cap||"butt"),transparent:s<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:bhe(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(n.width=zs(1));else{const o=this.symbolLayer.size!=null?this.symbolLayer.size:au(1);n.width=zs(o)}return this._fastUpdates&&this._fastUpdates.visualVariables?E(E({},n),this._fastUpdates.materialParameters):n}get lineMaterial(){return A(this._lineMaterial)&&(this._lineMaterial=new mR(this.getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return A(this._ringMaterial)&&(this._ringMaterial=new mR(this.getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}destroy(){super.destroy(),this._context.stage.remove(this._lineMaterial),this._lineMaterial=null,this._context.stage.remove(this._ringMaterial),this._ringMaterial=null}getDrivenSize(e){return this._drivenProperties.size&&e.size?zs(NUe(e.size)):1}getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?Vd(this._fastUpdates.visualVariables.size.field,e):null}getDrivenColor(e){const i=Bt(1,1,1,1);return this._drivenProperties.color&&e.color&&(i[0]=e.color[0],i[1]=e.color[1],i[2]=e.color[2],e.color.length>0&&(i[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(i[3]=e.opacity),i}getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?Vd(this._fastUpdates.visualVariables.color.field,e):null}getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?Vd(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const i=e.graphic;if(!this._validateGeometry(i.geometry,aqe,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new ma);return this.ensureDrapedStatus(r.mode==="on-the-ground"),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,r,i.uid)}applyRendererDiff(e,i){for(const r in e.diff){if(r!=="visualVariables"||!c3(this._fastUpdates,i,this._vvConvertOptions))return 0;_(this._lineMaterial)&&this._lineMaterial.setParameters(this._fastUpdates.materialParameters),_(this._ringMaterial)&&this._ringMaterial.setParameters(this._fastUpdates.materialParameters)}return 2}layerOpacityChanged(){return _(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),_(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0}updateMaterialLayerOpacity(e){const i=e.parameters.color,r=or(this.symbolLayer,"material","color"),s=this._patternHidesLine?0:this._getCombinedOpacity(r),n=s<1||this.needsDrivenTransparentPass,o=[i[0],i[1],i[2],s];e.setParameters({color:o,transparent:n})}layerElevationInfoChanged(e,i,r){const s=this._elevationContext.mode,n=NT(zR.elevationModeChangeTypes,r,s);if(n!==$i.UPDATE)return n;const o=cl(s);return this.updateGraphics3DGraphicElevationInfo(e,i,()=>o)}slicePlaneEnabledChanged(){return _(this._lineMaterial)&&this._lineMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),_(this._ringMaterial)&&this._ringMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof ht)return Zo.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,i,r){const s=e.graphic,n=this._getGeometryAsPolygonOrPolyline(s.geometry),o=n.type==="polygon"?n.rings:n.paths,a=new Array,l=new Array,c=new Array,h=lr(),p=GGe(n,this._context.elevationProvider,this._context.renderCoordsHelper,i),f=n.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(p,o,f,"LineSymbol3DLayer");for(let v=0;v<p.lines.length;v++){const{position:b,mapPosition:w}=p.lines[v];if(_(this._context.clippingExtent)&&(ii(h),Ql(h,w),!Xl(h,this._context.clippingExtent)))continue;const S=this._createGeometry(e,b,w,n.type,1);a.push(S),l.push(n.type==="polygon"?this.ringMaterial:this.lineMaterial),c.push(Dr)}if(a.length===0)return null;const g=new Nd({geometries:a,materials:l,transformations:c,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),y=new Wu(this,g,a,null,null,u7,i);return y.alignedSampledElevation=p.sampledElevation,y.needsElevationUpdates=cl(i.mode),y}_createGeometry(e,i,r,s,n){const o=s==="polygon"?1:0,a=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,l=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return sU({overlayInfo:n===0?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:o,uniformSize:this._uniformSize,attributeData:{position:i,mapPosition:r,size:l?null:this.getDrivenSize(e.renderingInfo),color:a?null:this.getDrivenColor(e.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(e.graphic),colorFeature:this.getColorFeatureAttributeData(e.graphic),opacityFeature:this.getOpacityFeatureAttributeData(e.graphic)}})}_createAsOverlay(e,i){const r=e.graphic,s=this._getGeometryAsPolygonOrPolyline(r.geometry),n=s.type==="polygon"?s.rings:s.paths,o=s.type==="polygon"?this.ringMaterial:this.lineMaterial;o.renderPriority=this._renderPriority;const a=new Array,l=lr(),c=ii(),h=qGe(s,this._context.overlaySR),p=s.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(h,n,p,"LineSymbol3DLayer");for(const f of h.lines){if(ii(l),Ql(l,f.position),!Xl(l,this._context.clippingExtent))continue;g1(c,l);const g=this._createGeometry(e,f.position,null,s.type,0),y=new Gb(g,o,i,r.uid);Ls(y.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),a.push(y)}return new IR(this,a,c)}get _patternHidesLine(){const e=this.symbolLayer.pattern;return _(e)&&e.type==="style"&&e.style==="none"}}zR.elevationModeChangeTypes={definedChanged:$i.RECREATE,staysOnTheGround:$i.NONE,onTheGroundChanged:$i.RECREATE};const whe=2048,lqe=1.5,cqe=8;function uqe(t,e){const{format:i,quality:r,rotation:s,disableDecorations:n}=t||{},o=oU(t,e.padding),a=_qe(t,{width:e.width-o.left-o.right,height:e.height-o.top-o.bottom}),{width:l,height:c}=vqe(t,a),h=xqe(i),p=Pqe[h];return{format:h,quality:Re(r!=null?r:p,0,100),area:a,width:l,height:c,rotation:s,disableDecorations:!!n,ignoreBackground:!(!t||!t.ignoreBackground),ignorePadding:!(!t||!t.ignorePadding)}}function hqe(t,e){const i=uqe(t,e),r=i.area,s=i.width/r.width,n=oU(i,e.padding),o=n.left+n.right,a=n.top+n.bottom,l=e.width-o,c=e.height-a,h=Math.floor(l*s+o),p=Math.floor(c*s+a),f=t&&t.layers?t.layers:[],g=i.ignoreBackground,y=i.ignorePadding;return{framebufferWidth:h,framebufferHeight:p,region:{x:Math.floor(r.x*s)+n.left,y:Math.floor(r.y*s)+n.top,width:i.width,height:i.height},format:i.format,quality:i.quality,rotation:i.rotation,pixelRatio:s,layers:f,disableDecorations:i.disableDecorations,ignoreBackground:g,ignorePadding:y}}function dqe(t,e,i,r){r.premultipliedAlpha&&Tqe(t),i.width=t.width,i.height=t.height;const s=i.getContext("2d");s.putImageData(t,0,0),r.flipY&&Sqe(s);const n=s.getImageData(0,0,t.width,t.height),o=pqe(i,e);return i.width=0,i.height=0,{dataUrl:o,data:n}}function pqe(t,e){const i=Cqe[e.format],r=e.quality/100;return t.toDataURL(i,r)}function nU(t,e,i){if(!t||!e)throw new Error("Cannot construct image data without dimensions");if(VR)try{return new ImageData(t,e)}catch{VR=!1}return xhe(t,e,i)}function fqe(t,e,i,r){if(!e||!i)throw new Error("Cannot construct image data without dimensions");if(VR)try{return new ImageData(t,e,i)}catch{VR=!1}const s=xhe(e,i,r);return s.data.set(t,0),s}function mqe(t,e,i,r=0,s=0,n=t.width-r,o=t.height-s,a=!1){const{data:l}=t,{width:c,height:h,data:p}=e,f=n/c,g=o/h,y=Math.ceil(f/2),v=Math.ceil(g/2),b=t.width;for(let w=0;w<h;w++)for(let S=0;S<c;S++){const T=4*(S+(a?h-w-1:w)*c);let C=0,M=0,P=0,F=0,z=0,D=0;const U=(w+.5)*g;for(let G=Math.floor(w*g);G<(w+1)*g;G++){const k=Math.abs(U-(G+.5))/v,j=(S+.5)*f,V=k*k;for(let q=Math.floor(S*f);q<(S+1)*f;q++){const J=Math.abs(j-(q+.5))/y,O=Math.sqrt(V+J*J);if(O>=1)continue;let L=2*O*O*O-3*O*O+1;const N=4*(r+q+(s+G)*b);D+=L*l[N+3],M+=L,!i&&l[N+3]<255&&(L=L*l[N+3]/255),P+=L*l[N],F+=L*l[N+1],z+=L*l[N+2],C+=L}}p[T]=P/C,p[T+1]=F/C,p[T+2]=z/C,p[T+3]=D/M}return e}function gqe(t,e,i){if(!e)return t;const{framebufferWidth:r,framebufferHeight:s,pixelRatio:n,region:o}=t,a=oU(t,i),l=a.left+a.right,c=a.top+a.bottom,h=r-l,p=s-c,f=Math.min(cqe,Math.min((whe-l)/h,(whe-c)/p));return f<lqe?t:he(E({},t),{framebufferWidth:Math.round(h*f)+l,framebufferHeight:Math.round(p*f)+c,pixelRatio:n*f,resample:{region:{x:Math.round((o.x-a.left)*f)+a.left,y:Math.round((o.y-a.top)*f)+a.top,width:Math.round(o.width*f),height:Math.round(o.height*f)},width:r,height:s}})}function xhe(t,e,i){return i||(i=yqe()),i.getContext("2d").createImageData(t,e)}let f3=null,VR=!0;function yqe(){return f3||(f3=document.createElement("canvas"),f3.width=1,f3.height=1),f3}function vqe(t,e){if(!t)return e;const i=t.width,r=t.height;if(i!=null&&r!=null)return{width:Math.floor(i),height:Math.floor(r)};if(i==null&&r==null)return e;const s=e.width/e.height;return r==null?{width:Math.floor(i),height:Math.floor(i/s)}:{width:Math.floor(r*s),height:Math.floor(r)}}function _qe(t,e){const i={x:0,y:0,width:e.width,height:e.height};if(t&&t.area){t.area.x!=null&&(i.x=Math.floor(t.area.x)),t.area.y!=null&&(i.y=Math.floor(t.area.y));const r=t.area.width!=null?Math.floor(t.area.width):null,s=t.area.height!=null?Math.floor(t.area.height):null;if(i.width=e.width-i.x,i.height=e.height-i.y,r!=null&&s!=null)i.width=Math.min(i.width,r),i.height=Math.min(i.height,s);else if(r==null&&s!=null){const n=Math.min(i.width,r);i.height=n/i.width*i.height,i.width=n}else if(r!=null&&s==null){const n=Math.min(i.height,s);i.width=n/i.height*i.width,i.height=n}}return bqe(wqe(i,t),e)}function bqe(t,e){const i=Math.floor(Math.max(t.x,0)),r=Math.floor(Math.max(t.y,0)),s={x:i,y:r,width:Math.floor(Math.min(t.width,e.width-i)),height:Math.floor(Math.min(t.height,e.height-r))},n=s.width/s.height,o=t.width/t.height;if(o===n)return s;if(o>n){const c=Math.floor(s.width/o),h=s.height-c;return{x:s.x,y:Math.floor(s.y+h/2),width:s.width,height:c}}const a=Math.floor(s.height*o),l=s.width-a;return{x:Math.floor(s.x+l/2),y:s.y,width:a,height:s.height}}function wqe(t,e){if(!e||e.width==null||e.height==null)return t;const i=e.width/e.height,r=t.width/t.height;if(r===i)return t;if(r<i){const n=Math.floor(t.height*i);return t.x-=(n-t.width)/2,t.width=n,t}const s=Math.floor(t.width/i);return t.y-=(s-t.height)/2,t.height=s,t}function oU(t,e){return!e||t&&t.ignorePadding?Aqe:e}function xqe(t){switch(t){case"png":case"jpg":case"jpeg":return t;default:return Mqe}}function Sqe(t){t.save(),t.globalCompositeOperation="copy",t.scale(1,-1),t.translate(0,-t.canvas.height),t.drawImage(t.canvas,0,0),t.restore()}function Tqe(t){const e=t.data,i=e.length;for(let r=0;r<i;r+=4){const s=e[r+3];if(s>0){const n=s/255;e[r+0]=e[r+0]/n,e[r+1]=e[r+1]/n,e[r+2]=e[r+2]/n}}}const Cqe={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},She=98,Mqe="png",Pqe={png:100,jpg:She,jpeg:She},Aqe={top:0,right:0,bottom:0,left:0};var qb;const aU=new WeakMap;let $qe=0,Ku=qb=class extends ge{constructor(t){super(t),this.wrap="repeat"}get url(){return this._get("url")||null}set url(t){this._set("url",t),t&&this._set("data",null)}get data(){return this._get("data")||null}set data(t){this._set("data",t),t&&this._set("url",null)}writeData(t,e,i,r){if(t instanceof HTMLImageElement){const s={type:"image-element",src:Jg(t.src,r),crossOrigin:t.crossOrigin};e[i]=s}else if(t instanceof HTMLCanvasElement){const s=t.getContext("2d").getImageData(0,0,t.width,t.height),n={type:"canvas-element",imageData:this.encodeImageData(s)};e[i]=n}else if(t instanceof HTMLVideoElement){const s={type:"video-element",src:Jg(t.src,r),autoplay:t.autoplay,loop:t.loop,muted:t.muted,crossOrigin:t.crossOrigin,preload:t.preload};e[i]=s}else{const s={type:"image-data",imageData:this.encodeImageData(t)};e[i]=s}}readData(t){switch(t.type){case"image-element":{const e=new Image;return e.src=t.src,e.crossOrigin=t.crossOrigin,e}case"canvas-element":{const e=this.decodeImageData(t.imageData),i=document.createElement("canvas");return i.width=e.width,i.height=e.height,i.getContext("2d").putImageData(e,0,0),i}case"image-data":return this.decodeImageData(t.imageData);case"video-element":{const e=document.createElement("video");return e.src=t.src,e.crossOrigin=t.crossOrigin,e.autoplay=t.autoplay,e.loop=t.loop,e.muted=t.muted,e.preload=t.preload,e}default:return}}get transparent(){const t=this.data,e=this.url;if(t instanceof HTMLCanvasElement)return this.imageDataContainsTransparent(t.getContext("2d").getImageData(0,0,t.width,t.height));if(t instanceof ImageData)return this.imageDataContainsTransparent(t);if(e){const i=e.substr(e.length-4,4).toLowerCase(),r=e.substr(0,15).toLocaleLowerCase();if(i===".png"||r==="data:image/png;")return!0}return!1}set transparent(t){t!=null?this._override("transparent",t):this._clearOverride("transparent")}get contentHash(){const t=typeof this.wrap=="string"?this.wrap:typeof this.wrap=="object"?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",e=(i="")=>`d:${i},t:${this.transparent},w:${t}`;return this.url!=null?e(this.url):this.data!=null?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?e(this.data.src):(aU.has(this.data)||aU.set(this.data,++$qe),e(aU.get(this.data))):e()}clone(){const t={url:this.url,data:this.data,wrap:this.cloneWrap()};return new qb(t)}cloneWithDeduplication(t){const e=t.get(this);if(e)return e;const i=this.clone();return t.set(this,i),i}cloneWrap(){return typeof this.wrap=="string"?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}encodeImageData(t){let e="";for(let i=0;i<t.data.length;i++)e+=String.fromCharCode(t.data[i]);return{data:btoa(e),width:t.width,height:t.height}}decodeImageData(t){const e=atob(t.data),i=new Uint8ClampedArray(e.length);for(let r=0;r<e.length;r++)i[r]=e.charCodeAt(r);return fqe(i,t.width,t.height)}imageDataContainsTransparent(t){for(let e=3;e<t.data.length;e+=4)if(t.data[e]!==255)return!0;return!1}static from(t){return typeof t=="string"?new qb({url:t}):t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData||t instanceof HTMLVideoElement?new qb({data:t}):Bv(qb,t)}};u([d({type:String,json:{write:qp}})],Ku.prototype,"url",null),u([d({json:{write:{overridePolicy(){return{enabled:!this.url}}}}}),d()],Ku.prototype,"data",null),u([Ee("data")],Ku.prototype,"writeData",null),u([Ce("data")],Ku.prototype,"readData",null),u([d({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],Ku.prototype,"transparent",null),u([d({json:{write:!0}})],Ku.prototype,"wrap",void 0),u([d({readOnly:!0})],Ku.prototype,"contentHash",null),Ku=qb=u([R("esri.geometry.support.MeshTexture")],Ku);const m3=Ku;var lU;let qd=lU=class extends ge{constructor(t){super(t),this.color=null,this.colorTexture=null,this.normalTexture=null,this.alphaMode="auto",this.alphaCutoff=.5,this.doubleSided=!0}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(t,e){const i=_(t)?t.get(this):null;if(i)return i;const r=new lU(this.clonePropertiesWithDeduplication(e));return _(t)&&t.set(this,r),r}clonePropertiesWithDeduplication(t){return{color:_(this.color)?this.color.clone():null,colorTexture:_(this.colorTexture)?this.colorTexture.cloneWithDeduplication(t):null,normalTexture:_(this.normalTexture)?this.normalTexture.cloneWithDeduplication(t):null,alphaMode:this.alphaMode,alphaCutoff:this.alphaCutoff,doubleSided:this.doubleSided}}};u([d({type:Ae,json:{write:!0}})],qd.prototype,"color",void 0),u([d({type:m3,json:{write:!0}})],qd.prototype,"colorTexture",void 0),u([d({type:m3,json:{write:!0}})],qd.prototype,"normalTexture",void 0),u([d({nonNullable:!0,json:{write:!0}})],qd.prototype,"alphaMode",void 0),u([d({nonNullable:!0,json:{write:!0}})],qd.prototype,"alphaCutoff",void 0),u([d({nonNullable:!0,json:{write:!0}})],qd.prototype,"doubleSided",void 0),qd=lU=u([R("esri.geometry.support.MeshMaterial")],qd);const cU=qd;var uU;let Hd=uU=class extends cU{constructor(t){super(t),this.emissiveColor=null,this.emissiveTexture=null,this.occlusionTexture=null,this.metallic=1,this.roughness=1,this.metallicRoughnessTexture=null}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(t,e){const i=_(t)?t.get(this):null;if(i)return i;const r=new uU(this.clonePropertiesWithDeduplication(e));return _(t)&&t.set(this,r),r}clonePropertiesWithDeduplication(t){return he(E({},super.clonePropertiesWithDeduplication(t)),{emissiveColor:_(this.emissiveColor)?this.emissiveColor.clone():null,emissiveTexture:_(this.emissiveTexture)?this.emissiveTexture.cloneWithDeduplication(t):null,occlusionTexture:_(this.occlusionTexture)?this.occlusionTexture.cloneWithDeduplication(t):null,metallic:this.metallic,roughness:this.roughness,metallicRoughnessTexture:_(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.cloneWithDeduplication(t):null})}};u([d({type:Ae,json:{write:!0}})],Hd.prototype,"emissiveColor",void 0),u([d({type:m3,json:{write:!0}})],Hd.prototype,"emissiveTexture",void 0),u([d({type:m3,json:{write:!0}})],Hd.prototype,"occlusionTexture",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],Hd.prototype,"metallic",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],Hd.prototype,"roughness",void 0),u([d({type:m3,json:{write:!0}})],Hd.prototype,"metallicRoughnessTexture",void 0),Hd=uU=u([R("esri.geometry.support.MeshMaterialMetallicRoughness")],Hd);const The=Hd;var NR;const Hb=le.getLogger("esri.geometry.support.MeshVertexAttributes");let va=NR=class extends ge{constructor(t){super(t),this.color=null,this.position=new Float64Array(0),this.uv=null,this.normal=null,this.tangent=null}castColor(t){return Wb(t,Uint8Array,[Uint8ClampedArray],{loggerTag:".color=",stride:4},Hb)}castPosition(t){return t&&t instanceof Float32Array&&Hb.warn(".position=","Setting position attribute from a Float32Array may cause precision problems. Consider storing data in a Float64Array or a regular number array"),Wb(t,Float64Array,[Float32Array],{loggerTag:".position=",stride:3},Hb)}castUv(t){return Wb(t,Float32Array,[Float64Array],{loggerTag:".uv=",stride:2},Hb)}castNormal(t){return Wb(t,Float32Array,[Float64Array],{loggerTag:".normal=",stride:3},Hb)}castTangent(t){return Wb(t,Float32Array,[Float64Array],{loggerTag:".tangent=",stride:4},Hb)}clone(){const t={position:ie(this.position),uv:ie(this.uv),normal:ie(this.normal),tangent:ie(this.tangent),color:ie(this.color)};return new NR(t)}clonePositional(){const t={position:ie(this.position),normal:ie(this.normal),tangent:ie(this.tangent),uv:this.uv,color:this.color};return new NR(t)}};function hU(t,e,i,r){const{loggerTag:s,stride:n}=e;return t.length%n!=0?(r.error(s,`Invalid array length, expected a multiple of ${n}`),new i([])):t}function Wb(t,e,i,r,s){if(!t)return t;if(t instanceof e)return hU(t,r,e,s);for(const n of i)if(t instanceof n)return hU(new e(t),r,e,s);if(Array.isArray(t))return hU(new e(t),r,e,s);{const n=i.map(o=>`'${o.name}'`);return s.error(`Failed to set property, expected one of ${n}, but got ${t.constructor.name}`),new e([])}}function g3(t,e,i){e[i]=Eqe(t)}function Eqe(t){const e=new Array(t.length);for(let i=0;i<t.length;i++)e[i]=t[i];return e}u([d({json:{write:g3}})],va.prototype,"color",void 0),u([ut("color")],va.prototype,"castColor",null),u([d({nonNullable:!0,json:{write:g3}})],va.prototype,"position",void 0),u([ut("position")],va.prototype,"castPosition",null),u([d({json:{write:g3}})],va.prototype,"uv",void 0),u([ut("uv")],va.prototype,"castUv",null),u([d({json:{write:g3}})],va.prototype,"normal",void 0),u([ut("normal")],va.prototype,"castNormal",null),u([d({json:{write:g3}})],va.prototype,"tangent",void 0),u([ut("tangent")],va.prototype,"castTangent",null),va=NR=u([R("esri.geometry.support.MeshVertexAttributes")],va);const Vat=va;var y3;const Oqe=le.getLogger("esri.geometry.support.MeshComponent");let Wd=y3=class extends ge{constructor(t){super(t),this.faces=null,this.material=null,this.shading="source",this.trustSourceNormals=!1}static from(t){return Bv(y3,t)}castFaces(t){return Wb(t,Uint32Array,[Uint16Array],{loggerTag:".faces=",stride:3},Oqe)}castMaterial(t){return Bv(t&&typeof t=="object"&&("metallic"in t||"roughness"in t||"metallicRoughnessTexture"in t)?The:cU,t)}clone(){return new y3({faces:ie(this.faces),shading:this.shading,material:ie(this.material),trustSourceNormals:this.trustSourceNormals})}cloneWithDeduplication(t,e){const i={faces:ie(this.faces),shading:this.shading,material:this.material?this.material.cloneWithDeduplication(t,e):null,trustSourceNormals:this.trustSourceNormals};return new y3(i)}};u([d({json:{write:!0}})],Wd.prototype,"faces",void 0),u([ut("faces")],Wd.prototype,"castFaces",null),u([d({type:cU,json:{write:!0}})],Wd.prototype,"material",void 0),u([ut("material")],Wd.prototype,"castMaterial",null),u([d({type:String,json:{write:!0}})],Wd.prototype,"shading",void 0),u([d({type:Boolean})],Wd.prototype,"trustSourceNormals",void 0),Wd=y3=u([R("esri.geometry.support.MeshComponent")],Wd);const Rqe=Wd,UR=le.getLogger("esri.geometry.support.meshUtils.normalProjection");function Iqe(t,e,i,r,s){return BR(r)?(jR(0,Wt.fromTypedArray(t),ir.fromTypedArray(e),ir.fromTypedArray(i),r,Wt.fromTypedArray(s)),s):(UR.error("Cannot convert spatial reference to PCPF"),s)}function Nat(t,e,i,r,s){return BR(r)?(jR(1,Wt.fromTypedArray(t),ir.fromTypedArray(e),ir.fromTypedArray(i),r,Wt.fromTypedArray(s)),s):(UR.error("Cannot convert to spatial reference from PCPF"),s)}function Uat(t,e,i){return Mi(t,e,0,i,DP(e),0,t.length/3),i}function jat(t,e,i){return Mi(t,DP(i),0,e,i,0,t.length/3),e}function Dqe(t,e,i){if(A(t))return e;const r=ir.fromTypedArray(t),s=ir.fromTypedArray(e);return qT(s,r,i),e}function Fqe(t,e,i){if(A(t))return e;X_(Yr,i);const r=Wt.fromTypedArray(t),s=Wt.fromTypedArray(e);return H0(s,r,Yr),wV(Yr)||x7(s,s),e}function Lqe(t,e,i){if(A(t))return e;X_(Yr,i);const r=Wt.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),s=Wt.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT);if(H0(s,r,Yr),wV(Yr)||x7(s,s),t!==e)for(let n=3;n<t.length;n+=4)e[n]=t[n];return e}function kqe(t,e,i,r,s){if(!BR(r))return UR.error("Cannot convert spatial reference to PCPF"),s;jR(0,Wt.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),ir.fromTypedArray(e),ir.fromTypedArray(i),r,Wt.fromTypedArray(s,4*Float32Array.BYTES_PER_ELEMENT));for(let n=3;n<t.length;n+=4)s[n]=t[n];return s}function Bat(t,e,i,r,s){if(!BR(r))return UR.error("Cannot convert to spatial reference from PCPF"),s;jR(1,Wt.fromTypedArray(t,16),ir.fromTypedArray(e),ir.fromTypedArray(i),r,Wt.fromTypedArray(s,16));for(let n=3;n<t.length;n+=4)s[n]=t[n];return s}function jR(t,e,i,r,s,n){if(!e)return;const o=i.count,a=DP(s);if(Che(s))for(let l=0;l<o;l++)r.getVec(l,GR),e.getVec(l,eh),rc(a,GR,qR,a),Ka(Yr,qR),t===1&&el(Yr,Yr),fo(eh,eh,Yr),n.setVec(l,eh);else for(let l=0;l<o;l++){r.getVec(l,GR),e.getVec(l,eh),rc(a,GR,qR,a),Ka(Yr,qR);const c=_M(i.get(l,1));let h=Math.cos(c);t===0&&(h=1/h),Yr[0]*=h,Yr[1]*=h,Yr[2]*=h,Yr[3]*=h,Yr[4]*=h,Yr[5]*=h,t===1&&el(Yr,Yr),fo(eh,eh,Yr),_e(eh,eh),n.setVec(l,eh)}return n}function BR(t){return Che(t)||zqe(t)}function Che(t){return t.isWGS84||i1e(t)||$h(t)||Eh(t)}function zqe(t){return t.isWebMercator}const GR=$(),eh=$(),qR=be(),Yr=Ai();function Vqe(t){switch(t){case"multiply":default:return 1;case"ignore":return 2;case"replace":return 3;case"tint":return 4}}function Mhe(t,e,i){if(A(t)||e===2)return i[0]=255,i[1]=255,i[2]=255,void(i[3]=255);const r=Re(Math.round(t[3]*HR),0,HR),s=r===0||e===4?0:e===3?Nqe:Uqe;i[0]=Re(Math.round(t[0]*Zb),0,Zb),i[1]=Re(Math.round(t[1]*Zb),0,Zb),i[2]=Re(Math.round(t[2]*Zb),0,Zb),i[3]=r+s}const Zb=255,HR=85,Nqe=HR,Uqe=2*HR;function jqe(t){const e=new pi;return e.include(Ss,{linearDepth:!1}),e.include(iv,t),e.include(Kce,he(E({},t),{stippleRequiresStretchMeasure:!1})),e.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.stippleEnabled&&(e.vertex.uniforms.add("ndcToPixel","vec2"),e.attributes.add("uv0","vec2"),e.attributes.add("auxpos1","vec3")),e.attributes.add("position","vec3"),e.varyings.add("vpos","vec3"),e.vertex.code.add(x`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),t.stippleEnabled&&(e.vertex.code.add(x`vec4 vpos2 = transformPosition(proj, view, auxpos1);
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),t.draped||e.vertex.code.add(x`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),e.vertex.code.add(x`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),t.draped?e.vertex.code.add(x`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):e.vertex.code.add(x`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),e.vertex.code.add(x`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),e.vertex.code.add(x`}`),t.output===4&&e.include(Dd),e.include(Zi,t),e.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),e.fragment.code.add(x`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${t.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${x.float(tn)}) {
      discard;
    }

    ${t.output===0?x`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===4?x`outputHighlight();`:""}
  }
  `),e}const Bqe=Object.freeze({__proto__:null,build:jqe});class WR extends Si{constructor(e,i,r){super(e,i,r),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==4}initializeProgram(e){const i=WR.shader.get(),r=this.configuration,s=i.build({output:r.output,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:r.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:r.stippleOffColorEnabled,stippleRequiresClamp:!1,stippleScaleWithLineWidth:!1,stipplePreferContinuous:r.stipplePreferContinuous});return new fi(e.rctx,s,Ht)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,i){if(Pc(this.program,i.camera.projectionMatrix),this.stipplePattern!==e.stipplePattern){const r=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,r),this.stipplePattern=r}if(this.stippleEnabled){const{pixelSize:r,sdfNormalizer:s,pixels:n}=_(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};this.program.setUniform1f("stipplePatternSDFNormalizer",s),this.program.setUniform1f("stipplePatternTextureSize",n),this.program.setUniform1f("stipplePatternPixelSize",r),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/i.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/i.camera.perScreenPixelRatio),this.program.setUniform2f("ndcToPixel",i.camera.fullViewport[2]/2,i.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",e.color),this.program.setUniform1f("alphaCoverage",Math.min(1,e.width*i.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const r=at(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",r[0],r[1],r[2],r.length>3?r[3]:1)}this.configuration.output===4&&Fd(this.program,i)}bindDraw(e){Yf(this.program,e),this.stippleEnabled&&!this.configuration.draped&&Qf(this.program,e.origin,e.camera.viewInverseTransposeMatrix),_m(this.program,this.configuration,e),this.program.rebindTextures()}initializePipeline(){const e=this.configuration,i=Xs(770,1,771,771),r=(s,n=null,o=null)=>_t({blending:n,depthTest:eue,depthWrite:o,colorWrite:Pt,stencilWrite:e.sceneHasOcludees?$m:null,stencilTest:e.sceneHasOcludees?s?kb:Q0:null});return e.output===0?(this._occludeePipelineState=r(!0,e.transparent||this.stippleEnabled?i:null,$o),r(!1,e.transparent||this.stippleEnabled?i:null,$o)):r(!1)}get primitiveType(){return 1}getPipelineState(e,i){return i?this._occludeePipelineState:super.getPipelineState(e,i)}}WR.shader=new vi(Bqe,()=>import("./NativeLine.glsl.a432a7e1.js"));class th extends tr{constructor(){super(...arguments),this.output=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.sceneHasOcludees=!1}}u([X({count:8})],th.prototype,"output",void 0),u([X()],th.prototype,"slicePlaneEnabled",void 0),u([X()],th.prototype,"vertexColors",void 0),u([X()],th.prototype,"transparent",void 0),u([X()],th.prototype,"draped",void 0),u([X()],th.prototype,"stippleEnabled",void 0),u([X()],th.prototype,"stippleOffColorEnabled",void 0),u([X()],th.prototype,"stipplePreferContinuous",void 0),u([X()],th.prototype,"sceneHasOcludees",void 0);const Gqe=le.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");class Phe extends Id{constructor(e){super(e,Wqe),this._techniqueConfig=new th}getTechniqueConfig(e,i){this._techniqueConfig.output=e,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.vertexColors=this.parameters.vertexColors,this._techniqueConfig.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._techniqueConfig.draped=i.slot===20;const r=_(this.parameters.stipplePattern);return this._techniqueConfig.stippleEnabled=r,this._techniqueConfig.stippleOffColorEnabled=r&&_(this.parameters.stippleOffColor),this._techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this._techniqueConfig.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._techniqueConfig}getPassParameters(){return this.parameters}intersect(e,i,r,s,n,o,a,l,c){_(c)?mNe(e,s,c,o,1,a):this.intersectLineGeometry(e,i,r,s,a)}intersectLineGeometry(e,i,r,s,n){if(!s.options.selectionMode||pT(i))return;if(!Hne(r))return void Gqe.error("intersection assumes a translation-only matrix");const o=e.vertexAttributes.get("position").data,a=s.camera,l=Jqe;os(l,s.point);const c=2;ne(v3[0],l[0]-c,l[1]+c,0),ne(v3[1],l[0]+c,l[1]+c,0),ne(v3[2],l[0]+c,l[1]-c,0),ne(v3[3],l[0]-c,l[1]-c,0);for(let y=0;y<4;y++)if(!a.unprojectFromRenderScreen(v3[y],Zd[y]))return;Us(a.eye,Zd[0],Zd[1],dU),Us(a.eye,Zd[1],Zd[2],pU),Us(a.eye,Zd[2],Zd[3],fU),Us(a.eye,Zd[3],Zd[0],mU);let h=Number.MAX_VALUE,p=0;for(let y=0;y<o.length-5;y+=3){if(xn[0]=o[y]+r[12],xn[1]=o[y+1]+r[13],xn[2]=o[y+2]+r[14],Sn[0]=o[y+3]+r[12],Sn[1]=o[y+4]+r[13],Sn[2]=o[y+5]+r[14],hi(dU,xn)<0&&hi(dU,Sn)<0||hi(pU,xn)<0&&hi(pU,Sn)<0||hi(fU,xn)<0&&hi(fU,Sn)<0||hi(mU,xn)<0&&hi(mU,Sn)<0)continue;if(a.projectToRenderScreen(xn,ov),a.projectToRenderScreen(Sn,av),ov[2]<0&&av[2]>0){ue(ih,xn,Sn);const b=a.frustum,w=-hi(b[4],xn)/ye(ih,Li(b[4]));se(ih,ih,w),de(xn,xn,ih),a.projectToRenderScreen(xn,ov)}else if(ov[2]>0&&av[2]<0){ue(ih,Sn,xn);const b=a.frustum,w=-hi(b[4],Sn)/ye(ih,Li(b[4]));se(ih,ih,w),de(Sn,Sn,ih),a.projectToRenderScreen(Sn,av)}else if(ov[2]<0&&av[2]<0)continue;ov[2]=0,av[2]=0;const v=M6(gy(ov,av,Ehe),l);v<h&&(h=v,re(Ahe,xn),re($he,Sn),p=y/3)}const f=s.rayBegin,g=s.rayEnd;if(h<c*c){let y=Number.MAX_VALUE;if(KJ(gy(Ahe,$he,Ehe),gy(f,g,Zqe),nv)){ue(nv,nv,f);const v=Te(nv);se(nv,nv,1/v),y=v/qt(f,g)}n(y,nv,p,!1)}}computeAttachmentOrigin(e,i){const r=e.vertexAttributes;if(!r)return!1;const s=r.get("position");return OV(s,null,!1,i)}requiresSlot(e){return e===2||e===20}createGLMaterial(e){return e.output===0||e.output===4?new qqe(e):null}createBufferWriter(){const e=this.parameters.vertexColors?gue:Uje;return A(this.parameters.stipplePattern)?new _R(e):new Hqe(e.clone().vec3f("auxpos1").vec2f("uv0"))}}class qqe extends vm{updateParameters(e){return this.ensureTechnique(WR,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output===0&&this._updateOccludeeState(e),this.updateParameters(e)}bind(e,i){i.bindPass(this._material.getPassParameters(),e)}}class Hqe{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,i,r,s){BO(i,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,s),this.writeAuxpos1(e,i,r,s),this.writeUV0(e,i,r,s)}writeAuxpos1(e,i,r,s){const n=r.getField("auxpos1",Wt),o=i.indices.get("position"),a=i.vertexAttributes.get("position").data,l=e.transformation,c=n.typedBufferStride,h=n.typedBuffer;s*=c;for(let p=0;p<o.length-1;p+=2)for(const f of[1,0]){const g=3*o[p+f],y=a[g],v=a[g+1],b=a[g+2],w=l[0]*y+l[4]*v+l[8]*b+l[12],S=l[1]*y+l[5]*v+l[9]*b+l[13],T=l[2]*y+l[6]*v+l[10]*b+l[14];h[s]=w,h[s+1]=S,h[s+2]=T,s+=c}}writeUV0(e,i,r,s){var n;const o=r.getField("uv0",rl),a=i.indices.get("position"),l=i.vertexAttributes.get("position").data,c=(n=i.vertexAttributes.get("distanceToStart"))==null?void 0:n.data,h=e.transformation,p=o.typedBufferStride,f=o.typedBuffer;let g=0;f[s*=p]=0,f[s+1]=g,s+=p;const y=3*a[0],v=ne(xn,l[y],l[y+1],l[y+2]);h&&Oe(v,v,h);const b=Sn,w=a.length-1;let S=1;const T=c?(M,P,F)=>g=c[F]:(M,P,F)=>g+=qt(M,P);for(let M=1;M<w;M+=2){const P=3*a[M];ne(b,l[P],l[P+1],l[P+2]),h&&Oe(b,b,h),T(v,b,S++);for(let F=0;F<2;++F)f[s]=1-F,f[s+1]=g,s+=p;re(v,b)}const C=3*a[w];ne(b,l[C],l[C+1],l[C+2]),h&&Oe(b,b,h),T(v,b,S),f[s]=1,f[s+1]=g}}const Wqe=E({color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleOffColor:null,stipplePreferContinuous:!0,sceneHasOcludees:!1},Gu),xn=$(),Sn=$(),ih=$(),nv=$(),ov=ys(),av=ys(),Ahe=$(),$he=$(),Ehe=ff(),Zqe=ff(),Jqe=$(),v3=[ys(),ys(),ys(),ys()],Zd=[$(),$(),$(),$()],dU=Mt(),pU=Mt(),fU=Mt(),mU=Mt(),Qqe=["mesh"];class Yqe extends Zu{constructor(e,i,r,s){super(e,i,r,s),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){Kt.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new Phe({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new Phe({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),e=>e.material)),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(e){const i=e.graphic;if(!this._validateGeometry(i.geometry,Qqe,"fill on mesh-3d"))return null;const r=this.setGraphicElevationContext(i,new ma),s=e.renderingInfo;return this._createAs3DShape(i,s,r,i.uid)}layerOpacityChanged(e,i){const r=this._getLayerOpacity();return this._materials.forEach(s=>{s.material.setParameters({layerOpacity:r});const n=s.material.parameters;this._setMaterialTransparentParameter(n,s),s.material.setParameters({transparent:n.transparent})}),e.forEach(s=>{const n=i(s);_(n)&&n.layerOpacityChanged(r,this._context.isAsync)}),!0}layerElevationInfoChanged(e,i){return this.updateGraphics3DGraphicElevationInfo(e,i,Cm)}slicePlaneEnabledChanged(e,i){return this._materials.forEach(r=>{r.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})}),e.forEach(r=>{const s=i(r);_(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._materials.forEach(i=>i.material.setParameters({usePBR:e})),!0}pixelRatioChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return A(e)?"-":e instanceof Ae?e.toHex():e.contentHash}_materialPropertiesDefault(e,i){const r=this._requiresSymbolVertexColors(),s=!!e.vertexAttributes.color,n=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:r,hasVertexColors:s,hasVertexTangents:n,uid:`vc:${s},vt:${n},vct${i},svc:${r}`}}_materialProperties(e,i,r){const s=this._materialPropertiesDefault(e,r);if(!i.material)return s;const{color:n,colorTexture:o,normalTexture:a,doubleSided:l,alphaCutoff:c,alphaMode:h}=i.material,p=this._colorOrTextureUid(n),f=this._colorOrTextureUid(o),g=this._colorOrTextureUid(a);if(s.color=n,s.colorTexture=o,s.normalTexture=a,s.uid=`${s.uid},cmuid:${p},ctmuid:${f},ntmuid:${g},ds:${l},ac:${c},am:${h}`,i.material instanceof The){const{metallic:y,roughness:v,metallicRoughnessTexture:b,emissiveColor:w,emissiveTexture:S,occlusionTexture:T}=i.material,C=this._colorOrTextureUid(b),M=this._colorOrTextureUid(w),P=this._colorOrTextureUid(S),F=this._colorOrTextureUid(T);s.metallic=y,s.roughness=v,s.metallicRoughnessTexture=b,s.emissiveColor=w,s.emissiveTexture=S,s.occlusionTexture=T,s.uid=`${s.uid},mrm:${y},mrr:${v},mrt:${C},emuid:${M},etmuid:${P},otmuid:${F}`}return s}_setInternalColorValueParameters(e,i){i.diffuse=Ae.toUnitRGB(e),i.opacity=e.a}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e){const i=this._getInternalTexture(e,1);return _(i)?i.id:null}_getInternalTexture(e,i){const r=this._getLoadableTextureResource(e);if(!r)return null;const s=`${e.contentHash}/${i}`;let n=this._textures.get(s);return n||(n=new Mr(r,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:i!==1}),this._textures.set(s,n),this._context.stage.add(n),this._context.stage.loadSynchronous(n)),n}_castTextureWrap(e="repeat"){if(typeof e=="string"){const i=this._castTextureWrapIndividual(e);return{s:i,t:i}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return 33071;case"mirror":return 33648;default:return 10497}}_setInternalMaterialParameters(e,i){if(_(e.color)&&this._setInternalColorValueParameters(e.color,i),_(e.colorTexture)){const r=this._getInternalTexture(e.colorTexture,i.textureAlphaMode);_(r)?(i.textureId=r.id,i.textureAlphaPremultiplied=!!r.params.preMultiplyAlpha):i.textureId=void 0}_(e.normalTexture)&&(i.normalTextureId=this._getInternalTextureId(e.normalTexture)),_(e.emissiveColor)&&(i.emissiveFactor=Ae.toUnitRGB(e.emissiveColor)),_(e.emissiveTexture)&&(i.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),_(e.occlusionTexture)&&(i.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),_(e.metallicRoughnessTexture)&&(i.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture))}_setExternalMaterialParameters(e){const i=this._drivenProperties.color;let r=_(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(i)e.externalColor=wu;else{const s=_(this.symbolLayer.material)?this.symbolLayer.material.color:null;_(s)?e.externalColor=Ae.toUnitRGBA(s):(r=null,e.externalColor=wu)}r&&(e.colorMixMode=r),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const i=e.vertexAttributes.color;if(A(i))return!1;for(let r=3;r<i.length;r+=4)if(i[r]!==255)return!0;return!1}_getOrCreateMaterial(e,i){var r,s,n;const o=(r=i.material)==null?void 0:r.color,a=(s=i.material)==null?void 0:s.colorTexture,l=(n=i.material)==null?void 0:n.alphaMode,c=l==="blend",h=l!=="opaque"&&(this._hasTransparentVertexColors(e)||_(o)&&o.a<1||_(a)&&a.transparent||c),p=this._materialProperties(e,i,h),f=this._materials.get(p.uid);if(f)return f.material;const g={material:null,isComponentTransparent:h,alphaMode:i.material?i.material.alphaMode:"opaque"},y=p.metallicRoughnessTexture==null&&p.metallic==null&&p.roughness==null,v={usePBR:this._usePBR(),isSchematic:y,vertexColors:p.hasVertexColors,symbolColors:p.hasSymbolVertexColors,vertexTangents:p.hasVertexTangents,ambient:Fn,diffuse:Kc,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:0,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};y||(v.mrrFactors=[p.metallic!=null?p.metallic:1,p.roughness!=null?p.roughness:1,.5]),i.material&&(v.doubleSided=i.material.doubleSided,v.cullFace=i.material.doubleSided?0:2,v.textureAlphaCutoff=i.material.alphaCutoff),this._setExternalMaterialParameters(v),this._setMaterialTransparentParameter(v,g),this._setInternalMaterialParameters(p,v);const b=new sv(v);return g.material=b,this._materials.set(p.uid,g),this._context.stage.add(b),b}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,i){e.transparent=this.needsDrivenTransparentPass||i.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,i.alphaMode==="auto"?e.textureAlphaMode=e.transparent?3:1:e.textureAlphaMode=i.alphaMode==="opaque"?1:i.alphaMode==="mask"?2:0}_addDebugNormals(e,i,r,s){const n=i.length,o=e.spatialReference.isGeographic?20015077/180:1,a=.1*Math.max(e.extent.width*o,e.extent.height*o,e.extent.zmax-e.extent.zmin),l=[],c=[],h=[],p=[];for(let y=0;y<n;y++){const v=i[y],b=v.vertexAttributes.get("position"),w=v.vertexAttributes.get("normal"),S=v.indices.get("position"),T=v.indices.get("normal"),C=b.data,M=w.data;for(let P=0;P<S.length;P++){const F=3*S[P],z=3*T[P];for(let D=0;D<3;D++)l.push(C[F+D]);for(let D=0;D<3;D++)l.push(C[F+D]+M[z+D]*a);if(c.push(c.length),c.push(c.length),P%3==0){this._calculateFaceNormal(C,S,P,Yb),this._getFaceVertices(C,S,P,Ms,Jb,Qb),de(Ms,Ms,Jb),de(Ms,Ms,Qb),se(Ms,Ms,1/3);for(let D=0;D<3;D++)h.push(Ms[D]);for(let D=0;D<3;D++)h.push(Ms[D]+Yb[D]*a);p.push(p.length),p.push(p.length)}}}const f=new zi([["position",{data:l,size:3,exclusive:!0}]],[["position",new Uint32Array(c)]],2);i.push(f),r.push(this._debugVertexNormalMaterial),s.push(my(s[0]));const g=new zi([["position",{data:h,size:3,exclusive:!0}]],[["position",new Uint32Array(p)]],2);i.push(g),r.push(this._debugFaceNormalMaterial),s.push(my(s[0]))}_createAs3DShape(e,i,r,s){const n=e.geometry;if(n.type!=="mesh")return null;const o=this._createGeometryInfo(n,i);if(!o)return null;const{geometries:a,materials:l,transformations:c,objectTransformation:h}=o;Kt.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,a,l,c);const p=new Nd({geometries:a,materials:l,transformations:c,metadata:{layerUid:this._context.layer.uid,graphicUid:s}});p.transformation=h;const f=this._createEdgeMaterial(),g=_(f)?{baseMaterial:l[0],edgeMaterials:[f],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,y=new Wu(this,p,a,null,null,jT,r,g);return y.needsElevationUpdates=Cm(r.mode),y.useObjectOriginAsAttachmentOrigin=!0,y.elevationContext.centerPointInElevationSR=this.getCenterPointInElevationSR(p),y.alignedSampledElevation=jT(y,y.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),y}getCenterPointInElevationSR(e){const i=Ld(0,0,0,this._context.elevationProvider.spatialReference);return bJ([e.transformation[12],e.transformation[13],e.transformation[14]],this._context.renderCoordsHelper.spatialReference,i),i}_createComponentNormals(e,i,r,s){switch(r.shading||"flat"){case"source":return this._createComponentNormalsSource(e,i,r,s);case"flat":return this._createComponentNormalsFlat(e,s);case"smooth":return this._createComponentNormalsSmooth(e,s);default:return}}_createComponentNormalsSource(e,i,r,s){if(A(i))return this._createComponentNormalsFlat(e,s);let n=!1;if(!r.trustSourceNormals)for(let o=0;o<s.length;o+=3){this._calculateFaceNormal(e,s,o,Yb);for(let a=0;a<3;a++){const l=3*s[o+a];Ms[0]=i[l+0],Ms[1]=i[l+1],Ms[2]=i[l+2],ye(Yb,Ms)<0&&(i[l+0]=-i[l+0],i[l+1]=-i[l+1],i[l+2]=-i[l+2],n=!0)}}return{normals:i,indices:s,didFlipNormals:n}}_createComponentNormalsFlat(e,i){const r=new Float32Array(i.length),s=new Uint32Array(3*i.length);for(let n=0;n<i.length;n+=3){const o=this._calculateFaceNormal(e,i,n,Yb);for(let a=0;a<3;a++)r[n+a]=o[a],s[n+a]=n/3}return{normals:r,indices:s,didFlipNormals:!1}}_createComponentNormalsSmooth(e,i){const r={};for(let o=0;o<i.length;o+=3){const a=this._calculateFaceNormal(e,i,o,Yb);for(let l=0;l<3;l++){const c=i[o+l];let h=r[c];h||(h={normal:$(),count:0},r[c]=h),de(h.normal,h.normal,a),h.count++}}const s=new Float32Array(3*i.length),n=new Uint32Array(3*i.length);for(let o=0;o<i.length;o++){const a=r[i[o]];a.count!==1&&(_e(a.normal,a.normal),a.count=1);for(let l=0;l<3;l++)s[3*o+l]=a.normal[l];n[o]=o}return{normals:s,indices:n,didFlipNormals:!1}}_getFaceVertices(e,i,r,s,n,o){const a=3*i[r+0],l=3*i[r+1],c=3*i[r+2];s[0]=e[a+0],s[1]=e[a+1],s[2]=e[a+2],n[0]=e[l+0],n[1]=e[l+1],n[2]=e[l+2],o[0]=e[c+0],o[1]=e[c+1],o[2]=e[c+2]}_calculateFaceNormal(e,i,r,s){return this._getFaceVertices(e,i,r,Ms,Jb,Qb),ue(Jb,Jb,Ms),ue(Qb,Qb,Ms),Ye(Ms,Jb,Qb),_e(s,Ms),s}_getOrCreateComponents(e){return e.components?e.components:Xqe}_createPositionBuffer(e,i){let r=e.vertexAttributes.position;const s=i.reprojection===1?i.transformBeforeProject:null;if(_(s)&&(r=Dqe(r,new Float64Array(r.length),s)),i.reprojection===0)return i.needsBufferCopy?new Float64Array(r):r;const n=_(s)?r:new Float64Array(r.length);return Mi(r,e.spatialReference,0,n,this._context.renderCoordsHelper.spatialReference,0,r.length/3),n}_createNormalBuffer(e,i,r){let s=e.vertexAttributes.normal;if(A(s))return null;const n=r.reprojection===1?r.transformBeforeProject:null;if(_(n)&&(s=Fqe(s,new Float32Array(s.length),n)),this._context.layerView.view.viewingMode==="local"||r.reprojection===0)return r.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const o=e.vertexAttributes.position,a=_(n)?s:new Float32Array(s.length);return Iqe(s,o,i,e.spatialReference,a)}_createTangentBuffer(e,i,r){let s=e.vertexAttributes.tangent;if(A(s))return null;const n=r.reprojection===1?r.transformBeforeProject:null;if(_(n)&&(s=Lqe(s,new Float32Array(s.length),n)),this._context.layerView.view.viewingMode==="local"||r.reprojection===0)return r.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const o=e.vertexAttributes.position,a=_(n)?s:new Float32Array(s.length);return kqe(s,o,i,e.spatialReference,a)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const i=this._getVertexOpacityAndColor(e),r=Vqe(or(this.symbolLayer,"material","colorMixMode")),s=new Uint8Array(4);return Mhe(i,r,s),s}return null}_createBuffers(e,i){const r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const s=e.vertexAttributes.normal,n=e.vertexAttributes.uv,o=e.vertexAttributes.tangent;if(_(s)&&s.length!==r.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(_(o)&&o.length/4!=r.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(_(n)&&n.length/2!=r.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(e),l=this._createPositionBuffer(e,a),c=this._createColorBuffer(e),h=this._createSymbolColorBuffer(i),p=this._createNormalBuffer(e,l,a),f=this._createTangentBuffer(e,l,a);return{positionBuffer:l,normalBuffer:p,tangentBuffer:f,uvBuffer:n,colorBuffer:c,symbolColorBuffer:h,objectTransformation:a.reprojection===0&&_(a.objectTransformation)?a.objectTransformation:this._transformOriginLocal(e,l,p,f),geometryTransformation:a.reprojection===0&&_(a.geometryTransformation)?a.geometryTransformation:be()}}_computeReprojectionInfo(e){const i=_(e.transform)&&e.transform.geographic||this._context.renderCoordsHelper.viewingMode===2?0:1;let r=null;if(_(e.transform)){if(i===0){const s=be();return rc(e.spatialReference,e.transform.origin,s,this._context.renderCoordsHelper.spatialReference),{reprojection:i,objectTransformation:s,geometryTransformation:my(e.transform.localMatrix),needsBufferCopy:!1}}return r=sJ(be(),e.transform.origin),wi(r,r,e.transform.localMatrix),{reprojection:i,transformBeforeProject:r,needsBufferCopy:!0}}return{reprojection:i,needsBufferCopy:!0}}_transformOriginLocal(e,i,r,s){const n=this._context.renderCoordsHelper.spatialReference,o=e.anchor;ZR[0]=o.x,ZR[1]=o.y,ZR[2]=o.z;const a=be();rc(e.spatialReference,ZR,a,n);const l=ir.fromTypedArray(i);if(Fi(Ohe,a),qT(l,l,Ohe),_(r)||_(s)){if(Ka(_3,a),el(_3,_3),_(r)){const c=Wt.fromTypedArray(r);H0(c,c,_3)}if(_(s)){const c=Wt.fromTypedArray(s,4*s.BYTES_PER_ELEMENT);H0(c,c,_3)}}return a}_validateFaces(e,i){const r=e.vertexAttributes.position.length/3,s=i.faces;if(s){let n=-1;for(let o=0;o<s.length;o++){const a=s[o];a>n&&(n=a)}if(r<=n)return this.logger.warn(`Vertex index ${n} is out of bounds of the mesh position buffer`),!1}else if(r%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,i){return i.faces?i.faces:lb(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return!1;const r=this._context.elevationProvider.spatialReference;let s;const n=i.length/3;return e.spatialReference.equals(r)?s=i:(s=new Float64Array(i.length),Mi(e.vertexAttributes.position,e.spatialReference,0,s,r,0,n)),ii(gU),Ql(gU,s,0,n),!Xl(gU,this._context.clippingExtent)}_createGeometryInfo(e,i){if(!O1(e.spatialReference,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const r=this._createBuffers(e,i);if(A(r))return null;const{positionBuffer:s,uvBuffer:n,colorBuffer:o,symbolColorBuffer:a,normalBuffer:l,tangentBuffer:c,objectTransformation:h,geometryTransformation:p}=r,f=this._getOrCreateComponents(e),g=[],y=[],v=[];let b=!1;for(const w of f){if(!this._validateFaces(e,w))return null;const S=this._getOrCreateFaces(e,w);if(S.length===0)continue;const T=this._createComponentNormals(s,l,w,S);T.didFlipNormals&&(b=!0);const C=[["position",{size:3,data:s,exclusive:!0}],["normal",{size:3,data:T.normals,exclusive:!0}]],M=[["position",S],["normal",T.indices]];_(o)&&(C.push(["color",{size:4,data:o,exclusive:!0}]),M.push(["color",S])),_(a)&&(C.push(["symbolColor",{size:4,data:a,exclusive:!0}]),M.push(["symbolColor",new Uint16Array(S.length)])),_(n)&&(C.push(["uv0",{size:2,data:n,exclusive:!0}]),M.push(["uv0",S])),_(c)&&(C.push(["tangent",{size:4,data:c,exclusive:!0}]),M.push(["tangent",S]));const P=new zi(C,M);g.push(P),y.push(p),v.push(this._getOrCreateMaterial(e,w))}return b&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:g,transformations:y,materials:v,objectTransformation:h}}_createEdgeMaterial(){const e={opacity:this._getLayerOpacity()};return _ce(this.symbolLayer,e)}}const ZR=$(),Ms=$(),Jb=$(),Qb=$(),Yb=$(),Ohe=be(),_3=Ai(),gU=lr(),Xqe=[new Rqe];class Kqe{constructor(e,i,r,s){this.graphics3DSymbolLayer=e,this.instanceIndex=i,this.elevationAligner=r,this.elevationContext=s,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const i=this.lodRenderer.instanceData;e!==i.getVisible(this.instanceIndex)&&i.setVisible(this.instanceIndex,e)}destroy(){this.instanceIndex!=null&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,i,r){if(this.elevationAligner){d7(this.elevationContext.featureExpressionInfoContext,r);const s=this.elevationAligner(this,this.elevationContext,e,i);_(s)&&(this.alignedSampledElevation=s)}}getCenterObjectSpace(e=$()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,rh),Oe(e,this.lodRenderer.baseBoundingSphere.center,rh)}getBoundingBoxObjectSpace(e=lr()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,rh);const i=this.lodRenderer.baseBoundingBox;ii(e);for(let r=0;r<8;++r)ne(fl,(1&r)==0?i[0]:i[3],(2&r)==0?i[1]:i[4],(4&r)==0?i[2]:i[5]),Oe(fl,fl,rh),uu(e,fl);return e}computeAttachmentOrigin(e){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,rh),e.render.origin[0]+=rh[12],e.render.origin[1]+=rh[13],e.render.origin[2]+=rh[14],e.render.num++}async getProjectedBoundingBox(e,i,r,s,n){const o=this.getBoundingBoxObjectSpace(n),a=eHe,l=mP(o)?1:a.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,rh);for(let h=0;h<l;h++){const p=a[h];fl[0]=o[p[0]],fl[1]=o[p[1]],fl[2]=o[p[2]],Oe(fl,fl,rh),lv[3*h+0]=fl[0],lv[3*h+1]=fl[1],lv[3*h+2]=fl[2]}if(!e(lv,0,l))return null;ii(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],lv[h+p]),o[p+3]=Math.max(o[p+3],lv[h+p]);c&&r.push({location:lv.slice(h,h+3),screenSpaceBoundingRect:c})}if(i&&(Yl(o,yU),this.elevationContext.mode!=="absolute-height")){let h;const p=c7(o,i);try{h=await i.service.queryElevation(yU[0],yU[1],s,p,"ground")}catch{}_(h)&&WW(o,0,0,-this.alignedSampledElevation+h)}return o}addObjectState(e,i){if(e===0){const r=new tR(e);this.addHighlightId(r),i.addExternal(s=>{this.removeHighlightId(s)},r)}}removeObjectState(e){this._highlights.forEach(i=>e.remove(i))}addHighlightId(e){this._highlights.add(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}removeHighlightId(e){this._highlights.delete(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const lv=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],fl=$(),yU=$(),eHe=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],rh=be();function tHe(t){const e=[];return t.stageResources.geometries.forEach((i,r)=>{const s=t.stageResources.materials[r],n=t.stageResources.textures;e.push({material:s,geometry:i,textures:n})}),{components:e,minScreenSpaceRadius:t.lodThreshold,pivotOffset:t.pivotOffset}}function iHe(t){return{levels:t.map(e=>tHe(e))}}function rHe(t,e=nHe){const i=hUe(t);return Math.sqrt(i/(e*Math.PI))}function sHe(t){t.levels.forEach(e=>{e.minScreenSpaceRadius||(e.minScreenSpaceRadius=rHe(e))})}const nHe=.05;function Gat(t){return t=t||globalThis.location.hostname,aHe.some(e=>{var i;return((i=t)==null?void 0:i.match(e))!=null})}function oHe(t,e){return t&&(e=e||globalThis.location.hostname)?e.match(Rhe)!=null||e.match(Dhe)!=null?t.replace("static.arcgis.com","staticdev.arcgis.com"):e.match(Ihe)!=null||e.match(Fhe)!=null?t.replace("static.arcgis.com","staticqa.arcgis.com"):t:t}const Rhe=/^devext.arcgis.com$/,Ihe=/^qaext.arcgis.com$/,Dhe=/^[\w-]*\.mapsdevext.arcgis.com$/,Fhe=/^[\w-]*\.mapsqa.arcgis.com$/,aHe=[/^([\w-]*\.)?[\w-]*\.zrh-dev-local.esri.com$/,Rhe,Ihe,/^jsapps.esri.com$/,Dhe,Fhe];function lHe(t,e,i){if(t.count!==e.count)return void nR.error("source and destination buffers need to have the same number of elements");const r=t.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],g=i[9],y=i[10],v=i[11],b=i[12],w=i[13],S=i[14],T=i[15],C=t.typedBuffer,M=t.typedBufferStride,P=e.typedBuffer,F=e.typedBufferStride;for(let z=0;z<r;z++){const D=z*M,U=z*F,G=P[U],k=P[U+1],j=P[U+2],V=P[U+3];C[D]=s*G+l*k+f*j+b*V,C[D+1]=n*G+c*k+g*j+w*V,C[D+2]=o*G+h*k+y*j+S*V,C[D+3]=a*G+p*k+v*j+T*V}}function Lhe(t,e,i){if(t.count!==e.count)return void nR.error("source and destination buffers need to have the same number of elements");const r=t.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],g=t.typedBuffer,y=t.typedBufferStride,v=e.typedBuffer,b=e.typedBufferStride;for(let w=0;w<r;w++){const S=w*y,T=w*b,C=v[T],M=v[T+1],P=v[T+2],F=v[T+3];g[S]=s*C+a*M+h*P,g[S+1]=n*C+l*M+p*P,g[S+2]=o*C+c*M+f*P,g[S+3]=F}}function vU(t,e,i){const r=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=i*o[h],s[c+1]=i*o[h+1],s[c+2]=i*o[h+2],s[c+3]=i*o[h+3]}}function cHe(t,e,i){const r=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=o[h]>>i,s[c+1]=o[h+1]>>i,s[c+2]=o[h+2]>>i,s[c+3]=o[h+3]>>i}}Object.freeze({__proto__:null,transformMat4:lHe,transformMat3:Lhe,scale:vU,shiftRight:cHe});function uHe(t,e,i){const r=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=i?i.count:e.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<9;++p)r[l+p]=n[c+p];l+=s,c+=o}}Object.freeze({__proto__:null,copy:uHe});function hHe(t,e,i){const r=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=i?i.count:e.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<16;++p)r[l+p]=n[c+p];l+=s,c+=o}}Object.freeze({__proto__:null,copy:hHe});function dHe(t,e,i){const r=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=i?i.count:e.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],l+=s,c+=o}function JR(t,e){const i=t.count;e||(e=new t.TypedArrayConstructor(i));for(let r=0;r<i;r++)e[r]=t.get(r);return e}Object.freeze({__proto__:null,copy:dHe,makeDense:JR});function khe(t,e,i){const r=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=i?i.count:e.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],l+=s,c+=o}function zhe(t,e,i){const r=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=i?i.count:e.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;if(Eke(e.elementType)){const h=Oke(e.elementType);if($ke(e.elementType))for(let p=0;p<a;++p)r[l]=Math.max(n[c]/h,-1),r[l+1]=Math.max(n[c+1]/h,-1),l+=s,c+=o;else for(let p=0;p<a;++p)r[l]=n[c]/h,r[l+1]=n[c+1]/h,l+=s,c+=o}else khe(t,e,i);return t}function pHe(t,e,i,r){var s,n;const o=t.typedBuffer,a=t.typedBufferStride,l=(s=r==null?void 0:r.count)!=null?s:t.count;let c=((n=r==null?void 0:r.dstIndex)!=null?n:0)*a;for(let h=0;h<l;++h)o[c]=e,o[c+1]=i,c+=a}Object.freeze({__proto__:null,copy:khe,normalizeIntegerBuffer:zhe,fill:pHe});function _U(t,e,i){const r=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=i?i.count:e.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],r[l+2]=n[c+2],l+=s,c+=o}function fHe(t,e,i,r,s){var n,o;const a=t.typedBuffer,l=t.typedBufferStride,c=(n=s==null?void 0:s.count)!=null?n:t.count;let h=((o=s==null?void 0:s.dstIndex)!=null?o:0)*l;for(let p=0;p<c;++p)a[h]=e,a[h+1]=i,a[h+2]=r,h+=l}Object.freeze({__proto__:null,copy:_U,fill:fHe});function Vhe(t,e,i){const r=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=i?i.count:e.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],r[l+2]=n[c+2],r[l+3]=n[c+3],l+=s,c+=o}function Nhe(t,e,i,r,s,n){var o,a;const l=t.typedBuffer,c=t.typedBufferStride,h=(o=n==null?void 0:n.count)!=null?o:t.count;let p=((a=n==null?void 0:n.dstIndex)!=null?a:0)*c;for(let f=0;f<h;++f)l[p]=e,l[p+1]=i,l[p+2]=r,l[p+3]=s,p+=c}Object.freeze({__proto__:null,copy:Vhe,fill:Nhe});function cv(t,e){return new t(new ArrayBuffer(e*t.ElementCount*Vne(t.ElementType)))}class Uhe{constructor(e){this.streamDataRequester=e}async loadJSON(e,i){return this.load("json",e,i)}async loadBinary(e,i){return Jc(e)?(Dt(i),yq(e)):this.load("binary",e,i)}async loadImage(e,i){return this.load("image",e,i)}async load(e,i,r){if(A(this.streamDataRequester))return(await vt(i,{responseType:mHe[e]})).data;const s=await zl(this.streamDataRequester.request(i,e,r));if(s.ok===!0)return s.value;throw Wc(s.error),new Q("",`Request for resource failed: ${s.error}`)}}const mHe={image:"image",binary:"array-buffer",json:"json"},gHe=le.getLogger("esri.views.3d.glTF");class yHe{error(e){throw new Q("gltf-loader-error",e)}errorUnsupported(e){throw new Q("gltf-loader-unsupported-feature",e)}errorUnsupportedIf(e,i){e&&this.errorUnsupported(i)}assert(e,i){e||this.error(i)}warn(e){gHe.warn(e)}warnUnsupported(e){this.warn("[Unsupported Feature] "+e)}warnUnsupportedIf(e,i){e&&this.warnUnsupported(i)}}function vHe(t={}){return E({color:[1,1,1],opacity:1,alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1,castShadows:!0,receiveShadows:!0,receiveAmbientOcclustion:!0,textureColor:null,textureNormal:null,textureOcclusion:null,textureEmissive:null,textureMetallicRoughness:null,emissiveFactor:[0,0,0],metallicFactor:1,roughnessFactor:1,colorMixMode:"multiply"},t)}function _He(t,e={}){return{data:t,parameters:E({wrap:E({s:10497,t:10497},e.wrap),noUnpackFlip:!0,mipmap:!1},e)}}class uv{constructor(e,i,r=""){this.major=e,this.minor=i,this._context=r}lessThan(e,i){return this.major<e||e===this.major&&this.minor<i}since(e,i){return!this.lessThan(e,i)}validate(e){if(this.major!==e.major){const i=this._context&&this._context+":",r=this._context&&this._context+" ";throw new Q(i+"unsupported-version",`Required major ${r}version is '${this.major}', but got '\${version.major}.\${version.minor}'`,{version:e})}}clone(){return new uv(this.major,this.minor,this._context)}static parse(e,i=""){const[r,s]=e.split("."),n=/^\s*\d+\s*$/;if(!r||!r.match||!r.match(n))throw new Q((i&&i+":")+"invalid-version","Expected major version to be a number, but got '${version}'",{version:e});if(!s||!s.match||!s.match(n))throw new Q((i&&i+":")+"invalid-version","Expected minor version to be a number, but got '${version}'",{version:e});const o=parseInt(r,10),a=parseInt(s,10);return new uv(o,a,i)}}class jhe{constructor(e){this.data=e,this.offset4=0,this.dataUint32=new Uint32Array(this.data,0,Math.floor(this.data.byteLength/4))}readUint32(){const e=this.offset4;return this.offset4+=1,this.dataUint32[e]}readUint8Array(e){const i=4*this.offset4;return this.offset4+=e/4,new Uint8Array(this.data,i,e)}remainingBytes(){return this.data.byteLength-4*this.offset4}}const Bhe={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},bHe={pbrMetallicRoughness:Bhe,emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1},wHe={ESRI_externalColorMixMode:"tint"},Ghe=(t={})=>{const e=E(E({},Bhe),t.pbrMetallicRoughness),i=xHe(E(E({},wHe),t.extras));return he(E(E({},bHe),t),{pbrMetallicRoughness:e,extras:i})};function xHe(t){switch(t.ESRI_externalColorMixMode){case"multiply":case"tint":case"ignore":case"replace":break;default:kn(t.ESRI_externalColorMixMode),t.ESRI_externalColorMixMode="tint"}return t}const SHe={magFilter:9729,minFilter:9987,wrapS:10497,wrapT:10497},THe=t=>E(E({},SHe),t);function CHe(t){let e,i;return t.replace(/^(.*\/)?([^/]*)$/,(r,s,n)=>(e=s||"",i=n||"","")),{dirPart:e,filePart:i}}const QR={MAGIC:1179937895,CHUNK_TYPE_JSON:1313821514,CHUNK_TYPE_BIN:5130562,MIN_HEADER_LENGTH:20};class Jd{constructor(e,i,r,s,n){this.context=e,this.errorContext=i,this.uri=r,this.json=s,this.glbBuffer=n,this.bufferLoaders=new Map,this.textureLoaders=new Map,this.textureCache=new Map,this.materialCache=new Map,this.nodeParentMap=new Map,this.nodeTransformCache=new Map,this.baseUri=CHe(this.uri).dirPart,this.checkVersionSupported(),this.checkRequiredExtensionsSupported(),i.errorUnsupportedIf(s.scenes==null,"Scenes must be defined."),i.errorUnsupportedIf(s.meshes==null,"Meshes must be defined"),i.errorUnsupportedIf(s.nodes==null,"Nodes must be defined."),this.computeNodeParents()}static async load(e,i,r,s){if(Jc(r)){const a=pM(r);if(a.mediaType!=="model/gltf-binary")try{const c=JSON.parse(a.isBase64?atob(a.data):a.data);return new Jd(e,i,r,c)}catch{}const l=yq(r);if(Jd.isGLBData(l))return this.fromGLBData(e,i,r,l)}if(r.endsWith(".gltf")){const a=await e.loadJSON(r,s);return new Jd(e,i,r,a)}const n=await e.loadBinary(r,s);if(Jd.isGLBData(n))return this.fromGLBData(e,i,r,n);const o=await e.loadJSON(r,s);return new Jd(e,i,r,o)}static isGLBData(e){const i=new jhe(e);return i.remainingBytes()>=4&&i.readUint32()===QR.MAGIC}static async fromGLBData(e,i,r,s){const n=await Jd.parseGLBData(i,s);return new Jd(e,i,r,n.json,n.binaryData)}static async parseGLBData(e,i){const r=new jhe(i);e.assert(r.remainingBytes()>=12,"GLB binary data is insufficiently large.");const s=r.readUint32(),n=r.readUint32(),o=r.readUint32();e.assert(s===QR.MAGIC,"Magic first 4 bytes do not fit to expected GLB value."),e.assert(i.byteLength>=o,"GLB binary data is smaller than header specifies."),e.errorUnsupportedIf(n!==2,"An unsupported GLB container version was detected. Only version 2 is supported.");let a,l,c=0;for(;r.remainingBytes()>=8;){const h=r.readUint32(),p=r.readUint32();c===0?(e.assert(p===QR.CHUNK_TYPE_JSON,"First GLB chunk must be JSON."),e.assert(h>=0,"No JSON data found."),a=await OHe(r.readUint8Array(h))):c===1?(e.errorUnsupportedIf(p!==QR.CHUNK_TYPE_BIN,"Second GLB chunk expected to be BIN."),l=r.readUint8Array(h)):e.warnUnsupported("More than 2 GLB chunks detected. Skipping."),c+=1}return a||e.error("No GLB JSON chunk detected."),{json:a,binaryData:l}}async getBuffer(e,i){const r=this.json.buffers[e],s=this.errorContext;if(r.uri==null)return s.assert(this.glbBuffer!=null,"GLB buffer not present"),this.glbBuffer;const n=await this.getBufferLoader(e,i);return s.assert(n.byteLength===r.byteLength,"Buffer byte lengths should match."),n}async getBufferLoader(e,i){const r=this.bufferLoaders.get(e);if(r)return r;const s=this.json.buffers[e],n=this.context.loadBinary(this.resolveUri(s.uri),i).then(o=>new Uint8Array(o));return this.bufferLoaders.set(e,n),n}async getAccessor(e,i){const r=this.errorContext;r.errorUnsupportedIf(!this.json.accessors,"Accessors missing.");const s=this.json.accessors[e];r.errorUnsupportedIf((s==null?void 0:s.bufferView)==null,"Some accessor does not specify a bufferView."),r.errorUnsupportedIf(s.type in["MAT2","MAT3","MAT4"],`AttributeType ${s.type} is not supported`);const n=this.json.bufferViews[s.bufferView],o=await this.getBuffer(n.buffer,i),a=AHe[s.type],l=$He[s.componentType],c=a*l,h=n.byteStride||c;return{raw:o.buffer,byteStride:h,byteOffset:o.byteOffset+(n.byteOffset||0)+(s.byteOffset||0),entryCount:s.count,isDenselyPacked:h===c,componentCount:a,componentByteSize:l,componentType:s.componentType,min:s.min,max:s.max,normalized:!!s.normalized}}async getIndexData(e,i){if(e.indices==null)return null;const r=await this.getAccessor(e.indices,i);if(r.isDenselyPacked)switch(r.componentType){case 5121:return new Uint8Array(r.raw,r.byteOffset,r.entryCount);case 5123:return new Uint16Array(r.raw,r.byteOffset,r.entryCount);case 5125:return new Uint32Array(r.raw,r.byteOffset,r.entryCount)}else switch(r.componentType){case 5121:return JR(this.wrapAccessor(Td,r));case 5123:return JR(this.wrapAccessor(y0,r));case 5125:return JR(this.wrapAccessor(_0,r))}}async getPositionData(e,i){const r=this.errorContext;r.errorUnsupportedIf(e.attributes.POSITION==null,"No POSITION vertex data found.");const s=await this.getAccessor(e.attributes.POSITION,i);return r.errorUnsupportedIf(s.componentType!==5126,"Expected type FLOAT for POSITION vertex attribute, but found "+XR[s.componentType]),r.errorUnsupportedIf(s.componentCount!==3,"POSITION vertex attribute must have 3 components, but found "+s.componentCount.toFixed()),this.wrapAccessor(Wt,s)}async getNormalData(e,i){const r=this.errorContext;r.assert(e.attributes.NORMAL!=null,"No NORMAL vertex data found.");const s=await this.getAccessor(e.attributes.NORMAL,i);return r.errorUnsupportedIf(s.componentType!==5126,"Expected type FLOAT for NORMAL vertex attribute, but found "+XR[s.componentType]),r.errorUnsupportedIf(s.componentCount!==3,"NORMAL vertex attribute must have 3 components, but found "+s.componentCount.toFixed()),this.wrapAccessor(Wt,s)}async getTangentData(e,i){const r=this.errorContext;r.assert(e.attributes.TANGENT!=null,"No TANGENT vertex data found.");const s=await this.getAccessor(e.attributes.TANGENT,i);return r.errorUnsupportedIf(s.componentType!==5126,"Expected type FLOAT for TANGENT vertex attribute, but found "+XR[s.componentType]),r.errorUnsupportedIf(s.componentCount!==4,"TANGENT vertex attribute must have 4 components, but found "+s.componentCount.toFixed()),new Zr(s.raw,s.byteOffset,s.byteStride,s.byteOffset+s.byteStride*s.entryCount)}async getTextureCoordinates(e,i){const r=this.errorContext;r.assert(e.attributes.TEXCOORD_0!=null,"No TEXCOORD_0 vertex data found.");const s=await this.getAccessor(e.attributes.TEXCOORD_0,i);return r.errorUnsupportedIf(s.componentCount!==2,"TEXCOORD_0 vertex attribute must have 2 components, but found "+s.componentCount.toFixed()),s.componentType===5126?this.wrapAccessor(rl,s):(r.errorUnsupportedIf(!s.normalized,"Integer component types are only supported for a normalized accessor for TEXCOORD_0."),EHe(s))}async getVertexColors(e,i){const r=this.errorContext;r.assert(e.attributes.COLOR_0!=null,"No COLOR_0 vertex data found.");const s=await this.getAccessor(e.attributes.COLOR_0,i);if(r.errorUnsupportedIf(s.componentCount!==4&&s.componentCount!==3,"COLOR_0 attribute must have 3 or 4 components, but found "+s.componentCount.toFixed()),s.componentCount===4){if(s.componentType===5126)return this.wrapAccessor(Zr,s);if(s.componentType===5121)return this.wrapAccessor(Hn,s);if(s.componentType===5123)return this.wrapAccessor(Jf,s)}else if(s.componentCount===3){if(s.componentType===5126)return this.wrapAccessor(Wt,s);if(s.componentType===5121)return this.wrapAccessor(Zf,s);if(s.componentType===5123)return this.wrapAccessor(v0,s)}r.errorUnsupported("Unsupported component type for COLOR_0 attribute: "+XR[s.componentType])}hasPositions(e){return e.attributes.POSITION!==void 0}hasNormals(e){return e.attributes.NORMAL!==void 0}hasVertexColors(e){return e.attributes.COLOR_0!==void 0}hasTextureCoordinates(e){return e.attributes.TEXCOORD_0!==void 0}hasTangents(e){return e.attributes.TANGENT!==void 0}async getMaterial(e,i,r){let s=this.materialCache.get(e.material);if(!s){const n=e.material!=null?Ghe(this.json.materials[e.material]):Ghe(),o=n.pbrMetallicRoughness,a=this.hasVertexColors(e),l=this.getTexture(o.baseColorTexture,i),c=this.getTexture(n.normalTexture,i),h=r?this.getTexture(n.occlusionTexture,i):null,p=r?this.getTexture(n.emissiveTexture,i):null,f=r?this.getTexture(o.metallicRoughnessTexture,i):null,g=e.material!=null?e.material:-1;s={alphaMode:n.alphaMode,alphaCutoff:n.alphaCutoff,color:o.baseColorFactor,doubleSided:!!n.doubleSided,colorTexture:await l,normalTexture:await c,name:n.name,id:g,occlusionTexture:await h,emissiveTexture:await p,emissiveFactor:n.emissiveFactor,metallicFactor:o.metallicFactor,roughnessFactor:o.roughnessFactor,metallicRoughnessTexture:await f,vertexColors:a,ESRI_externalColorMixMode:n.extras.ESRI_externalColorMixMode}}return s}async getTexture(e,i){if(!e)return null;this.errorContext.errorUnsupportedIf((e.texCoord||0)!==0,"Only TEXCOORD with index 0 is supported.");const r=e.index,s=this.errorContext,n=this.json.textures[r],o=THe(n.sampler!=null?this.json.samplers[n.sampler]:{});s.errorUnsupportedIf(n.source==null,"Source is expected to be defined for a texture.");const a=this.json.images[n.source],l=await this.loadTextureImageData(r,n,i);return EG(this.textureCache,r,()=>{const c=p=>p===33071||p===33648||p===10497,h=p=>(s.error(`Unexpected TextureSampler WrapMode: ${p}. Using default REPEAT(10497).`),10497);return{data:l,wrapS:c(o.wrapS)?o.wrapS:h(o.wrapS),wrapT:c(o.wrapT)?o.wrapT:h(o.wrapT),minFilter:o.minFilter,name:a.name,id:r}})}getNodeTransform(e){if(e===void 0)return PHe;let i=this.nodeTransformCache.get(e);if(!i){const r=this.getNodeTransform(this.getNodeParent(e)),s=this.json.nodes[e];s.matrix?i=wi(be(),r,s.matrix):s.translation||s.rotation||s.scale?(i=my(r),s.translation&&Vs(i,i,s.translation),s.rotation&&(YR[3]=_ne(YR,s.rotation),Bi(i,i,YR[3],YR)),s.scale&&kP(i,i,s.scale)):i=r,this.nodeTransformCache.set(e,i)}return i}wrapAccessor(e,i){return new e(i.raw,i.byteOffset,i.byteStride,i.byteOffset+i.byteStride*(i.entryCount-1)+i.componentByteSize*i.componentCount)}resolveUri(e){return Ra(e,this.baseUri)}getNodeParent(e){return this.nodeParentMap.get(e)}checkVersionSupported(){const e=uv.parse(this.json.asset.version,"glTF");MHe.validate(e)}checkRequiredExtensionsSupported(){const e=this.json,i=this.errorContext;e.extensionsRequired&&e.extensionsRequired.length!==0&&i.errorUnsupported("gltf loader was not able to load unsupported feature. Required extensions: "+e.extensionsRequired.join(", "))}computeNodeParents(){this.json.nodes.forEach((e,i)=>{e.children&&e.children.forEach(r=>{this.nodeParentMap.set(r,i)})})}async loadTextureImageData(e,i,r){const s=this.textureLoaders.get(e);if(s)return s;const n=this.createTextureLoader(i,r);return this.textureLoaders.set(e,n),n}async createTextureLoader(e,i){const r=this.json.images[e.source];if(r.uri)return this.context.loadImage(this.resolveUri(r.uri),i);const s=this.errorContext;s.errorUnsupportedIf(r.bufferView==null,"Image bufferView must be defined."),s.errorUnsupportedIf(r.mimeType==null,"Image mimeType must be defined.");const n=this.json.bufferViews[r.bufferView],o=await this.getBuffer(n.buffer,i);return s.errorUnsupportedIf(n.byteStride!=null,"byteStride not supported for image buffer"),RHe(new Uint8Array(o.buffer,o.byteOffset+(n.byteOffset||0),n.byteLength),r.mimeType)}}const MHe=new uv(2,0,"glTF"),PHe=nJ(be(),Math.PI/2),YR=pf(),AHe={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},$He={5120:1,5121:1,5122:2,5123:2,5126:4,5125:4};function EHe(t){switch(t.componentType){case 5120:return new b0(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case 5121:return new g0(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case 5122:return new w0(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case 5123:return new rb(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case 5125:return new sb(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case 5126:return new rl(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);default:return void kn(t.componentType)}}async function OHe(t){return new Promise((e,i)=>{const r=new Blob([t]),s=new FileReader;s.onload=()=>{const n=s.result;e(JSON.parse(n))},s.onerror=n=>{i(n)},s.readAsText(r)})}async function RHe(t,e){return new Promise((i,r)=>{const s=new Blob([t],{type:e}),n=URL.createObjectURL(s),o=new Image;o.addEventListener("load",()=>{URL.revokeObjectURL(n),"decode"in o?o.decode().then(()=>i(o),()=>i(o)):i(o)}),o.addEventListener("error",a=>{URL.revokeObjectURL(n),r(a)}),o.src=n})}const XR={5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5125:"UNSIGNED_INT",5126:"FLOAT"};let IHe=0;async function qhe(t,e,i={},r=!0){const s=await Jd.load(t,KR,e,i),n="gltf_"+IHe++,o={lods:[],materials:new Map,textures:new Map,meta:DHe(s)},a=!(!s.json.asset.extras||s.json.asset.extras.ESRI_type!=="symbolResource"),l=new Map;await FHe(s,async(c,h,p,f)=>{var g;const y=(g=l.get(p))!=null?g:0;l.set(p,y+1);const v=c.mode!==void 0?c.mode:4,b=v===4||v===5||v===6?v:null;if(A(b))return void KR.warnUnsupported("Unsupported primitive mode ("+VHe[v]+"). Skipping primitive.");if(!s.hasPositions(c))return void KR.warn("Skipping primitive without POSITION vertex attribute.");const w=s.getPositionData(c,i),S=s.getMaterial(c,i,r),T=s.hasNormals(c)?s.getNormalData(c,i):null,C=s.hasTangents(c)?s.getTangentData(c,i):null,M=s.hasTextureCoordinates(c)?s.getTextureCoordinates(c,i):null,P=s.hasVertexColors(c)?s.getVertexColors(c,i):null,F=s.getIndexData(c,i),z={transform:my(h),attributes:{position:await w,normal:T?await T:null,texCoord0:M?await M:null,color:P?await P:null,tangent:C?await C:null},indices:await F,primitiveType:b,material:kHe(o,await S,n)};let D=null;_(o.meta)&&_(o.meta.ESRI_lod)&&o.meta.ESRI_lod.metric==="screenSpaceRadius"&&(D=o.meta.ESRI_lod.thresholds[p]),o.lods[p]=o.lods[p]||{parts:[],name:f,lodThreshold:D},o.lods[p].parts[y]=z});for(const c of o.lods)c.parts=c.parts.filter(h=>!!h);return{model:o,meta:{isEsriSymbolResource:a,uri:s.uri},customMeta:{}}}function DHe(t){const e=t.json;let i=null;return e.nodes.forEach(r=>{const s=r.extras;_(s)&&(s.ESRI_proxyEllipsoid||s.ESRI_lod)&&(i=s)}),i}async function FHe(t,e){const i=t.json,r=i.scenes[i.scene||0].nodes,s=r.length>1,n=[];for(const a of r){const l=i.nodes[a];n.push(o(a,0)),LHe(l)&&!s&&l.extensions.MSFT_lod.ids.forEach((c,h)=>o(c,h+1))}async function o(a,l){const c=i.nodes[a],h=t.getNodeTransform(a);if(KR.warnUnsupportedIf(c.weights!=null,"Morph targets are not supported."),c.mesh!=null){const p=i.meshes[c.mesh];for(const f of p.primitives)n.push(e(f,h,l,p.name))}for(const p of c.children||[])n.push(o(p,l))}await Promise.all(n)}function LHe(t){return t.extensions&&t.extensions.MSFT_lod&&Array.isArray(t.extensions.MSFT_lod.ids)}function kHe(t,e,i){const r=n=>{const o=`${i}_tex_${n&&n.id}${n&&n.name?"_"+n.name:""}`;if(n&&!t.textures.has(o)){const a=_He(n.data,{wrap:{s:n.wrapS,t:n.wrapT},mipmap:zHe.some(l=>l===n.minFilter),noUnpackFlip:!0});t.textures.set(o,a)}return o},s=`${i}_mat_${e.id}_${e.name}`;if(!t.materials.has(s)){const n=vHe({color:[e.color[0],e.color[1],e.color[2]],opacity:e.color[3],alphaMode:e.alphaMode,alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,colorMixMode:e.ESRI_externalColorMixMode,textureColor:e.colorTexture?r(e.colorTexture):void 0,textureNormal:e.normalTexture?r(e.normalTexture):void 0,textureOcclusion:e.occlusionTexture?r(e.occlusionTexture):void 0,textureEmissive:e.emissiveTexture?r(e.emissiveTexture):void 0,textureMetallicRoughness:e.metallicRoughnessTexture?r(e.metallicRoughnessTexture):void 0,emissiveFactor:[e.emissiveFactor[0],e.emissiveFactor[1],e.emissiveFactor[2]],metallicFactor:e.metallicFactor,roughnessFactor:e.roughnessFactor});t.materials.set(s,n)}return s}const KR=new yHe,zHe=[9987,9985],VHe=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"];function NHe(t,e=lb){return typeof t=="number"?e(t):AC(t)||dg(t)?new Uint32Array(t):t}function UHe(t){const e=typeof t=="number"?t:t.length;if(e<3)return new Uint16Array(0);const i=e-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if(typeof t=="number"){let s=0;for(let n=0;n<i;n+=1)n%2==0?(r[s++]=n,r[s++]=n+1,r[s++]=n+2):(r[s++]=n+1,r[s++]=n,r[s++]=n+2)}else{let s=0;for(let n=0;n<i;n+=1)if(n%2==0){const o=t[n],a=t[n+1],l=t[n+2];r[s++]=o,r[s++]=a,r[s++]=l}else{const o=t[n+1],a=t[n],l=t[n+2];r[s++]=o,r[s++]=a,r[s++]=l}}return r}function jHe(t){const e=typeof t=="number"?t:t.length;if(e<3)return new Uint16Array(0);const i=e-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if(typeof t=="number"){let s=0;for(let n=0;n<i;++n)r[s++]=0,r[s++]=n+1,r[s++]=n+2;return r}{const s=t[0];let n=t[1],o=0;for(let a=0;a<i;++a){const l=t[a+2];r[o++]=s,r[o++]=n,r[o++]=l,n=l}return r}}const Qd=le.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function Hhe(t,e){const i=await BHe(t,e);return{resource:i,textures:await ZHe(i.textureDefinitions,e)}}async function BHe(t,e){const i=_(e)&&e.streamDataRequester;if(i)return GHe(t,i,e);const r=await zl(vt(t,at(e)));if(r.ok===!0)return r.value.data;Wc(r.error),Whe(r.error)}async function GHe(t,e,i){const r=await zl(e.request(t,"json",i));if(r.ok===!0)return r.value;Wc(r.error),Whe(r.error.details.url)}function Whe(t){throw new Q("",`Request for object resource failed: ${t}`)}function qHe(t){const e=t.params,i=e.topology;let r=!0;switch(e.vertexAttributes||(Qd.warn("Geometry must specify vertex attributes"),r=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const n=e.faces;if(n){if(e.vertexAttributes)for(const o in e.vertexAttributes){const a=n[o];a&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(Qd.warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),r=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(Qd.warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),r=!1)):(Qd.warn(`Indexed geometry does not specify face indices for '${o}' attribute`),r=!1)}}else Qd.warn("Indexed geometries must specify faces"),r=!1;break}default:Qd.warn(`Unsupported topology '${i}'`),r=!1}t.params.material||(Qd.warn("Geometry requires material"),r=!1);const s=t.params.vertexAttributes;for(const n in s)s[n].values||(Qd.warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function HHe(t,e){const i=[],r=[],s=[],n=[],o=t.resource,a=uv.parse(o.version||"1.0","wosr");QHe.validate(a);const l=o.model.name,c=o.model.geometries,h=o.materialDefinitions,p=t.textures;let f=0;const g=new Map;for(let y=0;y<c.length;y++){const v=c[y];if(!qHe(v))continue;const b=JHe(v),w=v.params.vertexAttributes,S=[];for(const D in w){const U=w[D],G=U.values;S.push([D,{data:G,size:U.valuesPerElement,exclusive:!0}])}const T=[];if(v.params.topology!=="PerAttributeArray"){const D=v.params.faces;for(const U in D)T.push([U,new Uint32Array(D[U].values)])}const C=p&&p[b.texture];if(C&&!g.has(b.texture)){const{image:D,params:U}=C,G=new Mr(D,U);n.push(G),g.set(b.texture,G)}const M=g.get(b.texture),P=M?M.id:void 0;let F=s[b.material]?s[b.material][b.texture]:null;if(!F){const D=h[b.material.substring(b.material.lastIndexOf("/")+1)].params;D.transparency===1&&(D.transparency=0);const U=C&&C.alphaChannelUsage,G=D.transparency>0||U==="transparency"||U==="maskAndTransparency",k=C?Zhe(C.alphaChannelUsage):void 0,j={ambient:Dn(D.diffuse),diffuse:Dn(D.diffuse),opacity:1-(D.transparency||0),transparent:G,textureAlphaMode:k,textureAlphaCutoff:.33,textureId:P,initTextureTransparent:!0,doubleSided:!0,cullFace:0,colorMixMode:D.externalColorMixMode||"tint",textureAlphaPremultiplied:!!C&&!!C.params.preMultiplyAlpha};_(e)&&e.materialParamsMixin&&Object.assign(j,e.materialParamsMixin),F=new sv(j),s[b.material]||(s[b.material]={}),s[b.material][b.texture]=F}r.push(F);const z=new zi(S,T);f+=T.position?T.position.length:0,i.push(z)}return{name:l,stageResources:{textures:n,materials:r,geometries:i},pivotOffset:o.model.pivotOffset,boundingBox:WHe(i),numberOfVertices:f,lodThreshold:null}}function WHe(t){const e=ii();return t.forEach(i=>{const r=i.boundingInfo;_(r)&&(uu(e,r.getBBMin()),uu(e,r.getBBMax()))}),e}async function ZHe(t,e){const i=[];for(const n in t){const o=t[n],a=o.images[0].data;if(!a){Qd.warn("Externally referenced texture data is not yet supported");continue}const l=o.encoding+";base64,"+a,c="/textureDefinitions/"+n,h=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",p={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:Zhe(h)!==1},f=_(e)&&e.disableTextures?Promise.resolve(null):tl(l,e);i.push(f.then(g=>({refId:c,image:g,params:p,alphaChannelUsage:h})))}const r=await Promise.all(i),s={};for(const n of r)s[n.refId]=n;return s}function Zhe(t){switch(t){case"mask":return 2;case"maskAndTransparency":return 3;case"none":return 1;default:return 0}}function JHe(t){const e=t.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const QHe=new uv(1,2,"wosr"),Xb=2.1;async function Jhe(t,e){const i=Qhe(oHe(t));if(i.fileType==="wosr"){const l=await(e.cache?e.cache.loadWOSR(i.url,e):Hhe(i.url,e)),c=HHe(l,e);return{lods:[c],referenceBoundingBox:c.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:l.remove}}const r=await(e.cache?e.cache.loadGLTF(i.url,e,e.usePBR):qhe(new Uhe(e.streamDataRequester),i.url,e,e.usePBR)),s=or(r.model.meta,"ESRI_proxyEllipsoid");r.meta.isEsriSymbolResource&&_(s)&&r.meta.uri.indexOf("/RealisticTrees/")!==-1&&KHe(r,s);const n=r.meta.isEsriSymbolResource?{usePBR:e.usePBR,isSchematic:!1,treeRendering:r.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:e.usePBR,isSchematic:!1,mrrFactors:[0,1,.5]},o=he(E({},e.materialParamsMixin),{treeRendering:r.customMeta.esriTreeRendering});if(i.specifiedLodIndex!=null){const l=eI(r,n,o,i.specifiedLodIndex);let c=l[0].boundingBox;return i.specifiedLodIndex!==0&&(c=eI(r,n,o,0)[0].boundingBox),{lods:l,referenceBoundingBox:c,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1,remove:r.remove}}const a=eI(r,n,o);return{lods:a,referenceBoundingBox:a[0].boundingBox,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1,remove:r.remove}}function Qhe(t){const e=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function eI(t,e,i,r){const s=t.model,n=Ai(),o=new Array,a=new Map,l=new Map;return s.lods.forEach((c,h)=>{if(r!==void 0&&h!==r)return;const p={name:c.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:_(c.lodThreshold)?c.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:ii()};o.push(p),c.parts.forEach(f=>{const g=f.material+(f.attributes.normal?"_normal":"")+(f.attributes.color?"_color":"")+(f.attributes.texCoord0?"_texCoord0":"")+(f.attributes.tangent?"_tangent":""),y=s.materials.get(f.material),v=_(f.attributes.texCoord0),b=_(f.attributes.normal),w=YHe(y.alphaMode);if(!a.has(g)){if(v){if(_(y.textureColor)&&!l.has(y.textureColor)){const J=s.textures.get(y.textureColor),O=he(E({},J.parameters),{preMultiplyAlpha:w!==1});l.set(y.textureColor,new Mr(J.data,O))}if(_(y.textureNormal)&&!l.has(y.textureNormal)){const J=s.textures.get(y.textureNormal);l.set(y.textureNormal,new Mr(J.data,J.parameters))}if(_(y.textureOcclusion)&&!l.has(y.textureOcclusion)){const J=s.textures.get(y.textureOcclusion);l.set(y.textureOcclusion,new Mr(J.data,J.parameters))}if(_(y.textureEmissive)&&!l.has(y.textureEmissive)){const J=s.textures.get(y.textureEmissive);l.set(y.textureEmissive,new Mr(J.data,J.parameters))}if(_(y.textureMetallicRoughness)&&!l.has(y.textureMetallicRoughness)){const J=s.textures.get(y.textureMetallicRoughness);l.set(y.textureMetallicRoughness,new Mr(J.data,J.parameters))}}const D=y.color[0]**(1/Xb),U=y.color[1]**(1/Xb),G=y.color[2]**(1/Xb),k=y.emissiveFactor[0]**(1/Xb),j=y.emissiveFactor[1]**(1/Xb),V=y.emissiveFactor[2]**(1/Xb),q=_(y.textureColor)&&v?l.get(y.textureColor):null;a.set(g,new sv(E(he(E({},e),{transparent:w===0,textureAlphaMode:w,textureAlphaCutoff:y.alphaCutoff,diffuse:[D,U,G],ambient:[D,U,G],opacity:y.opacity,doubleSided:y.doubleSided,doubleSidedType:"winding-order",cullFace:y.doubleSided?0:2,vertexColors:!!f.attributes.color,vertexTangents:!!f.attributes.tangent,normals:b?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:_(q)?q.id:void 0,colorMixMode:y.colorMixMode,normalTextureId:_(y.textureNormal)&&v?l.get(y.textureNormal).id:void 0,textureAlphaPremultiplied:_(q)&&!!q.params.preMultiplyAlpha,occlusionTextureId:_(y.textureOcclusion)&&v?l.get(y.textureOcclusion).id:void 0,emissiveTextureId:_(y.textureEmissive)&&v?l.get(y.textureEmissive).id:void 0,metallicRoughnessTextureId:_(y.textureMetallicRoughness)&&v?l.get(y.textureMetallicRoughness).id:void 0,emissiveFactor:[k,j,V],mrrFactors:[y.metallicFactor,y.roughnessFactor,e.mrrFactors[2]],isSchematic:!1}),i)))}const S=XHe(f.indices||f.attributes.position.count,f.primitiveType),T=f.attributes.position.count,C=cv(Wt,T);qT(C,f.attributes.position,f.transform);const M=[["position",{data:C.typedBuffer,size:C.elementCount,exclusive:!0}]],P=[["position",S]];if(_(f.attributes.normal)){const D=cv(Wt,T);X_(n,f.transform),H0(D,f.attributes.normal,n),M.push(["normal",{data:D.typedBuffer,size:D.elementCount,exclusive:!0}]),P.push(["normal",S])}if(_(f.attributes.tangent)){const D=cv(Zr,T);X_(n,f.transform),Lhe(D,f.attributes.tangent,n),M.push(["tangent",{data:D.typedBuffer,size:D.elementCount,exclusive:!0}]),P.push(["tangent",S])}if(_(f.attributes.texCoord0)){const D=cv(rl,T);zhe(D,f.attributes.texCoord0),M.push(["uv0",{data:D.typedBuffer,size:D.elementCount,exclusive:!0}]),P.push(["uv0",S])}if(_(f.attributes.color)){const D=cv(Hn,T);if(f.attributes.color.elementCount===4)f.attributes.color instanceof Zr?vU(D,f.attributes.color,255):f.attributes.color instanceof Hn?Vhe(D,f.attributes.color):f.attributes.color instanceof Jf&&vU(D,f.attributes.color,1/256);else{Nhe(D,255,255,255,255);const U=new Zf(D.buffer,0,4);f.attributes.color instanceof Wt?w7(U,f.attributes.color,255):f.attributes.color instanceof Zf?_U(U,f.attributes.color):f.attributes.color instanceof v0&&w7(U,f.attributes.color,1/256)}M.push(["color",{data:D.typedBuffer,size:D.elementCount,exclusive:!0}]),P.push(["color",S])}const F=new zi(M,P);p.stageResources.geometries.push(F),p.stageResources.materials.push(a.get(g)),v&&(_(y.textureColor)&&p.stageResources.textures.push(l.get(y.textureColor)),_(y.textureNormal)&&p.stageResources.textures.push(l.get(y.textureNormal)),_(y.textureOcclusion)&&p.stageResources.textures.push(l.get(y.textureOcclusion)),_(y.textureEmissive)&&p.stageResources.textures.push(l.get(y.textureEmissive)),_(y.textureMetallicRoughness)&&p.stageResources.textures.push(l.get(y.textureMetallicRoughness))),p.numberOfVertices+=T;const z=F.boundingInfo;_(z)&&(uu(p.boundingBox,z.getBBMin()),uu(p.boundingBox,z.getBBMax()))})}),o}function YHe(t){switch(t){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":case null:case void 0:return 1}}function XHe(t,e){switch(e){case 4:return NHe(t);case 5:return UHe(t);case 6:return jHe(t)}}function KHe(t,e){for(let i=0;i<t.model.lods.length;++i){const r=t.model.lods[i];t.customMeta.esriTreeRendering=!0;for(const s of r.parts){const n=s.attributes.normal;if(A(n))return;const o=s.attributes.position,a=o.count,l=$(),c=$(),h=$(),p=cv(Hn,a),f=cv(Wt,a),g=Fi(be(),s.transform);for(let y=0;y<a;y++){o.getVec(y,c),n.getVec(y,l),Oe(c,c,s.transform),ue(h,c,e.center),AM(h,h,e.radius);const v=h[2],b=Te(h),w=Math.min(.45+.55*b*b,1);AM(h,h,e.radius),Oe(h,h,g),_e(h,h),i+1!==t.model.lods.length&&t.model.lods.length>1&&jr(h,h,l,v>-1?.2:Math.min(-4*v-3.8,1)),f.setVec(y,h),p.set(y,0,255*w),p.set(y,1,255*w),p.set(y,2,255*w),p.set(y,3,255)}s.attributes.normal=f,s.attributes.color=p}}}var qat=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",fetch:Jhe,gltfToEngineResources:eI,parseUrl:Qhe}),mi;function eWe(t){let e=zr().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").vec2f("modelScaleFactors");return t.indexOf("color")>=0&&(e=e.vec4f("color")),t.indexOf("featureAttribute")>=0&&(e=e.vec4f("featureAttribute")),e=e.u8("state").u8("lodLevel").alignTo(8),e}(function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE"})(mi||(mi={}));class tWe{constructor(e){this.localTransform=e.getField("localTransform",Wf),this.globalTransform=e.getField("globalTransform",Wf),this.modelOrigin=e.getField("modelOrigin",ir),this.model=e.getField("model",Mc),this.modelNormal=e.getField("modelNormal",Mc),this.modelScaleFactors=e.getField("modelScaleFactors",rl),this.boundingSphere=e.getField("boundingSphere",m0),this.color=e.getField("color",Zr),this.featureAttribute=e.getField("featureAttribute",Zr),this.state=e.getField("state",Td),this.lodLevel=e.getField("lodLevel",Td)}}class iWe extends Ci{constructor(e,i){super(),this._capacity=0,this._size=0,this._next=0,this._layout=eWe(e),this._shaderTransformation=i}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this.grow();const e=this.findSlot();return this._view.state.set(e,mi.ALLOCATED),this._size++,this.emit("instance-added",{index:e}),e}removeInstance(e){const i=this._view.state;Ze(e>=0&&e<this._capacity&&i.get(e)&mi.ALLOCATED,"invalid instance handle"),this.getStateFlag(e,mi.ACTIVE)?this.setStateFlags(e,mi.REMOVE):this.freeInstance(e),this.emit("instance-removed",{index:e})}freeInstance(e){const i=this._view.state;Ze(e>=0&&e<this._capacity&&i.get(e)&mi.ALLOCATED,"invalid instance handle"),i.set(e,0),this._size--}setLocalTransform(e,i,r=!0){this._view.localTransform.setMat(e,i),r&&this.updateModelTransform(e)}getLocalTransform(e,i){this._view.localTransform.getMat(e,i)}setGlobalTransform(e,i,r=!0){this._view.globalTransform.setMat(e,i),r&&this.updateModelTransform(e)}getGlobalTransform(e,i){this._view.globalTransform.getMat(e,i)}updateModelTransform(e){const i=this._view,r=Im,s=Dc;i.localTransform.getMat(e,Yhe),i.globalTransform.getMat(e,bU);const n=wi(bU,bU,Yhe);ne(r,n[12],n[13],n[14]),i.modelOrigin.setVec(e,r),Ka(s,n),i.model.setMat(e,s);const o=Bbe(Im,n);o.sort(),i.modelScaleFactors.set(e,0,o[1]),i.modelScaleFactors.set(e,1,o[2]),p0(s,s),el(s,s),i.modelNormal.setMat(e,s),this.setStateFlags(e,mi.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:e})}getModelTransform(e,i){const r=this._view;r.model.getMat(e,Dc),r.modelOrigin.getVec(e,Im),i[0]=Dc[0],i[1]=Dc[1],i[2]=Dc[2],i[3]=0,i[4]=Dc[3],i[5]=Dc[4],i[6]=Dc[5],i[7]=0,i[8]=Dc[6],i[9]=Dc[7],i[10]=Dc[8],i[11]=0,i[12]=Im[0],i[13]=Im[1],i[14]=Im[2],i[15]=1}applyShaderTransformation(e,i){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,i)}getCombinedModelTransform(e,i){return this.getModelTransform(e,i),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,i),i}getCombinedLocalTransform(e,i){return this._view.localTransform.getMat(e,i),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,i),i}getCombinedMaxScaleFactor(e){let i=this._view.modelScaleFactors.get(e,1);if(this._shaderTransformation){const r=this._shaderTransformation.scaleFactor(Im,this,e);i*=Math.max(r[0],r[1],r[2])}return i}getCombinedMedianScaleFactor(e){let i=this._view.modelScaleFactors.get(e,0);if(this._shaderTransformation){const r=this._shaderTransformation.scaleFactor(Im,this,e);r.sort(),i*=r[1]}return i}getModel(e,i){this._view.model.getMat(e,i)}setFeatureAttribute(e,i){this._view.featureAttribute.setVec(e,i)}getFeatureAttribute(e,i){this._view.featureAttribute.getVec(e,i)}setColor(e,i){this._view.color.setVec(e,i)}getColor(e,i){this._view.color.getVec(e,i)}setVisible(e,i){i!==this.getVisible(e)&&(this.setStateFlag(e,mi.VISIBLE,i),this.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this.getStateFlag(e,mi.VISIBLE)}setHighlight(e,i){i!==this.getHighlight(e)&&(this.setStateFlag(e,mi.HIGHLIGHT,i),this.emit("instance-highlight-changed",{index:e}))}getHighlight(e){return this.getStateFlag(e,mi.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let i=0;for(let r=0;r<this._capacity;++r)this.getState(r)&e&&++i;return i}setStateFlags(e,i){const r=this._view.state;i=r.get(e)|i,r.set(e,i)}clearStateFlags(e,i){const r=this._view.state;i=r.get(e)&~i,r.set(e,i)}setStateFlag(e,i,r){r?this.setStateFlags(e,i):this.clearStateFlags(e,i)}getStateFlag(e,i){return!!(this._view.state.get(e)&i)}grow(){const e=Math.max(rWe,Math.floor(this._capacity*sWe)),i=this._layout.createBuffer(e);if(this._buffer){const r=new Uint8Array(this._buffer.buffer);new Uint8Array(i.buffer).set(r)}this._capacity=e,this._buffer=i,this._view=new tWe(this._buffer)}findSlot(){const e=this._view.state;let i=this._next;for(;e.get(i)&mi.ALLOCATED;)i=(i+1)%this._capacity;return this._next=(i+1)%this._capacity,i}}const rWe=1024,sWe=2,Im=$(),Dc=Ai(),Yhe=be(),bU=be();class nWe extends qce{constructor(e,i){super(r=>rQ(this._instanceData.view.boundingSphere.getVec(r,this._tmpSphere)),{maximumDepth:25}),this._tmpSphere=rs(),this._tmpMat4=be(),this._instanceData=e,this._boundingSphere=i}addInstance(e){const i=this._instanceData.view.boundingSphere,r=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);Oe(this._tmpSphere,this._boundingSphere.center,r),this._tmpSphere[3]=this._boundingSphere.radius*Rg(r),i.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class oWe{constructor(e,i){this.thresholdScale=1,this._camera=new Zt,this._worldSpaceRadius=e,this._thresholds=i.map(r=>r)}updateCamera(e){this._camera.copyFrom(e)}selectLevel(e,i){const r=this._camera.computeScreenPixelSizeAt(e),s=this._worldSpaceRadius*i/r,n=this._thresholds;let o=-1;for(let a=0;a<n.length;++a)s>=n[a]*this.thresholdScale&&(o=a);return o}}class aWe{constructor(e,i){const r=e.renderContext.rctx,{geometry:s,material:n}=i;this._materialRepository=e.materialRep,n.setParameters({instancedDoublePrecision:!0});const o=n.createBufferWriter(),a=o.vertexBufferLayout,l=o.elementCount(s),c=o.allocate(l);o.write({},s,c,0),this.geometry=s,this.material=n,this.glMaterials=new yle(n,this._materialRepository),this.vertexBufferLayout=a,this.vbo=Nt.createVertex(r,35044,c.buffer),this.vao=new Tr(r,Ht,{geometry:il(a)},{geometry:this.vbo}),this.vertexCount=l}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,i,r,s,n,o){const a=this.geometry.id;this.material.intersect(this.geometry,null,e.transform.transform,e,r,s,(l,c,h,p,f)=>{if(l>=0){if(i!=null&&!i(e.rayBegin,e.rayEnd,l))return;const g={layerUid:o.layerUid,graphicUid:o.graphicUid(n),geometryId:a,triangleNr:h};if((e.results.min.drapedLayerOrder==null||f>=e.results.min.drapedLayerOrder)&&(e.results.min.dist==null||l<e.results.min.dist)&&e.results.min.set(6,g,l,c,e.transform.transform,f),e.options.store!==0&&(e.results.max.drapedLayerOrder==null||f>=e.results.max.drapedLayerOrder)&&(e.results.max.dist==null||l>e.results.max.dist)&&e.results.max.set(6,g,l,c,e.transform.transform,f),e.options.store===2){const y=YE(e.results.min.ray);y.set(6,g,l,c,e.transform.transform,f),e.results.all.push(y)}}})}}class wU{constructor(e,i){this.minScreenSpaceRadius=e,this.components=i}static async create(e,i,r){const s=await Promise.allSettled(i.components.map(o=>e.schedule(()=>new aWe(e,o),r))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(o=>o);if(Ir(r)||n.length!==s.length){n.forEach(o=>o.destroy()),Dt(r);for(const o of s)if(o.status==="rejected")throw o.reason}return new wU(i.minScreenSpaceRadius,n)}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,i,r,s,n,o){this.components.forEach(a=>a.intersect(e,i,r,s,n,o))}get boundingBox(){if(A(this._boundingBox)){const e=ii();this.components.forEach(i=>{_(i.boundingInfo)&&(uu(e,i.boundingInfo.bbMin),uu(e,i.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(A(this._boundingSphere)){const e=this.boundingBox,i=$();Yl(e,i),this._boundingSphere={center:i,radius:.5*sxe(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,i)=>e+i.triangleCount,0)}}class lWe{constructor(e,i,r){this._elementSize=i,this._buffer=Nt.createVertex(e,35044),this.resize(r)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,i,r,s=0){const n=new Uint8Array(this.array,e*this.elementSize,(i-e)*this.elementSize);new Uint8Array(r.array,s*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(e,i){const r=e*this._elementSize,s=i*this._elementSize;this._buffer.setSubData(this._array,r,r,s)}resize(e){const i=e*this._elementSize,r=new ArrayBuffer(i);this._array&&(e>=this._capacity?new Uint8Array(r).set(new Uint8Array(this._array)):new Uint8Array(r).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=r,this._buffer.setData(i),this._capacity=e}}class cWe{constructor(e){this.modelOriginHi=e.getField("modelOriginHi",Wt),this.modelOriginLo=e.getField("modelOriginLo",Wt),this.model=e.getField("model",Mc),this.modelNormal=e.getField("modelNormal",Mc),this.color=e.getField("instanceColor",Zr),this.featureAttribute=e.getField("instanceFeatureAttribute",Zr)}}class Xhe{constructor(e,i){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=e,this._instanceBufferLayout=i,this._elementSize=i.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,i=this._tailIndex;return e>=i?e-i:e+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCylce(){this._captureFirstIndex=!0}beginUpdate(){Ze(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){Ze(this._updating,"not updating"),this.size<hWe*this.capacity&&this.shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this.transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){Ze(this._updating,"not updating"),this.isFull&&this.grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this.incrementHead(),Ze(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){Ze(this._updating,"not updating"),Ze(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this.incrementTail(),e&&(this._firstIndex=this._tailIndex)}grow(){const e=Math.max(Khe,Math.floor(this._capacity*uWe));this.resize(e)}shrink(){const e=Math.max(Khe,Math.floor(this._capacity*dWe));this.resize(e)}resize(e){if(Ze(this._updating,"not updating"),e===this._capacity)return;const i=new lWe(this._rctx,this._elementSize,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const r=this.size,s=this.compactInstances(i);Ze(s===r,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=s,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=i,this._view=new cWe(this._instanceBufferLayout.createView(this._buffer.array))}compactInstances(e){const i=this._headIndex,r=this._tailIndex;return r<i?(this._buffer.copyRange(r,i,e),i-r):r>i?(this._buffer.copyRange(r,this._capacity,e),i>0&&this._buffer.copyRange(0,i,e,this._capacity-r),i+(this._capacity-r)):0}incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}transferRange(e,i){e<i?this._buffer.transferRange(e,i):e>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(e,this._capacity))}}const Khe=1024,uWe=2,hWe=.3,dWe=.5;let pWe=function(t){const e=t.baseBoundingSphere.radius,i=t.levels.map(r=>r.minScreenSpaceRadius);return new oWe(e,i)};class fWe{constructor(e,i,r,s){this.type=6,this.isGround=!1,this._inverseViewport=ke(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new Zt,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=i,this._metadata=r,this._instanceBufferLayout=Zue({instancedDoublePrecision:!0,instanced:i}),this._glInstanceBufferLayout=il(this._instanceBufferLayout,1),this._instanceData=new iWe(this._optionalFields,s),this._instanceData.on("instance-added",()=>this.requestUpdateCycle()),this._instanceData.on("instance-removed",()=>this.requestUpdateCycle()),this._instanceData.on("instance-transform-changed",n=>{this.requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(n.index)}),this._instanceData.on("instance-visibility-changed",n=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(n.index)}),this._instanceData.on("instance-highlight-changed",()=>this.requestUpdateCycle(!0)),this._enableLevelSelection=this._symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach(i=>{const r=i.memoryUsage;e.cpu+=r.cpu,e.gpu+=r.gpu}),this._highlightRenderInstanceData.forEach(i=>{const r=i.memoryUsage;e.cpu+=r.cpu,e.gpu+=r.gpu}),e}get renderStats(){const e=this._instanceData.size,i=[];return this._levels.forEach((r,s)=>{const n=this._defaultRenderInstanceData[s],o=this._highlightRenderInstanceData[s],a=n.size+o.size,l=r.triangleCount;i.push({renderedInstances:a,renderedTriangles:a*l,trianglesPerInstance:l})}),{totalInstances:e,renderedInstances:i.reduce((r,s)=>r+s.renderedInstances,0),renderedTriangles:i.reduce((r,s)=>r+s.renderedTriangles,0),levels:i}}async initializeRenderContext(e,i){this._context=e;const r=e.renderContext.rctx,s=await Promise.allSettled(this._symbol.levels.map(o=>(this._defaultRenderInstanceData.push(new Xhe(r,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new Xhe(r,this._instanceBufferLayout)),wU.create(e,o,i)))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(o=>o);if(Ir(i)||n.length!==s.length){n.forEach(o=>o.destroy()),Dt(i);for(const o of s)if(o.status==="rejected")throw o.reason}this._levels=n,this._levelSelector=pWe(this)}uninitializeRenderContext(){this.invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceData.forEach(e=>e.destroy())}get slots(){return[3,5]}get needsHighlight(){return this._highlightRenderInstanceData.reduce((e,i)=>e+i.size,0)>0}prepareRender(e,i){if(Kt.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const s=i.equals(this._lastCamera);this._lastCamera.copyFrom(i),s||this.requestUpdateCycle()}const r=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(i,r),this.needsUpdates&&this._context.requestRender()}render(e){var i,r;const s=e.slot===3?2:e.slot===5?4:null;if(!s||!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return!1;const n=e.camera;this._inverseViewport[0]=1/n.fullViewport[2],this._inverseViewport[1]=1/n.fullViewport[3];const o={slot:s,origin:[0,0,0],camera:n,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:e.shadowMap.enabled,ssaoHelper:e.ssaoHelper,ssaoEnabled:e.ssaoHelper.enabled,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:(i=(r=e.offscreenRenderingHelper)==null?void 0:r.depthTexture)!=null?i:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:Dr,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType,terrainLinearDepthTexture:e.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:e.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:e.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:e.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:e.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null};e.rctx.bindVAO();const a=e.pass!==5&&e.pass!==7,l=e.pass!==6;return a&&this._renderComponents(e,s,o,this._defaultRenderInstanceData),l&&this._renderComponents(e,s,o,this._highlightRenderInstanceData),a||l}intersect(e,i,r,s){if(!this.baseMaterial.isVisible())return;const n=$();ue(n,s,r);const o=a=>{this._instanceData.getCombinedModelTransform(a,ide),e.transform.set(ide),Oe(rde,r,e.transform.inverse),Oe(sde,s,e.transform.inverse);const l=this._instanceData.getState(a),c=this._instanceData.getLodLevel(a);Ze(l&mi.ACTIVE,"invalid instance state"),Ze(c>=0&&c<this._levels.length,"invaid lod level"),this._levels[c].intersect(e,i,rde,sde,a,this._metadata)};this.baseMaterial.parameters.verticalOffset?this.octree.forEach(o):this.octree.forEachAlongRay(r,n,o)}queryDepthRange(e){return this.queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this.invalidateOctree()}requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get octree(){return this._octree||(this._octree=this.buildOctree()),this._octree}invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}buildOctree(){const e=new nWe(this._instanceData,this.baseBoundingSphere),i=this._instanceData,r=i.view?i.view.state:null;for(let s=0;s<this._instanceData.capacity;++s)r.get(s)&mi.ACTIVE&&e.addInstance(s);return e}queryDepthRangeOctree(e){const i=e.eye,r=e.viewForward,s=this.octree.findClosest(r,1,e.frustum),n=this.octree.findClosest(r,-1,e.frustum);if(s!=null&&n!=null){this._instanceData.view.boundingSphere.getVec(s,sh),ue(sh,sh,i);const o=ye(sh,r)-sh[3];this._instanceData.view.boundingSphere.getVec(n,sh),ue(sh,sh,i);const a=ye(sh,r)+sh[3];return{near:Math.max(e.near,o),far:Math.min(e.far,a)}}return{near:1/0,far:-1/0}}startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach(e=>{e.startUpdateCylce()}),this._highlightRenderInstanceData.forEach(e=>{e.startUpdateCylce()}),this.needsUpdates&&this._context.requestRender()}updateInstances(e,i){const r=this._enableLevelSelection,s=this._levelSelector;s.updateCamera(e),this._defaultRenderInstanceData.forEach(h=>{h.beginUpdate()}),this._highlightRenderInstanceData.forEach(h=>{h.beginUpdate()});const n=this._instanceData,o=this._instanceData.view,a=n.size,l=n.capacity;let c=this._instanceIndex;i=Math.min(a,i);for(let h=0;h<i;++h){c===0&&this.startUpdateCycle();const p=o.state.get(c);let f=0;if(!(p&mi.ALLOCATED)){c=(c+1)%l,i++;continue}const g=o.lodLevel.get(c);if(p&mi.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[g].freeTail(),p&mi.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[g].freeTail(),p&mi.REMOVE)n.freeInstance(c);else if(p&mi.VISIBLE){let y=0;r&&(o.modelOrigin.getVec(c,tde),y=s.selectLevel(tde,n.getCombinedMedianScaleFactor(c))),f=p&~(mi.ACTIVE|mi.TRANSFORM_CHANGED),y>=0&&(p&mi.HIGHLIGHT?(ede(this._highlightRenderInstanceData[y],o,c),f|=mi.HIGHLIGHT_ACTIVE):(ede(this._defaultRenderInstanceData[y],o,c),f|=mi.DEFAULT_ACTIVE)),o.state.set(c,f),o.lodLevel.set(c,y)}else f=p&~(mi.ACTIVE|mi.TRANSFORM_CHANGED),o.state.set(c,f);if(this._octree){const y=!!(p&mi.ACTIVE),v=!!(f&mi.ACTIVE);!y&&v?this._octree.addInstance(c):y&&!v?this._octree.removeInstance(c):y&&v&&p&mi.TRANSFORM_CHANGED&&(this._octree.removeInstance(c),this._octree.addInstance(c))}c=(c+1)%l}this._instanceIndex=c,this._defaultRenderInstanceData.forEach(h=>{h.endUpdate()}),this._highlightRenderInstanceData.forEach(h=>{h.endUpdate()})}_renderComponents(e,i,r,s){this.levels.forEach((n,o)=>{n.components.forEach(a=>{this._renderComponent(e,i,r,s[o],a,o)})})}_renderComponent(e,i,r,s,n,o){if(s.size===0||!n.material.requiresSlot(i))return;const{rctx:a,pass:l}=e,c=n.glMaterials.load(a,l);if(A(c))return;const h=a.capabilities.instancing,p=c.beginSlot(r),f=p.program;p.bindPipelineState(a,i),a.useProgram(f),c.bind(r,p),a.bindVAO(n.vao),p.ensureAttributeLocations(n.vao),e.isHighlightPass&&Fd(f,r),p.bindDraw(r),Kt.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.pass===0&&(f.setUniform4fv("externalColor",nde[Math.min(o,nde.length-1)]),f.setUniform1i("colorMixMode",WN.replace));const g=s.capacity,y=s.headIndex,v=s.tailIndex,b=s.firstIndex,w=this._glInstanceBufferLayout,S=(T,C)=>{une(a,Ht,s.buffer,w,T),h.drawArraysInstanced(p.primitiveType,0,n.vertexCount,C-T),hne(a,Ht,s.buffer,w)};n.material.parameters.transparent&&b!=null?y>v?(Ze(b>=v&&b<=y,"invalid firstIndex"),S(b,y),S(v,b)):y<v&&(b<=y?(Ze(b>=0&&b<=y,"invalid firstIndex"),S(b,y),S(v,g),S(0,b)):(Ze(b>=v&&b<=g,"invalid firstIndex"),S(b,g),S(0,y),S(v,b))):y>v?S(v,y):y<v&&(S(0,y),S(v,g)),a.bindVAO(null)}}function ede(t,e,i){const r=t.allocateHead();mWe(e,i,t.view,r)}function mWe(t,e,i,r){Xze(t.modelOrigin,e,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,t.model,e),i.modelNormal.copyFrom(r,t.modelNormal,e),t.color&&i.color&&i.color.copyFrom(r,t.color,e),t.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,t.featureAttribute,e)}const tde=$(),sh=Ot(),ide=be(),rde=$(),sde=$(),nde=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];class gWe extends Zu{constructor(e,i,r,s){super(e,i,r,s),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=r.physicalBasedRenderingEnabled}getCachedSize(){const[e,i,r]=_(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:i,height:r}}async doLoad(e){if(!this._drivenProperties.size&&QO(this.symbolLayer))throw new Error;const i=this.symbolLayer;if(this.isPrimitive){const r=i.resource?i.resource.primitive:iZ;this._resources=await this._createResourcesForPrimitive(r,e)}else this._resources=await this._createResourcesForUrl(i.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return _(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return or(this._resources,"lodRenderer")}setMaterialTransparencyParams(e,i=or(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(i),s=r<1||this.needsDrivenTransparentPass;return e.transparent=s,e.opacity=r,e.cullFace=s?0:2,e}async _createResourcesForPrimitive(e,i){if(!K7e(e))throw new Error(`Unknown object symbol primitive: ${e}`);const r=this.symbolLayer,s=lr(dxe(e)),n=Dn(pP(s)),o=Dn(sL(n,r)),a=Te(o),l=!1,c=!1,h={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:Kc,diffuse:Kc,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},p=h.usePBR;this.setMaterialTransparencyParams(h);const f=this.symbol;if(f.type==="point-3d"&&f.verticalOffset){const{screenLength:w,minWorldLength:S,maxWorldLength:T}=f.verticalOffset;h.verticalOffset={screenLength:zs(w),minWorldLength:S||0,maxWorldLength:T!=null?T:1/0},h.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)h.externalColor=wu;else{const w=_(r.material)&&r.material.color,S=_(w)?Ae.toUnitRGBA(w):wu;h.externalColor=S}this._fastUpdates=l3(this._context.renderer,this._fastVisualVariableConvertOptions(s,o,n,yp)),this._fastUpdates.enabled?(Object.assign(h,this._fastUpdates.materialParameters),h.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(h.instanced.push("color"),this._optionalFields.push("color"));const g=new sv(h),y=vce(e,g);if(!y)throw new Error(`Unknown object symbol primitive: ${e}`);const v=KO(y).map(w=>({opacity:1,transparent:w.parameters.transparent})),b=await this._createStageResources(y,p);return{lodResources:y,lodRenderer:await this._createLodRenderer(y,i),stageResources:b,symbolSize:o,extentPadding:a,isEsriSymbolResource:l,isWosr:c,originalMaterialParameters:v,physicalBasedRenderingEnabled:p,resourceBoundingBox:s,resourceSize:n,dispose:yp,pivotOffset:yp}}async _createResourcesForUrl(e,i){const r=["transformation"],s={materialParamsMixin:{instanced:r,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=l3(this._context.renderer,this._fastVisualVariableConvertOptions(yp,yp,yp,yp)),this._fastUpdates.enabled?(Object.assign(s.materialParamsMixin,this._fastUpdates.materialParameters),r.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(r.push("color"),this._optionalFields.push("color"));const n=this.symbol;if(n.type==="point-3d"&&n.verticalOffset){const{screenLength:U,minWorldLength:G,maxWorldLength:k}=n.verticalOffset;s.materialParamsMixin.verticalOffset={screenLength:zs(U),minWorldLength:G||0,maxWorldLength:k!=null?k:1/0},s.materialParamsMixin.castShadows=!1}s.signal=i,s.usePBR=this._context.physicalBasedRenderingEnabled;const o=s.usePBR,a=await Jhe(e,s),l=a.isEsriSymbolResource,c=a.isWosr,h=a.remove,p=iHe(a.lods);sHe(p),p.levels.sort((U,G)=>U.minScreenSpaceRadius-G.minScreenSpaceRadius),p.levels[0].minScreenSpaceRadius=Math.min(2,p.levels[0].minScreenSpaceRadius);const f=this._context,g=this.symbolLayer.material,y=this._getExternalColorParameters(g),v=or(this.symbolLayer,"material","color"),b=this._getCombinedOpacity(v,{hasIntrinsicColor:!0}),w=this.needsDrivenTransparentPass,S=KO(p),T=KO(p).map(U=>({opacity:U.parameters.opacity||1,transparent:U.parameters.transparent}));S.forEach(U=>{const G=U.parameters;U.setParameters(y);const k=G.opacity*b,j=k<1||w||G.transparent;U.setParameters({opacity:k,transparent:j}),f.screenSizePerspectiveEnabled&&U.setParameters({screenSizePerspective:f.sharedResources.screenSizePerspectiveSettings})});const C=a.referenceBoundingBox,M=Dn(pP(C)),P=Dn(p.levels[0].pivotOffset),F=Dn(sL(M,this.symbolLayer)),z=Te(F);c3(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(C,F,M,P))&&S.forEach(U=>U.setParameters(this._fastUpdates.materialParameters));const D=await this._createStageResources(p,o);return{lodResources:p,lodRenderer:await this._createLodRenderer(p,i),stageResources:D,symbolSize:F,extentPadding:z,isEsriSymbolResource:l,isWosr:c,originalMaterialParameters:T,physicalBasedRenderingEnabled:o,resourceBoundingBox:C,resourceSize:M,dispose:h,pivotOffset:P}}async _createStageResources(e,i){const r=this._context.stage,s=KO(e);i!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),r.addMany(s);const n=cUe(e);r.addMany(n),await r.load(n);const o=uUe(e);return r.addMany(o),{materials:s,textures:n,geometries:o}}async _createLodRenderer(e,i){const r=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:a=>this._instanceIndexToGraphicUid.get(a),notifyGraphicGeometryChanged:a=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(a)),notifyGraphicVisibilityChanged:a=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(a))},n=this._fastUpdates.enabled?{applyTransform:(a,l,c)=>{a.getFeatureAttribute(l,tI),ji(c,eU(this._fastUpdates.materialParameters,tI,c))},scaleFactor:(a,l,c)=>(l.getFeatureAttribute(c,tI),hGe(a,this._fastUpdates.materialParameters,tI))}:null,o=new fWe(e,this._optionalFields,s,n);return o.slicePlaneEnabled=this._context.slicePlaneEnabled,await r.addRenderPlugin(o.slots,o,i),o}_getExternalColorParameters(e){const i={};return this._drivenProperties.color?i.externalColor=wu:_(e)&&_(e.color)?i.externalColor=Ae.toUnitRGBA(e.color):(i.externalColor=wu,i.colorMixMode="ignore"),i}destroy(){if(super.destroy(),_(this._resources)){const e=this._context.stage;e.removeRenderPlugin(this._resources.lodRenderer);const i=this._resources.stageResources;e.removeMany(i.materials),e.removeMany(i.textures),e.removeMany(i.geometries),_(this._resources.dispose)&&this._resources.dispose(),this._resources=null}}createGraphics3DGraphic(e){const i=e.graphic;if(!this._validateGeometry(i.geometry))return null;const r=GT(i.geometry);if(A(r))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const s=this.setGraphicElevationContext(i,new ma),n=e.renderingInfo;return this._createAs3DShape(i,r,n,s,i.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(A(this._resources))return!0;const e=this._drivenProperties.opacity,i=!this.isPrimitive,r=this._resources.stageResources.materials,s=this._resources.originalMaterialParameters;for(let n=0;n<r.length;n++){const o=r[n],a=or(this.symbolLayer,"material","color"),l=s[n],c=this._getCombinedOpacity(a,{hasIntrinsicColor:i})*l.opacity,h=c<1||e||l.transparent;o.setParameters({opacity:c,transparent:h}),this.isPrimitive&&o.setParameters({cullFace:h?0:2})}return!0}layerElevationInfoChanged(e,i){return this.updateGraphics3DGraphicElevationInfo(e,i,Cm)}slicePlaneEnabledChanged(){if(A(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(A(this._resources))return!0;const{stageResources:e,isWosr:i}=this._resources;for(const r of e.materials)this.isPrimitive?r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):i||r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return this.hasLoadedPBRTextures!==!1||this._context.physicalBasedRenderingEnabled!==!0||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}applyRendererDiff(e,i){if(A(this._resources))return 0;const{stageResources:{materials:r},lodRenderer:s,resourceBoundingBox:n,symbolSize:o,resourceSize:a,pivotOffset:l}=this._resources;for(const c in e.diff){if(c!=="visualVariables"||!c3(this._fastUpdates,i,this._fastVisualVariableConvertOptions(n,o,a,l)))return 0;for(const h of r)h.setParameters(this._fastUpdates.materialParameters);s.notifyShaderTransformationChanged()}return 2}computeComplexity(){return A(this._resources)?super.computeComplexity():{primitivesPerFeature:m7(this._resources.lodResources.levels[0]).reduce((e,i)=>e+i.indices.get("position").length,0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:xce(this.symbol,this.symbolLayer)}}hasLodRenderer(){return _(this._resources)}_createAs3DShape(e,i,r,s,n){if(!this.hasLodRenderer()||A(this._resources))return null;const o=this.getFastUpdateAttrValues(e),a=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?zT(r.color,r.opacity):null,l=this._context.clippingExtent;if(Gr(i,Kb,this._context.elevationProvider.spatialReference),_(l)&&!iL(l,Kb))return null;const c=this._requiresTerrainElevation(s),h=this._computeGlobalTransform(i,s,xU,iI),p=this._computeLocalTransform(this._resources,this.symbolLayer,r,ode),f=this._resources.lodRenderer.instanceData,g=f.addInstance();this._instanceIndexToGraphicUid.set(g,n),f.setLocalTransform(g,p,!1),f.setGlobalTransform(g,h),o&&f.setFeatureAttribute(g,o),a&&f.setColor(g,a);const y=new Kqe(this,g,H7e,s);return c&&(y.alignedSampledElevation=iI.sampledElevation),y.needsElevationUpdates=Cm(s.mode),BT(y,i,this._context.elevationProvider),y}_computeGlobalTransform(e,i,r,s){return kd(e,this._context.elevationProvider,i,this._context.renderCoordsHelper,s),Kb[0]=e.x,Kb[1]=e.y,Kb[2]=s.z,rc(e.spatialReference,Kb,r,this._context.renderCoordsHelper.spatialReference),r}_computeLocalTransform(e,i,r,s){return Di(s),this._applyObjectRotation(r,!1,s),this._applyObjectRotation(i,!0,s),this._applyObjectScale(e,r,s),this._applyAnchor(e,i,s),s}_applyObjectScale(e,i,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._drivenProperties.size&&i.size?i.size:e.symbolSize,n=hce(s,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||kP(r,r,n)}prepareSymbolLayerPatch(e){if(e.diff.type!=="partial")return;const i=e.diff.diff;this._preparePatchTransform(e,i),this._preparePatchColor(e,i)}updateGeometry(e,i){if(A(this._resources))return!0;const r=i&&GT(i);if(A(r))return!1;const s=this.getGeometryElevationMode(i);return e.elevationContext.mode===s&&(this._computeGlobalTransform(r,e.elevationContext,xU,iI),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=iI.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,xU,!0),BT(e,r,this._context.elevationProvider),!0)}_preparePatchTransform(e,i){if(!(i.heading||i.tilt||i.roll||i.width||i.height||i.depth||i.anchor||i.anchorPosition)||A(this._resources))return;const r=(y,v,b)=>st(y!=null&&y.type==="complete"?y.newValue:v,b),s=r(i.heading,this.symbolLayer.heading,0),n=r(i.tilt,this.symbolLayer.tilt,0),o=r(i.roll,this.symbolLayer.roll,0),a=r(i.width,this.symbolLayer.width,void 0),l=r(i.height,this.symbolLayer.height,void 0),c=r(i.depth,this.symbolLayer.depth,void 0),h=r(i.anchor,this.symbolLayer.anchor,void 0),p=r(i.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete i.heading,delete i.tilt,delete i.roll,delete i.width,delete i.height,delete i.depth,delete i.anchor,delete i.anchorPosition;const f={heading:s,tilt:n,roll:o,anchor:h,anchorPosition:p},g=this._resources;this.loadStatus===1&&e.symbolLayerStatePatches.push(()=>{g.symbolSize=Dn(sL(g.resourceSize,{width:a,height:l,depth:c,isPrimitive:this.symbolLayer.isPrimitive}))}),e.graphics3DGraphicPatches.push((y,v)=>{const b=this._computeLocalTransform(g,f,v,ode),w=y.instanceIndex;g.lodRenderer.instanceData.setLocalTransform(w,b,!0)})}_preparePatchColor(e,i){if(!i.material||i.material.type!=="partial")return;const r=i.material.diff;if(!r.color||r.color.type!=="complete"||r.color.newValue==null||r.color.oldValue==null)return;const s=r.color.newValue,n=_(s)?Ae.toUnitRGBA(s):wu;delete r.color;const o=this._resources;A(o)||e.graphics3DGraphicPatches.push(a=>{let l;this._hasPerInstanceColor()?(o.lodRenderer.instanceData.setColor(a.instanceIndex,n),l=this.setMaterialTransparencyParams({},s)):l=this.setMaterialTransparencyParams({externalColor:n},s);for(const c of o.stageResources.materials)c.setParameters(l)})}_requiresTerrainElevation(e){return e.mode!=="absolute-height"}_applyObjectRotation(e,i,r){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&i))return F7e(e.heading,e.tilt,e.roll,r)}_computeAnchor(e,i,r){const s=$();switch(r.anchor){case"center":re(s,Yl(e)),Fs(s,s);break;case"top":{const n=Yl(e);ne(s,-n[0],-n[1],-e[5]);break}case"bottom":{const n=Yl(e);ne(s,-n[0],-n[1],-e[2]);break}case"relative":{const n=Yl(e),o=pP(e),a=r.anchorPosition,l=a?De(a.x,a.y,a.z):Fn;SF(s,o,l),de(s,s,n),Fs(s,s);break}default:_(i)?Fs(s,i):re(s,Fn)}return s}_applyAnchor(e,i,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,i);s&&Vs(r,r,s)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,i,r,s){const n=_(e)?Dn(pP(e)):Kc,o=_(e)?this._computeAnchor(e,s,this.symbolLayer):Fn,a=this._context.renderCoordsHelper.unitInMeters,l=hce(_(i)?i:void 0,i,r,a),c=De(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:n,symbolSize:_(i)?i:Kc,unitInMeters:a,transformation:{anchor:o,scale:l,rotation:c}}}}const Kb=$(),ode=be(),xU=be(),tI=Ot(),iI=new UT;function yWe(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function vWe(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t}function SU(t,e,i,r,s){return t[0]=e,t[1]=i,t[2]=r,t[3]=s,t}function _We(t,e){if(t===e){const i=e[1];t[1]=e[2],t[2]=i}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t}function bWe(t,e){const i=e[0],r=e[1],s=e[2],n=e[3];let o=i*n-s*r;return o?(o=1/o,t[0]=n*o,t[1]=-r*o,t[2]=-s*o,t[3]=i*o,t):null}function wWe(t,e){const i=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=i,t}function xWe(t){return t[0]*t[3]-t[2]*t[1]}function ade(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=i[0],l=i[1],c=i[2],h=i[3];return t[0]=r*a+n*l,t[1]=s*a+o*l,t[2]=r*c+n*h,t[3]=s*c+o*h,t}function SWe(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(i),l=Math.cos(i);return t[0]=r*l+n*a,t[1]=s*l+o*a,t[2]=r*-a+n*l,t[3]=s*-a+o*l,t}function TWe(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=i[0],l=i[1];return t[0]=r*a,t[1]=s*a,t[2]=n*l,t[3]=o*l,t}function CWe(t,e){const i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=i,t[2]=-i,t[3]=r,t}function MWe(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t}function PWe(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function AWe(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2)}function $We(t,e,i,r){return t[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-t[2]*i[1],[t,e,i]}function EWe(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t}function lde(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t}function OWe(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function RWe(t,e){const i=t[0],r=t[1],s=t[2],n=t[3],o=e[0],a=e[1],l=e[2],c=e[3];return Math.abs(i-o)<=it*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-a)<=it*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(s-l)<=it*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=it*Math.max(1,Math.abs(n),Math.abs(c))}function IWe(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t}function DWe(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t}const FWe=ade,LWe=lde;Object.freeze({__proto__:null,copy:yWe,identity:vWe,set:SU,transpose:_We,invert:bWe,adjoint:wWe,determinant:xWe,multiply:ade,rotate:SWe,scale:TWe,fromRotation:CWe,fromScaling:MWe,str:PWe,frob:AWe,LDU:$We,add:EWe,subtract:lde,exactEquals:OWe,equals:RWe,multiplyScalar:IWe,multiplyScalarAndAdd:DWe,mul:FWe,sub:LWe});class kWe extends zi{constructor(e,i,r,s,n,o){super(e,i),this.path=r,this.geometrySR=s,this.upVectorAlignment=n,this.stencilWidth=o}}function cde(t){return"upVectorAlignment"in t}function ude(){return[1,0,0,1]}function zWe(t){return[t[0],t[1],t[2],t[3]]}function VWe(t,e,i,r){return[t,e,i,r]}function NWe(t,e){return new Float64Array(t,e,4)}Object.freeze({__proto__:null,create:ude,clone:zWe,fromValues:VWe,createView:NWe});function TU(){return{up:$(),right:$()}}function UWe(t,e,i){Oe(t.up,e.up,i),Oe(t.right,e.right,i)}function jWe(t,e,i){si(t,ye(i,e.right),ye(i,e.up))}class BWe{constructor(){this.pos=$(),this.posES=$(),this.posGS=$(),this.vRight=$(),this.vLeft=$(),this.frame=TU(),this.rotationFrame=TU(),this.rotationRight=ke(),this.rotationAngle=0,this.miterStretch=ude()}setFrameFromUpVector(e){re(this.frame.up,e),de(ml,this.vLeft,this.vRight),_e(ml,ml),se(Fc,this.frame.up,ye(ml,this.frame.up)),ue(sI,ml,Fc),_e(sI,sI),Ye(this.frame.right,sI,this.frame.up)}computeRotationAxisAndAngleFromUpVector(){re(this.rotationFrame.up,this.frame.up),re(this.rotationFrame.right,this.frame.right),si(this.rotationRight,1,0),se(Fc,this.frame.up,ye(this.frame.up,this.vLeft)),ue(Fc,this.vLeft,Fc),Fs(Fc,Fc),_e(Fc,Fc),se(ml,this.frame.up,ye(this.frame.up,this.vRight)),ue(ml,this.vRight,ml),_e(ml,ml),Ye(AU,this.rotationFrame.up,this.vLeft);const e=Math.sign(ye(AU,this.vRight));if(this.rotationAngle=e*(Math.PI-ar(ye(Fc,ml))),Math.abs(this.rotationAngle)>0){const r=IF(Math.cos(.5*this.rotationAngle));SU(this.miterStretch,r-1+1,0,0,1)}const i=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*i))}}class b3{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}addVertex(e,i){return this.vertices.push(g2(e)),this.vertexNormals.push(g2(i)),this.vertices.length-1}addUV(e){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(e),this.uvs.length-1}addPole(e,i=null){return this.poles.push({position:g2(e),normal:i?g2(i):null}),this.poles.length-1}addSegment(e,i=null,r=null){this.vertexIndices.push(e.v0),this.vertexIndices.push(e.v1),i&&(this.uvIndices.push(i.v0),this.uvIndices.push(i.v1)),r&&(this.poleIndices.push(r.v0),this.poleIndices.push(r.v1))}get numSegments(){return this.vertexIndices.length/2}hasUV(){return this.uvs!=null}translate(e,i){for(const r of this.vertices)r[0]+=e,r[1]+=i;for(const r of this.poles)r.position[0]+=e,r.position[1]+=i}static circle(e=20){const i=.5,r=new b3,s={v0:0,v1:0};r.addPole(Qt(0,0));for(let a=0;a<e;++a){const l=2*a*Math.PI/e,c=Math.cos(l),h=Math.sin(l),p=Qt(c*i,h*i),f=Qt(c,h);r.addVertex(p,f),r.addUV(a/e)}r.addUV(1);for(let a=0;a<e-1;++a){const l={v0:a,v1:a+1},c=l;r.addSegment(l,c,s)}const n={v0:e-1,v1:0},o={v0:e-1,v1:e};return r.addSegment(n,o,s),r}static rect(){const e=1,i=1,r=new b3,s=Qt(.5*-e,.5*-i),n=Qt(.5*e,.5*-i),o=Qt(.5*e,.5*i),a=Qt(.5*-e,.5*i),l=Qt(0,-1),c=Qt(1,0),h=Qt(0,1),p=Qt(-1,0);r.addUV(0),r.addUV(1),r.addPole(Qt(0,.5*i),h),r.addPole(Qt(0,.5*i)),r.addPole(Qt(0,.5*-i)),r.addPole(Qt(0,.5*-i),l);const f={v0:0,v1:1};return r.addVertex(s,l),r.addVertex(n,l),r.addSegment({v0:0,v1:1},f,{v0:3,v1:3}),r.addVertex(n,c),r.addVertex(o,c),r.addSegment({v0:2,v1:3},f,{v0:2,v1:1}),r.addVertex(o,h),r.addVertex(a,h),r.addSegment({v0:4,v1:5},f,{v0:0,v1:0}),r.addVertex(a,p),r.addVertex(s,p),r.addSegment({v0:6,v1:7},f,{v0:1,v1:2}),r}}class GWe{constructor(e){this.vertices=[],this.offset=$(),this.xform=be(),this.vertices=e;const i=Math.floor((e.length-1)/2);re(this.offset,this.vertices[i].pos);for(const r of this.vertices)ue(r.pos,r.pos,this.offset);Vs(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const e=this.vertices.length;let i=this.vertices[0];i.index=0,ne(i.vLeft,0,0,0),i.vLeftLength=0,ue(i.vRight,this.vertices[1].pos,i.pos),i.vRightLength=Te(i.vRight),_e(i.vRight,i.vRight);let r=i;for(let s=1;s<e;++s)i=this.vertices[s],i.index=s,re(i.vLeft,r.vRight),i.vLeftLength=r.vRightLength,s<e-1?(ue(i.vRight,this.vertices[s+1].pos,i.pos),i.vRightLength=Te(i.vRight),_e(i.vRight,i.vRight)):(re(i.vRight,i.vLeft),i.vRightLength=i.vLeftLength),r=i}}function qWe(t,e){let i=null;const r=t.vertices.length,s=.99619469809,n=$(),o=$(),a=$(),l=$(),c=$(),h=$(),p=Mt();let f=t.vertices[0];re(o,e),ne(n,0,1,0),Oo.makeOrthoBasisDirUpFallback(f.vRight,o,n,n,a,o,s),re(f.frame.up,o),re(f.frame.right,a),i=f;for(let g=1;g<r;++g){f=t.vertices[g],de(c,f.vLeft,f.vRight);let y=Te(c);y>0?(y=1/Math.sqrt(y),c[0]=c[0]*y,c[1]=c[1]*y,c[2]=c[2]*y):(c[0]=f.vRight[0],c[1]=f.vRight[1],c[2]=f.vRight[2]),de(h,i.pos,i.frame.up),k1(f.pos,c,p),vy(p,Ko(h,f.vLeft),l)?(ue(l,l,f.pos),_e(o,l),Ye(a,c,o),_e(a,a)):Oo.makeOrthoBasisDirUpFallback(c,i.frame.up,i.frame.right,n,a,o,s),re(f.frame.up,o),re(f.frame.right,a),i=f}}class HWe{numProfilesPerJoin(){return 1}extrude(e,i,r){for(let s=0;s<i.vertices.length;++s)r(e.index,e.frame,i.vertices[s],i.vertexNormals[s],!1)}}class CU{constructor(e=.8*Math.PI,i=1){this.cutoffAngle=e,this.numBendSubdivisions=i}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,i,r){const s=KWe;if(Math.abs(e.rotationAngle)>=this.cutoffAngle)for(let n=0;n<this.numBendSubdivisions+1;++n){Di(nI),Bi(nI,nI,.5*-e.rotationAngle+n*e.rotationAngle/this.numBendSubdivisions,e.rotationFrame.up),UWe(s,e.frame,nI);for(let o=0;o<i.vertices.length;++o)Sr(i.vertices[o],e.rotationRight)*e.rotationAngle>=0?r(e.index,s,i.vertices[o],i.vertexNormals[o],!1):(iV(hv,i.vertices[o],e.miterStretch),r(e.index,e.frame,hv,i.vertexNormals[o],!0))}else for(let n=0;n<this.numBendSubdivisions+1;++n)for(let o=0;o<i.vertices.length;++o){const a=Sr(i.vertices[o],e.rotationRight)*e.rotationAngle>=0;iV(hv,i.vertices[o],e.miterStretch),r(e.index,e.frame,hv,i.vertexNormals[o],!a)}}}const WWe={generateUV:!1};class MU{rebuildConnectingProfileGeometry(e,i,r){for(let s=0;s<i.vertices.length;++s)r(e.index,e.frame,i.vertices[s],i.vertexNormals[s],0,0)}}class hde extends MU{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class rI extends MU{constructor(e,i=0,r=!1){super(),this.profile=e,this.profilePlaneOffset=i,this.flip=r}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,i,r){for(let s=0;s<i.vertices.length;++s)r(e.index,e.frame,i.vertices[s],i.vertexNormals[s],this.profilePlaneOffset,0)}rebuildCapGeometry(e,i){const r=PU;si(r,0,0);const s=this.flip?1:-1;for(let n=0;n<this.profile.vertices.length;++n)i(e.index,e.frame,this.profile.vertices[n],r,this.profilePlaneOffset,s)}buildTopology(e,i){const r=this.vertexBufferStart+this.profile.vertexIndices[0];for(let s=1;s<this.profile.numSegments;++s){const n=this.profile.vertexIndices[2*s+0],o=this.profile.vertexIndices[2*s+1],a=this.vertexBufferStart+n,l=this.vertexBufferStart+o;this.flip?i(l,a,r):i(r,a,l)}}}class dde extends MU{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}getNumVertices(){let e=0;return e=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(e+=this.profile.vertices.length),e+=this.profile.poles.length,e}getNumIndices(){let e=0;e+=2*this.profile.numSegments*(this.numSegments-1);for(let i=0;i<this.profile.numSegments;++i){const r=this.profile.vertexIndices[2*i+0],s=this.profile.vertexIndices[2*i+1];this.profile.poleIndices[r]===this.profile.poleIndices[s]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,i){const r=e.frame,s=.5*this.sign,n=hv,o=PU;si(o,0,0);for(let a=0;a<this.profile.poles.length;++a){const l=this.profile.poles[a];l.normal?i(e.index,r,l.position,l.normal,s,0):i(e.index,r,l.position,o,s,this.sign)}if(this.breakNormals)for(let a=0;a<this.profile.vertices.length;++a)i(e.index,r,this.profile.vertices[a],this.profile.vertexNormals[a],0,0);for(let a=0;a<this.numSegments-1;++a){const l=(1-(a+1)/this.numSegments)*Math.PI*.5,c=Math.sin(l),h=Math.cos(l);for(let p=0;p<this.profile.vertices.length;++p){const f=this.profile.poles[this.profile.poleIndices[p]];ku(n,this.profile.vertices[p],f.position),Ao(n,n,c),f.normal?(Tc(n,n,f.position),i(e.index,r,n,f.normal,s*h,0)):(NS(o,n),Ao(o,o,c),Tc(n,n,f.position),i(e.index,r,n,o,s*h,this.sign*h))}}}buildTopology(e,i){const r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,s=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let n=0;n<this.profile.numSegments;++n){const o=this.profile.vertexIndices[2*n+0],a=this.profile.vertexIndices[2*n+1],l=this.vertexBufferStart+this.profile.poleIndices[o],c=this.vertexBufferStart+this.profile.poleIndices[a];let h=r+o,p=r+a;for(let f=0;f<this.numSegments-1;++f){const g=s+f*this.profile.vertices.length+o,y=s+f*this.profile.vertices.length+a;this.flip?(i(g,p,h),i(p,g,y)):(i(h,p,g),i(y,g,p)),h=g,p=y}this.flip?(i(l,p,h),l!==c&&i(l,c,p)):(i(h,p,l),l!==c&&i(p,c,l))}}}class ZWe{constructor(e,i,r,s,n,o=WWe){this.options=o,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=i,this.path=e,this.extruder=r,this.startCap=s,this.endCap=n;const a=this.path.vertices.length-2;this.numExtrusionProfiles=r.numProfilesPerJoin()*a+2,this.numVerticesTotal=i.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const l=this.startCap.getNumVertices();this.numVerticesTotal+=l,this.numNormalsTotal+=l,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.getNumVertices();this.numVerticesTotal+=c,this.numNormalsTotal+=c,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this.rebuildGeometry(),this.buildTopology()}emitVertex(e,i,r,s,n){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=i.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=i.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=i.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=i.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=i.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=i.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,n){const o=this.path.vertices[e];this.profileRightAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[0]*o.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[1]*o.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(e,i,r,s,n,o){this.profileRightAxisData[4*this._extrusionVertexCount+0]=i.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=i.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=i.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=i.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=i.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=i.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,this.profileRightAxisData[4*this._extrusionVertexCount+3]=n,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o,++this._extrusionVertexCount}emitTriangle(e,i,r){this.vertexIndices[3*this._triangleCount+0]=e,this.vertexIndices[3*this._triangleCount+1]=i,this.vertexIndices[3*this._triangleCount+2]=r,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[e],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[i],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[r],this.normalIndices[3*this._triangleCount+0]=e,this.normalIndices[3*this._triangleCount+1]=i,this.normalIndices[3*this._triangleCount+2]=r,++this._triangleCount}rebuildGeometry(){const e=(r,s,n,o,a)=>this.emitVertex(r,s,n,o,a),i=(r,s,n,o,a,l)=>this.emitCapVertex(r,s,n,o,a,l);this._extrusionVertexCount=0;for(const r of this.path.vertices)this.originData[3*r.index+0]=r.pos[0],this.originData[3*r.index+1]=r.pos[1],this.originData[3*r.index+2]=r.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,i);for(let r=1;r<this.path.vertices.length-1;++r)this.extruder.extrude(this.path.vertices[r],this.profile,e);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,i),this.startCap.rebuildCapGeometry(this.path.vertices[0],i),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],i),this.profile.hasUV()&&this.options.generateUV)for(let r=0;r<this.profile.uvs.length;++r)this.uvData[2*r+0]=this.profile.uvs[r],this.uvData[2*r+1]=0}buildTopology(){const e=(o,a,l)=>this.emitTriangle(o,a,l);this._triangleCount=0;const i=this.profile.vertices.length,r=this.profile.numSegments,s=this.numExtrusionProfiles-1;let n=3*(2*(r*s));this.startCap.indexBufferStart=n,this.startCap.firstProfileVertexIndex=0,n+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=n,this.endCap.firstProfileVertexIndex=i*(this.numExtrusionProfiles-1),n+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(n),this.normalIndices=new Uint32Array(n),this.pathVertexIndices=new Uint32Array(n),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(n));for(let o=0;o<r;++o){const a=this.profile.vertexIndices[2*o],l=this.profile.vertexIndices[2*o+1];for(let c=0;c<s;++c){const h=c*i+a,p=(c+1)*i+l,f=c*i+l;e(h,(c+1)*i+a,p),e(h,p,f)}}this.startCap.buildTopology(this.path.vertices[0],e),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],e)}onPathChanged(){this.rebuildGeometry()}}class pde{constructor(e){this.builder=e}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}}class fde extends pde{constructor(e){super(e),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;for(let i=0;i<this.builder.numVerticesTotal;++i){let r=this.builder.pathVertexData[i];const s=r===0||r===this.builder.path.vertices.length-1;r*=3;const n=QWe;ne(n,this.builder.originData[r++],this.builder.originData[r++],this.builder.originData[r]);const o=4*i,a=Fc,l=hv,c=ml,h=AU,p=XWe;let f=0,g=0;if(ne(h,this.builder.profileRightAxisData[o],this.builder.profileRightAxisData[o+1],this.builder.profileRightAxisData[o+2]),ne(p,this.builder.profileUpAxisData[o],this.builder.profileUpAxisData[o+1],this.builder.profileUpAxisData[o+2]),si(l,this.builder.profileVertexAndNormalData[o]*e[0],this.builder.profileVertexAndNormalData[o+1]*e[1]),s)Ye(c,p,h),f=this.builder.profileRightAxisData[o+3]*e[0],g=this.builder.profileUpAxisData[o+3];else{const v=PU,b=YWe;si(v,this.builder.profileRightAxisData[o+3],this.builder.profileUpAxisData[o+3]);const w=eV(v);NS(v,v);const S=Sr(l,v);if(Math.abs(S)>w){si(b,-v[1],v[0]);const T=Sr(l,b);Ao(v,v,w*Math.sign(S)),Ao(b,b,T),Tc(l,v,b)}ne(c,0,0,0)}ne(a,h[0]*l[0]+p[0]*l[1],h[1]*l[0]+p[1]*l[1],h[2]*l[0]+p[2]*l[1]),this.vertexAttributePosition[3*i+0]=n[0]+a[0]+c[0]*f,this.vertexAttributePosition[3*i+1]=n[1]+a[1]+c[1]*f,this.vertexAttributePosition[3*i+2]=n[2]+a[2]+c[2]*f;const y=hv;si(y,this.builder.profileVertexAndNormalData[o+2],this.builder.profileVertexAndNormalData[o+3]),this.vertexAttributeNormal[3*i+0]=h[0]*y[0]+p[0]*y[1]+c[0]*g,this.vertexAttributeNormal[3*i+1]=h[1]*y[0]+p[1]*y[1]+c[1]*g,this.vertexAttributeNormal[3*i+2]=h[2]*y[0]+p[2]*y[1]+c[2]*g}}createGeometryData(){const e=[["position",this.builder.vertexIndices],["normal",this.builder.normalIndices]],i=[["position",{size:3,data:this.vertexAttributePosition,exclusive:!0}],["normal",{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];if(this.vertexAttributeColor){const r=this.builder.vertexIndices.length;e.push(["color",new Uint32Array(r)]),i.push(["color",{size:4,data:this.vertexAttributeColor}])}return{vertexAttributes:i,indices:e}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(e,i,r){const s=this.builder.vertexIndices,n={size:3,data:this.vertexAttributePosition},o=s.length/3;OT(e,i,0,o,s,n,void 0,void 0,r)}}class JWe extends pde{constructor(e,i,r,s){super(e),this.sizeAttributeValue=i,this.colorAttributeValue=r,this.opacityAttributeValue=s,this.vvData=null,this.baked=new fde(e),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let n=0;n<this.builder.path.vertices.length;++n){this.vvData[4*n+0]=i,this.vvData[4*n+1]=r,this.vvData[4*n+2]=s;const o=n===0||n===this.builder.path.vertices.length-1;this.vvData[4*n+3]=o?1:0}}createGeometryData(){return{vertexAttributes:[["position",{size:3,data:this.builder.originData,exclusive:!0}],["profileRight",{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],["profileUp",{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],["profileVertexAndNormal",{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],["featureValue",{size:4,data:this.vvData,exclusive:!0}]],indices:[["position",this.builder.pathVertexIndices],["profileRight",this.builder.vertexIndices],["profileUp",this.builder.vertexIndices],["profileVertexAndNormal",this.builder.vertexIndices],["featureValue",this.builder.pathVertexIndices]]}}}const QWe=$(),hv=ke(),PU=ke(),YWe=ke(),Fc=$(),ml=$(),AU=$(),XWe=$(),sI=$(),KWe=TU(),nI=be();function eZe(t,e){t.attributes.add("featureValue","vec4"),t.vertex.code.add(x`bool isCapVertex() {
return featureValue.w == 1.0;
}`),t.vertex.uniforms.add("size","vec3"),e.vvSize?(t.vertex.uniforms.add("vvSizeMinSize","vec3"),t.vertex.uniforms.add("vvSizeMaxSize","vec3"),t.vertex.uniforms.add("vvSizeOffset","vec3"),t.vertex.uniforms.add("vvSizeFactor","vec3"),t.vertex.code.add(x`vec2 getSize() {
return size.xy*clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
}`)):t.vertex.code.add(x`vec2 getSize(){
return size.xy;
}`),e.vvOpacity?(t.vertex.constants.add("vvOpacityNumber","int",8),t.vertex.code.add(x`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
vec4 applyOpacity(vec4 color) {
float value = featureValue.z;
if (value <= vvOpacityValues[0]) {
return vec4( color.xyz, vvOpacityOpacities[0]);
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
}
}
return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
}`)):t.vertex.code.add(x`vec4 applyOpacity(vec4 color){
return color;
}`),e.vvColor?(t.vertex.constants.add("vvColorNumber","int",8),t.vertex.code.add(x`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 getColor() {
float value = featureValue.y;
if (value <= vvColorValues[0]) {
return applyOpacity(vvColorColors[0]);
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
}
}
return applyOpacity(vvColorColors[vvColorNumber - 1]);
}`)):t.vertex.code.add(x`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),t.include(AR),t.attributes.add("profileRight","vec4"),t.attributes.add("profileUp","vec4"),t.attributes.add("profileVertexAndNormal","vec4"),t.vertex.code.add(x`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),t.vertex.code.add(x`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),t.vertex.code.add(x`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),t.vertex.code.add(x`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}function tZe(t,e){e.vvSizeEnabled&&(t.setUniform3fv("vvSizeMinSize",e.vvSizeMinSize),t.setUniform3fv("vvSizeMaxSize",e.vvSizeMaxSize),t.setUniform3fv("vvSizeOffset",e.vvSizeOffset),t.setUniform3fv("vvSizeFactor",e.vvSizeFactor)),e.vvColorEnabled&&(t.setUniform1fv("vvColorValues",e.vvColorValues),t.setUniform4fv("vvColorColors",e.vvColorColors)),e.vvOpacityEnabled&&(t.setUniform1fv("vvOpacityValues",e.vvOpacityValues),t.setUniform1fv("vvOpacityOpacities",e.vvOpacityOpacities))}function iZe(t){const e=new pi;return e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),e.varyings.add("vpos","vec3"),e.include(eZe,t),t.output!==0&&t.output!==7||(e.include(Ss,{linearDepth:!1}),t.receiveShadows&&e.include(Bd,t),e.include(QT,t),e.varyings.add("vnormal","vec3"),e.varyings.add("vcolor","vec4"),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(x`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${t.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${t.output===0?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),t.multipassTerrainEnabled&&(e.fragment.include(Lr),e.include(ll,t)),t.output===7&&(e.include(Zi,t),e.fragment.uniforms.add("camPos","vec3"),e.fragment.uniforms.add("localOrigin","vec3"),e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `)),t.output===0&&(e.include(Zi,t),e.include(r3,t),e.include($R,t),t.receiveShadows&&e.include(Bd,t),e.include(Hue,t),e.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("specular","vec3").add("opacity","float"),e.fragment.include(yd),e.fragment.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

        shadingParams.viewDirection = normalize(vpos - camPos);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${t.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":t.viewingMode===1?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
        gl_FragColor = vec4(shadedColor, combinedOpacity);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.output!==1&&t.output!==3||(e.include(Ss,{linearDepth:!0}),e.vertex.uniforms.add("nearFar","vec2"),e.varyings.add("depth","float"),e.vertex.code.add(x`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),e.include(Zi,t),e.include(J0,t),e.fragment.uniforms.add("timeElapsed","float"),e.fragment.code.add(x`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`)),t.output===2&&(e.include(Ss,{linearDepth:!1}),e.include(Em,t),e.vertex.uniforms.add("viewNormal","mat4"),e.varyings.add("vnormal","vec3"),e.vertex.code.add(x`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Zi,t),e.fragment.uniforms.add("waterColor","vec4"),e.fragment.code.add(x`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`)),t.output===4&&(e.include(Ss,{linearDepth:!1}),e.include(Em,t),e.vertex.uniforms.add("viewNormal","mat4"),e.varyings.add("vnormal","vec3"),e.vertex.code.add(x`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Zi,t),e.include(Dd),e.fragment.code.add(x`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),e}const rZe=Object.freeze({__proto__:null,build:iZe}),mde=new Map([["position",0],["profileRight",1],["profileUp",2],["profileVertexAndNormal",3],["featureValue",4]]);class oI extends Si{initializeProgram(e){const i=oI.shader.get(),r=this.configuration,s=i.build({OITEnabled:r.transparencyPassType===0,output:r.output,viewingMode:e.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!0,vvOpacity:r.vvOpacity,pbrMode:0,useCustomDTRExponentForWater:!1,receiveAmbientOcclusion:r.receiveSSAO,doubleSidedMode:r.doubleSidedMode,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new fi(e.rctx,s,mde)}bindPass(e,i){var r,s;Pc(this.program,i.camera.projectionMatrix),this.program.setUniform3fv("size",e.size),i.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),wm(this.program,i)),this.configuration.output!==0&&this.configuration.output!==7||this.program.setUniform1f("opacity",e.opacity),this.configuration.output===0?(i.lighting.setUniforms(this.program,!1),this.program.setUniform3fv("ambient",e.ambient),this.program.setUniform3fv("diffuse",e.diffuse),this.program.setUniform3fv("specular",e.specular),this.program.setUniform1f("opacity",e.opacity)):this.configuration.output!==1&&this.configuration.output!==3||Rke(this.program,i.camera.nearFar),tZe(this.program,e),(r=i.shadowMap)==null||r.bind(this.program),(s=i.ssaoHelper)==null||s.bind(this.program,i.camera)}bindDraw(e){Yf(this.program,e),_m(this.program,this.configuration,e),this.program.rebindTextures(),this.configuration.output!==0&&this.configuration.output!==7||Qf(this.program,e.origin,e.camera.viewInverseTransposeMatrix),this.configuration.output===0&&Oje(this.program,e),this.configuration.output===2&&rv.bindUniforms(this.program,e.camera.viewInverseTransposeMatrix)}setPipelineState(e){const i=this.configuration,r=e===3,s=e===2,n=o=>!o.slicePlaneEnabled&&!(o.transparent||o.doubleSidedMode===0);return _t({blending:i.output!==0&&i.output!==7||!i.transparent?null:r?qu:xm(e),culling:n(i)&&Kse,depthTest:{func:U0(e)},depthWrite:r||s?$o:null,colorWrite:Pt,stencilWrite:i.sceneHasOcludees?$m:null,stencilTest:i.sceneHasOcludees?Q0:null,polygonOffset:r||s?null:WO})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}oI.shader=new vi(rZe,()=>import("./Path.glsl.414d99f1.js"));class Do extends tr{constructor(){super(...arguments),this.output=0,this.doubleSidedMode=0,this.receiveShadows=!1,this.receiveSSAO=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([X({count:8})],Do.prototype,"output",void 0),u([X({count:3})],Do.prototype,"doubleSidedMode",void 0),u([X()],Do.prototype,"receiveShadows",void 0),u([X()],Do.prototype,"receiveSSAO",void 0),u([X()],Do.prototype,"vvSize",void 0),u([X()],Do.prototype,"vvColor",void 0),u([X()],Do.prototype,"vvOpacity",void 0),u([X()],Do.prototype,"slicePlaneEnabled",void 0),u([X()],Do.prototype,"transparent",void 0),u([X()],Do.prototype,"sceneHasOcludees",void 0),u([X({count:4})],Do.prototype,"transparencyPassType",void 0),u([X()],Do.prototype,"multipassTerrainEnabled",void 0),u([X()],Do.prototype,"cullAboveGround",void 0);const sZe=Ze;class $U extends Id{constructor(e){super(e,oZe),this.supportsEdges=!0,this._vertexAttributeLocations=mde,this.techniqueConfig=new Do,this.vertexBufferLayout=$U.getVertexBufferLayout(this.parameters)}getTechniqueConfig(e,i){return this.techniqueConfig.output=e,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,e!==0&&e!==7||(this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?1:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?2:0,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows,this.techniqueConfig.receiveSSAO=!!i.ssaoEnabled&&this.parameters.receiveSSAO),this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}isVisibleInPass(e){return e!==4&&e!==6&&e!==7||this.parameters.castShadows}isVisible(){const e=this.parameters;return!!super.isVisible()&&e.opacity>0}intersect(e,i,r,s,n,o,a){const l=e;if(!cde(l))return;const c=l.path,h=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const w=this.parameters.vvSizeOffset,S=this.parameters.vvSizeFactor,T=this.parameters.vvSizeMinSize,C=this.parameters.vvSizeMaxSize,M=c.sizeAttributeValue;h[0]*=Re(w[0]+M*S[0],T[0],C[0]),h[1]*=Re(w[2]+M*S[2],T[2],C[2])}const p=Math.max(h[0],h[1]),f=e.boundingInfo;if(A(f))return void this._intersectTriangles(c,h,n,o,a);const g=Hg(f.bbMin[0]-p,f.bbMin[1]-p,f.bbMin[2]-p,f.bbMax[0]+p,f.bbMax[1]+p,f.bbMax[2]+p),y=[o[0]-n[0],o[1]-n[1],o[2]-n[2]],v=Math.sqrt(y[0]*y[0]+y[1]*y[1]+y[2]*y[2]),b=[v/y[0],v/y[1],v/y[2]];qN(g,n,b,s.tolerance)&&this._intersectTriangles(c,h,n,o,a)}_intersectTriangles(e,i,r,s,n){e.baked.size&&e.baked.size[0]===i[0]&&e.baked.size[1]===i[1]||e.baked.bake(i),e.baked.intersect(r,s,n)}computeAttachmentOrigin(e,i){const r=e.vertexAttributes;if(!r)return null;const s=r.get("position");return OV(s,null,!1,i)}createBufferWriter(){return new aZe(this.vertexBufferLayout)}requiresSlot(e){return e===(this.parameters.transparent?4:2)||e===20}createGLMaterial(e){return e.output===0||e.output===7||e.output===1||e.output===2||e.output===4||e.output===3&&this.parameters.castShadows?new nZe(e):null}static getVertexBufferLayout(e){let i=zr().vec3f("position").vec4f("profileRight").vec4f("profileUp").vec4f("profileVertexAndNormal");return(e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(i=i.vec4f("featureValue")),i}}class nZe extends vm{updateParameters(e){return this.ensureTechnique(oI,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}_updateShadowState(e){(A(this.technique)||e.shadowMappingEnabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:e.shadowMappingEnabled})}beginSlot(e){return this._output!==0&&this._output!==7||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)}bind(e,i){i.bindPass(this._material.getPassParameters(),e)}}const oZe=E(E({size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1},Xce.Default),Gu);class aZe{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,i,r,s){const n=o=>{if(i.vertexAttributes.has(o)){const a=i.vertexAttributes.get(o),l=i.indices.get(o);sZe(a.size===4);const c=r.getField(o,Zr);if(!c)throw new Error("unable to acquire view for "+o);Pb(l,a.data,c,s)}};n("profileRight"),n("profileUp"),n("profileVertexAndNormal"),this.vertexBufferLayout.hasField("featureValue")&&n("featureValue"),BO(i,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,s)}}const lZe=["polyline"];class cZe extends Zu{constructor(e,i,r,s){super(e,i,r,s),this._intrinsicSize=Qt(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const e=_(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,i=_(this.symbolLayer.height)?this.symbolLayer.height:e;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,i],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=l3(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const r=this.symbolLayer.anchor||"center";this.upVectorAlignment="path",this.symbolLayer.profileRotation==="heading"&&(this.upVectorAlignment="world");const s=this.symbolLayer.profile||"circle";switch(s){case"circle":default:this._profile=b3.circle(fZe);break;case"quad":this._profile=b3.rect()}let n=[0,0];switch(r!=="center"&&(n={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(n[0],n[1])),this.symbolLayer.join||"simple"){case"round":this._extruder=new CU(0,pZe);break;case"bevel":this._extruder=new CU(0,1);break;case"miter":this._extruder=new CU(.8*Math.PI,1);break;default:this._extruder=new HWe}const o=this.symbolLayer.cap||"butt";switch(o){case"none":this._startCap=new hde,this._endCap=new hde;break;case"butt":default:this._startCap=new rI(this._profile,0),this._endCap=new rI(this._profile,0,!0);break;case"square":this._startCap=new rI(this._profile,-.5),this._endCap=new rI(this._profile,.5,!0);break;case"round":{const g=s==="quad";this._startCap=new dde({profile:this._profile,flip:!1,breakNormals:g,subdivisions:bde}),this._endCap=new dde({profile:this._profile,flip:!0,breakNormals:g,subdivisions:bde});break}}const a=or(this.symbolLayer,"material","color"),l=this._getCombinedOpacityAndColor(a),c=Dn(l),h=l[3],p=h<1||this.needsDrivenTransparentPass,f={diffuse:c,ambient:c,opacity:h,transparent:p,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:p||o==="none"?0:2,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(si(this._intrinsicSize,e,i),!YO(this._intrinsicSize[0])||!YO(this._intrinsicSize[1])))throw new Q("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||Ao(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(Object.assign(f,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new $U(f)):(f.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new sv(f)),this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const i=e.graphic;if(!this._validateGeometry(i.geometry,lZe,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new ma),s=e.renderingInfo;return this._createAs3DShape(i,s,r,i.uid)}layerOpacityChanged(){const e=or(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(e),r=i<1||this.needsDrivenTransparentPass;return this._material.setParameters({opacity:i,transparent:r}),!0}layerElevationInfoChanged(e,i){return this.updateGraphics3DGraphicElevationInfo(e,i,Cm)}slicePlaneEnabledChanged(){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}applyRendererDiff(e,i){for(const r in e.diff){if(r!=="visualVariables"||!c3(this._fastUpdates,i,this._vvConvertOptions))return 0;this._material.setParameters(this._fastUpdates.materialParameters)}return 2}getVertexData(e){let i=0;const r=e.paths,s=[],n=e.spatialReference,o=this._context.elevationProvider.spatialReference,a=this._context.renderCoordsHelper.spatialReference;for(const g of r)i+=g.length;const l=new Float64Array(3*i),c=new Float64Array(3*i),h=new Float64Array(3*i);let p=0;for(const g of r){s.push({index:p,numVertices:g.length});for(const y of g)l[p++]=y[0],l[p++]=y[1],l[p++]=e.hasZ?y[2]:0}let f=!0;return n.equals(o)?this._copyVertices(l,0,c,0,i):f=Mi(l,n,0,c,o,0,i),o.equals(a)?this._copyVertices(c,0,h,0,i):Mi(c,o,0,h,a,0,i),{pathVertexDataInfos:s,vertexDataGS:l,vertexDataES:c,vertexDataRS:h,projectionSuccess:f,terrainElevation:0}}_copyVertices(e,i,r,s,n){i*=3,s*=3;for(let o=0;o<n;++o)r[s++]=e[i++],r[s++]=e[i++],r[s++]=e[i++]}_createAs3DShape(e,i,r,s){const n=e.geometry,o=new Array,a=new Array,l=new Array,c=n.spatialReference,h=lr(),p=this._context.renderCoordsHelper;vde.spatialReference=c;const f=this.getVertexData(n);if(!f.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(f.pathVertexDataInfos.length>0){for(let g=0;g<f.pathVertexDataInfos.length;++g){const y=f.pathVertexDataInfos[g],v=y.index,b=y.numVertices;if(b<2||_(this._context.clippingExtent)&&(ii(h),Ql(h,f.vertexDataES,3*v,b),!Xl(h,this._context.clippingExtent)))continue;const w=[];for(let z=v;z<v+3*b;){const D=z++,U=z++,G=z++,k=new BWe;ne(k.posGS,f.vertexDataGS[D],f.vertexDataGS[U],f.vertexDataGS[G]),ne(k.posES,f.vertexDataES[D],f.vertexDataES[U],f.vertexDataES[G]);const j=L7e(k.posES,this._context.elevationProvider,r,p);ne(gl,f.vertexDataRS[D],f.vertexDataRS[U],f.vertexDataRS[G]),p.setAltitude(gl,j),ne(k.pos,gl[0],gl[1],gl[2]),w.push(k)}const S=new GWe(w);gde(S,this.upVectorAlignment,this._context.renderCoordsHelper);const T=new ZWe(S,this._profile,this._extruder,this._startCap,this._endCap);let C=null;if(this._fastUpdates.enabled){const z=this._fastUpdates.visualVariables,D=z.size?Vd(z.size.field,e):0,U=z.color?Vd(z.color.field,e):0,G=z.opacity?Vd(z.opacity.field,e):0;C=new JWe(T,D,U,G)}else{const z=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(z[0]*=yde(i.size[0],i.size[2]==="symbol-value"?this.symbolLayer.height||0:i.size[2],this.symbolLayer.width||0),z[1]*=yde(i.size[2],i.size[0]==="symbol-value"?this.symbolLayer.width||0:i.size[0],this.symbolLayer.height||0));let D=null;this._drivenProperties.color&&(D=i.color),this._drivenProperties.opacity&&i.opacity!=null&&(D=D?[D[0],D[1],D[2],i.opacity]:[1,1,1,i.opacity]);const U=new fde(T);U.bake(z),D&&U.bakeVertexColors(D),C=U}const{vertexAttributes:M,indices:P}=C.createGeometryData(),F=new kWe(M,P,C,c,this.upVectorAlignment,this.stencilWidth);o.push(F),a.push(this._material),l.push(C.xform)}if(o.length>0){const g={layerUid:this._context.layer.uid,graphicUid:s},y=new Nd({geometries:o,materials:a,transformations:l,metadata:g}),v=new Wu(this,y,o,null,null,hZe,r);return v.alignedSampledElevation=f.terrainElevation,v.needsElevationUpdates=Cm(r.mode),v}}else n.paths.length!==0&&n.paths.some(g=>g.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}}function gde(t,e,i){switch(e){case"world":for(const r of t.vertices)de(nh,r.pos,t.offset),i.worldUpAtPosition(nh,gl),r.setFrameFromUpVector(gl),r.computeRotationAxisAndAngleFromUpVector();break;case"path":de(nh,t.vertices[0].pos,t.offset),i.worldUpAtPosition(nh,gl),qWe(t,gl);for(const r of t.vertices){const s=Math.sign(ye(r.frame.right,r.vRight));Ye(r.rotationFrame.up,r.vRight,r.vLeft),se(r.rotationFrame.up,r.rotationFrame.up,s),_e(r.rotationFrame.up,r.rotationFrame.up);const n=ye(r.rotationFrame.up,r.frame.up),o=ye(r.rotationFrame.up,r.frame.right);if(se(nh,r.frame.up,-o),se(_de,r.frame.right,n),de(nh,nh,_de),_e(r.rotationFrame.right,nh),jWe(r.rotationRight,r.frame,r.rotationFrame.right),Fs(nh,r.vLeft),r.rotationAngle=-s*(Math.PI-ar(ye(nh,r.vRight))),Math.abs(r.rotationAngle)>0){const l=IF(Math.cos(.5*r.rotationAngle));SU(r.miterStretch,1+(l-1)*r.rotationRight[0]*r.rotationRight[0],(l-1)*r.rotationRight[0]*r.rotationRight[1],(l-1)*r.rotationRight[0]*r.rotationRight[1],1+(l-1)*r.rotationRight[1]*r.rotationRight[1])}const a=Math.PI-r.rotationAngle;r.maxStretchDistance=Math.abs(Math.min(r.vLeftLength,r.vRightLength)*IF(Math.cos(.5*a)))}}}function yde(t,e,i){switch(t){case"symbol-value":return i;case"proportional":return e;default:return t}}function uZe(t,e,i,r){let s=0;for(const n of t.vertices)kd(n.posES,i,e,r,EU),s+=EU.sampledElevation,de(gl,n.pos,t.offset),r.setAltitude(gl,EU.z),ue(n.pos,gl,t.offset);return t.updatePathVertexInformation(),s/t.vertices.length}function hZe(t,e,i,r){const s=t.stageObject,n=s.geometryRecords;let o=0;dZe.spatialReference=r.spatialReference;for(const a of n){const l=a.geometry;if(!cde(l))continue;const c=l.path,h=c.builder.path,p=l.geometrySR;vde.spatialReference=p,o+=uZe(h,e,i,r),l.upVectorAlignment!=="world"&&gde(h,l.upVectorAlignment,r),c.onPathChanged(),l.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(a)}return o/n.length}const dZe=Ld(0,0,0,null),vde=Ld(0,0,0,null),gl=$(),nh=li(),_de=li(),EU=new UT,pZe=3,bde=3,fZe=10;function mZe(t,e,i,r,s=1){if(i.isGeographic&&r!==2){const a=new Float64Array(e.typedBuffer.length),l=3*e.count,c=Ut(i);for(let h=0;h<l;h+=3)u6(e.typedBuffer,h,a,h,c);e=ir.fromTypedArray(a)}si(Pr,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let a=0;a<e.count;a++)e.getVec(a,Fo),Pr[0]=Math.min(Pr[0],Fo[0]),Pr[1]=Math.min(Pr[1],Fo[1]);const n=Pr[0]%s,o=Pr[1]%s;yl[0]=Pr[0]-n,yl[1]=Pr[1]-o;for(let a=0;a<e.count;a++)e.getVec(a,Fo),t.setValues(a,(Fo[0]-yl[0])/s,(Fo[1]-yl[1])/s,yl[0]/s,yl[1]/s)}function wde(t,e,i,r,s=1){ne(dv,1,0,0),ne(pv,0,1,0),ne(ew,0,0,1),vZe(OU,e),gZe(e,xde)&&yZe(xde,dv,pv,ew,i,OU),si(Pr,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),si(fv,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let l=0;l<e.count;l++){e.getVec(l,Fo);const c=ye(dv,Fo),h=ye(pv,Fo);Pr[0]=Math.min(Pr[0],c),Pr[1]=Math.min(Pr[1],h),fv[0]=Math.max(fv[0],c),fv[1]=Math.max(fv[1],h)}const n=ye(ew,OU);IU(Dm,Pr[0],Pr[1],n,dv,pv,ew),IU(mv,fv[0],Pr[1],n,dv,pv,ew),IU(gv,Pr[0],fv[1],n,dv,pv,ew),ue(mv,mv,Dm),se(mv,mv,.5),ue(gv,gv,Dm),se(gv,gv,.5),de(Dm,Dm,mv),de(Dm,Dm,gv);const o=Pr[0]%s,a=Pr[1]%s;yl[0]=Pr[0]-o,yl[1]=Pr[1]-a;for(let l=0;l<e.count;l++){e.getVec(l,Fo),t.setValues(l,(ye(dv,Fo)-yl[0])/s,(ye(pv,Fo)-yl[1])/s,yl[0]/s,yl[1]/s);for(let c=0;c<3;c++)r.set(l,c,Dm[c]),r.set(l,c+3,mv[c]),r.set(l,c+6,gv[c])}}const OU=$(),Fo=$(),xde=Mt(),dv=$(),pv=$(),ew=$(),Pr=ke(),fv=ke(),yl=ke(),Dm=$(),mv=$(),gv=$();function gZe(t,e){const i=t.count-1;return dQ(t,e,0,Math.floor(i/3),Math.floor(i*(2/3)))}function yZe(t,e,i,r,s,n){_(s)?(s.basisMatrixAtPosition(n,oh),ne(aI,oh[0],oh[1],oh[2]),ne(lI,oh[4],oh[5],oh[6]),ne(RU,oh[8],oh[9],oh[10])):(ne(aI,1,0,0),ne(lI,0,1,0),ne(RU,0,0,1));const o=Li(t);ye(o,RU)<0&&se(o,o,-1),re(r,o);const a=ye(o,lI),l=ye(o,aI);Math.abs(a)<Math.abs(l)?(TF(e,aI,o,-l),_e(e,e),Ye(i,e,o),_e(i,i),se(i,i,-1)):(TF(i,lI,o,-a),_e(i,i),Ye(e,i,o),_e(e,e))}const oh=be(),aI=$(),lI=$(),RU=$();function vZe(t,e){ne(cI,0,0,0);for(let i=0;i<e.count-1;i++)e.getVec(i,Fo),de(cI,cI,Fo);se(t,cI,1/(e.count-1))}const cI=$();function IU(t,e,i,r,s,n,o){ne(t,e*s[0]+i*n[0]+r*o[0],e*s[1]+i*n[1]+r*o[1],e*s[2]+i*n[2]+r*o[2])}function _Ze(t){const e=new pi,i=t.output===1;return e.include(Ss,{linearDepth:i}),e.include(iv,t),e.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.attributes.add("position","vec3"),e.varyings.add("vpos","vec3"),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),i&&(e.include(J0,t),e.vertex.uniforms.add("cameraNearFar","vec2"),e.varyings.add("linearDepth","float")),e.vertex.code.add(x`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      ${t.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${i?x`transformPositionWithDepth(proj, view, vpos, cameraNearFar, linearDepth);`:x`transformPosition(proj, view, vpos);`}
    }
  `),e.include(Zi,t),e.fragment.include(yd),t.multipassTerrainEnabled&&(e.fragment.include(Lr),e.include(ll,t)),e.fragment.uniforms.add("eColor","vec4"),t.output===4&&e.include(Dd),e.fragment.code.add(x`
  void main() {
    discardBySlice(vpos);
    ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 color = ${t.attributeColor?"vColor * eColor;":"eColor;"}

    if (color.a < ${x.float(tn)}) {
      discard;
    }

    ${t.output===7?x`gl_FragColor = vec4(color.a);`:""}

    ${t.output===0?x`gl_FragColor = highlightSlice(color, vpos); ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${t.output===4?x`outputHighlight();`:""};
    ${t.output===1?x`outputDepth(linearDepth);`:""};
  }
  `),e}const bZe=Object.freeze({__proto__:null,build:_Ze});class uI extends Si{initializeProgram(e){const i=uI.shader.get(),r=this.configuration,s=i.build({output:r.output,OITEnabled:r.transparencyPassType===0,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new fi(e.rctx,s,Ht)}bindPass(e,i){Pc(this.program,i.camera.projectionMatrix),this.program.setUniform4fv("eColor",e.color),this.configuration.output===4&&Fd(this.program,i),(this.configuration.output===1||i.multipassTerrainEnabled)&&this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),wm(this.program,i))}bindDraw(e){Yf(this.program,e),this.program.rebindTextures(),_m(this.program,this.configuration,e)}createPipeline(e,i){const r=this.configuration,s=e===3,n=e===2;return _t({blending:r.output!==0&&r.output!==7||!r.transparent?null:s?qu:xm(e),culling:PE(r.cullFace),depthTest:{func:U0(e)},depthWrite:s||n?r.writeDepth&&$o:null,colorWrite:Pt,stencilWrite:r.sceneHasOcludees?$m:null,stencilTest:r.sceneHasOcludees?i?kb:Q0:null,polygonOffset:s||n?r.polygonOffset&&wZe:ZO(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.createPipeline(this.configuration.transparencyPassType,!0),this.createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,i){return i?this._occludeePipelineState:super.getPipelineState(e,i)}}uI.shader=new vi(bZe,()=>import("./ColorMaterial.glsl.07f0fbcf.js"));const wZe={factor:1,units:1};class _a extends tr{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([X({count:8})],_a.prototype,"output",void 0),u([X({count:3})],_a.prototype,"cullFace",void 0),u([X()],_a.prototype,"slicePlaneEnabled",void 0),u([X()],_a.prototype,"vertexColors",void 0),u([X()],_a.prototype,"transparent",void 0),u([X()],_a.prototype,"polygonOffset",void 0),u([X()],_a.prototype,"enableOffset",void 0),u([X()],_a.prototype,"writeDepth",void 0),u([X()],_a.prototype,"sceneHasOcludees",void 0),u([X({count:4})],_a.prototype,"transparencyPassType",void 0),u([X()],_a.prototype,"multipassTerrainEnabled",void 0),u([X()],_a.prototype,"cullAboveGround",void 0);class Sde extends Id{constructor(e){super(e,SZe),this.supportsEdges=!0,this.techniqueConfig=new _a}getTechniqueConfig(e,i){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<HO,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(e,i,r,s,n,o,a){NO(e,i,s,n,o,void 0,a)}requiresSlot(e,i){return e===20?!0:N0(i)===4?e===2:e===(this.parameters.transparent?this.parameters.writeDepth?4:7:2)}createGLMaterial(e){return e.output===0||e.output===7||e.output===4||e.output===1&&this.parameters.writeLinearDepth?new xZe(e):null}createBufferWriter(){return new _R(gue)}}class xZe extends vm{updateParameters(e){return this.ensureTechnique(uI,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==0&&this._output!==7||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,i){i.bindPass(this._material.getPassParameters(),e)}}const SZe=E({color:[1,1,1,1],transparent:!1,writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1},Gu),DU=.70710678118,Tde=DU,TZe=.08715574274;function CZe(t){const e=new pi;t.draped||e.extensions.add("GL_OES_standard_derivatives");const i=t.output===1;e.include(Ss,{linearDepth:i}),e.include(iv,t),e.vertex.uniforms.add("proj","mat4"),e.vertex.uniforms.add("view","mat4"),i&&(e.include(J0,t),e.vertex.uniforms.add("cameraNearFar","vec2"),e.varyings.add("linearDepth","float")),t.draped?e.vertex.uniforms.add("worldToScreenRatio","float"):(e.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),e.vertex.uniforms.add("camPos","vec3"),e.attributes.add("boundingRect","mat3")),e.attributes.add("position","vec3"),e.attributes.add("uvMapSpace","vec4"),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),t.multipassTerrainEnabled&&e.varyings.add("depth","float");const r=t.style===3||t.style===4||t.style===5;return r&&e.vertex.code.add(x`
      const mat2 rotate45 = mat2(${x.float(DU)}, ${x.float(-Tde)},
                                 ${x.float(Tde)}, ${x.float(DU)});
    `),t.draped||(e.vertex.code.add(x`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),e.vertex.code.add(x`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),e.vertex.code.add(x`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${x.float(TZe)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, camPos, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - camPos);
      }
    `)),e.vertex.code.add(x`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${r?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${r?" * rotate45":""};

      ${t.draped?"":x`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${x.float(t.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `),e.vertex.code.add(x`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${t.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${i?x`transformPositionWithDepth(proj, view, vpos, cameraNearFar, linearDepth);`:x`transformPosition(proj, view, vpos);`}
    }
  `),e.include(Zi,t),e.fragment.include(yd),e.fragment.uniforms.add("matColor","vec4"),t.draped&&e.fragment.uniforms.add("texelSize","float"),t.output===4&&e.include(Dd),t.multipassTerrainEnabled&&(e.fragment.include(Lr),e.include(ll,t)),t.output!==4&&(e.fragment.code.add(x`
      const float lineWidth = ${x.float(t.lineWidth)};
      const float spacing = ${x.float(t.patternSpacing)};
      const float spacingINV = ${x.float(1/t.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),t.draped||e.fragment.code.add(x`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),e.fragment.code.add(x`
    void main() {
      discardBySlice(vpos);
      ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${t.attributeColor?"vColor * matColor;":"matColor;"}
      color = highlightSlice(color, vpos);

      ${t.output!==4?x`color.a *= ${MZe(t)};`:""}

      if (color.a < ${x.float(tn)}) {
        discard;
      }

      ${t.output===7?x`gl_FragColor = vec4(color.a);`:""}

      ${t.output===0?x`gl_FragColor = color; ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${t.output===4?x`outputHighlight();`:""}
      ${t.output===1?x`outputDepth(linearDepth);`:""};
    }
  `),e}function MZe(t){function e(i){return t.draped?x`coverage(vuv.${i}, texelSize)`:x`sample(vuv.${i})`}switch(t.style){case 3:case 0:return e("y");case 4:case 1:return e("x");case 5:case 2:return x`
        1.0 - (1.0 - ${e("x")}) * (1.0 - ${e("y")})
      `;default:return"0.0"}}const PZe=Object.freeze({__proto__:null,build:CZe});class hI extends Si{initializeProgram(e){const i=hI.shader.get(),r=this.configuration,s=i.build({output:r.output,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,style:r.style,patternSpacing:r.patternSpacing,lineWidth:r.lineWidth,draped:r.draped,OITEnabled:r.transparencyPassType===0,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new fi(e.rctx,s,Cde)}bindPass(e,i){Pc(this.program,i.camera.projectionMatrix),this.program.setUniform4fv("matColor",e.color),this.configuration.draped?(this.program.setUniform1f("worldToScreenRatio",1/i.screenToPCSRatio),this.program.setUniform1f("texelSize",1/i.camera.pixelRatio)):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/i.camera.perScreenPixelRatio),this.configuration.output===4&&Fd(this.program,i),(this.configuration.output===1||i.multipassTerrainEnabled)&&this.program.setUniform2fv("cameraNearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),wm(this.program,i))}bindDraw(e){Yf(this.program,e),Qf(this.program,e.origin,e.camera.viewInverseTransposeMatrix),_m(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e,i){const r=this.configuration,s=e===3,n=e===2;return _t({blending:r.output===0||r.output===7?s?qu:xm(e):null,culling:PE(r.cullFace),depthTest:{func:U0(e)},depthWrite:s?r.writeDepth&&$o:XN(e),colorWrite:Pt,stencilWrite:r.sceneHasOcludees?$m:null,stencilTest:r.sceneHasOcludees?i?kb:Q0:null,polygonOffset:s||n?r.polygonOffset&&AZe:ZO(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,i){return i?this._occludeePipelineState:super.getPipelineState(e,i)}}hI.shader=new vi(PZe,()=>import("./Pattern.glsl.6405bc95.js"));const AZe={factor:1,units:1};class Tn extends tr{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.enableOffset=!0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([X({count:8})],Tn.prototype,"output",void 0),u([X({count:3})],Tn.prototype,"cullFace",void 0),u([X()],Tn.prototype,"slicePlaneEnabled",void 0),u([X()],Tn.prototype,"vertexColors",void 0),u([X()],Tn.prototype,"polygonOffset",void 0),u([X()],Tn.prototype,"writeDepth",void 0),u([X()],Tn.prototype,"sceneHasOcludees",void 0),u([X({count:6})],Tn.prototype,"style",void 0),u([X()],Tn.prototype,"patternSpacing",void 0),u([X()],Tn.prototype,"lineWidth",void 0),u([X()],Tn.prototype,"enableOffset",void 0),u([X()],Tn.prototype,"draped",void 0),u([X({count:4})],Tn.prototype,"transparencyPassType",void 0),u([X()],Tn.prototype,"multipassTerrainEnabled",void 0),u([X()],Tn.prototype,"cullAboveGround",void 0);const Cde=new Map([["position",0],["color",3],["uvMapSpace",4],["boundingRect",5]]);class FU extends Id{constructor(e){super(e,OZe),this.supportsEdges=!0,this._vertexAttributeLocations=Cde,this.techniqueConfig=new Tn}getTechniqueConfig(e,i){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.style=this.parameters.style,this.techniqueConfig.patternSpacing=this.parameters.patternSpacing,this.techniqueConfig.lineWidth=this.parameters.lineWidth,this.techniqueConfig.draped=this.parameters.draped,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<HO,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(e,i,r,s,n,o,a){NO(e,i,s,n,o,void 0,a)}requiresSlot(e,i){return e===20?!0:N0(i)===4?e===2:e===(this.parameters.writeDepth?4:7)}createGLMaterial(e){return e.output===0||e.output===7||e.output===4||e.output===1&&this.parameters.writeLinearDepth?new $Ze(e):null}createBufferWriter(){const e=zr().vec3f("position").vec4u8("color").vec4f("uvMapSpace");return this.parameters.draped||e.mat3f("boundingRect"),new EZe(e)}}class $Ze extends vm{updateParameters(e){return this.ensureTechnique(hI,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==0&&this._output!==7||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,i){i.bindPass(this._material.getPassParameters(),e)}}class EZe extends _R{write(e,i,r,s){for(const n of this.vertexBufferLayout.fieldNames){const o=i.vertexAttributes.get(n),a=i.indices.get(n);if(o&&a)switch(n){case"position":{Ze(o.size===3);const l=r.getField(n,Wt);l&&UO(a,o.data,e.transformation,l,s);break}case"color":{Ze(o.size===3||o.size===4);const l=r.getField(n,Hn);l&&jO(a,o.data,o.size,l,s);break}case"uvMapSpace":{Ze(o.size===4);const l=r.getField(n,Zr);l&&Pb(a,o.data,l,s);break}case"boundingRect":{Ze(o.size===9);const l=r.getField(n,Mc);l&&this.writeBoundingRect(a,o.data,e.transformation,l,s);break}}}}writeBoundingRect(e,i,r,s,n){const o=r,a=s.typedBuffer,l=s.typedBufferStride,c=e.length;n*=l;for(let h=0;h<c;++h){const p=9*e[h],f=i[p],g=i[p+1],y=i[p+2];a[n]=o[0]*f+o[4]*g+o[8]*y+o[12],a[n+1]=o[1]*f+o[5]*g+o[9]*y+o[13],a[n+2]=o[2]*f+o[6]*g+o[10]*y+o[14];for(let v=3;v<9;++v)a[n+v]=i[p+v];n+=l}}}const OZe=E({color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,style:2,patternSpacing:10,lineWidth:1,draped:!0},Gu);function RZe(t,e,i){return DZe(IZe(t),e,i)}function IZe(t){return t&&t.pattern||null}function DZe(t,e,i){return _(t)?t.style==="none"||t.style==="solid"?(t.style==="none"&&(e.color=Bt(0,0,0,0),e.transparent=!0),new Sde(e)):(e.style=FZe(t.style),e.draped=i.isDraped,new FU(e)):new Sde(e)}function FZe(t){switch(t){case"horizontal":return 0;case"vertical":return 1;case"cross":return 2;case"forward-diagonal":return 3;case"backward-diagonal":return 4;case"diagonal-cross":return 5;default:return}}function LZe(t){return t.material instanceof FU&&!t.material.parameters.draped}function kZe(t,e){if(LZe(t)){const i=t.geometry.vertexAttributes,r=i.get("position").data,s=i.get("uvMapSpace").data,n=i.get("boundingRect").data;wde(Zr.fromTypedArray(s),ir.fromTypedArray(r),e,Hf.fromTypedArray(n))}}function zZe(t,e,i,r){const s=u7(t,e,i,r),n=t.stageObject.geometryRecords;for(let o=0;o<n.length;o++)kZe(n[o],r);return s}const VZe=["polyline","polygon","extent"];class dI extends Zu{constructor(e,i,r,s){super(e,i,r,s),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}ensureMaterials(){this.ensureFillMaterial(),this.ensureOutlineMaterial()}ensureFillMaterial(){if(_(this._material))return;const e=or(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(e);this._material=RZe(this.symbolLayer,{color:i,transparent:i[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof FU,this._context.stage.add(this._material)}ensureOutlineMaterial(){const e=this.symbolLayer.outline;if(_(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;const i=r=>{const s=bhe(e.pattern);return new mR({width:r,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:s,stippleScaleWithLineWidth:!0,cap:_he(e.patternCap||"butt")})};this._outlineMaterial=i(zs(e.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(e){return _(e)&&e.size&&e.size>0&&_(e.color)&&(A(e.pattern)||e.pattern.type!=="style"||e.pattern.style!=="none")}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const i=e.graphic;if(!this._validateGeometry(i.geometry,VZe,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(i,new ma);return this.ensureDrapedStatus(s.mode==="on-the-ground"),this.ensureMaterials(),this.draped?this._createAsOverlay(i,r):this._createAs3DShape(i,r,s)}layerOpacityChanged(){if(_(this._material)){const e=this._material.parameters.color,i=or(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i);this._material.setParameters({color:[e[0],e[1],e[2],r],transparent:r<1||this.needsDrivenTransparentPass})}if(_(this._outlineMaterial)){const e=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(e,i,r){const s=this._elevationContext.mode,n=NT(dI.elevationModeChangeTypes,r,s);if(n!==$i.UPDATE)return n;const o=cl(s);return this.updateGraphics3DGraphicElevationInfo(e,i,()=>o)}slicePlaneEnabledChanged(){if(_(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),_(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,i,r){const s=t3(e.geometry);if(A(s))return null;Vr.renderData=G7(s,this._context.elevationProvider,this._context.renderCoordsHelper,r),Vr.color=i;const n=Vr.renderData.position.length/3;if(this._needsUV&&(Vr.uvMapSpace=new Float32Array(4*n),Vr.boundingRect=new Float64Array(9*n)),Vr.outNum=0,Vr.outGeometries=[],Vr.outTransforms=[],Vr.outMaterials=[],this._createAs3DShapeFill(Vr),this._hasOutline&&this._createAs3DShapeOutline(Vr),this._logGeometryCreationWarnings(Vr.renderData,s.rings,"rings","FillSymbol3DLayer"),Vr.outNum===0)return null;this._needsUV&&wde(Zr.fromTypedArray(Vr.uvMapSpace),ir.fromTypedArray(Vr.renderData.position),this._context.renderCoordsHelper,Hf.fromTypedArray(Vr.boundingRect));const o=new Nd({geometries:Vr.outGeometries,materials:Vr.outMaterials,transformations:Vr.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),a=new Wu(this,o,Vr.outGeometries,null,null,zZe,r);return a.alignedSampledElevation=Vr.renderData.sampledElevation,a.needsElevationUpdates=cl(r.mode),a}_createAs3DShapeFill(e){const i=e.renderData.polygons;for(const{position:r,mapPosition:s,holeIndices:n,index:o,count:a}of i){if(_(this._context.clippingExtent)&&(ii(Cn),Ql(Cn,s),!Xl(Cn,this._context.clippingExtent)))continue;const l=Lb(s,n,3);if(l.length===0)continue;const c=new Uint32Array(l),h=Rue({indices:c,attributeData:{position:r,color:e.color,mapPosition:s,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*o*e.uvMapSpace.BYTES_PER_ELEMENT,4*a):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*o*e.boundingRect.BYTES_PER_ELEMENT,9*a):null}});e.outGeometries.push(h),e.outMaterials.push(at(this._material)),e.outTransforms.push(Dr),e.outNum++}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const i=e.renderData.outlines;for(let r=0;r<i.length;++r){const{mapPosition:s,position:n}=i[r];if(_(this._context.clippingExtent)&&(ii(Cn),Ql(Cn,s),!Xl(Cn,this._context.clippingExtent)))continue;const o=sU({overlayInfo:null,removeDuplicateStartEnd:1,attributeData:{position:n,mapPosition:s}}),a=o.vertexAttributes.get("position");a.data===n&&(a.data=new Float64Array(n)),e.outGeometries.push(o),e.outMaterials.push(at(this._outlineMaterial)),e.outTransforms.push(Dr),e.outNum++}}_createAsOverlay(e,i){const r=t3(e.geometry);if(A(r))return null;at(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,_(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),Ps.renderData=Due(r,this._context.overlaySR),Ps.color=i;const s=Ps.renderData.position.length/3;return this._needsUV&&(Ps.uvMapSpace=new Float32Array(4*s)),Ps.outNum=0,Ps.outGeometries=[],Ps.outBoundingBox=ii(),Ps.layerUid=this._context.layer.uid,Ps.graphicsUid=e.uid,this._createAsOverlayFill(Ps),this._hasOutline&&this._createAsOverlayOutline(Ps),this._logGeometryCreationWarnings(Ps.renderData,r.rings,"rings","FillSymbol3DLayer"),Ps.outNum===0?null:(this._needsUV&&mZe(Zr.fromTypedArray(Ps.uvMapSpace),ir.fromTypedArray(Ps.renderData.position),this._context.overlaySR,this._context.layerView.view.state.viewingMode),Ps.outNum>0?new IR(this,Ps.outGeometries,Ps.outBoundingBox):null)}_createAsOverlayFill(e){const i=e.renderData.polygons;for(const{position:r,holeIndices:s,index:n,count:o}of i){if(ii(Cn),Ql(Cn,r),!Xl(Cn,this._context.clippingExtent))continue;const a=Lb(r,s,3);if(a.length===0)continue;g1(e.outBoundingBox,Cn);const l=new Uint32Array(a),c=Rue({indices:l,attributeData:{position:r,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*n*e.uvMapSpace.BYTES_PER_ELEMENT,4*o):null}}),h=new Gb(c,at(this._material),e.layerUid,e.graphicsUid),p=Cn;Ls(h.boundingSphere,.5*(p[0]+p[3]),.5*(p[1]+p[4]),0,.5*Math.sqrt((p[3]-p[0])*(p[3]-p[0])+(p[4]-p[1])*(p[4]-p[1]))),e.outGeometries.push(h),e.outNum++}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const i=e.renderData.outlines;for(let r=0;r<i.length;++r){const{position:s}=i[r];if(ii(Cn),Ql(Cn,s),!Xl(Cn,this._context.clippingExtent))continue;g1(e.outBoundingBox,Cn);const n=sU({overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:1,attributeData:{position:s}}),o=new Gb(n,at(this._outlineMaterial),e.layerUid,e.graphicsUid),a=Cn;Ls(o.boundingSphere,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0,.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1]))),e.outGeometries.push(o),e.outNum++}}_getOutlineOpacity(){const e=or(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(_(e)?e.a:0)}_getOutlineColor(){const e=or(this.symbolLayer,"outline","color"),i=this._getOutlineOpacity();return zT(_(e)?Ae.toUnitRGB(e):null,i)}get test(){return{createAsOverlay:(e,i)=>this._createAsOverlay(e,i),createAs3DShape:(e,i,r)=>this._createAs3DShape(e,i,r)}}}dI.elevationModeChangeTypes={definedChanged:$i.RECREATE,staysOnTheGround:$i.NONE,onTheGroundChanged:$i.RECREATE};const Cn=lr(),Vr={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Ps={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};class pI{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.fillStyle=this.colorToRGBA(e.color),this.haloStyle=this.colorToRGB(e.halo.color)}colorToRGB(e){return`rgb(${e.slice(0,3).map(i=>Math.floor(255*i)).toString()})`}colorToRGBA(e){return`rgba(${e.slice(0,3).map(i=>Math.floor(255*i)).toString()},${e[3]})`}static fromSymbol(e,i=1){const r=or(e,"material","color"),s=_(r)?Ae.toUnitRGBA(r):I1,n=e.halo,o=e.size!=null?zs(e.size):12,a={family:e.font&&e.font.family?e.font.family:"sans-serif",weight:e.font&&e.font.weight?e.font.weight:"normal",style:e.font&&e.font.style?e.font.style:"normal"},l=_(n)&&_(n.color)&&n.size>0?{size:zs(n.size),color:Ae.toUnitRGBA(n.color)}:{size:0,color:I1};return new pI({size:o,color:s,font:a,halo:l,pixelRatio:i})}}class Mde{constructor(e,i,r=2048){this.text=e,this._parameters=i,this.maxSize=r,this._lineWidths=new Array,this._renderPixelRatio=null,this._displayWidth=null,this.key=`${this._parameters.key}--${e}`,this._lines=e.split(/\r?\n/),this._lineHeight=this.computeLineHeight()}get displayWidth(){return this._ensureTextWidth()}get displayHeight(){return this._lineHeight*this._lines.length}get renderedWidth(){return Math.round(this.displayWidth*this.renderPixelRatio)}get renderedHeight(){return Math.round(this.displayHeight*this.renderPixelRatio)}get renderedLineHeight(){return Math.round(this._lineHeight*this.renderPixelRatio)}get renderedFontSize(){return this._parameters.definition.size*this.renderPixelRatio}get renderedHaloSize(){return this._parameters.haloSize*this.renderPixelRatio}get renderPixelRatio(){if(A(this._renderPixelRatio)){const e=this._parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this.maxSize/(this.displayWidth*e),this.maxSize/(this.displayHeight*e))):this._renderPixelRatio=e}return this._renderPixelRatio}getLineXOffset(e){return Math.round((this.renderedWidth-this._lineWidths[e]*this.renderPixelRatio)/2)}render(e,i=0,r=0){const s=this.renderedLineHeight,n=this.renderedHaloSize,o=NZe(e.textAlign,this.renderedWidth)+n,a=n+Pde;e.save(),n>0&&this.renderHalo(e,o,a,i,r),this.setFontProperties(e,this.renderedFontSize),r+=a,i+=o;for(let l=0;l<this._lines.length;++l){e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)";const c=this._lines[l],h=this.getLineXOffset(l);e.fillText(c,i+h,r),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.fillStyle,e.fillText(c,i+this.getLineXOffset(l),r),r+=s}e.restore()}renderHalo(e,i,r,s,n){const o=this.renderedWidth,a=this.renderedHeight,l=LU($de,Math.max(o,fI),Math.max(a,fI)),c=l.getContext("2d");c.clearRect(0,0,o,a),this.setFontProperties(c,this.renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;const h=this.renderedHaloSize<3;c.lineJoin=h?"miter":"round",h?this.renderHaloEmulated(c,i,r):this.renderHaloNative(c,i,r),e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(l,0,0,o,a,s,n,o,a),e.globalAlpha=1}renderHaloEmulated(e,i,r){const s=this.renderedLineHeight,n=this.renderedHaloSize;for(let o=0;o<this._lines.length;++o){const a=this._lines[o],l=this.getLineXOffset(o);for(const[c,h]of Ade)e.fillText(a,i+l+n*c,r+n*h);r+=s}}renderHaloNative(e,i,r){const s=this.renderedLineHeight,n=this.renderedHaloSize;for(let o=0;o<this._lines.length;++o){const a=2*n,l=this._lines[o],c=this.getLineXOffset(o),h=5,p=.1;for(let f=0;f<h;f++){const g=1-(h-1)*p+f*p;e.lineWidth=g*a,e.strokeText(l,i+c,r)}r+=s}}setFontProperties(e,i){const r=this._parameters.definition.font,s=`${r.style} ${r.weight} ${i}px ${r.family}, sans-serif`;e.font=s,e.textAlign="left",e.textBaseline="top"}_ensureTextWidth(){if(_(this._displayWidth))return this._displayWidth;const e=LU($de,fI,fI).getContext("2d");this.setFontProperties(e,this._parameters.definition.size);let i=0,r=2*this._parameters.haloSize;this._lineWidths.length=0;const s=this._parameters.definition.font;(s.style==="italic"||s.style==="oblique"||typeof s.weight=="string"&&(s.weight==="bold"||s.weight==="bolder")||typeof s.weight=="number"&&s.weight>600)&&(r+=.3*e.measureText("A").width);for(const n of this._lines){const o=Math.round(e.measureText(n).width+r);this._lineWidths.push(o),i=Math.max(i,o)}return this._displayWidth=i,this._displayWidth}computeLineHeight(){const e=1.275*this._parameters.definition.size;return Math.ceil(e+2*this._parameters.haloSize)+Pde}}function NZe(t,e){return t==="center"?.5*e:t==="right"?e:0}const Pde=1,Ade=[];{const t=16;for(let e=0;e<360;e+=360/t)Ade.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}function LU(t,e,i){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=i,t.canvas}const $de={canvas:null},fI=512;class UZe extends ab{constructor(e,i,r){super(),this.type=4,this._glTexture=null,this.events=new Ci,this._requiresPowerOfTwo=!Eo(e.gl),this._renderer=new Mde(i,r)}get width(){return this._renderer.renderedWidth}get height(){return this._renderer.renderedHeight}get textureWidth(){const e=this.width;return this._requiresPowerOfTwo?Op(e):e}get textureHeight(){const e=this.height;return this._requiresPowerOfTwo?Op(e):e}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}get texcoordScale(){return[this._renderer.renderedWidth/this.textureWidth,this._renderer.renderedHeight/this.textureHeight]}get requiresFrameUpdates(){return!1}createDescriptor(e){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(e){if(_(this._glTexture))return this._glTexture;const i=LU(jZe,this.textureWidth,this.textureHeight),r=i.getContext("2d");return r.save(),this._renderer.render(r,0,this.textureHeight-this._renderer.renderedHeight),this._glTexture=new qe(e,this.createDescriptor(e),i),r.restore(),this._glTexture}unload(){_(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),this.events.emit("unloaded")}}const jZe={canvas:null},BZe=[0,0,1];class GZe extends Zu{constructor(e,i,r,s){super(e,i,r,s),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=QO(this.symbolLayer.size);if(e)throw new Q("graphics3dtextsymbollayer:invalid-size",e)}this._createTextRenderParameters()}_createTextRenderParameters(){const e=this._context.layerView.view.pixelRatio;this._textRenderParameters=pI.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const i=e.graphic,r=GT(i.geometry);if(A(r))return this.logger.warn(`unsupported geometry type for text symbol: ${i.geometry.type}`),null;const s=this.symbolLayer.text;if(!s)return null;const n=AL(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(i,r,s,n)}createLabel(e,i,r,s){const n=e.graphic,o=GT(n.geometry);if(A(o))return this.logger.warn(`unsupported geometry type for label: ${n.geometry.type}`),null;const a=i.text;return!a||/^\s+$/.test(a)?null:this._createAs3DShape(n,o,a,i,i,r,s)}setGraphicElevationContext(e,i,r=0){const s=super.setGraphicElevationContext(e,i);return s.addOffsetRenderUnits(r),s}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,i){return Ede(e,i,(r,s)=>{this.updateGraphicElevationContext(s,r)}),$i.UPDATE}slicePlaneEnabledChanged(e,i){return Ede(e,i,r=>{for(const s of r.stageObject.geometryRecords)s.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}updateGraphicElevationContext(e,i){this.setGraphicElevationContext(e,i.elevationContext,i.metadata.elevationOffset),i.needsElevationUpdates=cl(i.elevationContext.mode)||i.elevationContext.mode==="absolute-height"}_defaultElevationInfoNoZ(){return qZe}_createAs3DShape(e,i,r,s,n=HZe,o,a){const l=this.setGraphicElevationContext(e,new ma,n.elevationOffset),c=or(e.geometry,"type")==="polyline",h=e.uid,p=this._context.stage.renderView.renderingContext,f=n.anchor in VT?n.anchor:"center",g=VT[f],y=A(a)?new UZe(p,r,this._textRenderParameters):null,v={occlusionTest:!0,screenOffset:n.screenOffset,anchorPos:g,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:n.centerOffsetUnits,debugDrawBorder:n.debugDrawBorder,drawInSecondSlot:!0};if(_(y)&&(v.textureId=y.id,v.texCoordScale=y.texcoordScale),_(a)&&(v.textureId=a.id),_(s)&&_(s.verticalOffset)){const{screenLength:V,minWorldLength:q,maxWorldLength:J}=s.verticalOffset;v.verticalOffset={screenLength:zs(V),minWorldLength:q||0,maxWorldLength:J!=null?J:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:V,screenSizePerspectiveSettingsLabels:q}=this._context.sharedResources;v.screenSizePerspective=q.overridePadding(this._textRenderParameters.haloSize),v.screenSizePerspectiveAlignment=V}let b;if(c&&(v.shaderPolygonOffset=1e-4),v.slicePlaneEnabled=this._context.slicePlaneEnabled,_(o)){const V=JSON.stringify(v);b=o.get(V),A(b)&&(b=new Eb(v),o.add(V,b))}else b=new Eb(v);const w=[b],S=n.translation,T=_(y)?[y.displayWidth,y.displayHeight]:[0,0],C=n.centerOffset,M=BZe,P=[0,0],F=[Oo.createPointGeometry(M,S,null,T,C,P,null)],z=this._context.layer.uid,D=v7(this._context,i,F,w,l,z,h);if(D===null)return null;const U=new Wu(this,D.object,F,A(o)?w:null,_(y)?[y]:null,jT,l);U.alignedSampledElevation=D.sampledElevation,U.needsElevationUpdates=cl(l.mode)||l.mode==="absolute-height";const{displayWidth:G,displayHeight:k}=_(y)?y:n;U.getScreenSize=(V=ke())=>(V[0]=G,V[1]=k,V);const j={labelText:r,elevationOffset:n.elevationOffset};return U.metadata=j,BT(U,i,this._context.elevationProvider),U}}function Ede(t,e,i){t&&t.forEach(r=>{const s=e(r);_(s)&&i(s,r.graphic)})}const qZe={mode:"relative-to-ground",offset:0},HZe={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0},WZe=["polyline","polygon","extent"];class ah extends Zu{constructor(e,i,r,s){super(e,i,r,s)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const i=e.graphic;if(!this._validateGeometry(i.geometry,WZe,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new ma);return this.ensureDrapedStatus(r.mode==="on-the-ground"),this.ensureMaterial(),this.draped?this._createAsOverlay(i):this._createAs3DShape(i,r,i.uid)}ensureMaterial(){if(_(this._material))return;const e=E({},yue),i=this.symbolLayer.color;_(i)&&(e.color=Ae.toUnitRGBA(i));const r=this._getCombinedOpacity(i,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],r],e.transparent=r<1||this.needsDrivenTransparentPass,e.waveDirection=_(this.symbolLayer.waveDirection)?ah.headingVectorFromAngle(this.symbolLayer.waveDirection):Qt(0,0);const s=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=Bje[s];e.waveStrength=n.waveStrength,e.waveTextureRepeat=n.textureRepeat,e.waveVelocity=n.waveVelocity,e.flowStrength=n.perturbationStrength,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new vue(e),this._context.stage.add(this._material)}layerOpacityChanged(){if(A(this._material))return!0;const e=this._material.parameters.color,i=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=i<1||this.needsDrivenTransparentPass;return this._material.setParameters({color:[e[0],e[1],e[2],i],transparent:r}),!0}layerElevationInfoChanged(e,i,r){const s=this._elevationContext.mode,n=NT(ah.elevationModeChangeTypes,r,s);if(n!==$i.UPDATE)return n;const o=cl(s);return this.updateGraphics3DGraphicElevationInfo(e,i,()=>o)}slicePlaneEnabledChanged(){return _(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,i,r){const s=t3(e.geometry);if(A(s))return null;sn.renderData=G7(s,this._context.elevationProvider,this._context.renderCoordsHelper,i);const n=sn.renderData.position.length/3;if(sn.uvCoords=new Float64Array(2*n),sn.outNum=0,sn.outGeometries=[],sn.outTransforms=[],sn.outMaterials=[],this._create3DShapeGeometries(sn),this._logGeometryCreationWarnings(sn.renderData,s.rings,"rings","WaterSymbol3DLayer"),sn.outNum===0)return null;this._createUVCoordsFromVertices(sn.uvCoords,sn.renderData.mapPosition,n,this._context.elevationProvider.spatialReference);const o=new Nd({geometries:sn.outGeometries,materials:sn.outMaterials,transformations:sn.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),a=new Wu(this,o,sn.outGeometries,null,null,u7,i);return a.alignedSampledElevation=sn.renderData.sampledElevation,a.needsElevationUpdates=cl(i.mode),a}_createUVCoordsFromVertices(e,i,r,s){const n=bo(s);ja(Fm);for(let l=0;l<r;l++)si(Ode,i[3*l+0],i[3*l+1]),BW(Fm,Ode);gx(Fm,Fm,n);const o=Fm[0]%ah.unitSizeOfTexture,a=Fm[1]%ah.unitSizeOfTexture;mI[0]=Fm[0]-o,mI[1]=Fm[1]-a;for(let l=0;l<r;l++)e[2*l+0]=(i[3*l+0]*n-mI[0])/ah.unitSizeOfTexture,e[2*l+1]=(i[3*l+1]*n-mI[1])/ah.unitSizeOfTexture}_create3DShapeGeometries(e){const i=e.renderData.polygons,r=e.uvCoords;for(const{count:s,index:n,position:o,mapPosition:a,holeIndices:l}of i){if(_(this._context.clippingExtent)&&(ii(Lm),Ql(Lm,a),!Xl(Lm,this._context.clippingExtent)))continue;const c=Lb(a,l,3);if(c.length===0)continue;const h=new Uint32Array(c),p=new Float64Array(r.buffer,2*n*r.BYTES_PER_ELEMENT,2*s),f=Iue({indices:h,attributeData:{position:o,uv0:p,mapPosition:a}});e.outGeometries.push(f),e.outMaterials.push(at(this._material)),e.outTransforms.push(Dr),e.outNum++}}_createAsOverlay(e){const i=t3(e.geometry);if(A(i))return null;at(this._material).renderPriority=this._renderPriority,Mn.renderData=Due(i,this._context.overlaySR);const r=Mn.renderData.position.length/3;return Mn.uvCoords=new Float64Array(2*r),Mn.outNum=0,Mn.outGeometries=[],Mn.outBoundingBox=ii(),Mn.layerUid=this._context.layer.uid,Mn.graphicsUid=e.uid,this._createAsOverlayWater(Mn),this._logGeometryCreationWarnings(Mn.renderData,i.rings,"rings","WaterSymbol3DLayer"),Mn.outNum===0?null:(this._createUVCoordsFromVertices(Mn.uvCoords,Mn.renderData.position,r,this._context.overlaySR),Mn.outNum>0?new IR(this,Mn.outGeometries,Mn.outBoundingBox):null)}_createAsOverlayWater(e){const i=e.uvCoords,r=e.renderData.polygons;for(const{position:s,holeIndices:n,index:o,count:a}of r){if(ii(Lm),Ql(Lm,s),!Xl(Lm,this._context.clippingExtent))continue;g1(e.outBoundingBox,Lm);const l=Lb(s,n,3);if(l.length===0)continue;const c=new Uint32Array(l),h=new Float64Array(i.buffer,2*o*i.BYTES_PER_ELEMENT,2*a),p=Iue({indices:c,attributeData:{position:s,uv0:h}}),f=new Gb(p,at(this._material),e.layerUid,e.graphicsUid),g=Lm;Ls(f.boundingSphere,.5*(g[0]+g[3]),.5*(g[1]+g[4]),0,.5*Math.sqrt((g[3]-g[0])*(g[3]-g[0])+(g[4]-g[1])*(g[4]-g[1]))),e.outGeometries.push(f),e.outNum++}}static headingVectorFromAngle(e){const i=ke(),r=PM(e);return i[0]=Math.sin(r),i[1]=Math.cos(r),i}get test(){return{create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}ah.unitSizeOfTexture=100,ah.elevationModeChangeTypes={definedChanged:$i.RECREATE,staysOnTheGround:$i.NONE,onTheGroundChanged:$i.RECREATE};const mI=ke(),Fm=pt(),Ode=ke(),Lm=lr(),sn={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Mn={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},ZZe=le.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory");function JZe(t,e,i,r){const s=Rde[t.type]&&Rde[t.type][e.type]||QZe[e.type];return s?new s(t,e,i,r):(ZZe.error("GraphicsLayerFactory#make",`unknown symbol type ${e.type}`),null)}const QZe={icon:p3,object:gWe,line:zR,path:cZe,fill:dI,extrude:UBe,text:GZe,water:ah},Rde={"mesh-3d":{fill:Yqe}};class YZe extends p7{constructor(e,i,r){super(i.schedule),this._symbol=e,this._context=i,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}set symbol(e){this._symbol=e;for(let i=0;i<e.symbolLayers.length;i++){const r=this.symbolLayers[i];A(r)||(r.symbol=e,r.symbolLayer=e.symbolLayers.items[i])}}get symbol(){return this._symbol}async doLoad(e){let i=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(i=this._backgroundLayers.concat(i));const r=i.length;for(;this.symbolLayers.length<i.length;)this.symbolLayers.push(null);this.symbolLayers.length=i.length;const s=[];for(let n=0;n<r;n++){const o=i.getItemAt(n);if(o.enabled===!1)continue;gI.renderPriority=1-(1+n)/r,gI.renderPriorityStep=1/r,gI.ignoreDrivers=o._ignoreDrivers;const a=JZe(this.symbol,o,this._context,gI);s.push(WC(e,()=>{this.symbolLayers[n]=null,a.destroy()})),this.symbolLayers[n]=a}await cM(this.symbolLayers,async(n,o)=>{if(_(n))try{await n.load(),this._extentPadding+=Math.max(this._extentPadding,n.extentPadding)}catch{this.symbolLayers[o]=null}});for(const n of s)n==null||n.remove();if(s.length=0,Dt(e),this.symbolLayers.length&&!this.symbolLayers.some(n=>!!n))throw new Error}getSymbolLayerSize(e){const i=this.symbolLayers[e];return _(i)?i.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(e,i){const r=e.graphic,s=new Array(this.symbolLayers.length);for(let o=0;o<this.symbolLayers.length;o++){const a=this.symbolLayers[o];s[o]=_(a)?a.createGraphics3DGraphic(e):null}const n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new DUe(r,i||this,s,e.layer,n)}get complexity(){return y7(this.symbolLayers.map(e=>or(e,"complexity")))}globalPropertyChanged(e,i){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const n=this.symbolLayers[s],o=a=>{const l=a.graphics[s];return l instanceof Wu?l:null};if(_(n)&&!n.globalPropertyChanged(e,i,o))return!1}return!0}applyRendererDiff(e,i){return this.loadStatus!==1?0:this.symbolLayers.reduce((r,s)=>r!==0&&_(s)?Math.min(r,s.applyRendererDiff(e,i)):r,2)}prepareSymbolPatch(e){if(this.loadStatus===2||e.diff.type!=="partial")return;const i=e.diff.diff;if(!i.symbolLayers||i.symbolLayers.type!=="partial")return;const r=i.symbolLayers.diff;this.symbolLayers.forEach((s,n)=>{if(A(s))return;const o=r[n];if(o){const a={diff:o,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};s.prepareSymbolLayerPatch(a),e.symbolStatePatches.push(...a.symbolLayerStatePatches),a.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((l,c)=>{const h=l.graphics[n];_(h)&&a.graphics3DGraphicPatches.forEach(p=>p(h,c))})}})}updateGeometry(e,i){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(A(s))continue;const n=e.graphics[r];if(A(n)||!s.updateGeometry(n,i))return!1}return!0}onRemoveGraphic(e){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(A(r))continue;const s=e.graphics[i];_(s)&&r.onRemoveGraphic(s)}}getFastUpdateStatus(){let e=0,i=0,r=0;return this.symbolLayers.forEach(s=>{A(s)||(s.loadStatus===0?e++:s.isFastUpdatesEnabled()?r++:i++)}),{loading:e,slow:i,fast:r}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const e of this.symbolLayers)_(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const gI={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};class XZe extends p7{constructor(e,i,r){super(i),this.symbol=e,this.convert=r,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return _(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const i=await this.symbol.fetchSymbol({signal:e});i.id=this.symbol.id,this.graphics3DSymbol=this.convert(i),await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return _(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:g7}globalPropertyChanged(e,i){return!!_(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(e,i)}applyRendererDiff(e,i){return _(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(e,i):0}prepareSymbolPatch(e){_(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,i){return!!_(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(e,i)}onRemoveGraphic(){}getFastUpdateStatus(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){_(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}}function kU(t){return t instanceof XZe?t.graphics3DSymbol:t instanceof YZe?t:null}const w3=le.getLogger("esri.views.3d.layers.graphics.labelPlacement");function KZe(t){const e=lJe(t);if(A(e))return null;const i=eJe(t,e);if(A(i))return null;const r=i.anchor,s=!!e.hasLabelVerticalOffset;return iJe({anchor:r,verticalOffset:e.verticalOffset,screenOffset:ke(),centerOffset:Bt(0,0,0,-1),centerOffsetUnits:"world",translation:$(),elevationOffset:0,hasLabelVerticalOffset:s},i,t)}function eJe(t,e){if(e.anchor)return e;const i=t.labelClass.labelPlacement,r=Lc[i],s=r||yI(t);return i&&!r&&w3.warnOncePerTick(`the requested label placement '${i}' is not currently supported in SceneView`),tJe(s,t)}function zU(t){const e=t.graphics3DGraphic.graphics3DSymbol,i=kU(e);return _(i)?i.symbol.symbolLayers.getItemAt(0):null}function tJe(t,e){const i=e.graphics3DGraphic.graphic.geometry;if(A(i))return null;if(_(e.disablePlacement))return e.labelClass.labelPlacement?(w3.warnOncePerTick(Ide(t.placement,e.disablePlacement.logEntityDescription)),yI(e)):t;const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(e.labelClass.labelPlacement)return w3.warnOncePerTick(Ide(t.placement,`'${r}' geometries`)),yI(e);break;case"point":case"mesh":return t}return t}function Ide(t,e){return`the requested label placement '${t}' is currently unsupported for ${e} in SceneView`}function yI(t){const e=t.graphics3DGraphic.graphic.geometry;if(A(e))return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const i=zU(t);return _(i)&&i.type==="extrude"?Lc["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return Lc["above-center"];default:return}}function iJe(t,e,i){const r=i.graphics3DGraphic.graphic.geometry;if(A(r))return null;switch(r.type){case"point":sJe(t,e,i);break;case"polygon":rJe(t,e,i);break;case"mesh":VU(t,e,i.graphics3DGraphic.graphics[0])}return t}function rJe(t,e,i){const r=zU(i);if(!A(r))switch(r.type){case"extrude":{const s=i.graphics3DGraphic.graphics[0];_(s)?(s.getBoundingBoxObjectSpace(S3),Yl(S3,t.translation),t.translation[2]=Wg(S3)/2):ne(t.translation,0,0,0),VU(t,e,s);break}}}function sJe(t,e,i){const r=zU(i);if(A(r))return;const s=i.graphics3DGraphic.graphics[0];switch(_(s)?s.getCenterObjectSpace(t.translation):ne(t.translation,0,0,0),r.type){case"icon":case"text":nJe(t,e,i,s);break;case"object":VU(t,e,s)}}function nJe(t,e,i,r){const{graphics3DGraphic:s}=i,n=_(r)?r.getScreenSize():null;if(!s.isDraped&&_(n)){const o=oJe(i);x3[0]=n[0]/2*(e.normalizedOffset[0]-o[0]),x3[1]=n[1]/2*(e.normalizedOffset[1]-o[1]),t.screenOffset[0]=x3[0],t.hasLabelVerticalOffset?(t.centerOffset[1]=x3[1],t.centerOffsetUnits="screen"):t.screenOffset[1]=x3[1]}else t.hasLabelVerticalOffset||t.anchor==="center"||(Lc[i.labelClass.labelPlacement]&&w3.warnOncePerTick(`the requested placement '${e.placement}' is currently unsupported for draped graphics`),t.anchor="center")}function oJe(t,e=cJe){const{graphics3DGraphic:i}=t,r=i.graphics[0],s=_(r)?r.stageObject.geometryRecords[0].material:null;if(s&&s instanceof Eb){const n=s.parameters.anchorPos;e[0]=2*(n[0]-.5),e[1]=2*(n[1]-.5)}else e[0]=0,e[1]=0;return e}function VU(t,e,i){const r=_(i)?i.getBoundingBoxObjectSpace(S3):S3,s=De(r[3]-r[0],r[4]-r[1],r[5]-r[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);t.centerOffset[0]=n/2*e.normalizedOffset[0];const o=t.translation[2],a=s[2]/2*e.normalizedOffset[1];t.translation[2]=0,t.elevationOffset=o+a;const l=Te(s);t.centerOffset[2]=l/2*e.normalizedOffset[2]}function aJe(t){return t==="above-center"}function lJe(t){const e=t.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=t,s=kU(r.graphics3DSymbol),n=_(s)?s.symbol:null,o=Lc[e]||yI(t);return n.type==="point-3d"&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:Dde(n.verticalOffset),anchor:null,normalizedOffset:null}:!i||!i.hasVisibleVerticalOffset()||n.type==="point-3d"&&n.supportsCallout()&&n.verticalOffset&&!r.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:aJe(o.placement)?{placement:"above-center",verticalOffset:Dde(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(w3.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}function Dde(t){const{screenLength:e,minWorldLength:i,maxWorldLength:r}=t;return{screenLength:e,minWorldLength:i,maxWorldLength:r}}const Lc={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Fde={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const t in Fde){const e=Fde[t],i=Lc[t];e.forEach(r=>{Lc[r]=i})}Object.freeze&&(Object.freeze(Lc),Object.keys(Lc).forEach(function(t){Object.freeze(Lc[t]),Object.freeze(Lc[t].normalizedOffset)}));const x3=[0,0],cJe=[0,0],S3=lr();class Lde{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,i){this._materials.set(e,i),this._stage.add(i)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}var NU;const UU=512,jU=4096,uJe=.85,hJe=.95;let tw=NU=class extends ve{constructor(t){super(t),this.type=4,this.id=On(),this.events=new Ci,this._glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1}initialize(){this.stage=this.view._stage,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(this);const t=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(t),this.update2DCanvasSize(),this.resetAtlasCursor()}unload(){this._glTexture=Ge(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return!1}createDescriptor(t){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:t.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(t){return _(this._glTexture)||(this._glTexture=new qe(t,this.createDescriptor(t),this.canvas),this.frameWorker=this.view.resourceController.scheduler.registerTask(Qe.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker=ln(this.frameWorker),this._glTexture&&(this.stage.remove(this),this._glTexture=Ge(this._glTexture)),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null}create2DCanvas(){const t=document.createElement("canvas");return t.setAttribute("id","canvas2d"),t.setAttribute("style","display:none"),t.setAttribute("width",UU.toString()),t.setAttribute("height",UU.toString()),t}update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())}createAtlasRegion(t=UU){this.atlas={size:{width:t,height:t},cursor:{x:0,y:0},lineHeight:0}}computeAtlasResolution(t,e){let i=Math.max(t,e);return i+=256,i=Op(i),i=Math.min(i,jU),i}resizeAtlas(t,e){e=e||t;const i=this.atlas;i.size.width=t,i.size.height=e,_(this._glTexture)&&this._glTexture.resize(t,e),this.update2DCanvasSize()}resetAtlasCursor(){const t=this.atlas;t.cursor.x=T3,t.cursor.y=T3+kde,t.lineHeight=0,this.needsClear=!0}getAtlasUsage(){const t=this.atlas;return(t.cursor.x+t.cursor.y*t.size.width)/(t.size.width*t.size.height)}getExpectedAtlasUsage(){const t=this.elementsToRemove.size,e=this.elementsToAddOrUpdate.size,i=this.elements.size;return this.getAtlasUsage()/i*(i+e-t)}addAtlasElement(t,e,i,r){const s=this.atlas,{renderedWidth:n,renderedHeight:o,displayWidth:a,displayHeight:l}=t.textRenderer;t.placement.offset.x=s.cursor.x,t.placement.offset.y=s.cursor.y,t.placement.size.width=n,t.placement.size.height=o,t.placement.size.displayWidth=a,t.placement.size.displayHeight=l,t.placement.uvMinMax=[t.placement.offset.x/s.size.width,1-(t.placement.offset.y+o)/s.size.height,(t.placement.offset.x+n)/s.size.width,1-t.placement.offset.y/s.size.height],s.cursor.x+=i,s.lineHeight=Math.max(s.lineHeight,r),this.elements.set(e,t)}removeAtlasElement(t){if(t&&this.elements.has(t.textId)){const e=t.placement.offset,i=t.placement.size;this.ctx.clearRect(e.x,e.y,i.width,i.height),this.elements.delete(t.textId)}}ensureStageObjects(t){const e=this.stageObjects.get(t);if(e)return e;const i=new Set;return this.stageObjects.set(t,i),i}addStageObject(t,e){this.ensureStageObjects(t).add(e)}removeStageObject(t,e){const i=this.stageObjects.get(t);i&&i.delete(e)&&(e.geometries[0].vertexAttributes.get("size").data=[0,0],e.geometryVertexAttrsUpdated(e.geometryRecords[0]))}_processAddition(t,e){const i=this.atlas,r=t.textId,s=t.textRenderer.renderedWidth,n=t.textRenderer.renderedHeight,o=s+T3,a=n+T3+kde;if(i.cursor.x+o<i.size.width&&i.cursor.y+a<i.size.height)this.addAtlasElement(t,r,o,a),this.elementsToRender.set(r,t),this.elementsToAddOrUpdate.delete(r);else{if(!(i.cursor.y+a+i.lineHeight<i.size.height)){const l=this.getExpectedAtlasUsage(),c=l>uJe&&i.size.width<jU;return c&&this.resizeAtlas(2*i.size.width,2*i.size.height),!e||!c&&l>hJe&&i.size.width===jU?(this.processRemovals(),0):(this.repack(),1)}i.cursor.x=T3,i.cursor.y+=i.lineHeight,i.lineHeight=0,this.addAtlasElement(t,r,o,a),this.elementsToRender.set(r,t),this.elementsToAddOrUpdate.delete(r)}return 0}processRemovals(){this.elementsToRemove.forEach((t,e)=>{const i=this.stageObjects.get(e);i&&i.size!==0||this.removeAtlasElement(t),i&&i.size===0&&this.stageObjects.delete(e)}),this.elementsToRemove.clear()}repack(){this.processRemovals(),this.elements.forEach((t,e)=>{t.rendered=!1,this.elementsToAddOrUpdate.set(e,t)}),this.elements.clear(),this.resetAtlasCursor(),this.elementsToRender.clear()}processRenderingRequest(t){this.ctx.clearRect(t.placement.offset.x,t.placement.offset.y,t.placement.size.width,t.placement.size.height),t.textRenderer.render(this.ctx,t.placement.offset.x,t.placement.offset.y);const e=this.stageObjects.get(t.textId);e&&e.forEach(i=>{i.geometries[0].vertexAttributes.get("uv0").data=new Float32Array(t.placement.uvMinMax),i.geometries[0].vertexAttributes.get("size").data=[t.placement.size.displayWidth,t.placement.size.displayHeight],i.geometryVertexAttrsUpdated(i.geometryRecords[0])}),t.rendered=!0}get running(){return this.updating}runTask(t,e=!0){if(!this._glTexture)return;let i=!1;if(vr(this.elementsToAddOrUpdate,(s,n)=>{const o=this.elements.get(n);if(o&&o.rendered){const a=this.stageObjects.get(n);return a&&a.forEach(l=>{const c=l.geometries[0].vertexAttributes,h=this.elements.get(n);c.get("uv0").data=new Float32Array(h.placement.uvMinMax),c.get("size").data=new Float32Array([h.placement.size.displayWidth,h.placement.size.displayHeight]),l.geometryVertexAttrsUpdated(l.geometryRecords[0])}),this.elementsToAddOrUpdate.delete(n),!1}return this._processAddition(this.elementsToAddOrUpdate.get(n),e)===1&&(i=!0,!0)}),i)return void this.runTask(V_,!1);let r=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),vr(this.elementsToRender,(s,n)=>(this.processRenderingRequest(s),this.elementsToRender.delete(n),r=!0,t.madeProgress(),t.done)),r&&_(this._glTexture)&&this._glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&NU.test.orderedRepackingEnabled&&this.repackOrdered()}addTextTexture(t,e){const i=t.key;this.elementsToAddOrUpdate.has(i)||this.elementsToAddOrUpdate.set(i,{textId:i,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:t,rendered:!1}),this.addStageObject(i,e),this.elementsToRemove.delete(i),this.setDirty()}removeTextTexture(t,e){const i=t.key;this.elementsToRemove.set(i,this.elements.get(i)),this.removeStageObject(i,e)}setDirty(){this._glTexture&&(this.updating=!0)}repackOrdered(){if(this.elements.size===0)return;const t=[];this.elements.forEach((i,r)=>t.push({element:i,key:r}));let e=!0;for(let i=0;i<t.length-1;i++)if(t[i].key.localeCompare(t[i+1].key)>0){e=!1;break}if(!e||this.elementsToRemove.size){t.sort((i,r)=>i.key.localeCompare(r.key)),this.elements.clear();for(const{element:i,key:r}of t)this.elements.set(r,i);this.repack(),this.setDirty()}}get test(){const{elements:t,stageObjects:e,elementsToRemove:i,atlas:r}=this,s=this;return{elements:t,stageObjects:e,elementsToRemove:i,atlas:r,resizeAtlas:(n,o)=>s.resizeAtlas(n,o),run:(n,o)=>s.runTask(n,o)}}};tw.test={orderedRepackingEnabled:!1},u([d({constructOnly:!0})],tw.prototype,"view",void 0),u([d({type:Boolean})],tw.prototype,"updating",void 0),tw=NU=u([R("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],tw);const T3=2,kde=2,dJe=tw,zde=le.getLogger("esri.views.3d.layers.graphics.Labeler");let yv=class extends ve{constructor(){super(...arguments),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new dt,this._handles.add([this.view.watch("state.camera",()=>this.setDirty()),this.view.watch("pixelRatio",()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(Qe.LABELER,this)]),this._textTextureAtlas=new dJe({view:this.view}),this._hudMaterialCollection=new Lde(this.view._stage),this._calloutMaterialCollection=new Lde(this.view._stage)}dispose(){this._handles=tt(this._handles),this._textTextureAtlas=Ge(this._textTextureAtlas),this._hudMaterialCollection=Ge(this._hudMaterialCollection),this._calloutMaterialCollection=Ge(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(t){t.labels.forEach((e,i)=>{this._labels.set(i,e),e.graphics3DGraphic.setVisibilityFlag(0,!0,1)}),t.active=!0}_deactivateLabelingContext(t){t.labels.forEach((e,i)=>{e.graphics3DGraphic.setVisibilityFlag(0,!1,1),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this._labels.delete(i)}),t.active=!1}_addLabelTextureToAtlas(t){for(const e of t.graphics3DGraphic.labelGraphics){if(!e._labelClass)continue;const i=t.textRenderers[e._labelIndex];i&&this._textTextureAtlas.addTextTexture(i,e.stageObject)}t.rendered=!0}_removeLabelTextureFromAtlas(t){for(const e of t.graphics3DGraphic.labelGraphics){if(!e._labelClass)continue;const i=t.textRenderers[e._labelIndex];i&&this._textTextureAtlas.removeTextTexture(i,e.stageObject)}t.rendered=!1}get running(){var t;return!!this.view.ready&&(this._dirty||((t=this._textTextureAtlas)==null?void 0:t.updating)||this.deconflictor.running)}runTask(t){this._updateLabels(t),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(t)}_updateLabels(t){if(this._dirty){this._dirty=!1;for(const e of this._labelingContexts)if(pJe(e)){if(!Vde(e)){if(fJe(e)){this._deactivateLabelingContext(e);continue}if(this._createLabelClassContext(e),BU(e)){this._dirty=!0;continue}if(!Vde(e))continue}vr(e.labelsToInitialize,(i,r)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),t.madeProgress()),(i.visible&&i.hasTextTextureResources||!i.visible&&i.hasGraphics3DResources)&&(e.labelsToInitialize.delete(r),t.madeProgress()),t.done))&&(this._dirty=!0)}this._labelsToRemove.forEach(e=>this._removeLabelTextureFromAtlas(e)),this._labelsToAdd.forEach(e=>this._addLabelTextureToAtlas(e)),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(t){const e=t.labelClassAbortController.signal;await t.layer.when(),Dt(e),t.scaleVisibility&&t.scaleVisibility.updateScaleRangeActive();const i=t.graphics3DCore,r=i.layer,s=r.labelingInfo&&r.labelingInfo.filter(a=>!!a.symbol);if(!s||s.length===0)return;const n=new Array(s.length);let o=!1;await cM(s,async(a,l)=>{const c=a.symbol,h=kU(i.getOrCreateGraphics3DSymbol(c));if(A(h))return void zde.error("Failed to create Graphics3DSymbol for label");await h.load(),Dt(e);let p=null;AL(c)&&c.hasVisibleCallout()&&(p=EUe(c,i.symbolCreationContext),await p.load(),Dt(e));const f=await zl(ace(a,t.layer.fieldsIndex,this.view.spatialReference));Dt(e),f.ok===!0?n[l]={labelClass:a,labelFunction:f.value,graphics3DSymbol:h,graphics3DCalloutSymbolLayer:p,calloutSymbolLayerIndex:0,textRenderParameters:this._createTextRenderParameters(h.symbol)}:(zde.error(`Label expression failed to evaluate: ${f.error}`),o=!0)}),Dt(e),o||(t.labelClassContexts=n)}async _createLabelClassContext(t){return t.labelClassPromise||(t.labelClassPromise=this._createLabelClassContextAsync(t).catch(e=>{if(bi(e))throw e;t.labelClassContexts=null}).then(()=>{t.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),t.labelClassPromise}_createTextRenderParameters(t){const e=t.symbolLayers.getItemAt(0);return e&&e.type==="text"?pI.fromSymbol(e,this.view.pixelRatio):null}_destroyLabelClassContext(t){for(const i of t.labelClassContexts)--i.graphics3DSymbol.referenced,i.graphics3DSymbol=null;const e=t.labelClassAbortController;t.labelClassAbortController=new AbortController,e&&e.abort(),t.labelClassContexts=[],t.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(t,e,i,r,s){const n={text:t.text,centerOffset:i.centerOffset,translation:i.translation,elevationOffset:i.elevationOffset,screenOffset:i.screenOffset,anchor:i.anchor,centerOffsetUnits:i.centerOffsetUnits,verticalOffset:i.verticalOffset,debugDrawBorder:Kt.LABELS_SHOW_BORDER,displayWidth:t.displayWidth,displayHeight:t.displayHeight};return km.graphic=e,km.renderingInfo=null,km.layer=r,s.createLabel(km,n,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(t,e,i,r,s){const n={symbol:e,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,centerOffset:r.centerOffset,centerOffsetUnits:r.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return km.graphic=t,km.renderingInfo=n,km.layer=s,i.createGraphics3DGraphic(km)}_ensureGraphics3DResources(t){if(t.hasGraphics3DResources)return!1;const e=t.graphics3DGraphic;if(e.destroyed)return!1;this._ensureTextTextureResources(t);const i=t.labelingContext,r=i.labelClassContexts;if(!r||r.length===0||!i.emptySymbolLabelSupported&&e.graphics.length===0)return!1;let s=!1;const n=e.graphic,o=i.layer,a=H6(i.layer),l=this.view._stage;for(let c=0;c<r.length;c++){const h=t.textRenderers[c];if(!h)continue;const p=r[c],f=p.graphics3DSymbol;let g=null;f.symbol&&f.symbol.type==="label-3d"&&(g=f.symbol);const y=f.symbolLayers[0];if(!y)continue;const v=p.labelClass,b=i.disablePlacement,w=KZe({graphics3DGraphic:e,labelSymbol:g,labelClass:v,disablePlacement:b});if(A(w))continue;y.setElevationInfoOverride(i.elevationInfoOverride);const S=this._createTextSymbolGraphic(h,n,w,o,y);if(!S)return!1;S._labelClass=v,S._labelIndex=c,e.addLabelGraphic(S,l,i.stageLayer),e.setVisibilityFlag(0,a,1),e.clearVisibilityFlag(1,1),e.setVisibilityFlag(3,!1,1),s=!0;const T=p.graphics3DCalloutSymbolLayer;if(T&&w.hasLabelVerticalOffset){T.setElevationInfoOverride(i.elevationInfoOverride);const C=this._createLineCalloutGraphic(n,g,T,w,o);C&&(p.calloutSymbolLayerIndex=e.labelGraphics.length,e.addLabelGraphic(C,l,i.stageLayer))}break}return i.scaleVisibility&&s&&i.scaleVisibility.updateGraphicLabelScaleVisibility(e),t.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(t){const e=t.labelingContext.labelClassContexts;for(const i of t.graphics3DGraphic.labelGraphics){if(i._labelClass==null)continue;const r=e[i._labelIndex].graphics3DSymbol.symbolLayers[0];r!=null&&r.onRemoveGraphic(i)}t.graphics3DGraphic.clearLabelGraphics(),t.hasGraphics3DResources=!1}_ensureTextTextureResources(t){if(t.hasTextTextureResources)return;const e=t.labelingContext,i=e.labelClassContexts;if(!i||i.length===0)return;const r=t.graphics3DGraphic.graphic;for(let s=0;s<i.length;s++){const n=i[s];if(t.textRenderers[s]=null,!n.textRenderParameters)continue;const o=n.labelFunction;let a;if(o.type==="arcade")try{const l=o.needsHydrationToEvaluate()?M7e(r,e.layer):r;a=o.evaluate(l)}catch{a=null}else a=o.evaluate(r);A(a)||a===""||/^\s+$/.test(a)||(t.textRenderers[s]=new Mde(a,n.textRenderParameters))}t.hasTextTextureResources=!0}_destroyTextTextureResources(t){t.textRenderers=[],t.hasTextTextureResources=!1}_addGraphic(t,e){const i={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:t,graphics3DGraphic:e,textRenderers:[]},r=e.graphic.uid;t.labels.set(r,i),t.labelsToInitialize.set(r,i),this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(t,e){const i=e.graphic.uid,r=t.labels.get(i);r&&(this._destroyGraphic(r,i),t.labels.delete(i),t.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(t,e){this._labels.has(e)&&(this._labels.delete(e),this._labelsToAdd.delete(e),this._labelsToRemove.delete(e)),t.hasTextTextureResources&&(this._removeLabelTextureFromAtlas(t),this._destroyTextTextureResources(t)),t.hasGraphics3DResources&&this._destroyGraphics3DResources(t)}async _labelingInfoChange(t,e){if(!e)return this._visibilityInfoChange(t),this._resetLabels(t),this._createLabelClassContext(t);for(const i of e){const r=t.labels.get(i);r&&(this._removeGraphic(t,r.graphics3DGraphic),this._addGraphic(t,r.graphics3DGraphic))}}_globalPropertyChanged(t,e){for(const i of e.labelClassContexts){const r=new Map;e.labels.forEach(n=>{const o=n.graphics3DGraphic;r.set(o.graphic.uid,o)});const s=n=>n.labelGraphics[0];if(at(i.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(t,r,s),i.graphics3DCalloutSymbolLayer){const n=o=>o.labelGraphics[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(t,r,n)}}}_visibilityInfoChange(t){const e=t.layer.labelsVisible;e&&!t.active&&this._activateLabelingContext(t),!e&&t.active&&this._deactivateLabelingContext(t),this.setDirty()}_resetAllLabels(){for(const t of this._labelingContexts)this._resetLabels(t)}_resetLabels(t){t.labels.forEach((e,i)=>{this._destroyGraphic(e,i),e.visible=!1,e.rendered=!1,t.labelsToInitialize.set(i,e)}),this._destroyLabelClassContext(t),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(t){for(const e of this._labelingContexts)if(e.graphics3DCore===t)return e;return null}addGraphicsOwner(t,e,i){const r=i&&i.emptySymbolLabelSupported||!1,s=i&&i.elevationInfoOverride||null,n=i&&i.disablePlacement||null;if(this._findLabelingContext(t))return;const o=t.layer,a={graphics3DCore:t,layer:o,scaleVisibility:e,emptySymbolLabelSupported:r,elevationInfoOverride:s,disablePlacement:n,active:o.labelsVisible,labelClassPromise:null,labelClassAbortController:new AbortController,labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new Yce({isPickable:!0},o.uid)};return this.view._stage.add(a.stageLayer),this._labelingContexts.push(a),this.setDirty(),{addGraphic:l=>this._addGraphic(a,l),removeGraphic:l=>this._removeGraphic(a,l),featureReductionChange:()=>{},layerLabelsEnabled:()=>H6(a.layer),labelingInfoChange:l=>this._labelingInfoChange(a,l),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",a),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",a),visibilityInfoChange:()=>this._visibilityInfoChange(a),reset:()=>this._resetLabels(a),clear:()=>{}}}removeGraphicsOwner(t){const e=this._findLabelingContext(t);if(!e)return;const i=this._labelingContexts.indexOf(e);this._labelingContexts.splice(i,1),e.labels.forEach(r=>this._removeGraphic(e,r.graphics3DGraphic)),this.view._stage.remove(e.stageLayer),e.stageLayer=null,this.setDirty()}setLabelGraphicVisibility(t,e){const i=t.graphic.uid,r=this._labels.get(i);r&&r.visible!==e&&(e&&!r.rendered?(this._labelsToAdd.set(i,r),this._labelsToRemove.delete(i),r.hasTextTextureResources||r.labelingContext.labelsToInitialize.set(i,r)):!e&&r.rendered&&(this._labelsToRemove.set(i,r),this._labelsToAdd.delete(i)),r.visible=e,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var t;return this._dirty||((t=this._textTextureAtlas)==null?void 0:t.updating)||this.deconflictor.updating||this._labelingContexts.some(e=>BU(e))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const t=this._labelingContexts.length>0?this._labelingContexts.reduce((e,i)=>e+(BU(i)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*t+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function pJe(t){return t.active&&H6(t.layer)}function BU(t){return t.labelClassPromise&&!!t.labelClassAbortController}function Vde(t){return t.labelClassContexts&&t.labelClassContexts.length}function fJe(t){return t.labelClassContexts===null}u([d({constructOnly:!0})],yv.prototype,"view",void 0),u([d({constructOnly:!0})],yv.prototype,"deconflictor",void 0),u([d()],yv.prototype,"_textTextureAtlas",void 0),u([d({type:Boolean,readOnly:!0})],yv.prototype,"updating",null),yv=u([R("esri.views.3d.layers.graphics.Labeler")],yv);const km=new RUe(null,null,null);class mJe{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new dt}loadGLTF(e,i,r){const s=r?`gltfPBR:${e}`:`gltf:${e}`;return this.fromCache(this.gltfCache,s,n=>qhe(new Uhe(n.streamDataRequester),e,n,r),i)}loadWOSR(e,i){const r=`wosr:${e}:${i.disableTextures}`;return this.fromCache(this.wosrCache,r,s=>Hhe(e,s),i)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}fromCache(e,i,r,s){return new Promise((n,o)=>{if(Ir(s))return void o($t());const a=ps(s,()=>{this.remove(e,i),o($t())}),l=e.get(i);if(l)return this.evictHandles.remove(i),l.refCount++,void l.item.then(n,o);const c=new AbortController,h=he(E({},s),{signal:c.signal}),p={refCount:1,abortController:c,item:r(h).then(f=>(p.abortController=null,f.remove=()=>this.remove(e,i),f))};e.set(i,p),p.item.then(f=>{_(a)&&a.remove(),n(f)},f=>{_(a)&&a.remove(),o(f)})})}remove(e,i){const r=e.get(i);r&&(r.refCount--,r.refCount===0&&this.evictHandles.add(jye(()=>{e.delete(i),_(r.abortController)&&r.abortController.abort()},yJe),i))}}const gJe=1e4;let yJe=gJe;class kc{constructor(e,i,r,s=null){this.lij=[0,0,0],this.extent=pt(),this.resolution=0,this.loadPriority=0,this.measures={visibility:2,screenRect:pt(),distance:0,shouldSplit:!1},this.used=!1,s&&this.acquire(e,i,r,s)}acquire(e,i,r,s){this.tilingScheme=s,this.id=kc.id(e,i,r),this.lij[0]=e,this.lij[1]=i,this.lij[2]=r,s.getExtent(e,i,r,this.extent),this.resolution=s.resolutionAtLevel(e)}release(){this.tilingScheme=null}getChildren(e){const i=this.lij[0]+1,r=2*this.lij[1],s=2*this.lij[2];return e?(e[0].acquire(i,r,s,this.tilingScheme),e[1].acquire(i,r+1,s,this.tilingScheme),e[2].acquire(i,r,s+1,this.tilingScheme),e[3].acquire(i,r+1,s+1,this.tilingScheme),e):[new kc(i,r,s,this.tilingScheme),new kc(i,r+1,s,this.tilingScheme),new kc(i,r,s+1,this.tilingScheme),new kc(i,r+1,s+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,Bp(e.measures.screenRect,this.measures.screenRect)}static id(e,i,r){return`${e}/${i}/${r}`}}class zm{constructor(e){this.renderCoordsHelper=e,this.frustum=mb(),this._points=Boe(),this.lines=new Array(12),this._origin=$(),this._direction=$(),this._altitude=null;for(let i=0;i<12;i++)this.lines[i]={origin:null,direction:$(),endpoint:null}}get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}update(e){Goe(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),re(this._origin,e.eye),re(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this.updateLines()}updatePoints(e){for(let i=0;i<this._points.length;i++)re(this._points[i],e[i]);qoe(this.frustum,this._points),this.updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return am(this.frustum,e)}intersectsRay(e){return B8e(this.frustum,e)}intersectsLineSegment(e,i){return G8e(this.frustum,e,i)}intersectsPoint(e){return Hoe(this.frustum,e)}updateLines(){const e=this._points;for(let i=0;i<4;i++){const r=i+4;GU(this.lines[i],e[i],e[r]),GU(this.lines[i+4],e[i],i===3?e[0]:e[i+1]),GU(this.lines[i+8],e[r],i===3?e[4]:e[r+1])}}}function GU(t,e,i){t.origin=e,t.endpoint=i,Lh(t.direction,e,i)}zm.planePointIndices=H8e,zm.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]];const Nde=.5*Math.PI,vJe=Nde/Math.PI*180;class _Je{constructor(e){this.renderCoordsHelper=e.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:$(),direction:$()};for(let i=0;i<4;i++)this.extent[i]={origin:$(),direction:$(),cap:{next:null,direction:$()}},this.planes[i]=Mt();this.planes[4]=Mt(),this.planes[5]=Mt(),this.planesWithoutFar=this.planes.slice(0,5)}update(e,i,r,s=!0){const n=this.extent;this.toRenderBoundingExtent(e,i,r),de(this.center.origin,n[0].origin,n[2].origin),se(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),s||se(this.center.direction,this.center.direction,-1);for(let o=0;o<4;o++){const a=n[o];this.renderCoordsHelper.worldUpAtPosition(a.origin,a.direction);const l=n[o===3?0:o+1];a.cap.next=l.origin,Lh(a.cap.direction,a.origin,l.origin),_2(a.direction,a.cap.direction,a.origin,this.planes[o]),s||se(a.direction,a.direction,-1)}_2(n[0].cap.direction,n[1].cap.direction,n[0].origin,this.planes[4]),s?D6(this.planes[4],this.planes[5]):(tA(this.planes[4],this.planes[5]),D6(this.planes[4],this.planes[4])),this.maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this.maxSpanSpatialReference=i,this.minGlobalAltitude=.9*Ut(this.maxSpanSpatialReference).radius}isVisibleInFrustum(e,i,r=!1){if(e==null)return!1;if(this.renderCoordsHelper.viewingMode===1){const n=this.maxSpanSpatialReference.isGeographic?vJe:Nde*i;if(this.maxSpan>n)return!0;if(e.altitude>=this.minGlobalAltitude)return this.isVisibleInFrustumGlobal(e)}if(this.maxSpan===0){const n=this.extent[0];return!(r||!e.intersectsRay(Ko(n.origin,n.direction)))}for(let n=0;n<this.extent.length;n++){const o=this.extent[n];if(!r&&e.intersectsRay(Ko(o.origin,o.direction))||e.intersectsLineSegment(gy(o.origin,o.cap.next,wJe),o.cap.direction))return!0}const s=r?this.planes:this.planesWithoutFar;for(let n=0;n<e.lines.length;n++){const o=e.lines[n];if(xze(s,o.origin,o.endpoint,o.direction))return!0}return!1}toRenderBoundingExtentGlobal(e,i,r){const s=5;X5(e,zc),zc[2]=r,rc(i,zc,qU,this.renderCoordsHelper.spatialReference),Fi(Ude,qU),ii(Lo);for(const{x0:n,x1:o,y0:a,y1:l}of bJe)for(let c=0;c<s;c++){const h=c/(s-1);zc[0]=Et(e[n],e[o],h),zc[1]=Et(e[a],e[l],h),zc[2]=r,Ns(zc,i,zc,this.renderCoordsHelper.spatialReference),Oe(zc,zc,Ude),uu(Lo,zc)}ne(this.extent[0].origin,Lo[0],Lo[1],Lo[2]),ne(this.extent[1].origin,Lo[3],Lo[1],Lo[2]),ne(this.extent[2].origin,Lo[3],Lo[4],Lo[2]),ne(this.extent[3].origin,Lo[0],Lo[4],Lo[2]);for(let n=0;n<4;++n)Oe(this.extent[n].origin,this.extent[n].origin,qU)}toRenderBoundingExtentLocal(e,i,r){WP(e,i,Yd,this.renderCoordsHelper.spatialReference),ne(this.extent[0].origin,Yd[0],Yd[1],r),ne(this.extent[1].origin,Yd[2],Yd[1],r),ne(this.extent[2].origin,Yd[2],Yd[3],r),ne(this.extent[3].origin,Yd[0],Yd[3],r)}toRenderBoundingExtent(e,i,r){switch(this.renderCoordsHelper.viewingMode){case 1:this.toRenderBoundingExtentGlobal(e,i,r);break;case 2:this.toRenderBoundingExtentLocal(e,i,r);break;default:kn(this.renderCoordsHelper.viewingMode)}}isVisibleInFrustumGlobal(e){if(ye(this.center.direction,e.direction)<0)return!0;for(let i=0;i<4;i++){const r=this.extent[i];if(ye(r.direction,e.direction)<0)return!0}return!1}}const bJe=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],zc=$(),qU=be(),Ude=be(),Lo=lr(),Yd=pt(),wJe=ff();class xJe{constructor(e){this.renderCoordsHelper=e,this.surfaceElevation=0,this.cache=new Map,this.frustum=new zm(e),this.extendedFrustum=new zm(e),this.intersector=new _Je({renderCoordsHelper:e}),this.renderCoordsHelper=e}begin(e,i){this.surfaceElevation=i,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>i,this.frustum.update(e),this.shortenFrustumFarPlane(this.frustum),this.updateExtendedFrustum(e)}end(){this.cache.clear()}calculate(e){if(this.allTilesInvisible)return 0;const i=this.renderCoordsHelper.viewingMode===1&&e.lij[0]>=SJe&&e.lij[0]<TJe,r=this.getOrCalculateSingleTileVisibility(e,!i);return r!==0&&i?this.calculateAggregatedChildrenVisibility(e):r}shortenFrustumFarPlane(e){const i=zm.nearFarLineIndices,r=e.mutablePoints;for(const s of i){const[n,o]=s,a=r[n],l=r[o];ue(ba,l,a),se(ba,ba,MJe),de(r[o],a,ba)}e.updatePoints(r)}calculateAggregatedChildrenVisibility(e){let i=0;const r=this.cache.get(e.id);if(r!=null)return r;const s=qde.acquire();e.getChildren(s);for(const n of s){const o=this.calculate(n);if(o!==0&&(i=o,o===2))break}return qde.release(s),this.cache.set(e.id,i),i}getOrCalculateSingleTileVisibility(e,i){const r=this.cache.get(e.id);if(r!=null)return r;const s=this.calculateSingleTileVisibility(e);return i&&this.cache.set(e.id,s),s}calculateSingleTileVisibility(e){return!this.aboveGround&&this.renderCoordsHelper.viewingMode===1&&e.lij[0]<CJe?this.calculateSingleTileVisibilitySided(e,!1)===0?this.calculateSingleTileVisibilitySided(e,!0):void 0:this.calculateSingleTileVisibilitySided(e,this.aboveGround)}calculateSingleTileVisibilitySided(e,i){this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,i);const r=Ut(e.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,r)?this.intersector.isVisibleInFrustum(this.frustum,r,!0)?2:1:0}updateExtendedFrustum(e){this.extendedFrustum.update(e),this.shortenFrustumFarPlane(this.extendedFrustum);const i=this.renderCoordsHelper.worldUpAtPosition(e.eye,ba);this.aboveGround||Fs(i,i);const r=ar(-ye(i,e.viewForward));if(this.allTilesInvisible=r>(Math.PI+e.fovY)/2,this.allTilesInvisible||(this.hasExtendedFrustum=r>e.fovY/2,!this.hasExtendedFrustum))return;const s=this.extendedFrustumParameters(),n=this.extendedFrustum.mutablePoints;for(let o=0;o<4;o++){const a=s.pointIndices[o],l=n[a],c=this.renderCoordsHelper.getAltitude(l);if(s.needsAltitudeAdjustment(c)){switch(this.renderCoordsHelper.worldUpAtPosition(l,ba),a){case 4:case 7:case 0:case 3:F6(this.extendedFrustum.planes[0],ba,ba);break;case 5:case 6:case 1:case 2:F6(this.extendedFrustum.planes[1],ba,ba)}se(ba,ba,s.direction),this.renderCoordsHelper.intersectInfiniteManifold(Ko(l,ba),s.zWithMargin,l)}}if(this.extendedFrustum.updatePoints(n),Us(n[0],n[1],n[2],Bde),Us(n[1],n[2],n[3],Gde),ye(Li(Bde),Li(Gde))<0){const o=this.extendedFrustum.mutablePoints;this.aboveGround?[o[0],o[1]]=[o[1],o[0]]:[o[3],o[2]]=[o[2],o[3]],this.extendedFrustum.updatePoints(o)}}extendedFrustumParameters(){return this.aboveGround?this.extendedFrustumParametersAboveSurface():this.extendedFrustumParametersBelowSurface()}extendedFrustumParametersAboveSurface(){const e=this.surfaceElevation-jde;return{zWithMargin:e,pointIndices:zm.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:i=>i>e}}extendedFrustumParametersBelowSurface(){const e=this.surfaceElevation+jde;return{zWithMargin:e,pointIndices:zm.planePointIndices.top,direction:1,needsAltitudeAdjustment:i=>i<e}}}const SJe=2,TJe=6,CJe=12,MJe=.95,jde=1,ba=$(),Bde=Mt(),Gde=Mt(),qde=new Xi(Array,t=>{t.length!==4&&(t[0]=new kc,t[1]=new kc,t[2]=new kc,t[3]=new kc)},t=>{t[0].release(),t[1].release(),t[2].release(),t[3].release()});class PJe{constructor(e){this.camera=new Zt,this.focusOnMap=[0,0],this.screenRect=pt(),this.tileSize=e.tileSize,this.renderCoordsHelper=e.renderCoordsHelper,this.tilingScheme=e.tilingScheme,this.visibility=new xJe(e.renderCoordsHelper)}begin(e,i,r){this.camera.copyFrom(e),this.surfaceElevation=r,this.focusOnMap[0]=i.x,this.focusOnMap[1]=i.y,Jwe(0,0,e.fullWidth,e.fullHeight,this.screenRect),this.visibility.begin(this.camera,r)}end(){this.visibility.end()}updateTile(e){e.measures.visibility=this.visibility.calculate(e),e.measures.distance=Xwe(e.extent,this.focusOnMap),e.measures.visibility!==0&&this.updateScreenMeasure(e)}updateScreenMeasure(e){const i=AJe,r=1<<i,s=e.measures.screenRect;ja(s);let n=0;const o=e.lij[0]+i,a=e.lij[1]<<i,l=e.lij[2]<<i,c=this.tileSizeWithBias(e),h=c*c;for(let p=0;p<r;p++)for(let f=0;f<r;f++)if(n+=this.computeScreenArea(e,o,a+p,l+f,s),n>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}tileSizeWithBias(e){return e.measures.visibility===1?this.tileSize*$Je:this.tileSize}computeScreenArea(e,i,r,s,n){const o=e.measures.visibility===1;this.projectToScreen(i,r,s,o,Vm),ja(HU);for(let a=0;a<4;a++)BW(HU,Vm[a]);return Gp(n,HU,n),Wne(Vm[0],Vm[1],Vm[2])+Wne(Vm[0],Vm[2],Vm[3])}projectToScreen(e,i,r,s,n){this.tilingScheme.ensureMaxLod(e),this.tilingScheme.getExtent(e,i,r,C3),this.toRenderCoords(C3,0,3,Nm[0]),this.toRenderCoords(C3,2,3,Nm[1]),this.toRenderCoords(C3,2,1,Nm[2]),this.toRenderCoords(C3,0,1,Nm[3]),s&&(this.projectToPlane(Nm,this.camera.frustum[4]),this.projectToPlane(Nm,this.camera.frustum[3]),this.projectToPlane(Nm,this.camera.frustum[2]));for(let o=0;o<4;o++)this.camera.projectToRenderScreen(Nm[o],Hde),this.camera.renderToScreen(Hde,n[o])}projectToPlane(e,i){for(let s=0;s<4;s++)P3[s]=hi(i,e[s]);const r=Math.max(P3[0],P3[1],P3[2],P3[3]);if(r>0){const s=se(M3,Li(i),-r);for(let n=0;n<4;n++)de(e[n],e[n],s)}}toRenderCoords(e,i,r,s){return M3[0]=e[i],M3[1]=e[r],M3[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(M3,this.tilingScheme.spatialReference,s),s}}const HU=pt(),AJe=2,$Je=5,Vm=[Ii(),Ii(),Ii(),Ii()],C3=pt(),M3=$(),Nm=[$(),$(),$(),$()],P3=[0,0,0,0],Hde=ys();function Hat(t,e,i){if(A(t)||A(i))return!1;let r=!0;return Ar[0]=t.xmin!=null?t.xmin:0,Ar[1]=t.ymin!=null?t.ymin:0,Ar[2]=t.zmin!=null?t.zmin:0,r=r&&Mi(Ar,t.spatialReference,0,e,i,0,1),Ar[0]=t.xmax!=null?t.xmax:0,Ar[1]=t.ymax!=null?t.ymax:0,Ar[2]=t.zmax!=null?t.zmax:0,r=r&&Mi(Ar,t.spatialReference,0,e,i,3,1),t.xmin==null&&(e[0]=-1/0),t.ymin==null&&(e[1]=-1/0),t.zmin==null&&(e[2]=-1/0),t.xmax==null&&(e[3]=1/0),t.ymax==null&&(e[4]=1/0),t.zmax==null&&(e[5]=1/0),r}function Wde(t,e,i){if(A(t)||A(i))return!1;let r=!0;return Ar[0]=t.xmin!=null?t.xmin:0,Ar[1]=t.ymin!=null?t.ymin:0,Ar[2]=t.zmin!=null?t.zmin:0,r=r&&Mi(Ar,t.spatialReference,0,Ar,i,0,1),e[0]=Ar[0],e[1]=Ar[1],Ar[0]=t.xmax!=null?t.xmax:0,Ar[1]=t.ymax!=null?t.ymax:0,Ar[2]=t.zmax!=null?t.zmax:0,r=r&&Mi(Ar,t.spatialReference,0,Ar,i,0,1),e[2]=Ar[0],e[3]=Ar[1],t.xmin==null&&(e[0]=-1/0),t.ymin==null&&(e[1]=-1/0),t.xmax==null&&(e[2]=1/0),t.ymax==null&&(e[3]=1/0),r}const Ar=$(),EJe=le.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let As=class extends ve{constructor(t){super(t),this.tiles=new We,this.tileSize=512,this._idToTile=new Map,this._handles=new dt,this._clients=new Set,this._dirty=!1,this._newTiles=new ct}get tilingScheme(){const t=this.tilingSchemeOwner.tilingScheme;return t?t.clone():null}set filterExtent(t){if(_(t)&&!t.spatialReference.equals(this.viewState.spatialReference))return void EJe.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const e=this._get("filterExtent");if(e===t||_(e)&&t&&e.equals(t))return;const i=_(t)?t.clone():null;this._set("filterExtent",i),this._setDirty()}get filterExtentRect(){if(A(this.filterExtent)||!this.tilingScheme)return null;const t=pt();return Wde(this.filterExtent,t,this.tilingScheme.spatialReference),t}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(t){t!==this._get("suspended")&&(this._set("suspended",t),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add(this.watch(["tilingScheme","tileSize"],()=>this._reset(),!0)),this._handles.add(Ke(this,["tileSize","cameraOnSurface.location","tilingScheme","viewState.contentCamera","focus.location"],()=>this._setDirty(),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(Qe.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=ln(this._frameWorker),this._handles=tt(this._handles)}addClient(){const t=RJe();return this._clients.add(t),this._clients.size===1&&this._setDirty(),{remove:()=>this._removeClient(t)}}_removeClient(t){this._clients.delete(t),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(V_))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(t){this._dirty=!1,this._pendingTiles||(this._startUpdate(),_(this._frameWorker)&&(this._frameWorker.priority=Qe.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(t),!this._pendingTiles&&_(this._frameWorker)&&(this._frameWorker.priority=Qe.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new PJe({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const t=this.viewState.contentCamera;this._tileMeasurements.begin(t,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){return this.rootTileIds.map(t=>new kc(t[0],t[1],t[2],this.tilingScheme))}_purgeHorizonTiles(t){t.sort((e,i)=>{const r=e.measures.screenRect,s=i.measures.screenRect;return r[1]+r[3]-(s[1]+s[3])}),ja(vI);for(let e=0;e<t.length;e++)if(Gp(vI,t.data[e].measures.screenRect,vI),Gg(vI)>IJe)return t.data.slice(e,t.length);return[]}_subdivideTilesForView(t){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!t.done;){const e=this._pendingTiles.pop();t.madeProgress(),this.filterExtentRect&&!cP(this.filterExtentRect,e.extent)||(this._tileMeasurements.updateTile(e),e.measures.visibility!==0&&(e.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(e.lij[0]+1),this._pendingTiles.push(...e.getChildren())):this._newTiles.push(e)))}this._pendingTiles.length===0&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(t){for(const r of this.tiles.items)r.used=!1;const e=t.filter(r=>{const s=this._idToTile.get(r.id);return s?(s.copyMeasurementsFrom(r),s.used=!0):this._idToTile.set(r.id,r),!s}),i=this.tiles.items.filter(r=>!r.used&&(this._idToTile.delete(r.id),!0));this.tiles.removeMany(i),this.tiles.addMany(e),this.sortTiles()}sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((t,e)=>t.measures.visibility!==e.measures.visibility?t.measures.visibility===2?-1:1:t.measures.distance-e.measures.distance),this.tiles.forEach((t,e)=>t.loadPriority=e)}};u([d({constructOnly:!0})],As.prototype,"scheduler",void 0),u([d({constructOnly:!0})],As.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],As.prototype,"tilingSchemeOwner",void 0),u([d({constructOnly:!0})],As.prototype,"cameraOnSurface",void 0),u([d({constructOnly:!0})],As.prototype,"focus",void 0),u([d({constructOnly:!0})],As.prototype,"viewState",void 0),u([d({constructOnly:!0})],As.prototype,"terrain",void 0),u([d()],As.prototype,"tiles",void 0),u([d()],As.prototype,"tileSize",void 0),u([d({readOnly:!0})],As.prototype,"tilingScheme",null),u([d()],As.prototype,"filterExtent",null),u([d({readOnly:!0})],As.prototype,"filterExtentRect",null),u([d({readOnly:!0})],As.prototype,"rootTileIds",null),u([d({value:!1})],As.prototype,"suspended",null),u([d({readOnly:!0})],As.prototype,"updating",null),As=u([R("esri.views.3d.layers.support.FeatureTileTree3D")],As);let OJe=0;function RJe(){return OJe++}const vI=pt(),IJe=10,Zde=As;class Um{constructor(e,i){this.owner=i,this.properties={},this.afterDispatchHandle=null;for(const r in e){const s=e[r],n=new dG(s,null,null,2,2);this.properties[r]={pool:n,acquired:[]}}this.afterDispatchHandle=AG(()=>this.release())}destroy(){this.afterDispatchHandle&&(this.afterDispatchHandle.remove(),this.afterDispatchHandle=null);for(const e in this.properties){const i=this.properties[e];for(const r of i.acquired)$G(r)||i.pool.release(r);i.pool.destroy(),i.pool=null,i.acquired=null}this.properties=null,this.owner=null}get(e){const i=this.owner._get(e),r=this.properties[e];let s=r.pool.acquire();for(r.acquired.push(s);s===i;)r.acquired.push(s),s=r.pool.acquire();return s}release(){for(const e in this.properties){const i=this.properties[e];let r=0;for(const s of i.acquired)$G(s)?i.acquired[r++]=s:i.pool.release(s);i.acquired.length=r}}}let $s=class extends ve{constructor(){super(...arguments),this._propertiesPool=new Um({camera:Zt},this),this._lastSeenCameraProjectionValues=new Zt,this.events=new Ci,this.viewingMode=1,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1}init(t,e){this._set("viewingMode",t),this._set("spatialReference",e),this._set("constraints",new R5e({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new Um({camera:Zt},this)}createInitialCamera(){if(this.viewingMode===1){const t=Ut(this.spatialReference).radius;this.camera=new Zt(De(4*t,0,0),De(t,0,0),De(0,0,1))}else this.camera=new Zt(De(0,0,100),De(0,0,0),De(0,1,0))}get animation(){return this.cameraController instanceof _T&&_(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(t){t!==vl&&vl.copyFrom(t),vl.computeUp(this.viewingMode),Jde.camera=vl,this.events.emit("before-camera-change",Jde);const e=this._get("camera");if(this.cameraProjectionChanged(this._lastSeenCameraProjectionValues,vl)&&(this._lastSeenCameraProjectionValues.copyFrom(vl),Qde.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",Qde)),(!e||!e.equals(vl))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(vl)),this._cameraChanged=!e||!e.almostEquals(vl),this._cameraChanged)){const i=AG(()=>{this._cameraChanged=!1,i.remove()})}}get contentCamera(){return _(this._contentCamera)?this._contentCamera:this.camera}set contentCamera(t){this._contentCamera=_(t)?t.clone():null}get fixedContentCamera(){return!!_(this._contentCamera)}get isGlobal(){return this.viewingMode===1}get isLocal(){return this.viewingMode===2}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(t){this.stopActiveCameraController()?(t&&(t.watch("state",e=>{e!==Ti.Finished&&e!==Ti.Stopped||(this._set("cameraController",null),this.updateCamera(i=>t.onControllerEnd(i)))},!0),t.onControllerStart(this.camera)),this._set("cameraController",t)):t&&(t.state=Ti.Rejected)}switchCameraController(t){return this.cameraController=t,t.state!==Ti.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(t){this.updateQueue.push(t),this.processUpdateQueue()}processUpdateQueue(){if(this.updateQueue.length===0||this.processingUpdates)return;this.processingUpdates=!0;const t=this.updateQueue.shift();vl.copyFrom(this._get("camera")),t(vl),this.camera=vl,this.processingUpdates=!1,this.processUpdateQueue()}cameraProjectionChanged(t,e){return t.fov!==e.fov||t.fullViewport[0]!==e.fullViewport[0]||t.fullViewport[1]!==e.fullViewport[1]||t.fullViewport[2]!==e.fullViewport[2]||t.fullViewport[3]!==e.fullViewport[3]||t.padding[0]!==e.padding[0]||t.padding[1]!==e.padding[1]||t.padding[2]!==e.padding[2]||t.padding[3]!==e.padding[3]}};u([d({readOnly:!0,type:j_})],$s.prototype,"animation",null),u([d({type:Zt})],$s.prototype,"camera",null),u([d({})],$s.prototype,"_contentCamera",void 0),u([d({type:Zt})],$s.prototype,"contentCamera",null),u([d({readOnly:!0})],$s.prototype,"fixedContentCamera",null),u([d({readOnly:!0})],$s.prototype,"constraints",void 0),u([d({readOnly:!0})],$s.prototype,"events",void 0),u([d({readOnly:!0})],$s.prototype,"isGlobal",null),u([d({readOnly:!0})],$s.prototype,"isLocal",null),u([d({readOnly:!0})],$s.prototype,"viewingMode",void 0),u([d({readOnly:!0})],$s.prototype,"spatialReference",void 0),u([d({readOnly:!0})],$s.prototype,"navigating",null),u([d({readOnly:!0})],$s.prototype,"stationary",null),u([d()],$s.prototype,"_cameraChanged",void 0),u([d()],$s.prototype,"cameraController",null),$s=u([R("esri.views.3d.state.ViewState")],$s);const DJe=$s,vl=new Zt,Jde={camera:null},Qde={camera:null};function FJe(t,e,i){return t===1?new kJe(i):new LJe(e,i)}class LJe{constructor(e,i){this.elevationProvider=e,this._referenceEllipsoid=Ut(i),this.unitInMeters=bo(i,this._referenceEllipsoid.metersPerDegree)}compute(e,i,r,s,n){n||(n={near:0,far:0});let o=e[2]*this.unitInMeters;const a=o,l=o-s,c=this.elevationProvider?this.elevationProvider.elevationBounds:null;c&&(o=l>=0?a-this.unitInMeters*c.min:this.unitInMeters*c.max-a);const h={x:(r=_(r)?r:new ht({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-r.xmin,y:r.ymax-r.ymin,z:4*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},p=Math.max(h.x,h.y,h.z);ue(vv,i,e),iw[0]=vv[0]>0?r.xmax:r.xmin,iw[1]=vv[1]>0?r.ymax:r.ymin,iw[2]=vv[2]>0?p/2:-p/2,ue(iw,iw,e),_e(vv,vv);const f=1.1*ye(iw,vv)*this.unitInMeters,g=Math.sqrt(o*(o+2*this._referenceEllipsoid.radius)),y=Math.max(r.xmax-r.xmin,r.ymax-r.ymin),v=y*NJe*this.unitInMeters,b=y*UJe*this.unitInMeters;let w=Re((o-b)/(v-b),0,1);w*=w*w;let S=Et(g,f,w);return S*=Math.max(Math.log(Math.abs(l)),1),S=Math.min(S,Math.max(34064e4,p)),S/=this.unitInMeters,Yde(S,zJe,this.unitInMeters,n)}}class kJe{constructor(e){this._referenceEllipsoid=Ut(e)}compute(e,i,r,s,n){n||(n={near:0,far:0});const o=Te(e)-this._referenceEllipsoid.radius,a=this._referenceEllipsoid.radius+Math.min(0,s),l=Math.abs(o-s),c=Math.max(l,Math.abs(o));return Yde(1.2*Math.sqrt(c*(c+2*a)),Re(2e4-(Math.log(c)-7.983)/9.011*19e3,1e3,2e4),1,n)}}function Yde(t,e,i,r){const s=VJe/i;return t/e>s?(r.far=t,r.near=r.far/e):(r.near=s,r.far=r.near*e),r}const zJe=2e4,VJe=2,NJe=.001,UJe=1e-4,iw=$(),vv=$();let _I=class extends ve{constructor(t){super(t),this.handles=new dt}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",t=>this.handleElevationChangeEvent(t)))}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}handleElevationChangeEvent(t){if(this.view.state.cameraController)return;const e=this.view.state.camera;Poe(this.view,e,t.extent,t.spatialReference)&&this.applyToCurrentCamera()}applyToCurrentCamera(){this.view.state.updateCamera(t=>{pb(this.view,t,1)})}};u([d({constructOnly:!0})],_I.prototype,"view",void 0),_I=u([R("esri.views.3d.state.ElevationCollisionConstraint")],_I);const jJe=_I;let A3=class extends ve{constructor(t){super(t),this._handles=new dt,this.nearFarHeuristic=FJe(t.view.state.viewingMode,t.view.basemapTerrain,t.view.renderCoordsHelper.spatialReference)}initialize(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],()=>this._clipDistanceNearFarChanged()),this.view.watch("constraints.clipDistance.mode",()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",t=>this._updateCameraNearFar(t.camera)),this.view.watch("renderDataExtent",()=>this._updateNearFar(),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],()=>this._updateAltitude(),!0),this.view.watch("constraints.tilt.max",()=>this._updateTiltMax(),!0),this.view.watch("constraints.tilt.mode",()=>this._updateTilt(),!0),this.view.watch("state.camera",()=>this._updateTiltAutoMax(),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],()=>this._updateCollision(),!0)]),this.view.state.isLocal&&this._handles.add(Ke(this.view,"renderDataExtent",t=>this._updateLocalSurfaceDistance(t))),this._updateNearFar(),this.view.state.viewingMode!==2&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new jJe({view:this.view}))}destroy(){this._handles=tt(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var t;const e=(t=this.view.constraints)==null?void 0:t.clipDistance;e&&e.mode!=="auto"&&this.view.state.updateCamera(i=>(this._updateCameraNearFarManual(i,e),!0))}_updateNearFar(){this.view.state.updateCamera(t=>(this._updateCameraNearFar(t),!0))}_updateCameraNearFar(t){const e=this.view.constraints&&this.view.constraints.clipDistance;(e?e.mode:"auto")==="manual"?this._updateCameraNearFarManual(t,e):this._updateCameraNearFarAuto(t,e)}_updateCameraNearFarAuto(t,e){this.nearFarHeuristic.compute(t.eye,t.center,this.view.renderDataExtent,KE(this.view,t.eye),t),e&&e.autoUpdate(t.near,t.far)}_updateCameraNearFarManual(t,e){e&&(t.near=e.near,t.far=e.far)}_updateCollision(){var t,e,i;const r=(t=this.view.map)==null||(e=t.ground)==null||(i=e.navigationConstraint)==null?void 0:i.type,s=!r||r==="stay-above",n=this.view.state.constraints.collision;if(s!==n.enabled){n.enabled=s,s&&this._reapplyConstraints(8);const o=this.view.constraints&&this.view.constraints.tilt;o&&o.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const t=this.view.constraints&&this.view.constraints.altitude;t&&this.view.state.viewingMode!==2?this.view.state.constraints.altitude={min:t.min,max:t.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const t=this.view.constraints&&this.view.constraints.tilt;t&&t.mode!=="auto"&&(this._updateTiltManual(t),this._reapplyConstraints())}_updateTilt(){const t=this.view.constraints&&this.view.constraints.tilt;(t?t.mode:"auto")==="manual"?this._updateTiltManual(t):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(t){const e=this.view.state.constraints;e.tilt=e.createConstantMaxTilt(nt(t.max))}_updateTiltAuto(){const t=this.view.state.constraints;t.tilt=t.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const t=this.view.constraints&&this.view.constraints.tilt;if(!t||t.mode!=="auto")return;const e=this.view.state.constraints;if(e.tilt){const i=e.tilt(this.view.state.camera.distance).max;t.autoUpdate(go(i))}}_updateLocalSurfaceDistance(t){if(A(t))return;let e=Math.max(t.width,t.height);if(e<=0)return;t.hasZ&&(e=Math.max(e,t.zmax-t.zmin));const i=this.view.state,r=3*e/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(t=15){this.view.state.updateCamera(e=>Hi(this.view,e,{selection:t,interactionType:0,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:0}))}};u([d({constructOnly:!0})],A3.prototype,"view",void 0),u([d({readOnly:!0})],A3.prototype,"surfaceCollisionConstraint",void 0),A3=u([R("esri.views.3d.state.ConstraintsManager")],A3);const BJe=A3;let rw=class extends $0{constructor(t){super(t),this.handles=new dt}set desiredCamera(t){this._set("desiredCamera",t.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=Ti.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",t=>this.handleElevationChangeEvent(t))),this.applyCorrection()}onControllerEnd(){this.handles.removeAll()}stepController(){}handleElevationChangeEvent(t){Poe(this.view,this.desiredCamera,t.extent,t.spatialReference)&&this.applyCorrection()}applyCorrection(){this.view.state.updateCamera(t=>{t.copyViewFrom(this.desiredCamera),pb(this.view,t,1)||this.constraintEnabled||(this.state=Ti.Stopped)})}};u([d({constructOnly:!0})],rw.prototype,"view",void 0),u([d({constructOnly:!0})],rw.prototype,"desiredCamera",null),rw=u([R("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],rw);const GJe=.66;function Xde(t){return 360-t5.normalize(t)}function bI(t){return t5.normalize(360-t)}function wI(t){return _(t)&&t.resolver&&t.resolver.reject(),null}function qJe(t,e){return _(t)&&t.resolver&&t.resolver.resolve(e),e}function Kde(t,e,i,r=null){if(!e)return wI(r);const s=t.spatialReference||Ue.WGS84;if(_(e.camera)){const c=wg(e.camera.position,s);if(A(c))return wI(r);const h=e.camera.clone();return h.position=c,qJe(r,h)}if(A(e.targetGeometry))return wI(r);const n=e.get("targetGeometry.spatialReference");if(n&&!Rh(n,s))return wI(r);const o=xb(t,t.state.camera);let a=1;if(e.rotation!=null&&(o.heading=Xde(e.rotation),a=0),i!=null&&(o.tilt=i),e.targetGeometry.type==="point"){const c=e.targetGeometry;let h;const p=e.targetGeometry.clone();return h=e.scale!=null?ON(t,e.scale,c.latitude):t.state.camera.distance,kae(t,p,h,o,a,r)}const l=e.targetGeometry.extent;return CT(t,l,o.heading,o.tilt,a,r)}function HJe(t,e,i=null){return A(i)&&(i=new ec),JU(t,null,e.clone(),i)}async function WJe(t,e,i){const r=rQe(t,e);if(!r)throw new Q("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new yo({fov:t.camera.fov}),n=new ec({camera:s});if(r.target instanceof ec)return _v(await QJe(t,r.target,r,i,n));if(r.target instanceof yo)return _v(tpe(t,r.target,n));const o=r.scale!=null||r.zoom!=null;if(r.target instanceof ht){const c=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return _v(o||c?await QU(t,r,r.target.center,s,i,n):await eQe(t,r,r.target,s,i,n))}const a={boundingBox:ii(),hasZ:!1,screenSpaceObjects:[]},l=o?ZJe(t,r):void 0;if(await epe(t,r.target,l,a),isFinite(a.boundingBox[0])){let c;if(Yl(a.boundingBox,Ji),wa.x=Ji[0],wa.y=Ji[1],wa.z=Ji[2],wa.spatialReference=t.spatialReference,isFinite(wa.z)&&a.hasZ?c=mP(a.boundingBox):(wa.z=void 0,c=Kwe(rL(a.boundingBox,nQe))),o||c)return _v(await QU(t,r,wa,s,i,n));const h=sQe(t,a.screenSpaceObjects);return _v(await iQe(t,r,wa,a.boundingBox,h,s,i,n))}return r.position?_v(XJe(t,r,s,n)):_v(await KJe(t,r,s,i,n))}function WU(t,e){return e.scale==null&&e.zoom!=null?Nae(t,e.zoom):e.scale}function ZJe(t,e){return fVe(t,WU(t,e))}function ZU(t,e){let i=!1;return e.heading!=null?(t.heading=e.heading,i=!0):e.rotation!=null&&(t.heading=Xde(e.rotation),i=!0),e.tilt!=null&&(t.tilt=e.tilt,i=!0),e.fov!=null&&(t.fov=e.fov),i}function JU(t,e,i,r){const s=t.spatialReference||Ue.WGS84;return e=_(e)?e:Od(t,i),A(e)||(r.targetGeometry=nf(e.center,t.renderSpatialReference,s),r.scale=Uae(t,e),r.rotation=bI(i.heading),r.camera=i),r}function xI(t,e,i){if(!e)return;if(!Rh(e.spatialReference,t.spatialReference))throw new Q("viewpointutils:incompatible-spatialreference",`Spatial reference (${e.spatialReference?e.spatialReference.wkid:"unknown"}) is incompatible with the view (${t.spatialReference.wkid})`,{geometry:e});const r=[];if(!e.hasZ&&t.basemapTerrain){let o;switch(e.type){case"point":o=e;break;case"multipoint":case"polyline":o=e.extent.center;break;case"mesh":o=e.origin;break;case"extent":o=e.center;break;case"polygon":o=e.centroid}o&&Rh(o,t.basemapTerrain.spatialReference)?Ji[2]=st(wc(t.elevationProvider,o),0):Ji[2]=0}(0,oQe[e.type])(e,o=>{r.push(o[0],o[1],o[2])},Ji);const s=r.length/3;if(s===0)return;const n=new Array(r.length);if(Mi(r,e.spatialReference,0,n,t.spatialReference,0,s)){e.hasZ&&(i.hasZ=!0);for(let o=0;o<n.length;o+=3)e.hasZ?(Ji[0]=n[o+0],Ji[1]=n[o+1],Ji[2]=n[o+2]):(Ji[0]=n[o+0],Ji[1]=n[o+1]),uu(i.boundingBox,Ji)}}async function JJe(t,e,i,r){const s=await zl(t.whenViewForGraphic(e));if(s.ok===!1||A(s.value)||!("whenGraphicBounds"in s.value))return void xI(t,e.geometry,r);const n=s.value,o=await zl(n.whenGraphicBounds(e,{minDemResolution:i}));if(o.ok===!1)return void xI(t,e.geometry,r);const{screenSpaceObjects:a,boundingBox:l}=o.value;g1(r.boundingBox,l),a&&a.forEach(c=>{r.screenSpaceObjects.push(c)}),isFinite(l[2])&&(r.hasZ=!0)}async function epe(t,e,i,r){if(Array.isArray(e)&&e.length===2){const s=e[0],n=e[1];if(typeof s=="number"&&typeof n=="number")return wa.x=s,wa.y=n,wa.z=void 0,wa.spatialReference=t.spatialReference.isGeographic?t.spatialReference:Ue.WGS84,void xI(t,wa,r)}e&&typeof e.map=="function"?await En(e.map(s=>epe(t,s,i,r))):e instanceof ho?xI(t,e,r):e instanceof pn&&await JJe(t,e,i,r)}async function QJe(t,e,i,r,s){if(_(e.camera))return tpe(t,e.camera,s);s.scale=e.scale,s.rotation=e.rotation,s.targetGeometry=_(e.targetGeometry)?e.targetGeometry.clone():null,s.camera=null,i.heading!=null?s.rotation=bI(i.heading):i.rotation!=null&&(s.rotation=i.rotation);const n=WU(t,i);n!=null&&(s.scale=n);const o=new Sb(r);return Kde(t,s,i.tilt,o),s.camera=await o.resolver.promise,s}function tpe(t,e,i){const r=t.spatialReference,s=wg(e.position,r);return A(s)?null:((e=e.clone()).fov=t.camera.fov,e.position=s,JU(t,null,e,i))}function YJe(t,e,i,r,s,n){const o=t.renderSpatialReference;return Gr(i.position,CI,o),Gr(e,YU,o),n.targetGeometry=new je(e),s.position=new je(i.position),ue(TI,YU,CI),MO(t,CI,TI,r.up,s),n.scale=F0(t,qt(CI,YU),n.targetGeometry.latitude),n.rotation=bI(s.heading),n.camera=s,n}async function QU(t,e,i,r,s,n){if(A(i))throw new Q("createfromcenter","invalid point");n.targetGeometry=i.clone();const o=M0(t);if(e.position)return YJe(t,n.targetGeometry,e,o,r,n);if(e.zoomFactor){const l=o.distance/e.zoomFactor,c=se(Ji,o.viewForward,-l);o.eye=de(Ji,o.center,c),n.scale=F0(t,l,i.latitude)}xb(t,o,r);const a=ZU(r,e)?0:1;if(!e.zoomFactor){n.scale=WU(t,e),n.scale==null&&(Gr(i,Ji,t.renderSpatialReference),Hoe(o.frustum,Ji)?n.scale=F0(t,qt(o.eye,Ji),i.latitude):n.scale=Uae(t,o));const l=new Sb(s);Lae(t,n.targetGeometry,n.scale,r,a,l),n.camera=await l.resolver.promise}return n}function XJe(t,e,i,r){const s=M0(t);return re(TI,s.viewForward),MO(t,s.eye,TI,s.up,XU),i.position=new je(e.position),i.heading=e.heading!=null?e.heading:XU.heading,i.tilt=e.tilt!=null?e.tilt:XU.tilt,JU(t,null,i,r)}async function KJe(t,e,i,r,s){const n=M0(t);return QU(t,e,nf(n.center,t.renderSpatialReference,t.spatialReference),i,r,s)}async function eQe(t,e,i,r,s,n){n.targetGeometry=i.clone();const o=M0(t);xb(t,o,r);const a=ZU(r,e)?0:1,l=new Sb(s);return CT(t,i,r.heading,r.tilt,a,l),n.camera=await l.resolver.promise,n}function tQe(t,e,i,r,s){let n=0;i.hasZ?n=i.z:t.basemapTerrain&&(n=at(wc(t.elevationProvider,i))),ne(Ji,i.x,i.y,n),rc(t.spatialReference,Ji,ipe,t.renderSpatialReference),Ka(SI,ipe),el(SI,SI),ii($3);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let y=0;y<o.length;y++){const v=o[y];let b=r[v[2]];isFinite(b)||(b=n),ne(Ji,r[v[0]],r[v[1]],b),Ns(Ji,t.spatialReference,Ji,t.renderSpatialReference),uu($3,fo(Ji,Ji,SI))}const a=y1($3),l=Wg($3),c=v1($3),h=1/Math.tan(e.fovX/2),p=1/Math.tan(e.fovY/2),f=.5*Math.sqrt(a*a+c*c)*Math.max(p,h)+.5*l,g=.5*l*p+.5*Math.max(a,c);return Math.max(f,g)/s}async function iQe(t,e,i,r,s,n,o,a){a.targetGeometry=i.clone();const l=M0(t),c=tQe(t,l,i,r,s);xb(t,l,n);const h=ZU(n,e)?0:1;a.scale=F0(t,c,a.targetGeometry.latitude);const p=new Sb(o);return Lae(t,a.targetGeometry,a.scale,n,h,p),a.camera=await p.resolver.promise,a}function rQe(t,e){if(!e||!t.spatialReference)return null;const i={target:null};if("declaredClass"in e||Array.isArray(e))i.target=e;else{for(const r in e)i[r]=e[r];e.center&&!i.target&&(i.target=e.center)}return i}function _v(t){return t&&_(t.camera)&&(t.rotation=bI(t.camera.heading)),t}function sQe(t,e){const i=GJe;if(!e.length)return i;let r=Number.NEGATIVE_INFINITY;for(let s=0;s<e.length;s++){const n=e[s].screenSpaceBoundingRect;r=Math.max(r,Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2]),Math.abs(n[3]))}return i-r/Math.min(t.width,t.height)*2}const Ji=$(),ipe=be(),SI=Ai(),$3=lr(),nQe=pt(),TI=$(),CI=$(),YU=$(),XU={heading:0,tilt:0},wa=new je,oQe={point(t,e,i){i[0]=t.x,i[1]=t.y,t.hasZ&&(i[2]=t.z),e(i)},polygon(t,e,i){const r=t.hasZ;for(let s=0;s<t.rings.length;s++){const n=t.rings[s];for(let o=0;o<n.length;o++)i[0]=n[o][0],i[1]=n[o][1],r&&(i[2]=n[o][2]),e(i)}},polyline(t,e,i){const r=t.hasZ;for(let s=0;s<t.paths.length;s++){const n=t.paths[s];for(let o=0;o<n.length;o++)i[0]=n[o][0],i[1]=n[o][1],r&&(i[2]=n[o][2]),e(i)}},multipoint(t,e,i){const r=t.points,s=t.hasZ;for(let n=0;n<r.length;n++)i[0]=r[n][0],i[1]=r[n][1],s&&(i[2]=r[n][2]),e(i)},extent(t,e,i){t.hasZ?(e(ne(i,t.xmin,t.ymin,t.zmin)),e(ne(i,t.xmax,t.ymin,t.zmin)),e(ne(i,t.xmin,t.ymax,t.zmin)),e(ne(i,t.xmax,t.ymax,t.zmin)),e(ne(i,t.xmin,t.ymin,t.zmax)),e(ne(i,t.xmax,t.ymin,t.zmax)),e(ne(i,t.xmin,t.ymax,t.zmax)),e(ne(i,t.xmax,t.ymax,t.zmax))):(e(ne(i,t.xmin,t.ymin,i[2])),e(ne(i,t.xmax,t.ymin,i[2])),e(ne(i,t.xmin,t.ymax,i[2])),e(ne(i,t.xmax,t.ymax,i[2])))},mesh(t,e,i){const r=t.vertexAttributes&&t.vertexAttributes.position;if(r)for(let s=0;s<r.length;s+=3)e(ne(i,r[s+0],r[s+1],r[s+2]))}};class aQe{constructor(e,i,r){this.target=e,this.options=i,this.view=r,this.state="pending",this.abortController=null,this.animationController=null,this.promise=new Promise((s,n)=>{this.resolveCallback=s,this.rejectCallback=n;const o=new AbortController;_(this.options.signal)&&ps(this.options.signal,()=>{this.abort()}),this.abortController=o,this.waitForReady()})}then(e,i){return this.promise.then(e,i)}catch(e){return this.promise.catch(e)}resolve(e){return this.state="finished",this.resolveCallback(e)}reject(e){return this.state="finished",this.rejectCallback(e)}abort(e=!1){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject($t());break;case"wait-for-animation-finish":!e&&_(this.animationController)&&this.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject($t())}}waitForReady(){this.state="wait-for-ready",this.view.ready?this.createViewPoint():_x(this.view,"ready",this.abortController.signal).then(()=>{this.createViewPoint()},e=>{this.reject(e)})}createViewPoint(){this.state!=="finished"&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this.getAnimationController():null,WJe(this.view,this.target,this.abortController.signal).then(e=>{if(this.state==="finished")return;const i=this.getCameraFromViewpoint(e);if(!A(i))if(this.options.animate){if(A(this.animationController))return;this.startAnimation(i,this.animationController)}else this.view.stateManager.setStateCamera(i.camera,{applyConstraints:!i.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()},e=>{this.reject(e)}))}getCameraFromViewpoint(e){const i=!!(this.target instanceof ec&&this.target.camera||this.target instanceof yo),r=e.camera;if(A(r))return null;if(!this.view.stateManager.isCompatible(r)){const n=r.position,o=n&&n.spatialReference,a=o?o.wkid:"none",l=this.view.spatialReference.wkid;return this.reject(new Q("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${l})`,{camera:r})),null}const s=Od(this.view,r);return A(s)?(this.reject(new Q("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:s,isFullySpecified:i}}startAnimation(e,i){this.state="wait-for-animation-finish";const r=i.viewAnimation;if(A(r))return void this.reject(new Q("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(r.update(e.viewpoint,"running"),!i.active||A(i.viewAnimation)||i.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==i)return this.abort();let s;e.isFullySpecified?(s=new rw({view:this.view,desiredCamera:e.camera}),pb(this.view,e.camera,1)):Hi(this.view,e.camera),i.begin(e.camera,this.options);const n=()=>{const a=this.view.state.cameraController;s&&(a&&a.active?a instanceof Md&&_(a.viewAnimation)&&a.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=s):_(i.viewAnimation)&&i.viewAnimation.target===e.viewpoint&&i.state==="finished"&&(this.view.state.cameraController=s))},o=a=>{if(!A(this.view.state))switch(i.state){case Ti.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case Ti.Ready:case Ti.Rejected:case Ti.Running:case Ti.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(a)}}};r.when(n,a=>o(a)),i.asyncResult={resolve:()=>o(),reject:a=>o(a)}}getAnimationController(){let e,i=null;const r=this.view.state.cameraController;return r instanceof Md&&(r.updateStateFromViewAnimation(),r.active&&(e=r,i=e.viewAnimation)),e!=null||(e=new Md({view:this.view,mode:"animation"}),i=e.viewAnimation,this.view.state.switchCameraController(e))?e:(_(i)&&i.stop(),this.reject(new Q("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}const _l=le.getLogger("esri.views.3d.state.ViewStateManager");let nn=class extends ve{constructor(t){super(t),this.propertiesPool=new Um({frustum:zm},this),this.handles=new dt,this.cameraSetByUser=!1,this.gotoOperation=null,this.ready=!1,this.updateDevicePixelRatio=null,this.test={contentCameraResetState:new Map}}get camera(){const t=this._get("camera");if(!this.ready)return t;const e=xb(this.view,this.view.state.camera);return e&&t&&e.equals(t)?t:e}set camera(t){this.updatePropertyBeforeReady("camera",t)||(this.view.elevationProvider.enableElevationCache(!0),this.setStateCamera(Od(this.view,t),{applyConstraints:!1})||_l.error("#camera=","Invalid camera",t),this.view.elevationProvider.enableElevationCache(!1))}get contentCamera(){const t=this._get("contentCamera");if(!this.ready)return t;const e=xb(this.view,this.view.state.contentCamera);return e&&t&&e.equals(t)?t:e}set contentCamera(t){if(this.updatePropertyBeforeReady("contentCamera",t))return;const e=Od(this.view,t);A(e)?this.view.state.contentCamera=null:(this.updateElevation(e),this.view.state.contentCamera=e)}installContentCameraReset(t){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const e=this.zoom,i=this.view.state.camera.distance**2,r=Dn(this.view.state.camera.center),s=t.sticky?this.contentCamera.clone():null;return this.handles.add([this.watch("contentCamera",()=>{t.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear())}),this.watch("zoom",n=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(n-e)/2),Math.abs(n-e)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}),this.view.state.watch("camera",n=>{const o=cn(r,n.center);this.test.contentCameraResetState.set("camera.center",o/i),o>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)})],"contentCameraReset"),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(t){this.updatePropertyBeforeReady("center",t)||(t?this.isCompatible(t)?this.setStateCamera(this.centerToCamera(t),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():_l.error("#center=","Invalid center",t):_l.error("#center=","Center has an incompatible spatial reference (center: "+(t.spatialReference?t.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",t):_l.error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const t=this.view,e=cVe(t,t.state.camera,t.pointsOfInterest.centerOnContent.renderLocation);return _(e)?e:this._get("extent")}set extent(t){this.updatePropertyBeforeReady("extent",t)||(t?this.isCompatible(t)?this.setStateCamera(this.extentToCamera(t),{applyConstraints:!0})||_l.error("#extent=","Invalid extent",t):_l.error("#extent=","Extent has an incompatible spatial reference (extent: "+(t.spatialReference?t.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",t):_l.error("#extent=","Extent may not be null or undefined"))}get frustum(){const t=this.propertiesPool.get("frustum");return t.renderCoordsHelper=this.view.renderCoordsHelper,t.update(this.view.state.camera),t}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const t=this.view.pointsOfInterest.centerOnContent;return F0(this.view,t.distance,t.location.latitude)}return this._get("scale")}set scale(t){this.updatePropertyBeforeReady("scale",t)||this.setStateCamera(this.scaleToCamera(t),{applyConstraints:!0})||_l.error("#scale=","Invalid scale",t)}get padding(){if(!this.ready)return this._get("padding");const t=this.view.state.camera,e=t.padding,i=t.pixelRatio,r=this._get("padding"),s=Math.round(e[0]/i),n=Math.round(e[1]/i),o=Math.round(e[2]/i),a=Math.round(e[3]/i);return r!=null&&r.top===s&&r.right===n&&r.bottom===o&&r.left===a?r:{top:s,right:n,bottom:o,left:a}}set padding(t){this.updatePropertyBeforeReady("padding",t)||(this.paddingToArray(t,this.view.state.camera.pixelRatio,MI),this.view.state.updateCamera(e=>e.padding=MI))}paddingToArray(t,e,i){t?Ls(i,t.top||0,t.right||0,t.bottom||0,t.left||0):Ls(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*e)}get screenCenter(){const t=this.padding;return Zl((this.view.width-(t.left+t.right))/2+t.left,(this.view.height-(t.top+t.bottom))/2+t.top)}get viewpoint(){return this.ready?HJe(this.view,this.camera):this._get("viewpoint")}set viewpoint(t){if(!this.updatePropertyBeforeReady("viewpoint",t))if(t)if(this.isCompatible(t))this.setStateCamera(this.viewpointToCamera(t),{applyConstraints:!t.camera})||_l.error("#viewpoint=","Invalid viewpoint",t);else{const e=_(t.camera)?t.camera.position:t.targetGeometry,i=_(e)&&e.spatialReference;_l.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",t)}else _l.error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?Vae(this.view,this.scale):this._get("zoom")}set zoom(t){this.updatePropertyBeforeReady("zoom",t)||this.setStateCamera(this.zoomToCamera(t),{applyConstraints:!0})||_l.error("#zoom=","Invalid zoom",t)}initialize(){this.handles.add([ks(this.view,"state.events","before-camera-change",t=>this.updateElevation(t.camera))]),hbe(this.view.state,"camera",t=>this.updateElevation(t),!0),this.handles.add(gg({prepare:()=>this.prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",()=>{this.cameraSetByUser=!0,this.handles.remove(PI)})),this.handles.add(ks(this.view,"state.events","camera-projection-changed",()=>this.notifyChange("scale")))}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)}init(){this.constraintsManager=new BJe({view:this.view}),this.prepareFrame();const t=this.getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const e of t)this.set(e.name,e.value);if(!this.cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this.setInitialView(e):this.view.state.viewingMode===2&&this.handles.add(_x(this.view.basemapTerrain,"ready",()=>{this.handles.remove(PI),this.setInitialView(this.view.dataExtent)}),PI)}}deinit(){this.cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(PI),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))}async goTo(t,e){const i=E({animate:!0},e);return _(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new aQe(t,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(M0(this.view),{applyConstraints:!1})}step(t){const e=this.view.state,i=e&&this.view.state.cameraController;i&&(e.updateCamera(r=>{i.stepController(t,r)}),i.steppingFinished&&i.finishController())}cancelGoToOperation(){_(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)}getInitialProperties(){const t=new Set,e=[];for(const{propertyName:i,overrides:r}of uQe){const s=t.has(i),n=this._isOverridden(i);!s&&n&&e.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||n)&&r.forEach(o=>t.add(o))}return e}setInitialView(t){if(A(t)||this.cameraSetByUser)return;if(t instanceof yo)return void this.setStateCamera(Od(this.view,t),{applyConstraints:!1});if(t instanceof ec){if(t.targetGeometry instanceof ht){const s=CT(this.view,t.targetGeometry,0,.5,0);return void(_(s)&&this.setStateCamera(Od(this.view,s),{applyConstraints:!0}))}const i={applyConstraints:!t.camera},r=this.viewpointToCamera(t);return void this.setStateCamera(r,i)}const e=CT(this.view,t,0,.5,0);_(e)&&this.setStateCamera(Od(this.view,e),{applyConstraints:!0})}updatePropertyBeforeReady(t,e){return!this.ready&&(this._override(t,e),e&&cQe.indexOf(t)!==-1&&this._override("hasInitialView",!0),!0)}isCompatible(t){return!A(t)&&(t instanceof ec?t.camera?this.isCompatible(t.camera):this.isCompatible(t.targetGeometry):t instanceof yo?this.isCompatible(t.position):t.spatialReference&&Rh(t.spatialReference,this.view.spatialReference))}getPreservingHeadingTilt(t=hQe){return this.cameraSetByUser?(t.heading=this.camera.heading,t.tilt=this.camera.tilt):(t.heading=0,t.tilt=.5),t}centerPointAtDistanceToCamera(t,e,i=jm){const{heading:r,tilt:s}=this.getPreservingHeadingTilt(),n=TT(this.view,r,s,t,e,1);return A(n)?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}centerToCamera(t){const e=this.view.pointsOfInterest.centerOnContent;e.runTask();const i=e.distance;return this.centerPointAtDistanceToCamera(t,i)}extentToCamera(t){const{heading:e,tilt:i}=this.getPreservingHeadingTilt(),r=CT(this.view,t,e,i,1,dQe);return _(r)?Od(this.view,r):null}scaleToCamera(t){if(t==null)return null;const e=this.view.pointsOfInterest.centerOnContent;e.runTask();const i=e.renderLocation,r=e.location.latitude,s=ON(this.view,t,r);return this.centerPointAtDistanceToCamera(i,s)}zoomToCamera(t){return this.scaleToCamera(Nae(this.view,t))}viewpointToCamera(t){return Od(this.view,Kde(this.view,t))}setStateCamera(t,e){return!(A(t)||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,e.doNotCancelGoToOperation||this.cancelGoToOperation(),this.view.state.updateCamera(i=>{e.positionAndOrientationOnly?(i.eye=t.eye,i.center=t.center,i.up=t.up):i.copyFrom(t),e.applyConstraints&&Hi(this.view,i)}),e.applyConstraints||(this.view.state.cameraController=new rw({view:this.view,desiredCamera:t})),!0)}prepareFrame(){const{container:t,canvas:e}=this.view;if(!t||!e)return;_(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,r=Math.round(t.clientWidth*i),s=Math.round(t.clientHeight*i);if(r!==0&&s!==0&&(e.width===r&&e.height===s||(e.width=r,e.height=s),this.view.state)){const n=this.view.state.camera;n.fullWidth===r&&n.fullHeight===s&&n.pixelRatio===i||(jm.copyFrom(n),jm.pixelRatio!==i&&(this.paddingToArray(this.padding,i,MI),jm.padding=MI),jm.fullWidth=r,jm.fullHeight=s,jm.pixelRatio=i,this.view.state.camera=jm)}}updateElevation(t){const e=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(t.eye),r=e?KE(this.view,t.eye):0;t.relativeElevation=i-r}};u([d({type:yo,dependsOn:["view.state.camera","ready"]})],nn.prototype,"camera",null),u([d({type:yo,dependsOn:["view.state.contentCamera","ready"]})],nn.prototype,"contentCamera",null),u([d({type:je})],nn.prototype,"center",null),u([d({type:ht})],nn.prototype,"extent",null),u([d({readOnly:!0})],nn.prototype,"frustum",null),u([d({readOnly:!0})],nn.prototype,"hasInitialView",null),u([d({readOnly:!0,type:Boolean})],nn.prototype,"ready",void 0),u([d({type:Number})],nn.prototype,"scale",null),u([d()],nn.prototype,"padding",null),u([d({readOnly:!0})],nn.prototype,"screenCenter",null),u([d({constructOnly:!0})],nn.prototype,"view",void 0),u([d({type:ec})],nn.prototype,"viewpoint",null),u([d({type:Number})],nn.prototype,"zoom",null),u([d({constructOnly:!0})],nn.prototype,"updateDevicePixelRatio",void 0),nn=u([R("esri.views.3d.state.ViewStateManager")],nn);const lQe=nn,cQe=["camera","viewpoint","extent","scale","center","zoom"],uQe=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],hQe={heading:0,tilt:0},dQe=new yo,jm=new Zt,MI=Ot(),PI="pending-initial-view";class pQe{constructor(e,i,r){this.viewingMode=e,this._forEachLayer=i,this.view=r,this.externalIntersectionHandlers=new ct,this.tolerance=db,this.tmpRay=vs(),this.validateHUDIntersector=nl(this.viewingMode),this.validateHUDIntersector.options.hud=!1}intersectScreen(e,i){return this.intersectRay(this._getPickRay(e,this.tmpRay),rpe(this.viewingMode),i)}intersectScreenFreePointFallback(e,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this.tmpRay),i)}intersectRayFreePointFallback(e,i){return this.intersectRay(e,rpe(this.viewingMode),i)||this._intersectRayFreePointLocal(e,i)}intersectRay(e,i,r,s){return i.options.selectionMode=!1,i.options.store=0,this.computeIntersection(e,i,s),!!i.results.min&&i.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(e,i,r=.5,s=.5){return e.getRenderCenter(EI,r,s),EI[0]+=.0466,EI[1]-=.0123,pN(e,EI,i)}intersectIntersectorScreen(e,i,r){this.computeIntersection(this._getPickRay(e,this.tmpRay),i,r)}intersectToolIntersectorScreen(e,i,r){const s=this._getPickRay(e,this.tmpRay);this.intersectToolIntersectorRay(s,i,r)}intersectToolIntersectorRay(e,i,r){i.options.selectionMode=!0,this.computeIntersection(e,i,r);const s=i.results.min;!!this.view.basemapTerrain&&this.view.basemapTerrain.opaque||Bu(s)&&s.intersector!==2||(i.options.selectionMode=!1,this.computeIntersection(e,i,r))}setTolerance(e=db){this.tolerance=e}addIntersectionHandler(e){this.externalIntersectionHandlers.push(e),this.externalIntersectionHandlers.sort((i,r)=>i.type===2?1:r.type===2?-1:0)}removeIntersectionHandler(e){this.externalIntersectionHandlers.removeUnordered(e),this.externalIntersectionHandlers.sort((i,r)=>i.type===2?1:r.type===2?-1:0)}_getPickRay(e,i){const r=this.view.state.camera;return Qoe(r,e,i)}_intersectRayFreePointLocal(e,i){if(this.viewingMode!==2||A(e))return!1;const r=this.view.renderDataExtent;if(A(r))return de(i,e.origin,_e(Me.get(),e.direction)),!0;const s={x:r.xmax-r.xmin,y:r.ymax-r.ymin,z:8*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},n=Math.max(s.x,s.y,s.z);if(n===0)return de(i,e.origin,_e(Me.get(),e.direction)),!0;const o=this.view.state.camera,a=Math.max(0,r.xmin-o.eye[0],o.eye[0]-r.xmax),l=Math.max(0,r.ymin-o.eye[1],o.eye[1]-r.ymax),c=Math.sqrt(a*a+l*l),h=Math.abs(o.relativeElevation)+Number.MIN_VALUE,p=Math.max(0,Math.log(n/h))**2;let f=n/Math.max(1,p);f=Math.max(f,Math.min(c,n));const g=se(Me.get(),e.direction,f/Te(e.direction));return de(i,e.origin,g),!0}intersectElevationFromScreen(e,i,r=0,s=null){return this.intersectElevation(this._getPickRay(e,this.tmpRay),i,r,s)}intersectElevation(e,i,r=0,s=null){if(A(e))return null;const n=_(i)?i.mode:"absolute-height",o=_(i)?st(i.offset,0):0,a=n!=="on-the-ground"?o+r:0,l=a/this.view.renderCoordsHelper.unitInMeters;if(n==="absolute-height"){if(this.view.renderCoordsHelper.intersectInfiniteManifold(e,a,$I)){const S=this.view.computeMapPointFromVec3d($I);return S.z-=o,S}return null}const c=this.view.state.camera,h=Bh(Me.get());c.projectToRenderScreen(e.origin,h);const p=new spe(null,this._forEachLayer),f=this.view.slicePlane,g=_(f)?_oe(f):null,y=nl(this.viewingMode);y.options.store=0,y.options.verticalOffset=l;const v=e.origin,b=de(Me.get(),v,e.direction);y.reset(v,b,c),y.point=h;const w=_(s)?"type"in s&&s.type==="graphics"?S=>S.metadata.layerUid!==s.uid:S=>S.metadata.graphicUid!==s.uid:null;switch(n){case"relative-to-scene":{const S=T=>(A(w)||w(T))&&T.metadata&&T.metadata.isElevationSource;y.intersect(p.layers,h,this.tolerance,null,S),this.externalIntersectionHandlers.forAll(T=>{if(T.type===4||T.type===2){const C=T.slicePlaneEnabled?g:null;T.intersect(y,C,y.rayBegin,y.rayEnd,h)}})}break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll(S=>{if(S.isGround){const T=S.slicePlaneEnabled?g:null;S.intersect(y,T,y.rayBegin,y.rayEnd,h)}})}if(y.results.min.getIntersectionPoint($I)){const S=this.view.computeMapPointFromVec3d($I);return S.z=r,S}return null}computeIntersection(e,i,r){if(A(e))return;const s=this.view.state.camera,n=Bh(Me.get());s.projectToRenderScreen(e.origin,n);const o=new spe(r,this._forEachLayer);i.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);const a=e.origin,l=de(Me.get(),e.origin,e.direction);i.reset(a,l,s),i.intersect(o.layers,n,this.tolerance);const c=this.view.slicePlane,h=_(c)?_oe(c):null;i.intersect(o.sliceableLayers,n,this.tolerance,h);const p=r&&(r.requiresGroundFeedback||r.enableDraped);this.externalIntersectionHandlers.forAll(y=>{if(i.options.isFiltered=!o.filterLayerUid(y.layerUid),y.isGround&&p||!i.options.isFiltered){const v=y.slicePlaneEnabled?h:null;y.intersect(i,v,a,l,n)}});const f=Me.get();if(r&&r.enableDraped&&i.results.ground.getIntersectionPoint(f)){const y=this.view.basemapTerrain.overlayManager.renderer,v=this.view.renderCoordsHelper.spatialReference,b=Me.get();this.view.renderCoordsHelper.fromRenderCoords(f,b,this.view.spatialReference),b[2]=st(this.view.elevationProvider.getElevation(f[0],f[1],f[2],v,"ground"),0),y.intersect(i,b,i.results.ground,w=>o.filterRenderGeometry(w))}i.sortResults();const g=i.results.hud;if(HV(g)){const y=Bh(Me.get()),v=Me.get(),b=Me.get();this.unprojectHUDResultRay(g.target.center,y,v,b);const w=qt(g.target.center,v)/qt(v,b)*.99;this.validateHUDIntersector.reset(v,b,s),this.validateHUDIntersector.intersect(o.layers,y,this.tolerance),this.validateHUDIntersector.intersect(o.sliceableLayers,y,this.tolerance,h),this.externalIntersectionHandlers.forAll(T=>{if(!o.filterLayerUid(T.layerUid))return;const C=T.slicePlaneEnabled?h:null;T.intersect(this.validateHUDIntersector,C,v,b,y)});const S=this.validateHUDIntersector.results.min;(S.dist==null||w<=S.dist)&&(i.results.min.copy(g),i.results.all.splice(0,0,g))}}unprojectHUDResultRay(e,i,r,s){const n=this.view.state.camera;n.projectToRenderScreen(e,i);const o=Bh(Me.get());o[0]=i[0],o[1]=i[1],o[2]=0,n.unprojectFromRenderScreen(o,r),o[2]=1,n.unprojectFromRenderScreen(o,s)}}let AI;function rpe(t){return AI&&AI.viewingMode===t||(AI=nl(t)),AI}class spe{constructor(e,i){this.layers=new Array,this.sliceableLayers=new Array,this.include=e==null?void 0:e.include,this.exclude=e==null?void 0:e.exclude,i(r=>{r.isPickable&&this.filterLayerUid(r.apiLayerUid)&&(r.isSliceable?this.sliceableLayers:this.layers).push(r)})}filterLayerUid(e){const{include:i,exclude:r}=this;return A(e)?i==null&&r==null:(i==null||i.has(e))&&(r==null||!r.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}}function npe(t){return typeof t=="object"&&"intersect"in t}const $I=$(),EI=ys();class Wat{constructor(e,i){this.spatialReference=e,this.view=i}getElevation(e,i,r){return this.view.elevationProvider.getElevation(e,i,0,this.spatialReference,r)}async queryElevation(e,i,r,s,n){return this.view.elevationProvider.queryElevation(e,i,0,this.spatialReference,n,r,s)}}class fQe{constructor(e,i,r,s){this.spatialReference=i,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions=he(E({},s),{ignoreInvisibleLayers:!0}),this._frameTask=e.registerTask(Qe.ELEVATION_QUERY,this)}destroy(){this._frameTask.remove()}queryElevation(e,i,r,s=0){return new Promise((n,o)=>{const a={x:e,y:i,minDemResolution:s,result:{resolve:n,reject:o},signal:r};this._queries.push(a),ps(r,()=>{sD(this._queries,a),o($t())})})}get running(){return this._queries.length>0}runTask(){const e=this._queries;this._queries=[];const i=this._getElevationQueryProvider();if(!i)return void e.forEach(c=>c.result.reject());const r=e.map(c=>[c.x,c.y]),s=e.reduce((c,h)=>Math.min(c,h.minDemResolution),1/0),n=new $g({points:r,spatialReference:this.spatialReference}),o=e.length>1&&e.some(c=>!!c.signal)?new AbortController:null,a=_(o)?o.signal:e[0].signal;if(_(o)){let c=0;e.forEach(h=>ps(h.signal,()=>{c++,h.result.reject($t()),c===e.length&&o.abort()}))}const l=he(E({},this._queryOptions),{minDemResolution:s,signal:a});i.queryElevation(n,l).then(c=>{e.forEach((h,p)=>{_(h.signal)&&h.signal.aborted?h.result.reject($t()):h.result.resolve(c.geometry.points[p][2])})}).catch(c=>{e.forEach(h=>h.result.reject(c))})}get test(){const e=this;return{update:()=>e._queries.length>0&&e.runTask()}}}let E3=class extends Ci.EventedMixin(ve){constructor(t){super(t),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQuery=tt(this._elevationQuery)}get elevationQuery(){return A(this._elevationQuery)&&(this._elevationQuery=new fQe(this.view.resourceController.scheduler,this.view.spatialReference,()=>this.view.map&&this.view.map.ground,{maximumAutoTileRequests:4})),this._elevationQuery}enableElevationCache(t){t||(this.lastElevationQuery=null),this.elevationCacheEnabled=t}getElevation(t,e,i,r,s){if(this.elevationCacheEnabled&&this.lastElevationQuery!=null){const o=this.lastElevationQuery;if(t===o.x&&e===o.y&&i===o.z&&r.equals(o.spatialReference)&&s===o.queryContext)return o.result}let n=null;return n=OI(n,this.im,t,e,i,r,s),A(n)&&(n=OI(n,this.ground,t,e,i,r,s)),s==="scene"&&(n=OI(n,this.scene,t,e,i,r,s)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:t,y:e,z:i,spatialReference:r,queryContext:s,result:n}),n}queryElevation(t,e,i,r,s,n=null,o=0){const a=Th();return this.elevationQuery.queryElevation(t,e,n,o).then(l=>{s==="scene"&&(l=OI(l,this.scene,t,e,i,r,s)),a.resolve(l)}).catch(l=>{bi(l)?a.reject(l):a.resolve(this.getElevation(t,e,i,r,s))}),a.promise}register(t,e){this.handles.set(e,e.on("elevation-change",i=>this.emit("elevation-change",i))),this[t].push(e)}unregister(t){this.handles.has(t)&&(this.handles.get(t).remove(),this.handles.delete(t));for(const e of[this.im,this.ground,this.scene]){const i=e.indexOf(t);i>-1&&e.splice(i,1)}}};function OI(t,e,i,r,s,n,o){for(const a of e){const l=a.getElevation(i,r,s,n,o);_(l)&&(t=_(t)?Math.max(l,t):l)}return t}u([d({constructOnly:!0})],E3.prototype,"view",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],E3.prototype,"spatialReference",void 0),E3=u([R("esri.views.3d.support.CombinedElevationProvider")],E3);class Bm{static isValidProfile(e){return e in Bm.profiles}static getDefaultProfile(){return ae("trident")||ae("esri-iPhone")?"low":"medium"}static apply(e,i){const r=Bm.profiles[e];i.graphics3D.maxTotalNumberOfFeatures=r.graphics3D.maxTotalNumberOfFeatures,i.graphics3D.maxTotalNumberOfPrimitives=r.graphics3D.maxTotalNumberOfPrimitives,i.graphics3D.polygonLodFactor=r.graphics3D.polygonLodFactor,i.graphics3D.polylineLodFactor=r.graphics3D.polylineLodFactor,i.graphics3D.snapshotAvailable=r.graphics3D.snapshotAvailable;{const s=i.sceneService["3dObject"],n=r.sceneService["3dObject"];s.lodFactor=n.lodFactor,s.lodCrossfadeinDuration=n.lodCrossfadeinDuration,s.lodCrossfadeoutDuration=n.lodCrossfadeoutDuration,s.lodCrossfadeUncoveredDuration=n.lodCrossfadeUncoveredDuration}i.sceneService.point.lodFactor=r.sceneService.point.lodFactor,i.sceneService.integratedMesh.lodFactor=r.sceneService.integratedMesh.lodFactor,i.sceneService.pointCloud.lodFactor=r.sceneService.pointCloud.lodFactor,i.sceneService.uncompressedTextureDownsamplingEnabled=r.sceneService.uncompressedTextureDownsamplingEnabled,i.tiledSurface.lodBias=r.tiledSurface.lodBias,i.tiledSurface.angledSplitBias=r.tiledSurface.angledSplitBias,i.tiledSurface.reduceTileLevelDifferences=r.tiledSurface.reduceTileLevelDifferences,i.tiledSurface.textureFadeDuration=r.tiledSurface.textureFadeDuration,i.antialiasingEnabled=r.antialiasingEnabled,i.physicallyBasedRenderingEnabled=r.physicalBasedRenderingEnabled,i.highQualityTransparency=r.highQualityTransparency,i.memoryLimit=r.memoryLimit,i.additionalCacheMemory=r.additionalCacheMemory,i.frameRate=r.frameRate,i.maximumRenderResolution=r.maximumRenderResolution,i.maximumPixelRatio=r.maximumPixelRatio}}function ope(){const t=!!ae("esri-mobile"),e=!!ae("ios");return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:t?.8:1,polylineLodFactor:t?1.2:1.5,snapshotAvailable:!e},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:t},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!ae("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:t?600:750,additionalCacheMemory:t?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:t?1.2:2,polylineLodFactor:t?1.2:2,snapshotAvailable:!e},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!ae("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:t?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:t?null:4096,maximumPixelRatio:t?1:null}}}Bm.debug={reset(){const t=ope();for(const e in t)Bm.profiles[e]=t[e]}},function(t){t.profiles=ope()}(Bm||(Bm={}));const RI=Bm;function KU(){return new Float32Array(4)}function mQe(t){const e=new Float32Array(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function io(t,e,i,r){const s=new Float32Array(4);return s[0]=t,s[1]=e,s[2]=i,s[3]=r,s}function gQe(t,e){return new Float32Array(t,e,4)}function ape(){return KU()}function lpe(){return io(1,1,1,1)}function cpe(){return io(1,0,0,0)}function upe(){return io(0,1,0,0)}function hpe(){return io(0,0,1,0)}function dpe(){return io(0,0,0,1)}const yQe=ape(),vQe=lpe(),_Qe=cpe(),bQe=upe(),wQe=hpe(),xQe=dpe();Object.freeze({__proto__:null,create:KU,clone:mQe,fromValues:io,createView:gQe,zeros:ape,ones:lpe,unitX:cpe,unitY:upe,unitZ:hpe,unitW:dpe,ZEROS:yQe,ONES:vQe,UNIT_X:_Qe,UNIT_Y:bQe,UNIT_Z:wQe,UNIT_W:xQe});let lh=class extends ve{constructor(){super(...arguments),this.color=new Ae([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=new Ae([0,0,0]),this.shadowDifference=.2}static toEngineOptions(t){const e=Ae.toUnitRGBA(t.color),i=_(t.haloColor)?Ae.toUnitRGBA(t.haloColor):e,r=Ae.toUnitRGBA(t.shadowColor);return{color:io(e[0],e[1],e[2],e[3]),haloColor:io(i[0],i[1],i[2],i[3]),haloOpacity:t.haloOpacity,haloOpacityOccluded:.25*t.haloOpacity,fillOpacity:t.fillOpacity,fillOpacityOccluded:.25*t.fillOpacity,shadowOpacity:t.shadowOpacity,shadowColor:io(r[0],r[1],r[2],r[3]),occludedShadowOpacity:t.shadowOpacity*(1-t.shadowDifference)}}};u([d({type:Ae})],lh.prototype,"color",void 0),u([d({type:Ae})],lh.prototype,"haloColor",void 0),u([d()],lh.prototype,"haloOpacity",void 0),u([d()],lh.prototype,"fillOpacity",void 0),u([d()],lh.prototype,"shadowOpacity",void 0),u([d({type:Ae})],lh.prototype,"shadowColor",void 0),u([d()],lh.prototype,"shadowDifference",void 0),lh=u([R("esri.views.3d.support.HighlightOptions")],lh);const ej=lh;function Zat(t){return{geometryType:kp(t[0]),geometries:t.map(e=>e.toJSON())}}function SQe(t,e,i){const r=rW(e);return t.map(s=>{const n=r.fromJSON(s);return n.spatialReference=i,n})}let bv=class extends ge{constructor(t){super(t),this.geometries=null,this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const t=this.geometries.map(function(r){return r.toJSON()}),e=this.geometries[0],i={};return i.outSR=this.outSpatialReference.wkid||JSON.stringify(this.outSpatialReference.toJSON()),i.inSR=e.spatialReference.wkid||JSON.stringify(e.spatialReference.toJSON()),i.geometries=JSON.stringify({geometryType:kp(e),geometries:t}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),this.transformForward!=null&&(i.transformForward=this.transformForward),i}};u([d()],bv.prototype,"geometries",void 0),u([d({json:{read:{source:"outSR"}}})],bv.prototype,"outSpatialReference",void 0),u([d()],bv.prototype,"transformation",void 0),u([d()],bv.prototype,"transformForward",void 0),bv=u([R("esri.rest.support.ProjectParameters")],bv);const tj=bv,TQe=Ni(tj);async function ppe(t,e,i){e=TQe(e);const r=ss(t),s=E(he(E({},r.query),{f:"json"}),e.toJSON()),n=e.outSpatialReference,o=kp(e.geometries[0]),a=PPe(s,i);return vt(r.path+"/project",a).then(({data:{geometries:l}})=>SQe(l,o,n))}async function ij(t=null,e){var i,r;if(ei.geometryServiceUrl)return ei.geometryServiceUrl;if(!t)throw new Q("internal:geometry-service-url-not-configured");let s;s="portal"in t?t.portal||po.getDefault():t,await s.load({signal:e});const n=(i=s.helperServices)==null||(r=i.geometry)==null?void 0:r.url;if(!n)throw new Q("internal:geometry-service-url-not-configured");return n}async function CQe(t,e,i=null,r){const s=await ij(i,r),n=new tj;n.geometries=[t],n.outSpatialReference=e;const o=await ppe(s,n,{signal:r});if(o&&Array.isArray(o)&&o.length===1)return o[0];throw new Q("internal:geometry-service-projection-failed")}var MQe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",getGeometryServiceURL:ij,projectGeometry:CQe});class PQe{constructor(e,i){this.spatialReference=i,this.unitInMeters=bo(this.spatialReference,Ut(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=ij(e&&e.get("portalItem")).catch(()=>{throw new Q("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")})}async toGeographic(e){const i=await this._geometryServiceURLPromise;let r,s=!0;Array.isArray(e[0])&&typeof e[0]!="number"?r=e:(r=[e],s=!1);const n=r.map(l=>l instanceof je?l:new je(l,this.spatialReference)),o=new tj({geometries:n,outSpatialReference:Ue.WGS84}),a=(await ppe(i,o)).map(l=>l.type==="point"?[l.x,l.y]:void 0);return s?a:a[0]}}let ch=class extends ve{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1}};u([d()],ch.prototype,"minTotalNumberOfFeatures",void 0),u([d()],ch.prototype,"maxTotalNumberOfFeatures",void 0),u([d()],ch.prototype,"maxTotalNumberOfPrimitives",void 0),u([d()],ch.prototype,"snapshotAvailable",void 0),u([d()],ch.prototype,"polygonLodFactor",void 0),u([d()],ch.prototype,"polylineLodFactor",void 0),ch=u([R("esri.views.3d.support.QualitySettings.Graphics3DSettings")],ch);let uh=class extends ve{constructor(){super(...arguments),this.lodFactor=1}};u([d()],uh.prototype,"lodFactor",void 0),uh=u([R("esri.views.3d.support.QualitySettings.LoDFactorSettings")],uh);let II=class extends uh{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};II=u([R("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],II);let Xd=class extends ve{constructor(){super(...arguments),this["3dObject"]=new II,this.point=new uh,this.integratedMesh=new uh,this.pointCloud=new uh,this.uncompressedTextureDownsamplingEnabled=!1}};u([d({type:II})],Xd.prototype,"3dObject",void 0),u([d({type:uh})],Xd.prototype,"point",void 0),u([d({type:uh})],Xd.prototype,"integratedMesh",void 0),u([d({type:uh})],Xd.prototype,"pointCloud",void 0),u([d()],Xd.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Xd=u([R("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Xd);let Gm=class extends ve{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500}};u([d()],Gm.prototype,"lodBias",void 0),u([d()],Gm.prototype,"angledSplitBias",void 0),u([d()],Gm.prototype,"reduceTileLevelDifferences",void 0),u([d()],Gm.prototype,"textureFadeDuration",void 0),Gm=u([R("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Gm);let ko=class extends ve{constructor(){super(...arguments),this.graphics3D=new ch,this.sceneService=new Xd,this.tiledSurface=new Gm,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0}};u([d({type:ch})],ko.prototype,"graphics3D",void 0),u([d({type:Xd})],ko.prototype,"sceneService",void 0),u([d({type:Gm})],ko.prototype,"tiledSurface",void 0),u([d()],ko.prototype,"antialiasingEnabled",void 0),u([d()],ko.prototype,"physicallyBasedRenderingEnabled",void 0),u([d()],ko.prototype,"highQualityTransparency",void 0),u([d()],ko.prototype,"memoryLimit",void 0),u([d()],ko.prototype,"additionalCacheMemory",void 0),u([d()],ko.prototype,"frameRate",void 0),u([d()],ko.prototype,"maximumRenderResolution",void 0),u([d()],ko.prototype,"maximumPixelRatio",void 0),ko=u([R("esri.views.3d.support.QualitySettings.QualitySettings")],ko);const fpe=ko;class DI{constructor(e,i,r,s){this.viewingMode=e,this.spatialReference=i,this.unitInMeters=r,this.coordinateSystem=s,this._coordinateSystem=OTe(s)}set extent(e){e&&RTe(this.coordinateSystem,e,this.coordinateSystem)}getAltitude(e){return NTe(this.coordinateSystem,e)}setAltitude(e,i,r=e){return $Q(this.coordinateSystem,r,i,e)}setAltitudeOfTransformation(e,i){UTe(this.coordinateSystem,i,e,i)}worldUpAtPosition(e,i){return LTe(this.coordinateSystem,e,i)}worldBasisAtPosition(e,i,r){return kTe(this.coordinateSystem,e,i,r)}basisMatrixAtPosition(e,i){const r=this.worldBasisAtPosition(e,0,Me.get()),s=this.worldBasisAtPosition(e,1,Me.get()),n=this.worldBasisAtPosition(e,2,Me.get());return _u(i,r[0],r[1],r[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1),i}intersectManifoldClosestSilhouette(e,i,r){return G6(this.coordinateSystem,i,this._coordinateSystem),VTe(this._coordinateSystem,e,r),r}intersectManifold(e,i,r){G6(this.coordinateSystem,i,this._coordinateSystem);const s=Me.get();return zTe(this._coordinateSystem,e,s)?re(r,s):null}intersectInfiniteManifold(e,i,r){if(this.viewingMode===1)return this.intersectManifold(e,i,r);G6(this.coordinateSystem,i,this._coordinateSystem);const s=this._coordinateSystem.value,n=Me.get();return vy(s.plane,e,n)?re(r,n):null}toRenderCoords(e,i,r){return lE(e)?Gr(e,i,this.spatialReference):Ns(e,i,r,this.spatialReference)}fromRenderCoords(e,i,r=null){return lE(i)?(_(r)&&(i.spatialReference=r),bJ(e,this.spatialReference,i)):i instanceof Ue?nf(e,this.spatialReference,i):Ns(e,this.spatialReference,i,r)?i:null}static create(e,i){switch(e){case 2:return new DI(2,i,bo(i),FTe());case 1:return new DI(1,i,1,DTe(i))}}static renderUnitScaleFactor(e,i){return mpe(e)/mpe(i)}}function mpe(t){if(TO(t,1))return 1;const e=OQ(!1,t);return bo(e)}const AQe=(()=>{const t=new Array;return t[0]=10,t[1]=10,t[2]=10,t[3]=10,t[4]=5,t})(),$Qe=30;function gpe(t){return typeof t.getUsedMemory=="function"}const EQe=le.getLogger("esri.views.3d.support.MemoryController");function OQe(t){return new DQe(t)}const FI=1,rj=1,RQe=.75,IQe=.6,ype=1.3;class DQe{constructor(e){this._view=e,this.events=new Ci,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new u8,this._numQualityChanges=0,this._updating=!1}destroy(){this.events=null,this._cacheStorage.destroy()}newCache(e,i){return new NRe(e,this._cacheStorage,i)}set maxMemory(e){e!=null&&e>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(FI),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){e!=null&&e>=0&&(this._additionalCacheMemory=e)}disableMemCache(){this._additionalCacheMemory=-4096}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<IQe&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(FI);else if(e)(this._memoryPredicted>1.1*rj||this._memoryUsed>rj)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/ype),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>rj)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/ype),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<RQe&&this._quality<FI){this._stableQuality=this._quality;const i=.05;e=this._updateQuality(this._quality+i)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==e&&(this._updating=e,this.events.emit("updating-changed",this.updating))}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),FI))!==this._quality&&(this._quality=e,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){let e=0,i=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(e+=this._view.basemapTerrain.getUsedMemory());const r=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;_(r)&&(e+=r.usedMemory),this._view.allLayerViews&&this._view.allLayerViews.forEach(a=>{if(gpe(a)){const l=a.ignoresMemoryFactor()?this._quality:1;e+=a.getUsedMemory()*l,i+=a.getUnloadedMemory()*l}});const s=this._warnMemoryUsage==null||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),n=1048576*this._maxMemory;if(e>n&&s){this._warnMemoryUsage=e;const a=c=>(c/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",l=Math.round(100*this._quality);EQe.warn(`Memory Limit exceeded! Limit: ${a(n)} Current: ${a(e)} Projected: ${a(e+i)} Quality: ${l}%`)}this._memoryUsed=e/n,this._memoryPredicted=(e+i)/n;const o=n-e;this._cacheStorage.maxSize=Math.max(0,o+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const i=e._numQualityChanges;return e._numQualityChanges=0,i}}}}class FQe{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}class LQe{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new kQe}}class kQe{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class zQe{constructor(e,i,r,s){this._workerFunc=e,this._callbackFunc=i,this._maxTotalNumWorkers=r,this._totalNumWorkers=0,this._clients=s.map(n=>new LQe(n))}hasQuota(e){const i=this._clients[e];return!!i&&(this._totalNumWorkers<this._maxTotalNumWorkers||i.numWorkers+i.tasks.length<i.typeWorkerQuota)}push(e){const i=this._clients[e.client];i&&(this._totalNumWorkers<this._maxTotalNumWorkers?(i.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(r,s)=>this._taskCallback(r,s))):i.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}destroy(){this._clients.length=0}_taskFinished(e){const i=this._clients[e.client];this._totalNumWorkers--,i.numWorkers--,i.statistics.requests++,i.statistics.size+=e.size||0,i.statistics.duration+=e.duration||0,i.statistics.speed=i.statistics.duration>0?i.statistics.size/i.statistics.duration:0,Ze(i.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(i,r)=>this._taskCallback(i,r)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,i){e._cancelled||(this._callbackFunc(e,i),this._taskFinished(e))}getStatsForType(e){const i=this._clients[e];return i?{quota:i.typeWorkerQuota,workers:i.numWorkers,queueSize:i.tasks.length,requestStats:i.statistics}:null}get test(){const e=this;return{set workerFunc(i){e._workerFunc=i}}}}class VQe extends FQe{constructor(e,i,r,s,n){super(s),this.url=e,this.options=i,this.docType=r,this.key=n,this.result=null,this.status=1,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0}}let LI=class extends ve{constructor(){super(...arguments),this.tasks=new Map,this.onLoadQueue=new Array,this.doneQueue=new Array,this.updating=!1}setup(t,e,i){this.loadQueue=new zQe((r,s)=>this.startLoading(r,s),(r,s)=>this.doneLoadingCallback(r,s),t,e),i&&(this.taskHandle=i.registerTask(Qe.STREAM_DATA_LOADER,this))}destroy(){this.taskHandle=ln(this.taskHandle),this.tasks.forEach(t=>{t.abortController&&t.abortController.abort()}),this.loadQueue.destroy(),this.loadQueue=null,this.onLoadQueue=null,this.doneQueue=null,this.tasks=null}hasDownloadSlots(t){return this.loadQueue.hasQuota(t)}request(t,e,i,r={}){const s=Th();s.__signal=_(r)?r.signal:null;const n=this.createOrUpdateTask(t,e,i,r,s);return ps(r,()=>this.cancelRequest(n,s)),s.promise}createTask(t,e,i,r,s,n){const o=new VQe(t,e,i,r,s);return this.updateTask(o,n),this.tasks.set(s,o),this.tasks.size===1&&this._set("updating",!0),this.loadQueue.push(o),o}cancelRequest(t,e){PC(t.resolvers,e),e.reject($t()),t.resolvers.length===0&&(t.status===2&&(t.status=4,this.loadQueue.cancel(t),t.abortController.abort(),t.request=null,t.abortController=null),t.status=4,this.tasks.delete(t.key),this.tasks.size===0&&this._set("updating",!1))}taskKey(t,e,i){return`${t}:${e}:${i}`}updateTask(t,e){t.resolvers.push(e)}createOrUpdateTask(t,e,i,r,s){const n=_(r)&&r.uid||t,o=this.taskKey(n,e,i),a=this.tasks.get(o);return a?(this.updateTask(a,s),a):this.createTask(t,r,e,i,o,s)}doneLoadingCallback(t,e){this.loadQueue&&(Ze(t.status===2),t.status=3,this.taskHandle?this.doneQueue.push({task:t,err:e}):this.doneLoading(t,e))}get running(){return this.doneQueue.length>0||this.onLoadQueue.length>0}runTask(t){for(;!t.done&&this.onLoadQueue.length>0;){const e=this.onLoadQueue.shift();Dt(e.task.abortController),e.task.abortController=null,e.callback(e.task),t.madeProgress()}for(;!t.done&&this.doneQueue.length>0;){const e=this.doneQueue.shift();e.task.status!==3&&(e.err=e.err||$t()),this.doneLoading(e.task,e.err),t.madeProgress()}}doneLoading(t,e){let i=t.result instanceof HTMLImageElement?0:t.resolvers.length;for(const r of t.resolvers)if(e)bi(e)?r.reject(e):r.reject(new Q("stream-data-loader:request-error",`Failed to request resource at '${t.url}'. ${e}`,{url:t.url,error:e}));else{--i;const s=i<=0?t.result:ie(t.result);r.resolve(s)}this.tasks.delete(t.key),this.tasks.size===0&&this._set("updating",!1)}startLoading(t,e){if(t.status===4)return!1;let i,r;switch(t.startTime=performance.now(),t.status=2,t.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}t.abortController=new AbortController;const s=t.abortController.signal;t.request=vt(t.url,he(E({},t.options),{responseType:r,timeout:i,signal:s}));let n=()=>{};const o=l=>{t.duration=performance.now()-t.startTime,t.size=l instanceof ArrayBuffer?l.byteLength:t.size||0,t.result=l,this.taskHandle?this.onLoadQueue.push({callback:e,task:t}):(t.abortController=null,e(t))},a=l=>{t.status===2&&e(t,l),n()};return t.docType!=="image+type"?(t.request.then(l=>o(l.data),a),!0):(t.request.then(l=>{const c=l.data,h=NQe(c);if(r="image",t.size=c.byteLength,h==="unknown")return t.request=vt(t.url,{responseType:r,timeout:i,signal:s}),void t.request.then(g=>o(g.data),a);const p=new Blob([c],{type:h}),f=window.URL.createObjectURL(p);n=()=>window.URL.revokeObjectURL(f),t.request=vt(f,{responseType:r,timeout:i,signal:s}),t.request.then(g=>o(new O3(g.data,h,n)),a)},a),!0)}get test(){return{loadQueue:this.loadQueue}}};function NQe(t){if(t.byteLength<2)return"unknown";const e=new Uint8Array(t,0,t.byteLength);return e[0]===137&&e[1]===80?"image/png":e[0]===71&&e[1]===73?"image/gif":e[0]===66&&e[1]===77?"image/bmp":e[0]===255&&e[1]===216?"image/jpeg":"unknown"}u([d({readOnly:!0})],LI.prototype,"updating",void 0),LI=u([R("esri.views.3d.support.StreamDataLoader")],LI);class O3{constructor(e,i,r){this.image=e,this.type=i,this.release=r}get isOpaque(){return this.type==="image/jpeg"}}const UQe=LI;let kI=class extends ve{constructor(){super(...arguments),this.updating=!1}};function jQe(t,e=()=>performance.now()){return new sj.ResourceController({view:t,now:e})}var sj;u([d({readOnly:!0})],kI.prototype,"updating",void 0),kI=u([R("esri.views.3d.support.ResourceController")],kI),function(t){let e=class extends kI{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new dt,this._frameTask=null,this._scheduleTask=N_,this._state=2}initialize(){this._cameraChangeTime=this.now(),this._scheduler=a5e(this.now),this._memoryController=OQe(this.view),this._streamDataLoader=new UQe,this._streamDataLoader.setup($Qe,AQe,this._scheduler),this._handles.add([this.view.watch("state.camera",(r,s)=>this._cameraChangedHandler(r,s),!0),this.view.watch("stationary",()=>this._stationaryChangedHandler()),this._memoryController.events.on("updating-changed",()=>this.notifyChange("updating"))]),this._frameTask=gg({update:r=>this.frame(r)}),this._scheduleTask=this._scheduler.registerTask(Qe.RESOURCE_CONTROLLER)}destroy(){this._handles=tt(this._handles),this._scheduleTask.remove(),this._frameTask=ln(this._frameTask),this._streamDataLoader=tt(this._streamDataLoader),this._memoryController=tt(this._memoryController),this._scheduler=tt(this._scheduler)}get updating(){var r,s;return!!((r=this._memoryController)!=null&&r.updating||(s=this._streamDataLoader)!=null&&s.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(r,s,n){return this._scheduleTask.schedule(r,s,n)}createStreamDataRequester(r){const s=this._streamDataLoader;return{request:(n,o,a)=>s.request(n,o,r,a),get busy(){return!s.hasDownloadSlots(r)}}}frame(r){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(c0e(r.deltaTime)),!this._scheduler)||(this._updateState(),this._scheduler.state=this._state,this._scheduler.updateBudget(r)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(r,s){r&&s&&r.almostEquals(s)||(this._cameraChangeTime=this._scheduler.now,this._updateState(),this._scheduler.state=this._state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}_updateState(){this.view.animation?this._state=0:this.view.interacting?this._state=1:(this._state===0&&(this._cameraChangeTime=0),this._scheduler.now-this._cameraChangeTime<=i?this._state=1:this._state=2)}get test(){return{getQueueStats:r=>this._streamDataLoader.test.loadQueue.getStatsForType(r),state:this._state}}};u([d({constructOnly:!0})],e.prototype,"view",void 0),u([d({constructOnly:!0})],e.prototype,"now",void 0),u([d()],e.prototype,"_scheduler",void 0),u([d()],e.prototype,"_memoryController",void 0),u([d()],e.prototype,"_streamDataLoader",void 0),u([d({readOnly:!0})],e.prototype,"updating",null),e=u([R("esri.views.3d.support.ResourceController")],e),t.ResourceController=e;const i=300}(sj||(sj={}));function BQe(t){return"performanceInfo"in t}const sw=$(),GQe=$(),Kd=$(),ep=$();function qQe(t,e,i=0){const r=t.extent;if(A(r))return!1;if(i===0)return K5(r,e);const s=Math.min(r[2]-r[0],r[3]-r[1]);return Ywe(r,e,i*s)}function zI(t,e,i,r){re(sw,i),sw[r]=e[r];const s=ue(sw,sw,e),n=ue(GQe,t,e),o=ye(n,s),a=ye(s,s);let l;l=o<=0?e:a<=o?i:de(sw,e,se(s,s,o/a));const c=ue(sw,t,l);return Math.PI/2-Math.atan(c[2]/Math.sqrt(c[0]*c[0]+c[1]*c[1]))}function HQe(t,e,i){const r=t.extent;if(A(r))return 0;Kd[0]=r[0],Kd[1]=r[1],Kd[2]=i,ep[0]=r[2],ep[1]=r[3],ep[2]=i;let s=1/0,n=1/0;return e[0]<Kd[0]?s=zI(e,Kd,ep,0):e[0]>ep[0]&&(s=zI(e,ep,Kd,0)),e[1]<Kd[1]?n=zI(e,Kd,ep,1):e[1]>ep[1]&&(n=zI(e,ep,Kd,1)),Math.min(s,n)}function WQe(t,e,i){if(t.spatialReference.isGeographic&&!fy(t.spatialReference))return new Q("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const r=yi.checkUnsupported(t);return _(r)?r:ZQe(t,i)||(e&&!t.spatialReference.equals(e)?new Q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null)}function ZQe(t,e){const i=t.lods,r=i[0].resolution*2**i[0].level,s=[r*t.size[0],r*t.size[1]],n=[t.origin.x,t.origin.y],o=jW(e),a=pt();yi.computeRowColExtent(o,s,n,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>z_){const c=i[0].scale*2**i[0].level;let h=Math.max((o[3]-o[1])/t.size[1],(o[2]-o[0])/t.size[0])*c/r;const p=Math.floor(Math.log(h)/Math.log(10));return h=Math.ceil(h/10**p)*10**p,new Q("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(c).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+h.toLocaleString()+".",{level0Scale:c,suggestedLevel0Scale:h,requiredNumRootTiles:l,allowedNumRootTiles:z_})}return null}const JQe=Object.freeze({__proto__:null,isInsideExtent:qQe,tiltToExtentEdge:HQe,checkIfTileInfoSupportedForViewSR:WQe});function QQe(){return!0}function YQe(){return 0}function XQe(t,e){const i=t.lods.length-1,r=t.spatialReference,s=fy(r)||$h(r)||Eh(r);if(r.isWebMercator){if(!yi.makeWebMercatorAuxiliarySphere(i).compatibleWith(t))return new Q("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!s)return new Q("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!yi.makeGCSWithTileSize(t.spatialReference,t.size[0],i).compatibleWith(t))return t.spatialReference.isWGS84?new Q("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new Q("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}if(e&&!t.spatialReference.equals(e))return new Q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}const KQe=Object.freeze({__proto__:null,isInsideExtent:QQe,tiltToExtentEdge:YQe,checkIfTileInfoSupportedForViewSR:XQe}),vpe={1:KQe,2:JQe};function Vc(t,e){t||console.warn("Terrain: "+e)}const eYe=1.2,tYe=80/180*Math.PI,iYe=110/180*Math.PI;function rYe(t,e,i){const r=vpe[t.viewingMode];let s;if(r.isInsideExtent(t,e))s=st(t.getElevation(e[0],e[1],e[1],t.spatialReference),0);else{if(!r.isInsideExtent(t,e,eYe))return 0;const o=t.getTileWithElevation(e[0],e[1],e[1],t.spatialReference);s=.5*((_(o)?o.elevationBounds[0]:t.elevationBounds.min)+(_(o)?o.elevationBounds[1]:t.elevationBounds.max));const a=r.tiltToExtentEdge(t,e,s);if(a>tYe&&a<iYe)return 0}const n=e[2]-s;return Math.abs(n)<i?0:n<0?-1:1}function nj(t){return oj(t)?{fullExtent:t.fullExtent,minScale:t.layer.minScale,maxScale:t.layer.maxScale,tilemapCache:null}:t.layer}function _pe(t){return(t==null?void 0:t.type)==="vector-tile"}function VI(t){return(t==null?void 0:t.type)==="imagery-tile"||(t==null?void 0:t.type)==="wcs"}function oj(t){return(t==null?void 0:t.type)==="imagery-tile-3d"}function bpe(t){return(t==null?void 0:t.type)==="tile-3d"}function NI(t){return(t==null?void 0:t.type)==="vector-tile-3d"}function sYe(t){return(t==null?void 0:t.type)==="wmts-3d"}function UI(t){return(t==null?void 0:t.type)==="elevation-3d"}function nw(t){return t&&(bpe(t)||oj(t)||UI(t)||NI(t)||sYe(t))}function nYe(t){var e;const i=t==null||(e=t.sourceLayerInfo)==null?void 0:e.data;return _(i)&&"type"in i&&i.type==="raster-tile"}function oYe(t){var e;const i=t==null||(e=t.sourceLayerInfo)==null?void 0:e.data;return _(i)&&"type"in i&&i.type==="vector-tile"}function aYe(t){var e;const i=t==null||(e=t.sourceLayerInfo)==null?void 0:e.data;return _(i)&&"type"in i&&i.type==="tile-texture"}function lYe(t){var e;const i=t==null||(e=t.sourceLayerInfo)==null?void 0:e.data;return i instanceof HTMLImageElement||i instanceof O3||i instanceof HTMLCanvasElement||i instanceof ImageData}function ow(t){return _(t)&&"release"in t&&t.release(),null}function wpe(t){return t.fetchTile&&t.hasOverriddenFetchTile!==!1}function aj(t,e,i,r){return vpe[r].checkIfTileInfoSupportedForViewSR(t,i,e)}function jI(t,e,i){let r=null,s=null;if(t.type==="wmts"){const n=t.activeLayer;if(n){const o=n.tileMatrixSet;if(o)r=o.tileInfo,s=o.fullExtent;else{const a=n.tileMatrixSets;if(a){const l=a.find(c=>aj(c.tileInfo,c.fullExtent,e,i)==null);if(l)return{tileInfo:l.tileInfo,fullExtent:l.fullExtent}}}}}else s=VI(t)?t.getCompatibleFullExtent(e):t.fullExtent,r=_pe(t)&&!cYe.force512VTL?t.compatibleTileInfo256:VI(t)?t.getCompatibleTileInfo(e,s,i===2):t.tileInfo;return _(r)&&_(s)&&aj(r,s,e,i)==null?{tileInfo:r,fullExtent:s}:null}const cYe={force512VTL:!1};class uYe{constructor(e,i){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer,this.memory=nw(e)?i.basemapTerrain.getUsedMemoryForLayerView(e):e.getUsedMemory(),BQe(e)){const r=e.performanceInfo;this.displayedNumberOfFeatures=r.displayedNumberOfFeatures,this.maximumNumberOfFeatures=r.maximumNumberOfFeatures,this.totalNumberOfFeatures=r.totalNumberOfFeatures}}}class hYe{constructor(e){this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array;const i=e.resourceController.memoryController;this.totalMemory=1048576*i.maxMemory,this.usedMemory=Math.round(i.usedMemory*this.totalMemory),this.quality=i.memoryFactor,this.load=e.resourceController.scheduler.load,this.terrainMemory=e.basemapTerrain?e.basemapTerrain.getUsedMemory():0;const r=e._stage&&e._stage.renderView&&e._stage.renderView.edgeView;this.edgesMemory=_(r)?r.usedMemory:0,e.allLayerViews.items.forEach(s=>{(gpe(s)||nw(s))&&this.layerPerformanceInfos.push(new uYe(s,e))}),this.layerPerformanceInfos.sort((s,n)=>n.memory-s.memory)}}class dYe extends Gre{constructor(e,i,r,s){super(i,s),this._streamDataRequester=e,this._parameters=r}async fromUrl(e,i,r){Dt(r);const s=_(r)&&r.signal,n=this.makeUid(e,i);let o=this._textureRequests.get(n);if(!o){const a=new AbortController,l=this._streamDataRequester.request(e,"image",{uid:n,signal:a.signal});o={referenceCount:0,texture:null,textureAsync:null,abortController:a},this._textureRequests.set(n,o),o.textureAsync=l.then(async c=>{const h=this._createTexture(e,c,i);return o.texture=h,o.abortController=null,this._stage.add(h),await this._stage.load(h),{uid:n,texture:h,release:()=>this._release(n)}},c=>{throw o.abortController=null,c})}return o.referenceCount++,new Promise((a,l)=>{ps(s,()=>{l($t())}),o.textureAsync.then(a,l)}).catch(a=>{throw this._release(n),a})}_createTexture(e,i,r){const s=he(E({},this._parameters),{powerOfTwoResizeMode:2});if(QD(e)){if(r||i.width===0&&i.height===0){const n=i.width?i.height/i.width:1;r=r||64,n>1?(i.width=Math.round(r/n),i.height=r):(i.width=r,i.height=Math.round(r*n))}this._stage.renderView&&this._stage.renderView.renderingContext.driverTest.svgAlwaysPremultipliesAlpha&&(s.preMultiplyAlpha=!1)}return s.width=i.width,s.height=i.height,new Mr(i,s)}}class pYe{constructor(e){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=e.viewState,this.view=e.view,this.pointsOfInterest=e.pointsOfInterest,this.objectResourceCache=e.objectResourceCache,this.streamDataRequester=e.resourceController.createStreamDataRequester(4),this.textures=new dYe(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:33071,t:33071}},e.resourceController.scheduler);const i=Ut(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=ule(e.viewingMode,i),this.screenSizePerspectiveSettingsLabels=sNe(e.viewingMode,i)}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return{remove(){}};this.graphicsOwners.push(e);const i="layer"in e?e.watch("layer.screenSizePerspectiveEnabled",()=>this.updateScreenSizePerspectiveEnabled()):null;return this.updateScreenSizePerspectiveEnabled(),{remove:()=>{i&&(i.remove(),PC(this.graphicsOwners,e),this.updateScreenSizePerspectiveEnabled())}}}updateScreenSizePerspectiveEnabled(){const e=this.graphicsOwners.some(i=>i.get("layer.screenSizePerspectiveEnabled")===!0);if(e&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new dt;const i=()=>this.updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([this.pointsOfInterest.centerOnSurfaceInfrequent.watch("distance",i,!0),this.viewState.events.on("camera-projection-changed",i)]),this.updateScreenSizePerspectiveSettings()}else!e&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null)}updateScreenSizePerspectiveSettings(){const e=this.pointsOfInterest;BI.distance=e.centerOnSurfaceInfrequent.distance,BI.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(BI),this.screenSizePerspectiveSettingsLabels.update(BI),this.view._stage.renderView.requestRender()}}const BI={distance:0,fovY:0};class qm{constructor(e,i,r=""){this.graphics=e,this._symbol=new Xp({symbolLayers:[new du({material:{color:i},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new Kg({text:r,halo:{color:"white",size:1/.75},material:{color:i},size:12})]})}show(e,i){if(A(i))return;this.hide();const r=new je({x:e[0],y:e[1],z:e[2],spatialReference:i});this._graphic=new pn({geometry:r,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){_(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}let Hm=class extends ve{constructor(t){super(t),this.handles=new dt}destroy(){this.handles.destroy()}};u([d({constructOnly:!0})],Hm.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Hm.prototype,"surface",void 0),u([d({constructOnly:!0})],Hm.prototype,"state",void 0),Hm=u([R("esri.views.3d.support.PointOfInterest")],Hm);const fYe=Array;let bl=class extends Hm{constructor(t){super(t),this._dirty=!1,this._propertiesPool=new Um({location:je,renderLocation:fYe},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.cameraName="camera",this.renderLocation=$(),this.tmpPoint=new je}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const t=()=>this._setDirty();this.handles.add(ks(this.map,"ground.layers","change",t,t,t))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}get scale(){const t=this._camera,e=qt(t.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:t}};return F0(i,e,0)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const t=this._pendingElevationQueryController;t&&(this._pendingElevationQueryController=null,t.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this.tmpPoint,this.state.spatialReference);let t=new AbortController;this.map.ground.queryElevation(this.tmpPoint,{signal:t.signal,cache:this.cache}).then(e=>this._updateSurfaceAltitude(e.geometry.z)).catch(e=>{bi(e)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===t&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),t=null}),this._pendingElevationQueryController=t}_updateSurfaceAltitude(t){this._estimatedSurfaceAltitude!==t&&(this._estimatedSurfaceAltitude=t,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(lj,this._estimatedSurfaceAltitude,this._camera.eye),mo(this._get("renderLocation"),lj)||this._set("renderLocation",re(this._propertiesPool.get("renderLocation"),lj))}};u([d({constructOnly:!0})],bl.prototype,"scheduler",void 0),u([d({constructOnly:!0})],bl.prototype,"cache",void 0),u([d({constructOnly:!0})],bl.prototype,"task",void 0),u([d({constructOnly:!0})],bl.prototype,"cameraName",void 0),u([d({readOnly:!0})],bl.prototype,"location",null),u([d({constructOnly:!0})],bl.prototype,"map",void 0),u([d({readOnly:!0})],bl.prototype,"renderLocation",void 0),u([d({readOnly:!0})],bl.prototype,"scale",null),u([d({readOnly:!0})],bl.prototype,"updating",null),bl=u([R("esri.views.3d.support.CameraOnSurface")],bl);const lj=$(),xpe=bl,mYe=Array;let Nc=class extends Hm{constructor(t){super(t),this._propertiesPool=new Um({location:je,renderLocation:mYe},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.cameraName="camera",this.distance=0,this.renderLocation=$(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1}_updateRenderLocation(){const t=yYe;let e=this.calculateSurfaceIntersection(this._currentSurfaceAltitude,t);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!e&&i&&(e=this.calculateSurfaceIntersection(this._latestSurfaceAltitude,t),e&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=vYe;e&&this.latestSurfaceAltitudeChangesDistanceSignificantly(t,r)&&(re(t,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),e?this.distance=qt(this._camera.eye,t):(se(t,this._camera.viewForward,this._get("distance")),de(t,t,this._camera.eye)),mo(this._get("renderLocation"),t)||this._set("renderLocation",re(this._propertiesPool.get("renderLocation"),t))}calculateSurfaceIntersection(t,e){const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,t,e))return!1;if(this.state.isGlobal){const r=Ut(this.renderCoordsHelper.spatialReference).radius,s=r+t,n=un(i.eye),o=n<s*s,a=qt(i.eye,e);if(o&&a>r/4){const l=s-Math.sqrt(n);return se(e,i.viewForward,l),de(e,e,i.eye),!0}}else{const r=this.surface.ready?this.surface.extent:null;_(r)&&WP(r,this.surface.spatialReference,R3,this.renderCoordsHelper.spatialReference)&&(e[0]=Re(e[0],R3[0],R3[2]),e[1]=Re(e[1],R3[1],R3[3]))}return!0}latestSurfaceAltitudeChangesDistanceSignificantly(t,e){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||t==null)return!1;if(this.calculateSurfaceIntersection(this._latestSurfaceAltitude,e)){if(Kt.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=qt(i,t),s=qt(i,e);if(Math.abs(s-r)/r>gYe)return!0}return!1}};u([d({constructOnly:!0})],Nc.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Nc.prototype,"task",void 0),u([d({constructOnly:!0})],Nc.prototype,"cameraName",void 0),u([d()],Nc.prototype,"distance",void 0),u([d({constructOnly:!0})],Nc.prototype,"estimateSurfaceAltitudeAtCenter",void 0),u([d({readOnly:!0})],Nc.prototype,"location",null),u([d({readOnly:!0})],Nc.prototype,"renderLocation",void 0),u([d()],Nc.prototype,"updating",void 0),Nc=u([R("esri.views.3d.support.CenterOnSurface")],Nc);const gYe=.05,yYe=$(),vYe=$(),R3=pt(),GI=Nc;class _Ye{constructor(e){this.handles=new dt,this.events=new Ci,this.contentLayerViews=e.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",i=>this.layerViewsChanged(i))),this.layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews})}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}layerViewsChanged(e){e.added.forEach(i=>{i.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this.handles.add(i.on("visible-geometry-changed",()=>this.contentChanged()),i.uid)}),e.removed.forEach(i=>this.handles.remove(i.uid))}contentChanged(){this.events.emit("request-update",bYe)}}const bYe={},wYe=Array;let hh=class extends Hm{constructor(t){super(t),this._propertiesPool=new Um({location:je,renderLocation:wYe},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([this.centerOnSurface.watch("renderLocation",()=>this.updateRenderLocation()),this.state.watch("contentCamera",()=>this.updateRenderLocation())]),this.scheduler&&this.handles.add(this.scheduler.registerTask(Qe.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}get running(){return this._dirty}runTask(){const t=this._get("renderLocation"),e=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(e,Spe);const s=Math.max(0,(Math.acos(ye(Spe,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!t||!mx(t,e)){const l=this._propertiesPool.get("renderLocation");re(l,e),this._set("renderLocation",l)}return}const n=1-Re(s/(.5*Math.PI),0,1),o=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(Tpe);const a=this._propertiesPool.get("renderLocation");jr(a,e,Tpe,o),t&&mx(t,a)||this._set("renderLocation",a)}_calculateScreenHorizontalEdgeOnSurface(t){const e=this.state.contentCamera,i=e.getRenderCenter(ys());if(i[1]=e.aboveGround?e.padding[2]:e.fullHeight-e.padding[0],this.estimateSurfaceIntersectionAtRenderPoint(i,t))return t;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(e.unprojectFromRenderScreen(i,I3)){ue(I3,I3,e.eye);const s=_e(I3,I3);if(this.renderCoordsHelper.intersectManifold(Ko(e.eye,s),r,t))return t}return this.renderCoordsHelper.setAltitude(t,r,e.eye)}updateRenderLocation(){this._dirty=!0}};u([d()],hh.prototype,"_dirty",void 0),u([d({constructOnly:!0})],hh.prototype,"scheduler",void 0),u([d({constructOnly:!0})],hh.prototype,"centerOnSurface",void 0),u([d({constructOnly:!0})],hh.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),u([d({readOnly:!0})],hh.prototype,"updating",null),u([d({readOnly:!0})],hh.prototype,"location",null),u([d({readOnly:!0})],hh.prototype,"renderLocation",void 0),hh=u([R("esri.views.3d.support.CenterOnSurface")],hh);const Spe=$(),I3=$(),Tpe=$(),xYe=hh;let tp=class extends ve{constructor(t){super(t),this.location=null,this._updateController=null,this._handles=new dt}get renderLocation(){if(!this.location)return null;const t=$();return this.view.renderCoordsHelper.toRenderCoords(this.location,t),t}initialize(){this.view.state.isLocal&&(this._handles.add([this.watch(["surfaceView.spatialReference","surfaceView.extent"],()=>this._update()),ks(this,"surface.layers","change",()=>this._update())]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||A(this.surfaceView.extent)||!this.surfaceView.spatialReference)return void this._set("location",null);const t=X5(this.surfaceView.extent),e=new je({x:t[0],y:t[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(e,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(i=>{this._updateController=null,this._set("location",i.geometry)}).catch(i=>{bi(i)||i&&i.name==="elevation-query:invalid-layer"||console.error("StableSurfaceCenter failed to update: ",i)})):this._set("location",e)}};u([d({constructOnly:!0})],tp.prototype,"view",void 0),u([d({constructOnly:!0})],tp.prototype,"cache",void 0),u([d({readOnly:!0,aliasOf:"view.map.ground"})],tp.prototype,"surface",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain"})],tp.prototype,"surfaceView",void 0),u([d({readOnly:!0})],tp.prototype,"location",void 0),u([d({readOnly:!0})],tp.prototype,"renderLocation",null),tp=u([R("esri.views.3d.terrain.StableSurfaceCenter")],tp);let ip=class extends ve{constructor(){super(...arguments),this.handles=new dt,this._tileGeometryUpdateExtent=ja(),this._tileGeometryUpdateSpatialReference=null,this.events=new Ci,this.updating=!1}initialize(){this.handles.add([this.surface.on("elevation-change",t=>this._tileGeometryChanged(t)),this.scheduler.registerTask(Qe.SURFACE_GEOMETRY_UPDATES,this)])}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}get running(){return this.updating}runTask(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",SYe),ja(this._tileGeometryUpdateExtent),this._set("updating",!1))}_tileGeometryChanged(t){this._tileGeometryUpdateSpatialReference=t.spatialReference,Gp(this._tileGeometryUpdateExtent,t.tile.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let t=this.centerOnSurfaces[0];for(let e=1;e<this.centerOnSurfaces.length;e++){const i=this.centerOnSurfaces[e];i.distance>t.distance&&(t=i)}return t}_centerIntersectsExtent(t,e){const i=this.state.camera.eye,r=TYe,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,wv,e),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,xv,e),wv[0]<xv[0]?(r[0]=wv[0],r[2]=xv[0]):(r[0]=xv[0],r[2]=wv[0]),wv[1]<xv[1]?(r[1]=wv[1],r[3]=xv[1]):(r[1]=xv[1],r[3]=wv[1]),cP(r,t)}};u([d({constructOnly:!0})],ip.prototype,"state",void 0),u([d({constructOnly:!0})],ip.prototype,"centerOnSurfaces",void 0),u([d({constructOnly:!0})],ip.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],ip.prototype,"scheduler",void 0),u([d({constructOnly:!0})],ip.prototype,"surface",void 0),u([d({readOnly:!0})],ip.prototype,"updating",void 0),ip=u([R("esri.views.3d.support.SurfaceGeometryUpdates")],ip);const SYe={},wv=$(),xv=$(),TYe=ja();let Pn=class extends ve{constructor(t){super(t),this._handles=new dt,this._tmpRay=vs(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new Um({renderPointOfView:CYe},this),this.renderPointOfView=$(),this._pois=new Array,this._debugCenters=new Map}initialize(){var t;const{state:e,basemapTerrain:i,renderCoordsHelper:r,map:s}=this.view;this._surfaceIntersector=nl(e.viewingMode),e.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=0,this._contentIntersector=nl(e.viewingMode);const n=()=>this._estimateSurfaceAltitudeAtCenter(),o=this.view.resourceController.scheduler,a=at((t=this.view.basemapTerrain)==null?void 0:t.elevationQueryCache),l={state:e,scheduler:o,surface:i,renderCoordsHelper:r};this._set("centerOnSurfaceInfrequent",new GI(he(E({},l),{task:Qe.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n}))),this._set("centerOnSurfaceFrequent",new GI(he(E({},l),{task:Qe.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n}))),this._set("contentCenterOnSurface",new GI(he(E({},l),{task:Qe.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n,cameraName:"contentCamera"}))),this._set("centerOnContent",new GI(he(E({},l),{task:Qe.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}))),this._set("cameraOnSurface",new xpe(he(E({},l),{cache:a,task:Qe.POINT_OF_INTEREST_INFREQUENT,map:s}))),this._set("contentCameraOnSurface",new xpe(he(E({},l),{cache:a,task:Qe.POINT_OF_INTEREST_INFREQUENT,map:s,cameraName:"contentCamera"}))),this._set("surfaceGeometryUpdates",new ip(he(E({},l),{centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}))),this._set("contentGeometryUpdates",new _Ye({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:r})),this._set("surfaceOrigin",new tp({cache:a,view:this.view})),this._set("focus",new xYe({state:e,scheduler:o,surface:i,renderCoordsHelper:r,centerOnSurface:this.contentCenterOnSurface,estimateSurfaceIntersectionAtRenderPoint:(h,p)=>this._estimateSurfaceIntersectionAtRenderPoint(h,this.view.state.contentCamera,p)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const c=this.view.graphics;this._debugCenters.set(this.centerOnContent,new qm(c,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new qm(c,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new qm(c,"red","CenterOnSurface")),this._debugCenters.set(this.contentCenterOnSurface,new qm(c,"red","ContentCenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new qm(c,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new qm(c,"blue","ContentCameraOnSurface")),this._debugCenters.set(this.focus,new qm(c,"green","Focus")),this._handles.add([e.watch("camera",h=>this._cameraChanged(h),!0),i.watch("extent",()=>this._updateCenterPointsOfInterest()),LM(i,"updating",()=>this._updateCenterPointsOfInterest(),!0),this.surfaceGeometryUpdates.events.on("request-update",()=>this._updateCenterPointsOfInterest()),this.contentGeometryUpdates.events.on("request-update",()=>this._updateCenterOnContent()),Ke(Kt,"SHOW_POI",h=>this._setDebug(h))]),this._cameraChanged(this.view.state.camera);for(const h of this._pois)h.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const t of this._pois)t.destroy();this.surfaceOrigin.destroy()}get updating(){var t;return!!((t=this.surfaceGeometryUpdates)!=null&&t.updating||this._pois.some(e=>e.updating))}get centerRay(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const t=this.centerRay;return A(t)||(this.view.sceneIntersectionHelper.intersectRay(t,this._contentIntersector,aw,PYe)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(aw):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const t=this.centerRay;if(A(t))return this._surfaceAltitudeAtCenter;const e=t.origin,i=de(aw,t.origin,t.direction);return this._surfaceIntersector.resetWithRay(t,this.view.state.camera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,e,i),this._surfaceIntersector.results.min.getIntersectionPoint(aw)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(aw)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(t,e,i){const r=pN(e,t,MYe);if(A(r))return null;const s=r.origin,n=de(aw,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,e),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,n),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(t){this._updateCenterPointsOfInterest();const e=t.eye;mo(this.renderPointOfView,e)||this._set("renderPointOfView",re(this._propertiesPool.get("renderPointOfView"),e))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const t of this._pois)t.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(t){if(!t)return this._debugCenters.forEach(e=>e.hide()),void this._handles.remove("debug");for(const e of this._pois)this._handles.add(Ke(e,"renderLocation",i=>this._debugCenters.get(e).show(i,e.renderCoordsHelper.spatialReference)),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const t of this._pois)t.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};u([d({readOnly:!0})],Pn.prototype,"centerOnContent",void 0),u([d({readOnly:!0})],Pn.prototype,"centerOnSurfaceFrequent",void 0),u([d({readOnly:!0})],Pn.prototype,"centerOnSurfaceInfrequent",void 0),u([d({readOnly:!0})],Pn.prototype,"contentCenterOnSurface",void 0),u([d({readOnly:!0})],Pn.prototype,"cameraOnSurface",void 0),u([d({readOnly:!0})],Pn.prototype,"contentCameraOnSurface",void 0),u([d({readOnly:!0})],Pn.prototype,"focus",void 0),u([d({readOnly:!0})],Pn.prototype,"renderPointOfView",void 0),u([d({readOnly:!0})],Pn.prototype,"surfaceOrigin",void 0),u([d({readOnly:!0})],Pn.prototype,"contentGeometryUpdates",void 0),u([d({readOnly:!0})],Pn.prototype,"surfaceGeometryUpdates",void 0),u([d({constructOnly:!0})],Pn.prototype,"view",void 0),u([d({readOnly:!0})],Pn.prototype,"updating",null),Pn=u([R("esri.views.3d.support.PointsOfInterest")],Pn);const CYe=Array,aw=$(),MYe=vs(),PYe={exclude:new Set([T0])},Cpe=Pn;class AYe{constructor(e){this.store=e}destroy(){this.store.destroy()}get(e){return this.store.get(e)}put(e,i){this.store.put(e,i,i.values.byteLength+256)}}const $Ye=le.getLogger("esri.core.workers.WorkerHandle");class Mpe{constructor(e,i,r,s={}){this._mainMethod=i,this._listeners=[],this._promise=jZ(e,he(E({},s),{schedule:r})).then(n=>{if(this._thread===void 0){this._thread=n,this._promise=null,s.hasInitialize&&this.broadcast({},"initialize");for(const o of this._listeners)this._connectListener(o)}else n.close()}),this._promise.catch(n=>$Ye.error(`Failed to initialize ${e} worker: ${n}`))}on(e,i){const r={removed:!1,eventName:e,callback:i,threadHandle:null};return this._listeners.push(r),this._connectListener(r),pg(()=>{r.removed=!0,sD(this._listeners,r),this._thread&&_(r.threadHandle)&&r.threadHandle.remove()})}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null}invoke(e,i){return this.invokeMethod(this._mainMethod,e,i)}invokeMethod(e,i,r){if(this._thread){const s=this.getTransferList(i,e);return this._thread.invoke(e,i,{transferList:s,signal:r})}return this._promise?this._promise.then(()=>(Dt(r),this.invokeMethod(e,i,r))):Promise.reject(null)}broadcast(e,i){return this._thread?Promise.all(this._thread.broadcast(i,e)).then(()=>{}):this._promise?this._promise.then(()=>this.broadcast(e,i)):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then(i=>{e.removed||(e.threadHandle=i)})}}class Ppe extends Mpe{constructor(e=null){super("LercWorker","_decode",e,{strategy:"dedicated"}),this.schedule=e,this.ref=0}decode(e,i,r){return e&&e.byteLength!==0?this.invoke({buffer:e,options:i},r):Promise.resolve(null)}getTransferList(e){return[e.buffer]}release(){--this.ref<=0&&(D3.forEach((e,i)=>{e===this&&D3.delete(i)}),this.destroy())}}const D3=new Map;function Ape(t=null){let e=D3.get(at(t));return e||(_(t)?(e=new Ppe(i=>t.schedule(i)),D3.set(t,e)):(e=new Ppe,D3.set(null,e))),++e.ref,e}function rp(){const t=new Float32Array(9);return t[0]=1,t[4]=1,t[8]=1,t}function $pe(t){const e=new Float32Array(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function EYe(t,e,i,r,s,n,o,a,l){const c=new Float32Array(9);return c[0]=t,c[1]=e,c[2]=i,c[3]=r,c[4]=s,c[5]=n,c[6]=o,c[7]=a,c[8]=l,c}function OYe(t,e){return new Float32Array(t,e,9)}Object.freeze({__proto__:null,create:rp,clone:$pe,fromValues:EYe,createView:OYe});class RYe{constructor(e){this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}}class Jat{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function Qat(t,e,i,r,s,n){const o=i-s;if(o>=0)return(e>>o)+(r-(n<<o))*(t>>o);const a=-o;return e-(n-(r<<a))*(t>>a)<<a}class Yat{constructor(e,i,r){this._rows=Math.ceil(i/r),this._columns=Math.ceil(e/r),this._cellSize=r,this.cells=new Array(this._rows);for(let s=0;s<this._rows;s++){this.cells[s]=new Array(this._columns);for(let n=0;n<this._columns;n++)this.cells[s][n]=[]}}getCell(e,i){const r=Math.min(Math.max(Math.floor(i/this._cellSize),0),this._rows-1),s=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[r]&&this.cells[r][s]||null}getCellSpan(e,i,r,s){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function IYe(t,e,i,r,s,n){const o=e[r++];for(let a=0;a<o;a++){const l=new RYe(n);l.xTile=e[r++],l.yTile=e[r++],l.hash=e[r++],l.priority=e[r++];const c=e[r++];for(let f=0;f<c;f++){const g=e[r++],y=e[r++],v=e[r++],b=e[r++],w=!!e[r++],S=e[r++],T=i[r++],C=i[r++],M=e[r++],P=e[r++];l.colliders.push({xTile:g,yTile:y,dxPixels:v,dyPixels:b,hard:w,partIndex:S,width:M,height:P,minLod:T,maxLod:C})}const h=t[r++];for(let f=0;f<h;f++)l.textVertexRanges.push([t[r++],t[r++]]);const p=t[r++];for(let f=0;f<p;f++)l.iconVertexRanges.push([t[r++],t[r++]]);s.push(l)}return r}function Xat(t,e,i){for(const[r,s]of t.symbols)DYe(t,e,i,s,r)}function DYe(t,e,i,r,s){const n=t.layerData.get(s);if(n.type===3){for(const o of r){const a=o.unique;let l;if(o.selectedForRendering){const c=a.parts[0],h=c.startOpacity,p=c.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&p===0;const f=i?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.iconVertexRanges)for(let p=c;p<c+h;p+=4)n.iconOpacity[p/4]=l;if(o.selectedForRendering){const c=a.parts[1],h=c.startOpacity,p=c.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&p===0;const f=i?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.textVertexRanges)for(let p=c;p<c+h;p+=4)n.textOpacity[p/4]=l}n.lastOpacityUpdate=e,n.opacityChanged=!0}}class qI{constructor(e,i){this.layerUIDs=[],this.isDestroyed=!1,this.data=e,this.memoryUsed=e.byteLength;let r=1;const s=new Uint32Array(e);this.layerUIDs=[];const n=s[r++];for(let o=0;o<n;o++)this.layerUIDs[o]=s[r++];this.bufferDataOffset=r,i&&(this.layer=i.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return A(this.data)}get offset(){return this.bufferDataOffset}destroy(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}prepareForRendering(e){A(this.data)||(this.doPrepareForRendering(e,this.data,this.bufferDataOffset),this.data=null)}}class FYe extends qI{constructor(e,i){super(e,i),this.type=2,this.lineIndexStart=0,this.lineIndexCount=0;const r=new Uint32Array(e);let s=this.bufferDataOffset;this.lineIndexStart=r[s++],this.lineIndexCount=r[s++];const n=r[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=r[s++],c=r[s++],h=r[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){_(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),_(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),_(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.lineVertexBuffer=Nt.createVertex(e,35044,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.lineIndexBuffer=Nt.createIndex(e,35044,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=this.layer.lineMaterial;this.lineVertexArrayObject=new Tr(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)}}class LYe extends qI{constructor(e,i){super(e,i),this.type=1,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const r=new Uint32Array(e);let s=this.bufferDataOffset;this.fillIndexStart=r[s++],this.fillIndexCount=r[s++],this.outlineIndexStart=r[s++],this.outlineIndexCount=r[s++];const n=r[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=r[s++],c=r[s++],h=r[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){_(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),_(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),_(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,_(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),_(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),_(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.fillVertexBuffer=Nt.createVertex(e,35044,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.fillIndexBuffer=Nt.createIndex(e,35044,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=s[r++];this.outlineVertexBuffer=Nt.createVertex(e,35044,new Int32Array(n.buffer,4*r,l)),r+=l;const c=s[r++];this.outlineIndexBuffer=Nt.createIndex(e,35044,new Uint32Array(s.buffer,4*r,c)),r+=c;const h=this.layer,p=h.fillMaterial,f=h.outlineMaterial;this.fillVertexArrayObject=new Tr(e,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new Tr(e,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)}}class kYe extends qI{constructor(e,i,r){super(e,i),this.type=3,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const s=new Uint32Array(e),n=new Int32Array(e),o=new Float32Array(e);let a=this.bufferDataOffset;this.isIconSDF=!!s[a++];const l=s[a++];for(let f=0;f<l;f++){const g=s[a++],y=s[a++],v=s[a++];this.iconPerPageElementsMap.set(g,[y,v])}const c=s[a++];for(let f=0;f<c;f++){const g=s[a++],y=s[a++],v=s[a++];this.glyphPerPageElementsMap.set(g,[y,v])}const h=s[a++],p=s[a++];this.iconOpacity=new Int32Array(h),this.textOpacity=new Int32Array(p),a=IYe(s,n,o,a,this.symbols,r),this.bufferDataOffset=a}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const[i,r]of this.iconPerPageElementsMap)e+=r[1];for(const[i,r]of this.glyphPerPageElementsMap)e+=r[1];return e/3}doDestroy(){_(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),_(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),_(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),_(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,_(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),_(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),_(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),_(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=at(this.iconOpacity),i=at(this.iconOpacityBuffer);e.length>0&&e.byteLength===i.size&&i.setSubData(e);const r=at(this.textOpacity),s=at(this.textOpacityBuffer);r.length>0&&r.byteLength===s.size&&s.setSubData(r)}doPrepareForRendering(e,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.iconVertexBuffer=Nt.createVertex(e,35044,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.iconIndexBuffer=Nt.createIndex(e,35044,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=s[r++];this.textVertexBuffer=Nt.createVertex(e,35044,new Int32Array(n.buffer,4*r,l)),r+=l;const c=s[r++];this.textIndexBuffer=Nt.createIndex(e,35044,new Uint32Array(s.buffer,4*r,c)),r+=c,this.iconOpacityBuffer=Nt.createVertex(e,35044,at(this.iconOpacity).buffer),this.textOpacityBuffer=Nt.createVertex(e,35044,at(this.textOpacity).buffer);const h=this.layer,p=h.iconMaterial,f=h.textMaterial;this.iconVertexArrayObject=new Tr(e,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new Tr(e,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)}}class zYe extends qI{constructor(e,i){super(e,i),this.type=4,this.circleIndexStart=0,this.circleIndexCount=0;const r=new Uint32Array(e);let s=this.bufferDataOffset;this.circleIndexStart=r[s++],this.circleIndexCount=r[s++],this.bufferDataOffset=s}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){_(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),_(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),_(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.circleVertexBuffer=Nt.createVertex(e,35044,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.circleIndexBuffer=Nt.createIndex(e,35044,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=this.layer.circleMaterial;this.circleVertexArrayObject=new Tr(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)}}const Kat=!0,elt=32,Epe=200,VYe=1/ae("mapview-transitions-duration");class NYe extends Ci{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const i=this._stage;this._stage=e,e?this._stage.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):i.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return A(this._transforms)&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this.requestRender())}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=Th(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=Th(),this.requestRender()),this._fadeOutResolver.promise}beforeRender(e){this.updateTransitionProperties(e.deltaTime,e.state.scale)}afterRender(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&this.computedOpacity===0&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var e;(e=this.parent)==null||e.removeChild(this)}setTransform(e){}processRender(e){this.stage&&this.computedVisible&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.onDetach(),this.emit("detach")}updateTransitionProperties(e,i){if(this.fadeTransitionEnabled){const r=this._fadeOutResolver||!this.visible?0:this.opacity,s=this.computedOpacity;if(s===r)this.computedVisible=this.visible;else{const n=e*VYe;this.computedOpacity=s>r?Math.max(r,s-n):Math.min(r,s+n),this.computedVisible=this.computedOpacity>0;const o=r===this.computedOpacity;this.inFadeTransition=!o,o||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}class dh{constructor(e,i,r,s){this.set(e,i,r,s)}static getId(e,i,r,s){return typeof e=="object"?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${i}/${r}/${s}`}get key(){return this}get id(){return this.toString()}set id(e){this.set(e)}get hash(){const e=4095&this.row,i=4095&this.col,r=63&this.level;return(3&this.world)<<30|i<<22|e<<8|r}acquire(e,i,r,s){this.set(e,i,r,s)}contains(e){const i=e.level-this.level;return this.row===e.row>>i&&this.col===e.col>>i&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new dh(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,i,r,s){if(e==null)this.level=0,this.row=0,this.col=0,this.world=0;else if(typeof e=="object")this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if(typeof e=="string"){const[n,o,a,l]=e.split("/");this.level=parseFloat(n),this.row=parseFloat(o),this.col=parseFloat(a),this.world=parseFloat(l)}else this.level=+e,this.row=+i,this.col=+r,this.world=+s||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new dh(this.level-1,this.row>>1,this.col>>1,this.world)}getChildKeys(){const e=this.level+1,i=this.row<<1,r=this.col<<1,s=this.world;return[new dh(e,i,r,s),new dh(e,i,r+1,s),new dh(e,i+1,r,s),new dh(e,i+1,r+1,s)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}}dh.pool=new Xi(dh,null,null,25,50);class UYe extends NYe{constructor(e,i,r,s,n,o=s,a=n){super(),this.triangleCountReportedInDebug=0,this.triangleCount=0,this.texture=null,this.key=new dh(e),this.x=i,this.y=r,this.width=s,this.height=n,this.rangeX=o,this.rangeY=a}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}setTransform(e,i){const r=i/(e.resolution*e.pixelRatio),s=this.transforms.tileMat3,[n,o]=e.toScreenNoRotation([0,0],[this.x,this.y]),a=this.width/this.rangeX*r,l=this.height/this.rangeY*r;gV(s,a,0,0,0,l,0,n,o,1),OE(this.transforms.dvs,e.displayViewMat3,s)}}class HI extends UYe{constructor(e,i,r,s,n,o,a=null){super(e,i,r,s,n,4096,4096),this._memCache=a,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.layerCount=0,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.invalidating=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.styleRepository=o,this.id=e.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<Epe}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<Epe)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}deleteLayerData(e){let i=!1;for(const r of e)if(this.layerData.has(r)){const s=this.layerData.get(r);this._memoryUsedByLayerData-=s.memoryUsed,s.type===3&&this.symbols.has(r)&&(this.symbols.delete(r),i=!0),s.destroy(),this.layerData.delete(r),this.layerCount--}_(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),i&&this.emit("symbols-changed"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerCount>0}dispose(){this.status!=="unloaded"&&(Ope.delete(this),HI._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return--this._referenced==0&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get memoryUsage(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}changeDataImpl(e){let i=!1;if(e){const r=this._createRenderBuckets(e);for(const[s,n]of r){if(this.layerData.has(s)){const o=this.layerData.get(s);this._memoryUsedByLayerData-=n.memoryUsed,o.destroy(),this.layerData.delete(s),this.layerCount--}n.type===3&&(this.symbols.set(s,n.symbols),i=!0),this._memoryUsedByLayerData+=n.memoryUsed,this.layerData.set(s,n),this.layerCount++}_(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const[r,s]of this.layerData)s.type===3&&(this._hasSymbolBuckets=!0);i&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(i){i.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e,i){super.setTransform(e,i);const r=i/(e.resolution*e.pixelRatio),s=this.width/this.rangeX*r,n=this.height/this.rangeY*r,o=[0,0];e.toScreen(o,[this.x,this.y]);const a=this.transforms.tileUnitsToPixels;yV(a),RE(a,a,o),vV(a,a,Math.PI*e.rotation/180),_V(a,a,[s,n,1])}_createTransforms(){return{dvs:rp(),tileMat3:rp(),tileUnitsToPixels:rp()}}static _destroyRenderBuckets(e){if(!e)return;const i=new Set;e.forEach(r=>{i.has(r)||(r.destroy(),i.add(r))}),e.clear()}_createRenderBuckets(e){const i=new Map,r=new Map;for(const s of e){const n=this._deserializeBucket(s,r);for(const o of n.layerUIDs)i.set(o,n)}return i}_deserializeBucket(e,i){let r=i.get(e);if(r)return r;switch(new Uint32Array(e)[0]){case 1:r=new LYe(e,this.styleRepository);break;case 2:r=new FYe(e,this.styleRepository);break;case 3:r=new kYe(e,this.styleRepository,this);break;case 4:r=new zYe(e,this.styleRepository)}return i.set(e,r),r}}const Ope=new Map;function jYe(){Ope.forEach((t,e)=>{console.log(`
${e.key}:`),t[0].forEach(i=>console.log(i)),console.log("========"),t[1].forEach(i=>console.log(i))})}const BYe=t=>{let e=class extends t{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(i){super.postscript(i),ase(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const i=bx(this.view.defaultsFromMap,"heightModelInfoReady");this.handles.add(i),await i;const r=w5e(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(r)throw r}};return u([d()],e.prototype,"view",void 0),u([d()],e.prototype,"slicePlaneEnabled",void 0),e=u([R("esri.views.3d.layers.LayerView3D")],e),e},GYe={value:.5,readOnly:!0},Rpe={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}},qYe=t=>{let e=class extends t{get imageFormatIsOpaque(){return!1}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get dataLevelRange(){const i=this.tileInfo.lods,r=i[0].scale,s=i[i.length-1].scale;return this.levelRangeFromScaleRange(r,s)}get displayLevelRange(){const i=this.tileInfo.lods,r=this.layer.minScale||i[0].scale,s=this.layer.maxScale||i[i.length-1].scale,n=this.levelRangeFromScaleRange(r,s);return this.layer.maxScale&&n.maxLevel++,n}getTileUrl(i,r,s){return this.layer.getTileUrl(i,r,s)}_addTilingSchemeMatchPromise(){if(A(this.layer.fullExtent))return this.addResolvingPromise(Promise.reject(new Q("tilingscheme:extent-not-defined","This layer doesn't define a fullExtent.")));const i=this._getTileInfoSupportError(this.tileInfo,this.layer.fullExtent);if(i)return this.addResolvingPromise(Promise.reject(i));const r=bx(this.view,"basemapTerrain.tilingSchemeLocked").then(()=>{const s=this.view.basemapTerrain.tilingScheme,n=this._getTileInfoCompatibilityError(this.tileInfo,s);if(n)throw n});this.addResolvingPromise(r)}_getTileInfoSupportError(i,r){const s=aj(i,r,this.view.spatialReference,this.view.state.viewingMode);if(s){const n={layer:this.layer,error:s};let o;switch(s.name){case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":case"tilingscheme:local-unsupported-spatial-reference":o=new Q("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",n);break;default:o=new Q("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",n)}return o}return null}_getTileInfoCompatibilityError(i,r){return r.compatibleWith(i)?null:new Q("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(i,r){const s={minLevel:0,maxLevel:1/0},n=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!n)return s;const o=n.levels[0],a=l=>{const c=Math.log(o.scale/l)/Math.LN2;return .5-Math.abs(.5-c%1)<1e-9?Math.round(c):Math.ceil(c)};return i!=null&&i>0&&(s.minLevel=Math.max(0,a(i))),r!=null&&r>0&&(s.maxLevel=Math.max(0,a(r))),s}isUpdating(){return!!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return u([d({readOnly:!0})],e.prototype,"imageFormatIsOpaque",null),u([d({readOnly:!0})],e.prototype,"updating",void 0),u([d(Rpe)],e.prototype,"updatingProgress",void 0),u([d(GYe)],e.prototype,"updatingProgressValue",void 0),u([d({readOnly:!0})],e.prototype,"fullExtent",void 0),u([d({readOnly:!0})],e.prototype,"isOpaque",null),u([d({readOnly:!0})],e.prototype,"dataLevelRange",null),u([d({readOnly:!0})],e.prototype,"displayLevelRange",null),u([d()],e.prototype,"layer",void 0),u([d({readOnly:!0})],e.prototype,"tileInfo",void 0),e=u([R("esri.views.3d.layers.TiledLayerView3D")],e),e};let wl=class extends tu(NM(rx(Ci.EventedMixin(ve)))){constructor(t){super(t),this.layer=null,this.parent=null}initialize(){this.when().catch(t=>{if(t.name!=="layerview:create-error"){const e=this.layer&&this.layer.id||"no id",i=this.layer&&this.layer.title||"no title";throw le.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${i}', id: '${e}')`,t),t}})}get fullOpacity(){return st(this.get("layer.opacity"),1)*st(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&this.layer.legendEnabled===!0}get updating(){return!!(this.updatingHandles&&this.updatingHandles.updating||this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){var t;return((t=this.layer)==null?void 0:t.visible)===!0}set visible(t){t!==void 0?this._override("visible",t):this._clearOverride("visible")}canResume(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.get("layer.loaded")&&this.visible||!1}getSuspendInfo(){const t=this.parent&&this.parent.suspended?this.parent.suspendInfo:{},e=this;return e.view&&e.view.ready||(t.viewNotReady=!0),this.layer&&this.layer.loaded||(t.layerNotLoaded=!0),this.visible||(t.layerInvisible=!0),t}isUpdating(){return!1}};u([d()],wl.prototype,"fullOpacity",null),u([d()],wl.prototype,"layer",void 0),u([d()],wl.prototype,"parent",void 0),u([d({readOnly:!0})],wl.prototype,"suspended",null),u([d({readOnly:!0})],wl.prototype,"suspendInfo",null),u([d({readOnly:!0})],wl.prototype,"legendEnabled",null),u([d({type:Boolean,readOnly:!0})],wl.prototype,"updating",null),u([d({readOnly:!0})],wl.prototype,"updatingProgress",null),u([d()],wl.prototype,"visible",null),wl=u([R("esri.views.layers.LayerView")],wl);const HYe=wl;let lw=class extends qYe(BYe(HYe)){constructor(){super(...arguments),this.type="elevation-3d"}initialize(){const t=this.get("view.map.allLayers"),e=t&&t.includes(this.layer),i=this.get("view.map.ground.layers"),r=i&&i.includes(this.layer);if(e&&!r){const s=new Q("layerview:elevation-layer-only","3D elevation layer '"+this.layer.id+"' can only be added in the map ground");this.addResolvingPromise(Promise.reject(s))}this._addTilingSchemeMatchPromise()}};u([d({readOnly:!0,aliasOf:"layer.fullExtent"})],lw.prototype,"fullExtent",void 0),u([d()],lw.prototype,"layer",void 0),u([d({readOnly:!0,aliasOf:"layer.tileInfo"})],lw.prototype,"tileInfo",void 0),lw=u([R("esri.views.3d.layers.ElevationLayerView3D")],lw);const Ipe=lw;var WYe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Ipe});class cj{constructor(e=0,i=0){this.min=e,this.max=i,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}class WI{constructor(e,i,r){this.type="elevation",this.samplerData=null,this.level=e[0],this.i=e[1],this.j=e[2],this.extent=i;const s=r.noDataValue,n=r.values;let o=1/0,a=-1/0,l=!0,c=!1;for(let h=0;h<n.length;h++){const p=n[h];p!==s?(o=p<o?p:o,a=p>a?p:a,l=!1):c=!0}l&&(o=0,a=0),a=a>-3e38?a:0,this.samplerData={pixelData:r.values,width:r.width,height:r.height,noDataValue:s,safeWidth:.99999999*(r.width-1),dx:(r.width-1)/(i[2]-i[0]),dy:(r.width-1)/(i[3]-i[1]),x0:i[0],y1:i[3]},this.bounds=[o,a],this.hasNoDataValues=c}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(e,i,r,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;const n=e-this.level;if(n<=0)return s;const o=2**n;if(!(Math.floor(i/o)===this.i&&Math.floor(r/o)===this.j))return s;let a=1/0,l=-1/0;const c=this.samplerData.width,h=this.samplerData.pixelData,p=.5*CS;let f=(c-1)/o,g=(r-this.j*o)*f,y=(i-this.i*o)*f;if(f<1){const v=Math.floor(g),b=Math.floor(y),w=v+b*c,S=h[w],T=h[w+1],C=h[w+c],M=h[w+c+1];if(S+T+C+M<p){const P=g-v,F=y-b,z=UM(S,T,C,M,P,F),D=UM(S,T,C,M,P+f,F),U=UM(S,T,C,M,P,F+f),G=UM(S,T,C,M,P+f,F+f);return s.min=Math.min(z,D,U,G),s.max=Math.max(z,D,U,G),s}g=v,y=b,f=1}else g=Math.floor(g),y=Math.floor(y),f=Math.ceil(f);for(let v=g;v<=g+f;v++)for(let b=y;b<=y+f;b++){const w=h[v+b*c];w<p?(a=Math.min(a,w),l=Math.max(l,w)):s.hasNoDataValues=!0}return s.min=a,s.max=l,s}static sample(e,i,r){for(const s of r){if(!s)continue;const n=s.safeWidth,o=s.width,a=s.pixelData;let l=Re(s.dy*(s.y1-i),0,n),c=Re(s.dx*(e-s.x0),0,n);const h=Math.floor(l),p=Math.floor(c),f=h*o+p,g=f+o,y=a[f],v=a[g],b=a[f+1],w=a[g+1];if(y+v+b+w<.5*CS){l-=h,c-=p;const S=y+(b-y)*c;return S+(v+(w-v)*c-S)*l}}return null}}let xl=class extends ve{constructor(t){super(t),this._handles=new dt}initialize(){this._handles.add([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){this._handles.destroy(),this._handles=null}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const t=[];return this.layerViews.forEach(e=>{const i=e.layer;if(i.operationalLayerType==="IntegratedMeshLayer"&&this.viewSpatialReference!=null){const r=Dpe(i.fullExtent,this.viewSpatialReference);_(r)&&t.push(jW(r))}}),t}};function ZYe(t,e){return t===1?new uj(e):new hj(e)}u([d({readOnly:!0})],xl.prototype,"layerViewsExtent",null),u([d({readOnly:!0})],xl.prototype,"tiledLayersExtent",null),u([d({readOnly:!0})],xl.prototype,"stencilEnabledExtents",null),u([d()],xl.prototype,"viewSpatialReference",void 0),u([d()],xl.prototype,"tilingScheme",void 0),u([d()],xl.prototype,"defaultTiledLayersExtent",void 0),u([d({constructOnly:!0})],xl.prototype,"layers",void 0),u([d({constructOnly:!0})],xl.prototype,"layerViews",void 0),xl=u([R("esri.views.3d.terrain.ExtentHelper")],xl);let uj=class extends xl{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?Rre:QFe}};uj=u([R("esri.views.3d.terrain.ExtentHelperGlobal")],uj);let hj=class extends xl{_computeLayerViewsExtent(){const t=ja(),e=this.viewSpatialReference;this.layerViews.forEach(s=>{const n=s.layer;if(s.isResolved()&&(n.type!=="graphics"||!n.internal)){const o=Dpe("fullExtentInLocalViewSpatialReference"in s&&s.fullExtentInLocalViewSpatialReference||s.layer.fullExtent,e);Gp(t,o,t)}});const i=Y5(t)?t:null,r=this._get("layerViewsExtent");return qg(i,r)?r:i}_computeTiledLayersExtent(){const t=this.tilingScheme;if(!t)return null;const e=this.viewSpatialReference,i=ja();this.layers.forEach(n=>{if(n.loaded&&hA(n)){const o=jI(n,e,2);if(A(o))return;const{tileInfo:a,fullExtent:l}=o;(_(a)&&VI(n)&&_(l)||_(a)&&t.compatibleWith(a)&&_(l)&&l.spatialReference.equals(t.spatialReference))&&Gp(i,l,i)}}),Gp(i,this.defaultTiledLayersExtent,i);const r=Y5(i)?i:null,s=this._get("tiledLayersExtent");return qg(r,s)?s:r}};function Dpe(t,e){return _(t)&&!t.spatialReference.equals(e)?yJ(t,t.spatialReference,e):t}hj=u([R("esri.views.3d.terrain.ExtentHelperLocal")],hj);const Sv=[0,1],JYe=25,QYe=Ft(1e3/JYe),YYe=20,XYe=Ft(1e3/YYe);function Fpe(){var t;const e=(t=globalThis.require)==null?void 0:t.modules;if(e){const i=Object.keys(e);for(const r of i)r.search(".glsl")!==-1&&delete e[r]}}const KYe=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let Wm,An=class extends ve{constructor(t){super(t),this._handles=new dt,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Map,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._layerViewsDirty=!0,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=ae("esri-mobile")?2048:4096,this._animationTimeLast=0}get running(){return(this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||Kt.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return _(this._spatialReference)&&this._spatialReference.isGeographic&&!this.view.state.isLocal?Ut(this._spatialReference).metersPerDegree:1}get view(){return this.surface.view}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const t=this.view;this.renderer=new Rc({view:t,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=nl(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights")}),this.renderer.events.on("has-water",e=>{var i;return(i=t._stage)==null?void 0:i.renderView.setRenderParameters({hasOverlayWater:e})}),this.renderer.events.on("renders-occluded",()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded")}),this.renderer.events.on("content-changed",()=>this._setDrawTexturesDirty()),this.renderer.events.on("textures-disposed",()=>this.updateDrapeTargets()),t.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],()=>this.setPlacementDirty()),this.surface.on("elevation-change",()=>this.setPlacementDirty()),t.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0),t.watch("graphicsView",()=>this._layerViewsDirty=!0),t.on("resize",()=>this.setPlacementDirty()),gg({preRender:e=>{this._contentUpdated=!1,this.renderer.processSyncLayers(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchRendererUpdate(e),this._drawOverlayTextures(this.renderer.overlays,1)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),t.resourceController.scheduler.registerTask(Qe.OVERLAY,this),t._stage.renderView.events.on("force-camera-for-screenshot",e=>{this._updateOverlays(e,0),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,0,e)})]),this._updateLayerViews()}destroy(){this._drapeSources.forEach((t,e)=>this.unregisterDrapeSource(e)),this._drapeTargets.forEach(t=>this._unregisterDrapeTarget(t)),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),_(Wm)&&(Wm.hide(),Wm=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(t){this._spatialReference=t,this.renderer.spatialReference=t,this._longitudeCyclical=null;const e=this.view.renderSpatialReference;_(t)&&_(e)?(this._renderSR=e,this._overlaySREqualsRenderSR=t.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=t.isWebMercator?new zp(-20037508342787e-6,20037508342787e-6):new zp(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}_updateLayerViews(){if(!this._layerViewsDirty)return;const t=new Set;for(const i of this.view.allLayerViews.items)t.add(i.uid),"drapeSourceType"in i&&!this._drapeSources.has(i)&&this._registerDrapeSource(i,0),"drapeTargetType"in i&&!this._drapeTargets.has(i)&&this._registerDrapeTarget(i);const e=this.view.graphicsView;_(e)&&!this._drapeSources.has(e)&&(this._registerDrapeSource(e,0),t.add(e.uid)),this._drapeSources.forEach((i,r)=>{i!==0||t.has(r.uid)||this.unregisterDrapeSource(r)}),this._drapeTargets.forEach(i=>{t.has(i.uid)||this._unregisterDrapeTarget(i)}),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1}registerDrapeSource(t){this._registerDrapeSource(t,1)}_registerDrapeSource(t,e){this._drapeSources.set(t,e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this._updateDrapeSourceExtent(t),this._setContentDirty(),this.notifyChange("running")}_updateDrapeSourceExtent(t){this.renderer.overlays.length===2&&_(t.setDrapingExtent)&&_(this._spatialReference)&&t.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(t){this._drapeSources.has(t)&&(this._drapeSources.delete(t),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}_registerDrapeTarget(t){this._drapeTargets.add(t),this._updateDrapeTarget(t),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateDrapeTargets(){this._drapeTargets.forEach(t=>this._updateDrapeTarget(t))}_updateDrapeTarget(t){t.setDrapingTextures(this.renderer.overlays)}_unregisterDrapeTarget(t){this._drapeTargets.delete(t),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this._setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(){this._updateOverlays(this.view.state.camera,1)}_updateOverlays(t,e){if(!this._spatialReference)return;this._updateLayerViews();const i=WUe(t.fullWidth,t.fullHeight,this._maxResolution);this._computeOverlayExtents(t,i,sp);const r=Hh(sp.inner)/Hh(sp.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const s=this._updateOverlay(0,sp.inner,i,1*sp.pixelRatioAdjustment,sp.mapUnitsPerPixel),n=this._updateOverlay(1,sp.outer,i,r*sp.pixelRatioAdjustment,sp.mapUnitsPerPixel);s!==1&&n!==1||(this._drapeSources.forEach((o,a)=>this._updateDrapeSourceExtent(a)),this.surface.updateTileOverlayParams(e)),s===0&&n===0||this._setDrawTexturesDirty(),this._placementDirty=!1}_updateOverlay(t,e,i,r,s){if(this.renderer.overlays.length===0)return 0;const n=this.renderer.overlays[t],o=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=s,n.pixelRatio=r,eXe(e,n.extent)&&i===n.resolution)return o===s?0:2;Bp(n.extent,e),n.resolution=i;const a=X5(n.extent);return n.renderLocalOrigin=WT(a[0],a[1],0,"OV_"+this._latestOriginId++),1}setTileParameters(t){const e=t.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[0],r=this.renderer.overlays[1],s=uP(t.extent,this.surface.extent,Lpe);this._rectInsideRect(i.extent,s)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,0,e),this._setTileOverlayData(s,1,e)):(this._clearTileOverlayData(0,e),this._clearTileOverlayData(1,e))}else this._clearTileOverlayData(0,e),this._clearTileOverlayData(1,e)}overlayPixelSizeInMapUnits(t){if(this.renderer.overlays.length===0)return 0;const e=this.renderer.overlays[0],i=this.renderer.overlays[1],r=this._pointIsInExtent(t,e.extent)?e:i;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(t,e,i){if(this.renderer.overlays.length===0)return;const r=this.renderer.overlays[e].extent,s=Hh(r),n=Gg(r);let o=t[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(r[0],o);const a=this._longitudeCyclical.minimalMonotonic(r[0],t[2]);o>a&&(o=a-(t[2]-t[0]))}i.setScale(e,Hh(t)/s,Gg(t)/n),i.setOffset(e,(o-r[0])/s,(t[1]-r[1])/n)}_clearTileOverlayData(t,e){e.setScale(t,-1,-1),e.setOffset(t,-1,-1)}async reloadShaders(){Fpe(),await this.renderer.reloadShaders(),this._setDrawTexturesDirty(),this.runTask()}_dispatchRendererUpdate(t){const e=Ft(t.time-this._animationTimeLast);e<XYe&&A(this.forcedAnimationTime)||(this._animationTimeLast=t.time,this.renderer.updateLogic({dt:e,forcedTime:this.forcedAnimationTime,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0))}_setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this.setPlacementDirty()}_intersectGroundFromView(t,e,i,r){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(t,iXe,e,i);if(A(s))return!1;const n=s.origin,o=de(ZI,s.origin,s.direction);return this._groundIntersector.reset(n,o,t),this._groundIntersector.intersect([],null),this.view.basemapTerrain.intersect(this._groundIntersector,null,n,o),this._groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(t,e){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(t.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,a=Re(n.estimatedSurfaceAltitude,t.aboveGround?-1/0:s+o,t.aboveGround?s-o:1/0),l=t.aboveGround;if(this.view.viewingMode==="global"){const c=ZI;L1(KP(Ut(this.view.spatialReference).radius+a),Ko(t.eye,t.viewForward),c),ue(c,c,t.eye);const h=Vp.normalize(YSe(t.viewForward,c,t.viewRight))/t.fovY+.5,p=h<=0||h>=1?.5:r;i=l?p*h:h+p*(1-h)}else{const c=.5*Math.PI-Math.acos(-t.viewForward[2]),h=Math.tan(c),p=Bt(0,h,1,0),f=Va(p,p,t.projectionMatrix)[1],g=Re(.5+.5*f,0,1);i=g===1||g===0?.5:l?g*r:1-(1-g)*r}return!!this._intersectGroundFromView(t,.5,i,e)&&MF(e,t.eye)<n.distance*n.distance}_computeOverlayExtents(t,e,i){const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=$();this._findHorizonBasedPointOfInterest(t,s)||re(s,r);const n=Math.max(.1,qt(t.eye,s)),o=rm(this.view.renderCoordsHelper,r,t.eye),a=Math.PI/2-Math.abs(o-Math.PI/2);Kt.OVERLAY_SHOW_CENTER?(A(Wm)&&(Wm=new qm(this.view.graphics,"red")),Wm.show(s,this._renderSR)):_(Wm)&&Wm.hide(),this._overlaySREqualsRenderSR||Ns(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent,c=!this._isSpherical&&_(this._spatialReference)&&this._spatialReference.isGeographic,h=c&&_(this._spatialReference)?1/Ut(this._spatialReference).metersPerDegree:1,p=t.perRenderPixelRatio*n*h;i.mapUnitsPerPixel=p/this._worldToPCSRatio;let f=e*p/2,g=!1,y=c?90:1/0;this._isSpherical&&_(l)&&_(this._spatialReference)&&(this._spatialReference.isWebMercator?(f/=Math.cos(_M(s[1])),y=l[3]):(g=!0,f/=Ut(this._spatialReference).metersPerDegree,y=90),f>=y&&(f=y,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let v=1;g&&(v=1/Math.max(.2,Math.cos(Math.abs(nt(s[1])))),f*v>180&&(v=180/f),i.mapUnitsPerPixel*=v);const b=Math.log(2)/12;f=Math.exp(Math.round(Math.log(f)/b)*b);const w=f*v,S=32,T=.5*e/(S*w),C=.5*e/(S*f);s[0]=Math.round(s[0]*T)/T,s[1]=Math.round(s[1]*C)/C;const M=i.inner;M[0]=s[0]-w,M[1]=s[1]-f,M[2]=s[0]+w,M[3]=s[1]+f,this._isSpherical&&this._shiftExtentToFitBounds(M,1/0,y);const P=i.outer;if(6*w>Hh(l))Bp(P,at(l));else if(a<=.25*Math.PI)P[0]=M[0]-w,P[1]=M[1]-f,P[2]=M[2]+w,P[3]=M[3]+f;else{Ns(t.eye,this._renderSR,ZI,this._spatialReference),ku(Tv,s,ZI);let z=-Math.atan2(Tv[1],Tv[0])+.125*Math.PI;z<0&&(z+=2*Math.PI);const D=Math.floor(z/(.25*Math.PI));gx(Tv,KYe[D],2*f),Tv[0]*=v,Tv[2]*=v,$F(P,M,Tv)}if(this._isSpherical)P[0]=this._longitudeCyclical.clamp(P[0]),P[2]=this._longitudeCyclical.clamp(P[2]),P[1]=Math.max(P[1],-y),P[3]=Math.min(P[3],y);else{const z=uP(M,l,Lpe),D=uP(P,l,tXe);qW(z,D)&&(P[2]=P[0],P[3]=P[1])}const F=Math.abs(M[2]-M[0])/e;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,F),i.pixelRatioAdjustment=i.mapUnitsPerPixel/F}_drawOverlayTextures(t,e,i=this.view.state.camera){if(t.length===0||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const r=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const s=this._drawOverlay(t[0],i),n=this._drawOverlay(t[1],i);s!==0&&n!==0||this.surface.updateTileOverlayParams(1),this._collectUnusedRenderTargetMemory(),this.updateDrapeTargets(),r?(this.surface.requestRender(e),e===1&&this.surface.requestUpdate()):this.surface.requestRender(0)}_drawOverlay(t,e){return this._longitudeCyclical?t.setupGeometryViewsCyclical(this._longitudeCyclical):t.setupGeometryViewsDirect(),t.draw(this.renderer,e.pixelRatio)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const t=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(t)}}_rectanglesOverlap(t,e){return!A(t)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(e[0],e[2],t[0])||this._longitudeCyclical.contains(e[0],e[2],t[2])||this._longitudeCyclical.contains(t[0],t[2],e[0]))&&!(t[1]>e[3]||t[3]<e[1]):cP(t,e))}_rectInsideRect(t,e){return!A(e)&&(this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:qW(t,e))}_pointIsInExtent(t,e){if(this._longitudeCyclical)return this._longitudeCyclical.contains(e[0],e[2],t.x)&&t.y>=e[1]&&t.y<=e[3];const i=t.x,r=t.y;return i>e[0]&&i<e[2]&&r>e[1]&&r<e[3]}_shiftExtentToFitBounds(t,e,i){let r=0,s=0;t[0]<-e?r=t[0]+e:t[2]>e&&(r=e-t[2]),t[1]<-i?s=t[1]+i:t[3]>i&&(s=i-t[3]),hP(t,r,s)}get test(){return{renderer:this.renderer,update:()=>this.runTask()}}};function eXe(t,e){const i=1e-5,r=Kt.TESTS_DISABLE_OPTIMIZATIONS?0:i*Math.max(t[2]-t[0],t[3]-t[1],e[2]-e[0],e[3]-e[1]);return Math.abs(e[0]-t[0])<=r&&Math.abs(e[1]-t[1])<=r&&Math.abs(e[2]-t[2])<=r&&Math.abs(e[3]-t[3])<=r}u([d()],An.prototype,"_spatialReference",void 0),u([d({readOnly:!0})],An.prototype,"running",null),u([d()],An.prototype,"_placementDirty",void 0),u([d()],An.prototype,"_contentUpdated",void 0),u([d()],An.prototype,"_layerViewsDirty",void 0),u([d()],An.prototype,"_isSpherical",null),u([d()],An.prototype,"_worldToPCSRatio",null),u([d()],An.prototype,"renderer",void 0),u([d({constructOnly:!0})],An.prototype,"surface",void 0),u([d({readOnly:!0,aliasOf:"surface.suspended"})],An.prototype,"suspended",void 0),u([d({readOnly:!0})],An.prototype,"updating",null),u([d({type:Boolean})],An.prototype,"hasHighlights",null),u([d({type:Boolean})],An.prototype,"rendersOccluded",null),An=u([R("esri.views.3d.terrain.OverlayManager")],An);const Tv=Ot(),ZI=$(),sp={inner:pt(),outer:pt(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},Lpe=pt(),tXe=pt(),iXe=vs();class F3{constructor(e,i){this._factoryCallback=e,this._lengthCallback=i,this._pool=new Map}acquire(e){if(!F3.test.disabled){const i=this._pool.get(e);if(i&&i.length!==0)return i.pop()}try{return this._factoryCallback(e)}catch(i){const r=window.performance&&window.performance.memory;let s="";throw r&&(s=`
  totalJSHeapSize: ${r.totalJSHeapSize}, usedJSHeapSize: ${r.usedJSHeapSize}, jsHeapSizeLimit: ${r.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+i+s),i}}release(e){if(F3.test.disabled)return;const i=this._lengthCallback(e);let r=this._pool.get(i);r||(r=new ct({shrink:!0}),this._pool.set(i,r)),r.push(e)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}}F3.test={disabled:!1};const rXe=zr().vec3f("position").vec2f("uv0"),JI=new F3(t=>rXe.createBuffer(t),t=>t.count);class sXe{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=ii(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=Ot()}}class nXe{constructor(e,i,r){this.values=e,this.numSurfaceIndices=i,this.numSkirtIndices=r}}function oXe(){JI.clear(),dj.clear()}function aXe(t){JI.release(t.vertexAttributes),t.vertexAttributes=null,t.indices=null}const lXe=65536;function cXe(t,e,i,r,s,n,o,a){const l=s[0],c=s[1],h=s[2],p=s[3],f=.1*o.radius*(p-c),g=t.numVertsPerRow-1,y=t.numVertsPerRow-1,v=t.numVertsPerRow*t.numVertsPerRow,b=2*g+2*y,w=JI.acquire(v+b),S=w.position.typedBuffer,T=w.uv0.typedBuffer,C=r.geometryInfo.boundingBox;ii(C);const M=e[2]-e[0],P=e[3]-e[1],F=h-l,z=i[0],D=i[1],U=i[2];for(let V=0;V<=g;V++){const q=V/g,J=l+q*F;Vpe[V]=Math.sin(J),Npe[V]=Math.cos(J),Upe[V]=q,jpe[V]=e[0]+q*M}const G=n&&!!(1&a),k=n&&!!(2&a);let j=0;for(let V=0;V<=y;V++){let q=V/y;const J=Et(c,p,q),O=Math.cos(J),L=Math.sin(J);let N;n?(N=o.halfSemiMajorAxis*Math.log((1+L)/(1-L)),q=(N-e[1])/P):N=180*J/Math.PI;for(let B=0;B<=g;B++){const W=Upe[B],Y=Vpe[B],H=Npe[B];let K=o.radius;t.samplerData&&(K+=WI.sample(jpe[B],N,t.samplerData)||0);const fe=H*O*K-z,ce=Y*O*K-D,me=L*K-U;pj(fe,ce,me,C);const Ie=uE*j;S[Ie+0]=fe,S[Ie+1]=ce,S[Ie+2]=me,T[Ie+0]=W,T[Ie+1]=q;const He=fj(B,V,g,y);if(He>-1){const $e=uE*(v+He),Le=G&&V===0?-1:k&&V===y?1:0,Ei=Le===0?fe:-z,rr=Le===0?ce:-D,Or=Le===0?me:o.radius*Le-U;S[$e+0]=Ei,S[$e+1]=rr,S[$e+2]=Or,T[$e+0]=Le===0?zpe(W,q):W,T[$e+1]=Le===0?f:q,Le!==0&&pj(Ei,rr,Or,C)}++j}}r.geometryInfo.numVertsPerRow=t.numVertsPerRow,r.geometryInfo.vertexAttributes=w,r.geometryInfo.skirtLength=f,Ls(r.geometryInfo.uvOffsetAndScale,0,0,1,1),kpe(r.geometryInfo,t.numVertsPerRow,n?a:0,t.wireframe),r.intersectionData=null,r.skirtIntersectionData=null}function uXe(t,e,i,r,s){const n=e[0],o=e[1],a=e[2]-n,l=e[3]-o,c=t.clippingArea,h=_(c)?Math.max(0,(c[0]-e[0])/a):0,p=_(c)?Math.max(0,(c[1]-e[1])/l):0,f=_(c)?Math.min(1,(c[2]-e[0])/a):1,g=_(c)?Math.min(1,(c[3]-e[1])/l):1,y=f>h?1/(f-h):1,v=g>p?1/(g-p):1,b=-h*y,w=-p*v,S=a*r*.1,T=t.numVertsPerRow-1,C=t.numVertsPerRow-1,M=t.numVertsPerRow*t.numVertsPerRow,P=2*T+2*C,F=JI.acquire(M+P),z=F.position.typedBuffer,D=F.uv0.typedBuffer,U=s.geometryInfo.boundingBox;ii(U);let G=0;for(let k=0;k<=C;k++){const j=k/C;let V=w+j*v,q=o+j*l;_(c)&&(q<c[1]?(q=c[1],V=0):q>c[3]&&(q=c[3],V=1));for(let J=0;J<=T;J++){const O=J/T;let L=b+O*y,N=n+O*a;_(c)&&(N<c[0]?(N=c[0],L=0):N>c[2]&&(N=c[2],L=1));const B=t.samplerData&&WI.sample(N,q,t.samplerData)||0,W=N*r-i[0],Y=q*r-i[1],H=B-i[2];pj(W,Y,H,U);const K=uE*G;z[K+0]=W,z[K+1]=Y,z[K+2]=H,D[K+0]=L,D[K+1]=V;const fe=fj(J,k,T,T);if(fe>-1){const ce=uE*(M+fe);z[ce+0]=W,z[ce+1]=Y,z[ce+2]=H,D[ce+0]=zpe(L,V),D[ce+1]=S}++G}}s.geometryInfo.numVertsPerRow=t.numVertsPerRow,s.geometryInfo.vertexAttributes=F,s.geometryInfo.skirtLength=S,Ls(s.geometryInfo.uvOffsetAndScale,h,p,f-h,g-p),kpe(s.geometryInfo,t.numVertsPerRow,0,t.wireframe),s.intersectionData=null,s.skirtIntersectionData=null}const dj=new Map;function kpe(t,e,i,r){const s=(2&i)>0,n=e+(r?1024:0)+(s?2048:0);let o=dj.get(n);o||(o=hXe(e,s,r),dj.set(n,o)),t.indices=o.values,t.numSurfaceIndices=o.numSurfaceIndices,t.numSkirtIndices=o.numSkirtIndices,t.numWithoutSkirtIndices=t.numSurfaceIndices+(i?6*(e-1)*(r?2:1):0)}function hXe(t,e,i){const r=t-1,s=t-1,n=t*t,o=2*r+2*s;let a=r*s*2*3,l=6*o,c=6*(2*r+s-1);i&&(a*=2,l*=2,c*=2);const h=n+o>lXe?new Uint32Array(a+l):new Uint16Array(a+l);let p,f,g,y,v=0,b=0,w=a,S=0;for(let T=0;T<=s;T++){e&&(S=T===0?c:T===s?-c:0),w+=S;for(let C=0;C<=r;C++){const M=fj(C,T,r,s);if(M>-1){const P=dXe(C,T,r,s);P!==0&&(p=v,f=n+M,g=n+(C===0&&T===1?0:M+1),y=v+P,i?(h[w+0]=p,h[w+1]=f,h[w+2]=f,h[w+3]=g,h[w+4]=g,h[w+5]=p,h[w+6]=g,h[w+7]=y,h[w+8]=y,h[w+9]=p,h[w+10]=p,h[w+11]=g,w+=12):(h[w+0]=p,h[w+1]=f,h[w+2]=g,h[w+3]=g,h[w+4]=y,h[w+5]=p,w+=6))}++v,C<r&&T<s&&(p=T*(r+1)+C,f=p+1,g=f+(r+1),y=g-1,i?(h[b+0]=p,h[b+1]=f,h[b+2]=f,h[b+3]=g,h[b+4]=g,h[b+5]=p,h[b+6]=g,h[b+7]=y,h[b+8]=y,h[b+9]=p,h[b+10]=p,h[b+11]=g,b+=12):(h[b+0]=p,h[b+1]=f,h[b+2]=g,h[b+3]=g,h[b+4]=y,h[b+5]=p,b+=6))}w-=S}return new nXe(h,a,l)}function pj(t,e,i,r){t<r[0]&&(r[0]=t),t>r[3]&&(r[3]=t),e<r[1]&&(r[1]=e),e>r[4]&&(r[4]=e),i<r[2]&&(r[2]=i),i>r[5]&&(r[5]=i)}function zpe(t,e){const i=e>t?1:0;return 2+4*i+(1-2*i)*(t+e)}function fj(t,e,i,r){return e===0?t:t===i?i+e:e===r?i+r+(i-t):t===0&&e>0?2*i+r+(r-e):-1}function dXe(t,e,i,r){return e===0&&t!==i?1:t===i&&e!==r?i+1:e===r&&t!==0?-1:t===0&&e!==0?-(i+1):0}function pXe(t,e,i,r,s,n,o,a,l,c){const h=n.position,p=n.uv0,f=t[0],g=t[1],y=t[2],v=e[0]-f,b=e[1]-g,w=e[2]-y;r*=3;for(let S=i*=3;S<r;S+=3){const T=s[S],C=s[S+1],M=s[S+2];let P=h.get(T,0),F=h.get(T,1),z=h.get(T,2),D=h.get(C,0),U=h.get(C,1),G=h.get(C,2),k=h.get(M,0),j=h.get(M,1),V=h.get(M,2);if(p.get(T,0)>=2){const Or=P+a[0],us=F+a[1],yr=z+a[2],Rr=o/Math.sqrt(Or*Or+us*us+yr*yr);P+=Or*Rr,F+=us*Rr,z+=yr*Rr}if(p.get(C,0)>=2){const Or=D+a[0],us=U+a[1],yr=G+a[2],Rr=o/Math.sqrt(Or*Or+us*us+yr*yr);D+=Or*Rr,U+=us*Rr,G+=yr*Rr}if(p.get(M,0)>=2){const Or=k+a[0],us=j+a[1],yr=V+a[2],Rr=o/Math.sqrt(Or*Or+us*us+yr*yr);k+=Or*Rr,j+=us*Rr,V+=yr*Rr}_(l)&&([P,F,z]=l.applyToVertex(P,F,z),[D,U,G]=l.applyToVertex(D,U,G),[k,j,V]=l.applyToVertex(k,j,V));const q=D-P,J=U-F,O=G-z,L=k-P,N=j-F,B=V-z,W=b*B-N*w,Y=w*L-B*v,H=v*N-L*b,K=q*W+J*Y+O*H;if(Math.abs(K)<=Number.EPSILON)continue;const fe=f-P,ce=g-F,me=y-z,Ie=fe*W+ce*Y+me*H;if(K>0){if(Ie<0||Ie>K)continue}else if(Ie>0||Ie<K)continue;const He=ce*O-J*me,$e=me*q-O*fe,Le=fe*J-q*ce,Ei=v*He+b*$e+w*Le;if(K>0){if(Ei<0||Ie+Ei>K)continue}else if(Ei>0||Ie+Ei<K)continue;const rr=(L*He+N*$e+B*Le)/K;rr>=0&&c(rr,RT(q,J,O,L,N,B,Bpe))}}function fXe(t,e,i,r,s,n){const o=r.position,a=r.uv0,l=new Map,c=3*e,h=3*i-c,p=new Uint32Array(h);let f=0;for(let y=0;y<h;++y){const v=t[y+c];if(l.has(v))p[y]=l.get(v);else{const b=f++;l.set(v,b),p[y]=b}}const g=new Float64Array(3*f);return l.forEach((y,v)=>{let b=o.get(v,0),w=o.get(v,1),S=o.get(v,2);if(a.get(v,0)>=2){const T=b+n[0],C=w+n[1],M=S+n[2],P=s/Math.sqrt(T*T+C*C+M*M);b+=T*P,w+=C*P,S+=M*P}g[3*y+0]=b,g[3*y+1]=w,g[3*y+2]=S}),{vertices:g,indices:p}}function mXe(t,e,i,r,s,n,o,a,l){const c=n.position,h=n.uv0,p=t[0],f=t[1],g=t[2],y=e[0]-p,v=e[1]-f,b=e[2]-g;r*=3;for(let w=i*=3;w<r;w+=3){const S=s[w],T=s[w+1],C=s[w+2];let M=c.get(S,0),P=c.get(S,1),F=c.get(S,2),z=c.get(T,0),D=c.get(T,1),U=c.get(T,2),G=c.get(C,0),k=c.get(C,1),j=c.get(C,2);h.get(S,0)>=2&&(F+=o),h.get(T,0)>=2&&(U+=o),h.get(C,0)>=2&&(j+=o),_(a)&&([M,P,F]=a.applyToVertex(M,P,F),[z,D,U]=a.applyToVertex(z,D,U),[G,k,j]=a.applyToVertex(G,k,j));const V=z-M,q=D-P,J=U-F,O=G-M,L=k-P,N=j-F,B=v*N-L*b,W=b*O-N*y,Y=y*L-O*v,H=V*B+q*W+J*Y;if(Math.abs(H)<=Number.EPSILON)continue;const K=p-M,fe=f-P,ce=g-F,me=K*B+fe*W+ce*Y;if(H>0){if(me<0||me>H)continue}else if(me>0||me<H)continue;const Ie=fe*J-q*ce,He=ce*V-J*K,$e=K*q-V*fe,Le=y*Ie+v*He+b*$e;if(H>0){if(Le<0||me+Le>H)continue}else if(Le>0||me+Le<H)continue;const Ei=(O*Ie+L*He+N*$e)/H;Ei>=0&&l(Ei,RT(V,q,J,O,L,N,Bpe))}}const Vpe=new Array(TS+1),Npe=new Array(TS+1),Upe=new Array(TS+1),jpe=new Array(TS+1),Bpe=$();class Gpe{constructor(){this._queue=new ct,this._last=null,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=null}reset(e=null){this._queue.clear(),_(e)&&this._queue.pushArray(e),this._last=null}skipSubtree(){this._last=null}next(){return this._last&&!this._last.isLeaf&&this._queue.pushArray(this._last.children),this._last=this._queue.pop(),this._last}}class gXe{constructor(){this.q=new ct}get done(){return this.q.length===0}reset(e){if(this.q.clear(),!A(e)){this.q.pushArray(e);for(let i=0;i<this.q.length;++i){const r=this.q.data[i];r.isLeaf||this.q.pushArray(r.children)}}}next(){return this.q.pop()}}function L3(t,e,i){if(A(e)||A(e.fullExtent))return!1;const r=e.fullExtent,s=t.extent;if(i){if(s[0]<r.xmin||s[1]<r.ymin||s[2]>r.xmax||s[3]>r.ymax)return!1}else if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const n=t.surface.tilingScheme.levels[t.level].scale;return!(e.minScale>0&&n>1.00000001*e.minScale)&&!(e.maxScale>0&&n<.99999999*e.maxScale)}function qpe(t,e){e.sort((i,r)=>Hpe(i,r,t))}function Hpe(t,e,i){const r=t.screenDepth,s=e.screenDepth;return r<s?-i:r>s?i:0}function yXe(t,e){const i=new Map;t.forAll(r=>i.set(r,r.distanceToSquared(e))),t.sort((r,s)=>i.get(r)-i.get(s))}function vXe(t,e,i){let r=1,s=0,n=0;for(;t!==e;)if(r*=.5,s*=.5,n*=.5,1&t.lij[2]&&(s+=.5),(1&t.lij[1])==0&&(n+=.5),(t=t.parent)==null)throw new Error("tile was not a descendant of upsampleTile");i.init(e,s,n,r)}function _Xe(t){for(let e=0;e<t.length;e++){const i=t[e],r=i.parent;if(r)for(let s=0;s<4;s++){const n=r.children[s];if(n&&n!==i&&n.loadable)return!0}}return!1}function tlt(t,e){if(!t||!e||t[0]===e[0])return!1;const i=t[0]<e[0],r=i?t:e,s=i?e:t,n=1<<s[0]-r[0];return Math.floor(s[1]/n)===r[1]&&Math.floor(s[2]/n)===r[2]}class mj{get updating(){return!!this._tileRequested}init(e,i,r,s){this.tile=e,this._layerIdx=i,this._layerClass=r,this._suspended=s,this._tileLayerInfo=e.getLayerInfo(i,r),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,0):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return _(e)?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,i=this._layerClass,r=this.tile.surface.layerViewByIndex(e,i),s=nj(r),{minLevel:n,maxLevel:o}=r.dataLevelRange,a=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+a,c=this._scaleRangeEnabled?L3:()=>!0;let h=this.tile;const p=h.level;let f;const g=this._tileLayerInfo.upsampleInfo,y=g?g.tile.level:-1,v=or(s,"tilemapCache");for(;h&&c(h,s,!1)&&h.level>=n;){const b=h.level,w=p-b,S=h.layerInfo[i][e];if(S.data&&w>=a){b>y&&this._setUpsampleTile(h),S.dataInvalidated&&(f=h);break}if((A(v)||v.getAvailability(h.lij[0],h.lij[1],h.lij[2])!=="unavailable")&&b<=o&&!S.data&&!S.dataMissing&&((A(f)||h.level===n||b%Ore==0||p-f.level<a)&&(f=h),w>=l))break;h=h.parent}return _(f)&&p-f.level<a&&this._tileLayerInfo.upsampleInfo&&(f=null),f}_findAncestorWithData(){const e=this.tile.vlevel,i=this._desiredMinLevelDelta;let r;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(e-s.level>=i)return s;r=s}return r}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,0)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}class bXe extends mj{get _desiredMinLevelDelta(){throw Wpe}get _progressiveLevelModulo(){throw Wpe}dispose(){}}const Wpe=new Error("Abstract method called on TileAgent"),zo=new bXe;class Zpe extends mj{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return cE(this.tile.level)-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}class Jpe extends mj{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return Ore}}function wXe(t,e,i="nearest",r=!1){var s;const n=!(r&&e.pixelType==="u8"),o=n?5126:5121,a=e.pixels==null||e.pixels.length===0?null:n?e.getAsRGBAFloat():e.getAsRGBA(),l=(s=t.capabilities.textureFloat)==null?void 0:s.textureFloatLinear,c={width:e.width,height:e.height,target:3553,pixelFormat:6408,internalFormat:t.webglVersion==="webgl2"&&n?34836:6408,samplingMode:!l||i!=="bilinear"&&i!=="cubic"?9728:9729,dataType:o,wrapMode:33071,flipped:!1};return new qe(t,c,a)}function xXe(t,e){const i=4*e.size[0],r=e.size[1],s={width:i,height:r,target:3553,pixelFormat:6408,internalFormat:t.webglVersion==="webgl2"?34836:6408,dataType:5126,samplingMode:9728,wrapMode:33071,flipped:!1},n=new Float32Array(i*r*4);let o=0;for(let a=0;a<e.coefficients.length;a++)n[o++]=e.coefficients[a],a%3==2&&(n[o++]=1);return new qe(t,s,n)}function Qpe(t,e){const i={width:e.length/4,height:1,target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,flipped:!1};return new qe(t,i,e)}function SXe(t,e,i,r=1,s=!0,n=!1){return{u_flipY:s,u_isFloatTexture:n,u_applyTransform:!!t,u_opacity:r,u_transformSpacing:t?t.spacing:null,u_transformGridSize:t?t.size:null,u_targetImageSize:e,u_srcImageSize:i}}function TXe(t,e){return{u_colormapOffset:e||0,u_colormapMaxIndex:t?t.length/4-1:null}}function CXe(t,e){return{u_scale:t,u_offset:e}}function MXe(t){return{u_bandCount:t.bandCount,u_minOutput:t.outMin,u_maxOutput:t.outMax,u_minCutOff:t.minCutOff,u_maxCutOff:t.maxCutOff,u_factor:t.factor,u_useGamma:t.useGamma,u_gamma:t.gamma,u_gammaCorrection:t.gammaCorrection}}function PXe(t){return{u_hillshadeType:t.hillshadeType,u_sinZcosAs:t.sinZcosAs,u_sinZsinAs:t.sinZsinAs,u_cosZs:t.cosZs,u_weights:t.weights,u_factor:t.factor,u_minValue:t.minValue,u_maxValue:t.maxValue}}function AXe(t,e){const i=t.gl,r=e.glName,s=i.getProgramParameter(r,i.ACTIVE_UNIFORMS),n=new Map;let o;for(let a=0;a<s;a++)o=i.getActiveUniform(r,a),o&&n.set(o.name,{location:i.getUniformLocation(r,o.name),info:o});return n}function k3(t,e,i){Object.keys(i).forEach(r=>{const s=e.get(r)||e.get(r+"[0]");s&&$Xe(t,r,i[r],s)})}function $Xe(t,e,i,r){if(r===null||i==null)return!1;const{info:s}=r;switch(s.type){case 5126:s.size>1?t.setUniform1fv(e,i):t.setUniform1f(e,i);break;case 35664:t.setUniform2fv(e,i);break;case 35665:t.setUniform3fv(e,i);break;case 35666:t.setUniform4fv(e,i);break;case 35675:t.setUniformMatrix3fv(e,i);break;case 35676:t.setUniformMatrix4fv(e,i);break;case 5124:s.size>1?t.setUniform1iv(e,i):t.setUniform1i(e,i);break;case 35670:t.setUniform1i(e,i?1:0);break;case 35667:case 35671:t.setUniform2iv(e,i);break;case 35668:case 35672:t.setUniform3iv(e,i);break;case 35669:case 35673:t.setUniform4iv(e,i);break;default:return!1}return!0}const Ype={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class Xpe{constructor(e,i,r=null,s=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=e,this.source=i,this.width=r||i.width,this.height=s||i.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null)}get symbolizerParameters(){return this.isRendereredSource?he(E({},Ype),{maxCutOff:[1,1,1],factor:[1,1,1]}):this._symbolizerParameters||Ype}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){_(e)&&e.length>0?this._bandIds&&e.every((i,r)=>!!this._bandIds[r]&&i===this._bandIds[r])||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture){const i=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(i==="bilinear"?9729:9728)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(e,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(e),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=xXe(e,this.transformGrid))),!0)}getUniforms(){const e=CXe(this.scale,this.offset),{symbolizerParameters:i,transformGrid:r,width:s,height:n,opacity:o}=this;return{basic:e,common:SXe(r,[s,n],[this.source.width,this.source.height],o),colormap:i.colormap?TXe(i.colormap,i.colormapOffset):null,stretch:this.symbolizerParameters.type==="stretch"?MXe(this.symbolizerParameters):null,hillshade:this.symbolizerParameters.type==="hillshade"?PXe(this.symbolizerParameters):null}}getTextures(){const e=new Array,i=[];return this._rasterTexture&&(i.push(this._rasterTexture),e.push("u_image"),this._transformGridTexture&&(i.push(this._transformGridTexture),e.push("u_transformGrid")),this._colormapTexture&&(i.push(this._colormapTexture),e.push("u_colormap"))),{names:e,textures:i}}get memoryUsage(){if(A(this._memoryUsed)){const e=this.getTextures();if(e==null)return 0;this._memoryUsed=e.textures.map(i=>i.descriptor.width*i.descriptor.height*4).reduce((i,r)=>i+r,0)}return this._memoryUsed}release(){return this._rasterTexture=Ge(this._rasterTexture),this._transformGridTexture=Ge(this._transformGridTexture),this._colormapTexture=Ge(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,i){const r=this.source?this.source.extractBands(i):null;if(!(r&&r.pixels&&r.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const s=A(i)&&A(this.bandIds)||_(i)&&_(this.bandIds)&&i.join("")===this.bandIds.join("");if(this._rasterTexture){if(s)return;this._rasterTexture.dispose(),this._rasterTexture=null}const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=wXe(e,r,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"?"nearest":"bilinear"}_updateColormapTexture(e){const i=this._colormap,r=this.symbolizerParameters.colormap;return r?i?r.length!==i.length||r.some((s,n)=>s!==i[n])?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=Qpe(e,r),void(this._colormap=r)):void 0:(this._colormapTexture=Qpe(e,r),void(this._colormap=r)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}class QI{constructor(){this.waitingAgents=new ct,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const i=gj.acquire();return i._init(e),i}release(){this.dispose(),YI.delete(this),gj.release(this)}dispose(){this.loadingAgent=Ge(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=ow(this._data)}static prune(){gj.prune(0)}_init(e){this.waitingAgents.clear(),this._data=ow(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=Rl(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,i){if(e===i||A(i))this._unsetUpsampleInfo();else{if(this._upsampleInfo==null)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===i)return;this._upsampleInfo.tile.unrefMapData()}i.refMapData(),vXe(e,i,this._upsampleInfo)}}get data(){return this._data}set data(e){ow(this._data),this._data=e}}const gj=new Xi(QI,null,()=>{}),YI=new Map;function EXe(){YI.size>0&&(console.log(`${YI.size} live TilePerLayerInfo allocations:`),YI.forEach(t=>console.log(t,`
`)))}class Zm{constructor(e){this._texture=e,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}}const yj=$(),cw=$(),cs=$(),OXe=.1;class RXe{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}}class vj{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=pt(),this._elevationBounds=ke(),this.layerInfo=[[],[]],this.extentInRadians=pt(),this.centerAtSeaLevel=$(),this._center=[$(),rs(),$()],this.up=xF(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=z3,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0}static prune(){_j.prune(0),bj.prune(0),QI.prune()}get usedMemory(){return this._usedMemory===z3&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){this._usedMemory===z3&&this._updateMemoryUsed();let e=this._mapTileMemory;for(const{data:i}of this.layerInfo[1])i instanceof HI&&(e+=i.memoryUsage);return e}get isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get screenDepth(){return this._screenDepth}get visible(){return this._dirty&&this.updateVisibilityNow(),this._visible}updateVisibilityNow(){this._dirty=!1;const e=this._intersectsClippingArea&&this._isVisible(this.surface.frustum);return e!==this._visible&&(this._visible=e,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender(),this.updateAgentSuspension()),this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setNeedsRender()),e}get shouldLoad(){if(!this.loadable)return!1;if(this._surface.lodSnapping===1){const e=this.level-this._surface.snapLevel;if(e===0)return!0;if(e===1)return!1}return this.isLeaf}init(e,i,r){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=Ut(r.tilingScheme.spatialReference),r.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),r.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,r.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.vlevel=e?e[0]:0,i&&i.elevationBounds?os(this._elevationBounds,i.elevationBounds):si(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=i,this.unsetChildren(),this._surface=r,this.updateVisibility();for(const s of Sv){const n=r.numLayers(s),o=this.layerInfo[s];for(const a of o)a.release();o.length=n;for(let a=0;a<n;a++)o[a]=QI.acquire(this._surface.upsampleInfoPool),s===0&&this.findElevationBoundsForLayer(a,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(r.tilingScheme.pixelSize,TS)}release(){Vc(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of Sv){for(const i of this.layerInfo[e])i.release();this.layerInfo[e].length=0}this._parent=null,this._surface=null,this._usedMemory=z3}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this.isCached){const e=this.cachedMemory;e>0&&(this._surface.upsampleMapCache.put(this.key,this,e),this.setMemoryDirty())}}setMemoryDirty(){this._usedMemory=z3}get cpuImageMemorySize(){const e=4,i=this._surface.tilingScheme.pixelSize;return i*i*e}_updateMemoryUsed(){this._usedMemory=0,this._mapTileMemory=0;const e=this.cpuImageMemorySize;for(const{data:i}of this.layerInfo[1])i instanceof Zm?this._mapTileMemory+=Gf(i.texture):i instanceof HTMLImageElement||i instanceof O3?this._mapTileMemory+=e:i instanceof Xpe&&(this._mapTileMemory+=i.memoryUsage);for(const i of this.layerInfo[0])this._usedMemory+=i.data?e:0;this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=Gf(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this.cachedMemory)}getUsedMemoryForLayer(e,i){const r=this.layerInfo[e][i];if(!r||!r.data)return 0;if(e!==1||this.isCached){if(e===0)return this.cpuImageMemorySize}else{const s=r.data;if(s instanceof Zm)return Gf(s.texture);if(s instanceof HTMLImageElement||s instanceof O3)return this.cpuImageMemorySize;if(s instanceof HI||s instanceof Xpe)return s.memoryUsage}return 0}updateScreenDepth(e){const i=this._center[1],r=e,s=i[0],n=i[1],o=i[2],a=r[2]*s+r[6]*n+r[10]*o+r[14];this._screenDepth=a<0?0:a/(r[3]*s+r[7]*n+r[11]*o+r[15])}shouldSplit(e,i,r){if(_(e.frustum)&&(!this._intersectsClippingArea||!this._isVisible(e.frustum)))return 0;const s=this.level;ue(yj,this._center[1],i);let n=un(yj),o=1;ue(cw,this._center[0],i);const a=un(cw);a<n&&(n=a,o=0),ue(cw,this._center[2],i);const l=un(cw);if(l<n&&(n=l,o=2),this._edgeLen2>n&&s<e.maxLod)return 2;const c=Math.sqrt(n),h=e.fovX*c*2,p=this._edgeLen/h,f=()=>{const b=s+Math.ceil(-Math.log2(e.relativeWidthLimit/p));return b!==this.vlevel?(this.vlevel=b,4):1};if(r===1&&this._surface.snapLevel-s==1)return s>=e.maxLod?f():2;const g=ye(this.up,yj),y=this._elevationBounds[1]-this._elevationBounds[0],v=y/this.edgeLen;if(e.aboveGround&&g>0&&v<.001&&g/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-v>0)return 0;if(p<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,4):0;if(s>=e.maxLod)return f();if(s>6){ue(cw,this._center[o],i),se(cs,this.up,g),ue(cs,cs,cw);const b=un(cs);if(b>this.radius*this.radius){se(cs,cs,this.radius/Math.sqrt(b)),de(cs,cs,this._center[o]),ue(cs,i,cs);const w=Math.min(1,(Math.abs(ye(cs,this.up))+.5*y+this._curvatureHeight)/Te(cs)),S=OXe/e.angledSplitBias,T=e.fovY*c*2;if(w*(this._edgeLen/T)<S*e.relativeHeightLimit)return 0}}return 2}setChildren(e,i,r,s){Vc(!!(e&&i&&r&&s),"Null child passed"),this._children[0]=e,this._children[1]=i,this._children[2]=r,this._children[3]=s}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}load(e){this.refMapData();for(const i of Sv)this._createOrUpdateAgents(0,i);e.loadTile(this)}unload(e){e.unloadTile(this);for(const i of Sv){const r=this.layerInfo[i];for(const s of r)s.loadingAgent&&s.loadingAgent!==zo&&(XI(s.loadingAgent),s.loadingAgent=null),s.pendingUpdates=0}this.resetPendingUpdate(32),this.resetPendingUpdate(64),this.resetPendingUpdate(128),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[1];for(const i of e)i.loadingAgent&&i.loadingAgent!==zo&&(XI(i.loadingAgent),i.loadingAgent=null),i.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(qg(e,this._clippingArea))return!1;const i=this._intersectsClippingArea,r=this._isWithinClippingArea;_(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const s=r&&this._isWithinClippingArea,n=!(r||i||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||s||n||this.setPendingUpdate(32),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,i){return this.layerInfo[i][e]}hasLayerData(e,i){const r=this.layerInfo[i][e];return!(!r||!r.data||r.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of Sv){const i=this.layerInfo[e];for(const r of i)if(r.loadingAgent&&r.loadingAgent!==zo&&r.loadingAgent.updating)return!0}return!1}isSuspended(e){return!!this.hasPendingUpdate(2)||e!==0&&!this.loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,e===2||e===8?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,i,r){const s=this.layerInfo[i][e];if(s.waitingAgents.has(r))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),i,e),!0;if(s.waitingAgents.push(r),s.data&&!s.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),i,e),r.dataArrived(this),!0;if(s.requestPromise)return!0;Rl(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,e,i,s.requestAbort);if(!n)return s.requestAbort=null,!1;const o=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(o,o),!0}get isLeaf(){return this._children[0]==null}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){return this.hasLij(e)?this:this.isLeaf?null:this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e)||null}distanceToSquared(e){return un(ue(cs,this._center[1],e))}containsPoint(e){const i=this.extent;return e[0]>=i[0]&&e[1]>=i[1]&&e[0]<=i[2]&&e[1]<=i[3]}unrequestLayerData(e,i,r){const s=this.layerInfo[i][e],n=s.waitingAgents,o=n.removeUnordered(r)!=null;Vc(o,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this._updateMemoryUsed())}dataArrived(e,i,r){const s=this.layerInfo[i][e];s.data=r,s.dataInvalidated=!1,s.waitingAgents.forAll(n=>n.dataArrived(this)),s.waitingAgents.clear(),this._updateMemoryUsed()}dataMissing(e,i,r){r.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${i}/${e} error ${r}`);const s=this.layerInfo[i][e];s.dataMissing=!0,s.waitingAgents.forAll(n=>n.dataMissing()),s.waitingAgents.clear(),this._updateMemoryUsed()}updateRenderData(e,i){switch(e){case 1:return this.updateTexture(i);case 0:return this.updateGeometry()}}updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===0?64:128),this.setPendingUpdate(e===0?128:64))}updateGeometry(){this.setPendingUpdate(32);for(const e of this.layerInfo[0])e.pendingUpdates|=32}invalidateLayerData(e,i){this.layerInfo[i][e].invalidateSourceData(),this.restartAgents(i)}computeElevationBounds(){si(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const e=this.layerInfo[0];let i=!0;for(const r of e)_(r.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],r.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],r.elevationBounds.max),r.elevationBounds.hasNoDataValues||(i=!1));i&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()}_updateCenter(){const e=.5*(this._elevationBounds[0]+this._elevationBounds[1]);se(cs,this.up,e),de(this._center[1],this.centerAtSeaLevel,cs),se(cs,this.up,this._elevationBounds[0]),de(this._center[0],this.centerAtSeaLevel,cs),se(cs,this.up,this._elevationBounds[1]),de(this._center[2],this.centerAtSeaLevel,cs)}findElevationBoundsForLayer(e,i){const r=this.layerInfo[0][e];if(_(r.elevationBounds)&&r.elevationBounds.level>=i)return;const s=this._surface.layerViewByIndex(e,0),n=nj(s);if(!L3(this,n,!1))return;const o=DXe;let a=!1;if(r.data){const l=r.data;o.min=l.bounds[0],o.max=l.bounds[1],o.hasNoDataValues=l.hasNoDataValues,o.level=this.lij[0],a=!0}else{let l,c,h=0;for(let p=this._parent;p&&(!c||h<cE(this.level))&&(h=this.vlevel-p.level,l=c||l,c=p.layerInfo[0][e].data,!(!c&&l&&h>=cE(this.level)));p=p.parent);c=c||l,c&&(c.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],o),o.min!==1/0&&(o.level=c.level,a=!0))}a&&(A(r.elevationBounds)&&(r.elevationBounds=new cj),r.elevationBounds.copyFrom(o))}modifyLayers(e,i,r){const s=this.layerInfo[r];for(const a of s)a.loadingAgent&&a.loadingAgent!==zo&&(XI(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<s.length;++a)e[a]===void 0&&s[a].release();const n=new Array(...s),o=i.length;s.length=o;for(let a=0;a<o;a++){const l=i[a];s[a]=l>-1?n[l]:QI.acquire(this._surface.upsampleInfoPool)}this._updateMemoryUsed()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,0))}updateAgents(e){if(this.renderData){const i=this.layerInfo[e];for(const r of i)r.loadingAgent===zo&&(r.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of Sv){const i=this.isSuspended(e);for(const r of this.layerInfo[e])r.loadingAgent&&r.loadingAgent!==zo&&(r.loadingAgent.setSuspension(i),r.loadingAgent===zo&&this.updateRenderData(e,0))}}removeLayerAgent(e,i){const r=this.layerInfo[i][e];r.loadingAgent&&r.loadingAgent!==zo&&r.loadingAgent.dispose(),r.loadingAgent=null}agentDone(e,i){const r=this.layerInfo[i][e];r.loadingAgent=zo,r.data||r.upsampleInfo||this._createOrUpdateAgents(e+1,i)}_createOrUpdateAgents(e,i){const r=this.isSuspended(i),s=this.layerInfo[i];for(let n=e;n<s.length;++n){const o=s[n];let a=!1;const l=this._surface.layerViewByIndex(n,i),c=nj(l);if(o.loadingAgent?L3(this,c,!1)?(o.loadingAgent!==zo&&o.loadingAgent.setSuspension(r),o.loadingAgent!==zo&&(a=o.loadingAgent.update())):o.dispose():L3(this,c,!1)&&(o.loadingAgent=IXe(this,n,i,r),a=o.loadingAgent.startLoading(),a?o.loadingAgent===zo&&this.setPendingUpdate(32):(XI(o.loadingAgent),o.loadingAgent=zo)),o.loadingAgent===zo&&this.updateRenderData(i,0),a&&l.isOpaque)return}}_isWithinExtent(e){const i=this.extent;return i[0]>=e[0]&&e[2]>=i[2]&&i[1]>=e[1]&&e[3]>=i[3]}intersectsExtent(e){const i=this.extent;return i[2]>=e[0]&&e[2]>=i[0]&&i[3]>=e[1]&&e[3]>=i[1]}getElevationBasedVerticesPerRow(e){const i=this.vlevel-this.level,r=Math.max(this.level-e,cE(this.level)-i);return Re(1+(this.maxTesselation>>r),2,this.maxTesselation+1)}get test(){return{cachedMemory:this.cachedMemory}}}function IXe(t,e,i,r){const s=i===0?bj.acquire():_j.acquire();return s.init(t,e,i,r),s}function XI(t){t.dispose(),t instanceof Zpe?bj.release(t):t instanceof Jpe&&_j.release(t)}const _j=new Xi(Jpe),bj=new Xi(Zpe),DXe=new cj,z3=-1;class FXe extends vj{constructor(e,i,r){super(),this.horizontalScaleFactor=1,e!==void 0&&this.init(e,i,r)}init(e,i,r){super.init(e,i,r);const s=r.view.renderSpatialReference,n=_(s)&&Mq(s)&&r.spatialReference.isGeographic;this.horizontalScaleFactor=n?this.ellipsoid.radius*Math.PI/180:1,this._edgeLen=(this.extent[2]-this.extent[0])*this.horizontalScaleFactor,this._edgeLen2=this._edgeLen*this._edgeLen,this.centerAtSeaLevel[0]=Et(this.extent[0],this.extent[2],.5)*this.horizontalScaleFactor,this.centerAtSeaLevel[1]=Et(this.extent[1],this.extent[3],.5)*this.horizontalScaleFactor,this.centerAtSeaLevel[2]=0,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=(this.extent[2]-this.extent[0])*Math.SQRT1_2,i=.5*(this.elevationBounds[0]-this.elevationBounds[1]);this._center[1][3]=Math.sqrt(e*e+i*i)}_isVisible(e){return q8e(e,this._aabb())}_aabb(){return axe(this.extent[0]*this.horizontalScaleFactor,this.extent[1]*this.horizontalScaleFactor,this.elevationBounds[0],this.extent[2]*this.horizontalScaleFactor,this.extent[3]*this.horizontalScaleFactor,this.elevationBounds[1])}intersectsRay(e,i,r,s,n){KI[0]=1/i[0],KI[1]=1/i[1],KI[2]=1/i[2];const o=n*(this.extent[2]-this.extent[0])*this.horizontalScaleFactor*.1;return HN(this._aabb(),e,KI,r+o,s)}createGeometry(e,i){uXe(e,this.extent,i,this.horizontalScaleFactor,this.renderData),this.setMemoryDirty()}getDefaultVerticesPerRowOnLevel(){return this.level<9?3:2}}const KI=$();class LXe extends vj{constructor(e,i,r){super(),this.obb=new Array(8),this.isWebMercator=!1;for(let s=0;s<8;s++)this.obb[s]=$();e!==void 0&&this.init(e,i,r)}init(e,i,r){super.init(e,i,r),this.isWebMercator=r.tilingScheme.spatialReference.isWebMercator;const s=this.ellipsoid.radius,n=this.extentInRadians[0],o=this.extentInRadians[1],a=this.extentInRadians[2],l=this.extentInRadians[3],c=e[0],h=Et(o,l,.5),p=Et(n,a,.5),f=c===0?0:Math.min(Math.abs(o),Math.abs(l));this._edgeLen=(a-n)*Math.cos(f)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),m2(this.centerAtSeaLevel,p,h,this.ellipsoid.radius,0);const g=Dn(this.centerAtSeaLevel);_e(g,g),this.up=g,this._updateOBB(),this.updateRadiusAndCenter()}updateRadiusAndCenter(){if(this.lij[0]===0)ne(this._center[1],0,0,0),ne(this._center[0],0,0,0),ne(this._center[2],0,0,0),this.ellipsoid||(this.ellipsoid=Ut(this.surface.spatialReference)),this._center[1][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const e=Math.max(cn(this._center[1],this.obb[0]),cn(this._center[1],this.obb[1]));this._center[1][3]=Math.sqrt(e)}}_isVisible(e){if(!am(e,this._center[1]))return!1;if(this.lij[0]<10)return!0;const i=this.obb;for(let r=0;r<6;r++){const s=r===4,n=e[r];s&&(V3[0]=n[0],V3[1]=n[1],V3[2]=n[2],V3[3]=n[3]-this.surface.view.state.camera.near);const o=s?V3:n;let a;for(a=0;a<8;a++){const l=i[a];if(o[0]*l[0]+o[1]*l[1]+o[2]*l[2]+o[3]<0)break}if(a===8)return!1}return!0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB()}createGeometry(e,i){const r=this._isPole(this.lij[1],this.lij[0]);cXe(e,this.extent,i,this.renderData,this.extentInRadians,this.isWebMercator,this.ellipsoid,r),this.setMemoryDirty()}_updateOBB(){const e=this.extentInRadians,i=this.obb;for(let r=0;r<2;r++){const s=this.elevationBounds[r];let n=4*r;m2(i[n++],e[0],e[1],this.ellipsoid.radius,s),m2(i[n++],e[0],e[3],this.ellipsoid.radius,s),m2(i[n++],e[2],e[3],this.ellipsoid.radius,s),m2(i[n++],e[2],e[1],this.ellipsoid.radius,s)}if(this.isWebMercator){const r=this._isPole(this.lij[1],this.lij[0]);r===2?(ne(i[1],0,0,this.ellipsoid.radius),ne(i[2],0,0,this.ellipsoid.radius),ne(i[5],0,0,this.ellipsoid.radius),ne(i[6],0,0,this.ellipsoid.radius)):r===1&&(ne(i[0],0,0,-this.ellipsoid.radius),ne(i[3],0,0,-this.ellipsoid.radius),ne(i[4],0,0,-this.ellipsoid.radius),ne(i[7],0,0,-this.ellipsoid.radius))}}_isPole(e,i){let r=0;return e===(1<<i)-1&&(r+=1),e===0&&(r+=2),r}intersectsRay(e,i,r,s,n){const o=this._center[1],a=o[3]+r+.2*this.ellipsoid.radius*Math.abs(n*(this.extentInRadians[3]-this.extentInRadians[1])),l=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],c=o[0]-e[0],h=o[1]-e[1],p=o[2]-e[2],f=(c*i[0]+h*i[1]+p*i[2])/l,g=i[0]*f-c,y=i[1]*f-h,v=i[2]*f-p;return g*g+y*y+v*v<a*a}getDefaultVerticesPerRowOnLevel(){return this.level<Kpe.length?Kpe[this.level]+1:2}}const Kpe=[128,64,32,16,16,8,8,4],V3=Mt();class uw{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=tt(this._current),this._next=tt(this._next),this._waiting=tt(this._waiting),this._delayed=tt(this._delayed)}get current(){if(A(this._current))return null;if(!this._isFadingEnabled){const i=this._delayed||this._waiting||this._next||this._current;i!==this._current&&(this._current=null,this.clear(),this._current=i)}let e=uw.test.fadeMoment;if(_(this._delayed)&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null)),_(this._next)){e=e||performance.now();const i=this._fadeDuration,r=_(this._current)&&this._next.texture===this._current.texture,s=this._next.type!==0,n=e-this._fadeStart>=i;(r||s||n)&&(tt(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(A(this._next))return 1;const e=uw.test.fadeMoment||performance.now(),i=Math.max(0,e-this._fadeStart),r=this._fadeDuration;return i>r?0:1-i/r}get isFading(){return _(this._next)||_(this._delayed)}push(e,i=0){this._delayed=tt(this._delayed),this._push(e,i)}_push(e,i){if(this._isFadingEnabled||this.clear(),A(this._current))return void(this._current=e);const r=uw.test.fadeMoment||performance.now();return i!==0?(this._delayed=e,void(this._delayedTime=r+i)):A(this._next)?(this._next=e,void(this._fadeStart=this._alignFadeStart(r))):void(A(e)||(tt(this._waiting),this._waiting=e))}get _fadeDuration(){return A(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const i=this._getFadeDuration();return e+i-e%i}get _isFadingEnabled(){return this._getFadeDuration()>0}}uw.test={fadeMoment:0};class kXe{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1]}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,i,r){this._scales[2*e]=i,this._scales[2*e+1]=r}setOffset(e,i,r){this._offsets[2*e]=i,this._offsets[2*e+1]=r}get scales(){return this._scales}get offsets(){return this._offsets}}class zXe{constructor(){this.geometryInfo=new sXe,this.intersectionData=null,this.skirtIntersectionData=null,this._textureRef=new uw(()=>this.tile.surface.textureFadeDuration),this.overlay=new kXe}init(e){this.tile=e,this.clear();const i=this.geometryInfo;i.indices=null,i.vertexAttributes=null,ii(i.boundingBox),i.numSurfaceIndices=0,i.numSkirtIndices=0,i.numWithoutSkirtIndices=0,i.numVertsPerRow=0,this.intersectionData=null,this.skirtIntersectionData=null,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometry(e,i){return!!this._updateGeometryState(i)&&(this._releaseGeometry(),this._createGeometry(e),!0)}releaseGeometry(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)}ensureTexture(e,i){return _(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),A(this._texture)&&(this._texture=i(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){_(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_updateGeometryState(e){const i=this._getElevationInfo(),r=i.samplerData?this.tile.getElevationBasedVerticesPerRow(i.maxTileLevel):this.tile.getDefaultVerticesPerRowOnLevel();let s=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(s=null);const n=this.geometryState;let o=!1;return n.numVertsPerRow!==r&&(n.numVertsPerRow=r,o=!0),i.changed&&(n.samplerData=i.samplerData,o=!0),_p(n.clippingArea,s)||(n.clippingArea=s,o=!0),n.wireframe!==e&&(n.wireframe=e,o=!0),o}_createGeometry(e){this.tile.createGeometry(this.geometryState,this.localOrigin);const i=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,s=e.gl;this._vao=new Tr(e,Ht,{geometry:il(i.layout)},{geometry:Nt.createVertex(e,s.STATIC_DRAW,i.buffer)},Nt.createIndex(e,s.STATIC_DRAW,r))}_releaseGeometry(){return!!this._vao&&(this._vao.dispose(),this._vao=null,aXe(this.geometryInfo),!0)}get vao(){return this._vao}setTextureReference(e,i=0){_(e)&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,i)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,i=this.tile.layerInfo[0],r=i.length;let s=new Array(r),n=0,o=0,a=!1;for(let l=0;l<r;l++){const c=i[l];if(c.upsampleInfo){const h=c.upsampleInfo.tile,p=h.layerInfo[0][l].data,f=p&&p.samplerData;e&&e[n]===f||(a=!0),s[n++]=f,o=Math.max(o,h.lij[0])}else if(c.data){const h=this.tile.surface.layerViewByIndex(l,0);if(L3(this.tile,h.layer,!1)){const p=c.data;e&&e[n]===p.samplerData||(a=!0),s[n++]=p.samplerData,o=this.tile.level}}}return e&&e.length!==n&&(a=!0),n>0?s.length=n:s=null,{changed:a,samplerData:s,maxTileLevel:o}}get estimatedGeometryMemoryUsage(){const e=xh(this.intersectionData,0,i=>i.estimatedMemoryUsage)+xh(this.skirtIntersectionData,0,i=>i.estimatedMemoryUsage+i.vertexPositionBuffer.byteLength);return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength+e}get textureDescriptor(){return _(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:this._texture!=null}}}class VXe{constructor(){this.extent=Ot(),this.minLevel=0,this.maxLevel=0,this.callback=null}}class NXe{constructor(){this._queries=new ct({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new ct({initialSize:30}),this._queryPool=new Xi(VXe)}queryVisibleLevelRange(e,i,r,s){const n=this._queryPool.acquire();Ln(n.extent,e),n.minLevel=i||-Number.MAX_VALUE,n.maxLevel=r!=null?r:Number.MAX_VALUE,n.callback=s,this._queryQueue.push(n)}hasPendingQueries(){return this._queryQueue.length!==0}prepareQueries(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}processQueries(){for(let e=0;e<this._queries.length;e++){const i=this._queries.data[e];this._queryPool.release(i),i.callback(e>=this._queriesInvPtr),i.callback=null}this._queries.clear()}scaleQueriesForTile(e){const i=e.level;let r=0;for(;r<this._queriesInvPtr;){const s=this._queries.data[r],n=s.extent;i>=s.minLevel&&i<=s.maxLevel&&n[0]<=e.extent[2]&&n[2]>=e.extent[0]&&n[1]<=e.extent[3]&&n[3]>=e.extent[1]?(this._queries.swapElements(r,this._queriesInvPtr-1),this._queriesInvPtr--):r++}}}function UXe(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function wj(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t}function jXe(t,e,i,r,s,n,o){return t[0]=e,t[1]=i,t[2]=r,t[3]=s,t[4]=n,t[5]=o,t}function efe(t,e){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5];let l=i*n-r*s;return l?(l=1/l,t[0]=n*l,t[1]=-r*l,t[2]=-s*l,t[3]=i*l,t[4]=(s*a-n*o)*l,t[5]=(r*o-i*a)*l,t):null}function BXe(t){return t[0]*t[3]-t[1]*t[2]}function tfe(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=i[0],h=i[1],p=i[2],f=i[3],g=i[4],y=i[5];return t[0]=r*c+n*h,t[1]=s*c+o*h,t[2]=r*p+n*f,t[3]=s*p+o*f,t[4]=r*g+n*y+a,t[5]=s*g+o*y+l,t}function xj(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=Math.sin(i),h=Math.cos(i);return t[0]=r*h+n*c,t[1]=s*h+o*c,t[2]=r*-c+n*h,t[3]=s*-c+o*h,t[4]=a,t[5]=l,t}function ife(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=i[0],h=i[1];return t[0]=r*c,t[1]=s*c,t[2]=n*h,t[3]=o*h,t[4]=a,t[5]=l,t}function N3(t,e,i){const r=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=i[0],h=i[1];return t[0]=r,t[1]=s,t[2]=n,t[3]=o,t[4]=r*c+n*h+a,t[5]=s*c+o*h+l,t}function GXe(t,e){const i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=i,t[2]=-i,t[3]=r,t[4]=0,t[5]=0,t}function qXe(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t}function HXe(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t}function WXe(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"}function ZXe(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+1)}function JXe(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t}function rfe(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t}function QXe(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t}function YXe(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t[4]=e[4]+i[4]*r,t[5]=e[5]+i[5]*r,t}function XXe(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]}function KXe(t,e){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=e[0],c=e[1],h=e[2],p=e[3],f=e[4],g=e[5];return Math.abs(i-l)<=it*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(r-c)<=it*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(s-h)<=it*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(n-p)<=it*Math.max(1,Math.abs(n),Math.abs(p))&&Math.abs(o-f)<=it*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(a-g)<=it*Math.max(1,Math.abs(a),Math.abs(g))}const eKe=tfe,tKe=rfe;Object.freeze({__proto__:null,copy:UXe,identity:wj,set:jXe,invert:efe,determinant:BXe,multiply:tfe,rotate:xj,scale:ife,translate:N3,fromRotation:GXe,fromScaling:qXe,fromTranslation:HXe,str:WXe,frob:ZXe,add:JXe,subtract:rfe,multiplyScalar:QXe,multiplyScalarAndAdd:YXe,exactEquals:XXe,equals:KXe,mul:eKe,sub:tKe});function sfe(){const t=new Float32Array(6);return t[0]=1,t[3]=1,t}function iKe(t){const e=new Float32Array(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function rKe(t,e,i,r,s,n){const o=new Float32Array(6);return o[0]=t,o[1]=e,o[2]=i,o[3]=r,o[4]=s,o[5]=n,o}function sKe(t,e){return new Float32Array(t,e,6)}function nfe(t,e,i,r){const s=e[r],n=e[r+1];t[r]=i[0]*s+i[2]*n+i[4],t[r+1]=i[1]*s+i[3]*n+i[5]}function nKe(t,e,i,r=0,s=0,n=2){const o=s||e.length/n;for(let a=r;a<o;a++)nfe(t,e,i,a*n)}Object.freeze({__proto__:null,create:sfe,clone:iKe,fromValues:rKe,createView:sKe,transform:nfe,transformMany:nKe});function e4(){return[1,0,0,1,0,0]}function oKe(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]}function aKe(t,e,i,r,s,n){return[t,e,i,r,s,n]}function lKe(t,e){return new Float64Array(t,e,6)}Object.freeze({__proto__:null,create:e4,clone:oKe,fromValues:aKe,createView:lKe});function cKe(t){return t instanceof Float32Array&&t.length>=2}function uKe(t){return Array.isArray(t)&&t.length>=2}function Sj(t){return cKe(t)||uKe(t)}const hKe=39.37;function Tj(t,e){return e.type?si(t,e.x,e.y):os(t,e)}function dKe(t){return bo(t)}function pKe(t,e){const i=t.targetGeometry,r=e.targetGeometry;return i.x=r.x,i.y=r.y,i.spatialReference=r.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}const fKe=function(){const t=ke();return function(e,i,r){const s=i.targetGeometry;Tj(t,s);const n=.5*t4(i);return e.xmin=t[0]-n*r[0],e.ymin=t[1]-n*r[1],e.xmax=t[0]+n*r[0],e.ymax=t[1]+n*r[1],e.spatialReference=s.spatialReference,e}}();function t4(t){return t.scale*mKe(t.targetGeometry)}function mKe(t){return _(t)&&Ho(t.spatialReference)?1/(dKe(t.spatialReference)*hKe*yKe()):1}function gKe(t){return PM(t.rotation)||0}function yKe(){return 96}const Cj=function(){const t=ke(),e=ke(),i=ke();return function(r,s,n,o,a,l){return tV(t,s),Ao(e,n,.5*l),si(i,1/o*l,-1/o*l),wj(r),N3(r,r,e),a&&xj(r,r,a),ife(r,r,i),N3(r,r,t),r}}(),vKe=function(){const t=ke();return function(e,i,r,s){const n=t4(i),o=gKe(i);return Tj(t,i.targetGeometry),Cj(e,t,r,n,o,s)}}(),_Ke=function(){const t=ke();return function(e,i,r,s){const n=t4(i);return Tj(t,i.targetGeometry),Cj(e,t,r,n,0,s)}}();function bKe(t){if(t.isWrappable){const e=Pp(t);return e.valid[1]-e.valid[0]}return 0}function wKe(t,e){return Math.round(bKe(t)/e)}var Mj;const np=[0,0];let Cv=Mj=class extends ge{constructor(t){super(t),this._viewpoint2D={center:ke(),rotation:0,scale:0,spatialReference:null},this.center=[0,0],this.extent=new ht,this.id=0,this.inverseTransform=e4(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=e4(),this.transformNoRotation=e4(),this.displayMat3=rp(),this.displayViewMat3=rp(),this.viewMat3=rp(),this.viewMat2d=sfe(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(t){this._set("pixelRatio",t),this._update()}set size(t){this._set("size",t),this._update()}set viewpoint(t){if(t){const e=this._viewpoint2D,i=t.targetGeometry;e.center[0]=i.x,e.center[1]=i.y,e.rotation=t.rotation,e.scale=t.scale,e.spatialReference=i.spatialReference}this._update()}copy(t){const e=this.size,i=this.viewpoint;return i&&e?(this.viewpoint=pKe(i,t.viewpoint),this._set("size",os(e,t.size))):(this.viewpoint=t.viewpoint.clone(),this._set("size",[t.size[0],t.size[1]])),this._set("pixelRatio",t.pixelRatio),this}clone(){return new Mj({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(t,e,i){return Sj(e)?c0(t,e,this.inverseTransform):(np[0]=e,np[1]=i,c0(t,np,this.inverseTransform))}toScreen(t,e,i){return Sj(e)?c0(t,e,this.transform):(np[0]=e,np[1]=i,c0(t,np,this.transform))}toScreenNoRotation(t,e,i){return Sj(e)?c0(t,e,this.transformNoRotation):(np[0]=e,np[1]=i,c0(t,np,this.transformNoRotation))}getScreenTransform(t,e){const{center:i}=this._viewpoint2D,r=this._get("pixelRatio")||1,s=this._get("size");return Cj(t,i,s,e,0,r),t}_update(){const{center:t,spatialReference:e,scale:i,rotation:r}=this._viewpoint2D,s=this._get("pixelRatio")||1,n=this._get("size"),o=new ec({targetGeometry:new je(t[0],t[1],e),scale:i,rotation:r});if(this._set("viewpoint",o),!n||!e||!i)return;this.resolution=t4(o),this.rotation=r,this.scale=i,this.spatialReference=e,os(this.center,t);const a=n[0]!==0?2/n[0]:0,l=n[1]!==0?-2/n[1]:0;gV(this.displayMat3,a,0,0,0,l,0,-1,1,1);const c=yV(this.viewMat3),h=hl(n[0]/2,n[1]/2),p=hl(-n[0]/2,-n[1]/2),f=PM(r);RE(c,c,h),vV(c,c,f),RE(c,c,p),OE(this.displayViewMat3,this.displayMat3,c);const g=wj(this.viewMat2d);return N3(g,g,h),xj(g,g,f),N3(g,g,p),fKe(this.extent,o,n),vKe(this.transform,o,n,s),efe(this.inverseTransform,this.transform),_Ke(this.transformNoRotation,o,n,s),this.worldScreenWidth=wKe(this.spatialReference,this.resolution),this._set("id",this.id+1),this}};u([d({readOnly:!0})],Cv.prototype,"id",void 0),u([d({value:1,json:{write:!0}})],Cv.prototype,"pixelRatio",null),u([d({json:{write:!0}})],Cv.prototype,"size",null),u([d({type:ec,json:{write:!0}})],Cv.prototype,"viewpoint",null),Cv=Mj=u([R("esri.views.2d.ViewState")],Cv);const xKe=Cv,SKe=.125;class TKe{constructor(){this._renderParams={context:null,drawPhase:1,state:new xKe({viewpoint:new ec({targetGeometry:new je(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1}}dispose(){this._renderParams=null}render(e,i,r,s,n,o,a,l,c,h){const p=o.adjustLevel(i[0]),f=this._renderParams;f.context=e,f.painter=s,f.glyphMosaic=s.glyphMosaic,f.spriteMosaic=s.spriteMosaic,f.pixelRatio=h,f.displayLevel=p,f.requiredLevel=p;const g=o.getScale(i[0]),[y,v]=o.getShift(i,a*g),b=SKe*a*g/c,w=r.transforms.dvs;w[0]=b,w[4]=-b,w[6]=-1-y-l[0]*a*2,w[7]=1+v+(1-l[1])*a*2-2,f.state.size[0]=c,f.state.size[1]=c,r.stage||r.attachWithContext(e),r.triangleCount=0,s.drawTile(f,r,n)}}function CKe(){const t=new pi;return t.attributes.add("position","vec2"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("scale","float"),t.vertex.uniforms.add("offset","vec2"),t.varyings.add("uv","vec2"),t.vertex.code.add(x`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
}`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(x`void main() {
vec4 color = texture2D(tex, uv);
gl_FragColor = vec4(color.xyz, 1.0) * color.a * opacity;
}`),t}const MKe=Object.freeze({__proto__:null,build:CKe});class U3 extends Si{initializeProgram(e){const i=U3.shader.get().build();return new fi(e.rctx,i,Ht)}initializePipeline(){const e=this.configuration.mode===2?Qa(1,771):this.configuration.mode===1?Qa(0,770):null;return _t({blending:e,colorWrite:Pt})}}U3.shader=new vi(MKe,()=>import("./BlendLayers.glsl.37ab73a3.js"));class Pj extends tr{constructor(){super(...arguments),this.mode=0}}u([X({count:3})],Pj.prototype,"mode",void 0);function PKe(t){t.attributes.add("position","vec2"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("u_scale","float"),t.vertex.uniforms.add("u_offset","vec2"),t.varyings.add("v_texcoord","vec2"),t.vertex.code.add(x`void main(void) {
v_texcoord = uv0 * u_scale + u_offset;
gl_Position = vec4(position, 0.0, 1.0);
}`)}function AKe(t){t.fragment.uniforms.add("u_colormap","sampler2D"),t.fragment.uniforms.add("u_colormapOffset","float"),t.fragment.uniforms.add("u_colormapMaxIndex","float"),t.fragment.code.add(x`vec4 colormap(vec4 currentPixel, bool isFloat) {
float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
vec4 color = texture2D(u_colormap, clrPosition);
result = vec4(color.rgb, 1.0) * color.a * u_opacity;
}
return result;
}`)}function $Ke(t){t.fragment.uniforms.add("u_transformGrid","sampler2D"),t.fragment.uniforms.add("u_transformSpacing","vec2"),t.fragment.uniforms.add("u_transformGridSize","vec2"),t.fragment.uniforms.add("u_targetImageSize","vec2"),t.fragment.code.add(x`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;
vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
vec2 srcLocation;
vec2 transform_location = index_transform + oneTransformPixel * 0.5;
if (pos.s <= pos.t) {
vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
} else {
vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
}
return srcLocation;;
}`)}function EKe(t){t.include($Ke),t.fragment.uniforms.add("u_image","sampler2D"),t.fragment.uniforms.add("u_isFloatTexture","bool"),t.fragment.uniforms.add("u_flipY","bool"),t.fragment.uniforms.add("u_applyTransform","bool"),t.fragment.uniforms.add("u_opacity","float"),t.fragment.code.add(x`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`)}function OKe(t){const e=new pi;return e.include(PKe),e.include(EKe),e.include(AKe),t.output===0?IKe(e,t):t.output===1?RKe(e):t.output===2&&DKe(e,t),e}function RKe(t){t.fragment.code.add(x`void main() {
vec2 pixelLocation = getPixelLocation(v_texcoord);
if (isOutside(pixelLocation)) {
gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = colormap(currentPixel, true);
}`)}function IKe(t,e){t.fragment.uniforms.add("u_bandCount","int"),t.fragment.uniforms.add("u_minCutOff","float",3),t.fragment.uniforms.add("u_maxCutOff","float",3),t.fragment.uniforms.add("u_factor","float",3),t.fragment.uniforms.add("u_minOutput","float"),t.fragment.uniforms.add("u_maxOutput","float"),t.fragment.uniforms.add("u_useGamma","bool"),t.fragment.uniforms.add("u_gamma","float",3),t.fragment.uniforms.add("u_gammaCorrection","float",3),t.fragment.code.add(x`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=e.applyColormap?x`gl_FragColor = colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma);`:x`gl_FragColor = vec4(grayVal, grayVal, grayVal, 1.0) * currentPixel.a * u_opacity;`;t.fragment.code.add(x`
      void main() {
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${e.stretchType===0?x`
        gl_FragColor = vec4(currentPixel.rgb, 1.0) * currentPixel.a * u_opacity;`:x`
        if (currentPixel.a == 0.0) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = vec4(redVal, greenVal, blueVal, 1.0) * currentPixel.a * u_opacity;
        }`}
      }`)}function DKe(t,e){t.fragment.uniforms.add("u_hillshadeType","int"),t.fragment.uniforms.add("u_sinZcosAs","float",6),t.fragment.uniforms.add("u_sinZsinAs","float",6),t.fragment.uniforms.add("u_cosZs","float",6),t.fragment.uniforms.add("u_weights","float",6),t.fragment.uniforms.add("u_factor","vec2"),t.fragment.uniforms.add("u_applyColormap","bool"),t.fragment.uniforms.add("u_minValue","float"),t.fragment.uniforms.add("u_maxValue","float"),t.fragment.uniforms.add("u_srcImageSize","vec2"),t.fragment.include(yd),t.fragment.code.add(x`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 rgb = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(rgb.xyz);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv) * alpha, alpha);
}`),t.fragment.code.add(x`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=e.applyColormap?x`gl_FragColor = overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha);`:x`hillshade *= alpha;
gl_FragColor = vec4(hillshade, hillshade, hillshade, alpha);`;t.fragment.code.add(x`
    void main() {
      vec2 pixelLocation = getPixelLocation(v_texcoord);
      if (isOutside(pixelLocation)) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}
    }
  `)}const FKe=Object.freeze({__proto__:null,build:OKe});class i4 extends Si{get uniformLocationInfos(){return this._uniformLocationInfos||(this._uniformLocationInfos=AXe(this._context,this.program)),this._uniformLocationInfos}initializeProgram(e){const i=i4.shader.get(),r=this.configuration,s=i.build({output:r.colorizerType,applyColormap:r.applyColormap,stretchType:r.stretchType});return this._context=e.rctx,new fi(e.rctx,s,Ht)}initializePipeline(){const e=this.configuration.mode===2?Qa(1,771):this.configuration.mode===1?Qa(0,770):null;return _t({blending:e,colorWrite:Pt})}bindPass(e){k3(this.program,this.uniformLocationInfos,e.basic),k3(this.program,this.uniformLocationInfos,e.common),_(e.colormap)&&k3(this.program,this.uniformLocationInfos,e.colormap),this.configuration.colorizerType===0&&_(e.stretch)?k3(this.program,this.uniformLocationInfos,e.stretch):this.configuration.colorizerType===2&&_(e.hillshade)&&k3(this.program,this.uniformLocationInfos,e.hillshade)}}i4.shader=new vi(FKe,()=>import("./RasterColorizer.glsl.183fec36.js"));class j3 extends tr{constructor(){super(...arguments),this.mode=2,this.colorizerType=0,this.stretchType=0,this.applyColormap=!0}}u([X({count:3})],j3.prototype,"mode",void 0),u([X({count:3})],j3.prototype,"colorizerType",void 0),u([X({count:2})],j3.prototype,"stretchType",void 0),u([X()],j3.prototype,"applyColormap",void 0);class Aj{constructor(e,i,r,s,n,o,a){this.texture=e,this.type=i,e.retain(),this.offsetAndScale=Bt(r.offset[0],r.offset[1],r.scale,r.scale),this.opacities=De(s,a?o:0,n)}destroy(){this.texture.release()}}class LKe{constructor(e){this._rctx=e,this._pools=new Map}acquire(e){return this.getPool(e).acquire()}release(e){this.getPool(e.width).release(e)}clear(){this._pools.forEach(e=>e.destroy()),this._pools.clear()}getPool(e){let i=this._pools.get(e);if(!i){const r=ci.bind(ci,this._rctx,{colorTarget:0,depthStencilTarget:1,width:e,height:e});i=new Xi(r),this._pools.set(e,i)}return i}}class kKe{constructor(e,i,r){this._rctx=e,this.tileSize=i,this._techniqueRepository=r,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new TKe,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=vn(this._rctx,GS),this._blackTex=new Zm(mne(this._rctx,[0,0,0,1])),this._fboPool=new LKe(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=Ge(this._vaoQuad),this._backgroundTexture=nr(this._backgroundTexture),this._blackTex=nr(this._blackTex),this._blendLayersTechnique=Ge(this._blendLayersTechnique),this._applyOpacityTechnique=Ge(this._applyOpacityTechnique),this._vectorTileHelper=Ge(this._vectorTileHelper)}get blendLayersTechnique(){if(A(this._blendLayersTechnique)){const e=new Pj;e.mode=2,this._blendLayersTechnique=this._techniqueRepository.acquire(U3,e)}return this._blendLayersTechnique}get applyOpacityTechnique(){if(A(this._applyOpacityTechnique)){const e=new Pj;e.mode=1,this._applyOpacityTechnique=this._techniqueRepository.acquire(U3,e)}return this._applyOpacityTechnique}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,i){const r=e.layerInfo[1];for(const v of r)v.pendingUpdates&=-1;if(!e.renderData)return;const s=e.surface,n=s.baseOpacity;let o=0,a=0,l=this.tileSize,c=!1;const h=s.view.pixelRatio;let p=r.length,f=0;for(;f<r.length&&!c;f++){const v=s.layerViewByIndex(f,1),b=v.fullOpacity;if(Ej[f]=b,DQ(v.layer)&&p>=r.length&&(p=f),b===0)continue;++a;const w=$j(e,f,Oj);w&&(NI(v)?l=Math.max(l,this.tileSize*h):n===1&&b===1&&(v.isOpaque||this._dataToTexture(w)&&w.sourceLayerInfo.data.descriptor.isOpaque)&&(c=!0),++o)}this._cleanupFBOPool(h,r.length),l=zKe(l);const g=l/this.tileSize,y=f-1;o!==0?o===1&&(c||this._backgroundIsGrid||_(this._backgroundColor))&&this._useLayerTexture(e,y,p,Ej[y])||this._composeMapLayers(e,i,y,p,c,Ej,l,g):this._useBackgroundTexture(e,a)}_useBackgroundTexture(e,i){let r=0;(e.surface.view.layerViewManager.updating||i>0)&&(r=5e3),this._backgroundTexture&&A(e.renderData.textureReference)&&(r=0),e.renderData.setTextureReference(_(this._backgroundTexture)?new Aj(this._backgroundTexture,0,ofe,e.surface.baseOpacity,1,1,!1):null,r)}_useLayerTexture(e,i,r,s){const n=i<r,o=n?1:e.surface.baseOpacity,a=n?e.surface.baseOpacity:1,l=$j(e,i,Oj);return!!this._dataToTexture(l)&&(e.renderData.setTextureReference(new Aj(l.sourceLayerInfo.data,0,l,o,s,a,!0)),!0)}_composeMapLayers(e,i,r,s,n,o,a,l){const c=this._rctx,h=this._fboPool.acquire(a);c.bindFramebuffer(h),c.setViewport(0,0,a,a),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(16640);let p=!1;!n&&_(this._backgroundTexture)&&this._drawRasterData(this.blendLayersTechnique,this._backgroundTexture.texture,1,w6);const f=e.surface.baseOpacity;let g=!1,y=9987;for(let T=r;T>=0;T--){const C=$j(e,T,Oj);C&&(T<s&&f<1&&!g&&(this._drawRasterData(this.applyOpacityTechnique,this._blackTex.texture,1,w6,f),g=!0),o[T]!==0&&(oYe(C)?p=this._drawVectorData(this.blendLayersTechnique,C,l,o[T],a,h,p):nYe(C)?(this._drawImageryTileData(C,o[T]),this.hasNearestInterpolation(C)&&(y=9728)):this._dataToTexture(C)&&this._drawRasterData(this.blendLayersTechnique,C.sourceLayerInfo.data.texture,C.scale,C.offset,o[T])))}const v=e.renderData.ensureTexture(a,()=>this._buildTexture(a,y)),b=c.bindTexture(v.texture,qe.TEXTURE_UNIT_FOR_UPDATES),w=v.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,w.pixelFormat,0,0,w.width,w.height,0),v.generateMipmap(),c.bindTexture(b,qe.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(null),this._fboPool.release(h);const S=g?1:f;e.renderData.setTextureReference(new Aj(v,i,ofe,S,1,1,!1))}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,xs(this._vaoQuad,"geometry"))}_drawRasterData(e,i,r,s,n=1){if(A(i))return;const o=this._rctx,a=e.program;e.bindPipelineState(o),o.useProgram(a),a.bindTexture(i,"tex"),a.setUniform1f("scale",r),a.setUniform2f("offset",s[0],s[1]),a.setUniform1f("opacity",n),this._drawQuad(a)}hasNearestInterpolation(e){const i=e.sourceLayerInfo.data;return!!i.source&&i.interpolation==="nearest"}_drawImageryTileData(e,i=1){const r=e.sourceLayerInfo.data;if(!r.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(r);const s=this._getRasterColorizerTechnique(r),n=this._rctx,o=s.program;if(s.bindPipelineState(n),n.useProgram(o),!r.bind(n))return;r.opacity=i,r.scale=e.scale,r.offset=e.offset;const{names:a,textures:l}=r.getTextures();a.forEach((c,h)=>o.bindTexture(l[h],c)),s.bindPass(r.getUniforms()),this._drawQuad(o),n.bindVAO()}_getRasterColorizerTechnique(e){const i=e.symbolizerParameters,r=["stretch","lut","hillshade"].indexOf(i.type);return A(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new j3,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=!!i.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?0:1,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(i4,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,i,r,s,n,o,a){const l=this._rctx,c=i.sourceLayerInfo.data,h=i.tile.surface.layerViewByIndex(i.layerIndex,1);let p;return e.bindPipelineState(l),s<1?(p=this._fboPool.acquire(n),l.bindFramebuffer(p),l.setClearColor(1,1,1,0),l.clearSafe(16640)):a&&l.clearSafe(256),this._vectorTileHelper.render(l,i.sourceLod,c,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/i.scale),i.offset,this.tileSize,r),!_(p)||(l.bindFramebuffer(o),this._drawRasterData(e,p.colorTexture,1,[0,0],s),this._fboPool.release(p),a)}_dataToTexture(e){return lYe(e)&&this._rasterDataToTexture(e),aYe(e)}_rasterDataToTexture(e){const i=e.sourceLayerInfo;i.data=this._buildTexture(i.data),e.tile.setMemoryDirty()}setBackground(e,i){nr(this._backgroundTexture),this._backgroundIsGrid=i,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new Zm(mne(this._rctx,Bt(e[0]||0,e[1]||0,e[2]||0,1))),this._backgroundColor=De(e[0]||0,e[1]||0,e[2]||0))}_buildTexture(e,i=9987){if(A(e))return null;const r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:i,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},s=this._rctx;let n;if(typeof e=="number")r.width=r.height=e,n=new Zm(new qe(s,r));else if(e instanceof O3)r.isOpaque=e.isOpaque,n=new Zm(new qe(s,r,e.image)),e.release();else try{n=new Zm(new qe(s,r,e))}catch{n=new Zm(fne(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=s.bindTexture(n.texture,qe.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),s.bindTexture(o,qe.TEXTURE_UNIT_FOR_UPDATES),n}_cleanupFBOPool(e,i){e===this._lastPixelRatio&&i===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=i)}get test(){return{backgroundTexture:this._backgroundTexture}}}function zKe(t){const e=Op(t),i=e*e,r=t*t;if(i===r)return t;const s=e/2;return i-r<r-s*s?e:s}function $j(t,e,i){i.layerIndex=e;const r=t.layerInfo[1][e];if(r.data)return si(i.offset,0,0),i.tile=t,i.scale=1,i.sourceLod=t.lij,i.sourceLayerInfo=r,i;const s=r.upsampleInfo;if(s){const n=s.tile.layerInfo[1][e];return i.tile=s.tile,os(i.offset,s.offset),i.scale=s.scale,i.sourceLod=s.tile.lij,i.sourceLayerInfo=n,i}return null}const Ej=new Array,Oj={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},ofe={offset:[0,0],scale:1},Rj=40,afe=20,VKe=.8,NKe=15,B3=1e-6;function UKe(t,e,i){const r=e,s=i;let n=0,o=1/0;for(let a=0;a<3;++a){{const l=t[a];if(r[a]<l){if(s[a]<=B3)return!1;const c=(l-r[a])/s[a];n=Math.max(n,c)}else if(s[a]<=-B3){const c=(l-r[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}{const l=t[a+3];if(r[a]>l){if(s[a]>=-B3)return!1;const c=(l-r[a])/s[a];n=Math.max(n,c)}else if(s[a]>=B3){const c=(l-r[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}}return!0}class lfe{constructor(e,i,r,s,n){this.aabb=e,this.axis=i,this.d=r,this.midStartIndex=s,this.rightStartIndex=n}}class Mv{constructor(e,i,r,s){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=i,this.positionAttribute=s,this.rayDirection=$(),this.bspNodeTree=new Array,this.vertexPositionBuffer=s.data,this.vertexPositionStride=s.stride;const n=r-i,o=n<=cfe?new Uint16Array(n):new Uint32Array(n);this.indices=o;for(let a=0;a<n;++a)o[a]=a;{const a=HKe(e,i,r,s.data,s.stride),l=(c,h,p)=>{const f=GKe(o,a,c,h),g=h-c;if(g<=afe){const T=new lfe(f,void 0,0,c,h);return this.bspNodeTree.push(T),T}const{axis:y,midValue:v}=qKe(f),b=BKe(o,a,c,h,y,v),w=(T,C)=>{if(p>NKe)return;const M=C-T;return M<afe||M>=VKe*g?void 0:l(T,C,p+1)},S=new lfe(f,y,v,b.next,b.mid);return this.bspNodeTree.push(S),S.leftNode=w(c,b.next),S.rightNode=w(b.mid,h),S};l(0,n,0),this.triangleVertexIndices=WKe(o,e,i,r)}}intersectRayTriangleRange(e,i){{if(e>=i)return;const r=this.triangleVertexIndices,s=this.positionAttribute.data,n=this.positionAttribute.stride,o=this.rayOrigin,a=o[0],l=o[1],c=o[2],h=this.rayDirection,p=h[0],f=h[1],g=h[2];for(let y=e,v=3*e;y<i;++y){const b=r[v]*n,w=s[b],S=s[b+1],T=s[b+2],C=r[v+1]*n,M=s[C],P=s[C+1],F=s[C+2],z=r[v+2]*n,D=s[z],U=s[z+1],G=s[z+2];v+=3;const k=M-w,j=P-S,V=F-T,q=D-w,J=U-S,O=G-T,L=f*O-J*g,N=g*q-O*p,B=p*J-q*f,W=k*L+j*N+V*B;if(Math.abs(W)<=Number.EPSILON)continue;const Y=a-w,H=l-S,K=c-T,fe=Y*L+H*N+K*B;if(W>0){if(fe<0||fe>W)continue}else if(fe>0||fe<W)continue;const ce=H*V-j*K,me=K*k-V*Y,Ie=Y*j-k*H,He=p*ce+f*me+g*Ie;if(W>0){if(He<0||fe+He>W)continue}else if(He>0||fe+He<W)continue;const $e=(q*ce+J*me+O*Ie)/W;if($e>=0){const Le=this.indices[y]+this.firstTriangleIndex,Ei=RT(k,j,V,q,J,O,jKe);this.callback($e,Ei,Le,!1)}}}Mv.numFacesTested+=i-e}intersectRay(e,i){Mv.numFacesTested=0;const r=De(e.r0[0],e.r0[1],e.r0[2]),s=De(e.r1[0],e.r1[1],e.r1[2]),n=s[0]-r[0],o=s[1]-r[1],a=s[2]-r[2];if(n*n+o*o+a*a<B3)return;this.rayOrigin=r;const l=this.rayDirection;l[0]=n,l[1]=o,l[2]=a;const c=this.triangleVertexIndices.length/3;this.callback=i;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,c)}intersectRayBSP(e,i,r){const s=this.rayOrigin,n=this.rayDirection;if(!UKe(e.aabb,s,n))return;const o=e.axis,a=e.d;if(s[o]<a||n[o]<0){const l=i,c=e.midStartIndex;if(l<c){const h=e.leftNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),s[o]>a||n[o]>0){const l=e.rightStartIndex,c=r;if(l<c){const h=e.rightNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}Mv.numFacesTested=0;const jKe=$(),hw=[1/0,1/0,1/0],dw=[-1/0,-1/0,-1/0];function BKe(t,e,i,r,s,n){let o=i,a=r;for(;o<a;){const c=t[o];e[6*c+s+3]<=n?++o:(--a,t[o]=t[a],t[a]=c)}let l=o;for(a=r;l<a;){const c=t[a-1];e[6*c+s]>=n?--a:(t[a-1]=t[l],t[l]=c,++l)}return{next:o,mid:l}}function GKe(t,e,i,r){if(r<=i)return Hg(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*t[i];for(let n=0;n<3;++n)hw[n]=e[s+0+n],dw[n]=e[s+3+n]}for(let s=i+1;s<r;++s){const n=6*t[s];for(let o=0;o<3;++o)hw[o]=Math.min(hw[o],e[n+0+o]),dw[o]=Math.max(dw[o],e[n+3+o])}return Hg(hw[0],hw[1],hw[2],dw[0],dw[1],dw[2])}function qKe(t){const e=t[3]-t[0],i=t[4]-t[1],r=t[5]-t[2],s=e>i?e>r?0:i>r?1:2:i>r?1:r>e?2:0;return{axis:s,midValue:(t[s]+t[s+3])/2}}function HKe(t,e,i,r,s){const n=i-e,o=new Float32Array(6*n);for(let a=0;a<n;++a){const l=3*(a+e),c=t[l+0]*s,h=t[l+1]*s,p=t[l+2]*s;for(let f=0;f<3;++f){const g=r[c+f],y=r[h+f],v=r[p+f];o[6*a+f]=Math.min(g,y,v),o[6*a+3+f]=Math.max(g,y,v)}}return o}function WKe(t,e,i,r){const s=r-i;let n=0;for(let a=i;a<r;++a)for(let l=0;l<3;++l)n=Math.max(e[3*a+l],n);const o=n<=cfe?new Uint16Array(3*s):new Uint32Array(3*s);for(let a=0;a<s;++a){const l=3*(t[a]+i);for(let c=0;c<3;++c){const h=e[l+c];o[3*a+c]=h}}return o}const cfe=65535;function ZKe(t,e){t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),e.viewingMode===1?t.vertex.code.add(x`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):t.vertex.code.add(x`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),t.fragment.code.add(x`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function Ij(t,e){t.extensions.add("GL_OES_standard_derivatives"),e.pbrMode!==3&&e.pbrMode!==4||t.include(fue,e),t.vertex.uniforms.add("overlayTexOffset","vec4"),t.vertex.uniforms.add("overlayTexScale","vec4"),t.varyings.add("vtcOverlay","vec4"),t.vertex.code.add(x`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),t.fragment.uniforms.add("ovColorTex","sampler2D"),t.fragment.uniforms.add("overlayOpacity","float"),t.fragment.code.add(x`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),t.fragment.code.add(x`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),e.pbrMode!==3&&e.pbrMode!==4||(t.include(mV),t.fragment.code.add(x`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, lightingMainDirection, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position);
return vec4(final, colorInput.w);
}`))}function JKe(t){t.vertex.code.add(x`vec3 applySkirts(inout vec2 uv, vec3 vpos, vec3 vnormal, float skirtScale) {
float skirtLength = 0.0;
if (uv.x >= 2.0) {
skirtLength = uv.y * skirtScale;
vec2 x = vec2(uv.x) - vec2(3.5, 4.5);
uv = clamp(vec2(1.5) - abs(x), vec2(0.0), vec2(1.0));
}
return vpos - vnormal * skirtLength;
}`)}function QKe(t,e){t.varyings.add("vtc","vec2"),t.vertex.uniforms.add("texOffsetAndScale","vec4"),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("textureOpacities","vec3"),e.textureFadingEnabled&&(t.vertex.uniforms.add("nextTexOffsetAndScale","vec4"),t.varyings.add("nvtc","vec2"),t.fragment.uniforms.add("texNext","sampler2D"),t.fragment.uniforms.add("nextTexOpacities","vec3"),t.fragment.uniforms.add("fadeFactor","float")),t.vertex.code.add(x`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${e.textureFadingEnabled?x`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:x``}
  }`),e.useGrid?(t.fragment.code.add(x`float lineFactorAtPosition(float value) {
float pos = value * 129.0;
if(pos < 0.5 || pos > 128.5) {
return 1.0;
}
pos = pos + 0.5;
float modulo = mod(pos, 16.0);
return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
}
float lineFactorAtUV(vec2 uv) {
return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
}
float lineFactor(vec2 uv) {
vec2 offset = fwidth(uv) * 0.25;
return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
}
vec4 gridColor(vec2 uv) {
float line = lineFactor(uv) * 0.1 + 0.9;
float backgroundOpacity = textureOpacities.y;
return vec4(1.0, 0.972, 0.918, 1.0) * line * backgroundOpacity;
}`),t.fragment.code.add(x`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
vec4 grid = gridColor(uv);
float alpha = opacities.z * color.a;
return mix(grid, color, alpha) * opacities.x;
}`)):e.hasBackgroundColor?(t.fragment.uniforms.add("backgroundColor","vec3"),t.fragment.code.add(x`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
float alpha = opacities.z * color.a;
float backgroundOpacity = opacities.y;
return mix(vec4(backgroundColor, 1.0) * backgroundOpacity, color, alpha) * opacities.x;
}`)):t.fragment.code.add(x`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
return color;
}`),e.textureFadingEnabled?t.fragment.code.add(x`vec4 getTileColor() {
vec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):t.fragment.code.add(x`vec4 getTileColor() {
return getColor(texture2D(tex, vtc), vtc, textureOpacities);
}`)}function YKe(t){const e=new pi;if(e.include(Wue,{name:"Terrain Shader",output:t.output}),e.include(JKe),e.attributes.add("position","vec3"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("origin","vec3").add("skirtScale","float"),t.output===0){e.include(Ss,{linearDepth:!1}),e.include(Em,t),e.include(QKe,t);const i=t.overlayMode!==0,r=t.overlayMode===2;i&&e.include(Ij,{pbrMode:3,useCustomDTRExponentForWater:!1,ssrEnabled:t.ssrEnabled,highStepCount:t.highStepCount}),r&&e.include(ZKe,t),e.varyings.add("vnormal","vec3"),e.varyings.add("vpos","vec3"),e.vertex.uniforms.add("viewNormal","mat4"),t.receiveShadows&&e.varyings.add("linearDepth","float"),t.tileBorders&&e.varyings.add("vuv","vec2"),t.atmosphere&&(e.vertex.uniforms.add("lightingMainDirection","vec3"),e.varyings.add("wnormal","vec3"),e.varyings.add("wlight","vec3")),t.screenSizePerspective&&(e.vertex.uniforms.add("screenSizePerspective","vec4"),e.varyings.add("screenSizeDistanceToCamera","float"),e.varyings.add("screenSizeCosAngle","float")),e.vertex.code.add(x`
      void main(void) {
        vpos = position;
        vnormal = getLocalUp(vpos, origin);

        vec2 uv = uv0;
        vpos = applySkirts(uv, vpos, vnormal, skirtScale);
        ${t.atmosphere?x`
        wnormal = normalize((viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz);
        wlight = normalize((view  * vec4(lightingMainDirection, 1.0)).xyz);`:""}
        ${t.tileBorders?x`vuv = uv;`:""}
        ${t.screenSizePerspective?x`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${t.receiveShadows?x`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${i?x`setOverlayVTC(uv);`:""}
        ${r?x`forwardVertexTangent(vnormal);`:x``}
      }
    `),e.extensions.add("GL_OES_standard_derivatives"),e.extensions.add("GL_EXT_shader_texture_lod"),e.include(Zi,t),e.include(r3,t),e.fragment.uniforms.add("camPos","vec3").add("viewDirection","vec3").add("ssaoTex","sampler2D").add("viewportPixelSz","vec4"),t.screenSizePerspective&&e.fragment.uniforms.add("screenSizePerspective","vec4"),r&&(e.fragment.uniforms.add("ovWaterTex","sampler2D"),e.fragment.uniforms.add("view","mat4")),e.fragment.code.add(x`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),e.fragment.code.add(x`
      void main() {
        ${t.receiveShadows?x`float shadow = readShadowMap(vpos, linearDepth);`:x`float shadow = 0.0;`}
        float vndl = dot(normalize(vnormal), lightingMainDirection);

        float ssao = viewportPixelSz.w < .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
        vec4 tileColor = getTileColor();
        ${i?x`
            vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        ${t.atmosphere?x`
            float ndotl = clamp(vndl, 0.0, 1.0);
            vec3 atm = vec3(clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
            atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); //avoid atmosphere on bright base maps
            atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}

        vec3 albedo = ${t.atmosphere?x`atm + tileColor.rgb;`:x`tileColor.rgb;`}
        vec3 normal = normalize(vnormal);

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${r?x`
            vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - camPos), shadow, vnormal, tbnMatrix, viewPosition.xyz);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${t.screenSizePerspective?x`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, screenSizePerspective);
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${t.tileBorders?x`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `)}return t.output!==1&&t.output!==3||(e.include(Ss,{linearDepth:!0}),e.include(J0,{output:t.output}),e.include(Em,t),e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("nearFar","vec2"),e.vertex.code.add(x`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, normal.xyz, skirtScale);
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);
}`),e.fragment.code.add(x`void main() {
outputDepth(linearDepth);
}`)),t.output===2&&(e.include(Ss,{linearDepth:!1}),e.include(Em,t),e.varyings.add("vnormal","vec3"),e.varyings.add("vpos","vec3"),e.vertex.uniforms.add("viewNormal","mat4"),e.vertex.code.add(x`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vpos = applySkirts(uv, position, normal, skirtScale);
gl_Position = transformPosition(proj, view, vpos);
vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
}`),e.fragment.code.add(x`void main() {
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) {
normal = -normal;
}
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
}`)),t.output===4&&(e.include(Ss,{linearDepth:!1}),e.include(Em,t),e.include(Ij,{pbrMode:0}),e.vertex.code.add(x`void main() {
vec3 vnormal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, vnormal, skirtScale);
setOverlayVTC(uv);
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Dd),e.fragment.code.add(x`void main() {
vec4 overlayColor = getCombinedOverlayColor();
if (overlayColor.a == 0.0) {
gl_FragColor = vec4(0.0);
return;
}
outputHighlight();
}`)),e}const XKe=Object.freeze({__proto__:null,build:YKe});class r4 extends Si{constructor(){super(...arguments),this.useStencil=!1}initializeProgram(e){const i=r4.shader.get(),r=this.configuration,s=i.build({overlayMode:r.overlayMode,output:r.output,viewingMode:e.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,textureFadingEnabled:r.textureFadingEnabled&&!r.renderOccluded,hasBackgroundColor:r.hasBackgroundColor,useGrid:r.useGrid,receiveShadows:r.receiveShadows&&!r.renderOccluded,receiveAmbientOcclusion:!1,atmosphere:r.atmosphere,tileBorders:r.tileBorders,screenSizePerspective:r.screenSizePerspective,pbrMode:0,ssrEnabled:r.ssrEnabled,highStepCount:!1});return new fi(e.rctx,s,Ht)}initializePipeline(){return this._stencilPipelineState=this.createPipeline(!0),this.createPipeline(!1)}createPipeline(e){const i=this.configuration,r=i.backfaceCullingEnabled&&!i.renderOccluded;return _t({blending:i.renderOccluded?Qa(1,771):null,culling:r&&hV,depthTest:!i.renderOccluded&&{func:513},depthWrite:!i.renderOccluded&&$o,colorWrite:Pt,stencilTest:e?dje(1):null})}getPipelineState(e,i){return this.useStencil?this._stencilPipelineState:super.getPipelineState(e,i)}}r4.shader=new vi(XKe,()=>import("./Terrain.glsl.f6dc6ff8.js"));class ro extends tr{constructor(){super(...arguments),this.output=0,this.overlayMode=0,this.atmosphere=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.hasBackgroundColor=!1,this.useGrid=!1,this.renderOccluded=!1,this.ssrEnabled=!1,this.tileBorders=!1,this.screenSizePerspective=!1}}u([X({count:8})],ro.prototype,"output",void 0),u([X({count:3})],ro.prototype,"overlayMode",void 0),u([X()],ro.prototype,"atmosphere",void 0),u([X()],ro.prototype,"receiveShadows",void 0),u([X()],ro.prototype,"slicePlaneEnabled",void 0),u([X()],ro.prototype,"backfaceCullingEnabled",void 0),u([X()],ro.prototype,"stencilEnabled",void 0),u([X()],ro.prototype,"textureFadingEnabled",void 0),u([X()],ro.prototype,"hasBackgroundColor",void 0),u([X()],ro.prototype,"useGrid",void 0),u([X()],ro.prototype,"renderOccluded",void 0),u([X()],ro.prototype,"ssrEnabled",void 0),u([X()],ro.prototype,"tileBorders",void 0),u([X()],ro.prototype,"screenSizePerspective",void 0);const s4=7,KKe=10,n4=lr(),o4=Ot();let $n=class extends ve{constructor(t){super(t),this.type=2,this.isGround=!0,this.tileSize=256,this.rctx=null,this._isTransparent=!1,this._scaleRangeQueries=new NXe,this.renderDataPool=new Xi(zXe),this._patchGroups=new ct({allocator:e=>e||{root:null,origin:null,patches:new ct},deallocator:e=>(e.root=null,e.origin=null,e.patches.clear(),e)}),this.patchGroupsDirty=!0,this.patchGroupsMap=new Map,this.tileIterator=new Gpe,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._skirtScale=1,this._velvetOverground=!0,this.castShadows=!0,this._ssrEnabled=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.tileBackgroundUpdating=!1,this.stencilEnabledLayerExtents=[],this.numTrianglesRendered=0,this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.overlayOpacity=1,this.needsHighlight=!1,this.renderOccludedFlags=1}get isGlobal(){return this.stage.viewingMode===1}initialize(){const t=[1,6,8];this.stage.addRenderPlugin(t,this)}destroy(){this.stage.removeRenderPlugin(this),oXe()}get updating(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating}get canRender(){return this.visible&&!!this._rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}set renderingDisabled(t){this._set("renderingDisabled",!!t),this.setNeedsRender()}set opaque(t){this._opaque!==t&&(this._opaque=t,this.setNeedsRender())}get needsLinearDepth(){return this.overlayRenderer.hasWater}get opaque(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled}set isTransparent(t){this._isTransparent!==t&&(this._isTransparent=t,this.setNeedsRender())}get isTransparent(){return this._isTransparent}set skirtScale(t){t!==this._skirtScale&&(this._skirtScale=t,this.setNeedsRender())}get skirtScale(){return this._skirtScale}get renderPatchBorders(){return!!this.shaderTechniqueConfig.tileBorders}set renderPatchBorders(t){this.shaderTechniqueConfig.tileBorders!==t&&(this.shaderTechniqueConfig.tileBorders=t,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this.shaderTechniqueConfig.backfaceCullingEnabled}set cullBackFaces(t){this.shaderTechniqueConfig.backfaceCullingEnabled!==t&&(this.shaderTechniqueConfig.backfaceCullingEnabled=t,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(t){this._set("renderOrder",t),this.setNeedsRender()}set velvetOverground(t){this._velvetOverground!==t&&(this._velvetOverground=t,this.setNeedsRender())}get layerUid(){return T0}get slicePlaneEnabled(){return this.shaderTechniqueConfig.slicePlaneEnabled}set slicePlaneEnabled(t){this.shaderTechniqueConfig.slicePlaneEnabled!==t&&(this.shaderTechniqueConfig.slicePlaneEnabled=t,this.setNeedsRender())}set textureFadingEnabled(t){this.shaderTechniqueConfig.textureFadingEnabled!==t&&(this.shaderTechniqueConfig.textureFadingEnabled=t,this.setNeedsRender())}setDebugScreenSizePerspective(t){this.shaderTechniqueConfig.screenSizePerspective!==t&&(this.shaderTechniqueConfig.screenSizePerspective=t,this.setNeedsRender())}setRootTiles(t){this._rootTiles=t,this.setNeedsRender()}setNeedsHighlight(t){this.needsHighlight=t,this.setNeedsRender()}setRenderOccludedOverlay(t){this.renderOccludedFlags=t?CR:1,this.setNeedsRender()}setStencilEnabledLayerExtents(t){this.stencilEnabledLayerExtents=t,this.setNeedsRender()}setTileSize(t){this.tileSize=t,this.tileRenderer&&(this.tileRenderer.tileSize=t),this.setNeedsRender()}loadTile(t){t.renderData||(t.renderData=this.renderDataPool.acquire(),t.renderData.init(t),t.renderData.localOrigin=this._getLocalOriginOfTile(t)),this.updateTileGeometry(t),this.updateTileTexture(t,128)}queryVisibleLevelRange(t,e,i,r){this._scaleRangeQueries.queryVisibleLevelRange(t,e,i,r),this.setNeedsRender()}updateTileTexture(t,e){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(t,e===128?0:2),this.setNeedsRender(),t.resetPendingUpdate(e))}updateTileGeometry(t){for(const e of t.layerInfo[0])e.pendingUpdates&=-33;t.resetPendingUpdate(32),t.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(t){t.renderData&&(t.renderData.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(t.renderData),t.renderData.clear(),t.renderData=null,t.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(t){const e=KKe-s4,i=Math.max(0,Math.floor((t.level-e)/s4)*s4);if(this.isGlobal&&i===0)return Fn;for(;t.parent&&t.level>i;)t=t.parent;return t.centerAtSeaLevel}setVisibility(t){this.visible=t,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}}set wireframe(t){this._get("wireframe")!==t&&(this._set("wireframe",t),this.allTiles.forAll(e=>{var i;return(i=e.renderData)==null?void 0:i.updateGeometry(this.rctx,t)}),this.setNeedsRender())}setNeedsRender(t=1){this.patchGroupsDirty=!0,this.context.requestRender(t)}setTileBackground(t){this.tileBackground=t,this._updateTileBackground()}initializeRenderContext(t){this.context=t,this.rctx=t.renderContext.rctx,this.shaderTechniques=t.shaderTechniqueRep,this.shaderTechniqueConfig=new ro,this.tileRenderer=new kKe(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=fne(this.rctx)}uninitializeRenderContext(){this.emptyTex!=null&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)}intersect(t,e,i,r){if(!this._rootTiles||t.options.selectOpaqueTerrainOnly&&t.options.selectionMode&&!this._opaque)return;const s=iet,n=ret;ue(s,r,i),ne(n,1/s[0],1/s[1],1/s[2]);const o=t.results.min,a=t.results.max,l=t.results.ground,c=t.options.store===0,h=!!t.results.ground.target,p=Jze(t.verticalOffset),f=this._skirtScale,g=t.tolerance;let y,v=c&&_(o.dist)?o.dist:1/0;const b=S=>{const T=S.renderData;if(T==null)return;const C=T.geometryInfo;fP(n4,C.boundingBox);const M=T.localOrigin;_(p)&&(p.localOrigin=M,p.applyToAabb(n4));const P=-f*C.skirtLength;if(P!==0){const q=S.up;ixe(n4,P*q[0],P*q[1],P*q[2])}const F=n4;if(op[0]=i[0]-M[0],op[1]=i[1]-M[1],op[2]=i[2]-M[2],!HN(F,op,n,g,v))return;const z=(q,J,O)=>{q.set(this.type,S,J,O,Dr),v=c&&_(o.dist)?o.dist:1/0},D=(q,J)=>{if(_(J)&&q>=0&&(t.options.backfacesTerrain||ye(J,s)<0)&&(t.options.invisibleTerrain||!t.options.selectionMode||e==null||e(i,r,q))){if((l.dist==null||q<l.dist)&&z(l,q,J),t.options.isFiltered)return;t.options.store===2&&(A(y)?(y=YE(t.ray),z(y,q,J),t.results.all.push(y)):q<y.dist&&z(y,q,J)),(o.dist==null||q<o.dist)&&z(o,q,J),t.options.store!==0&&(a.dist==null||q>a.dist)&&z(a,q,J)}},U=set;ue(U,r,M);const G=C.indices,k=C.vertexAttributes,j={data:k.getField("position",Wt).typedBuffer,size:3,stride:k.stride/4},V=C.numWithoutSkirtIndices/3;if(!_(p)&&V>Rj){const q=S.renderData;_(q.intersectionData)||(q.intersectionData=new Mv(G,0,V,j)),q.intersectionData.intersectRay({r0:op,r1:U},D)}else OT(op,U,0,V,G,j,null,p,D);if(P!==0){const q=G.length/3;if(this.isGlobal){const J=q-V;if(!_(p)&&J>Rj){const O=S.renderData;if(!_(O.skirtIntersectionData)){const L=fXe(G,V,q,k,P,M);O.skirtIntersectionData=new Mv(L.indices,0,J,{data:L.vertices,stride:3})}O.skirtIntersectionData.intersectRay({r0:op,r1:U},D)}else pXe(op,U,V,q,G,k,P,M,p,D)}else mXe(op,U,V,q,G,k,P,p,D)}},w=this._rootTiles;_(w)&&(()=>{const S=this.tileIterator;S.reset(w);const T=t.options.invisibleTerrain;for(;!S.done;){const C=S.next();!(C.visible||T&&C.intersectsClippingArea)||!_(p)&&!C.intersectsRay(i,s,g,v,f)||h&&this._useStencilForTile(C)?S.skipSubtree():b(C)}})()}render(t){if(t.slot===8){if((t.renderOccludedMask&CR)==0)return!1}else{const n=this.opaque?1:6;if(t.slot!==n)return!1}const e=t.pass,i=t.scenelightingData.globalFactor===1,r=this._updatePatchGroups();let s=!1;switch(e){case 0:{const n=t.shadowMap&&t.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==n&&(this.shaderTechniqueConfig.receiveShadows=n);const o=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==o&&(this.shaderTechniqueConfig.overlayMode=o);const a=t.slot===8?3:1;this._renderMaterialPass(t,0,r,a),s=!0;break}case 4:case 6:this.castShadows&&i&&(this._renderAuxiliaryPass(t,3,r,0),s=!0);break;case 2:this.isTransparent&&this.overlayRenderer.isEmpty()||(this._renderAuxiliaryPass(t,1,r,0),s=!0);break;case 3:this._renderAuxiliaryPass(t,2,r,0),s=!0;break;case 5:this.needsHighlight&&(this._renderAuxiliaryPass(t,4,r,2),t.rctx.clearSafe(256),s=!0)}return this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender(),s}_renderMaterialPass(t,e,i,r){const{rctx:s,camera:n}=t;this._ssrEnabled=t.ssrParams.ssrEnabled,this._setTerrainTechnique(e,r===3);const o=this._shaderTechnique.program;s.useProgram(o),this.shaderTechniqueConfig.overlayMode!==0&&r===1&&t.ssrParams&&L7(o,t.ssrParams),t.shadowMap.bind(o),t.ssaoHelper.bind(o,t.camera),this._bindOverlayData(o,r),o.setUniformMatrix4fv("viewNormal",n.viewInverseTransposeMatrix),Pc(o,n.projectionMatrix),t.scenelightingData.setUniforms(o,!0);const a=n.viewMatrix;ne(a4,a[12],a[13],a[14]),_e(a4,a4),o.setUniform3fv("viewDirection",a4),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._scaleRangeQueries.prepareQueries(),this.opaque?this._renderPatchGroups(t,o,i,r):t.offscreenRenderingHelper.renderToTargets(()=>this._renderPatchGroups(t,o,i,r),t.offscreenRenderingHelper.tmpColor,t.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._scaleRangeQueries.processQueries()}_renderAuxiliaryPass(t,e,i,r){this._setTerrainTechnique(e,r===3);const s=t.rctx,n=this._shaderTechnique.program;if(s.useProgram(n),t.pass===5){const o=t.offscreenRenderingHelper;n.bindTexture(o.depthTexture,"depthTex"),n.setUniform4f("highlightViewportPixelSz",0,0,1/o.width,1/o.height)}else n.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix),t.pass!==2&&t.pass!==4&&t.pass!==6||n.setUniform2fv("nearFar",t.camera.nearFar);this._renderPatchGroupsAuxiliary(t,n,i,r)}_updateTileBackground(){if(!this.tileRenderer)return;this.tileBackgroundUpdating=!0;const t=()=>{this.tileBackgroundInitialized=!0,this.tileBackgroundUpdating=!1,this.shaderTechniqueConfig.useGrid=this.tileRenderer.backgroundIsGrid,this.shaderTechniqueConfig.hasBackgroundColor=!this.tileRenderer.backgroundIsGrid&&!!_(this.tileRenderer.backgroundColor),this.allTiles.forAll(e=>this.tileRenderer.updateTileTexture(e,0)),this.setNeedsRender()};if(typeof this.tileBackground=="string"){const e=this.tileBackground;tl(e).then(i=>{e===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(i,this.tileBackground===Ire),t())})}else{const e=this.tileBackground?Ae.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(e,!1),t()}}_updatePatchGroups(){const t=this._patchGroups;if(!this.patchGroupsDirty)return t;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(t),this.renderOrder!==0){for(let e=0;e<t.length;e++)qpe(this.renderOrder,t.data[e].patches);t.sort((e,i)=>tet(e,i,this.renderOrder))}return this.patchGroupsDirty=!1,t}_renderCollectOrigins(t){const e=this._rootTiles;if(A(e))return;const i=this.isGlobal;t.clear();for(const r of e){const s=t.pushNew();s.root=r,s.origin=i?Fn:r.centerAtSeaLevel,s.patches.clear(),this._renderCollectOriginsForRoot(t,s)}t.filterInPlace(r=>r.patches.length>0)}_renderCollectOriginsForRoot(t,e){const i=this.tileIterator;i.resetOne(e.root);const r=this.patchGroupsMap;for(r.clear(),r.set(e.origin,e);!i.done;){const s=i.next(),n=s.renderData;if(!n||s.visible){if(s.level%s4==0){const o=t.pushNew();o.root=s,o.origin=s.centerAtSeaLevel,r.set(s.centerAtSeaLevel,o),o.patches.clear()}if(s.rendered){if(n){const o=r.get(n.localOrigin);o&&o.patches.push(s),(!this.highestVisibleLODTile||s.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=s),i.skipSubtree()}}else this.numTilesCulled++}else this.numTilesCulled++,i.skipSubtree()}}_useStencilForTile(t){for(const e of this.stencilEnabledLayerExtents)if(t.intersectsExtent(e))return!0;return!1}_renderPatchGroupsAuxiliary(t,e,i,r){const s=t.rctx;this._shaderTechnique.useStencil=!1,this._shaderTechnique.bindPipelineState(s,t.slot);const n=this.stencilEnabledLayerExtents.length>0;e.setUniformMatrix4fv("proj",t.camera.projectionMatrix),e.setUniform1f("skirtScale",this._skirtScale),r!==0&&this._bindOverlayData(e,r);for(let o=0;o<i.length;o++){const a=i.data[o];this._bindPatchGroupData(e,a,t.camera.eye,t.camera.viewMatrix);for(let l=0;l<a.patches.length;l++)this._renderPatch(t,e,a.patches.data[l],4,n,r)}t.rctx.bindVAO(null)}_renderPatchGroups(t,e,i,r){const s=t.rctx,n=t.camera,o=n.viewMatrix;if(this._shaderTechnique.useStencil=!1,this._shaderTechnique.bindPipelineState(s,t.slot),this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){const f=ule(this.stage.viewingMode,this.ellipsoidRadius),g=this.pointsOfInterest.centerOnSurfaceFrequent.distance;f.update({distance:g,fovY:n.fovY}),IT(f,e,"screenSizePerspective")}const a=this.stencilEnabledLayerExtents.length>0,l=r===3;l&&(e.bindTexture(this.emptyTex,"tex"),e.setUniform1f("blend",1),e.setUniform4fv("texOffsetAndScale",I1));const c=_(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:Fn;this.shaderTechniqueConfig.hasBackgroundColor&&e.setUniform3fv("backgroundColor",c);const h=l?0:this._skirtScale;e.setUniform1f("skirtScale",h);const p=this.wireframe?1:4;this.shaderTechniqueConfig.textureFadingEnabled&&e.bindTexture(this.emptyTex,"texNext");for(let f=0;f<i.length;f++){const g=i.data[f],y=g.patches;this._bindPatchGroupData(e,g,n.eye,o);const v=t.sliceHelper&&t.sliceHelper.plane;Ab(e,this._shaderTechnique.configuration,v,g.origin),t.shadowMap&&t.shadowMap.bindView(e,g.origin),this.numOriginsRendered++;for(let b=0;b<y.length;b++){const w=y.data[b],S=w.renderData.textureReference;if(A(S))continue;if(!l){this._scaleRangeQueries.scaleQueriesForTile(w),ufe(w.renderData.geometryInfo.uvOffsetAndScale,S.offsetAndScale,o4),e.setUniform4fv("texOffsetAndScale",o4),e.bindTexture(S.texture.texture,"tex");const C=w.renderData.textureFadeFactor,M=C<1?w.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&_(M)&&C<1?(ufe(w.renderData.geometryInfo.uvOffsetAndScale,M.offsetAndScale,o4),e.setUniform1f("fadeFactor",C),e.setUniform4fv("nextTexOffsetAndScale",o4),e.setUniform3fv("nextTexOpacities",M.opacities),e.bindTexture(M.texture.texture,"texNext")):e.setUniform1f("fadeFactor",1),w.renderData.textureIsFading&&this.setNeedsRender(),e.setUniform3fv("textureOpacities",S.opacities)}const T=this._renderPatch(t,e,w,p,a,r);w.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=T/3}}s.bindVAO(null)}_renderPatch(t,e,i,r,s,n){if(A(i.renderData.vao.indexBuffer))return 0;n!==0&&this._bindOverlayPatchData(e,i.renderData.overlay),s&&(this._shaderTechnique.useStencil=this._useStencilForTile(i),this._shaderTechnique.bindPipelineState(t.rctx,t.slot));const o=this._skirtScale===0?i.renderData.geometryInfo.numWithoutSkirtIndices:i.renderData.vao.indexBuffer.size;return t.rctx.bindVAO(i.renderData.vao),e.assertCompatibleVertexAttributeLocations(i.renderData.vao),t.rctx.drawElements(r,o,i.renderData.vao.indexBuffer.indexType,0),o}_bindPatchGroupData(t,e,i,r){t.setUniform3fv("origin",e.origin),Vs(hfe,r,e.origin),t.setUniformMatrix4fv("view",hfe),t.setUniform3f("camPos",i[0]-e.origin[0],i[1]-e.origin[1],i[2]-e.origin[2])}_bindOverlayData(t,e){if(this.shaderTechniqueConfig.overlayMode===0)return;t.setUniform1f("overlayOpacity",this.overlayOpacity);const i=this.overlayRenderer.overlays;if(i.length>0){const r=i[0],s=r.getColorTexture(e);if(t.bindTexture(_(s)?s:this.emptyTex,"ovColorTex"),this.shaderTechniqueConfig.overlayMode===2){const n=r.getNormalTexture(e);t.bindTexture(_(n)?n:this.emptyTex,"ovWaterTex")}}}_bindOverlayPatchData(t,e){t.setUniform4fv("overlayTexOffset",e.offsets),t.setUniform4fv("overlayTexScale",e.scales)}_setTerrainTechnique(t,e){this.shaderTechniqueConfig.output=t,t===0&&(this.shaderTechniqueConfig.atmosphere=this.isGlobal&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled),this.shaderTechniqueConfig.renderOccluded=e,this.shaderTechniqueConfig.stencilEnabled=!1,this._shaderTechnique=this.shaderTechniques.releaseAndAcquire(r4,this.shaderTechniqueConfig,this._shaderTechnique)}get test(){return{tileRenderer:this.tileRenderer}}};u([d()],$n.prototype,"tileBackgroundInitialized",void 0),u([d()],$n.prototype,"tileBackgroundUpdating",void 0),u([d({constructOnly:!0})],$n.prototype,"overlayRenderer",void 0),u([d({constructOnly:!0})],$n.prototype,"stage",void 0),u([d({readOnly:!0})],$n.prototype,"isGlobal",null),u([d({constructOnly:!0})],$n.prototype,"allTiles",void 0),u([d({constructOnly:!0})],$n.prototype,"ellipsoidRadius",void 0),u([d({readOnly:!0})],$n.prototype,"updating",null),u([d({value:!1})],$n.prototype,"renderingDisabled",null),u([d()],$n.prototype,"renderPatchBorders",null),u([d()],$n.prototype,"cullBackFaces",null),u([d({value:1})],$n.prototype,"renderOrder",null),u([d()],$n.prototype,"wireframe",null),$n=u([R("esri.views.3d.terrain.TerrainRenderer")],$n);const eet=$n;function tet(t,e,i){return t.patches.length===0?-i:e.patches.length===0?i:Hpe(t.patches.data[0],e.patches.data[0],i)}function ufe(t,e,i){const r=t[0]*e[2]+e[0],s=t[1]*e[3]+e[1],n=t[2]*e[2],o=t[3]*e[3];Ls(i,r,s,n,o)}const hfe=be(),a4=$(),iet=$(),ret=$(),op=$(),set=$();class net{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}let Uc=class extends ve{constructor(t){super(t),this._handles=new dt}initialize(){this._handles.add(this.layers.on("change",()=>this._update())),this._handles.add(this.extentHelper.watch("layerViewsExtent",()=>this._setAdHocTilingScheme())),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=tt(this._handles),this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let t;if(this._set("tilingSchemeDone",!1),this.layers.some(e=>!(!hA(e)||e.isRejected())&&!(e.isFulfilled()&&!oet(e,this.viewSpatialReference,this.viewingMode))&&(t=e,!_pe(e)&&!VI(e))),t)if(t.isResolved()){const e=jI(t,this.viewSpatialReference,this.viewingMode);if(_(e)){const i=new yi(e.tileInfo);this._set("tilingSchemeDone",!0),this._lockTilingScheme(i)}}else this._updateWhen(t);else this._set("tilingSchemeDone",!0)}_updateWhen(t){const e=t.when().catch(()=>{}).then(()=>{e!==this._waitTask||this.destroyed||this._update()});this._waitTask=e}_lockTilingScheme(t){if(this.viewingMode===1){const e=t.levels.length-1;t.spatialReference.isWebMercator?t=yi.makeWebMercatorAuxiliarySphere(e):fy(t.spatialReference)&&(t=yi.makeGCSWithTileSize(t.spatialReference,t.pixelSize,e))}this.tilingSchemeLocked=!0,this.tilingScheme=t,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(this.extentHelper.watch("tiledLayersExtent",()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===1){const t=this.extentHelper.viewSpatialReference,e=fy(t)||$h(t)||Eh(t);t.isWebMercator?this.tilingScheme=yi.WebMercatorAuxiliarySphere:e&&(this.tilingScheme=yi.makeGCSWithTileSize(t,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const t=this.extentHelper.layerViewsExtent;_(t)&&!qg(t,this.extent)&&(this.tilingScheme=yi.fromExtent(t,this.extentHelper.viewSpatialReference),this._set("extent",t))}}get test(){return{lockTilingScheme:t=>this._lockTilingScheme(t),done:!this._waitTask}}};function oet(t,e,i){return _(jI(t,e,i))}u([d()],Uc.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],Uc.prototype,"extent",void 0),u([d({value:!1})],Uc.prototype,"tilingSchemeLocked",void 0),u([d({readOnly:!0,value:!1})],Uc.prototype,"tilingSchemeDone",void 0),u([d({constructOnly:!0})],Uc.prototype,"viewSpatialReference",void 0),u([d({constructOnly:!0})],Uc.prototype,"layers",void 0),u([d({constructOnly:!0})],Uc.prototype,"extentHelper",void 0),u([d({constructOnly:!0})],Uc.prototype,"viewingMode",void 0),Uc=u([R("esri.views.3d.terrain.TilingSchemeLogic")],Uc);class aet{constructor(){this.offset=ke(),this.scale=0,this.tile=null}init(e,i,r,s){this.tile=e,this.offset[0]=i,this.offset[1]=r,this.scale=s}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}const Sl=le.getLogger("esri.views.3d.terrain.TerrainSurface"),cet=.25;let ft=class extends Ci.EventedMixin(ve){constructor(t){super(t),this._elevationBounds=new cj,this._iteratorPool=new Xi(Gpe,e=>e.remove=()=>this._iteratorPool.release(e)),this._postorderIterator=new gXe,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=q3,this._performanceInfo=new net,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=$(),this._eyePosSurfaceSR=$(),this._splitLimits=new RXe,this._snapLevel=1/0,this._frustum=mb(),this._viewProjectionMatrix=be(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new dt,this._watchUpdatingTracking=new zh,this._frameTask=N_,this._allTiles=new ct,this._upsampleInfoPool=new Xi(aet),this._rootTilesExtent=pt(),this._maxNumUpdating=1,this.maxTextureScale=1.2,this.backgroundImage=Ire,this.backgroundColor=null,this._layerViewsDirty=!1}initialize(){this._lercDecoder=Ape(this.view.resourceController),this._tilePool=this.view.state.isLocal?new Xi(FXe):new Xi(LXe);const t=this.view.resourceController.memoryController;this._upsampleMapCache=t.newCache("esri.views.3d.terrain.upsample",s=>s.unloadMapData()),this._elevationQueryCache=new AYe(t.newCache("elevation-query")),this._set("overlayManager",new An({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",s=>this._renderer.setNeedsHighlight(s)),this.watch("overlayManager.rendersOccluded",s=>this._renderer.setRenderOccludedOverlay(s))],"overlayManager"),this._renderer=new eet({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:Ut(this.view.spatialReference).radius,stage:this.view._stage,allTiles:this._allTiles}),this._handles.add([Ke(this,"baseOpacity",s=>{this._handleLayerViewChanges(),this._updateBaseOpacity(s)},!0),Ke(this,"_background",()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background)},!0),this.view.watch("pointsOfInterest",s=>{this._renderer.pointsOfInterest=s,this._watchUpdatingTracking.removeAll(),s&&this._watchUpdatingTracking.add(s.focus,"renderLocation",()=>()=>this._allTilesSorted=!1)}),Ke(Kt,"TERRAIN_TILE_TREE_SHOW_TILES",s=>{s&&!this._treeDebugger?import("./TerrainTileTree3DDebugger.c2429378.js").then(({TerrainTileTree3DDebugger:n})=>{!this._treeDebugger&&Kt.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new n({view:this.view}))}):s||(this._treeDebugger=tt(this._treeDebugger))})]),this._extentHelper=ZYe(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference});const e=this.view.defaultsFromMap?new i1({getCollections:()=>{var s,n,o;return(s=this.view)==null||(n=s.defaultsFromMap)==null||(o=n.mapCollections)==null?void 0:o.map(({layers:a})=>a)},getChildrenFunction:s=>s&&"layers"in s?s.layers:null}):this.view.map.allLayers,i=new Uc({layers:e,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",i),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);const r=this.view.resourceController.scheduler;this._frameTask=r.registerTask(Qe.TERRAIN_SURFACE,this),this.view.resourceController.memoryController.events.on("quality-changed",()=>this._viewChangeUpdate()),this._handles.add([Ke(this._extentHelper,"stencilEnabledExtents",s=>this._renderer.setStencilEnabledLayerExtents(s)),this.tilingSchemeLogic.watch("tilingScheme",()=>this._updateTilingScheme(),!0),Ke(this,"extent",()=>this._updateRootTiles()),this.view.on("resize",()=>this._viewChangeUpdate()),this.view.watch("state.camera",()=>this._viewChangeUpdate(),!0),this.view.watch("state.contentCamera",()=>this.view.state.fixedContentCamera&&this._viewChangeUpdate(),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",()=>this._viewChangeUpdate()),Ke(this.view,"qualitySettings.tiledSurface.textureFadeDuration",s=>this._renderer.textureFadingEnabled=s>0),this.view.watch("lodSnapping",()=>this._viewChangeUpdate()),hn(()=>this._userClippingExtent,()=>this._updateClippingExtent(),cbe)]),this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=nr(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=tt(this._upsampleMapCache),this._elevationQueryCache=tt(this._elevationQueryCache),this._set("tilingSchemeLogic",tt(this.tilingSchemeLogic)),this._extentHelper=tt(this._extentHelper),this._basemapLayerViewHandles.forEach((t,e)=>this._unregisterTiledLayerView(e)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",tt(this.overlayManager)),this._tilePool=tt(this._tilePool),vj.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=tt(this._renderer),this._iteratorPool=tt(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=tt(this._upsampleInfoPool),jYe(),EXe()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var t,e;const i=(t=this.view.pointsOfInterest)==null||(e=t.contentCameraOnSurface)==null?void 0:e.scale;if(i){const r=this.view.state.contentCamera;let s=MO(this.view,r.eye,r.viewForward,r.up).tilt;s>90&&(s=180-s);const n=2*(s/90)**2,o=Vae(this.view,i)-n;Math.abs(this._snapLevel-o)>cet&&(Math.round(o)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=o)}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?1:0}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:t}=this,{clippingArea:e}=this.view;if(A(e)||A(t))return null;const i=pt(),r=Wde(e,i,t)?i:null,s=this._get("extent");return qg(r,s)?s:r}get extent(){const t=uP(this.groundExtent,this._userClippingExtent,pt()),e=this._get("extent");return qg(t,e)?e:t}get groundExtent(){return st(this._tilingSchemeExtent,this._rootTilesExtent)}get _tilingSchemeExtent(){var t;return(t=this.tilingSchemeLogic)==null?void 0:t.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get viewingMode(){return this.view.state.viewingMode}get ready(){return _(this.rootTiles)}set renderOrder(t){this._renderer.renderOrder=t,this._set("renderOrder",t)}set skirtScale(t){this._renderer.skirtScale=t}get skirtScale(){return this._renderer.skirtScale}get spatialReference(){var t,e;return(t=(e=this.tilingScheme)==null?void 0:e.spatialReference)!=null?t:null}get _background(){return this.backgroundColor!=null?this.backgroundColor:this.backgroundImage}set slicePlaneEnabled(t){var e,i;this._renderer.slicePlaneEnabled=t,this._set("slicePlaneEnabled",t),(e=this.view)==null||(i=e._stage)==null||i.renderView.setRenderParameters({opaqueTerrain:this.opaque})}set velvetOverground(t){t!==this.velvetOverground&&(this._renderer.velvetOverground=t),this._set("velvetOverground",t)}set visible(t){t!==this._visible&&(this._visible=t,this._renderer.setVisibility(t),this.suspended=!t)}get opaque(){return this._renderer.opaque}set suspended(t){this._set("suspended",t),this._viewChangeUpdate()}intersect(t,e,i,r){this._renderer.intersect(t,e,i,r)}getElevation(t,e,i,r){const s=ap,n=this.getTileWithElevation(t,e,i,r,s);return A(n)?null:WI.sample(s[0],s[1],n.renderData.geometryState.samplerData)}getTileWithElevation(t,e,i,r,s=ap){var n;const o=this.rootTiles;if(A(o)||!o.length||o[0].layerInfo[0].length===0)return null;if(s[0]=t,s[1]=e,s[2]=i,!Ns(s,r,s,(n=this.tilingScheme)==null?void 0:n.spatialReference))return Sl.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let a of o){if(!a.containsPoint(s))continue;for(;a&&!a.rendered&&!a.isLeaf;){let c=0;s[0]>.5*(a.extent[0]+a.extent[2])&&(c+=1),s[1]<.5*(a.extent[1]+a.extent[3])&&(c+=2),a=a.children[c]}const l=a.renderData;return(l&&l.geometryState?l.geometryState.samplerData:null)?a:null}return null}get elevationBounds(){return this._elevationBounds}getScale(t){if(this.tilingScheme){if(!Gr(t,ap,this.spatialReference))return Sl.error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const e=this.rootTiles;if(_(e)){for(let i of e)if(i.containsPoint(ap)){for(;i.children[0]!=null;){let r=0;ap[0]>i.children[0].extent[2]&&(r+=1),ap[1]<i.children[0].extent[1]&&(r+=2),i=i.children[r]}return this._getLodBiasCorrectedScale(i.level)}}}return 1e100}getSphereScale(t,e){if(!this.tilingScheme)return null;if(!Gr(t,ap,this.spatialReference))return Sl.error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;ap[3]=e;let i=null;const r=n=>{if(n&&Qwe(n.extent,ap))if(n.children[0]!=null)for(const o of n.children)r(o);else{const o=this._getLodBiasCorrectedScale(n.level);i=i==null?o:Math.min(i,o)}},s=this.rootTiles;if(_(s))for(const n of s)r(n);return i}queryVisibleScaleRange(t,e,i,r){const s=e?this.tilingScheme.levelAtScale(e):0,n=i?this.tilingScheme.levelAtScale(i):1/0,o=this.lodBias;this._renderer.queryVisibleLevelRange(t,s+o,n+o,r)}_updateBaseOpacity(t){const e=this._renderer.opaque;this._renderer.opaque=t>=1,this._renderer.isTransparent=this._allTransparentSurfaceLayers();const i=e===this._renderer.opaque?2:1;var r,s;i===1&&((r=this.view)==null||(s=r._stage)==null||s.renderView.setRenderParameters({opaqueTerrain:this.opaque})),this._updateTileTextures(i)}_updateTilingScheme(){const t=this.tilingSchemeLogic.tilingScheme;t!==this.tilingScheme&&(Vc(!!t,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",t),this._updateClippingExtent(),t&&(this._updateTiledLayers(),this._renderer.setTileSize(t.pixelSize),this.overlayManager.setSpatialReference(t.spatialReference),this._updateRootTiles()))}_acquireTile(t,e,i,r){const s=this._tilePool.acquire();return l4[0]=t,l4[1]=e,l4[2]=i,s.init(l4,r,this),s}_updateRootTiles(){const{extent:t,tilingScheme:e}=this;if(!e)return;const i=det;let r=e.rootTilesInExtent(t,i,5*z_);if(_(this.rootTiles)){if(r.length>z_)return void Sl.warn(YFe);const s=this.rootTiles.map(o=>o.lij),n=Tye(s,r,dfe);if(n.removed.length>0||n.added.length>0){const o=this.rootTiles.filter(a=>!(n.removed.findIndex(l=>dfe(l,a.lij))>-1)||(this._purgeTile(a),!1));n.added.forEach(a=>o.push(this._newRootTile(a))),this._setRootTiles(o)}}else r.length>z_&&(Sl.warn(XFe),r=e.rootTilesInExtent(t,i,z_)),this._setRootTiles(r.map(s=>this._newRootTile(s)));qg(i,this._rootTilesExtent)||(this._rootTilesExtent=pt(i)),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready")}_newRootTile(t){const e=this._acquireTile(0,t[1],t[2],null);return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===2&&e.setPendingUpdate(2),this._loadTile(e),e}_setRootTiles(t){if(this._set("rootTiles",t),this._allTiles.clear(),_(t)){const e=this._iteratorPool.acquire();for(e.reset(t);!e.done;)this._allTiles.push(e.next());e.remove()}this._renderer.setRootTiles(this.rootTiles),this._updateTilesVisibility(t)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this._updateTilesVisibility(this.rootTiles)))}_updateClippingStatus(t){t.updateClippingStatus(this.extent)&&t.resetPendingUpdate(32)&&this._updateTileGeometry(t)}_updateTilesVisibility(t){if(A(t))return;const e=_Xe(t);let i=e?this._elevationBounds.min:1/0,r=e?this._elevationBounds.max:-1/0;const s=this.view.state.fixedContentCamera,n=this.extent,o=this._viewProjectionMatrix;this.setTileTreeDirty();const a=this._iteratorPool.acquire();for(a.reset(t);!a.done;){const l=a.next();l.updateClippingStatus(n)&&l.resetPendingUpdate(32)&&this._updateTileGeometry(l),l.setPendingUpdate(16);const c=l.updateVisibilityNow();s||c?(l.updateScreenDepth(o),l.renderData&&(i=Math.min(l.elevationBounds[0],i),r=Math.max(l.elevationBounds[1],r))):a.skipSubtree()}a.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(i)&&isFinite(r)&&(this._elevationBounds.min===i&&this._elevationBounds.max===r||(this._elevationBounds.min=i,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)))}_updateViewDependentParameters(){const t=this.view.state.camera,e=this.view.state.contentCamera,i=Math.tan(.5*e.fovX),r=Math.tan(.5*e.fovY),s=this.tilingScheme.pixelSize,n=2**-this.lodBias*t.pixelRatio;this._splitLimits.aboveGround=t.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/t.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/t.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(A(this._splitLimits.frustum)&&(this._splitLimits.frustum=mb()),rO(e.frustum,this._splitLimits.frustum)):this._splitLimits.frustum=null,rO(t.frustum,this._frustum),wi(this._viewProjectionMatrix,e.projectionMatrix,e.viewMatrix),re(this._eyePosRenderSR,e.eye),Ns(t.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateSkirts(){const t=this.view.state.camera,e=this.view.state.constraints.collision.enabled?0:1.11*t.near;this.skirtScale=rYe(this,this._eyePosSurfaceSR,e)}_updateRenderData(t){t.rendered&&!t.shouldLoad&&(G3(t)?this._loadChildren(t):het(t)&&this._loadParent(t))}_updateTileGeometry(t){t.updateVisibility(),this._renderer.updateTileGeometry(t),this._elevationUpdate(t),this._usedMemory=q3}_updateTileTexture(t,e){const i=t.resetPendingUpdate(128)?128:!!t.resetPendingUpdate(64)&&64;i&&(this._renderer.updateTileTexture(t,i),this._usedMemory=q3,e.madeProgress())}_elevationUpdate(t){u4.spatialReference=this.spatialReference,u4.tile=t,u4.extent=t.extent,this.emit("elevation-change",u4),K5(t.extent,this._eyePosSurfaceSR)&&this._updateSkirts()}get running(){return this.updating&&this.ready&&!this.suspended}runTask(t){this._handleLayerViewChanges(t),this._frameTask.processQueue(t),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(t),this._sortTiles(t);const e=!this.view.state.fixedContentCamera;this._mergeAndSplit(t,e),t.run(()=>this._updateElevation(t)),t.run(()=>this._updateTextures(t)),e||this._mergeAndSplit(t,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),t.done&&this.requestUpdate(),this.notifyChange("updatingProgressValue")}_updateTileStatus(t){if(!this._viewChanged||!this.rootTiles||t.done)return;this._viewChanged=!1;const e=this._iteratorPool.acquire();for(e.reset(this.rootTiles);!e.done;){const i=e.next();if(i.loadable){const r=i.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(r===2){i.resetPendingUpdate(8),i.isLeaf&&(i.setPendingUpdate(2),e.skipSubtree());continue}i.resetPendingUpdate(2)&&i.updateAgentSuspension(),r===4&&i.updateAgents(0)}if(e.skipSubtree(),!i.isLeaf){i.setPendingUpdate(8),i.resetPendingUpdate(2);const r=this._iteratorPool.acquire();r.resetOne(i);for(let s=r.next();!r.done;s=r.next())this._updateClippingStatus(s),s.updateVisibility(),s.loadable&&s.updateScreenDepth(this._viewProjectionMatrix);r.remove()}}e.remove(),this.requestUpdate(),t.madeProgress()}_sortTiles(t){t.done||this._allTilesSorted||(yXe(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),t.madeProgress())}_mergeAndSplit(t,e){if(this.suspended||t.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=0;for(;!t.done;){let r=!1;i=0;const s=!this._allTiles.some(n=>{if(i+=n.usedMemory,n.resetPendingUpdate(8)){if(!e)return n.setPendingUpdate(8),t.done;this._mergeTile(n),r=!0,t.madeProgress()}else n.resetPendingUpdate(2)&&(this._splitTile(n),r=!0,t.madeProgress());return!t.done&&n.resetPendingUpdate(16)&&(this._updateRenderData(n),t.madeProgress()),t.done});if(r&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(this._usedMemory=i,!r)break;this._updateTilesVisibility(this.rootTiles)}else this._allTilesDirty=!0}i===0&&(this._allTilesDirty=!0),this._sortTiles(t)}_updateElevation(t){return this._allTiles.some(e=>(e.resetPendingUpdate(32)&&(this._updateTileGeometry(e),this._updateTileTexture(e,t),t.madeProgress()),t.done)),t.hasProgressed}_updateTextures(t){return this._allTiles.some(e=>(this._updateTileTexture(e,t),t.done)),t.hasProgressed}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(1),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get lodBias(){const t=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-t)*ZFe}_getLodBiasCorrectedScale(t){const e=this.tilingScheme.levels,i=Re(t-this.lodBias,0,e.length-1),r=i-Math.floor(i);return e[Math.floor(i)].scale*(1-r)+e[Math.ceil(i)].scale*r}_removeAllTiles(){_(this.rootTiles)&&(this.rootTiles.forEach(t=>this._purgeTile(t)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1}_purgeChildTiles(t){if(t.isLeaf)return!1;let e=this._purgeTile(t.children[0]);return e=this._purgeTile(t.children[1])||e,e=this._purgeTile(t.children[2])||e,e=this._purgeTile(t.children[3])||e,t.unsetChildren(),e}_purgeTile(t){const e=this._purgeChildTiles(t)||t.rendered;return this._allTiles.removeUnordered(t),t.unload(this._renderer),this._tilePool.release(t),e}_splitTile(t){Vc(t.isLeaf,"tile that is already split should not be split again!");const e=t.level+1,i=2*t.lij[1],r=2*t.lij[2];t.setChildren(this._createTile(e,i,r,t),this._createTile(e,i,r+1,t),this._createTile(e,i+1,r,t),this._createTile(e,i+1,r+1,t)),t.setPendingUpdate(16),t.updateAgentSuspension(),this._allTiles.pushArray(t.children),this._allTilesDirty=!0,this._emitTileScaleChange(t,e),++this._performanceInfo.numSplit}_emitTileScaleChange(t,e=t.level){h4.spatialReference=this.spatialReference,h4.extent=t.extent,h4.scale=this._getLodBiasCorrectedScale(e),this.emit("scale-change",h4)}_createTile(t,e,i,r){Vc(!!r,"_createTile sanity check");const s=this._acquireTile(t,e,i,r);return s.updateClippingStatus(this.extent),s.loadable&&(s.updateScreenDepth(this._viewProjectionMatrix),s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===2&&s.setPendingUpdate(2)),s}_mergeTile(t){Vc(!t.hasPendingUpdate(2),"_mergeTile sanity check"),this._purgeChildTiles(t)&&(Vc(!t.renderData,"_mergeTile sanity check"),this._loadTile(t)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(t)}_loadChildren(t){Vc(t.rendered,"parent should be rendered"),t.unload(this._renderer),this._loadTile(t.children[0]),this._loadTile(t.children[1]),this._loadTile(t.children[2]),this._loadTile(t.children[3])}_loadParent(t){const e=t.parent;this._unloadChildren(e),this._loadTile(e)}_unloadChildren(t){t.isLeaf||(this._unloadChildren(t.children[0]),t.children[0].unload(this._renderer),this._unloadChildren(t.children[1]),t.children[1].unload(this._renderer),this._unloadChildren(t.children[2]),t.children[2].unload(this._renderer),this._unloadChildren(t.children[3]),t.children[3].unload(this._renderer))}_loadTile(t){t.load(this._renderer),t.setPendingUpdate(16),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(t),this._elevationUpdate(t)}_elevationDataArrived(t,e,i){const r=new WI(t.lij,t.extent,i);t.dataArrived(e,0,r);const s=[t],n=t.level,o=this._iteratorPool.acquire();for(o.reset(s);!o.done;){const a=o.next();a.findElevationBoundsForLayer(e,n),a.computeElevationBounds()}o.remove(),this._updateTilesVisibility(s)}_handleLayerViewChanges(t=V_){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let e=!1;const i=new Set;let r=-1;for(const s of this.view.allLayerViews.items)if(i.add(s.uid),nw(s))if(this._basemapLayerViewHandles.has(s.uid)){const n=this.layerClassFromLayerView(s),o=this._layerIndexByUid[n].get(s.uid);o<r&&(e=!0),r=o}else this._registerTiledLayerView(s),s.layer.loaded&&(e=!0);this._basemapLayerViewHandles.forEach((s,n)=>{i.has(n)||(this._unregisterTiledLayerView(n),e=!0)}),e&&this._updateTiledLayers(),this._renderer.isTransparent=this._allTransparentSurfaceLayers(),t.madeProgress()}_allTransparentSurfaceLayers(){let t=this.view.map.ground.opacity===0;for(const e of this.view.allLayerViews.items)if(nw(e)&&!UI(e)&&!DQ(e.layer)&&e.fullOpacity!==0)return t=!1,t;return t}layerClassFromLayerView(t){return UI(t)?0:1}_registerTiledLayerView(t){const e=[],i=this.layerClassFromLayerView(t);e.push(t.watch("suspended",()=>this._updateTiledLayers())),e.push(t.watch("fullOpacity",()=>this._updateTileTextures(2))),e.push(t.layer.watch("scaleRangeId",()=>this._restartAllAgents(i))),t.on("data-changed",()=>{const r=this._layerIndexByUid[i].get(t.uid);r!=null&&this._invalidateLayerData(r,i)}),this._basemapLayerViewHandles.set(t.uid,e)}_unregisterTiledLayerView(t){const e=this._basemapLayerViewHandles.get(t);if(e){for(let i=0;i<e.length;i++)e[i].remove();this._basemapLayerViewHandles.delete(t)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const t=this.view.allLayerViews,e=[[],[]];let i=null;const r=ja();t.forEach(s=>{const n=s.layer;if(!n||s.suspended||!nw(s))return;const o=s.fullExtent;if(!o)return void Sl.warn("Terrain: Map or elevation layer does not have fullExtent: "+n.id);if(!this.tilingScheme.compatibleWith(s.tileInfo))return void Sl.warn("Terrain: tiling scheme of layer "+n.id+" is incompatible with other tiled layers, will not be drawn");Gp(r,o,r);const a=this.layerClassFromLayerView(s);if(a===1){const l=s.displayLevelRange;l.maxLevel!==1/0&&(i===null||l.maxLevel>i)&&(i=l.maxLevel)}e[a].push(s)});for(const s of Sv){const n=this._layerViews[s],o=e[s];o.reverse();const a=o.length;let l=n.length!==a;const c=new Array(a),h=new Array(n.length);this._layerIndexByUid[s].clear();for(let p=0;p<a;p++){const f=o[p].uid;this._layerIndexByUid[s].set(f,p);const g=n.indexOf(o[p]);c[p]=g,p!==g&&(l=!0),g>-1&&(h[g]=p)}if(l){const p=this._postorderIterator;for(p.reset(this.rootTiles);!p.done;)p.next().modifyLayers(h,c,s);this._layerViews[s]=o,this._restartAllAgents(s),this._updateTilesVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(t){const e=this._postorderIterator;for(e.reset(this.rootTiles);!e.done;){const i=e.next();i.restartAgents(t),t===0&&i.computeElevationBounds()}}layerViewByIndex(t,e){return this._layerViews[e][t]}numLayers(t){return this._layerViews[t].length}_updateTileTextures(t){this._allTiles.forAll(e=>{e.updateAgents(1),t===1?this.renderer.updateTileTexture(e,64):e.updateRenderData(1,t)}),this._renderer.isTransparent=this._allTransparentSurfaceLayers()}_invalidateLayerData(t,e){this._allTiles.forAll(i=>i.removeLayerAgent(t,e)),this._allTiles.forAll(i=>i.invalidateLayerData(t,e))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(t=1){this.renderer.setNeedsRender(t)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(t,e,i,r){const s=this.layerViewByIndex(e,i),n=s.layer;return!n.tilemapCache||NI(s)?this._requestTileData(t,i,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(t.lij[0],t.lij[1],t.lij[2],he(E({},r),{timeout:6e3})).then(()=>--this._asyncWorkItems).catch(o=>{throw--this._asyncWorkItems,bi(o)||this._dataMissing(t,i,s,{notInTilemap:!0}),o}).then(()=>this._frameTask.schedule(()=>this._requestTileData(t,i,s,r),r.signal)))}_requestTileData(t,e,i,r){return e===0?this._requestElevationTileData(t,i,r):this._requestMapTileData(t,i,r)}_requestElevationTileData(t,e,i){if(!UI(e))return void Vc(!1,"_requestElevationTileData can only be called for elevation layer views");const r=o=>{if(--this._asyncWorkItems,Ir(i))return;const a=this._layerIndexByUid[0].get(e.uid);a!=null?(this._usedMemory=q3,this.requestUpdate(),this._elevationDataArrived(t,a,o)):Sl.warn("TerrainSurface: received data from unknown layer %d %s",0,t.lij.toString())},s=o=>{--this._asyncWorkItems,bi(o)||(this._dataMissing(t,0,e,o),this.requestUpdate())};if(++this._asyncWorkItems,wpe(e.layer))return e.layer.fetchTile(t.lij[0],t.lij[1],t.lij[2],{noDataValue:CS,signal:i.signal}).then(o=>{if(Ir(i))return Sl.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s($t());this._frameTask.schedule(()=>r(o),i.signal,s)},s);const n=e.getTileUrl(t.lij[0],t.lij[1],t.lij[2]);return this._elevationDataRequester.request(n,"binary",i).then(o=>this._lercDecoder.decode(o,{noDataValue:CS},i.signal)).then(o=>{r({values:o.pixelData,width:o.width,height:o.height,noDataValue:o.noDataValue,minValue:o.minValue,maxValue:o.maxValue})},s)}_requestMapTileData(t,e,i){if(e instanceof Ipe)return Promise.reject();++this._asyncWorkItems;const r=(c,h)=>{--this._asyncWorkItems,ow(h),Ir(i)||(this._dataMissing(t,1,e,c),this.requestUpdate())},s=c=>h=>r(h,c),n=c=>this._frameTask.schedule(()=>{--this._asyncWorkItems,this.requestUpdate(),Ir(i)?ow(c):this._mapTileDataArrived(t,e,c)},i.signal,s(c)).catch(s(c)),o=(c,h=null)=>this._frameTask.schedule(()=>r(c,h));if(NI(e)){const c=e.schemaHelper.getLevelRowColumn(t.lij);return e.fetchTile(c[0],c[1],c[2],i).then(n,o)}if(oj(e))return e.fetchTile(t.lij[0],t.lij[1],t.lij[2],i).then(n,o);if(bpe(e)&&wpe(e.layer))return e.layer.fetchTile(t.lij[0],t.lij[1],t.lij[2],i).then(c=>{if(Ir(i))return Sl.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void o($t());n(c)},o);let a=e.getTileUrl(t.lij[0],t.lij[1],t.lij[2]);I4e(e.layer)&&e.layer.refreshTimestamp&&(a+=`${a.includes("?")?"&":"?"}_ts=${e.layer.refreshTimestamp}`);const l=e.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(a,l,i).then(n,o)}_mapTileDataArrived(t,e,i){const r=this._layerIndexByUid[1].get(e.uid);r!=null?t.dataArrived(r,1,i):(ow(i),Sl.warn("TerrainSurface: received data from unknown layer"))}_dataMissing(t,e,i,r){const s=this._layerIndexByUid[e].get(i.uid);s!=null?t.dataMissing(s,e,r):Sl.warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(t){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll(e=>{e.renderData&&this.overlayManager.setTileParameters(e)}),this._renderer.setNeedsRender(t))}get performanceInfo(){const t=this._performanceInfo;return t.numNodes=this._allTiles.length,t.numLeaves=t.numVisible=t.numRendered=t.numLoadedPerLevel.length=t.numRenderedPerLevel.length=0,this._allTiles.forAll(e=>{e.isLeaf&&t.numLeaves++;const i=e.level;e.renderData&&(t.numLoadedPerLevel[i]=(t.numLoadedPerLevel[i]||0)+1),e.visible&&(t.numVisible++,e.rendered&&(t.numRenderedPerLevel[i]=(t.numRenderedPerLevel[i]||0)+1,t.numRendered++))}),t}getUsedMemory(){return this.tilingScheme?(this._usedMemory===q3&&(this._usedMemory=0,this._allTiles.forAll(t=>this._usedMemory+=t.usedMemory)),this._usedMemory):0}getUsedMemoryForLayerView(t){let e=0;const i=this.layerClassFromLayerView(t),r=this._layerIndexByUid[i].get(t.uid);return this._allTiles.forAll(s=>e+=s.getUsedMemoryForLayer(i,r)),e}getTile(t){if(A(t)||A(this.rootTiles))return null;const e=t.split("/").map(o=>+o);if(e[0]===0)return this.rootTiles.find(o=>o.lij[1]===e[1]&&o.lij[2]===e[2]);const i=2**e[0],r=Math.floor(e[1]/i),s=Math.floor(e[2]/i);let n;if(this.rootTiles.some(o=>o.lij[1]===r&&o.lij[2]===s&&(n=o,!0)),n){let o=1<<e[0]-1;for(;n.lij[0]<e[0];){let a=e[1]&o?2:0;if((e[2]&o)>0&&a++,!n.children[a])return null;n=n.children[a],o>>=1}return Vc(n.lij[0]===e[0]&&n.lij[1]===e[1]&&n.lij[2]===e[2],"not the right tile?"),n}return null}get test(){const t=this;return{renderer:t._renderer,lercDecoder:t._lercDecoder,forceReload:()=>{_(t.rootTiles)&&(t._mergeTile(t.rootTiles[0]),t._viewChangeUpdate())},getTiles:()=>t._allTiles.toArray(),getRenderedTiles:()=>(c4.clear(),t._allTiles.forAll(e=>{e.visible&&e.rendered&&c4.push(e)}),qpe(t.renderOrder,c4),c4.toArray()),lockTilingScheme(e,i){t._extentHelper.defaultTiledLayersExtent=i,t.tilingSchemeLogic.test.lockTilingScheme(e)}}}};u([d()],ft.prototype,"_renderer",void 0),u([d()],ft.prototype,"_hasPendingUpdates",void 0),u([d()],ft.prototype,"_asyncWorkItems",void 0),u([d()],ft.prototype,"_allTilesDirty",void 0),u([d()],ft.prototype,"_allTilesSorted",void 0),u([d()],ft.prototype,"_viewChanged",void 0),u([d({readOnly:!0})],ft.prototype,"_watchUpdatingTracking",void 0),u([d()],ft.prototype,"_frameTask",void 0),u([d({readOnly:!0})],ft.prototype,"snapLevel",null),u([d({readOnly:!0})],ft.prototype,"lodSnapping",null),u([d({constructOnly:!0})],ft.prototype,"view",void 0),u([d()],ft.prototype,"_userClippingExtent",null),u([d()],ft.prototype,"_rootTilesExtent",void 0),u([d({readOnly:!0})],ft.prototype,"extent",null),u([d({readOnly:!0})],ft.prototype,"groundExtent",null),u([d({readOnly:!0})],ft.prototype,"_tilingSchemeExtent",null),u([d({readOnly:!0})],ft.prototype,"updating",null),u([d(Rpe)],ft.prototype,"updatingProgress",void 0),u([d({readOnly:!0})],ft.prototype,"updatingProgressValue",null),u([d()],ft.prototype,"_maxNumUpdating",void 0),u([d({aliasOf:"view.map.ground.opacity"})],ft.prototype,"baseOpacity",void 0),u([d({readOnly:!0})],ft.prototype,"overlayManager",void 0),u([d({readOnly:!0})],ft.prototype,"viewingMode",null),u([d()],ft.prototype,"maxTextureScale",void 0),u([d({readOnly:!0})],ft.prototype,"ready",null),u([d({value:1})],ft.prototype,"renderOrder",null),u([d({readOnly:!0})],ft.prototype,"rootTiles",void 0),u([d({readOnly:!0})],ft.prototype,"spatialReference",null),u([d()],ft.prototype,"backgroundImage",void 0),u([d({type:Ae,aliasOf:"view.map.ground.surfaceColor"})],ft.prototype,"backgroundColor",void 0),u([d()],ft.prototype,"_background",null),u([d({value:!1})],ft.prototype,"slicePlaneEnabled",null),u([d({readOnly:!0})],ft.prototype,"tilingScheme",void 0),u([d({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],ft.prototype,"tilingSchemeLocked",void 0),u([d({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],ft.prototype,"tilingSchemeDone",void 0),u([d({readOnly:!0})],ft.prototype,"tilingSchemeLogic",void 0),u([d({value:!0})],ft.prototype,"velvetOverground",null),u([Ve("_renderer.wireframe")],ft.prototype,"wireframe",void 0),u([d({value:!1})],ft.prototype,"suspended",null),u([d({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],ft.prototype,"textureFadeDuration",void 0),u([d()],ft.prototype,"_layerViewsDirty",void 0),u([Ve("_renderer.renderPatchBorders")],ft.prototype,"renderPatchBorders",void 0),u([Ve("_renderer.renderingDisabled")],ft.prototype,"renderingDisabled",void 0),ft=u([R("esri.views.3d.terrain.TerrainSurface")],ft);const uet=ft;function dfe(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function G3(t){return!t.isLeaf&&(t.children[0].shouldLoad||t.children[1].shouldLoad||t.children[2].shouldLoad||t.children[3].shouldLoad||G3(t.children[0])||G3(t.children[1])||G3(t.children[2])||G3(t.children[3]))}function het(t){return t.isLeaf&&t.parent&&t.parent.shouldLoad}const q3=-1,ap=Ot(),det=pt(),l4=[0,0,0],c4=new ct,u4={spatialReference:null,tile:null,extent:null,context:"ground"},h4={spatialReference:null,extent:null,scale:0};let H3=class extends ve{constructor(t){super(t),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commit(t){this.dirty=!1,this._dirtyGeomRecords.forEach((e,i)=>this.commitLayer(i,t))}commitLayer(t,e){const i=this._dirtyGeomRecords.get(t);i&&(i.forEach((r,s)=>{const n=this._ensureGeomRecord(t,s);r.forEach((o,a)=>{const l=o[0],c=o[1],h=o[2];let p=!1;if(2&c){const f=n.get(a);if(f){const g=f[1];if(4&h){const y=this.model.getObject(s);this.model.updateRenderGeometryTransformation(y,l,g)&&(p=!0)}p||e.updates.push({renderGeometry:g,updateType:h})}else Ze(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(4&c||p){const f=n.get(a);f?(e.removes.push(f[1]),n.delete(a),f[0].disposed&&G0.pool.release(f[0])):c===4&&Ze(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(1&c||p){const f=this.model.getObject(s);if(_(f)){const g=this.model.getRenderGeometry(f,l),y=[l,g];e.adds.push(g),n.set(a,y)}}}),n.size===0&&this._residentGeomRecords.get(t).delete(s)}),this._residentGeomRecords.get(t).size===0&&this._residentGeomRecords.delete(t),this._dirtyGeomRecords.delete(t))}getResidentRenderGeometries(t,e){const i=this._residentGeomRecords.get(t);i&&i.forEach(r=>r.forEach(s=>e.push(s[1])))}_objectStateChanged(t,e){for(const i of e.geometryRecords)this._updateOrCreateDirtyRecord(e,i,null,2,0,0,2,5,t)}visibilityChanged(t){this._objectStateChanged(1,t)}highlightChanged(t){this._objectStateChanged(8,t)}occlusionChanged(t){this._objectStateChanged(16,t)}vertexAttrsUpdated(t){this._updateOrCreateDirtyRecord(t.object,t.record,null,2,0,0,2,5,2)}layerAdded(t){t.objects.forAll(e=>this._layerObjectAdded(t,e))}layerRemoved(t){t.objects.forAll(e=>this._layerObjectRemoved(t,e))}layerObjectAdded(t){this._layerObjectAdded(t.layer,t.object)}_layerObjectAdded(t,e){const i=t.id;for(const r of e.geometryRecords)this._objectGeometryAdded(e,r,i)}layerObjectRemoved(t){this._layerObjectRemoved(t.layer,t.object)}layerObjectsAdded(t){for(const e of t.objects)this._layerObjectAdded(t.layer,e)}layerObjectsRemoved(t){for(const e of t.objects)this._layerObjectRemoved(t.layer,e)}_layerObjectRemoved(t,e){const i=t.id;for(const r of e.geometryRecords)this._objectGeometryRemoved(e,r,i)}shaderTransformationChanged(t){const e=this._residentGeomRecords.get(t.id);e&&e.forEach((i,r)=>{const s=this.model.getObject(r);s&&s.hasVolativeTransformation()&&i.forEach(n=>{n[1].shaderTransformationChanged()})})}objectTransformation(t){const e=this._getParentLayerId(t),i=t.id;this._ensureGeomRecord(e,i).forEach(r=>{this._updateOrCreateDirtyRecord(t,r[0],e,2,0,0,2,5,4)})}objectGeometryAdded(t){this._objectGeometryAdded(t.object,t.record)}_objectGeometryAdded(t,e,i=null){this._updateOrCreateDirtyRecord(t,e,i,1,4,0,0,0)}objectGeometryRemoved(t){this._objectGeometryRemoved(t.object,t.record)}_objectGeometryRemoved(t,e,i=null){this._updateOrCreateDirtyRecord(t,e,i,4,1,2,0,0)}_updateOrCreateDirtyRecord(t,e,i,r,s,n,o,a,l){i=st(i,this._getParentLayerId(t));const c=t.id,h=e.id,p=this._ensureDirtyRecord(i,c),f=p.get(h);if(f){const g=f[1];g&s?(p.delete(h),f[0].disposed&&G0.pool.release(f[0])):g&n?(f[1]=r,f[2]=l):g&o?f[2]|=l:g&a||Ze(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state")}else p.set(h,[e,r,l]);this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(t,e){let i=this._residentGeomRecords.get(t);i||(i=new Map,this._residentGeomRecords.set(t,i));let r=i.get(e);return r||(r=new Map,i.set(e,r)),r}get _hasDirtyGeometryRecords(){return vr(this._dirtyGeomRecords,t=>vr(t,e=>e&&e.size>0))}_ensureDirtyRecord(t,e){let i=this._dirtyGeomRecords.get(t);i||(i=new Map,this._dirtyGeomRecords.set(t,i));let r=i.get(e);return r||(r=new Map,i.set(e,r)),r}_getParentLayerId(t){return _(t.parentLayer)?t.parentLayer.id:b0e}formatDebugInfo(){const t=["ADD","UPD",void 0,"REM"];let e="";return this._dirtyGeomRecords.forEach((i,r)=>{i.forEach((s,n)=>{e.length>0&&(e+=`
`),e+=r+"."+n;const o=[];s.forEach(a=>{const l=a[1];o[l]||(o[l]=[]),o[l].push(a[0].geometry.id)});for(let a=0;a<o.length;a++)if(o[a]){e+=" "+t[a-1]+": ";for(let l=0;l<o[a].length;l++)e+=o[a][l]+", "}})}),e}get test(){const t=this;return{get residentLayerCount(){return t._residentGeomRecords.size},get residentObjectCount(){return Array.from(t._residentGeomRecords.values()).reduce((e,i)=>e+i.size,0)}}}};u([d({constructOnly:!0})],H3.prototype,"model",void 0),u([d()],H3.prototype,"dirty",void 0),H3=u([R("esri.views.3d.webgl-engine.lib.ModelDirtySet")],H3);const pet=H3;let d4=class extends ve{constructor(){super(...arguments),this.dirtySet=new pet({model:this}),this._content=new Map,this._originFactory=new D7(null,75e4)}getObject(t){return this._content.get(t)}add(t){const e=t.id;Ze(!this._content.has(e),"Model/Stage already contains object to be added"),this._content.set(e,t),dR(t)&&this.dirtySet.layerAdded(t)}remove(t){Ze(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload(),dR(t)&&this.dirtySet.layerRemoved(t)}addMany(t){for(const e of t)_(e)&&(Ze(!this._content.has(e.id),"Model/Stage already contains object to be added"),this._content.set(e.id,e))}removeMany(t){for(const e of t)Ze(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload()}has(t){return this._content.has(t.id)}forEachOfType(t,e){this._content.forEach(i=>{i.type===t&&e(i)})}getRenderGeometry(t,e){const{geometry:i,material:r,id:s,shaderTransformation:n,origin:o,instanceParameters:a}=e,l=new Gb(i,r,null,null,s,i.boundingInfo,n,t.castShadow);return l.updateTransformation(c=>t.getCombinedStaticTransformation(e,c)),l.origin=o||this._originFactory.getOrigin(l.boundingSphere),l.instanceParameters=a,l}updateRenderGeometryTransformation(t,e,i){if(A(t))return!1;i.updateTransformation(s=>t.getCombinedStaticTransformation(e,s));const r=this._originFactory.getOrigin(i.boundingSphere);return i.origin!==r}getStats(){const t={},e=Array.from(this._content.values());for(let i=0;i<5;++i)t[i]=e.filter(r=>r.type===i).length;return{contentTypes:t,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};u([d({constructOnly:!0})],d4.prototype,"dirtySet",void 0),d4=u([R("esri.views.3d.webgl-engine.parts.Model")],d4);function fet(){const t=new Float32Array(4);return t[3]=1,t}function pfe(t){const e=new Float32Array(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function met(t,e,i,r){const s=new Float32Array(4);return s[0]=t,s[1]=e,s[2]=i,s[3]=r,s}function ffe(t,e){return new Float32Array(t,e,4)}Object.freeze({__proto__:null,create:fet,clone:pfe,fromValues:met,createView:ffe});const pw=1e-6,W3=[0,0,0],p4=[0,0,0];function get(t,e){const{data:i,size:r}=t,s=i.length/r;if(s<=0)return;const n=new Met(t);g4(W3,n.minProj,n.maxProj),Av(W3,W3,.5),Al(p4,n.maxProj,n.minProj);const o=Dj(p4),a=new Pet;a.quality=o,s<14&&(t={data:new Float64Array(n.buffer,112,42),size:3});const l=[0,0,0],c=[0,0,0],h=[0,0,0],p=[0,0,0],f=[0,0,0],g=[0,0,0],y=[0,0,0];switch(yet(n,t,y,l,c,h,p,f,g,a)){case 1:return void vfe(W3,p4,e);case 2:return void Cet(t,p,e)}vet(t,y,l,c,h,p,f,g,a),bfe(t,a.b0,a.b1,a.b2,vw,_w);const v=[0,0,0];Al(v,_w,vw),a.quality=Dj(v),a.quality<o?wfe(a.b0,a.b1,a.b2,vw,_w,v,e):vfe(W3,p4,e)}function yet(t,e,i,r,s,n,o,a,l,c){return _et(t,r,s),Fj(r,s)<pw?1:(Al(o,r,s),Es(o,o),bet(e,r,o,n)<pw?2:(Al(a,s,n),Es(a,a),Al(l,n,r),Es(l,l),$l(i,a,o),Es(i,i),Pv(e,i,o,a,l,c),0))}const Z3=[0,0,0],J3=[0,0,0],Tl=[0,0,0],Cl=[0,0,0],Ml=[0,0,0],Jm=[0,0,0],Qm=[0,0,0],Ym=[0,0,0];function vet(t,e,i,r,s,n,o,a,l){wet(t,e,i,Z3,J3),Z3[0]!==void 0&&(Al(Tl,Z3,i),Es(Tl,Tl),Al(Cl,Z3,r),Es(Cl,Cl),Al(Ml,Z3,s),Es(Ml,Ml),$l(Jm,Cl,n),Es(Jm,Jm),$l(Qm,Ml,o),Es(Qm,Qm),$l(Ym,Tl,a),Es(Ym,Ym),Pv(t,Jm,n,Cl,Tl,l),Pv(t,Qm,o,Ml,Cl,l),Pv(t,Ym,a,Tl,Ml,l)),J3[0]!==void 0&&(Al(Tl,J3,i),Es(Tl,Tl),Al(Cl,J3,r),Es(Cl,Cl),Al(Ml,J3,s),Es(Ml,Ml),$l(Jm,Cl,n),Es(Jm,Jm),$l(Qm,Ml,o),Es(Qm,Qm),$l(Ym,Tl,a),Es(Ym,Ym),Pv(t,Jm,n,Cl,Tl,l),Pv(t,Qm,o,Ml,Cl,l),Pv(t,Ym,a,Tl,Ml,l))}function _et(t,e,i){let r=Fj(t.maxVert[0],t.minVert[0]),s=0;for(let n=1;n<7;++n){const o=Fj(t.maxVert[n],t.minVert[n]);o>r&&(r=o,s=n)}Vo(e,t.minVert[s]),Vo(i,t.maxVert[s])}const Pl=[0,0,0];function bet(t,e,i,r){const{data:s,size:n}=t;let o=Number.NEGATIVE_INFINITY,a=0;for(let l=0;l<s.length;l+=n){Pl[0]=s[l]-e[0],Pl[1]=s[l+1]-e[1],Pl[2]=s[l+2]-e[2];const c=i[0]*Pl[0]+i[1]*Pl[1]+i[2]*Pl[2],h=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],p=Pl[0]*Pl[0]+Pl[1]*Pl[1]+Pl[2]*Pl[2]-c*c/h;p>o&&(o=p,a=l)}return Vo(r,s,a),o}const Nr=[0,0];function wet(t,e,i,r,s){Tet(t,e,Nr,s,r);const n=Sfe(i,e);Nr[1]-pw<=n&&(r[0]=void 0),Nr[0]+pw>=n&&(s[0]=void 0)}const mfe=[0,0,0],gfe=[0,0,0],yfe=[0,0,0],fw=[0,0,0],mw=[0,0,0],f4=[0,0,0];function Pv(t,e,i,r,s,n){if(xfe(e)<pw)return;$l(mfe,i,e),$l(gfe,r,e),$l(yfe,s,e),gw(t,e,Nr),mw[1]=Nr[0],fw[1]=Nr[1],f4[1]=fw[1]-mw[1];const o=[i,r,s],a=[mfe,gfe,yfe];for(let l=0;l<3;++l){gw(t,o[l],Nr),mw[0]=Nr[0],fw[0]=Nr[1],gw(t,a[l],Nr),mw[2]=Nr[0],fw[2]=Nr[1],f4[0]=fw[0]-mw[0],f4[2]=fw[2]-mw[2];const c=Dj(f4);c<n.quality&&(Vo(n.b0,o[l]),Vo(n.b1,e),Vo(n.b2,a[l]),n.quality=c)}}const xet=[0,0,0];function gw(t,e,i){const{data:r,size:s}=t;i[0]=Number.POSITIVE_INFINITY,i[1]=Number.NEGATIVE_INFINITY;for(let n=0;n<r.length;n+=s){const o=r[n]*e[0]+r[n+1]*e[1]+r[n+2]*e[2];i[0]=Math.min(i[0],o),i[1]=Math.max(i[1],o)}}function Tet(t,e,i,r,s){const{data:n,size:o}=t;Vo(r,n),Vo(s,r),i[0]=Sfe(xet,e),i[1]=i[0];for(let a=o;a<n.length;a+=o){const l=n[a]*e[0]+n[a+1]*e[1]+n[a+2]*e[2];l<i[0]&&(i[0]=l,Vo(r,n,a)),l>i[1]&&(i[1]=l,Vo(s,n,a))}}function vfe(t,e,i){Vo(i.center,t),Av(i.halfSize,e,.5),i.quaternion[0]=0,i.quaternion[1]=0,i.quaternion[2]=0,i.quaternion[3]=1}const lp=[0,0,0],yw=[0,0,0],Q3=[0,0,0],vw=[0,0,0],_w=[0,0,0],_fe=[0,0,0];function Cet(t,e,i){Vo(lp,e),Math.abs(e[0])>Math.abs(e[1])&&Math.abs(e[0])>Math.abs(e[2])?lp[0]=0:Math.abs(e[1])>Math.abs(e[2])?lp[1]=0:lp[2]=0,xfe(lp)<pw&&(lp[0]=lp[1]=lp[2]=1),$l(yw,e,lp),Es(yw,yw),$l(Q3,e,yw),Es(Q3,Q3),bfe(t,e,yw,Q3,vw,_w),Al(_fe,_w,vw),wfe(e,yw,Q3,vw,_w,_fe,i)}function bfe(t,e,i,r,s,n){gw(t,e,Nr),s[0]=Nr[0],n[0]=Nr[1],gw(t,i,Nr),s[1]=Nr[0],n[1]=Nr[1],gw(t,r,Nr),s[2]=Nr[0],n[2]=Nr[1]}const m4=[0,0,0],ph=[1,0,0,0,1,0,0,0,1],bw=[0,0,0];function wfe(t,e,i,r,s,n,o){ph[0]=t[0],ph[1]=t[1],ph[2]=t[2],ph[3]=e[0],ph[4]=e[1],ph[5]=e[2],ph[6]=i[0],ph[7]=i[1],ph[8]=i[2],Aet(o.quaternion,ph),g4(bw,r,s),Av(bw,bw,.5),Av(o.center,t,bw[0]),Av(m4,e,bw[1]),g4(o.center,o.center,m4),Av(m4,i,bw[2]),g4(o.center,o.center,m4),Av(o.halfSize,n,.5)}const xa=7;class Met{constructor(e){this.minVert=new Array(xa),this.maxVert=new Array(xa);const i=64*xa;this.buffer=new ArrayBuffer(i);let r=0;this.minProj=new Float64Array(this.buffer,r,xa),r+=8*xa,this.maxProj=new Float64Array(this.buffer,r,xa),r+=8*xa;for(let l=0;l<xa;++l)this.minVert[l]=new Float64Array(this.buffer,r,3),r+=24;for(let l=0;l<xa;++l)this.maxVert[l]=new Float64Array(this.buffer,r,3),r+=24;for(let l=0;l<xa;++l)this.minProj[l]=Number.POSITIVE_INFINITY,this.maxProj[l]=Number.NEGATIVE_INFINITY;const s=new Array(xa),n=new Array(xa),{data:o,size:a}=e;for(let l=0;l<o.length;l+=a){let c=o[l];c<this.minProj[0]&&(this.minProj[0]=c,s[0]=l),c>this.maxProj[0]&&(this.maxProj[0]=c,n[0]=l),c=o[l+1],c<this.minProj[1]&&(this.minProj[1]=c,s[1]=l),c>this.maxProj[1]&&(this.maxProj[1]=c,n[1]=l),c=o[l+2],c<this.minProj[2]&&(this.minProj[2]=c,s[2]=l),c>this.maxProj[2]&&(this.maxProj[2]=c,n[2]=l),c=o[l]+o[l+1]+o[l+2],c<this.minProj[3]&&(this.minProj[3]=c,s[3]=l),c>this.maxProj[3]&&(this.maxProj[3]=c,n[3]=l),c=o[l]+o[l+1]-o[l+2],c<this.minProj[4]&&(this.minProj[4]=c,s[4]=l),c>this.maxProj[4]&&(this.maxProj[4]=c,n[4]=l),c=o[l]-o[l+1]+o[l+2],c<this.minProj[5]&&(this.minProj[5]=c,s[5]=l),c>this.maxProj[5]&&(this.maxProj[5]=c,n[5]=l),c=o[l]-o[l+1]-o[l+2],c<this.minProj[6]&&(this.minProj[6]=c,s[6]=l),c>this.maxProj[6]&&(this.maxProj[6]=c,n[6]=l)}for(let l=0;l<xa;++l){let c=s[l];Vo(this.minVert[l],o,c),c=n[l],Vo(this.maxVert[l],o,c)}}}class Pet{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}function Dj(t){return t[0]*t[1]+t[0]*t[2]+t[1]*t[2]}function g4(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2]}function Al(t,e,i){t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2]}function Av(t,e,i){t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}function Vo(t,e,i=0){t[0]=e[i+0],t[1]=e[i+1],t[2]=e[i+2]}function $l(t,e,i){const r=e[0],s=e[1],n=e[2],o=i[0],a=i[1],l=i[2];t[0]=s*l-n*a,t[1]=n*o-r*l,t[2]=r*a-s*o}function Es(t,e){const i=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(i>0){const r=1/Math.sqrt(i);t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r}}function xfe(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}function Fj(t,e){const i=e[0]-t[0],r=e[1]-t[1],s=e[2]-t[2];return i*i+r*r+s*s}function Sfe(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Aet(t,e){const i=e[0]+e[4]+e[8];if(i>0){let r=Math.sqrt(i+1);t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r}else{let r=0;e[4]>e[0]&&(r=1),e[8]>e[3*r+r]&&(r=2);const s=(r+1)%3,n=(r+2)%3;let o=Math.sqrt(e[3*r+r]-e[3*s+s]-e[3*n+n]+1);t[r]=.5*o,o=.5/o,t[3]=(e[3*s+n]-e[3*n+s])*o,t[s]=(e[3*s+r]+e[3*r+s])*o,t[n]=(e[3*n+r]+e[3*r+n])*o}}const Y3=pf(),$v=$(),$et=$(),Eet=Ai();class ilt{constructor(e){const i=56,r=0,s=24,n=36,o=e*i;this.buffer=new ArrayBuffer(o),this.obbs=new Array(e);for(let a=0;a<e;a++)this.obbs[a]={center:wF(this.buffer,i*a+r),halfSize:One(this.buffer,i*a+s),quaternion:ffe(this.buffer,i*a+n)}}}function Tfe(t=[0,0,0],e=[-1,-1,-1],i=[0,0,0,1]){return{center:br(t),halfSize:IE(e),quaternion:pfe(i)}}function Oet(t){return Tfe(t.center,t.halfSize,t.quaternion)}function rlt(t,e){re(e.center,t.center),re(e.halfSize,t.halfSize),xne(e.quaternion,t.quaternion)}function slt(t,e){return e=e||Tfe(),get(t,e),e}function Ev(t,e){const i=hi(e,t.center),r=y4(t,Li(e));return i>r?1:i<-r?-1:0}function nlt(t,e){e||(e=lr());const i=bV(Eet,t.quaternion),r=t.halfSize[0]*Math.abs(i[0])+t.halfSize[1]*Math.abs(i[3])+t.halfSize[2]*Math.abs(i[6]),s=t.halfSize[0]*Math.abs(i[1])+t.halfSize[1]*Math.abs(i[4])+t.halfSize[2]*Math.abs(i[7]),n=t.halfSize[0]*Math.abs(i[2])+t.halfSize[1]*Math.abs(i[5])+t.halfSize[2]*Math.abs(i[8]);return e[0]=t.center[0]-r,e[1]=t.center[1]-s,e[2]=t.center[2]-n,e[3]=t.center[0]+r,e[4]=t.center[1]+s,e[5]=t.center[2]+n,e}function olt(t,e){return hi(e,t.center)-y4(t,Li(e))}function alt(t,e){return hi(e,t.center)+y4(t,Li(e))}function llt(t,e){return Ev(t,e[0])<=0&&Ev(t,e[1])<=0&&Ev(t,e[2])<=0&&Ev(t,e[3])<=0&&Ev(t,e[4])<=0&&Ev(t,e[5])<=0}function clt(t,e,i,r=0){qS(Y3,t.quaternion),ue($v,e,t.center);const s=Ep($v,$v,Y3),n=Ep($et,i,Y3);let o=-1/0,a=1/0;for(let l=0;l<3;l++)if(Math.abs(n[l])>1e-6){const c=(r+t.halfSize[l]-s[l])/n[l],h=(-r-t.halfSize[l]-s[l])/n[l];o=Math.max(o,Math.min(c,h)),a=Math.min(a,Math.max(c,h))}else if(s[l]>t.halfSize[l]+r||s[l]<-t.halfSize[l]-r)return!1;return o<=a}(()=>{const t=new Int8Array(162);let e=0;const i=r=>{for(let s=0;s<r.length;s++)t[e+s]=r[s];e+=6};return i([6,2,3,1,5,4]),i([0,2,3,1,5,4]),i([0,2,3,7,5,4]),i([0,1,3,2,6,4]),i([0,1,3,2,0,0]),i([0,1,5,7,3,2]),i([0,1,3,7,6,4]),i([0,1,3,7,6,2]),i([0,1,5,7,6,2]),i([0,1,5,4,6,2]),i([0,1,5,4,0,0]),i([0,1,3,7,5,4]),i([0,2,6,4,0,0]),i([0,0,0,0,0,0]),i([1,3,7,5,0,0]),i([2,3,7,6,4,0]),i([2,3,7,6,0,0]),i([2,3,1,5,7,6]),i([0,1,5,7,6,2]),i([0,1,5,7,6,4]),i([0,1,3,7,6,4]),i([4,5,7,6,2,0]),i([4,5,7,6,0,0]),i([4,5,1,3,7,6]),i([0,2,3,7,5,4]),i([6,2,3,7,5,4]),i([6,2,3,1,5,4]),t})();function y4(t,e){qS(Y3,t.quaternion),Ep($v,e,Y3);const i=t.halfSize;return Math.abs($v[0]*i[0])+Math.abs($v[1]*i[1])+Math.abs($v[2]*i[2])}function ult(t,e){for(let i=0;i<8;++i){const r=e[i];r[0]=1&i?-t.halfSize[0]:t.halfSize[0],r[1]=2&i?-t.halfSize[1]:t.halfSize[1],r[2]=4&i?-t.halfSize[2]:t.halfSize[2],Ep(r,r,t.quaternion),de(r,r,t.center)}}function Ret(t){return PF(t.halfSize)}class Iet{constructor(e){this._totalCount=e,this._indexRanges=[0,e]}componentCount(){const e=this._indexRanges;let i=0;for(let r=0;r<e.length;r+=2)i+=e[r+1];return i}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=Det(e)}forEachComponent(e){const i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],n=s+i[r+1];for(let o=s;o<n;o++)if(!e(o))return!1}return!0}forEachComponentRange(e){const i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r];if(!e(s,s+i[r+1]))return!1}return!0}computeOffsetRanges(e){const i=new Array(this._indexRanges.length),r=this._indexRanges;for(let s=0;s<r.length;s+=2){const n=r[s],o=n+r[s+1],a=e[n],l=e[o];i[s]=a,i[s+1]=l-a}return i}}function Det(t){const e=new Array;if(t.length===0)return e;let i=t[0],r=1;for(let s=1;s<t.length;s++){const n=t[s];i+r===n?r+=1:(e.push(i),e.push(r),i=n,r=1)}return e.push(i),e.push(r),e}class Fet extends cR{constructor(e,i){super(),this.pickability=null,this.highlightCounts=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=nD(i);const r=this.count;this.visibility=new Iet(r),this.materialDataBuffer=e.getBuffer(r),this.materialDataIndices=new Uint16Array(r);for(let s=0;s<r;s++)this.materialDataIndices[s]=this.materialDataBuffer.acquireIndex()}dispose(){super.dispose();for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return A(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return A(this.highlightCounts)?null:(this.updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return A(this.highlightCounts)?this.geometryRanges:(this.updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}updateCachedHighlightRanges(){if((A(this.cachedHighlightRanges)||A(this.cachedDefaultRanges))&&_(this.highlightCounts)){const{highlightRanges:e,defaultRanges:i}=Let(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=i}}}function Let(t,e,i){const r=[],s=[];let n=i.length,o=i.length;return e.forEachComponent(a=>(t[a]>0?(n!==a-1&&(r.length&&r.push(i[n+1]-r[r.length-1]),r.push(i[a])),n=a):(o!==a-1&&(s.length&&s.push(i[o+1]-s[s.length-1]),s.push(i[a])),o=a),!0)),r.length&&r.push(i[n+1]-r[r.length-1]),s.length&&s.push(i[o+1]-s[s.length-1]),{highlightRanges:r,defaultRanges:s}}class Lj extends cR{constructor(){super(...arguments),this.visible=0}}u([Cs()],Lj.prototype,"renderable",void 0),u([Cs()],Lj.prototype,"components",void 0);function ket(t){return typeof t=="function"}function zet(t,e,i,r){if(i>=e)return t;t==null&&(t=Vet());const s=t.isVisibleBit;let n=t.data;const o=Mfe(n),a=i/o|0,l=i-o*a,c=(e-1)/o|0,h=n,p=r===s;if(!(i<h.length*o)&&p){const f=1.5,g=a+1,y=Math.ceil(h.length*f),v=c+1;let b=Math.max(g,y);b=Math.min(b,v),n=new Uint32Array(b),n.set(h)}return a<n.length&&(n[a]=Uet(n[a],l,p)),t.data=n,t}function Cfe(t,e){if(t==null)return!0;const{isVisibleBit:i,data:r}=t,s=Mfe(r);return e<r.length*s?Net(i,r,e,s):!t.isVisibleBit}function Vet(t=!0){return{isVisibleBit:!t,data:new Uint32Array(0)}}function Net(t,e,i,r){const s=i/r|0,n=i-s*r;return jet(e[s],n)===t}function Mfe(t){const e=8;return t.BYTES_PER_ELEMENT*e}function Uet(t,e,i){return t&~(1<<e)|(i?1:0)<<e}function jet(t,e){return(t&1<<e)!=0}class Bet{constructor(e,i){this._indices=_(e.indices)?e.indices:lb(e.positions.length/3),this._positions=new Wt(e.positions),this._components=i,this._componentIntersectionData=new Array(i.count)}getComponentAabb(e,i){if(_(this._perComponentAabbs)){for(let r=0;r<6;r++)i[r]=this._perComponentAabbs[6*e+r];return i}return this._computePerComponentAabbs(),this.getComponentAabb(e,i)}getComponentPositions(e,i){i.indices=this._indices,i.data=this._positions.typedBuffer,i.stride=this._positions.typedBufferStride,i.startIndex=this._components.offsets[e],i.endIndex=this._components.offsets[e+1]}intersect(e,i,r,s,n,o){const a={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},l=this._indices,c=this._components.offsets,h=Sle(e,i,Get);this._components.visibility.forEachComponent(p=>{if(!Cfe(this._components.pickability,p))return!0;const f=this.getComponentAabb(p,qet);if(_(n)&&n.applyToAabb(f),!qN(f,e,h,r))return!0;const g=c[p]/3,y=c[p+1]/3,v=(w,S,T)=>{o(p,w,fo(S,S,s),T)},b=y-g;return A(n)&&b>Rj?(this._componentIntersectionData[p]==null&&(this._componentIntersectionData[p]=new Mv(this._indices,g,y,a)),this._componentIntersectionData[p].intersectRay({r0:e,r1:i},v)):OT(e,i,g,y,l,a,void 0,n,v),!0})}_computePerComponentAabbs(){const e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);for(let i=0;i<e;i++)this._computeAABB(i)}_computeAABB(e){const i=this._indices,r=this._positions,s=this._components.offsets,n=s[e],o=s[e+1],a=[0,0,0],l=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];for(let p=n;p<o;p++){const f=i[p];r.getVec(f,a),dH(l,l,a),pH(c,c,a)}let h=6*e;this._perComponentAabbs[h++]=l[0],this._perComponentAabbs[h++]=l[1],this._perComponentAabbs[h++]=l[2],this._perComponentAabbs[h++]=c[0],this._perComponentAabbs[h++]=c[1],this._perComponentAabbs[h]=c[2]}get positions(){return this._positions}get indices(){return this._indices}}const Get=$(),qet=lr();class Het{constructor(e,i,r,s){this.material=e,this.drawParameters=i,this.geometry=r,this.meta=s}dispose(){this.material.dispose(),this.geometry.dispose()}}class Pfe extends cR{constructor(e,i,r,s){super(),this.primitiveType=i,this.parameters=r,this.indexed=s,this.vao=e}}u([Cs()],Pfe.prototype,"vao",void 0);function Wet(t,e){return{near:t,far:e}}function X3(t){return t?K3(t,1/0,-1/0):Wet(1/0,-1/0)}function K3(t,e,i){return t.near=e,t.far=i,t}function ww(t,e,i=t){return i.near=Math.min(t.near,e.near),i.far=Math.max(t.far,e.far),i}function v4(t,e){return t.near<=e&&e<=t.far}const kj={near:0,far:0};function Zet(t,e){const i=X3(),{eye:r,frustum:s,viewForward:n}=t;e.forAll(o=>{const a=o.obb,l=ye(eu(Sa,a.center,r),n),c=y4(a,n);if(v4(i,l-c)&&v4(i,l+c))return;const h=Ket(a,s);if(h===-1)return;if(h===0)return cp.far=l+c,cp.near=l-c,void ww(i,cp);const p=_4.pushNew();p.near=l-c,p.far=l+c,p.mask=h,p.object=o});for(let o=0;o<_4.length;o++){const a=_4.data[o];if(v4(i,a.near)&&v4(i,a.far))continue;cp.far=a.far,cp.near=1/0,Xet(a.object.obb,r,Jet,c=>{let h=Qet;for(let p=0;p<$fe&&c.length>0;p++){if((a.mask&1<<p)==0)continue;Yet(s[p],c,h);const f=c;c=h,h=f}for(let p=0;p<c.length;p+=3){ne(so,c.data[p+0],c.data[p+1],c.data[p+2]);const f=ye(eu(so,so,r),n);cp.near=Math.min(cp.near,f)}})===0&&(cp.near=0),ww(i,cp)}return _4.length=0,i}const _4=new ct({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),cp=X3(),so=$(),Ov=$(),Jet=new ct({deallocator:null}),Qet=new ct({deallocator:null});function Yet(t,e,i){i.length=0;const r=e.length-3;zj(so,e,r);const s=hi(t,so);s<=0&&(i.push(so[0]),i.push(so[1]),i.push(so[2]));let n=0,o=s;for(;n<r;n+=3){zj(Ov,e,n);const a=hi(t,Ov);o*a<0&&(jr(so,Ov,so,a/(a-o)),no(i,so)),a<=0&&no(i,Ov),o=a,re(so,Ov)}o*s<0&&(zj(Ov,e,r),jr(so,Ov,so,s/(s-o)),no(i,so))}function zj(t,e,i){return ne(t,e.data[i+0],e.data[i+1],e.data[i+2])}function no(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2])}function Xet(t,e,i,r){qS(Efe,t.quaternion),eu(Sa,e,t.center),Ep(Sa,Sa,Efe);const s=8*((Sa[0]<-t.halfSize[0]?-1:Sa[0]>t.halfSize[0]?1:0)+3*(Sa[1]<-t.halfSize[1]?-1:Sa[1]>t.halfSize[1]?1:0)+9*(Sa[2]<-t.halfSize[2]?-1:Sa[2]>t.halfSize[2]?1:0)+13),n=Afe[s];if(n===0)return n;bV(b4,t.quaternion),_V(b4,b4,t.halfSize);const o=(a,l)=>{const c=Afe[s+l+1];return ne(a,((1&c)<<1)-1,(2&c)-1,((4&c)>>1)-1),fo(a,a,b4),de(a,t.center,a)};return i.length=0,no(i,o(Vj,0)),no(i,o(Ofe,1)),no(i,o(Sa,2)),no(i,o(Rfe,3)),r(i),n===1||(i.length=0,no(i,Vj),no(i,Rfe),no(i,o(Sa,4)),no(i,o(Ife,5)),r(i),n===2||(i.length=0,no(i,Vj),no(i,Ife),no(i,o(Sa,6)),no(i,Ofe),r(i))),n}const Afe=(()=>{const t=new Int8Array(216);let e=0;const i=r=>{for(let s=0;s<r.length;s++)t[e+s]=r[s];e+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),t})(),$fe=4;function Ket(t,e){let i=0;for(let r=0;r<$fe;r++){const s=Ev(t,e[r]);if(s>0)return-1;s===0&&(i|=1<<r)}return i}const b4=Ai(),Efe=pf(),Sa=$(),Vj=$(),Ofe=$(),Rfe=$(),Ife=$();class ett{constructor(e){this._objects=e}submit(e,i){this._objects.preSubmit(i),this._objects.visibleObjects.forAll(r=>r.renderable.material.submit(e,r))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?Zet(e,this._objects.visibleObjects):null}}function ttt(t){const e=zr().vec3f("position");return t.normals&&e.vec2i16("normalCompressed",{glNormalized:!0}),t.textureCoordinates===1?e.vec2f("uv0"):t.textureCoordinates===2&&(e.vec2f("uv0"),e.vec4u16("uvRegion",{glNormalized:!0})),t.colors&&e.vec4u8("color",{glNormalized:!0}),e.alignTo(4)}function itt(t,e){e.componentData===1&&(t.vertex.uniforms.add("uComponentColorTex","sampler2D"),t.vertex.uniforms.add("uComponentColorTexInvDim","vec2"),t.attributes.add("componentIndex","float"),t.varyings.add("vExternalColorMixMode","mediump float"),t.varyings.add("vExternalColor","vec4"),t.include(jue),t.vertex.code.add(x`vec4 _readComponentColor() {
float normalizedIndex = (componentIndex + 0.5) * uComponentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * uComponentColorTexInvDim.y
);
return texture2D(uComponentColorTex, indexCoord);
}
vec4 forwardExternalColor(out bool castShadows) {
vec4 componentColor = _readComponentColor() * 255.0;
float shadowFlag = mod(componentColor.b * 255.0, 2.0);
componentColor.b -= shadowFlag;
castShadows = shadowFlag >= 1.0;
int decodedColorMixMode;
vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451;
vExternalColorMixMode = float(decodedColorMixMode) + 0.5;
return vExternalColor;
}`),t.fragment.code.add(x`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = int(vExternalColorMixMode);
}`)),e.componentData===0&&(t.vertex.uniforms.add("uExternalColor","vec4"),t.fragment.uniforms.add("uExternalColorMixMode","int"),t.varyings.add("vExternalColor","vec4"),t.vertex.code.add(x`vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = uExternalColor;
castShadows = true;
return uExternalColor;
}`),t.fragment.code.add(x`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = uExternalColorMixMode;
}`))}function rtt(t,e){const i=t.vertex;switch(i.code.add(x`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),e.vertexDiscardMode){case 0:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) {}`);break;case 2:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case 1:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}function Dfe(t,e){t.include(iv,e),t.fragment.include(s3);const i=t.fragment;i.uniforms.add("uBaseColor","vec4"),i.uniforms.add("uObjectOpacity","float"),e.attributeColor?i.code.add(x`vec3 _baseColor() {
return uBaseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a * vColor.a;
}`):i.code.add(x`vec3 _baseColor() {
return uBaseColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a;
}`),i.code.add(x`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = uObjectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function Ffe(t,e){const i=t.fragment;e.doubleSidedMode===0?i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`):e.doubleSidedMode===1?(t.include(eo,e),i.uniforms.add("uTransform_ViewFromCameraLocal_T","vec3"),i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
vec3 viewDir = vPositionWorldCameraRelative + uTransform_ViewFromCameraLocal_T;
return dot(normal, viewDir) > 0.0 ? -normal : normal;
}`)):e.doubleSidedMode===2&&i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`),e.normalType===0||e.normalType===1?(t.include(rv,e),i.code.add(x`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`)):e.normalType===3?(t.extensions.add("GL_OES_standard_derivatives"),t.include(eo,e),i.code.add(x`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`)):e.normalType===2&&(e.viewingMode===1?(t.include(eo,e),i.code.add(x`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):e.viewingMode===2&&i.code.add(x`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),t.extensions.add("GL_OES_standard_derivatives"),i.code.add(x`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`))}function stt(t,e){const i=t.fragment;e.baseColorTexture?(t.include(H7,e),i.uniforms.add("uBaseColorTexture","sampler2D"),i.uniforms.add("uBaseColorTextureSize","vec2"),e.attributeTextureCoordinates===2?(t.include(Vue),i.code.add(x`vec4 readBaseColorTexture() {
return textureAtlasLookup(
uBaseColorTexture,
uBaseColorTextureSize,
vuv0,
vuvRegion
);
}`)):i.code.add(x`vec4 readBaseColorTexture() {
return texture2D(uBaseColorTexture, vuv0);
}`)):i.code.add(x`vec4 readBaseColorTexture() { return vec4(1.0); }`)}const Lfe=new Map([["position",0],["normal",1],["normalCompressed",1],["color",2],["uv0",3],["uvRegion",4],["componentIndex",5]]);function ntt(t){const e=new pi;e.include(eo,t),e.include(rv,t),e.include(iv,t),e.include(fd,t),e.include(QT,t),e.include(itt,t),e.include(bm,t),e.include(Zi,t),e.include(stt,t),e.include(rtt,t),e.fragment.uniforms.add("view","mat4"),t.pbrMode!==1&&t.pbrMode!==2||(e.include(W7,t),t.hasNormalTexture&&e.include(que,t)),t.output===3&&t.componentData===1?e.vertex.code.add(x`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):e.vertex.code.add(x`#define discardShadows(castShadows) {}`);const i=t.overlayEnabled&&t.output===0&&t.pbrMode===4;return t.overlayEnabled&&(e.include(Ij,t),t.viewingMode===1?e.vertex.code.add(x`
      const float invEllipsoidRadius = ${x.float(1/(t.ellipsoidMode===1?Lt.radius:t.ellipsoidMode===2?Ul.radius:Xc.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):e.vertex.code.add(x`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),i&&(e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),e.varyings.add("groundNormal","vec3"),e.varyings.add("positionView","vec3")),e.vertex.code.add(x`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${x.float(tn)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
      forwardPosition();
      forwardNormal();
      ${i?x`
        positionView = position_view();
        ${t.viewingMode===1?x`
        groundNormal = normalize(positionWorld());
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:x`
        groundNormal = vec3(0.0, 0.0, 1.0);
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`}
        `:""}

      ${t.overlayEnabled?x`setOverlayVTC(projectOverlay(position));`:""}
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth(); // depends on forwardPosition()
    }
  `),t.output===7&&(e.fragment.include(Lr),t.multipassTerrainEnabled&&e.include(ll,t),e.include(Dfe,t),e.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${t.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${t.overlayEnabled?x`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),t.output===0&&(e.fragment.include(Lr),t.multipassTerrainEnabled&&e.include(ll,t),e.include(Dfe,t),e.include(Ffe,t),e.include(r3,t),i&&e.fragment.uniforms.add("ovNormalTex","sampler2D"),t.receiveShadows?(e.include(Bd,t),e.fragment.code.add(x`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):e.fragment.code.add(x`float evaluateShadow() { return 0.0; }`),e.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${t.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${t.overlayEnabled?x`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}
    `),t.pbrMode===1||t.pbrMode===2?(e.fragment.code.add(x`
        ${t.pbrMode===1?x`
        applyPBRFactors();
        if (int(externalColorMixMode) == 3) {
          mrr = vec3(0.0, 0.6, 0.2);
        }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),t.hasNormalTexture?e.fragment.code.add(x`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):e.fragment.code.add(x`vec3 shadingNormal = normalVertex;`),e.fragment.code.add(x`${t.viewingMode===1?x`vec3 normalGround = normalize(positionWorld());`:x`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),e.fragment.code.add(x`vec3 viewDir = normalize(vPositionWorldCameraRelative);
float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());
vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);`)):(t.receiveShadows?e.fragment.code.add(x`float shadow = evaluateShadow();`):t.viewingMode===1?e.fragment.code.add(x`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`):e.fragment.code.add(x`float shadow = 0.0;`),e.fragment.code.add(x`
      float ambientOcclusion = evaluateAmbientOcclusion();
      // At global scale we create some additional ambient light based on the main light to simulate global illumination
      vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());
      vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${i?x`
          vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
          float waterNormalLength = length(overlayWaterMask);
          if (waterNormalLength > 0.95) {
            mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
            vec4 waterOverlayColor = vec4(overlayColorOpaque.xyz, overlayColor.w);
            vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, positionView);
            vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
            // un-gamma the ground color to mix in linear space
            shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
          }`:""}
      `)),e.fragment.code.add(x`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.output!==1&&t.output!==3||(e.include(J0,t),e.fragment.code.add(x`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),t.output===2&&(e.include(Ffe,t),e.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${t.normalType===2?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),t.output===4&&(e.include(Dd),e.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${t.overlayEnabled?x`
        vec4 overlayColor = getCombinedOverlayColor();

        if (overlayColor.a == 0.0) {
          gl_FragColor = vec4(0.0);
          return;
        }`:""}

        outputHighlight();
      }
    `)),e}const ott=Object.freeze({__proto__:null,attributeLocations:Lfe,build:ntt});class w4 extends Si{bindPass(e){const i=this.program;eo.bindViewProjTransform(i,e.viewTransform),Ab(this.program,this.configuration,e.slicePlane),e.identifier===0&&(e.ssrParams!==void 0&&L7(this.program,e.ssrParams),i.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",e.transformNormal_ViewFromGlobal),e.subPass===2&&i.setUniform2fv("cameraNearFar",e.cameraNearFar),e.subPass===0&&e.lighting.setUniforms(this.program,e.integratedMesh)),e.identifier===1&&this.program.setUniform2fv("cameraNearFar",e.cameraNearFar)}bindMaterial(e,i){this._material=e;const r=this.program;r.setUniform4fv("uBaseColor",e.baseColor),r.setUniform1f("uObjectOpacity",e.objectOpacity),r.setUniform1f("textureAlphaCutoff",e.alphaCutoff),e.componentParameters.type===1?e.componentParameters.texture.bind(r,"uComponentColorTex","uComponentColorTexInvDim"):(r.setUniform4fv("uExternalColor",e.componentParameters.externalColor),r.setUniform1i("uExternalColorMixMode",e.componentParameters.externalColorMixMode)),_(e.baseColorTexture)&&e.baseColorTexture.bind(r,"uBaseColorTexture","uBaseColorTextureSize"),this.configuration.output!==0&&this.configuration.output!==7||(Nue(this.program,e,this.configuration.isSchematic),_(e.metallicRoughnessTexture)&&e.metallicRoughnessTexture.bind(r,"texMetallicRoughness","texMetallicRoughnessSize"),_(e.emissionTexture)&&e.emissionTexture.bind(r,"texEmission","texEmissionSize"),_(e.occlusionTexture)&&e.occlusionTexture.bind(r,"texOcclusion","texOcclusionSize"),_(e.normalTexture)&&e.normalTexture.bind(r,"normalTexture","normalTextureSize")),e.isIntegratedMesh&&(i.identifier===0&&i.subPass===0?(r.bindTexture(e.overlayColor,"ovColorTex"),r.bindTexture(e.overlayNormal,"ovNormalTex")):i.identifier===2&&r.bindTexture(e.overlayHighlight,"ovColorTex"),r.setUniform1f("overlayOpacity",1)),i.identifier===2&&Fd(this.program,i),i.identifier===0&&i.subPass===0&&(i.ambientOcclusionEnabled&&i.bindAmbientOcclusion(r),i.shadowsEnabled&&i.bindShadowMap(r)),i.identifier!==0||i.subPass!==0&&i.subPass!==1||!i.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("cameraNearFar",i.cameraNearFar),r.setUniform2fv("inverseViewport",i.inverseViewport),i.multipassTerrainParams.terrainLinearDepthTexture&&r.bindTexture(i.multipassTerrainParams.terrainLinearDepthTexture,"terrainDepthTexture"))}bindDraw(e){if(eo.bindModelTransform(this.program,e),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",e.transformNormal_GlobalFromModel),this.program.rebindTextures(),_(this._material)&&this._material.isIntegratedMesh){const i=this._material.overlayTexScale,r=this._material.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[e.toMapSpace[0]*i[0]+r[0],e.toMapSpace[1]*i[1]+r[1],e.toMapSpace[0]*i[2]+r[2],e.toMapSpace[1]*i[3]+r[3]]),this.program.setUniform4fv("overlayTexScale",[e.toMapSpace[2]*i[0],e.toMapSpace[3]*i[1],e.toMapSpace[2]*i[2],e.toMapSpace[3]*i[3]])}}initializeProgram(e){const i=w4.shader.get(),r=this.configuration,s=i.build({multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround,OITEnabled:r.transparencyPassType===0,output:r.output,normalType:r.integratedMeshMode===0?r.hasNormals?1:3:2,attributeColor:r.hasVertexColors,attributeTextureCoordinates:r.vertexTextureCoordinates,componentData:r.componentData,alphaDiscardMode:r.alphaDiscardMode,baseColorTexture:r.baseColorTexture,doubleSidedMode:r.doubleSidedMode,receiveAmbientOcclusion:r.receiveAmbientOcclusion,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:e.viewingMode,vertexDiscardMode:r.vertexDiscardMode,pbrMode:r.integratedMeshMode===3?4:r.usePBR?r.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:r.hasMetalnessAndRoughnessTexture,hasEmissionTexture:r.hasEmissionTexture,hasOcclusionTexture:r.hasOcclusionTexture,hasNormalTexture:r.hasNormalTexture,vertexTangents:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:MR(e.rctx),overlayEnabled:r.integratedMeshMode===2||r.integratedMeshMode===3,ssrEnabled:r.ssrEnabled,highStepCount:!1,ellipsoidMode:r.ellipsoidMode});return new fi(e.rctx,s,i.attributeLocations)}setPipelineState(e){const i=this.configuration,r=i.integratedMeshMode!==0,s=e===3,n=e===2;return _t({blending:i.output!==0&&i.output!==7||!i.blendingEnabled?null:s?qu:xm(e),culling:PE(i.cullFace),depthTest:{func:U0(e)},depthWrite:s||n?$o:null,colorWrite:Pt,stencilWrite:r||i.sceneHasOcludees?$m:null,stencilTest:r?pje(1):i.sceneHasOcludees?Q0:null,polygonOffset:s||n?i.polygonOffsetEnabled?{factor:2,units:2}:null:WO})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}w4.shader=new vi(ott,()=>import("./ComponentShader.glsl.c60e69c9.js"));class kfe extends eo.ModelTransform{constructor(){super(...arguments),this.transformNormal_GlobalFromModel=Ai(),this.toMapSpace=Ot()}}class _i extends tr{constructor(){super(...arguments),this.output=0,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=0,this.componentData=0,this.slicePlaneEnabled=!1,this.cullFace=2,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.blendingEnabled=!0,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.isSchematic=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.ellipsoidMode=1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([X({count:8})],_i.prototype,"output",void 0),u([X()],_i.prototype,"hasVertexColors",void 0),u([X()],_i.prototype,"hasNormals",void 0),u([X({count:3})],_i.prototype,"vertexTextureCoordinates",void 0),u([X({count:2})],_i.prototype,"componentData",void 0),u([X()],_i.prototype,"slicePlaneEnabled",void 0),u([X({count:3})],_i.prototype,"cullFace",void 0),u([X()],_i.prototype,"baseColorTexture",void 0),u([X()],_i.prototype,"receiveAmbientOcclusion",void 0),u([X()],_i.prototype,"receiveShadows",void 0),u([X({count:3})],_i.prototype,"vertexDiscardMode",void 0),u([X({count:3})],_i.prototype,"doubleSidedMode",void 0),u([X()],_i.prototype,"blendingEnabled",void 0),u([X({count:4})],_i.prototype,"alphaDiscardMode",void 0),u([X({count:4})],_i.prototype,"integratedMeshMode",void 0),u([X()],_i.prototype,"ssrEnabled",void 0),u([X()],_i.prototype,"polygonOffsetEnabled",void 0),u([X()],_i.prototype,"usePBR",void 0),u([X()],_i.prototype,"isSchematic",void 0),u([X()],_i.prototype,"hasMetalnessAndRoughnessTexture",void 0),u([X()],_i.prototype,"hasEmissionTexture",void 0),u([X()],_i.prototype,"hasOcclusionTexture",void 0),u([X()],_i.prototype,"hasNormalTexture",void 0),u([X()],_i.prototype,"sceneHasOcludees",void 0),u([X({count:4})],_i.prototype,"transparencyPassType",void 0),u([X({count:4})],_i.prototype,"ellipsoidMode",void 0),u([X()],_i.prototype,"multipassTerrainEnabled",void 0),u([X()],_i.prototype,"cullAboveGround",void 0);class att{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}class Nj{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function ni(t={}){return(e,i)=>{var r;const s=(r=e._parameterCount)!=null?r:0;if(e._parameterCount=s+1,t.vectorOps){const n=t.vectorOps;Object.defineProperty(e,i,{get(){return this[s]},set(o){const a=this[s];if(a==null)this[s]=o;else{if(n.equals(a,o))return;n.copy(a,o)}this._setDirty()}})}else Object.defineProperty(e,i,{get(){return this[s]},set(n){this[s]!==n&&(t.dispose&&this[s]&&this[s].dispose(),this[s]=n,this._setDirty())}})}}function zfe(){return(t,e)=>{var i;const r=(i=t._parameterCount)!=null?i:0;t._parameterCount=r+1,t._parameterBlocks=t._parameterBlocks||[],t._parameterBlocks.push(r),Object.defineProperty(t,e,{get(){return this[r]},set(s){this[r]!==s&&(this[r]=s,this._setDirty())}})}}class Qi extends att{constructor(){super(...arguments),this.baseColor=io(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=xt(1,1,.5),this.emissiveFactor=xt(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.overlayTexOffset=Bt(-1,-1,-1,-1),this.overlayTexScale=Bt(0,0,0,0),this.overlayColor=null,this.overlayHighlight=null,this.overlayNormal=null,this.objectOpacity=1,this.commonMaterialParameters=new x4,this.componentParameters=new xw,this.alphaCutoff=GO,this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.sceneHasOcludees=!1,this._techniqueConfig=new _i}dispose(){this._technique=nr(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}getTechnique(e,i,r){const s=this._techniqueConfig;if(s.hasVertexColors=r.colors,s.hasNormals=r.normals,s.vertexTextureCoordinates=r.textureCoordinates,s.usePBR=this.usePBR,s.hasMetalnessAndRoughnessTexture=_(this.metallicRoughnessTexture),s.hasEmissionTexture=_(this.emissionTexture),s.hasOcclusionTexture=_(this.occlusionTexture),s.hasNormalTexture=_(this.normalTexture),s.transparencyPassType=i.identifier===0&&i.transparencyPassType!=null?i.transparencyPassType:3,s.multipassTerrainEnabled=i.identifier===0&&i.multipassTerrainParams!=null&&i.multipassTerrainParams.multipassTerrainEnabled,s.cullAboveGround=i.identifier===0&&i.multipassTerrainParams!=null&&i.multipassTerrainParams.cullAboveGround,s.ellipsoidMode=this.ellipsoidMode,this.dirty){s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,s.baseColorTexture=_(this.baseColorTexture),s.isSchematic=this.hasParametersFromSource&&!_(this.baseColorTexture);const n=this._computeWhichMaterialPass();s.blendingEnabled=n===1||n===2,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?this.overlayColor?this.overlayNormal?3:2:1:0,s.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean()}return s.slicePlaneEnabled=i.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,i.identifier===1?(s.output=3,s.vertexDiscardMode=0):i.identifier===2?(s.output=4,s.vertexDiscardMode=0):(this._computeWhichMaterialPass()===2?s.vertexDiscardMode=i.transparent?2:1:s.vertexDiscardMode=0,s.output=ltt(i.subPass),i.subPass===1&&(s.sceneHasOcludees=i.sceneHasOcludees),i.subPass===0?(s.receiveAmbientOcclusion=i.ambientOcclusionEnabled,s.sceneHasOcludees=i.sceneHasOcludees,s.receiveShadows=i.shadowsEnabled,s.ssrEnabled=i.ssrParams.ssrEnabled):(s.receiveAmbientOcclusion=!1,s.receiveShadows=!1)),this._technique=e.releaseAndAcquire(w4,s,this._technique),this._technique}submit(e,i){if(this.objectOpacity===0)return;const r=i.renderable.geometry,s=i.components,n=i.renderable.drawParameters,o=i.renderable.meta.cameraDepthSquared,a=s.geometryRanges,l=s.highlightRanges,c=s.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case 0:e.materialOpaque.submitDraw(this,r,a,n,o);break;case 1:e.materialTransparent.submitDraw(this,r,a,n,o);break;case 2:e.materialOpaque.submitDraw(this,r,a,n,o),e.materialTransparent.submitDraw(this,r,a,n,o);break;case 3:e.materialIntegratedMesh.submitDraw(this,r,a,n,o),this.overlayHighlight&&e.highlightIntegratedMesh.submitDraw(this,r,a,n,o)}const h=this.componentParameters.castShadows!==2;h&&e.shadowMap.submitDraw(this,r,a,n,o),_(l)&&(e.highlight.submitDraw(this,r,l,n,o),h&&e.highlightShadowMap.submitDraw(this,r,l,n,o)),h&&_(c)&&e.defaultShadowMap.submitDraw(this,r,c,n,o)}get attributeLocations(){return Lfe}_computeWhichMaterialPass(){return this.isIntegratedMesh?3:this.objectOpacity<1?1:this.componentParameters.opaqueOverride===0?0:this.baseColor[3]<1||this.alphaDiscardMode===0||this.alphaDiscardMode===3?1:this.componentParameters.transparent===2?0:this.componentParameters.transparent===0?1:2}}u([ni({vectorOps:xH})],Qi.prototype,"baseColor",void 0),u([ni()],Qi.prototype,"usePBR",void 0),u([ni()],Qi.prototype,"hasParametersFromSource",void 0),u([ni({vectorOps:fH})],Qi.prototype,"mrrFactors",void 0),u([ni({vectorOps:fH})],Qi.prototype,"emissiveFactor",void 0),u([ni({dispose:!0})],Qi.prototype,"baseColorTexture",void 0),u([ni({dispose:!0})],Qi.prototype,"metallicRoughnessTexture",void 0),u([ni({dispose:!0})],Qi.prototype,"emissionTexture",void 0),u([ni({dispose:!0})],Qi.prototype,"occlusionTexture",void 0),u([ni({dispose:!0})],Qi.prototype,"normalTexture",void 0),u([ni({vectorOps:{equals:Pg,copy:Ln}})],Qi.prototype,"overlayTexOffset",void 0),u([ni({vectorOps:{equals:Pg,copy:Ln}})],Qi.prototype,"overlayTexScale",void 0),u([ni()],Qi.prototype,"overlayColor",void 0),u([ni()],Qi.prototype,"overlayHighlight",void 0),u([ni()],Qi.prototype,"overlayNormal",void 0),u([ni()],Qi.prototype,"objectOpacity",void 0),u([zfe()],Qi.prototype,"commonMaterialParameters",void 0),u([zfe()],Qi.prototype,"componentParameters",void 0),u([ni()],Qi.prototype,"alphaCutoff",void 0),u([ni()],Qi.prototype,"alphaDiscardMode",void 0),u([ni()],Qi.prototype,"isIntegratedMesh",void 0),u([ni()],Qi.prototype,"polygonOffsetEnabled",void 0),u([ni()],Qi.prototype,"ellipsoidMode",void 0),u([ni()],Qi.prototype,"sceneHasOcludees",void 0);class x4 extends Nj{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.slicePlaneEnabled=!0}}u([ni()],x4.prototype,"doubleSided",void 0),u([ni()],x4.prototype,"cullFace",void 0),u([ni()],x4.prototype,"slicePlaneEnabled",void 0);class xw extends Nj{constructor(){super(...arguments),this.externalColor=io(1,1,1,1),this.externalColorMixMode=1,this.castShadows=0}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return this.externalColorMixMode===3&&this.externalColor[3]===1?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}}u([ni({vectorOps:xH})],xw.prototype,"externalColor",void 0),u([ni()],xw.prototype,"externalColorMixMode",void 0),u([ni()],xw.prototype,"castShadows",void 0);class eC extends Nj{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.castShadows=2}get type(){return 1}}function ltt(t){switch(t){case 0:return 0;case 1:return 7;case 2:return 1;case 3:return 2}}u([ni()],eC.prototype,"texture",void 0),u([ni()],eC.prototype,"transparent",void 0),u([ni()],eC.prototype,"opaqueOverride",void 0),u([ni()],eC.prototype,"castShadows",void 0);class S4{constructor(e){this._low=li(),this._high=li(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){const i=this._low,r=this._high;re(i,e),eu(r,e,i)}setElements(e,i,r){ne(Vfe,e,i,r),this.set(Vfe)}get(e){return de(e,this._low,this._high)}getLowScaled(e){return se(e,this._low,1)}}const Vfe=$();class ctt{constructor(e){this.maxCount=e,this._nextIndex=0,this.recycledIndices=[]}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this.recycledIndices.push(e)}}class utt{constructor(e,i=1){this.rctx=e,this.fieldCount=i,this.textureWidth=4096,this.dirty=!0,this.texture=new qe(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:this.textureWidth,height:1,flipped:!1}),this.data=new Hn(new ArrayBuffer(4*this.textureWidth))}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0}setData(e,i,r,s,n,o){const a=e*this.fieldCount+i;this.dirty=!0,this.data.set(a,0,r),this.data.set(a,1,s),this.data.set(a,2,n),this.data.set(a,3,o)}setDataElement(e,i,r,s){const n=e*this.fieldCount+i;this.dirty=!0,this.data.set(n,r,s)}resizeToFit(e){const i=e*this.fieldCount;if(i>=this.data.count){const r=Math.ceil((i+1)/this.textureWidth)*this.textureWidth,s=new Hn(new ArrayBuffer(4*r));s.typedBuffer.set(this.data.typedBuffer),this.data=s}}updateTexture(){if(!this.dirty)return;const e=this.texture.descriptor.width,i=this.texture.descriptor.height;this.data.count>e*i&&this.texture.resize(e,this.data.count/e),this.texture.setData(this.data.typedBuffer),this.dirty=!1}bind(e,i,r){e.bindTexture(this.texture,i),e.setUniform2f(r,1/this.texture.descriptor.width,1/this.texture.descriptor.height)}}const Nfe=65536;class htt{constructor(e,i=1){this.textureBuffer=new utt(e,i),this.indexManager=new ctt(Nfe)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const e=this.indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this.indexManager.release(e)}}class Ufe{constructor(e,i=1){this.rctx=e,this.fieldCount=i,this.buffers=[]}garbageCollect(){this.buffers=this.buffers.filter(e=>e.activeCount!==0||(e.dispose(),!1))}destroy(){this.buffers.forEach(e=>e.dispose()),this.buffers=[]}getBuffer(e){for(const r of this.buffers)if(r.availableCount>=e)return r;if(e>Nfe)return null;const i=new htt(this.rctx,this.fieldCount);return this.buffers.push(i),i}updateTextures(){for(const e of this.buffers)e.textureBuffer.updateTexture()}}const jfe=le.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class dtt{constructor(e){this._renderManager=e,this._objects=[new ct,new ct],this._renderSubmit=new ett(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new Ufe(e.rctx)}dispose(){Ze(this._objects[0].length===0&&this._objects[1].length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(e){const i=new Lj;return i.toMapSpace=e.toMapSpace.slice(),i.transform=e.transform,i.obb=Oet(e.obb),i.components=new Fet(this._componentBufferManager,e.geometry.componentOffsets),i.renderable=this._createRenderable(e,i.components),i.intersectionGeometry=new Bet(e.geometry.positionData,i.components),this._objects[i.visible].push(i),i}destroyObject(e){const i=e;this._objects[i.visible].removeUnordered(i),i.dispose(),this._notifyDirty()}setObjectVisibility(e,i){const r=e;i!==r.visible&&(this._objects[r.visible].removeUnordered(r),this._objects[i].push(r),r.visible=i,this._notifyDirty())}preSubmit(e){const i=e.camera.eye;this.visibleObjects.forAll(r=>{const s=cn(i,r.obb.center);r.renderable.meta.cameraDepthSquared=s})}getMaterial(e){return e.renderable.material}updateMaterial(e,i){const r=e.renderable.material;i(r),r.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,i){const r=e;r.components.visibility.reset(i),r.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,i){return e.components.visibility.forEachComponent(i)}getComponentCount(e){const i=e,r=i.components.visibility.componentCount();return{visible:r,invisible:i.components.count-r}}setComponentData(e,i){const r=e,s=r.renderable.material;if(ket(i)){const n=r.components,o=n.materialDataBuffer,a=n.materialDataIndices,l={castShadows:!0,pickable:!0,externalColor:KU(),externalColorMixMode:1},c=o.textureBuffer,h=new Uint8Array(4),p=new Uint32Array(h.buffer);let f=0,g=0,y=0,v=!1,b=0;for(let w=0;w<n.count;w++)i(w,l),f+=+(l.externalColor[3]<1),g+=+(l.externalColorMixMode===3&&l.externalColor[3]===1),y+=+l.castShadows,Mhe(l.externalColor,l.externalColorMixMode,h),h[2]=254&h[2]|+l.castShadows,c.setData(a[w],0,h[0],h[1],h[2],h[3]),v=v||w>0&&b!==p[0],b=p[0],l.pickable!==Cfe(n.pickability,w)&&(n.pickability=zet(n.pickability,n.count,w,l.pickable));v?(s.componentParameters=new eC,s.componentParameters.castShadows=Uj(y,n.count),s.componentParameters.transparent=Uj(f,n.count),s.componentParameters.opaqueOverride=Uj(g,n.count),s.componentParameters.texture=c,c.updateTexture()):(s.componentParameters=new xw,s.componentParameters.castShadows=l.castShadows?0:2,s.componentParameters.externalColor=l.externalColor,s.componentParameters.externalColorMixMode=l.externalColorMixMode)}else s.componentParameters=new xw,s.componentParameters.castShadows=i.castShadows?0:2,s.componentParameters.externalColor=i.externalColor,s.componentParameters.externalColorMixMode=i.externalColorMixMode;this._notifyDirty()}getComponentAabb(e,i,r){return e.intersectionGeometry.getComponentAabb(i,r)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,i,r){return e.intersectionGeometry.getComponentPositions(i,r)}intersect(e,i,r,s,n,o){const a=e;_(n)&&(n.localOrigin=a.transform.position);const l=p0(Bfe,a.transform.rotationScale);eu(T4,i,a.transform.position),eu(C4,r,a.transform.position),fo(T4,T4,l),fo(C4,C4,l);const c=el(Bfe,l);return a.intersectionGeometry.intersect(T4,C4,s,c,n,o)}addEdges(e,i,r,s){const n=e,{indices:o,positions:a}=n.intersectionGeometry,l=n.components.offsets;return i.addComponentObject(e,n.transform,{center:n.obb.center,radius:Ret(n.obb)},a,o,l,r,s)}addComponentHighlight(e,i){const r=e.components;A(r.highlightCounts)&&(r.highlightCounts=new Uint32Array(r.count+1)),r.highlightCounts[i]++==0&&(r.highlightsDirty(),this._notifyDirty()),r.highlightCounts[r.count]++}removeComponentHighlight(e,i){const r=e.components;if(A(r.highlightCounts))return void jfe.warn("Removing non-existing highlight.");const s=r.highlightCounts[i],n=r.highlightCounts[r.count];if(s!==0){if(s>1)return r.highlightCounts[i]=s-1,void(r.highlightCounts[r.count]=n-1);r.highlightCounts[i]=0,r.highlightsDirty(),this._notifyDirty(),n===1?r.highlightCounts=null:r.highlightCounts[r.count]=n-1}else jfe.warn("Removing non-existing highlight.")}clearHighlights(e){const i=e.components;_(i.highlightCounts)&&(i.highlightCounts=null,i.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[1]}_createRenderable(e,i){const r=this._renderManager.rctx,s=e.geometry,n=s.vertices.layoutParameters,o=Nt.createVertex(r,35044,s.vertices.data),a=vp(s.indices,S=>Nt.createIndex(r,35044,S)),l=il(ttt(n)),c=new Uint16Array(s.vertices.count);for(let S=0;S<i.count;S++){const T=i.offsets[S],C=i.offsets[S+1],M=i.materialDataIndices[S];if(_(s.indices))for(let P=T;P<C;P++)c[s.indices[P]]=M;else for(let P=T;P<C;P++)c[P]=M}const h=Nt.createVertex(r,35044,c.buffer),p=new S4(e.transform.position),f=$pe(e.transform.rotationScale);p0(f,f),el(f,f);const g=new kfe;re(g.worldFromModel_TL,p.low),re(g.worldFromModel_TH,p.high),ZS(g.worldFromModel_RS,e.transform.rotationScale),ZS(g.transformNormal_GlobalFromModel,f),Ln(g.toMapSpace,e.toMapSpace);const y=new Qi,v=new Tr(r,y.attributeLocations,{data:l,componentIndices:ptt},{data:o,componentIndices:h},at(a)),b=new Pfe(v,4,n,_(a)),w={cameraDepthSquared:.5,gpuMemoryEstimate:o.byteSize+h.byteSize+(_(a)?a.byteSize:0)};return new Het(y,g,b,w)}_notifyDirty(){this._renderManager.notifyDirty()}}const ptt=il(zr().u16("componentIndex"));function Uj(t,e){return t===e?0:t===0?2:1}const Bfe=rp(),T4=$(),C4=$();function ftt(t){const e=new pi;return e.include(KT),e.fragment.uniforms.add("tex","sampler2D"),t.function===0&&(t.hasOpacityFactor?(e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(x`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):e.fragment.code.add(x`void main() {
gl_FragColor = texture2D(tex, uv);
}`)),t.function===3&&(e.fragment.uniforms.add("overlayIdx","int"),t.hasOpacityFactor&&e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(x`
      void main() {
        vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5+ 0.5, uv.y);
        gl_FragColor = texture2D(tex, overlayUV) ${t.hasOpacityFactor?"* opacity":""};
      }`)),t.function===1&&e.fragment.code.add(x`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),t.function===2&&(e.fragment.uniforms.add("colorTexture","sampler2D"),e.fragment.uniforms.add("alphaTexture","sampler2D"),e.fragment.uniforms.add("frontFaceTexture","sampler2D"),e.fragment.code.add(x`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`)),e}const mtt=Object.freeze({__proto__:null,build:ftt});class tC extends Si{initializeProgram(e){const i=tC.shader.get().build(this.configuration);return new fi(e.rctx,i,Ht)}initializePipeline(){if(this.configuration.function===1)return _t({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case 0:return _t({colorWrite:Pt});case 1:return _t({blending:Xs(770,1,771,771),colorWrite:Pt});default:return _t({blending:Qa(1,771),colorWrite:Pt})}}}tC.shader=new vi(mtt,()=>import("./Compositing.glsl.b88c32ed.js"));class M4 extends tr{constructor(){super(...arguments),this.function=0,this.alphaMode=0,this.hasOpacityFactor=!1}}u([X({count:4})],M4.prototype,"function",void 0),u([X({count:3})],M4.prototype,"alphaMode",void 0),u([X()],M4.prototype,"hasOpacityFactor",void 0);class gtt{constructor(e,i){this._rctx=e,this._techniqueRepository=i}dispose(){this._vao=Ge(this._vao)}compositeTransparent(e,i,r,s=1){const n=this._rctx;up.alphaMode=1,up.function=2,up.hasOpacityFactor=s!==1;const o=this._techniqueRepository.acquire(tC,up);n.useProgram(o.program),o.bindPipelineState(n),o.program.bindTexture(e,"colorTexture"),o.program.bindTexture(i,"alphaTexture"),o.program.bindTexture(r,"frontFaceTexture");const a=this.ensureVAO();n.bindVAO(a),n.drawArrays(5,0,xs(a,"geometry")),o.release()}composite(e,i=0,r=1,s=0,n=0){const o=this._rctx;up.alphaMode=i,up.function=s,up.hasOpacityFactor=r!==1;const a=this._techniqueRepository.acquire(tC,up);o.useProgram(a.program),a.bindPipelineState(o),a.program.bindTexture(e,"tex"),up.hasOpacityFactor&&a.program.setUniform1f("opacity",r),s===3&&a.program.setUniform1i("overlayIdx",n);const l=this.ensureVAO();o.bindVAO(l),o.drawArrays(5,0,xs(l,"geometry")),a.release()}ensureVAO(){return A(this._vao)&&(this._vao=vn(this._rctx)),this._vao}}const up=new M4,ytt=1e4,jj=100,vtt=500,_tt=500,btt=.1;function wtt(t,e,i){return j7(e,t)*(i[1]-i[0])+i[0]}function xtt(t,e,i){if(e.size<ytt)return Ett.compute(t,e);const r=X3();return i.forAll(s=>{s.isVisible&&ww(r,Stt(t,s))}),r}function Stt(t,e){if(!e.isVisible)return;const i=X3(),r=e.getSpatialQueryAccelerator();return _(r)?Ttt(i,t,r):Ctt(i,t,e.objects),i}function Ttt(t,e,i){const r=e.eye,s=e.viewForward,n=e.frustum,o=l=>l.isVisible,a=i.objectCount;if(a<vtt)K3(El,e.near,Math.min(t.near,e.far)),i.forEachInDepthRange(r,s,1,El,(l,c)=>{Bj(t,e,l),El.far=t.near,c.setRange(El)},n,o),K3(El,Math.max(t.far,e.near),e.far),i.forEachInDepthRange(r,s,-1,El,(l,c)=>{Bj(t,e,l),El.near=t.far,c.setRange(El)},n,o);else{const l=Math.max(Math.min(a,_tt),Math.ceil(a*btt)),c=i.findClosest(s,1,n,o,l),h=i.findClosest(s,-1,n,o,l);c&&h&&(qfe(t,e,c.boundingVolumeWorldSpace.bounds),qfe(t,e,h.boundingVolumeWorldSpace.bounds))}}function Ctt(t,e,i){Sw.clear(),i.forAll(r=>{r.isVisible&&r.geometryRecords.length!==0&&Sw.add(r)}),Sw.empty||(Sw.sort(e),K3(El,e.near,Math.min(t.near,e.far)),Sw.forEachInDepthRange(El,1,(r,s)=>{s<t.near&&Bj(t,e,r)}),K3(El,Math.max(t.far,e.near),e.far),Sw.forEachInDepthRange(El,-1,(r,s,n)=>{t.far=Math.max(t.far,n)}))}function Bj(t,e,i){if(!i.isVisible||!am(e.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,s=$tt;i.geometryRecords.forEach(n=>{wi(s,r,n.getShaderTransformation());const o=Rg(s);Gfe(t,e,n.geometry.boundingInfo,s,o)})}function Gfe(t,e,i,r,s){if(A(i))return;const n=e.eye,o=e.viewForward;Oe(Os,i.center,r);const a=o[0]*(Os[0]-n[0])+o[1]*(Os[1]-n[1])+o[2]*(Os[2]-n[2]);if(Os[3]=i.radius*s,!(a-Os[3]>t.near&&a+Os[3]<t.far)&&am(e.frustum,Os))if(i.radius>jj&&i.getChildren()){const l=i.getChildren();for(let c=0;c<8;++c)l[c]&&Gfe(t,e,l[c],r,s)}else qj.unionDepthRangeWithAABB(t,e.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function qfe(t,e,i){const r=e.eye,s=e.viewForward,n=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];t.near=Math.min(t.near,n-i[3]),t.far=Math.max(t.far,n+i[3])}class Mtt{constructor(){this._items=new ct({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const i=e.eye,r=e.viewForward;this._items.forAll(s=>{const n=s.obj.boundingVolumeWorldSpace.bounds,o=(n[0]-i[0])*r[0]+(n[1]-i[1])*r[1]+(n[2]-i[2])*r[2];s.distance=o,s.near=o-n[3],s.far=o+n[3]}),this._items.sort((s,n)=>s.distance-n.distance)}forEachInDepthRange(e,i,r){if(i===1)for(let s=0;s<this._items.length;++s){const n=this._items.data[s];n.far<e.near||n.near>e.far||r(n.obj,n.near,n.far)}else for(let s=this._items.length-1;s>=0;--s){const n=this._items.data[s];n.far<e.near||n.near>e.far||r(n.obj,n.near,n.far)}}}class Ptt{constructor(){this.view=be(),this.viewProj=be(),this.frustum=mb(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}compute(e,i){this.reset(),ji(this.view,e.viewMatrix),wi(this.viewProj,e.projectionMatrix,this.view),rO(e.frustum,this.frustum);const r=this.view,s=r[2],n=r[6],o=r[10],a=r[14],l=this.range;let c=0;if(i.forEach(g=>{if(!g.instanceParameters.visible||!g.castShadow)return;let y;g.hasShaderTransformation?(g.computeBoundingSphere(g.getShaderTransformation(),Os,1),y=Os):y=g.boundingSphere;const v=s*y[0]+n*y[1]+o*y[2]+a,b=v-y[3],w=v+y[3];this.geometries[c]=g,this.near[c]=-w,this.far[c]=-b,++c}),this.geometries.length===0)return l;for(let g=0;g<this.geometries.length;++g)this.near[g]>l.far&&(l.far=this.near[g]),this.near[g]>2&&this.far[g]<l.near&&(l.near=this.far[g]);const h=this.looseRange;h.near=Math.max(.5*l.near,2),h.far=2*l.far;let p=0,f=0;for(let g=0;g<this.geometries.length;++g)this.near[g]<l.near&&(this.near[g]>=h.near?l.near=this.near[g]:this.nearCandidates[p++]=g),this.far[g]>l.far&&(this.far[g]<=h.far?l.far=this.far[g]:this.farCandidates[f++]=g);if(this.nearCandidates.length===0&&this.farCandidates.length===0)return l;this.nearCandidates.sort((g,y)=>this.near[g]<this.near[y]?-1:this.near[g]>this.near[y]?1:0),this.farCandidates.sort((g,y)=>this.far[g]<this.far[y]?1:this.far[g]>this.far[y]?-1:0);for(let g=0;g<this.nearCandidates.length;++g){const y=this.nearCandidates[g];if(this.near[y]<l.near){const v=this.geometries[y],b=v.boundingInfo;this.includeNearBoundingInfoRec(b,v.getShaderTransformation())}}for(let g=0;g<this.farCandidates.length;++g){const y=this.farCandidates[g];if(this.far[y]>l.far){const v=this.geometries[y],b=v.boundingInfo;this.includeFarBoundingInfoRec(b,v.getShaderTransformation())}}return l}reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE}includeNearBoundingInfoRec(e,i){if(A(e))return;const r=e.getCenter();Oe(Os,r,i);const s=Rg(i),n=Os[0],o=Os[1],a=Os[2],l=e.getBSRadius()*s,c=this.frustum;if(c[0][0]*n+c[0][1]*o+c[0][2]*a+c[0][3]>l||c[1][0]*n+c[1][1]*o+c[1][2]*a+c[1][3]>l||c[2][0]*n+c[2][1]*o+c[2][2]*a+c[2][3]>l||c[3][0]*n+c[3][1]*o+c[3][2]*a+c[3][3]>l)return;const h=this.view[2]*n+this.view[6]*o+this.view[10]*a+this.view[14],p=h+l;if(!(-(h-l)<2||-p>=this.range.near))if(-p>this.looseRange.near)this.range.near=-p;else{if(l>jj){const f=e.getChildren();if(f!==void 0){for(let g=0;g<8;++g)f[g]!==void 0&&this.includeNearBoundingInfoRec(f[g],i);return}}qj.unionDepthRangeWithAABB(this.range,this.viewProj,i,e.getBBMin(),e.getBBMax())}}includeFarBoundingInfoRec(e,i){if(A(e))return;let r=e.getBSRadius();const s=e.getCenter();Oe(Os,s,i);const n=Rg(i),o=Os[0],a=Os[1],l=Os[2];r*=n;const c=this.frustum;if(c[0][0]*o+c[0][1]*a+c[0][2]*l+c[0][3]>r||c[1][0]*o+c[1][1]*a+c[1][2]*l+c[1][3]>r||c[2][0]*o+c[2][1]*a+c[2][2]*l+c[2][3]>r||c[3][0]*o+c[3][1]*a+c[3][2]*l+c[3][3]>r)return;const h=this.view[2]*o+this.view[6]*a+this.view[10]*l+this.view[14]-r;if(!(-h<=this.range.far))if(-h<this.looseRange.far)this.range.far=-h;else{if(r>jj){const p=e.getChildren();if(p!==void 0){for(let f=0;f<8;++f)p[f]!==void 0&&this.includeFarBoundingInfoRec(p[f],i);return}}qj.unionDepthRangeWithAABB(this.range,this.viewProj,i,e.getBBMin(),e.getBBMax())}}}class Att{constructor(){this.modelViewProj=be(),this.clipPosition=[Ot(),Ot(),Ot(),Ot(),Ot(),Ot(),Ot(),Ot()]}unionDepthRangeWithAABB(e,i,r,s,n){const o=this.modelViewProj;wi(o,i,r);let a=!1;for(let l=0;l<8;++l){const c=this.clipPosition[l],h=l===0||l===3||l===4||l===7?s[0]:n[0],p=l===0||l===1||l===4||l===5?s[1]:n[1],f=l<4?s[2]:n[2];c[0]=o[0]*h+o[4]*p+o[8]*f+o[12],c[1]=o[1]*h+o[5]*p+o[9]*f+o[13],c[2]=o[2]*h+o[6]*p+o[10]*f+o[14],c[3]=o[3]*h+o[7]*p+o[11]*f+o[15]}for(let l=0;l<12;++l){const c=this.clipPosition[Gj[l][0]],h=this.clipPosition[Gj[l][1]],p=this.clipPosition[Gj[l][2]],f=this.clipTriangle(c,h,p);let g=!0;for(let y=0;y<f.length;++y)if(f[y][3]>=2){g=!1;break}if(!g){a=!0;for(let y=0;y<f.length;++y){const v=f[y][3];v<e.near&&(e.near=v),v>e.far&&(e.far=v)}}}return a}inside(e,i){return i===0?e[0]>=-e[3]:i===1?e[1]>=-e[3]:i===2?e[0]<=e[3]:i===3?e[1]<=e[3]:void Ze(!1)}intersect(e,i,r){let s=0;return r===0?s=(-e[3]-e[0])/(i[0]-e[0]+i[3]-e[3]):r===1?s=(-e[3]-e[1])/(i[1]-e[1]+i[3]-e[3]):r===2?s=(e[3]-e[0])/(i[0]-e[0]-i[3]+e[3]):r===3&&(s=(e[3]-e[1])/(i[1]-e[1]-i[3]+e[3])),RF(Ot(),e,i,s)}clipTriangle(e,i,r){let s=[e,i,r];for(let n=0;n<4;++n){const o=s;s=[];for(let a=0;a<o.length;++a){const l=o[a],c=o[(a+1)%o.length];this.inside(c,n)?(this.inside(l,n)||s.push(this.intersect(l,c,n)),s.push(c)):this.inside(l,n)&&s.push(this.intersect(l,c,n))}}return s}}const Gj=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Os=rs(),$tt=be(),El=X3(),Sw=new Mtt,Ett=new Ptt,qj=new Att;function Ott(){const t=new pi;return t.attributes.add("position","vec2"),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("drawPosition","vec4"),t.varyings.add("vUV","vec2"),t.vertex.code.add(x`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),t.fragment.uniforms.add("textureInput","sampler2D"),t.fragment.uniforms.add("textureMask","sampler2D"),t.fragment.uniforms.add("textureOverlay","sampler2D"),t.fragment.uniforms.add("maskEnabled","bool"),t.fragment.uniforms.add("overlayEnabled","bool"),t.fragment.code.add(x`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),t}async function Rtt(t){const e=import("./mask-svg.03f23d26.js"),i=import("./overlay-svg.4d0d565d.js"),r=tl((await e).default,{signal:t}),s=tl((await i).default,{signal:t}),n={mask:await r,overlay:await s};return Dt(t),n}let Tw=class extends ve{constructor(){super(...arguments),this._handles=new dt,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new Ci,this.attributeLocations=new Map([["position",0]]),this.tmpScreenPoint=Ii(),this.tmpRenderPoint=Fwe()}get updating(){return A(this._imageSources)&&_(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(t){if(t===this._magnifier)return;this._handles.removeAll(),this._magnifier=t;const e=()=>{this.updateResourceLoading(),this.events.emit("request-render")};_(this._magnifier)&&this._handles.add(this._magnifier.watch("version",e)),e()}get enabled(){return _(this._validMagnifier)}get _validMagnifier(){return _(this._magnifier)&&this._magnifier.visible&&_(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return _(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),_(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources()}render(t,e){const i=this._validMagnifier;if(A(i))return;const r=e.camera.pixelRatio,s=Math.ceil(r*i.size);if(this.updateResources(t,s),A(this._resources))return;const n=this._resources.program;t.useProgram(n);const o=this._resources.textures,a=Math.ceil(1/this.factor*s);o.input.resize(a,a);const l=e.camera.fullWidth,c=e.camera.fullHeight;Gh(i.position,this.tmpScreenPoint);const h=e.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),p=.5*a,f=.5*a;h[0]=Re(h[0],p,l-p-1),h[1]=Re(h[1],f,c-f-1);const g=Math.floor(h[0]-p),y=Math.floor(h[1]-f);n.bindTexture(o.input,"textureInput"),t.gl.copyTexImage2D(o.input.descriptor.target,0,o.input.descriptor.pixelFormat,g,y,a,a,0);const v=i.offset.x*r,b=i.offset.y*r,w=(h[0]+v)/l*2-1,S=(h[1]-b)/c*2-1,T=s/l*2,C=s/c*2;t.bindVAO(this._resources.vao),n.bindTexture(o.overlay,"textureOverlay"),n.bindTexture(o.mask,"textureMask"),n.setUniform4f("drawPosition",w,S,T,C),n.setUniform1i("maskEnabled",i.maskEnabled?1:0),n.setUniform1i("overlayEnabled",i.overlayEnabled?1:0),t.setPipelineState(this._resources.pipelineState),t.drawArrays(5,0,4)}updateResourceLoading(){const t=this._validMagnifier;if(A(t))return;const e=t.maskUrl,i=t.overlayUrl;!_(this._imageLoadTask)||this._imageLoadTask.maskUrl===e&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),_(this._imageSources)||_(this._imageLoadTask)||(this._imageLoadTask={maskUrl:e,overlayUrl:i,task:Jw(async r=>{const s=A(e)||A(i)?Rtt(r):null,n=_(e)?tl(e,{signal:r}):s.then(a=>a.mask),o=_(i)?tl(i,{signal:r}):s.then(a=>a.overlay);this._imageSources={mask:await n,overlay:await o},this.disposeResources(),this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}updateResources(t,e){if(!this.enabled)return void this.disposeResources();if(_(this._resources)){if(this._resources.textures.size!==e){const r=this.createTextureResources(t,e);if(A(r))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=r}return}const i=this.createTextureResources(t,e);A(i)||(this._resources={textures:i,program:this.createProgram(t),vao:vn(t,dV,this.attributeLocations,0,1),pipelineState:_t({blending:Qa(1,771),depthTest:null,depthWrite:null,colorWrite:Pt})})}disposeResources(){A(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}disposeTextureResources(t){t.mask.dispose(),t.overlay.dispose(),t.input.dispose()}createTextureResources(t,e){if(A(this._imageSources))return null;this._imageSources.overlay.width=e,this._imageSources.overlay.height=e,this._imageSources.mask.width=e,this._imageSources.mask.height=e;const i=new qe(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:!QD(this._imageSources.overlay.src)||!t.driverTest.svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new qe(t,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new qe(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:r,overlay:i,size:e}}createProgram(t){const e=Ott();return new fi(t,e,this.attributeLocations)}};u([d()],Tw.prototype,"_imageSources",void 0),u([d()],Tw.prototype,"_imageLoadTask",void 0),u([d({readOnly:!0})],Tw.prototype,"updating",null),Tw=u([R("esri/views/3d/webgl-engine/lib/MagnifierHelper")],Tw);class Hj{constructor(){this.viewTransform=new eo.ViewProjectionTransform,this.slicePlane=_y()}}class Itt extends Hj{constructor(){super(...arguments),this.identifier=0,this.slicePlaneEnabled=!0,this.transparent=!1,this.integratedMesh=!1,this.transformNormal_ViewFromGlobal=Ai(),this.cameraNearFar=ke(),this.inverseViewport=ke(),this.ambientOcclusionEnabled=!0,this.shadowsEnabled=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3}}class Dtt extends Hj{constructor(){super(...arguments),this.identifier=1,this.cameraNearFar=ke()}}class Ftt extends Hj{constructor(){super(...arguments),this.identifier=2,this.inverseViewport=ke(),this.viewport=Ot()}}class Xm{constructor(e,i,r=0){this._rctx=e,this._techniqueRepository=i,this._sorting=r,this._draws=new ct({initialSize:32,allocator:s=>s||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map}submitDraw(e,i,r,s,n){const o=this._draws.pushNew();o.geometry=i,o.geometryRanges=r,o.material=e,o.bindDrawParams=s,o.depthSquaredHint=n,o.indexType=i.indexed?at(i.vao.indexBuffer).indexType:0}dispatch(e){const i=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let r=null;const s=this._draws.length;for(let n=0;n<s;n++){const o=this._draws.data[n],a=o.geometry,l=o.material.getTechnique(this._techniqueRepository,e,a.parameters);l===r&&l.configuration.transparencyPassType===3||(i.useProgram(l.program),l.bindPipelineState(i,e.slot),r=l),this._passBoundTechniques.has(l)||(l.bindPass(e),this._passBoundTechniques.add(l)),i.bindVAO(a.vao),this._previouslyBoundMaterials.get(l)!==o.material&&(l.bindMaterial(o.material,e),this._previouslyBoundMaterials.set(l,o.material)),this._previouslyBoundDraw.get(l)!==o.bindDrawParams&&(l.bindDraw(o.bindDrawParams),this._previouslyBoundDraw.set(l,o.bindDrawParams));const c=o.geometryRanges,h=c.length;if(o.indexType!==0){const p=P4.get(o.indexType);for(let f=0;f<h;f+=2){const g=c[f],y=c[f+1];i.drawElements(a.primitiveType,y,o.indexType,g*p)}}else for(let p=0;p<h;p+=2){const f=c[p],g=c[p+1];i.drawArrays(a.primitiveType,f,g)}}return s>0}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===0?1:-1;this._draws.sort((i,r)=>{const s=e*(i.depthSquaredHint-r.depthSquaredHint);return s!==0?s:i.geometry.vao.size-r.geometry.vao.size})}get count(){return this._draws.length}}const P4=new Map;P4.set(5121,1),P4.set(5123,2),P4.set(5125,4);class Ltt{constructor(e,i){this.rctx=e,this.shaderTechniqueRepository=i,this.canRender=!0,this._materialPassParams=new Itt,this._shadowPassParams=new Dtt,this._highlightPassParams=new Ftt,this._systems=new Set,this._passes={materialOpaque:new Xm(e,this.shaderTechniqueRepository),materialTransparent:new Xm(e,this.shaderTechniqueRepository,1),materialIntegratedMesh:new Xm(e,this.shaderTechniqueRepository),shadowMap:new Xm(e,this.shaderTechniqueRepository),highlight:new Xm(e,this.shaderTechniqueRepository),highlightIntegratedMesh:new Xm(e,this.shaderTechniqueRepository),highlightShadowMap:new Xm(e,this.shaderTechniqueRepository),defaultShadowMap:new Xm(e,this.shaderTechniqueRepository)}}register(e){this._systems.add(e)}prepareRender(e){if(this._systems.size!==0){for(const i of Object.values(this._passes))i.prepareSubmit();this._systems.forEach(i=>i.submit(this._passes,{camera:e}));for(const i of Object.values(this._passes))i.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}render(e){if(this._systems.size===0)return!1;switch(this._configure(e),e.slot){case 3:switch(e.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this._passes.materialOpaque.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialOpaque.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialOpaque.dispatch(this._materialPassParams);case 5:return this._passes.highlight.dispatch(this._highlightPassParams);case 4:return this._passes.shadowMap.dispatch(this._shadowPassParams);case 7:return this._passes.highlightShadowMap.dispatch(this._shadowPassParams);case 6:return this._passes.defaultShadowMap.dispatch(this._shadowPassParams)}return!1;case 5:switch(e.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this._passes.materialTransparent.dispatch(this._materialPassParams);case 1:return this._materialPassParams.subPass=1,this._configureMaterialColorPass(e),this._passes.materialTransparent.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialTransparent.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialTransparent.dispatch(this._materialPassParams)}return!1;case 0:switch(e.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this._materialPassParams.ssrParams=e.ssrParams,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 5:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return!1}return!1}notifyDirty(){this._context.requestRender()}slots(){return[3,5,0]}initializeRenderContext(e){this._context=e}uninitializeRenderContext(){}queryDepthRange(e){const i={near:1/0,far:-1/0};return this._systems.forEach(r=>{const s=r.queryShadowCasterDepthRange(e);_(s)&&ww(i,s,i)}),i}get shadowCastingEnabled(){return this._materialPassParams.shadowsEnabled}set shadowCastingEnabled(e){this._materialPassParams.shadowsEnabled=e}get screenSpaceReflectionsEnabled(){return _(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(e){this._materialPassParams.ssrParams.ssrEnabled=!!e}_configureMaterialColorPass(e){this._materialPassParams.bindShadowMap=i=>{e.shadowMap.bind(i);const r=this._materialPassParams.viewTransform;de(iC,r.worldFromView_TL,r.worldFromView_TH),e.shadowMap.bindView(i,iC)},this._materialPassParams.bindAmbientOcclusion=i=>e.ssaoHelper.bind(i,e.camera),this._materialPassParams.ambientOcclusionEnabled=!!e.ssaoHelper&&e.ssaoHelper.ready,this._materialPassParams.sceneHasOcludees=e.hasOccludees}_configure(e){const i=e.pass===4||e.pass===7||e.pass===6?this._shadowPassParams:e.pass===5?this._highlightPassParams:this._materialPassParams;this._updateParameters(e,i)}_updateParameters(e,i){const r=e.camera,s=r.viewInverseTransposeMatrix;ne(iC,s[3],s[7],s[11]),Wj.set(iC),re(i.viewTransform.worldFromView_TH,Wj.high),re(i.viewTransform.worldFromView_TL,Wj.low),Ka(i.viewTransform.viewFromCameraRelative_RS,r.viewMatrix),ji(i.viewTransform.projFromView,r.projectionMatrix),i.identifier===0?(this._materialPassParams.transparent=e.slot===5,this._materialPassParams.integratedMesh=e.slot===0,this._materialPassParams.lighting=e.scenelightingData,el(Hfe,i.viewTransform.viewFromCameraRelative_RS),p0(i.transformNormal_ViewFromGlobal,Hfe),si(i.cameraNearFar,r.near,r.far)):i.identifier===1?si(i.cameraNearFar,r.near,r.far):i.identifier===2&&(i.highlightDepthTexture=e.highlightDepthTexture,Ln(i.viewport,r.fullViewport)),i.identifier!==0&&i.identifier!==2||(i.inverseViewport[0]=1/r.fullViewport[2],i.inverseViewport[1]=1/r.fullViewport[3]),mQ(e.sliceHelper.plane,i.slicePlane),ue(i.slicePlane.origin,i.slicePlane.origin,iC),i.slicePlaneEnabled=e.sliceHelper.isEnabled,this._materialPassParams.slot=e.slot,this._materialPassParams.transparencyPassType=e.transparencyPassType,this._materialPassParams.multipassTerrainParams=e.multipassTerrainParams}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}}const iC=$(),Hfe=Ai(),Wj=new S4;function ktt(t){const e=new pi,i=e.vertex.code,r=e.fragment.code;return e.attributes.add("position","vec2"),t.highlightStage===2&&(i.add(x`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("invFramebufferDim","vec2"),r.add(x`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`)),t.highlightStage===0&&(e.attributes.add("uv0","vec2"),t.gridOptimization?(e.vertex.uniforms.add("coverageTex","sampler2D"),e.fragment.uniforms.add("blurSize","vec2"),e.varyings.add("blurCoordinate","vec3")):(e.vertex.uniforms.add("blurSize","vec2"),e.varyings.add("blurCoordinates[5]","vec2")),i.add(x`
    void main() {
      gl_Position = vec4(position, 0.0, 1.0);
      ${t.gridOptimization?x`
      vec4 cov = texture2D(coverageTex, uv0);
      if (cov.r == 0.0) {
        gl_Position = vec4(0.0);
      }
      blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
      `:x`
      vec2 uv = position.xy * 0.5 + vec2(0.5);
      blurCoordinates[0] = uv;
      blurCoordinates[1] = uv + blurSize * 1.407333;
      blurCoordinates[2] = uv - blurSize * 1.407333;
      blurCoordinates[3] = uv + blurSize * 3.294215;
      blurCoordinates[4] = uv - blurSize * 3.294215;
          `}
    }`),e.fragment.uniforms.add("tex","sampler2D"),r.add(x`
    void main() {
      ${t.gridOptimization?x`
          vec2 uv = blurCoordinate.xy;
          vec4 center = texture2D(tex, uv);

          // do not blur if no pixel or all pixels in neighborhood are set
          if (blurCoordinate.z == 1.0) {
            gl_FragColor = center;
          } else {
            vec4 sum = vec4(0.0);
            sum += center * 0.204164;
            sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
            sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
            gl_FragColor = sum;
          }`:x`
          vec4 sum = vec4(0.0);
          sum += texture2D(tex, blurCoordinates[0]) * 0.204164;
          sum += texture2D(tex, blurCoordinates[1]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[2]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[3]) * 0.093913;
          sum += texture2D(tex, blurCoordinates[4]) * 0.093913;
          gl_FragColor = sum;`}
    }`)),t.highlightStage===1&&(e.varyings.add("uv","vec2"),t.gridOptimization&&(e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("coverageTex","sampler2D")),i.add(x`
      void main() {
        ${t.gridOptimization?x`
            vec4 cov = texture2D(coverageTex, uv0);
            // if no highlight pixel set in this block, hide block
            if (cov.r == 0.0) {
              gl_Position = vec4(0.0);
              return;
            }`:""}
        gl_Position = vec4(position, 0.0, 1.0);
        uv = position.xy * 0.5 + vec2(0.5);
      }`),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("origin","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.uniforms.add("haloColor","vec4"),e.fragment.uniforms.add("outlineSize","float"),e.fragment.uniforms.add("blurSize","float"),e.fragment.uniforms.add("opacities","vec4"),r.add(x`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = color.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = color.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, color.rgb, fillFactor), intensity);
}`)),e}const ztt=Object.freeze({__proto__:null,build:ktt}),Vtt=8.6,Ntt=.4;class Km extends Si{initializeProgram(e){const i=Km.shader.get().build(this.configuration);return new fi(e.rctx,i,Ht)}bindApplyPass(e){this.program.setUniform4fv("color",e.color),this.program.setUniform4fv("haloColor",e.haloColor),this.program.setUniform1f("outlineSize",Vtt),this.program.setUniform1f("blurSize",Ntt),this.program.setUniform4f("opacities",e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)}initializePipeline(){return this.configuration.highlightStage===1?_t({blending:Xs(770,1,771,771),colorWrite:Pt}):_t({colorWrite:Pt})}get primitiveType(){return this.configuration.gridOptimization?4:5}}Km.shader=new vi(ztt,()=>import("./HighlightComposition.glsl.9312235c.js"));class Zj extends tr{constructor(){super(...arguments),this.highlightStage=0,this.gridOptimization=!1}}u([X({count:3})],Zj.prototype,"highlightStage",void 0),u([X()],Zj.prototype,"gridOptimization",void 0);const Utt=32;class jtt{constructor(e,i){this._techniqueRep=e,this._rctx=i,this.viewportToRestore=Ot(),this.defaultOptions={color:io(1,0,1,1),haloColor:io(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:io(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075},this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}assertResources(){if(this.quadVAO)return;this.quadVAO=vn(this._rctx);const e={colorTarget:0,depthStencilTarget:0,width:0,height:0},i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new ci(this._rctx,e,i),this.blur1Fbo=new ci(this._rctx,e,i);const r=new Zj;r.highlightStage=0,r.gridOptimization=!1,this.blurTechnique=this._techniqueRep.acquire(Km,r),r.highlightStage=0,r.gridOptimization=!0,this.blurGridTechnique=this._techniqueRep.acquire(Km,r),r.highlightStage=1,r.gridOptimization=!1,this.applyTechnique=this._techniqueRep.acquire(Km,r),r.highlightStage=1,r.gridOptimization=!0,this.applyGridTechnique=this._techniqueRep.acquire(Km,r),r.highlightStage=2,r.gridOptimization=!1,this.downsampleTechnique=this._techniqueRep.acquire(Km,r)}dispose(){if(this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null),this.blur0Fbo=Ge(this.blur0Fbo),this.blur1Fbo=Ge(this.blur1Fbo)}get profilingCallback(){return Kt.HIGHLIGHTS_PROFILE_TO_CONSOLE?e=>console.log(e):null}setDefaultOptions(e){this.defaultOptions=e}render(e,i,r){const s=e.pixelRatio,n=Kt.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,o=this._rctx;this.assertResources(),Ln(this.viewportToRestore,e.fullViewport);const a=e.fullWidth,l=e.fullHeight,c=Math.ceil(a/s),h=Math.ceil(l/s);this.blur0Fbo.resize(c,h),this.blur1Fbo.resize(c,h),o.bindVAO(this.quadVAO);let p=null;const f=n?this.blurGridTechnique:this.blurTechnique;f.bindPipelineState(o),o.useProgram(f.program),n?(this._gridUpdateResources(i,Utt),this._gridComputeMipmap(),p=this._grid.vao,f.program.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,"coverageTex")):p=this.quadVAO,o.bindVAO(p),o.bindFramebuffer(this.blur0Fbo),o.setViewport(0,0,c,h),o.setClearColor(0,0,0,0),o.clear(16384),f.program.bindTexture(i.colorTexture,"tex"),f.program.setUniform2f("blurSize",1/c,0),o.drawArrays(f.primitiveType,0,xs(p,"geometry")),o.bindFramebuffer(this.blur1Fbo),o.clear(16384),f.program.bindTexture(this.blur0Fbo.colorTexture,"tex"),f.program.setUniform2f("blurSize",0,1/h),o.drawArrays(f.primitiveType,0,xs(p,"geometry"));const g=n?this.applyGridTechnique:this.applyTechnique;if(o.bindFramebuffer(r),g.bindPipelineState(o),o.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),o.useProgram(g.program),g.program.bindTexture(this.blur1Fbo.colorTexture,"tex"),g.program.bindTexture(i.colorTexture,"origin"),n){const y=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;g.program.bindTexture(y,"coverageTex")}g.bindApplyPass(this.defaultOptions),o.drawArrays(g.primitiveType,0,xs(p,"geometry")),o.bindVAO(null)}_gridUpdateResources(e,i){const r=this._rctx,s=this._grid;let n=!1;if(s.coverageMipmap===null&&(s.coverageMipmap=[e],n=!0),s.viewportWidth===e.width&&s.viewportHeight===e.height||(n=!0,s.viewportWidth=e.width,s.viewportHeight=e.height),s.coverageMipmap[0]=e,s.cellPixelSize!==i&&(s.cellPixelSize=i,n=!0),n){for(let l=1;l<s.coverageMipmap.length;l++)s.coverageMipmap[l].dispose();s.mipmapLevels=Math.ceil(Math.log(s.cellPixelSize)*Math.LOG2E),s.coverageMipmap.length=s.mipmapLevels+1;for(let l=0;l<s.mipmapLevels;l++){const c=s.coverageMipmap[l],h={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)},p={colorTarget:0,depthStencilTarget:0,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)};s.coverageMipmap[l+1]=new ci(r,p,h)}}const o=Math.ceil(e.height/s.cellPixelSize),a=Math.ceil(e.width/s.cellPixelSize);if(!s.vao||s.verticalCellCount!==o||s.horizontalCellCount!==a){s.verticalCellCount=o,s.horizontalCellCount=a;const l=o+1,c=a+1,h=1/o,p=1/a,f=6,g=4,y=new Float32Array(f*g*l*c);let v=0;for(let b=0;b<l;b++)for(let w=0;w<c;w++)y[v+0]=(w-.5)*p*2-1,y[v+1]=(b-.5)*h*2-1,y[v+2]=w*p,y[v+3]=b*h,y[v+4]=(w+.5)*p*2-1,y[v+5]=(b-.5)*h*2-1,y[v+6]=w*p,y[v+7]=b*h,y[v+8]=(w-.5)*p*2-1,y[v+9]=(b+.5)*h*2-1,y[v+10]=w*p,y[v+11]=b*h,y[v+12]=(w-.5)*p*2-1,y[v+13]=(b+.5)*h*2-1,y[v+14]=w*p,y[v+15]=b*h,y[v+16]=(w+.5)*p*2-1,y[v+17]=(b-.5)*h*2-1,y[v+18]=w*p,y[v+19]=b*h,y[v+20]=(w+.5)*p*2-1,y[v+21]=(b+.5)*h*2-1,y[v+22]=w*p,y[v+23]=b*h,v+=f*g;s.vao&&s.vao.dispose(!0),s.vao=new Tr(r,Ht,{geometry:GS},{geometry:Nt.createVertex(r,35044,y)})}}_gridComputeMipmap(){const e=this._rctx,i=this._grid,r=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(e),e.bindVAO(this.quadVAO),e.useProgram(r);for(let s=0;s<i.mipmapLevels;s++){e.bindFramebuffer(i.coverageMipmap[s+1]),r.bindTexture(i.coverageMipmap[s].colorTexture,"tex");const n=i.coverageMipmap[s+1].width,o=i.coverageMipmap[s+1].height;r.setUniform2f("invFramebufferDim",1/n,1/o),e.setViewport(0,0,n,o),e.drawArrays(5,0,xs(this.quadVAO,"geometry"))}}get gpuMemoryUsage(){let e=(_(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+(_(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const i of this._grid.coverageMipmap)e+=i.gpuMemoryUsage;return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}const Btt={dataType:5121,internalFormat:6408},Gtt={};class qtt{constructor(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach(e=>e.dispose()),this._depthBuffers.clear(),this._depthTextures.forEach(e=>e.dispose()),this._depthTextures.clear(),this._colorTextures.forEach(e=>e.dispose()),this._colorTextures.clear(),this._framebuffers.forEach(e=>e.dispose()),this._framebuffers.clear()}disposeTargetResource(e){const i=e.id;this._activeTargets.has(i)&&(this._activeTargets.delete(i),this.disposeWithFramebuffers(this._depthTextures,i),this.disposeWithFramebuffers(this._depthBuffers,i),this.disposeWithFramebuffers(this._colorTextures,i))}disposeWithFramebuffers(e,i){const r=e.get(i);r&&(this._framebuffers.forEach((s,n)=>{s.colorAttachment!==r&&s.depthStencilAttachment!==r||(s.detachAll(),s.dispose(),this._framebuffers.delete(n))}),r.dispose(),e.delete(i))}getDepthTexture(e,i){if(!this.depthTextureSupported)return null;let r=this._depthTextures.get(e.id);return!r||r.descriptor.width===i.width&&r.descriptor.height===i.height||(r.dispose(),r=null),r||(r=new qe(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:i.width,height:i.height}),this._depthTextures.set(e.id,r),this._activeTargets.add(e.id)),r}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,i){if(this.depthTextureSupported)return null;let r=this._depthBuffers.get(e.id);return r?r.descriptor.width===i.width&&r.descriptor.height===i.height||r.resize(i.width,i.height):(r=new JS(this.rctx,E({internalFormat:34041},i)),this._depthBuffers.set(e.id,r),this._activeTargets.add(e.id)),r}getColorTexture(e,i){let r=this._colorTextures.get(e.id);return r&&(r.descriptor.width===i.width&&r.descriptor.height===i.height||(r.dispose(),r=null)),r||(r=new qe(this.rctx,{target:3553,pixelFormat:6408,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:e.samplingMode!=null?e.samplingMode:9729,wrapMode:33071,width:i.width,height:i.height}),this._colorTextures.set(e.id,r),this._activeTargets.add(e.id)),r}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return E(E({id:On()},Gtt),e)}registerColorTarget(e={}){return E(E({id:On()},Btt),e)}getFramebuffer(e,i,r){const s=this.getKey(i,r);let n=this._framebuffers.get(s);const o=this.getColorTexture(i,e);if(this.depthTextureSupported){const l=r?this.getDepthTexture(r,e):void 0;return n?((n.width!==e.width||n.height!==e.height||n.colorTexture!==o||n.depthStencilTexture!==l)&&(n.detachAll(),n.resize(e.width,e.height),n.attachColorTexture(o),n.attachDepthStencilTexture(l)),n):(n=_(r)?new ci(this.rctx,{colorTarget:0,depthStencilTarget:4},o,l):new ci(this.rctx,{colorTarget:0,depthStencilTarget:0},o),this._framebuffers.set(s,n),n)}const a=r?this.getDepthBuffer(r,e):void 0;return n?((n.width!==e.width||n.height!==e.height||n.colorTexture!==o)&&(n.detachAll(),n.resize(e.width,e.height),n.attachColorTexture(o),n.attachDepthStencilBuffer(a)),n):(n=new ci(this.rctx,{colorTarget:0,depthStencilTarget:r?3:0},o,a),this._framebuffers.set(s,n),n)}getKey(e,i){return`${e.id}_${i?i.id:"X"}_${e.name}${i?"_"+i.name:""}`}get gpuMemoryUsage(){let e=0;const i=new Set,r=s=>{i.has(s)||(i.add(s),e+=Gf(s))};return this._depthTextures.forEach(r),this._colorTextures.forEach(r),this._depthBuffers.forEach(r),e}}class Htt{constructor(e,i){this._rctx=e,this._compositingHelper=i,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const r=e.webglVersion==="webgl2";this._renderTargetHelper=new qtt(e);const s=this._renderTargetHelper;this.mainColorTargets=[s.registerColorTarget({name:"mainColorTarget0"}),s.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const n=o=>s.registerColorTarget({name:o,dataType:5126,internalFormat:r?34836:6408,samplingMode:9728});this.colorFloatTarget=n("colorFloatTarget"),this.alphaFloatTarget=n("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:9728}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:r?32854:6408,dataType:32819}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:r?32854:6408,dataType:32819}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}get width(){return this._dimensions.width}get height(){return this._dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return this.mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this.mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,i){return this._renderTargetHelper.getFramebuffer(this._dimensions,e,i)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this.getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this.getColorTexture(this.tmpColor)}get hudColorTexture(){return this.getColorTexture(this.hudColor)}get mainColorTexture(){return this.getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._mainColorTarget=this._mainColorTarget===0&&this._needLastFrameColorTexture?1:0}initializeFrame(e){const i=this._rctx;this._dimensions.width=e.fullWidth,this._dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),i.setClearStencil(0);const r=this._background.color;i.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),i.clearSafe(17664)}composite(){_(this.colorTexture)&&this._compositingHelper.composite(this.colorTexture,0)}renderTmpAndCompositeToMain(e,i,r=!1){this.renderToTargets(e,this.tmpColor,r?this.tmpDepth:this.mainDepth,Wtt),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),i)}renderHUDVisibility(e,i=!1){this.renderToTargets(e,this.hudVisibility,i?this.tmpDepth:this.mainDepth,Ztt)}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets(()=>this._compositingHelper.composite(this.getColorTexture(this.tmpColor),0,1,1),this.hudVisibility,this.tmpDepth)}renderOITPass(e,i,r){let s,n;switch(i){case 0:s=this.colorFloatTarget,n=[0,0,0,0];break;case 1:s=this.alphaFloatTarget,n=[1,1,1,1];break;case 2:s=this.frontFaceTarget,n=[0,0,0,0]}r?this.renderToTargets(e,s,this.tmpDepth,n,!0,!0):this.renderToTargets(e,s,this.mainDepth,n,!1)}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2)}compositeOccludedOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2,e)}compositeTransparentOntoOpaque(e){e?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(16384)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget),this.getColorTexture(this.alphaFloatTarget),this.getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this._renderTargetHelper.disposeTargetResource(e)}set needLastFrameColorTexture(e){!e&&this._needLastFrameColorTexture&&(this._mainColorTarget=0,this.disposeTarget(this.mainColorTargets[1])),this._needLastFrameColorTexture=e}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(e,i,r,s,n=!1,o=!1){const a=this._rctx,l=this.bindTarget(i,r);let c=0;if(s){const h=1e-13,p=Math.max(h,s[3]);a.setClearColor(s[0],s[1],s[2],p),c|=16384}return n&&(c|=256),o===!1?o=0:(o===!0&&(o=255),c|=1024),c&&a.clearSafe(c,o),e(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),l}bindTarget(e,i){const r=this._renderTargetHelper.getFramebuffer(this._dimensions,e,i);return this._rctx.bindFramebuffer(r),r}getColorTexture(e){return this._renderTargetHelper.getColorTexture(e,this._dimensions)}get gpuMemoryUsage(){let e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}}const Wtt=[0,0,0,0],Ztt=[0,1,0,1];class Jtt{constructor(e){this.context=e,this.renderPlugins=new Array,this.slots=[];for(let i=0;i<23;++i)this.slots[i]=[]}add(e,i,r){const s=()=>{this.renderPlugins.push(i);for(const o of e)this.slots[o].push(i);this.context.requestRender()},n=i.initializeRenderContext(this.context,r);if(ZC(n))return n.then(s);s()}remove(e){const i=this.renderPlugins.length;this.renderPlugins=this.renderPlugins.filter(r=>r!==e),Ze(this.renderPlugins.length<i,"Removing non-added render plugin");for(let r=0;r<this.slots.length;++r)this.slots[r]=this.slots[r].filter(s=>s!==e);e.uninitializeRenderContext(),this.context.requestRender()}prepareRender(e,i){for(const r of this.renderPlugins)r.prepareRender&&r.prepareRender(e,i)}render(){const e=this.slots[this.context.renderContext.slot];let i=!1;for(const r of e)r.canRender&&r.render(this.context.renderContext)&&(i=!0);return i}queryDepthRange(e){const i=Qtt;i.near=1/0,i.far=-1/0;for(const r of this.renderPlugins)if(r.queryDepthRange){const s=r.queryDepthRange(e);s&&ww(i,s,i)}return i}get needsHighlight(){return this.renderPlugins.some(e=>e.needsHighlight)}get needsLinearDepth(){return this.renderPlugins.some(e=>e.needsLinearDepth)}get needsLaserlineWithContrastControl(){const e=this.slots[15];return!!e&&e.length>0}get renderOccludedFlags(){let e=0;return this.renderPlugins.forEach(i=>{i.renderOccludedFlags&&(e|=i.renderOccludedFlags)}),e}}const Qtt={near:0,far:0};function Jj(t){t.fragment.uniforms.add("projInfo","vec4"),t.fragment.uniforms.add("zScale","vec2"),t.fragment.code.add(x`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}const A4=255,Ytt=1/A4;function Xtt(t){const e=new pi;e.fragment.include(zu),e.fragment.include(Lr),e.include(Jj),e.include(KT);const{pass:i}=t;if(i===1){const{visualization:r,bandsEnabled:s}=t;e.fragment.constants.add("inverseSampleValue","float",A4),e.fragment.uniforms.add("shadowCastMap","sampler2D"),e.fragment.uniforms.add("sampleScale","float"),e.fragment.uniforms.add("opacityFromElevation","float");const n=r===0,o=r===1;e.fragment.uniforms.add("color","vec4"),n?s&&e.fragment.uniforms.add("bandSize","float"):o&&e.fragment.uniforms.add("threshold","float"),e.fragment.code.add(x`
      void main(void) {
        vec4 record = texture2D(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;

        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${o?x`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${n&&s?x`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = vec4(color.xyz, color.a * opacityFromElevation ${n?x`* strength`:""});
      }
    `)}else i!==0&&i!==2||(e.include(Bd),e.fragment.uniforms.add("depthMap","sampler2D"),e.fragment.uniforms.add("inverseView","mat4"),e.fragment.uniforms.add("nearFar","vec2"),i===0?e.fragment.constants.add("sampleValue","float",Ytt):e.fragment.constants.add("shadowColor","vec4",[0,0,0,.8]),e.fragment.code.add(x`
      void main(void) {

        float depth = rgba2float(texture2D(depthMap, uv));
        // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
        if (depth == 0.0) {
          discard;
        }

        float currentPixelDepth = linearDepthFromFloat(depth, nearFar);

        if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
          discard;
        }

        vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
        vec4 worldSpacePos = inverseView * currentPixelPos;

        mat4 shadowMatrix;
        float linearDepth = -currentPixelDepth;
        int i = chooseCascade(linearDepth, shadowMatrix);

        if (i >= uShadowMapNum) {
          discard;
        }

        vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

        // vertex completely outside? -> no shadow
        if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
          discard;
        }

        vec2 uvShadow = cascadeCoordinates(i, lvpos);

        float depthShadow = readShadowMapDepth(uvShadow, uShadowMapTex);
        bool shadow = depthShadow < lvpos.z;

        if (!shadow) {
          discard;
        }

        gl_FragColor = ${i===0?x`vec4(sampleValue)`:x`shadowColor`};
      }
    `));return e}const Ktt=Object.freeze({__proto__:null,shadowCastMaxSamples:A4,build:Xtt});class rC extends Si{initializeProgram(e){const i=rC.shader.get().build(this.configuration);return new fi(e.rctx,i,Ht)}initializePipeline(e){switch(this.configuration.pass){case 0:return _t({blending:Xs(1,1,1,1),colorWrite:Pt,depthTest:null,depthWrite:null});case 1:case 2:return _t({blending:qu,colorWrite:Pt,depthTest:null,depthWrite:null})}return _t({})}bindPass(e){if(this.configuration.pass===0||this.configuration.pass===2){const i=e;this.program.bindTexture(i.linearDepthTexture,"depthMap"),i.shadowMap.bind(this.program),i.shadowMap.bindView(this.program,i.camera.center),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",i.inverseView),this.program.setUniform4fv("projInfo",i.projInfo),this.program.setUniform2fv("zScale",i.zScale)}else if(this.configuration.pass===1){const i=e;if(this.program.bindTexture(i.shadowCastMap,"shadowCastMap"),this.program.setUniform1f("sampleScale",i.sampleScale),this.program.setUniform1f("opacityFromElevation",i.opacityFromElevation),this.program.setUniform4fv("color",i.color),this.configuration.visualization===0&&this.configuration.bandsEnabled){const r=e;this.program.setUniform1f("bandSize",r.bandSize)}else if(this.configuration.visualization===1){const r=e;this.program.setUniform1f("threshold",r.threshold)}}}get primitiveType(){return 5}}rC.shader=new vi(Ktt,()=>import("./ShadowCast.glsl.0e1c7979.js"));class sC extends tr{constructor(){super(...arguments),this.pass=0,this.visualization=0,this.bandsEnabled=!1}}u([X({count:3})],sC.prototype,"pass",void 0),u([X()],sC.prototype,"visualization",void 0),u([X()],sC.prototype,"bandsEnabled",void 0);const eit=Bt(.01,0,.25,1),tit=4e4,iit=5e4,Wfe=1/512;let $4=class extends ve{constructor(t,e,i,r){super({}),this._techniqueRepository=t,this._rctx=e,this._shadowAccumulator=i,this._requestRender=r,this._visualizationParams={shadowCastMap:this._shadowCastTexture,sampleScale:0,color:eit,threshold:.5,bandSize:.1,opacityFromElevation:1},this._techniqueConfig=new sC,this._enabled=!1,this._vao=vn(e),this._techniqueConfig.pass=1,this._techniqueConfig.visualization=0}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=Ge(this._vao),this._techniqueRepository.release(this._technique),this._technique=null,this._shadowAccumulator=null}get visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(rC,this._techniqueConfig,this._technique),this._technique}render(){if(!this._isRenderingVisualization)return;this._sampleScale=1/this._computedSamples,this._rctx.bindVAO(this._vao);const t=this.visualizeShadowCastTechnique;this._rctx.useProgram(t.program),t.bindPipelineState(this._rctx),t.bindPass(this._visualizationParams),this._rctx.drawArrays(t.primitiveType,0,xs(this._vao,"geometry"))}setOptions(t){t.enabled!==void 0&&this._setEnabled(t.enabled),t.color!==void 0&&this._setColor(t.color),t.threshold!==void 0&&(this._threshold=t.threshold),t.visualization!==void 0&&(this._visualization=t.visualization),t.bandSize!==void 0&&(this._bandSize=t.bandSize),t.bandsEnabled!==void 0&&(this._bandsEnabled=t.bandsEnabled)}get opacityFromElevation(){return this._visualizationParams.opacityFromElevation}set opacityFromElevation(t){this._visualizationParams.opacityFromElevation!==t&&(this._visualizationParams.opacityFromElevation=t,this.notifyChange("opacityFromElevation"))}get _isRenderingVisualization(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>Wfe}get _computedSamples(){return this._shadowAccumulator.computedSamples}get _shadowCastTexture(){return this._shadowAccumulator.shadowCastTexture}get _sampleScale(){return this._visualizationParams.sampleScale}set _sampleScale(t){this._visualizationParams.sampleScale=t}get _threshold(){return this._visualizationParams.threshold}set _threshold(t){this._threshold!==t&&(this._visualizationParams.threshold=t,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(t){t!==this._visualization&&(this._techniqueConfig.visualization=t,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._visualizationParams.bandSize}set _bandSize(t){t!==this._bandSize&&(this._visualizationParams.bandSize=t,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(t){t!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=t,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(t){const e=this._visualizationParams.color;Pg(t,e)||(Ln(this._visualizationParams.color,t),this._requestRenderIfRunning())}_setEnabled(t){t!==this._enabled&&(t?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};u([d()],$4.prototype,"opacityFromElevation",null),$4=u([R("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],$4);class rit{constructor(){this.camera=new Zt,this.lightMat=be()}}class Zfe{constructor(e,i,r=0){this.rctx=e,this.viewingMode=i,this._enabled=!1,this._snapshots=new Array,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let s=0;s<4;++s)this.cascades.push(new rit);this.snapshotCount=r}dispose(){this.discardDepthTexture(),this.discardAllSnapshots()}set maxCascades(e){this.maxNumCascades=Re(Math.floor(e),1,4)}get maxCascades(){return this.maxNumCascades}set enabled(e){this._enabled=e,e||(this.discardDepthTexture(),this.discardAllSnapshots())}get enabled(){return this._enabled}get snapshotCount(){return this._snapshots.length}set snapshotCount(e){const i=this._snapshots.length;if(e>i){const r=e-i;this._snapshots.length=e;for(let s=0;s<r;++s)this._snapshots[i+s]=null}else if(e<this.snapshotCount){const r=i-e;for(let s=0;s<r;++s)this.discardSnapshot(e+s);this._snapshots.length=e}}getSnapshot(e){return this.enabled?this._snapshots[e]:null}getCascades(){for(let e=0;e<this.numCascades;++e)Yj[e]=this.cascades[e];return Yj.length=this.numCascades,Yj}start(e,i,r){Ze(this.enabled),this.textureSize=this.computeTextureSize(e.fullWidth,e.fullHeight),this.ensureDepthTexture();const{near:s,far:n}=this.clampNearFar(r);this.computeCascadeDistances(n,s),this.setupMatrices(e,i);const o=e.viewMatrix,a=e.projectionMatrix;for(let l=0;l<this.numCascades;++l)this.constructCascade(l,a,o,i);this.lastOrigin=null,this.clear()}finish(e){Ze(this.enabled),this.rctx.bindFramebuffer(e)}bind(e){this.enabled?(this._depthTextureUnit=e.bindTexture(this._depthTexture,"uShadowMapTex"),e.setUniform1f("uDepthHalfPixelSz",.5/this.textureSize),e.setUniform1i("uShadowMapNum",this.numCascades),e.setUniform4f("uShadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)):e.setUniform1f("uDepthHalfPixelSz",-1)}bindView(e,i){if(!this.enabled)return;const r=this.lastOrigin;if(!(r&&r[0]===i[0]&&r[1]===i[1]&&r[2]===i[2])){this.lastOrigin=this.lastOrigin||$(),re(this.lastOrigin,i);for(let s=0;s<this.numCascades;++s){Vs(sme,this.cascades[s].lightMat,i);for(let n=0;n<16;++n)nme[16*s+n]=sme[n]}}e.setUniformMatrix4fv("uShadowMapMatrix",nme)}takeCascadeSnapshotTo(e,i){Ze(this.enabled),this.ensureSnapshot(i),this._bindFbo();const r=this.rctx,s=r.bindTexture(this._snapshots[i],qe.TEXTURE_UNIT_FOR_UPDATES);r.gl.copyTexSubImage2D(3553,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),r.bindTexture(s,qe.TEXTURE_UNIT_FOR_UPDATES)}clear(){const e=this.rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(16640)}computeTextureSize(e,i){const r=.5*Math.log(e*e+i*i)*Math.LOG2E,s=.35,n=2**Math.round(r+s);return Math.min(this.maxTextureSize,2*n)}ensureDepthTexture(){if(this._depthTexture!=null&&this._depthTexture.descriptor.width===this.textureSize)return;this.discardDepthTexture();const e={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._depthTexture=new qe(this.rctx,e),this.fbo=new ci(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this._depthTexture)}ensureSnapshot(e){const i=this._snapshots[e];if(_(i)&&i.descriptor.width===this.textureSize)return;this.discardSnapshot(e);const r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._snapshots[e]=new qe(this.rctx,r)}discardDepthTexture(){this.fbo=Ge(this.fbo),this._depthTexture=Ge(this._depthTexture)}discardSnapshot(e){this._snapshots[e]=Ge(this._snapshots[e])}discardAllSnapshots(){for(let e=0;e<this.snapshotCount;++e)this.discardSnapshot(e)}_bindFbo(){const e=this.rctx;_(this._depthTextureUnit)&&(e.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null),e.bindFramebuffer(this.fbo)}constructCascade(e,i,r,s){const n=this.cascades[e],o=-this.cascadeDistances[e],a=-this.cascadeDistances[e+1],l=(i[10]*o+i[14])/Math.abs(i[11]*o+i[15]),c=(i[10]*a+i[14])/Math.abs(i[11]*a+i[15]);Ze(l<c);for(let p=0;p<8;++p){Ls(Xfe,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?l:c,1),Va(No[p],Xfe,Yfe);for(let f=0;f<3;++f)No[p][f]/=No[p][3]}Fs(Qj,No[0]),Vs(Jfe,rme,Qj),n.camera.viewMatrix=Jfe;for(let p=0;p<8;++p)Oe(No[p],No[p],n.camera.viewMatrix);re(fh,No[0]),re(mh,No[0]);for(let p=1;p<8;++p)for(let f=0;f<3;++f)fh[f]=Math.min(fh[f],No[p][f]),mh[f]=Math.max(mh[f],No[p][f]);fh[2]-=200,mh[2]+=200,n.camera.near=-mh[2],n.camera.far=-fh[2],this.warp?this.constructTrapezoidalProjection(r,s,n):this.constructOrthogonalProjection(n),wi(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const h=this.textureSize/2;n.camera.viewport[0]=e%2==0?0:h,n.camera.viewport[1]=Math.floor(e/2)===0?0:h,n.camera.viewport[2]=h,n.camera.viewport[3]=h}constructOrthogonalProjection(e){JL(e.camera.projectionMatrix,fh[0],mh[0],fh[1],mh[1],e.camera.near,e.camera.far)}constructTrapezoidalProjection(e,i,r){const s=1/No[0][3],n=1/No[4][3];Ze(s<n);let o=s+Math.sqrt(s*n);const a=Math.sin(ar(e[2]*i[0]+e[6]*i[1]+e[10]*i[2]));o/=a,nit(No,o,a,Kfe,eme,sit,tme,ime),oit(Kfe,eme,tme,ime,r.camera.projectionMatrix),r.camera.projectionMatrix[10]=2/(fh[2]-mh[2]),r.camera.projectionMatrix[14]=-(fh[2]+mh[2])/(fh[2]-mh[2])}setupMatrices(e,i){wi(Qfe,e.projectionMatrix,e.viewMatrix),Fi(Yfe,Qfe);const r=this.viewingMode===1?e.eye:ne(Qj,0,0,1);VP(rme,[0,0,0],[-i[0],-i[1],-i[2]],r)}clampNearFar(e){let{near:i,far:r}=e;return i<2&&(i=2),r<2&&(r=2),i>=r&&(i=2,r=4),{near:i,far:r}}computeCascadeDistances(e,i){this.numCascades=Math.min(1+Math.floor(Dke(e/i,4)),this.maxNumCascades);const r=(e-i)/this.numCascades,s=(e/i)**(1/this.numCascades);let n=i,o=i;for(let a=0;a<this.numCascades+1;++a)this.cascadeDistances[a]=Et(n,o,this.splitSchemeLambda),n*=s,o+=r}get gpuMemoryUsage(){var e,i;return this._snapshots.reduce((r,s)=>r+Gf(s),(e=(i=this.fbo)==null?void 0:i.gpuMemoryUsage)!=null?e:0)}get test(){const e=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(i){e.splitSchemeLambda=i},get splitSchemeLambda(){return e.splitSchemeLambda},set warp(i){e.warp=i},get warp(){return e.warp}}}}const Jfe=be(),Qfe=be(),Yfe=be(),Xfe=Ot(),No=[];for(let t=0;t<8;++t)No.push(Ot());const fh=$(),mh=$(),Kfe=ke(),eme=ke(),sit=ke(),tme=ke(),ime=ke(),rme=be(),Qj=$(),Yj=[],sme=be(),nme=new Float32Array(64),Ta=ke(),Cw=ke(),Rv=[ke(),ke(),ke(),ke()],Ur=ke(),Xj=ke(),eg=ke(),nC=ke(),Mw=ke(),Pw=ke(),E4=ke();function nit(t,e,i,r,s,n,o,a){si(Ta,0,0);for(let M=0;M<4;++M)Tc(Ta,Ta,t[M]);Ao(Ta,Ta,.25),si(Cw,0,0);for(let M=4;M<8;++M)Tc(Cw,Cw,t[M]);Ao(Cw,Cw,.25),W_(Rv[0],t[4],t[5],.5),W_(Rv[1],t[5],t[6],.5),W_(Rv[2],t[6],t[7],.5),W_(Rv[3],t[7],t[4],.5);let l=0,c=SE(Rv[0],Ta);for(let M=1;M<4;++M){const P=SE(Rv[M],Ta);P<c&&(c=P,l=M)}ku(Ur,Rv[l],t[l+4]);const h=Ur[0];let p,f;Ur[0]=-Ur[1],Ur[1]=h,ku(Xj,Cw,Ta),Sr(Xj,Ur)<0&&tV(Ur,Ur),W_(Ur,Ur,Xj,i),NS(Ur,Ur),p=f=Sr(ku(eg,t[0],Ta),Ur);for(let M=1;M<8;++M){const P=Sr(ku(eg,t[M],Ta),Ur);P<p?p=P:P>f&&(f=P)}os(r,Ta),Ao(eg,Ur,p-e),Tc(r,r,eg);let g=-1,y=1,v=0,b=0;for(let M=0;M<8;++M){ku(nC,t[M],r),NS(nC,nC);const P=Ur[0]*nC[1]-Ur[1]*nC[0];P>0?P>g&&(g=P,v=M):P<y&&(y=P,b=M)}ob(g>0,"leftArea"),ob(y<0,"rightArea"),Ao(Mw,Ur,p),Tc(Mw,Mw,Ta),Ao(Pw,Ur,f),Tc(Pw,Pw,Ta),E4[0]=-Ur[1],E4[1]=Ur[0];const w=VE(r,t[b],Pw,Tc(eg,Pw,E4),1,s),S=VE(r,t[v],Pw,eg,1,n),T=VE(r,t[v],Mw,Tc(eg,Mw,E4),1,o),C=VE(r,t[b],Mw,eg,1,a);ob(w,"rayRay"),ob(S,"rayRay"),ob(T,"rayRay"),ob(C,"rayRay")}function Tt(t,e){return 3*e+t}const ome=ke();function Uo(t,e){return si(ome,t[e],t[e+3]),ome}const oo=ke(),ze=Ai();function oit(t,e,i,r,s){ku(oo,i,r),Ao(oo,oo,.5),ze[0]=oo[0],ze[1]=oo[1],ze[2]=0,ze[3]=oo[1],ze[4]=-oo[0],ze[5]=0,ze[6]=oo[0]*oo[0]+oo[1]*oo[1],ze[7]=oo[0]*oo[1]-oo[1]*oo[0],ze[8]=1,ze[Tt(0,2)]=-Sr(Uo(ze,0),t),ze[Tt(1,2)]=-Sr(Uo(ze,1),t);let n=Sr(Uo(ze,0),i)+ze[Tt(0,2)],o=Sr(Uo(ze,1),i)+ze[Tt(1,2)],a=Sr(Uo(ze,0),r)+ze[Tt(0,2)],l=Sr(Uo(ze,1),r)+ze[Tt(1,2)];n=-(n+a)/(o+l),ze[Tt(0,0)]+=ze[Tt(1,0)]*n,ze[Tt(0,1)]+=ze[Tt(1,1)]*n,ze[Tt(0,2)]+=ze[Tt(1,2)]*n,n=1/(Sr(Uo(ze,0),i)+ze[Tt(0,2)]),o=1/(Sr(Uo(ze,1),i)+ze[Tt(1,2)]),ze[Tt(0,0)]*=n,ze[Tt(0,1)]*=n,ze[Tt(0,2)]*=n,ze[Tt(1,0)]*=o,ze[Tt(1,1)]*=o,ze[Tt(1,2)]*=o,ze[Tt(2,0)]=ze[Tt(1,0)],ze[Tt(2,1)]=ze[Tt(1,1)],ze[Tt(2,2)]=ze[Tt(1,2)],ze[Tt(1,2)]+=1,n=Sr(Uo(ze,1),e)+ze[Tt(1,2)],o=Sr(Uo(ze,2),e)+ze[Tt(2,2)],a=Sr(Uo(ze,1),i)+ze[Tt(1,2)],l=Sr(Uo(ze,2),i)+ze[Tt(2,2)],n=-.5*(n/o+a/l),ze[Tt(1,0)]+=ze[Tt(2,0)]*n,ze[Tt(1,1)]+=ze[Tt(2,1)]*n,ze[Tt(1,2)]+=ze[Tt(2,2)]*n,n=Sr(Uo(ze,1),e)+ze[Tt(1,2)],o=Sr(Uo(ze,2),e)+ze[Tt(2,2)],a=-o/n,ze[Tt(1,0)]*=a,ze[Tt(1,1)]*=a,ze[Tt(1,2)]*=a,s[0]=ze[0],s[1]=ze[1],s[2]=0,s[3]=ze[2],s[4]=ze[3],s[5]=ze[4],s[6]=0,s[7]=ze[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=ze[6],s[13]=ze[7],s[14]=0,s[15]=ze[8]}var oC;let on=oC=class extends ve{constructor(t,e,i,r,s,n){super({}),this._rctx=t,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=n,this._progress=0,this._sampleCount=0,this._cachedCamera=new Zt,this._contentCamera=new Zt,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=kj,this._previewing=!1,this._handles=new dt,this._cameraForcedForScreenshot=!1,this._shadowMap=new Zfe(t,i.viewingMode),this._shadowMap.enabled=!0,this._vao=vn(t);const o={colorTarget:0,depthStencilTarget:0,width:0,height:0},a={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this._fbo=new ci(t,o,a),this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseView:be(),projInfo:Ot(),zScale:ke()},this._accumulationRenderer=new $4(e,t,this,n);const l=this._stage.resourceController.scheduler;this._handles.add(l.registerTask(Qe.SHADOW_ACCUMULATOR,this)),this._handles.add(hn(()=>i.renderView,c=>{this._handles.remove(oC.renderViewHandleKey),A(c)||this._handles.add(c.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),oC.renderViewHandleKey)},VF))}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get accumulationTechnique(){if(A(this._accumulationTechnique)){const t={rctx:this._rctx,viewingMode:this._stage.viewingMode},e=new sC;e.pass=0,this._accumulationTechnique=new rC(t,e)}return this._accumulationTechnique}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get _canAccumulate(){return this._accumulationParams.linearDepthTexture!==null&&this._depthRange!==kj&&this._opacityFromElevation>Wfe}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(t){const e=this._cachedLightDirections;if(_p(e,t,mx))return;const i=t.length;e.length=i,this._sampleCount=Math.min(A4,i);for(let r=0;r<i;++r){const s=t[r],n=e[r]||$();re(n,s),e[r]=n}this._invalidate()}get _projInfo(){return this._accumulationParams.projInfo}get _zScale(){return this._accumulationParams.zScale}get _inverseView(){return this._accumulationParams.inverseView}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(t){this._accumulationRenderer.opacityFromElevation=t}get running(){return this._isRefining&&this._canAccumulate&&this._progress>0}runTask(t){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!t.done&&!this._isDoneAccumulating;)this._accumulateShadow(),t.madeProgress();this._requestRender()}accumulateFixedSamples(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();const t=this._cameraForcedForScreenshot?this._sampleCount:Math.min(oC.previewSamples,this._sampleCount-this._progress);for(let e=0;e<t;++e)this._accumulateShadow();this._cameraForcedForScreenshot=!1}render(){this._accumulationRenderer.render()}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=Ge(this._accumulationRenderer),this._shadowMap=Ge(this._shadowMap),this._fbo=Ge(this._fbo),this._vao=Ge(this._vao),this._accumulationTechnique=Ge(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(t){t.enabled!==void 0&&this._setEnabled(t.enabled),t.previewing!==void 0&&this.setPreviewing(t.previewing),t.lightDirections!==void 0&&this.setLightDirections(t.lightDirections),this._accumulationRenderer.setOptions(t)}setPreviewing(t){this._previewing!==t&&(this._previewing=t,this._requestRenderIfEnabled())}setLightDirections(t){this._lightDirections=t}setAccumulationDependencies(t,e,i,r){this._accumulationParams.linearDepthTexture=t,this._depthRange=e,this._updateCamera(i),this._contentCamera=r,this.notifyChange("_canAccumulate")}readAccumulatedShadow(t,e){if(!this._isActive||this._progress<1||t<0||t>this._fbo.width||e<0||e>this._fbo.height)return 0;const i=ait;return this._fbo.readPixels(t,e,1,1,6408,5121,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0}_stop(){this._enabled=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(16384),this._progress=0}_accumulateShadow(){const t=this._lightDirections[this._progress],e=this._cachedCamera;this._renderToShadowMap(this._shadowMap,t,e,this._depthRange),this._rctx.bindFramebuffer(this._fbo);const i=this.accumulationTechnique;this._rctx.useProgram(i.program),i.bindPipelineState(this._rctx),i.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,xs(this._vao,"geometry")),this._progress++}_updateCamera(t){if(t.equals(this._cachedCamera))return;const{fullWidth:e,fullHeight:i,projectionMatrix:r,viewMatrix:s,center:n}=t;this._cachedCamera.copyFrom(t),this._fbo.resize(e,i),$V(r,e,i,this._projInfo,this._zScale),Vs(this._inverseView,s,n),Fi(this._inverseView,this._inverseView),this._opacityFromElevation=1-Ag(tit,iit,t.relativeElevation)}_setEnabled(t){t!==this._enabled&&(t?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}get test(){return{lightDirections:this._lightDirections,isDone:()=>this._isDoneAccumulating,isActive:()=>this._isActive}}};on.previewSamples=6,on.renderViewHandleKey="renderView",u([d()],on.prototype,"_progress",void 0),u([d()],on.prototype,"_sampleCount",void 0),u([d()],on.prototype,"_enabled",void 0),u([d()],on.prototype,"_depthRange",void 0),u([d()],on.prototype,"_previewing",void 0),u([d()],on.prototype,"_accumulationRenderer",void 0),u([d()],on.prototype,"_isRefining",null),u([d()],on.prototype,"_isActive",null),u([d()],on.prototype,"_canAccumulate",null),u([d()],on.prototype,"_isDoneAccumulating",null),u([d()],on.prototype,"_opacityFromElevation",null),u([d()],on.prototype,"running",null),on=oC=u([R("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],on);const ait=new Uint8Array(4);function lit(t){const e=new pi;return e.include(Bd),e.fragment.include(zu),e.fragment.include(Lr),e.include(Jj),e.include(KT),e.fragment.uniforms.add("defaultDepthTex","sampler2D").add("highlightDepthTex","sampler2D").add("depthMap","sampler2D").add("highlightMap","sampler2D").add("color","vec4").add("nearFar","vec2").add("opacity","float").add("occludedOpacity","float").add("terminationFactor","float").add("inverseView","mat4").add("lightingMainDirectionView","vec3").add("texelSize","vec2"),e.fragment.constants.add("unoccludedHighlightFlag","vec4",Rle).add("highlightedThreshold","float",t.highlightedThreshold).add("selfShadowThreshold","float",t.selfShadowThreshold),e.fragment.code.add(x`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),e.fragment.code.add(x`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseView * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= uShadowMapNum) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float differenceOpacity = opacity;
float bothOpacity = occludedOpacity;
float fragOpacity = (shadowDefault || shaded) ? bothOpacity : differenceOpacity;
gl_FragColor = vec4(color.rgb, color.a * fragOpacity * terminationFactor);
}`),e}const cit=Object.freeze({__proto__:null,build:lit}),ame=0,lme=1;class O4 extends Si{initializeProgram(e){const i=O4.shader.get().build({highlightedThreshold:.99999,selfShadowThreshold:.025});return new fi(e.rctx,i,Ht)}initializePipeline(e){return _t({blending:Xs(770,1,771,771),colorWrite:Pt,depthTest:null,depthWrite:null})}bindPass(e,i){if(A(i.linearDepthTexture))return;this.program.bindTexture(i.linearDepthTexture,"depthMap"),this.program.bindTexture(i.highlightColorTexture,"highlightMap"),Oe(R4,i.lighting.lightingMainDirection,i.camera.viewInverseTransposeMatrix),_e(R4,R4),$V(i.camera.projectionMatrix,i.camera.fullWidth,i.camera.fullHeight,ume,cme),Vs(I4,i.camera.viewMatrix,i.camera.center),Fi(I4,I4),this.program.setUniform4fv("color",e.shadowColor),this.program.setUniform1f("opacity",e.shadowOpacity),this.program.setUniform1f("occludedOpacity",e.occludedShadowOpacity),this.program.setUniform1f("terminationFactor",e.opacityElevation*e.dayNightTerminator),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",I4),this.program.setUniform4fv("projInfo",ume),this.program.setUniform2fv("zScale",cme),this.program.setUniform3fv("lightingMainDirectionView",R4),this.program.setUniform2f("texelSize",1/i.linearDepthTexture.descriptor.width,1/i.linearDepthTexture.descriptor.height),i.shadowMap.bind(this.program),i.shadowMap.bindView(this.program,i.camera.center);let r=i.shadowMap.getSnapshot(ame);_(r)&&this.program.bindTexture(r,"highlightDepthTex"),r=i.shadowMap.getSnapshot(lme),_(r)&&this.program.bindTexture(r,"defaultDepthTex")}get primitiveType(){return 5}}O4.shader=new vi(cit,()=>import("./ShadowHighlight.glsl.79d95eb5.js"));const R4=$(),cme=ke(),ume=Ot(),I4=be(),uit=.001953125,hit=4e4,dit=5e4;class pit{constructor(e,i){this._rctx=e,this._viewingMode=i,this._maxOpacity=1,this._parameters={shadowColor:io(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1,opacityElevation:1,dayNightTerminator:1},this._vao=vn(this._rctx)}get technique(){return A(this._technique)&&(this._technique=new O4({rctx:this._rctx,viewingMode:this._viewingMode},null)),this._technique}render(e,i){if(this._updateParameters(e),!e.shadowMap.enabled||!e.linearDepthTexture||!this.isVisible)return;const r=this.technique;this._rctx.bindFramebuffer(i),this._rctx.useProgram(r.program),r.bindPipelineState(this._rctx),r.bindPass(this._parameters,e),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(r.primitiveType,0,xs(this._vao,"geometry"))}get gpuMemoryUsage(){var e,i;return(e=(i=this._vao)==null?void 0:i.size)!=null?e:0}setDefaultOptions(e){this._parameters=E(E({},this._parameters),e),this._updateMaxOpacity()}_updateParameters(e){this._parameters.opacityElevation=1-Ag(hit,dit,e.camera.relativeElevation);const i=this._viewingMode===1?_e(hme,e.camera.center):ne(hme,0,0,1),r=ye(i,e.lighting.lightingMainDirection);this._parameters.dayNightTerminator=Ag(0,1,Re(30*r,0,1))}dispose(){this._vao=Ge(this._vao),this._technique=Ge(this._technique)}get isVisible(){return this._maxOpacity*this._parameters.opacityElevation*this._parameters.dayNightTerminator>=uit}_updateMaxOpacity(){const e=this._parameters,i=e.shadowColor,r=Math.max(e.shadowOpacity,e.occludedShadowOpacity);this._maxOpacity=r*i[3]}}const hme=$(),Kj=_y();class fit{constructor(){this._worldPlane=Kj}get isEnabled(){return this.plane!==Kj}get plane(){return this._worldPlane}set plane(e){this._worldPlane=e||Kj}}function mit(t){const e=new pi;return t.output===0&&(e.attributes.add("position","vec2"),e.vertex.uniforms.add("uResolution","vec4"),e.varyings.add("fTexCoord","vec2"),e.varyings.add("fOffset[3]","vec4"),e.vertex.code.add(x`void SMAAEdgeDetectionVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
fOffset[2] = texcoord.xyxy + uResolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAAEdgeDetectionVS( fTexCoord );
}`),e.fragment.uniforms.add("tColor","sampler2D"),e.fragment.code.add(x`
      vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {
        vec2 threshold = vec2( ${x.float(t.threshold)} );

        // Calculate color deltas:
        vec4 delta;
        vec3 C = texture2D( colorTex, texcoord ).rgb;

        vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;
        vec3 t = abs( C - Cleft );
        delta.x = max( max( t.r, t.g ), t.b );

        vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;
        t = abs( C - Ctop );
        delta.y = max( max( t.r, t.g ), t.b );

        // We do the usual threshold:
        vec2 edges = step( threshold, delta.xy );

        // Then discard if there is no edge:
        if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )
            discard;

        // Calculate right and bottom deltas:
        vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;
        t = abs( C - Cright );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;
        t = abs( C - Cbottom );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the maximum delta in the direct neighborhood:
        float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );

        // Calculate left-left and top-top deltas:
        vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;
        t = abs( C - Cleftleft );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;
        t = abs( C - Ctoptop );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the final maximum delta:
        maxDelta = max( max( maxDelta, delta.z ), delta.w );

        // Local contrast adaptation in action:
        edges.xy *= step( maxDelta, float(${x.float(t.localConstrastAdaption)}) * delta.xy );

        return vec4( edges, 0.0, 0.0 );
      }

      void main() {
        gl_FragColor = SMAAColorEdgeDetectionPS( fTexCoord, fOffset, tColor );
      }
    `)),t.output===1&&(e.attributes.add("position","vec2"),e.vertex.uniforms.add("uResolution","vec4"),e.varyings.add("fTexCoord","vec2"),e.varyings.add("fOffset[3]","vec4"),e.varyings.add("fPixCoord","vec2"),e.vertex.code.add(x`
      void SMAABlendingWeightCalculationVS( vec2 texcoord ) {
        fPixCoord = texcoord * uResolution.zw;
        fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        fOffset[2] = vec4( fOffset[0].xz, fOffset[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * uResolution.xxyy * float( ${x.int(t.maxSearchSteps)} );
      }

      void main() {
        fTexCoord = (position + 1.0 ) * 0.5;
        gl_Position = vec4(position, 0, 1);
        SMAABlendingWeightCalculationVS( fTexCoord );
      }
    `),e.fragment.uniforms.add("tEdges","sampler2D").add("tArea","sampler2D").add("tSearch","sampler2D").add("tColor","sampler2D").add("uResolution","vec4"),e.fragment.code.add(x`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 SMAASampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset) {
        return texture2D( tex, coord + offset.x * uResolution.xy, 0.0 );
      }

      vec2 round( vec2 x ) {
        return sign( x ) * floor( abs( x ) + 0.5 );
      }

      float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${x.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * uResolution.x;
        texcoord.x += uResolution.x;
        texcoord.x += 2.0 * uResolution.x;
        texcoord.x -= uResolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${x.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * uResolution.x;
        texcoord.x -= uResolution.x;
        texcoord.x -= 2.0 * uResolution.x;
        texcoord.x += uResolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${x.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * uResolution.y;
        texcoord.y -= uResolution.y;
        texcoord.y -= 2.0 * uResolution.y;
        texcoord.y += uResolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${x.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * uResolution.y;
        texcoord.y += uResolution.y;
        texcoord.y += 2.0 * uResolution.y;
        texcoord.y -= uResolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${x.int(t.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {
        vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );
        vec2 e = texture2D( edgesTex, texcoord ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );
          coords.y = offset[ 1 ].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTex, coords, 0.0 ).r;
          coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );
          d.y = coords.x;
          d = d * uResolution.z - pixcoord.x;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );
          coords.x = offset[ 0 ].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTex, coords, 0.0 ).g;
          coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );
          d.y = coords.y;
          d = d * uResolution.w - pixcoord.y;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 0.0, 1.0 ) ).g;
          weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offset[ 0 ]+offset[ 1 ]+offset[ 2 ] + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0,1,0,1),dbg);
        }
        return weights;
      }

      void main() {
        gl_FragColor = SMAABlendingWeightCalculationPS( fTexCoord, fPixCoord, fOffset, tEdges, tArea, tSearch, ivec4( 0.0 ) );
      }
    `)),t.output===2&&(e.attributes.add("position","vec2"),e.vertex.uniforms.add("uResolution","vec4"),e.varyings.add("fTexCoord","vec2"),e.varyings.add("fOffset[2]","vec4"),e.vertex.code.add(x`void SMAANeighborhoodBlendingVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAANeighborhoodBlendingVS(fTexCoord);
}`),e.fragment.uniforms.add("tBlendWeights","sampler2D"),e.fragment.uniforms.add("tColor","sampler2D"),e.fragment.uniforms.add("uResolution","vec4"),e.fragment.code.add(x`vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {
vec4 a;
a.xz = texture2D( blendTex, texcoord ).xz;
a.y = texture2D( blendTex, offset[ 1 ].zw ).g;
a.w = texture2D( blendTex, offset[ 1 ].xy ).a;
if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {
return texture2D( colorTex, texcoord, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTex, texcoord, 0.0 );
texcoord += sign( offset ) * uResolution.xy;
vec4 Cop = texture2D( colorTex, texcoord, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
vec4 mixed = mix(C, Cop, s);
return mixed;
}
}
void main() {
gl_FragColor = SMAANeighborhoodBlendingPS( fTexCoord, fOffset, tColor, tBlendWeights );
}`)),e}const git=Object.freeze({__proto__:null,build:mit});class D4 extends Si{initializeProgram(e){const i=D4.shader.get(),r=this.configuration,s=i.build({output:r.output,threshold:.05,localConstrastAdaption:2,maxSearchSteps:8,maxDistanceAreaTex:16});return new fi(e.rctx,s,Ht)}initializePipeline(){return _t({colorWrite:Pt})}}D4.shader=new vi(git,()=>import("./SMAA.glsl.96c31121.js"));class dme extends tr{constructor(){super(...arguments),this.output=0}}u([X({count:3})],dme.prototype,"output",void 0);let aC=class extends ve{constructor(t,e){super({}),this.rctx=t,this._techniqueRep=e,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=Rl(this._abortController),this.disable()}_loadResources(t){if(_(this._abortController))return!1;if(_(this._searchTexture))return!0;this._abortController=new AbortController;const e=this._abortController.signal;return import("./SmaaRenderPassData.9de12c8c.js").then(i=>this._loadTextures(i,e)).then(()=>t()).finally(()=>this._abortController=null),!1}_loadTextures(t,e){return Dt(e),Promise.all([this.loadTextureFromBase64(t.areaTexture,9729,6407),this.loadTextureFromBase64(t.searchTexure,9728,6409)]).then(([i,r])=>{Ir(e)?(i.dispose(),r.dispose(),Dt(e)):(this._areaTexture=i,this._searchTexture=r)})}get updating(){return _(this._abortController)}enable(t){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeights||!this._blur){const e=new dme,i=(r,s)=>this._techniqueRep.releaseAndAcquire(D4,r,s);e.output=0,this._edgeDetectTechnique=i(e,this._edgeDetectTechnique),e.output=1,this._blendWeights=i(e,this._blendWeights),e.output=2,this._blur=i(e,this._blur)}return!!this._loadResources(t)&&(this._vao=d6e(this.rctx),this._edges=new ci(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6407,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this._blend=new ci(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this._isEnabled=!0,!0)}disable(){this._isEnabled&&(this._vao=Ge(this._vao),this._areaTexture=Ge(this._areaTexture),this._searchTexture=Ge(this._searchTexture),this._blend=Ge(this._blend),this._edges=Ge(this._edges),this._isEnabled=!1)}render(t){if(!this._isEnabled)return;const e=this.rctx,i=e.getBoundFramebufferObject(),r={x:0,y:0,width:t.descriptor.width,height:t.descriptor.height};e.bindVAO(this._vao),this._edgeDetectTechnique.bindPipelineState(e),e.setViewport(r.x,r.y,r.width,r.height),this._edges.resize(r.width,r.height),e.bindFramebuffer(this._edges),e.setClearColor(0,0,0,1),e.clear(16384),e.useProgram(this._edgeDetectTechnique.program),this._edgeDetectTechnique.program.bindTexture(t,"tColor"),this._edgeDetectTechnique.program.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),e.drawArrays(4,0,3),this._blend.resize(r.width,r.height),e.bindFramebuffer(this._blend),e.setClearColor(0,0,1,1),e.clear(16384),e.useProgram(this._blendWeights.program),this._blendWeights.program.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),this._blendWeights.program.bindTexture(this._searchTexture,"tSearch"),this._blendWeights.program.bindTexture(this._areaTexture,"tArea"),this._blendWeights.program.bindTexture(this._edges.colorTexture,"tEdges"),e.drawArrays(4,0,3),e.bindFramebuffer(i),e.setClearColor(0,1,0,1),e.clear(16384),e.useProgram(this._blur.program),this._blur.program.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),this._blur.program.bindTexture(t,"tColor"),this._blur.program.bindTexture(this._blend.colorTexture,"tBlendWeights"),e.drawArrays(4,0,3)}loadTextureFromBase64(t,e,i){const r=new qe(this.rctx,{pixelFormat:i,dataType:5121,wrapMode:33071,samplingMode:e},null);return tl(t).then(s=>(r.resize(s.width,s.height),r.setData(s),r))}};u([d()],aC.prototype,"_abortController",void 0),u([d({readOnly:!0})],aC.prototype,"updating",null),aC=u([R("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],aC);function yit(t){const e=new pi;return e.include(KT),t.output===1&&(e.fragment.include(Lr),e.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("tex","sampler2D").add("blurSize","vec2").add("projScale","float").add("nearFar","vec2"),e.fragment.code.add(x`
      void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
        float c = texture2D(tex, uv).r;
        float d = linearDepthFromTexture(depthMap, uv, nearFar);

        float ddiff = d - center_d;

        float w = exp(-r * r * ${x.float(t.blurFalloff)} - ddiff * ddiff * sharpness);
        wTotal += w;
        bTotal += w * c;
      }
    `),e.fragment.code.add(x`
      void main(void) {
        float b = 0.0;
        float w_total = 0.0;

        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

        float sharpness = -0.05 * projScale/center_d;
        for (int r = -${x.int(t.filterRadius)}; r <= ${x.int(t.filterRadius)}; ++r) {
          float rf = float(r);
          vec2 uvOffset = uv + rf * blurSize;
          blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
        }

        gl_FragColor = vec4(b / w_total);
      }
    `)),t.output===0&&(e.fragment.include(Lr),e.include(Jj),e.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("intensity","float").add("projScale","float").add("radius","float").add("nearFar","vec2").add("screenDimensions","vec2").add("rnmScale","vec2").add("rnm","sampler2D"),e.fragment.code.add(x`vec3 sphere[16];
void fillSphere() {
sphere[0] = vec3(0.186937, 0.0, 0.0);
sphere[1] = vec3(0.700542, 0.0, 0.0);
sphere[2] = vec3(-0.864858, -0.481795, -0.111713);
sphere[3] = vec3(-0.624773, 0.102853, -0.730153);
sphere[4] = vec3(-0.387172, 0.260319, 0.007229);
sphere[5] = vec3(-0.222367, -0.642631, -0.707697);
sphere[6] = vec3(-0.01336, -0.014956, 0.169662);
sphere[7] = vec3(0.122575, 0.1544, -0.456944);
sphere[8] = vec3(-0.177141, 0.85997, -0.42346);
sphere[9] = vec3(-0.131631, 0.814545, 0.524355);
sphere[10] = vec3(-0.779469, 0.007991, 0.624833);
sphere[11] = vec3(0.308092, 0.209288,0.35969);
sphere[12] = vec3(0.359331, -0.184533, -0.377458);
sphere[13] = vec3(0.192633, -0.482999, -0.065284);
sphere[14] = vec3(0.233538, 0.293706, -0.055139);
sphere[15] = vec3(0.417709, -0.386701, 0.442449);
}
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn-bias, 0.0);
}`),e.fragment.code.add(x`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),e.fragment.code.add(x`
      void main(void) {
        fillSphere();
        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));
        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
          gl_FragColor = vec4(0.0);
          return;
        }

        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

        // get the normal of current fragment
        vec4 norm4 = texture2D(normalMap, uv);
        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
        bool isTerrain = norm4.w<0.5;

        float sum = .0;
        vec3 tapPixelPos;

        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
        // bug or deviation from CE somewhere else?
        float ps = projScale/(2.0 * currentPixelPos.z * zScale.x + zScale.y);

        for(int i = 0; i < ${x.int(t.samples)}; ++i) {
          vec2 unitOffset = reflect(sphere[i], fres).xy;
          vec2 offset = vec2(-unitOffset * radius * ps);

          //don't use current or very nearby samples
          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

          vec2 tc = vec2(gl_FragCoord.xy + offset);
          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenDimensions.x || tc.y > screenDimensions.y) continue;
          vec2 tcTap = tc/screenDimensions;
          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

          if (isTerrain) {
            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
            if (isTerrainTap) {
              continue;
            }
          }

          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
        }

        // output the result
        float A = max(1.0-sum*intensity/float(${x.int(t.samples)}),0.0);

        // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4)/2.2
        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;
        gl_FragColor = vec4(A);
      }
    `)),e}const vit=Object.freeze({__proto__:null,build:yit});class gh extends Si{initializeProgram(e){const i=gh.shader.get(),r=this.configuration,s=(gh.filterRadius+1)/2,n=1/(2*s*s),o=i.build({output:r.output,samples:gh.samples,filterRadius:gh.filterRadius,blurFalloff:n});return new fi(e.rctx,o,Ht)}initializePipeline(){return _t({colorWrite:Pt})}}gh.shader=new vi(vit,()=>import("./SSAO.glsl.08d8e333.js")),gh.samples=16,gh.filterRadius=4;class pme extends tr{constructor(){super(...arguments),this.output=0}}u([X({count:2})],pme.prototype,"output",void 0);class _it{constructor(e,i,r){this._techniqueRep=e,this._rctx=i,this._requestRender=r,this._enabled=!1,this._ssaoTechniqueConfig=new pme,this.quadVAO=null,this._blurSizePx=2,this._attenuation=.5}dispose(){this.quadVAO=Ge(this.quadVAO)}set enabled(e){e?this._enable():this._disable()}get enabled(){return this._enabled}get ready(){return this.enabled&&_(this._noiseTexture)&&_(this._ssaoFBO)&&_(this._blur0FBO)&&_(this._blur1FBO)}computeSSAO(e,i,r){if(!this.enabled||A(i)||A(r)||A(this._noiseTexture)||A(this._ssaoFBO)||A(this._blur0FBO)||A(this._blur1FBO))return;const s=this._rctx,n=e.fullViewport,o=n[2],a=n[3],l=o/this._blurSizePx,c=a/this._blurSizePx;this._ssaoFBO.resize(o,a),this._blur0FBO.resize(l,c),this._blur1FBO.resize(l,c);const h=1,p=1,f=o*h,g=a*p;s.bindFramebuffer(this._ssaoFBO),s.setViewport(0,0,o,a);const y=this._ssaoTechnique.program;s.useProgram(y),this._ssaoTechnique.bindPipelineState(s),y.setUniform2f("rnmScale",o/this._noiseTexture.descriptor.width,a/this._noiseTexture.descriptor.height),$V(e.projectionMatrix,e.fullWidth,e.fullHeight,mme,fme),y.setUniform4fv("projInfo",mme),y.setUniform2fv("zScale",fme),y.setUniform2f("nearFar",e.near,e.far);let v=1/e.computeRenderPixelSizeAtDist(1);y.setUniform1f("projScale",v*h),y.setUniform2f("screenDimensions",f,g);const b=qt(e.eye,e.center);let w=20*e.computeRenderPixelSizeAtDist(b);w=Math.max(.1,w),y.setUniform1f("radius",w),y.setUniform1f("intensity",4*this._attenuation/w**6),y.bindTexture(this._noiseTexture,"rnm"),y.bindTexture(r,"normalMap"),y.bindTexture(i,"depthMap"),A(this.quadVAO)&&(this.quadVAO=vn(this._rctx)),s.bindVAO(this.quadVAO),s.drawArrays(5,0,xs(this.quadVAO,"geometry"));const S=this._blurTechnique.program;s.useProgram(S),S.bindTexture(this._ssaoFBO.colorTexture,"tex"),S.bindTexture(r,"normalMap"),S.bindTexture(i,"depthMap"),s.setViewport(0,0,f/this._blurSizePx,g/this._blurSizePx),s.bindFramebuffer(this._blur0FBO),S.setUniform2f("screenDimensions",f,g),S.setUniform2f("blurSize",0,this._blurSizePx*h/g),S.setUniform2f("nearFar",e.near,e.far),b>5e4&&(v=Math.max(0,v-(b-5e4))),S.setUniform1f("projScale",v),s.drawArrays(5,0,xs(this.quadVAO,"geometry")),S.setUniform2f("blurSize",this._blurSizePx*p/f,0),s.bindFramebuffer(this._blur1FBO),S.bindTexture(this._blur0FBO.colorTexture,"tex"),s.drawArrays(5,0,xs(this.quadVAO,"geometry")),s.setViewport(n[0],n[1],n[2],n[3])}bind(e,i){this.enabled&&_(this._blur1FBO)&&_(this._ssaoFBO)?(e.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),e.setUniform4f("viewportPixelSz",i.fullViewport[0],i.fullViewport[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}_selectPrograms(){this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(gh,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.releaseAndAcquire(gh,this._ssaoTechniqueConfig,this._blurTechnique)}_enable(){this.enabled||(this._enabled=!0,this._loadResources(()=>{this._enabled&&this._initialize()}))}_loadResources(e){this._data?e():import("./SSAOHelperData.8a544e94.js").then(i=>{this._data=i,e()})}_initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},i={colorTarget:0,depthStencilTarget:0};tl(this._data.noiseTexture).then(r=>{this._enabled&&(this._ssaoFBO=new ci(this._rctx,i,e),this._blur0FBO=new ci(this._rctx,i,e),this._blur1FBO=new ci(this._rctx,i,e),this._noiseTexture=new qe(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:r.width,height:r.height},r),this._requestRender())}),this._selectPrograms()}_disable(){this._enabled=!1,this._noiseTexture=Ge(this._noiseTexture),this._blur1FBO=Ge(this._blur1FBO),this._blur0FBO=Ge(this._blur0FBO),this._ssaoFBO=Ge(this._ssaoFBO)}get gpuMemoryUsage(){return(_(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(_(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(_(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const fme=ke(),mme=Ot();function bit(t,e){const i=e,r=-t[0],s=-t[1],n=-t[2],o=i[3],a=i[7],l=i[11],c=i[15];i[0]+=o*r,i[1]+=o*s,i[2]+=o*n,i[4]+=a*r,i[5]+=a*s,i[6]+=a*n,i[8]+=l*r,i[9]+=l*s,i[10]+=l*n,i[12]+=c*r,i[13]+=c*s,i[14]+=c*n}function wit(t,e){const i=e,r=t[0],s=t[1],n=t[2];i[12]+=r*i[0]+s*i[4]+n*i[8],i[13]+=r*i[1]+s*i[5]+n*i[9],i[14]+=r*i[2]+s*i[6]+n*i[10],i[14]+=r*i[3]+s*i[7]+n*i[11]}class xit{constructor(e){this.factory=e,this.originData=new Map}acquire(e){return this.register(this.factory.getOrigin(e))}register(e){const i=this.originData.get(e.id);return i?(i.refCount++,i.origin):(this.originData.set(e.id,{refCount:1,viewMatrix:be(),origin:e}),e)}release(e){const i=this.originData.get(e.id);i&&(i.refCount--,i.refCount===0&&this.originData.delete(e.id))}updateViewMatrices(e){this.originData.forEach(i=>{ji(i.viewMatrix,e),wit(i.origin.vec3,i.viewMatrix)})}getViewMatrix(e){return this.originData.get(e.id).viewMatrix}}const F4=zr().vec3f("position").u16("componentIndex").u16("u16padding"),gme=zr().vec2u8("sideness"),yme=il(gme),vme=zr().vec3f("position0").vec3f("position1").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).u8("u8padding",{glPadding:!0}).u16("u16padding",{glPadding:!0}),eB=vme.clone().vec3f("normal"),tB=vme.clone().vec3f("normalA").vec3f("normalB"),iB=new Map([["position0",0],["position1",1],["componentIndex",2],["variantOffset",3],["variantStroke",4],["variantExtension",5],["normal",6],["normalA",6],["normalB",7],["sideness",8]]);class _me{updateSettings(e){this.settings=e,this.edgeHashFunction=e.reducedPrecision?Tit:Sit}write(e,i,r){const s=this.edgeHashFunction(r);N4.seed=s;const n=N4.getIntRange(0,255),o=N4.getIntRange(0,this.settings.variants-1),a=.7,l=N4.getFloat(),c=255*(.5*Cit(-(1-Math.min(l/a,1))+Math.max(0,l-a)/(1-a),1.2)+.5);e.position0.setVec(i,r.position0),e.position1.setVec(i,r.position1),e.componentIndex.set(i,r.componentIndex),e.variantOffset.set(i,n),e.variantStroke.set(i,o),e.variantExtension.set(i,c)}trim(e,i){return e.slice(0,i)}}const rB=new Float32Array(6),L4=new Uint32Array(rB.buffer),tg=new Uint32Array(1);function Sit(t){const e=rB;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],tg[0]=5381;for(let i=0;i<L4.length;i++)tg[0]=31*tg[0]+L4[i];return tg[0]}function Tit(t){const e=rB;e[0]=Aw(t.position0[0]),e[1]=Aw(t.position0[1]),e[2]=Aw(t.position0[2]),e[3]=Aw(t.position1[0]),e[4]=Aw(t.position1[1]),e[5]=Aw(t.position1[2]),tg[0]=5381;for(let i=0;i<L4.length;i++)tg[0]=31*tg[0]+L4[i];return tg[0]}const bme=1e4;function Aw(t){return Math.round(t*bme)/bme}function Cit(t,e){const i=t<0?-1:1;return Math.abs(t)**e*i}class k4{constructor(){this.commonWriter=new _me}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return eB.createBuffer(e)}write(e,i,r){this.commonWriter.write(e,i,r),de(V4,r.faceNormal0,r.faceNormal1),_e(V4,V4),e.normal.setVec(i,V4)}trim(e,i){return this.commonWriter.trim(e,i)}}k4.Layout=eB,k4.glLayout=il(eB,1);class z4{constructor(){this.commonWriter=new _me}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return tB.createBuffer(e)}write(e,i,r){this.commonWriter.write(e,i,r),e.normalA.setVec(i,r.faceNormal0),e.normalB.setVec(i,r.faceNormal1)}trim(e,i){return this.commonWriter.trim(e,i)}}z4.Layout=tB,z4.glLayout=il(tB,1);const V4=$(),N4=new $a;function Mit(t){const e=x`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;t.code.add(e)}function Pit(t,e){t.vertex.include(Mit),t.include(eo,e);const i=t.vertex;i.uniforms.add("uDepthBias","vec2"),i.uniforms.add("uViewportDimInv","vec2"),e.legacy?(i.uniforms.add("uView","mat4"),i.uniforms.add("uProj","mat4")):i.uniforms.add("uTransformNormal_ViewFromGlobal","mat3"),e.legacy?i.code.add(x`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uProj * uView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`):i.code.add(x`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uTransform_ProjFromView * vec4(uTransformNormal_ViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`),i.code.add(x`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = uDepthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function Ait(t,e){const i=t.fragment;i.constants.add("coverageTestThreshold","float",.01),e.antialiasing?i.code.add(x`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):i.code.add(x`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function $it(t,e){const i=t.vertex;e.silhouette?(i.code.add(x`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),e.legacy?i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function Eit(t,e){const i=t.vertex;switch(e.mode){case 1:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 2:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 0:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) {}`)}}function $w(t,e){const i=t.vertex;i.uniforms.add("uDistanceFalloffFactor","float"),i.code.add(x`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(uDistanceFalloffFactor / distance), 0.0, 1.0);
}`),i.uniforms.add("uComponentDataTex","sampler2D"),i.uniforms.add("uComponentDataTexInvDim","vec2"),t.attributes.add("componentIndex","float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentFieldCount","float",2),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("componentTexWidth","float",4096),i.code.add(x`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float rowIndex = floor(fieldIndex / componentTexWidth);
float colIndex = mod(fieldIndex, componentTexWidth);
vec2 linearIndex = vec2(
(colIndex + 0.5) / componentTexWidth,
(rowIndex + 0.5) * uComponentDataTexInvDim.y
);
return linearIndex;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec4 colorValue = texture2D(uComponentDataTex, colorIndex);
vec4 otherValue = texture2D(uComponentDataTex, otherIndex);
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5
);
}`),e.legacy?i.code.add(x`vec3 _modelToWorldNormal(vec3 normal) {
return (uModel * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (uView * uModel * vec4(normal, 0.0)).xyz;
}`):(i.uniforms.add("uTransformNormal_GlobalFromModel ","mat3"),i.code.add(x`vec3 _modelToWorldNormal(vec3 normal) {
return uTransformNormal_GlobalFromModel * normal;
}`)),e.silhouette?(t.attributes.add("normalA","vec3"),t.attributes.add("normalB","vec3"),i.code.add(x`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(t.attributes.add("normal","vec3"),i.code.add(x`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),e.legacy?i.code.add(x`vec3 worldFromModelPosition(vec3 position) {
return (uModel * vec4(position, 1.0)).xyz;
}
vec3 viewFromModelPosition(vec3 position) {
return (uView * vec4(worldFromModelPosition(position), 1.0)).xyz;
}
vec4 projFromViewPosition(vec3 position) {
return uProj * vec4(position, 1.0);
}`):(t.vertex.include(q7,e),i.code.add(x`vec3 worldFromModelPosition(vec3 position) {
vec3 rotatedModelPosition = uTransform_WorldFromModel_RS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
uTransform_WorldFromModel_TL,
uTransform_WorldFromModel_TH,
-uTransform_WorldFromView_TL,
-uTransform_WorldFromView_TH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 viewFromModelPosition(vec3 position) {
return uTransform_ViewFromCameraRelative_RS * worldFromModelPosition(position);
}
vec4 projFromViewPosition(vec3 position) {
return uTransform_ProjFromView * vec4(position, 1.0);
}`)),i.code.add(x`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}(function(t){function e(r){return r.mode===1||r.mode===2}function i(r){return r.mode===0||r.mode===2}t.usesSketchLogic=e,t.usesSolidLogic=i})($w||($w={}));function sB(t,e){const i=t.vertex;switch(t.include($w,e),t.attributes.add("sideness","vec2"),e.mode===2?i.code.add(x`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):i.code.add(x`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),e.mode){case 2:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case 1:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case 0:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`)}}function Oit(t,e){const i=t.vertex;switch(t.include(sB,e),$w.usesSketchLogic(e)&&i.uniforms.add("uStrokesAmplitude","float"),e.mode){case 0:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case 1:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return uStrokesAmplitude;
}`);break;case 2:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return uStrokesAmplitude;
}
else {
return 0.0;
}
}`)}}function Rit(t,e){const i=t.vertex;t.include(sB,e);const r=t.fragment;switch($w.usesSketchLogic(e)&&(i.uniforms.add("uStrokesTextureScale","vec2"),i.uniforms.add("uStrokesLog2Resolution","float"),i.uniforms.add("uStrokeVariants","float"),t.varyings.add("vStrokeUV","vec2"),r.uniforms.add("uStrokesTexture","sampler2D"),r.uniforms.add("uStrokesNormalizationScale","float"),i.code.add(x`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, uStrokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * uStrokeVariants + variantStroke + 0.5) * uStrokesTextureScale;
vStrokeUV.x += variantOffset;
}`),t.fragment.include(zu),r.code.add(x`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(uStrokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * uStrokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(uStrokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),e.mode){case 0:i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),r.code.add(x`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case 1:i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),r.code.add(x`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case 2:t.varyings.add("vType","float"),i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),r.code.add(x`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}function Iit(t){const e=new pi,i=e.vertex,r=e.fragment;return t.legacy&&i.uniforms.add("uModel","mat4"),t.antialiasing&&(i.code.add(x`#define ANTIALIASING 1`),r.code.add(x`#define ANTIALIASING 1`)),e.include(Pit,t),e.include(Oit,t),e.include($w,t),e.include(sB,t),e.include(Rit,t),e.include(Zi,t),e.include($it,t),e.include(Ait,t),e.include(Eit,t),e.varyings.add("vColor","vec4"),e.varyings.add("vRadius","float"),e.varyings.add("vPosition","vec3"),e.varyings.add("vWorldPosition","vec3"),e.varyings.add("vViewPos","vec3"),e.varyings.add("vLineLengthPixels","float"),e.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add("uPixelToNDC","vec2"),i.uniforms.add("uNDCToPixel","vec2"),i.uniforms.add("uPixelRatio","float"),e.attributes.add("position0","vec3"),e.attributes.add("position1","vec3"),e.attributes.add("variantOffset","float"),e.attributes.add("variantStroke","float"),e.attributes.add("variantExtension","float"),i.code.add(x`const float opaqueCutoff = 1.0 / 255.0;
void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
vec2 sideness = unpackedAttributes.sideness;
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;
vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
vViewPos = viewPos;
vec4 projPosV0 = projFromViewPosition(viewPosV0);
vec4 projPosV1 = projFromViewPosition(viewPosV1);
vec4 projPos = projFromViewPosition(viewPos);
vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * uNDCToPixel;
float lineLengthPixels = length(screenSpaceLinePixels);
float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;
float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * uPixelRatio;
float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;
float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * uPixelRatio;
vSizeFalloffFactor = falloffFactor;
float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;
#ifdef ANTIALIASING
const float aaPaddingPixels = 1.0;
float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
#else
float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
#endif
vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * uPixelToNDC;
vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * uPixelToNDC;
vec2 extensionLengthNDC = extensionLengthPixels * uPixelToNDC;
vec2 ndcOffset = (
screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
+ perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
);
projPos.xy += ndcOffset * projPos.w;
projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;
projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));
float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;
float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;
vPosition = vec3(
halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
pixelPositionAlongLine,
pixelPositionAlongLine / extendedLineLengthPixels
);
vRadius = lineWidthPixels * 0.5;
vLineLengthPixels = extendedLineLengthPixels;
discardShortEdges(unpackedAttributes, lineLengthPixels);
gl_Position = projPos;
}
void main() {
ComponentData component = readComponentData();
UnpackedAttributes unpackedAttributes = unpackAttributes(component);
vec3 worldPosV0 = worldFromModelPosition(position0);
vec3 worldPosV1 = worldFromModelPosition(position1);
vec3 viewPosV0 = viewFromModelPosition(position0);
vec3 viewPosV1 = viewFromModelPosition(position1);
vColor = component.color;
if (vColor.a < opaqueCutoff) {
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return;
}
if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
return;
}
calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);
calculateStyleOutputs(unpackedAttributes);
}`),t.multipassTerrainEnabled&&(e.fragment.include(Lr),e.include(ll,t)),e.fragment.code.add(x`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),e}const Dit=Object.freeze({__proto__:null,build:Iit}),Fit=-4e-4,Lit=.5;class ig extends Si{bindPass(e){const i=this.program,{edgeRenderParameters:r,bindParameters:s}=e;eo.bindViewProjTransform(i,r.viewProjectionTransform),i.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",r.transformNormal_ViewFromGlobal),i.setUniformMatrix4fv("uProj",s.camera.projectionMatrix),i.setUniform2f("uDepthBias",Lit,Fit),i.setUniform2f("uPixelToNDC",2/s.camera.fullViewport[2],2/s.camera.fullViewport[3]),i.setUniform2f("uNDCToPixel",s.camera.fullViewport[2]/2,s.camera.fullViewport[3]/2),i.setUniform1f("uDistanceFalloffFactor",r.distanceFalloffFactor),i.setUniform2f("uViewportDimInv",1/s.camera.fullViewport[2],1/s.camera.fullViewport[3]),i.setUniform1f("uPixelRatio",s.camera.pixelRatio||1)}initializeProgram(e){const i=ig.shader.get(),r=this.configuration,s=i.build({slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,silhouette:r.silhouette,legacy:r.legacy,antialiasing:r.antialiasing,mode:r.mode,doublePrecisionRequiresObfuscation:r.doublePrecisionRequiresObfuscation,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new fi(e.rctx,s,iB)}initializePipeline(e){const i=e.rctx.capabilities.blendMinMax;return _t(i?{blending:Xs(1,1,0,1,32774,i.MAX),depthTest:{func:515},colorWrite:Pt}:{depthTest:{func:515},depthWrite:$o,colorWrite:Pt})}}ig.shader=new vi(Dit,()=>import("./EdgeShaderProgram.glsl.2913d109.js")),function(t){class e extends tr{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.mode=0,this.doublePrecisionRequiresObfuscation=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([X()],e.prototype,"slicePlaneEnabled",void 0),u([X()],e.prototype,"silhouette",void 0),u([X()],e.prototype,"legacy",void 0),u([X()],e.prototype,"antialiasing",void 0),u([X({count:3})],e.prototype,"mode",void 0),u([X()],e.prototype,"doublePrecisionRequiresObfuscation",void 0),u([X()],e.prototype,"multipassTerrainEnabled",void 0),u([X()],e.prototype,"cullAboveGround",void 0),t.Configuration=e}(ig||(ig={}));const kit=8,nB=128,zit={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class Vit{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const Nit={solid:0,sketch:1,uber:2};class lC{constructor(e,i,r){this.rctx=e,this.shaderTechniqueRepository=i,this.config=new ig.Configuration,this.technique=null,this.refCount=new Vit,this.renderables=new Set,this.sortedRenderables={1:{1:new ct,2:new ct},2:{1:new ct,2:new ct}},this.renderablesDirty=!1,this.settings=E(E({},zit),r),this.key=lC.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const s=this.settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:Kt.TESTS_DISABLE_OPTIMIZATIONS},this.config.legacy=this.settings.legacy,this.config.mode=Nit[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=MR(e)}dispose(){this.technique=nr(this.technique)}addRenderable(e){this.renderables.add(e),this.renderablesDirty=!0}removeRenderable(e){this.renderables.delete(e),this.renderablesDirty=!0}setRenderablesDirty(){this.renderablesDirty=!0}forEachRenderable(e,i){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[i][1].forAll(e),this.sortedRenderables[i][2].forAll(e)}setMultipassParameters(e){this.config.multipassTerrainEnabled=!!e.multipassTerrainEnabled&&e.multipassTerrainEnabled,this.config.cullAboveGround=!!e.cullAboveGround&&e.cullAboveGround}bindRegularEdges(e,i){this.setMultipassParameters(e),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(ig,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:i}),this.technique.bindPipelineState(this.rctx,e.slot),this.rctx.useProgram(this.technique.program)}bindSilhouetteEdges(e,i){this.setMultipassParameters(e),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(ig,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:i}),this.technique.bindPipelineState(this.rctx,e.slot),this.rctx.useProgram(this.technique.program)}renderRegularEdges(e,i,r){this.render(e,e.regular.vao,i,r)}renderSilhouetteEdges(e,i,r){this.render(e,e.silhouette.vao,i,r)}render(e,i,r,s){this.setUniforms(e,r),this.rctx.bindVAO(i),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,s)}setUniforms(e,i){const r=this.technique.program;if(e.components.buffer.textureBuffer.bind(r,Uit,jit),i.multipassTerrainEnabled&&(r.setUniform2fv("cameraNearFar",i.camera.nearFar),r.setUniform2fv("inverseViewport",i.inverseViewport),wm(r,i)),"origin"in e.transform)r.setUniformMatrix4fv("uView",i.localViewMatrixForEdges),r.setUniformMatrix4fv("uModel",e.transform.modelMatrix),Ab(r,this.settings,i.slicePlane,e.transform.origin.vec3);else{const s=new S4(e.transform.position),n=el(wme,p0(wme,e.transform.rotationScale)),o=new kfe;re(o.worldFromModel_TL,s.low),re(o.worldFromModel_TH,s.high),ZS(o.worldFromModel_RS,e.transform.rotationScale),ZS(o.transformNormal_GlobalFromModel,n),eo.bindModelTransform(r,o),r.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",o.transformNormal_GlobalFromModel);const a=i.camera.viewInverseTransposeMatrix,l=ne(Bit,a[3],a[7],a[11]);Ab(r,this.settings,i.slicePlane,l)}this.settings.type!=="uber"&&this.settings.type!=="sketch"||this.setSketchUniforms(r),r.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[3]/2))}setSketchUniforms(e){const i=this.settings.strokesTexture,r=i.texture;A(r)||(e.bindTexture(r,"uStrokesTexture"),e.setUniform2f("uStrokesTextureScale",1/r.descriptor.width,1/r.descriptor.height),e.setUniform1f("uStrokesLog2Resolution",Math.log2(i.resolution)),e.setUniform1f("uStrokesNormalizationScale",i.normalizationScale),e.setUniform1f("uStrokesAmplitude",i.amplitude),e.setUniform1f("uStrokeVariants",i.variants))}sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach(i=>{i.objectTransparency!==0&&i.edgeTransparency!==0&&this.sortedRenderables[i.objectTransparency][i.edgeTransparency].push(i)});const e=(i,r)=>"origin"in i.transform&&"origin"in r.transform?i.transform.origin.id<r.transform.origin.id?-1:i.transform.origin.id>r.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(e),this.sortedRenderables[1][2].sort(e),this.sortedRenderables[2][1].sort(e),this.sortedRenderables[2][2].sort(e)}static getKey(e,i,r){return`edges-t:${e}:${i}:${r}`}}const Uit="uComponentDataTex",jit="uComponentDataTexInvDim",wme=rp(),Bit=$();function xme(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:Git(t.layout)}}function Sme(t){return qit(t.layout).createView(t.buffer)}function Git(t){const e=new Array;return t.fields.forEach((i,r)=>{const s=he(E({},i),{constructor:Tme(i.constructor)});e.push([r,s])}),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}function qit(t){const e=zr();return e.stride=t.stride,e.fieldNames=t.fieldNames,t.fields.forEach(i=>e.fields.set(i[0],he(E({},i[1]),{constructor:Wit(i[1].constructor)}))),e}const Hit=[KS,rl,Wt,Zr,Mc,eb,tb,ib,ir,m0,Hf,Wf,Td,g0,Zf,Hn,y0,rb,v0,Jf,_0,sb,eT,tT,nb,b0,iT,rT,sT,w0,nT,oT,aT,lT,cT,uT];function Tme(t){return`${t.ElementType}_${t.ElementCount}`}function Wit(t){return Cme.get(t)}const Cme=new Map;Hit.forEach(t=>Cme.set(Tme(t),t));function Mme(t,e,i){const r=e/3,s=new Uint32Array(i+1),n=new Uint32Array(i+1),o=(w,S)=>{w<S?s[w+1]++:n[S+1]++};for(let w=0;w<r;w++){const S=t[3*w],T=t[3*w+1],C=t[3*w+2];o(S,T),o(T,C),o(C,S)}let a=0,l=0;for(let w=0;w<i;w++){const S=s[w+1],T=n[w+1];s[w+1]=a,n[w+1]=l,a+=S,l+=T}const c=new Uint32Array(6*r),h=s[i],p=(w,S,T)=>{if(w<S){const C=s[w+1]++;c[2*C]=S,c[2*C+1]=T}else{const C=n[S+1]++;c[2*h+2*C]=w,c[2*h+2*C+1]=T}};for(let w=0;w<r;w++){const S=t[3*w],T=t[3*w+1],C=t[3*w+2];p(S,T,w),p(T,C,w),p(C,S,w)}const f=(w,S)=>{const T=2*w,C=S-w;for(let M=1;M<C;M++){const P=c[T+2*M],F=c[T+2*M+1];let z=M-1;for(;z>=0&&c[T+2*z]>P;z--)c[T+2*z+2]=c[T+2*z],c[T+2*z+3]=c[T+2*z+1];c[T+2*z+2]=P,c[T+2*z+3]=F}};for(let w=0;w<i;w++)f(s[w],s[w+1]),f(h+n[w],h+n[w+1]);const g=new Int32Array(3*r),y=(w,S)=>w===t[3*S]?0:w===t[3*S+1]?1:w===t[3*S+2]?2:-1,v=(w,S)=>{const T=y(w,S);g[3*S+T]=-1},b=(w,S,T,C)=>{const M=y(w,S);g[3*S+M]=C;const P=y(T,C);g[3*C+P]=S};for(let w=0;w<i;w++){let S=s[w];const T=s[w+1];let C=n[w];const M=n[w+1];for(;S<T&&C<M;){const P=c[2*S],F=c[2*h+2*C];P===F?(b(w,c[2*S+1],F,c[2*h+2*C+1]),S++,C++):P<F?(v(w,c[2*S+1]),S++):(v(F,c[2*h+2*C+1]),C++)}for(;S<T;)v(w,c[2*S+1]),S++;for(;C<M;)v(c[2*h+2*C],c[2*h+2*C+1]),C++}return g}const Iv=-1;function Zit(t,e,i,r=ert){const s=t.vertices.position,n=t.vertices.componentIndex,o=nt(r.anglePlanar),a=nt(r.angleSignificantEdge),l=Math.cos(a),c=Math.cos(o),h=oB.edge,p=h.position0,f=h.position1,g=h.faceNormal0,y=h.faceNormal1,v=Kit(t),b=Xit(t),w=b.length/4,S=e.allocate(w);let T=0;const C=w,M=i.allocate(C);let P=0,F=0,z=0;const D=Pye(0,w),U=new Float32Array(w);Rye(U,(q,J,O)=>{s.getVec(b[4*J+0],p),s.getVec(b[4*J+1],f),O[J]=qt(p,f)}),D.sort((q,J)=>U[J]-U[q]);const G=new Array,k=new Array;for(let q=0;q<w;q++){const J=D[q],O=U[J],L=b[4*J+0],N=b[4*J+1],B=b[4*J+2],W=b[4*J+3],Y=W===Iv;if(s.getVec(L,p),s.getVec(N,f),Y)ne(g,v[3*B+0],v[3*B+1],v[3*B+2]),re(y,g),h.componentIndex=n.get(L),h.cosAngle=ye(g,y);else{if(ne(g,v[3*B+0],v[3*B+1],v[3*B+2]),ne(y,v[3*W+0],v[3*W+1],v[3*W+2]),h.componentIndex=n.get(L),h.cosAngle=ye(g,y),Qit(h,c))continue;h.cosAngle<-.9999&&re(y,g)}F+=O,z++,Y||Jit(h,l)?(e.write(S,T++,h),G.push(O)):Yit(h,o)&&(i.write(M,P++,h),k.push(O))}const j=new Float32Array(G.reverse()),V=new Float32Array(k.reverse());return{regular:{instancesData:e.trim(S,T),lodInfo:{lengths:j}},silhouette:{instancesData:i.trim(M,P),lodInfo:{lengths:V}},averageEdgeLength:F/z}}function Jit(t,e){return t.cosAngle<e}function Qit(t,e){return t.cosAngle>e}function Yit(t,e){const i=ar(t.cosAngle),r=oB.fwd,s=oB.ortho;return Lh(r,t.position1,t.position0),i*(ye(Ye(s,t.faceNormal0,t.faceNormal1),r)>0?-1:1)>e}function Xit(t){const e=t.faces.length/3,i=t.faces,r=t.neighbors;let s=0;for(let a=0;a<e;a++){const l=r[3*a+0],c=r[3*a+1],h=r[3*a+2],p=i[3*a+0],f=i[3*a+1],g=i[3*a+2];s+=l===Iv||p<f?1:0,s+=c===Iv||f<g?1:0,s+=h===Iv||g<p?1:0}const n=new Int32Array(4*s);let o=0;for(let a=0;a<e;a++){const l=r[3*a+0],c=r[3*a+1],h=r[3*a+2],p=i[3*a+0],f=i[3*a+1],g=i[3*a+2];(l===Iv||p<f)&&(n[o++]=p,n[o++]=f,n[o++]=a,n[o++]=l),(c===Iv||f<g)&&(n[o++]=f,n[o++]=g,n[o++]=a,n[o++]=c),(h===Iv||g<p)&&(n[o++]=g,n[o++]=p,n[o++]=a,n[o++]=h)}return n}function Kit(t){const e=t.faces.length/3,i=t.vertices.position,r=t.faces,s=aB.v0,n=aB.v1,o=aB.v2,a=new Float32Array(3*e);for(let l=0;l<e;l++){const c=r[3*l+0],h=r[3*l+1],p=r[3*l+2];i.getVec(c,s),i.getVec(h,n),i.getVec(p,o),ue(n,n,s),ue(o,o,s),Ye(s,n,o),_e(s,s),a[3*l+0]=s[0],a[3*l+1]=s[1],a[3*l+2]=s[2]}return a}const oB={edge:{position0:$(),position1:$(),faceNormal0:$(),faceNormal1:$(),componentIndex:0,cosAngle:0},ortho:$(),fwd:$()},aB={v0:$(),v1:$(),v2:$()},ert={anglePlanar:4,angleSignificantEdge:35};async function trt(t){const e=irt(t),i=lB(e),r=[e.data.buffer];return{result:rrt(i,r),transferList:r}}function lB(t){const e=srt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return Pme.updateSettings(t.writerSettings),Ame.updateSettings(t.writerSettings),Zit(e,Pme,Ame)}function irt(t){return{data:F4.createView(t.dataBuffer),indices:t.indicesType==="Uint32Array"?new Uint32Array(t.indicesBuffer):t.indicesType==="Uint16Array"?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}function rrt(t,e){return e.push(t.regular.lodInfo.lengths.buffer),e.push(t.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:xme(t.regular.instancesData,e),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:xme(t.silhouette.instancesData,e),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}function srt(t,e,i,r){if(e)return{faces:i,facesLength:r,neighbors:Mme(i,r,t.count),vertices:t};const s=zce(t.buffer,t.stride/4,{originalIndices:i,originalIndicesLength:r}),n=Mme(s.indices,r,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:n,vertices:F4.createView(s.buffer)}}const Pme=new k4,Ame=new z4;var nrt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",work:lB,wrappedWork:trt});class ort extends Mpe{constructor(e){super("EdgeProcessingWorker","wrappedWork",e)}async process(e,i,r){if(r)return lB(e);const s=this._packInput(e),n=await this.invoke(s,i);return this._unpackOutput(n)}getTransferList(e){return[e.dataBuffer]}_packInput(e){return{dataBuffer:e.data.buffer,writerSettings:e.writerSettings,skipDeduplicate:e.skipDeduplicate,indicesBuffer:e.indices.buffer,indicesType:$C(e.indices)?"Uint32Array":"Uint16Array",indicesLength:e.indicesLength}}_unpackOutput(e){return{regular:{instancesData:Sme(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:Sme(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}}function art(t){const e=4,i=cC.resolution,r=i/2,s=new Uint8Array(e*i*i),n=e*i*r,o=cC.amplitude,a=2*o,l=e*i,c=Math.log2(i)+1,h=cC.strokes.length;let p=(c-1)*h*l;for(const{distance:g,pressure:y}of cC.strokes){let v=g,b=y,w=p;for(let S=0;S<c;S++){S!==0&&(v=$me(v,0),b=$me(b,1));for(let T=0;T<cC.resolution;T++){const C=.5+(v?v[T%v.length]/a:0),M=b?b[T%b.length]:1;ev(C,s,w),ev(M,s,w+n),w+=e}w-=l*(h+1)}p+=l}const f=new qe(t,{pixelFormat:6408,dataType:5121,hasMipmap:!1,samplingMode:9729,width:i,height:i,wrapMode:10497},s);return new crt(i,a,o,h,f)}function $me(t,e){if(!t)return null;const i=t.length/2,r=lrt*i,s=new Array(i);let n=0;const o=e===1;for(let a=0;a<t.length;a+=2){const l=(t[a]+t[a+1])/2;s[n++]=o?Math.min(r,1-(1-l)*Eme):Math.min(r,l*Eme)}return s}const lrt=.1,Eme=.5;class crt{constructor(e,i,r,s,n){this.resolution=e,this.normalizationScale=i,this.amplitude=r,this.variants=s,this.texture=n}dispose(){this.texture=Ge(this.texture)}}const cC={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function Ome(t){let e=null;for(const i of t){const r=i.type;if(urt(i)){if(A(e))e=r;else if(e!==r)return"uber"}}return _(e)?e:"uber"}function cB(t){let e=0;for(const{material:i}of t)if(Rme(i)){if(i.color[3]*i.opacity<1)return 1;e=2}return e}function uB(t){let e=0;for(const{material:i}of t)if(Rme(i)){switch(i.objectTransparency){case 1:case 0:return 1;case 2:if(i.opacity<1)return 1}e=2}return e}function Rme(t){return t.size*t.color[3]*t.opacity>0}function urt(t){return t.size*t.color[3]>0}function hrt(t,e){const i=Aye(t,e,!0);return i===-1?e<t[0]?0:t.length:i}function Ime(t,e,i){return t.length-hrt(t,e*i.minimumEdgeLength)}function Dme(t,e,i,r){for(let s=0;s<t.length;s++){const n=t[s].index,o=e[s],a=e[s+1];if(r)for(let l=o;l<a;l++){const c=r[l];i.set(c,n)}else for(let l=o;l<a;l++)i.set(l,n)}}const drt=le.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");let yh=class extends ve{constructor(t){super(t),this.updatingHandles=new zh,this.perObjectData=new Map,this.perObjectDataEvictionCache=new Set,this.renderers=new Map,this.numberOfRenderedEdges=0,this.gpuMemoryUsage=0,this.workerAbort=new AbortController,this.tmpModelPosition=$(),this.localOrigins=new xit(new D7(t.renderSR))}initialize(){this.worker=new ort(this.schedule),this.componentColorManager=new Ufe(this.rctx,2);const t=gme.createBuffer(4);for(let e=0;e<4;e++)t.sideness.set(e,0,e===0||e===3?0:1),t.sideness.set(e,1,e===0||e===1?0:1);this.verticesBufferObject=Nt.createVertex(this.rctx,35044,t.buffer)}destroy(){this.destroyed||(this.perObjectData.forEach(t=>this._discardObjectEntry(t)),this.perObjectData.clear(),this.strokesTexture=Ge(this.strokesTexture),this.componentColorManager=tt(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=Ge(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges}shouldRender(){return this.renderers.size>0}async addComponentObject(t,e,i,r,s,n,o,a){if(this.hasObject(t))return;let l;const c=new Fme(new Promise(h=>l=h),i.center,i.radius);this.perObjectData.set(t,c),await this.updatingHandles.addPromise(this.addComponentGeometry(e,c,r,s,n,o,a)),this.setNeedsRender(),l()}async addOrUpdateObject3D(t,e,i,r){if(this.destroyed)return void drt.warn("Attempt to add an object to a destroyed instance");const s=this.perObjectData.get(t);let n;(s==null?void 0:s.renderables.length)>0&&this.perObjectDataEvictionCache.add(s);const o=t.boundingVolumeWorldSpace.bounds,a=new Fme(new Promise(c=>n=c),ea(o),eA(o));this.perObjectData.set(t,a);const l=new Array;if(i.mergeGeometries&&t.geometries.length>1&&frt(t))l.push(this.addObjectMergedGeometries(t,a,e,i,r));else for(let c=0;c<t.geometries.length;c++){const h=t.geometryRecords[c];if(!h.material.supportsEdges)continue;const p=t.geometries[c];l.push(this.addGeometry(t,a,p,h,e[0],i,r))}await this.updatingHandles.addPromise(Promise.all(l)),this.perObjectDataEvictionCache.delete(a),this._discardObjectEntry(s),this.setNeedsRender(),n()}_discardObjectEntry(t){t&&(t.renderables.length&&(t.renderables.forEach(e=>this.removeRenderable(e)),this.setNeedsRender()),t.loaded=null)}hasObject(t){return this.perObjectData.has(t)}async updateAllComponentOpacities(t,e){const i=e instanceof Array?r=>e[r]:()=>e;(await this.updatingHandles.addPromise(this.getObjectEntry(t))).renderables.forEach(r=>{const s=r.components.meta.length;for(let n=0;n<s;n++){const o=i(n),a=r.components.meta[n],l=a.index;a.material.opacity=o,r.components.buffer.textureBuffer.setDataElement(l,1,3,255*o)}this.updateTransparency(r)}),this.setNeedsRender()}async updateAllComponentMaterials(t,e,i,r){const s=t instanceof Nd,n=!!i.slicePlaneEnabled,o=Ome(e),a=lC.getKey(o,n,s);(await this.updatingHandles.addPromise(this.getObjectEntry(t))).renderables.forEach(l=>{if(a!==l.rendererKey){const c=this.renderers.get(l.rendererKey),h=this.acquireRenderer(o,n,s);c.removeRenderable(l),c.refCount.decrement(),l.rendererKey=a,h.addRenderable(l)}for(let c=0;c<e.length;c++)l.components.meta[c].material=e[c];r&&this.updateComponentBuffer(l.components),this.updateTransparency(l)}),this.setNeedsRender()}async updateObjectVisibility(t,e){(await this.updatingHandles.addPromise(this.getObjectEntry(t))).renderables.forEach(i=>i.visible=e),this.setNeedsRender()}removeObject(t){const e=this.perObjectData.get(t);e&&(this.perObjectData.delete(t),this._discardObjectEntry(e))}async getObjectEntry(t){const e=this.perObjectData.get(t);if(!e)throw"no object";return await e.loaded,e}removeAll(){this.perObjectData.forEach((t,e)=>this.removeObject(e))}render(t,e){if(A(this.componentColorManager))return;this.localOrigins.updateViewMatrices(t.camera.viewMatrix);const i=t.camera.viewInverseTransposeMatrix,r=$(),s=new S4,n=new eo.ViewProjectionTransform,o=Ai();ne(r,i[3],i[7],i[11]),s.set(r),re(n.worldFromView_TH,s.high),re(n.worldFromView_TL,s.low),Ka(n.viewFromCameraRelative_RS,t.camera.viewMatrix),ji(n.projFromView,t.camera.projectionMatrix);const a=Ai();el(a,n.viewFromCameraRelative_RS),p0(o,a);let l=0,c=0;if(this.renderers.forEach(p=>{p.refCount.value===0?(this.renderers.delete(p.key),p.dispose()):p.forEachRenderable(f=>{l+=f.statistics.averageEdgeLength,c++},e)}),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures(),c===0)return;const h={distanceFalloffFactor:40*l/c,minimumEdgeLength:t.camera.perScreenPixelRatio,transparency:e,viewProjectionTransform:n,transformNormal_ViewFromGlobal:o};this.updateObjectCameraDistances(t),this.numberOfRenderedEdges=0,this.renderers.forEach(p=>{this.renderRegularEdges(p,t,h),this.renderSilhouetteEdges(p,t,h)})}updateTransparency(t){const e=cB(t.components.meta),i=uB(t.components.meta);e===t.edgeTransparency&&i===t.objectTransparency||(t.edgeTransparency=e,t.objectTransparency=i,this.renderers.get(t.rendererKey).setRenderablesDirty())}computeModelTransformWithLocalOrigin(t,e,i){if(t.getCombinedStaticTransformation(e,i),_(e.origin))this.localOrigins.register(e.origin);else{const r=ne(this.tmpModelPosition,i[12],i[13],i[14]);e.origin=this.localOrigins.acquire(r)}return bit(e.origin.vec3,i),e.origin}updateComponentBuffer(t){const{meta:e,buffer:i}=t;for(let r=0;r<e.length;r++){const s=e[r].material,n=e[r].index,o=Re(Math.round(s.size*kit),0,255),a=Re(s.extensionLength,-nB,255-nB)+nB,l=s.type==="solid"?0:1,c=255*s.opacity,h=s.color,p=255*h[0],f=255*h[1],g=255*h[2],y=255*h[3];i.textureBuffer.setData(n,0,p,f,g,y),i.textureBuffer.setData(n,1,o,a,l,c)}}createComponentBuffers(t){if(A(this.componentColorManager))return null;const e=new Array,i=this.componentColorManager.getBuffer(t.length);for(let s=0;s<t.length;s++){const n=t[s],o=i.acquireIndex();e.push({index:o,material:n})}const r={meta:e,buffer:i};return this.updateComponentBuffer(r),r}extractEdges(t,e,i,r,s,n=s.length){return this.worker.process({data:e,indices:s,indicesLength:n,writerSettings:t,skipDeduplicate:i},this.workerAbort.signal,r)}createEdgeResources(t){const e={};if(A(this.verticesBufferObject))return e;if(t.regular.lodInfo.lengths.length>0){const i=new Tr(this.rctx,iB,{vertices:yme,instances:k4.glLayout},{vertices:this.verticesBufferObject,instances:Nt.createVertex(this.rctx,35044,t.regular.instancesData.buffer)});e.regular={vao:i,lod:t.regular.lodInfo}}if(t.silhouette.lodInfo.lengths.length>0){const i=new Tr(this.rctx,iB,{vertices:yme,instances:z4.glLayout},{vertices:this.verticesBufferObject,instances:Nt.createVertex(this.rctx,35044,t.silhouette.instancesData.buffer)});e.silhouette={vao:i,lod:t.silhouette.lodInfo}}return e}async addGeometry(t,e,i,r,s,n,o){const a=i.vertexAttributes.get("position"),l=i.indices.get("position"),c=be(),h={position:a,indices:l,modelTransform:c,origin:this.computeModelTransformWithLocalOrigin(t,r,c)};return this.addPositionData(e,h,i.edgeIndicesLength,s,n,o)}async addPositionData(t,e,i,r,s,n=!1){if(t.loaded==null)return;const o=this.createComponentBuffers([r]);if(A(o)||i<=0)return;const a=this.acquireRenderer(r.type,!!s.slicePlaneEnabled),{modelTransform:l,origin:c}=e,h=e.indices,p=e.position,f=p.data.length/p.size,g=F4.createBuffer(f);for(let T=0;T<f;T++)g.position.set(T,0,p.data[T*p.size+0]),g.position.set(T,1,p.data[T*p.size+1]),g.position.set(T,2,p.data[T*p.size+2]);Dme(o.meta,[0,g.componentIndex.count],g.componentIndex);const y=await this.updatingHandles.addPromise(this.extractEdges(a.writerSettings,g,!1,n,h,i));if(t.loaded==null)return;const{regular:v,silhouette:b}=this.createEdgeResources(y),w=(v?v.vao.size:0)+(b?b.vao.size:0),S={regular:v,silhouette:b,transform:{modelMatrix:l,origin:c},statistics:{gpuMemoryUsage:w,averageEdgeLength:y.averageEdgeLength},components:o,visible:!0,edgeTransparency:cB(o.meta),objectTransparency:uB(o.meta),distanceToCamera:0,rendererKey:a.key};t.renderables.push(S),a.addRenderable(S),this.gpuMemoryUsage+=w}async addComponentGeometry(t,e,i,r,s,n,o){if(e.loaded==null)return;const a=this.createComponentBuffers(n);if(A(a))return;const l=Ome(n),c=this.acquireRenderer(l,o.slicePlaneEnabled||!1,!1),h=F4.createBuffer(i.count);_U(h.position,i),Dme(a.meta,s,h.componentIndex,r);const p=!0,f=c.writerSettings,g=await this.updatingHandles.addPromise(this.extractEdges(f,h,p,!1,r));if(e.loaded==null)return;const{regular:y,silhouette:v}=this.createEdgeResources(g),b=(y?y.vao.size:0)+(v?v.vao.size:0),w={regular:y,silhouette:v,transform:t,statistics:{gpuMemoryUsage:b,averageEdgeLength:g.averageEdgeLength},components:a,visible:!0,edgeTransparency:cB(a.meta),objectTransparency:uB(a.meta),distanceToCamera:0,rendererKey:c.key};e.renderables.push(w),c.addRenderable(w),this.gpuMemoryUsage+=b}async addObjectMergedGeometries(t,e,i,r,s){const n=new Map;let o=0,a=null,l=0;for(let w=0;w<t.geometries.length;w++){const S=t.geometries[w],T=t.geometryRecords[w];if(!T.material.supportsEdges)continue;!a&&T.origin&&(a=T);const C=S.vertexAttributes.get("position");l+=C.data.length/C.size,o+=S.edgeIndicesLength}const c=l>=65536?Uint32Array:Uint16Array,h=o?new c(o):null,p=[];let f=0;for(let w=0;w<t.geometries.length;w++){const S=t.geometries[w];if(!t.geometryRecords[w].material.supportsEdges)continue;const T=S.vertexAttributes.get("position"),C=S.indices.get("position");let M=n.get(T.data);if(M==null){M=p.length/3;for(let P=0;P<T.data.length;P+=T.size)p.push(T.data[P+0]),p.push(T.data[P+1]),p.push(T.data[P+2]);n.set(T.data,M)}if(C)for(let P=0;P<S.edgeIndicesLength;P++)h[f++]=M+C[P]}const g=a||t.geometryRecords[0],y=be(),v=this.computeModelTransformWithLocalOrigin(t,g,y);for(let w=0;w<t.geometryRecords.length;w++)t.geometryRecords[w].origin=v;const b={position:{data:p,size:3},indices:h,modelTransform:y,origin:v};await this.updatingHandles.addPromise(this.addPositionData(e,b,h.length,i[0],r,s))}acquireRenderer(t,e,i=!0){const r=lC.getKey(t,e,i);let s=this.renderers.get(r);return A(this.strokesTexture)&&(this.strokesTexture=art(this.rctx)),s||(s=new lC(this.rctx,this.techniqueRepository,{type:t,slicePlaneEnabled:e,strokesTexture:this.strokesTexture,legacy:i}),this.renderers.set(r,s)),s.refCount.increment(),s}removeRenderable(t){prt(t);const e=this.renderers.get(t.rendererKey);if(e){e.removeRenderable(t),e.refCount.decrement(),"origin"in t.transform&&this.localOrigins.release(t.transform.origin),this.gpuMemoryUsage-=t.statistics.gpuMemoryUsage;for(const i of t.components.meta)t.components.buffer.releaseIndex(i.index)}}updateObjectCameraDistances(t){const e=t.camera.eye,i=t.camera.viewForward,r=$(),s=n=>{const{center:o,radius:a}=n;eu(r,o,e);const l=ye(r,i),c=l<-a?1/0:l<a?0:l-a;n.renderables.forEach(h=>h.distanceToCamera=c)};this.perObjectData.forEach(s),this.perObjectDataEvictionCache.forEach(s)}renderRegularEdges(t,e,i){t.bindRegularEdges(e,i);const r=i.transparency;t.forEachRenderable(s=>{if(!s.visible||!s.regular)return;const n=Ime(s.regular.lod.lengths,s.distanceToCamera,i);"origin"in s.transform&&(e.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),t.renderRegularEdges(s,e,n),this.numberOfRenderedEdges+=n},r)}renderSilhouetteEdges(t,e,i){t.bindSilhouetteEdges(e,i);const r=i.transparency;t.forEachRenderable(s=>{if(!s.visible||!s.silhouette)return;const n=Ime(s.silhouette.lod.lengths,s.distanceToCamera,i);"origin"in s.transform&&(e.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),t.renderSilhouetteEdges(s,e,n),this.numberOfRenderedEdges+=n},r)}};function prt(t){t.regular&&(t.regular.vao.vertexBuffers.instances.dispose(),t.regular.vao.dispose(!1),t.regular.vao=null),t.silhouette&&(t.silhouette.vao.vertexBuffers.instances.dispose(),t.silhouette.vao.dispose(!1),t.silhouette.vao=null)}function frt(t){let e=null,i=null;for(let s=0;s<t.geometries.length;s++){var r;const n=t.geometryRecords[s];if(n.material.supportsEdges){if(e){if(!_p(e,n.transformation))return!1}else e=n.transformation;if(!i&&_(n.origin))i=n;else if(_((r=i)==null?void 0:r.origin)&&_(n.origin)&&i.origin.id!==n.origin.id)return!1}}return!0}u([d({constructOnly:!0})],yh.prototype,"rctx",void 0),u([d({constructOnly:!0})],yh.prototype,"renderSR",void 0),u([d({constructOnly:!0})],yh.prototype,"techniqueRepository",void 0),u([d({constructOnly:!0})],yh.prototype,"setNeedsRender",void 0),u([d({constructOnly:!0})],yh.prototype,"schedule",void 0),u([d({readOnly:!0})],yh.prototype,"updatingHandles",void 0),u([d({readOnly:!0})],yh.prototype,"updating",null),yh=u([R("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],yh);class Fme{constructor(e,i,r){this.center=i,this.radius=r,this.renderables=new Array,this.loaded=e,this.loaded.then(()=>{this.loaded!=null&&(this.loaded=!0)})}}function Lme(t){const e=t.capabilities.disjointTimerQuery;return A(e)?null:e.timestampBits()>0?new mrt(e):hB?null:new grt(e)}class mrt{constructor(e){this.timer=e,this.start=e.createQuery(),e.createTimestamp(this.start)}stop(e,i=50){this.end=this.timer.createQuery(),this.timer.createTimestamp(this.end),this.checkQueryResult(e,i)}checkQueryResult(e,i){if(!this.timer.resultAvailable(this.end))return void setTimeout(()=>this.checkQueryResult(e,i),i);if(this.timer.disjoint())return void e(null);const r=this.timer.getResult(this.start),s=this.timer.getResult(this.end);e((s-r)/1e6)}}class grt{constructor(e){this.timer=e,this.query=e.createQuery(),hB=!0,this.timer.beginTimeElapsed(this.query)}stop(e,i=50){this.timer.endTimeElapsed(),hB=!1,this.checkQueryResult(e,i)}checkQueryResult(e,i){const r=this.timer.resultAvailable(this.query),s=this.timer.disjoint();if(!r||s)s?e(null):setTimeout(()=>this.checkQueryResult(e,i),i);else{const n=this.timer.getResult(this.query);e(n/1e6)}}}let hB=!1;const yrt=["prepare","shadowmap","lineardepth","normals","ssao","opaque","opaque edges","transparent","transparent edges","hudvisibility","transparent terrain","atmosphere","laserline","occluded","antialiasing","highlights","hudOccluded","hudNotoccluded"];class vrt extends wp{constructor(){super("total"),this.total=0,this.frameCount=0}}class _rt{constructor(){this._startTime=0,this._lastSample=0,this._enableGPUTimer=0,this.totalTime=new vrt,this.gpuTime=new wp("gpu",9),this.renderPassTimings=yrt.map(e=>new wp(e))}enableGPUTimer(){return++this._enableGPUTimer,{remove:lD(()=>--this._enableGPUTimer)}}prerender(e){this._startTime=this._lastSample=performance.now(),this._enableGPUTimer&&(this._gpuTimer=Lme(e))}advance(e){const i=performance.now();this.renderPassTimings[e].record(i-this._lastSample),this._lastSample=i}postrender(){_(this._gpuTimer)&&(this._gpuTimer.stop(i=>_(i)&&this.gpuTime.record(i),16),this._gpuTimer=null);const e=performance.now()-this._startTime;this.totalTime.record(e),this.totalTime.total+=e,this.totalTime.frameCount++}}let hp=class extends ve{constructor(t,e,i,r,s,n,o,a,l){super({}),this._materialRepository=t,this._shaderTechniqueRepository=i,this._rctx=r,this._compositingHelper=s,this._magnifierHelper=n,this._requestRender=o,this._stage=l,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this.performanceInfo=new _rt,this._antialiasing=1,this._oitEnabled=!1,this._multipassTerrain=!0,this._opaqueTerrain=!0,this._lighting=new Aue,this._handles=new dt,this.renderHiddenTransparentEdges=()=>{},this._smaaPass=new aC(this._rctx,i),this._oitEnabled=this._hasOITSupport,this._requestRender(),this._offscreenRendering=new Htt(this._rctx,this._compositingHelper),this._sliceHelper=new fit,this._shadowMap=new Zfe(this._rctx,l.viewingMode,2),this._ssaoHelper=new _it(i,this._rctx,()=>this._requestRender()),this._highlightHelper=new jtt(i,this._rctx),this._shadowHighlightHelper=new pit(this._rctx,l.viewingMode),this._shadowAccumulator=new on(this._rctx,i,l,(c,h)=>{this.renderPassManager.shadowCastingEnabled=!0,this._renderPlugins.prepareRender(c,h),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled},(c,h,p,f)=>{c.start(p,h,f),this.renderShadowCascades(4,c),p.setGLViewport(this._rctx),this.ensureCameraBindParameters(p)},()=>this._requestRender()),this._bindParameters={slot:null,camera:null,inverseViewport:ke(),shadowMap:this._shadowMap,shadowMappingEnabled:this._shadowMap.enabled,ssaoHelper:this._ssaoHelper,ssaoEnabled:this._ssaoHelper.enabled,origin:null,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:this._sliceHelper.plane,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!1,lastFrameColorTexture:null,reprojectionMatrix:Dr,ssrEnabled:!1,lighting:this._lighting,highlightColorTexture:null},this._renderContext=new Cje(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!1,terrainLinearDepthTexture:null},this._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},this._renderContext.ssrParams={camera:null,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:Dr,ssrEnabled:!1},this._renderPlugins=new Jtt({renderContext:this._renderContext,shaderTechniqueRep:i,textureRep:e,materialRep:this._materialRepository,requestRender:this._requestRender,schedule:a}),this.renderPassManager=new Ltt(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([Ke(Kt,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",c=>{this.renderHiddenTransparentEdges=c?()=>this.renderEdges(1):()=>{},this._requestRender()}),Ke(this._stage,"camera",()=>this._requestRender(),!0)])}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}normalizeCtorArgs(){return{}}dispose(){this._handles.destroy(),this._smaaPass.dispose(),this._materialRenderers.forEach(t=>t.dispose()),this._materialRenderers.clear(),this._edgeView=tt(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=Ge(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),this._shadowAccumulator.dispose(),NE.prune(),this._content.clear()}get updating(){return this._antialiasing===1&&this._smaaPass.updating||_(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return A(this._edgeView)&&(this._edgeView=new yh({rctx:this._rctx,renderSR:this._stage.renderSR,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:t=>this._stage.resourceController.schedule(t)}),this._handles.add(this._edgeView.watch("updating",()=>this._requestRender(),!0)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return this._bindParameters.reprojectionMatrix===null||QL(this._bindParameters.reprojectionMatrix,Dr)}set _reprojectionMatrix(t){QL(this._bindParameters.reprojectionMatrix,t)||(this._bindParameters.reprojectionMatrix=t,this.notifyChange("isCameraFinal"))}get hasShadowsEnabled(){var t;return!((t=this._shadowMap)==null||!t.enabled)}setRenderParameters(t){const{renderPassManager:e,_shadowMap:i,_ssaoHelper:r}=this;t.screenSpaceReflectionsEnabled!==void 0&&e.screenSpaceReflectionsEnabled!==t.screenSpaceReflectionsEnabled&&(e.screenSpaceReflectionsEnabled=t.screenSpaceReflectionsEnabled,this._requestRender()),t.shadowMap===void 0||i.enabled===t.shadowMap&&e.shadowCastingEnabled===t.shadowMap||(i.enabled=t.shadowMap,e.shadowCastingEnabled=t.shadowMap,this._requestRender()),t.shadowMapMaxCascades!==void 0&&i.maxCascades!==t.shadowMapMaxCascades&&(i.maxCascades=t.shadowMapMaxCascades,this._requestRender()),t.ssao!==void 0&&r.enabled!==t.ssao&&(r.enabled=t.ssao,this._requestRender()),t.background&&this._offscreenRendering.background!==t.background&&(this._offscreenRendering.background=t.background,this._requestRender());const s=t.antialiasingEnabled?1:0;t.antialiasingEnabled!==void 0&&this._antialiasing!==s&&(this._antialiasing=s,this._requestRender()),t.highQualityTransparency!==void 0&&this._multipassTerrain!==t.highQualityTransparency&&(this._multipassTerrain=t.highQualityTransparency,this._oitEnabled=t.highQualityTransparency&&this._hasOITSupport,this._requestRender()),t.defaultHighlightOptions!==void 0&&(this._highlightHelper.setDefaultOptions(t.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(t.defaultHighlightOptions),this._requestRender()),t.slicePlane!==void 0&&this._sliceHelper.plane!==t.slicePlane&&(this._sliceHelper.plane=at(t.slicePlane),this._requestRender()),t.waterReflectionEnabled!==void 0&&this._waterReflectionEnabled!==t.waterReflectionEnabled&&(this._waterReflectionEnabled=t.waterReflectionEnabled,this._requestRender()),t.opaqueTerrain!==void 0&&this._opaqueTerrain!==t.opaqueTerrain&&(this._opaqueTerrain=t.opaqueTerrain,this._requestRender()),t.hasOverlayWater!==void 0&&this._hasOverlayWater!==t.hasOverlayWater&&(this._hasOverlayWater=t.hasOverlayWater,this._requestRender()),t.shadowCastOptions!==void 0&&this._shadowAccumulator.setOptions(t.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlendWorking}modify(t){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:e,removes:i,updates:r}=t;if(e.length===0&&i.length===0&&r.length===0)return;i.forAll(({id:o})=>this._content.delete(o)),e.forAll(o=>this._content.set(o.id,o));const s=due(t);let n=!1;s.forEach((o,a)=>{let l=this._materialRenderers.get(a);if(!l){if(!(o.adds.length>0))return;l=new xue(this._rctx,this._materialRepository,a),this._materialRenderers.set(a,l)}l.modify(o),l.isEmpty&&(n=!0)}),n&&this._materialRenderers.forEach((o,a)=>{o.isEmpty&&(this._materialRenderers.delete(a),o.dispose())}),this._hasHighlights=vr(this._materialRenderers,o=>o.hasHighlights),this._hasOccludees=vr(this._materialRenderers,o=>o.hasOccludees),this._hasWater=vr(this._materialRenderers,o=>o.hasWater),this._requestRender()}updateLogic(t){let e=!1;return this._materialRenderers.forEach(i=>e=i.updateLogic(t)||e),e}updateLightSources(t,e,i){this._lighting.groundLightingFactor=e,this._lighting.globalFactor=i,this._lighting.set(t)}render(t,e,i,r){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.lighting=this._lighting,this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=3;const s=this._offscreenRendering;s.needLastFrameColorTexture=this.hasWaterReflection,s.advanceCurrentRenderTarget();const n=this._sliceHelper.plane;r===0&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(t),e.setGLViewport(this._rctx),this.needsShadowCast&&(this.renderPassManager.shadowCastingEnabled=!0),this._renderPlugins.prepareRender(e,i),this.performanceInfo.advance(0);const o=this.computeDepthRange(e);this.renderShadowMap(t,e,this._lighting.lightingMainDirection,o),this.performanceInfo.advance(1),s.initializeFrame(e),this.ensureBindParameters(e),this.renderLinearDepth(),this.performanceInfo.advance(2),this.accumulateShadows(o,e,i),this.renderNormal(),this.performanceInfo.advance(3),this.ensureBindParametersSSR(),this._ssaoHelper.computeSSAO(e,s.linearDepthTexture,s.normalTexture),this.performanceInfo.advance(4),this._renderContext.pass=0,s.bindFramebuffer(),this.renderOpaqueGeometry(),this.performanceInfo.advance(5);const a=this._multipassTerrain&&!this._opaqueTerrain;this.renderTerrainLinearDepth(a),this.setMultipassFlags(a),this.setTerrainCulling(a),this.renderEdges(2),this.performanceInfo.advance(6),this.renderHiddenTransparentEdges(),this._oitEnabled?this.renderOrderIndependentTransparency(()=>this.renderTransparentGeometry(),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderGeometryLinearDepth(a);const l={hudVisibility:!1,transparentTerrain:!1};l.hudVisibility=this.renderHUDVisibility(),a||this.renderInternalSlot(18),this.performanceInfo.advance(9),this.renderEdges(1,a),this.performanceInfo.advance(8),this.renderSlot(22),l.transparentTerrain=this.renderTransparentTerrain(),l.transparentTerrain&&l.hudVisibility&&(a?this.renderLineCallouts(0):s.compositeTransparentTerrainOntoHUDVisibility(),this.renderHUD(0,s.framebuffer),this.performanceInfo.advance(16)),this.performanceInfo.advance(10),this.setTerrainCulling(!1),l.transparentTerrain&&(s.compositeTransparentTerrainOntoMain(),a&&(this.renderEdges(2),this.performanceInfo.advance(6),this._oitEnabled?this.renderOrderIndependentTransparency(()=>this.renderTransparentGeometry(),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8))),a&&this.renderLineCallouts(1),this.setMultipassFlags(!1),this._shadowAccumulator.render(),s.renderToTargets(()=>{this.renderInternalSlot(7),this.renderSlot(13),this.renderSlot(14)},s.currentColorTarget,s.mainDepth),this.performanceInfo.advance(11),this._renderPlugins.needsLaserlineWithContrastControl&&s.renderTmpAndCompositeToMain(()=>this.renderSlot(15),2),this.performanceInfo.advance(12),this.renderOccluded(),this.performanceInfo.advance(13);const c=r===1&&this._magnifierHelper.enabled,h=c&&A(t)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):t;this._rctx.bindFramebuffer(h);const p=this._offscreenRendering.colorTexture;!this.renderAntiAliasing(this._antialiasing,p)&&_(p)&&this._compositingHelper.composite(p,0),this.performanceInfo.advance(14),this.renderHUD(1,h),this.performanceInfo.advance(17),this.renderHighlights(h,this._bindParameters),this.performanceInfo.advance(15),c&&this._magnifierHelper.render(this._rctx,this._bindParameters),h!==t&&(this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0)),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=n,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}readDepthPixels(t,e,i,r,s,n){const o=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this.ensureBindParameters(t),this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const a=17664;this._rctx.clearSafe(a),this.renderGeometryAndTransparentTerrainPass(2)}o.readPixels(e,i,r,s,6408,5121,n)}readAccumulatedShadow(t,e){return this._shadowAccumulator.readAccumulatedShadow(t,e)}setMultipassFlags(t){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=t,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=t}setTerrainCulling(t){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=t}renderSlot(t){return this._renderContext.slot=t,this._renderPlugins.render()}renderEdges(t,e=!1){const i=this._edgeView;_(i)&&i.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain(()=>i.render(this._bindParameters,t),1,e)}renderShadowMap(t,e,i,r){const s=this._shadowMap;s.enabled&&(s.start(e,i,r),this.needsShadowHighlight?(this.renderShadowCascades(7,this._shadowMap,n=>s.takeCascadeSnapshotTo(n,ame)),s.clear(),this.renderShadowCascades(6,this._shadowMap,n=>{s.takeCascadeSnapshotTo(n,lme),this.renderGeometryAndTransparentTerrainPass(7)})):this.renderShadowCascades(4),s.finish(t),e.setGLViewport(this._rctx))}renderShadowCascades(t,e=this._shadowMap,i=r=>{}){for(const r of e.getCascades())r.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(r.camera),this.renderGeometryAndTransparentTerrainPass(t),i(r)}get _needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowCast}renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets(()=>this.renderGeometryAndTransparentTerrainPass(2),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture}renderTerrainLinearDepth(t){if(t){const e=this._renderContext.pass;this._renderContext.pass=2,this._offscreenRendering.renderToTargets(()=>this.renderTransparentTerrain(),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}renderGeometryLinearDepth(t){if(t){const e=this._renderContext.pass;this._offscreenRendering.renderToTargets(()=>this.renderGeometryPass(2),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}get needsNormal(){return this._ssaoHelper.enabled}renderNormal(){this.needsNormal?this._offscreenRendering.renderToTargets(()=>{this.renderGeometryAndTransparentTerrainPass(3)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}get needsDepthRange(){return this._shadowMap.enabled||this.needsShadowCast}computeDepthRange(t){if(!this.needsDepthRange)return kj;const e=xtt(t,this._content,this._stage.layers);return ww(e,this.renderPlugins.queryDepthRange(t)),e.near=Math.max(t.near,e.near),e.far=Math.min(t.far,e.far),e}renderGeometryAndTransparentTerrainPass(t){this._renderContext.pass=t,this.renderGeometryPass(t),this.renderTransparentTerrain()}renderGeometryPass(t){this._renderContext.pass=t,this.renderOpaqueGeometry(),this.renderTransparentGeometry()}renderOpaqueGeometry(){this.renderSlot(0),this.renderSlot(1),this.renderInternalSlot(2),this.renderSlot(3),this.renderSlot(12)}renderTransparentGeometry(){this.renderInternalSlot(4),this.renderSlot(5)}renderTransparentTerrain(){return this.renderSlot(6)}renderHUDVisibility(){let t=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,t=this.renderInternalSlot(11)},this._multipassTerrain&&!this._opaqueTerrain),t}renderLineCallouts(t){this._bindParameters.renderTransparentlyOccludedHUD=t,t===0?this._offscreenRendering.renderToTargets(()=>this.renderInternalSlot(18),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderInternalSlot(18)}renderHUD(t,e){this._oitEnabled?(this.renderOrderIndependentTransparency(()=>this.renderHUDElements(t),!0),this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):t===0?this._offscreenRendering.renderToTargets(()=>this.renderHUDElements(0),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(t)}renderHUDElements(t){this._bindParameters.renderTransparentlyOccludedHUD=t,this.renderInternalSlot(19),this.renderInternalSlot(16),this.renderInternalSlot(17)}get needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlightHelper.isVisible&&this.needsHighlight}renderHighlights(t,e){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const i=this._highlightHelper,r=i.profilingCallback&&Lme(this._renderContext.rctx);this._renderContext.highlightDepthTexture=e.highlightDepthTexture;const s=this._offscreenRendering.renderToTargets(()=>{this.renderGeometryAndTransparentTerrainPass(5),this._rctx.clearSafe(256),this.renderHUDElements(2)},this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=s.colorTexture,this.needsShadowHighlight&&this._shadowHighlightHelper.render(e,t),i.render(this._renderContext.camera,s,t),_(r)&&i.profilingCallback&&r.stop(n=>{i.profilingCallback&&i.profilingCallback(n)})}get needsShadowCast(){return this._shadowAccumulator.isAccumulating}accumulateShadows(t,e,i){this.needsShadowCast&&(this._shadowAccumulator.setAccumulationDependencies(this._offscreenRendering.linearDepthTexture,t,e,i),this._shadowAccumulator.accumulateFixedSamples(),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled)}renderOrderIndependentTransparency(t,e){const i=s=>{this._renderContext.transparencyPassType=s,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass(()=>t(),s,e)},r=this._renderContext.pass;this._renderContext.pass=1,i(1),this._renderContext.pass=0,i(0),i(2),this._offscreenRendering.compositeTransparentOntoOpaque(e),this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=r}renderOccluded(){let t=0;this._materialRenderers.forEach((n,o)=>{o&&o.isVisible()&&o.renderOccluded===8&&(t|=o.renderOccluded,hC.push(o))});const e=this._offscreenRendering,i=(n,o,a,l,c)=>{(t&o)!=0&&(e.renderToTargets(a,e.tmpColor,e.mainDepth,[0,0,0,0],l,c),e.compositeOccludedOntoMain(n))};hC.length!==0&&(this.renderInternalSlot(9,hC),i(.5,8,()=>this.renderInternalSlot(10,hC),!1,!1),hC.length=0),this._materialRenderers.forEach((n,o)=>{o&&o.isVisible()&&(o.renderOccluded===4||o.renderOccluded===2||o.renderOccluded===16)&&(t|=o.renderOccluded,uC.push(o))});const r=this._renderPlugins.renderOccludedFlags;if(t|=r,!t)return;const s=n=>{this._renderContext.renderOccludedMask=n,r>1&&this.renderSlot(8),this.renderInternalSlot(2,uC),this.renderInternalSlot(4,uC),this.renderInternalSlot(7,uC),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=0,i(.5,4,()=>s(4),!0,2),i(.5,2,()=>s(2),!0,2),i(1,16,()=>s(16),!0,2),uC.length=0}renderAntiAliasing(t,e){if(t===1){if(this._smaaPass.enable(()=>this._requestRender())&&_(e))return this._smaaPass.render(e),!0}else this._smaaPass.disable();return!1}ensureCameraBindParameters(t){this._renderContext.camera=t,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]}ensureBindParameters(t){var e;this.ensureCameraBindParameters(t);const i=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=this._renderContext.shadowMap.enabled,this._bindParameters.ssaoHelper=this._renderContext.ssaoHelper,this._bindParameters.ssaoEnabled=this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=i.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=(e=i.depthTexture)!=null?e:this.getFallbackDepthTexture()}ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._renderContext.camera)?this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=Dr:(Vs(kme,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),Vs(U4,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),Fi(U4,U4),Fi(zme,this._renderContext.camera.projectionMatrix),wi(Ew,U4,zme),wi(Ew,kme,Ew),wi(Ew,this._renderContext.lastFrameCamera.projectionMatrix,Ew),this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=Ew),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this.hasWaterReflection}renderInternalSlot(t,e){let i=!1;return this._bindParameters.slot=t,_(e)?e.forEach(r=>{if(!r.shouldRender(this._renderContext))return;const s=this._materialRenderers.get(r);_(s)&&(i=s.render(t,this._renderContext.pass,this._bindParameters)||i)}):this._materialRenderers.forEach((r,s)=>{s.shouldRender(this._renderContext)&&(i=r.render(t,this._renderContext.pass,this._bindParameters)||i)}),i}getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=gne(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){var t,e,i,r,s,n,o,a,l,c;return{offscreen:(t=(e=this._offscreenRendering)==null?void 0:e.gpuMemoryUsage)!=null?t:0,highlights:((i=(r=this._highlightHelper)==null?void 0:r.gpuMemoryUsage)!=null?i:0)+((s=(n=this._shadowHighlightHelper)==null?void 0:n.gpuMemoryUsage)!=null?s:0),shadows:(o=(a=this._shadowMap)==null?void 0:a.gpuMemoryUsage)!=null?o:0,ssao:(l=(c=this._ssaoHelper)==null?void 0:c.gpuMemoryUsage)!=null?l:0}}get test(){const t=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,lighting:this._lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,getFramebufferTexture:e=>{var i;switch(e){case 0:return t._offscreenRendering.colorTexture;case 1:return t._offscreenRendering.linearDepthTexture;case 2:return t._offscreenRendering.normalTexture;case 3:return(i=t._shadowMap)==null?void 0:i.test.depthTexture;case 4:return t._offscreenRendering.hudVisibilityTexture;case 5:return t._offscreenRendering.highlightTexture}}}}};u([d()],hp.prototype,"_shadowAccumulator",void 0),u([d()],hp.prototype,"_smaaPass",void 0),u([d()],hp.prototype,"_antialiasing",void 0),u([d()],hp.prototype,"_edgeView",void 0),u([d()],hp.prototype,"updating",null),u([d()],hp.prototype,"isCameraFinal",null),hp=u([R("esri.views.3d.webgl-engine.lib.Renderer")],hp);const uC=[],hC=[],kme=be(),zme=be(),U4=be(),Ew=be();class brt{constructor(e){this._allocations=new Map,e?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(e){this._allocations.set(e,new Error().stack)}remove(e){this._allocations.delete(e)}print(){if(this._allocations.size>0){console.log(`${this._allocations.size} live object allocations:`);const e=new Map;this._allocations.forEach(i=>{var r;e.set(i,((r=e.get(i))!=null?r:0)+1)}),e.forEach((i,r)=>{const s=r.split(`
`);s.shift(),s.shift(),console.log(`${i}: ${s.shift()}`),s.forEach(n=>console.log("   ",n))})}}}const wrt=!1;class xrt{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new brt(wrt);this._current.length<kr.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(e,i){const r=++this._current[e];this._max[e]=Math.max(r,this._max[e]),this._allocations.add(i)}decrement(e,i){--this._current[e],this._allocations.remove(i)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((e,i)=>e+i,0)}printResourceCount(){if(this.total>0){console.log("Live objects:");for(let e=0;e<kr.COUNT;++e){const i=this._current[e];i>0&&console.log(`${kr[e]}: ${i}`)}}this._allocations.print()}}function Vme(t,e){const i=new ci(t,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1});function r(w,S){const T=new jS(t,`

  precision highp float;

  attribute vec2 position;

  uniform vec3 u_highA;
  uniform vec3 u_lowA;
  uniform vec3 u_highB;
  uniform vec3 u_lowB;

  varying vec4 v_color;

  ${e?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}

  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION

  vec3 dpPlusFrc(vec3 a, vec3 b) {
    return mix(a, a + b, vec3(notEqual(b, vec3(0))));
  }

  vec3 dpMinusFrc(vec3 a, vec3 b) {
    return mix(vec3(0), a - b, vec3(notEqual(a, b)));
  }

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = dpPlusFrc(hiA, hiB);
    vec3 e = dpMinusFrc(t1, hiA);
    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
    return t1 + t2;
  }

  #else

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = hiA + hiB;
    vec3 e = t1 - hiA;
    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
    return t1 + t2;
  }

  #endif

  const float MAX_RGBA_FLOAT =
    255.0 / 256.0 +
    255.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 / 256.0;

  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);

  vec4 float2rgba(const float value) {
    // Make sure value is in the domain we can represent
    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);

    // Decompose value in 32bit fixed point parts represented as
    // uint8 rgba components. Decomposition uses the fractional part after multiplying
    // by a power of 256 (this removes the bits that are represented in the previous
    // component) and then converts the fractional part to 8bits.
    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);

    // Convert uint8 values (from 0 to 255) to floating point representation for
    // the shader
    const float toU8AsFloat = 1.0 / 255.0;

    return fixedPointU8 * toU8AsFloat;
  }

  void main() {
    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);

    v_color = float2rgba(val.z / 25.0);

    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
  }
  `,`
  precision highp float;

  varying vec4 v_color;

  void main() {
    gl_FragColor = v_color;
  }
  `,new Map([["position",0]])),C=new Float32Array(6);JE(w,C,3);const M=new Float32Array(6);return JE(S,M,3),t.useProgram(T),T.setUniform3f("u_highA",C[0],C[2],C[4]),T.setUniform3f("u_lowA",C[1],C[3],C[5]),T.setUniform3f("u_highB",M[0],M[2],M[4]),T.setUniform3f("u_lowB",M[1],M[3],M[5]),T}const s=Nt.createVertex(t,35044,new Uint16Array([0,0,1,0,0,1,1,1])),n=new Tr(t,new Map([["position",0]]),{geometry:[{name:"position",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:s}),o=De(5633261287538229e-9,2626832878767164e-9,1.4349880495278358e6),a=De(563327146742708e-8,2.6268736381334523e6,1434963231608387e-9),l=r(o,a),c=t.getBoundFramebufferObject(),{x:h,y:p,width:f,height:g}=t.getViewport();t.bindFramebuffer(i),t.setViewport(0,0,1,1),t.bindVAO(n),t.drawArrays(5,0,4);const y=new Uint8Array(4);i.readPixels(0,0,1,1,6408,5121,y),l.dispose(),n.dispose(!1),s.dispose(),i.dispose(),t.setViewport(h,p,f,g),t.bindFramebuffer(c);const v=(o[2]-a[2])/25,b=j7(y);return Math.abs(v-b)}var Nme,Ume,jme,Bme={exports:{}};function Srt(t){var e,i,r,s,n;if(!t.gl)return!1;if(t.webglVersion==="webgl")return((s=t.capabilities.textureFloat)==null?void 0:s.textureFloat)&&((n=t.capabilities.colorBufferFloat)==null?void 0:n.textureFloat);if(!(((e=t.capabilities.textureFloat)==null?void 0:e.textureFloat)&&((i=t.capabilities.colorBufferFloat)==null?void 0:i.textureFloat)&&((r=t.capabilities.colorBufferFloat)==null?void 0:r.floatBlend)))return!1;const o=new ci(t,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5126,internalFormat:34836,samplingMode:9728,width:1,height:1}),a=Nt.createVertex(t,35044,new Uint16Array([0,0,1,0,0,1,1,1])),l=new Tr(t,new Map([["a_pos",0]]),{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:a}),c=new jS(t,`
  precision highp float;
  attribute vec2 a_pos;

  void main() {
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,`
   precision highp float;

   void main() {
    gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
   }
  `,new Map([["a_pos",0]]));t.useProgram(c);const h=t.getBoundFramebufferObject(),{x:p,y:f,width:g,height:y}=t.getViewport();t.bindFramebuffer(o),t.setViewport(0,0,1,1),t.bindVAO(l),t.drawArrays(5,0,4);const v=_t({blending:Fle});t.setPipelineState(v),t.drawArrays(5,0,4),Bme.exports.init(t);const b=t.gl.getError();return t.setViewport(p,f,g,y),t.bindFramebuffer(h),c.dispose(),l.dispose(!1),a.dispose(),o.dispose(),b!==1282||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}Nme=Bme,Ume=function(){var t=function(v){window.console&&window.console.log&&window.console.log(v)},e=function(v){window.console&&window.console.error?window.console.error(v):t(v)},i={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},r=null,s=null;function n(v){if(r==null)for(var b in r={},s={},v)typeof v[b]=="number"&&(r[v[b]]=b,s[b]=v[b])}function o(){if(r==null)throw"WebGLDebugUtils.init(ctx) not called"}function a(v){return o(),r[v]!==void 0}function l(v){o();var b=r[v];return b!==void 0?"gl."+b:"/*UNKNOWN WebGL ENUM*/ 0x"+v.toString(16)}function c(v,b,w,S){var T;if((T=i[v])!==void 0&&(T=T[b])!==void 0&&T[w]){if(typeof T[w]=="object"&&T[w].enumBitwiseOr!==void 0){for(var C=T[w].enumBitwiseOr,M=0,P=[],F=0;F<C.length;++F){var z=s[C[F]];(S&z)!=0&&(M|=z,P.push(l(z)))}return M===S?P.join(" | "):l(S)}return l(S)}return S===null?"null":S===void 0?"undefined":S.toString()}function h(v,b){for(var w="",S=b.length,T=0;T<S;++T)w+=(T==0?"":", ")+c(v,S,T,b[T]);return w}function p(v,b,w){v.__defineGetter__(w,function(){return b[w]}),v.__defineSetter__(w,function(S){b[w]=S})}function f(v,b,w,S){S=S||v,n(v),b=b||function(z,D,U){for(var G="",k=U.length,j=0;j<k;++j)G+=(j==0?"":", ")+c(D,k,j,U[j]);e("WebGL error "+l(z)+" in "+D+"("+G+")")};var T={};function C(z,D){return function(){w&&w(D,arguments);var U=z[D].apply(z,arguments),G=S.getError();return G!=0&&(T[G]=!0,b(G,D,arguments)),U}}var M={};for(var P in v)if(typeof v[P]=="function")if(P!="getExtension")M[P]=C(v,P);else{var F=C(v,P);M[P]=function(){return f(F.apply(v,arguments),b,w,S)}}else p(M,v,P);return M.getError=function(){for(var z in T)if(T.hasOwnProperty(z)&&T[z])return T[z]=!1,z;return v.NO_ERROR},M}function g(v){var b=v.getParameter(v.MAX_VERTEX_ATTRIBS),w=v.createBuffer();v.bindBuffer(v.ARRAY_BUFFER,w);for(var S=0;S<b;++S)v.disableVertexAttribArray(S),v.vertexAttribPointer(S,4,v.FLOAT,!1,0,0),v.vertexAttrib1f(S,0);v.deleteBuffer(w);var T=v.getParameter(v.MAX_TEXTURE_IMAGE_UNITS);for(S=0;S<T;++S)v.activeTexture(v.TEXTURE0+S),v.bindTexture(v.TEXTURE_CUBE_MAP,null),v.bindTexture(v.TEXTURE_2D,null);for(v.activeTexture(v.TEXTURE0),v.useProgram(null),v.bindBuffer(v.ARRAY_BUFFER,null),v.bindBuffer(v.ELEMENT_ARRAY_BUFFER,null),v.bindFramebuffer(v.FRAMEBUFFER,null),v.bindRenderbuffer(v.RENDERBUFFER,null),v.disable(v.BLEND),v.disable(v.CULL_FACE),v.disable(v.DEPTH_TEST),v.disable(v.DITHER),v.disable(v.SCISSOR_TEST),v.blendColor(0,0,0,0),v.blendEquation(v.FUNC_ADD),v.blendFunc(v.ONE,v.ZERO),v.clearColor(0,0,0,0),v.clearDepth(1),v.clearStencil(-1),v.colorMask(!0,!0,!0,!0),v.cullFace(v.BACK),v.depthFunc(v.LESS),v.depthMask(!0),v.depthRange(0,1),v.frontFace(v.CCW),v.hint(v.GENERATE_MIPMAP_HINT,v.DONT_CARE),v.lineWidth(1),v.pixelStorei(v.PACK_ALIGNMENT,4),v.pixelStorei(v.UNPACK_ALIGNMENT,4),v.pixelStorei(v.UNPACK_FLIP_Y_WEBGL,!1),v.pixelStorei(v.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),v.UNPACK_COLORSPACE_CONVERSION_WEBGL&&v.pixelStorei(v.UNPACK_COLORSPACE_CONVERSION_WEBGL,v.BROWSER_DEFAULT_WEBGL),v.polygonOffset(0,0),v.sampleCoverage(1,!1),v.scissor(0,0,v.canvas.width,v.canvas.height),v.stencilFunc(v.ALWAYS,0,4294967295),v.stencilMask(4294967295),v.stencilOp(v.KEEP,v.KEEP,v.KEEP),v.viewport(0,0,v.canvas.width,v.canvas.height),v.clear(v.COLOR_BUFFER_BIT|v.DEPTH_BUFFER_BIT|v.STENCIL_BUFFER_BIT);v.getError(););}function y(v){var b,w,S=[],T=[],C={},M=1,P=!1,F=[],z=0,D=0,U=!1,G=0,k={};function j(H){return typeof H=="function"?H:function(K){H.handleEvent(K)}}v.getContext=(w=v.getContext,function(){var H=w.apply(v,arguments);if(H instanceof WebGLRenderingContext){if(H!=b){if(b)throw"got different context";C=Y(b=H)}return C}return H});var V=function(H){S.push(j(H))},q=function(H){T.push(j(H))};function J(H){var K=H.addEventListener;H.addEventListener=function(fe,ce,me){switch(fe){case"webglcontextlost":V(ce);break;case"webglcontextrestored":q(ce);break;default:K.apply(H,arguments)}}}function O(){for(var H=Object.keys(k),K=0;K<H.length;++K)delete k[H]}function L(){++D,P||z==D&&v.loseContext()}function N(H,K){var fe=H[K];return function(){if(L(),!P)return fe.apply(H,arguments)}}function B(){for(var H=0;H<F.length;++H){var K=F[H];K instanceof WebGLBuffer?b.deleteBuffer(K):K instanceof WebGLFramebuffer?b.deleteFramebuffer(K):K instanceof WebGLProgram?b.deleteProgram(K):K instanceof WebGLRenderbuffer?b.deleteRenderbuffer(K):K instanceof WebGLShader?b.deleteShader(K):K instanceof WebGLTexture&&b.deleteTexture(K)}}function W(H){return{statusMessage:H,preventDefault:function(){U=!0}}}return J(v),v.loseContext=function(){if(!P){for(P=!0,z=0,++M;b.getError(););O(),k[b.CONTEXT_LOST_WEBGL]=!0;var H=W("context lost"),K=S.slice();setTimeout(function(){for(var fe=0;fe<K.length;++fe)K[fe](H);G>=0&&setTimeout(function(){v.restoreContext()},G)},0)}},v.restoreContext=function(){P&&T.length&&setTimeout(function(){if(!U)throw"can not restore. webglcontestlost listener did not call event.preventDefault";B(),g(b),P=!1,D=0,U=!1;for(var H=T.slice(),K=W("context restored"),fe=0;fe<H.length;++fe)H[fe](K)},0)},v.loseContextInNCalls=function(H){if(P)throw"You can not ask a lost contet to be lost";z=D+H},v.getNumCalls=function(){return D},v.setRestoreTimeout=function(H){G=H},v;function Y(H){for(var K in H)typeof H[K]=="function"?C[K]=N(H,K):p(C,H,K);C.getError=function(){if(L(),!P)for(;$e=b.getError();)k[$e]=!0;for(var $e in k)if(k[$e])return delete k[$e],$e;return C.NO_ERROR};for(var fe=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],ce=0;ce<fe.length;++ce){var me=fe[ce];C[me]=function($e){return function(){if(L(),P)return null;var Le=$e.apply(H,arguments);return Le.__webglDebugContextLostId__=M,F.push(Le),Le}}(H[me])}var Ie=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(ce=0;ce<Ie.length;++ce)me=Ie[ce],C[me]=function($e){return function(){return L(),P?null:$e.apply(H,arguments)}}(C[me]);var He=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(ce=0;ce<He.length;++ce)me=He[ce],C[me]=function($e){return function(){return L(),!P&&$e.apply(H,arguments)}}(C[me]);return C.checkFramebufferStatus=function($e){return function(){return L(),P?C.FRAMEBUFFER_UNSUPPORTED:$e.apply(H,arguments)}}(C.checkFramebufferStatus),C.getAttribLocation=function($e){return function(){return L(),P?-1:$e.apply(H,arguments)}}(C.getAttribLocation),C.getVertexAttribOffset=function($e){return function(){return L(),P?0:$e.apply(H,arguments)}}(C.getVertexAttribOffset),C.isContextLost=function(){return P},C}}return{init:n,mightBeEnum:a,glEnumToString:l,glFunctionArgToString:c,glFunctionArgsToString:h,makeDebugContext:f,makeLostContextSimulatingCanvas:y,resetToInitialState:g}},(jme=Ume())!==void 0&&(Nme.exports=jme);const Trt=le.getLogger("esri.views.WebGLDriverTest"),Crt=t=>{const e=new ci(t,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),i=`
precision highp float;
attribute vec2 a_pos;
uniform highp sampler2D u_texture;
varying vec4 v_color;

float getBit(in float bitset, in int bitIndex) {
  float offset = pow(2.0, float(bitIndex));
  return mod(floor(bitset / offset), 2.0);
}

void main() {
  vec4 value = texture2D(u_texture, vec2(0.0));
  float bit = getBit(value.x * 255.0, 1);

  v_color = bit * vec4(1.0);
  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,r=`
precision highp float;
varying vec4 v_color;

void main() {
  gl_FragColor = v_color;
}
`,s=new Uint8Array(4),n=Nt.createVertex(t,35044,new Uint16Array([0,0,1,0,0,1,1,1])),o=new Tr(t,new Map([["a_position",0]]),{geometry:[{name:"a_position",count:2,type:5122,offset:0,stride:4,normalized:!1}]},{geometry:n}),a=new jS(t,i,r,new Map([["a_pos",0]])),l=new qe(t,{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([2,255,0,0]));a.setUniform1i("u_texture",0),t.bindTexture(l,0);const c=t.getBoundFramebufferObject();t.bindFramebuffer(e),t.useProgram(a);const{x:h,y:p,width:f,height:g}=t.getViewport();t.setViewport(0,0,1,1),t.bindVAO(o),t.drawArrays(5,0,4),t.setViewport(h,p,f,g),e.readPixels(0,0,1,1,6408,5121,s),a.dispose(),o.dispose(!1),n.dispose(),e.dispose();const y=s[0]!==255||s[1]!==255||s[2]!==255||s[3]!==255;return y&&Trt.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${s[0]}.${s[1]}.${s[2]}.${s[3]}]`),t.bindFramebuffer(c),y};async function Mrt(t){const e=new Image;if(e.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",e.width=5,e.height=5,await e.decode(),!t.gl)return!0;const i=new ci(t,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),r=Nt.createVertex(t,35044,new Uint16Array([0,0,1,0,0,1,1,1])),s=new Tr(t,new Map([["a_pos",0]]),{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:r}),n=new jS(t,`
  precision highp float;

  attribute vec2 a_pos;
  varying vec2 v_uv;

  void main() {
    v_uv = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,`
  precision highp float;

  varying vec2 v_uv;
  uniform sampler2D u_texture;

  void main() {
    gl_FragColor = texture2D(u_texture, v_uv);
  }
  `,new Map([["a_pos",0]]));t.useProgram(n);const o=new qe(t,{dataType:5121,pixelFormat:6408,preMultiplyAlpha:!1,wrapMode:33071,samplingMode:9729},e);t.bindTexture(o,0),n.setUniform1i("u_texture",0);const a=t.getBoundFramebufferObject(),{x:l,y:c,width:h,height:p}=t.getViewport();t.bindFramebuffer(i),t.setViewport(0,0,1,1),t.setClearColor(0,0,0,0),t.setBlendingEnabled(!1),t.clearSafe(16384),t.bindVAO(s),t.drawArrays(5,0,4);const f=new Uint8Array(4);return i.readPixels(0,0,1,1,6408,5121,f),n.dispose(),s.dispose(!1),r.dispose(),i.dispose(),o.dispose(),t.setViewport(l,c,h,p),t.bindFramebuffer(a),e.src="",f[0]===255}class Prt{constructor(e){this.context=e,this._floatBufferBlendWorking=Srt(e),Mrt(e).then(i=>this._svgAlwaysPremultipliesAlpha=!i)}get floatBufferBlendWorking(){if(A(this._floatBufferBlendWorking))throw new Error("floatBufferBlendWorking test not yet available");return this._floatBufferBlendWorking}get svgAlwaysPremultipliesAlpha(){if(A(this._svgAlwaysPremultipliesAlpha))throw new Error("svgAlwaysPremultipliesAlpha test not yet available");return this._svgAlwaysPremultipliesAlpha}get doublePrecisionRequiresObfuscation(){if(A(this._doublePrecisionRequiresObfuscation)){const e=Vme(this.context,!1),i=Vme(this.context,!0);this._doublePrecisionRequiresObfuscation=e!==0&&(i===0||e/i>5)}return this._doublePrecisionRequiresObfuscation}get ignoresSamplerPrecision(){return A(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=Crt(this.context)),this._ignoresSamplerPrecision}}class Gme{constructor(e,i,r,s,n,o,a,l){this.createQuery=e,this.resultAvailable=i,this.getResult=r,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=o,this.createTimestamp=a,this.timestampBits=l}}function Art(t,e){if(e.disjointTimerQuery)return null;let i=t.getExtension("EXT_disjoint_timer_query_webgl2");return i&&Eo(t)?new Gme(()=>t.createQuery(),r=>t.getQueryParameter(r,t.QUERY_RESULT_AVAILABLE),r=>t.getQueryParameter(r,t.QUERY_RESULT),()=>t.getParameter(i.GPU_DISJOINT_EXT),r=>t.beginQuery(i.TIME_ELAPSED_EXT,r),()=>t.endQuery(i.TIME_ELAPSED_EXT),r=>i.queryCounterEXT(r,i.TIMESTAMP_EXT),()=>t.getQuery(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):(i=t.getExtension("EXT_disjoint_timer_query"),i?new Gme(()=>i.createQueryEXT(),r=>i.getQueryObjectEXT(r,i.QUERY_RESULT_AVAILABLE_EXT),r=>i.getQueryObjectEXT(r,i.QUERY_RESULT_EXT),()=>t.getParameter(i.GPU_DISJOINT_EXT),r=>i.beginQueryEXT(i.TIME_ELAPSED_EXT,r),()=>i.endQueryEXT(i.TIME_ELAPSED_EXT),r=>i.queryCounterEXT(r,i.TIMESTAMP_EXT),()=>i.getQueryEXT(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):null)}function $rt(t,e){if(e.disjointTimerQuery)return null;if(Eo(t))return{drawBuffers:t.drawBuffers.bind(t),MAX_DRAW_BUFFERS:t.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:t.MAX_COLOR_ATTACHMENTS};if(e.drawBuffers)return null;const i=t.getExtension("WEBGL_draw_buffers");return i?{drawBuffers:i.drawBuffersWEBGL.bind(i),MAX_DRAW_BUFFERS:i.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:i.MAX_COLOR_ATTACHMENTS_WEBGL}:null}function Ert(t){if(Eo(t))return{drawArraysInstanced:t.drawArraysInstanced.bind(t),drawElementsInstanced:t.drawElementsInstanced.bind(t),vertexAttribDivisor:t.vertexAttribDivisor.bind(t)};const e=t.getExtension("ANGLE_instanced_arrays");return e?{drawArraysInstanced:e.drawArraysInstancedANGLE.bind(e),drawElementsInstanced:e.drawElementsInstancedANGLE.bind(e),vertexAttribDivisor:e.vertexAttribDivisorANGLE.bind(e)}:null}function Ort(t,e){const i=e.loseContext&&t.getExtension("WEBGL_lose_context");return i?{loseRenderingContext:()=>i.loseContext()}:null}function Rrt(t,e){if(Eo(t))return{createVertexArray:t.createVertexArray.bind(t),deleteVertexArray:t.deleteVertexArray.bind(t),bindVertexArray:t.bindVertexArray.bind(t)};if(e.vao)return null;const i=t.getExtension("OES_vertex_array_object")||t.getExtension("MOZ_OES_vertex_array_object")||t.getExtension("WEBKIT_OES_vertex_array_object");return i?{createVertexArray:i.createVertexArrayOES.bind(i),deleteVertexArray:i.deleteVertexArrayOES.bind(i),bindVertexArray:i.bindVertexArrayOES.bind(i)}:null}function Irt(t,e){const i=e.disabledExtensions||{},r=e.debugWebGLExtensions||{};let s,n,o,a,l,c,h,p,f,g,y,v,b=null,w=null,S=null,T=null;return{get drawBuffers(){return y||(y=$rt(t,i)),y},get instancing(){return s||(s=Ert(t)),s},get vao(){return n||(n=Rrt(t,i)),n},get compressedTextureETC(){return o||(o=Drt(t,i)),o},get compressedTextureS3TC(){return a||(a=Frt(t,i)),a},get textureFilterAnisotropic(){return l||(l=krt(t,i)),l},get disjointTimerQuery(){return c||(c=Art(t,i)),c},get textureFloat(){return h||(h=zrt(t,i)),h},get colorBufferFloat(){return p||(p=Vrt(t,i)),p},get blendMinMax(){return f||(f=Lrt(t,i)),f},get depthTexture(){return b===null&&(b=j4(t,i,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),b},get standardDerivatives(){return w===null&&(w=j4(t,i,"standardDerivatives",!0,["OES_standard_derivatives"])),w},get shaderTextureLOD(){return S===null&&(S=j4(t,i,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),S},get fragDepth(){return T===null&&(T=j4(t,i,"fragDepth",!0,["EXT_frag_depth"])),T},get loseContext(){return g||(g=Ort(t,r)),g},get textureNorm16(){return v||(v=Nrt(t,i)),v},enable(C){return this[C]}}}function Drt(t,e){if(e.compressedTextureETC)return null;const i=t.getExtension("WEBGL_compressed_texture_etc");return i?{COMPRESSED_R11_EAC:i.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:i.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:i.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:i.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:i.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:i.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function Frt(t,e){if(e.compressedTextureS3TC)return null;const i=t.getExtension("WEBGL_compressed_texture_s3tc");return i?{COMPRESSED_RGB_S3TC_DXT1:i.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:i.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:i.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:i.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function Lrt(t,e){if(Eo(t))return{MIN:t.MIN,MAX:t.MAX};if(e.blendMinMax)return null;{const i=t.getExtension("EXT_blend_minmax");return i?{MIN:i.MIN_EXT,MAX:i.MAX_EXT}:null}}function krt(t,e){if(e.textureFilterAnisotropic)return null;const i=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return i?{MAX_TEXTURE_MAX_ANISOTROPY:i.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:i.TEXTURE_MAX_ANISOTROPY_EXT}:null}function zrt(t,e){if(Eo(t))return{textureFloat:!0,textureFloatLinear:!e.textureFloatLinear&&!!t.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!e.textureHalfFloatLinear&&!!t.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:t.HALF_FLOAT};if(t instanceof WebGLRenderingContext){const i=!e.textureHalfFloat&&t.getExtension("OES_texture_half_float");return{textureFloat:!e.textureFloat&&!!t.getExtension("OES_texture_float"),textureFloatLinear:!e.textureFloatLinear&&!!t.getExtension("OES_texture_float_linear"),textureHalfFloat:!!i,textureHalfFloatLinear:!e.textureHalfFloatLinear&&!!t.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:i?i.HALF_FLOAT_OES:void 0}}return null}function Vrt(t,e){if(Eo(t)){const i=!e.colorBufferFloat&&t.getExtension("EXT_color_buffer_half_float"),r=!e.colorBufferFloat&&t.getExtension("EXT_color_buffer_float"),s=!e.colorBufferFloat&&t.getExtension("EXT_float_blend");return i||r||s?{textureFloat:!!r,textureHalfFloat:!!i,floatBlend:!!s,R16F:t.R16F,RG16F:t.RG16F,RGBA16F:t.RGBA16F,R32F:t.R32F,RG32F:t.RG32F,RGBA32F:t.RGBA32F,R11F_G11F_B10F:t.R11F_G11F_B10F,RGB16F:t.RGB16F}:null}if(t instanceof WebGLRenderingContext){const i=!e.colorBufferFloat&&t.getExtension("EXT_color_buffer_half_float"),r=!e.colorBufferFloat&&t.getExtension("WEBGL_color_buffer_float"),s=!e.colorBufferFloat&&t.getExtension("EXT_float_blend");return i||r||s?{textureFloat:!!r,textureHalfFloat:!!i,floatBlend:!!s,RGBA16F:i?i.RGBA16F_EXT:void 0,RGB16F:i?i.RGB16F_EXT:void 0,RGBA32F:r?r.RGBA32F_EXT:void 0}:null}return null}function j4(t,e,i,r,s){if(r&&Eo(t))return!0;if(e[i])return!1;for(const n of s)if(t.getExtension(n))return!0;return!1}function Nrt(t,e){if(!Eo(t)||e.textureNorm16)return null;const i=t.getExtension("EXT_texture_norm16");return i?{R16:i.R16,RG16:i.RG16,RGB16:i.RGB16,RGBA16:i.RGBA16,R16_SNORM:i.R16_SNORM,RG16_SNORM:i.RG16_SNORM,RGB16_SNORM:i.RGB16_SNORM,RGBA16_SNORM:i.RGBA16_SNORM}:null}class Urt{constructor(e,i){this.gl=e,this.instanceCounter=new xrt,this._blendEnabled=!1,this._blendColorState={r:0,g:0,b:0,a:0},this._blendFunctionState={srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0},this._blendEquationState={mode:32774,modeAlpha:32774},this._colorMaskState={r:!0,g:!0,b:!0,a:!0},this._polygonCullingEnabled=!1,this._cullFace=1029,this._frontFace=2305,this._scissorTestEnabled=!1,this._scissorRect={x:0,y:0,width:0,height:0},this._depthTestEnabled=!1,this._depthFunction=513,this._clearDepth=1,this._depthWriteEnabled=!0,this._depthRange={zNear:0,zFar:1},this._viewport=null,this._stencilTestEnabled=!1,this._polygonOffsetFillEnabled=!1,this._polygonOffset=[0,0],this._stencilFunction={face:1032,func:519,ref:0,mask:1},this._clearStencil=0,this._stencilWriteMask=1,this._stencilOperation={face:1032,fail:7680,zFail:7680,zPass:7680},this._clearColor={r:0,g:0,b:0,a:0},this._activeShaderProgram=null,this._activeVertexBuffer=null,this._activeIndexBuffer=null,this._activeFramebuffer=null,this._activeRenderbuffer=null,this._activeTextureUnit=0,this._textureUnitMap=new Array,this._numOfDrawCalls=0,this._numOfTriangles=0,this.webglVersion=Eo(e)?"webgl2":"webgl",this.webglVersion==="webgl"&&this.gl.getExtension("OES_element_index_uint"),this._capabilities=Irt(e,i),this._parameters=this._loadParameters(i);const r=this.gl.getParameter(this.gl.VIEWPORT);this._viewport={x:r[0],y:r[1],width:r[2],height:r[3]},this._stateTracker=new c6e({setBlending:s=>{if(s){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(s.opRgb,s.opAlpha),this.setBlendFunctionSeparate(s.srcRgb,s.dstRgb,s.srcAlpha,s.dstAlpha);const n=s.color;this.setBlendColor(n.r,n.g,n.b,n.a)}else this.setBlendingEnabled(!1)},setCulling:s=>{s?(this.setFaceCullingEnabled(!0),this.setCullFace(s.face),this.setFrontFace(s.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:s=>{s?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(s.factor,s.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:s=>{s?(this.setDepthTestEnabled(!0),this.setDepthFunction(s.func)):this.setDepthTestEnabled(!1)},setStencilTest:s=>{if(s){this.setStencilTestEnabled(!0);const n=s.function;this.setStencilFunction(n.func,n.ref,n.mask);const o=s.operation;this.setStencilOp(o.fail,o.zFail,o.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:s=>{s?(this.setDepthWriteEnabled(!0),this.setDepthRange(s.zNear,s.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:s=>{s?this.setColorMask(s.r,s.g,s.b,s.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:s=>{s?this.setStencilWriteMask(s.mask):this.setStencilWriteMask(0)}}),this.enforceState(),this.driverTest=new Prt(this)}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}dispose(){this.bindVAO(null),this.unbindBuffer(34962),this.unbindBuffer(34963),this._textureUnitMap.length=0,u0()&&this.instanceCounter.printResourceCount()}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._blendEnabled!==e&&(e===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._blendEnabled=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){var e;(e=this._activeShaderProgram)==null||e.stop(),this._activeShaderProgram=null}externalTextureUnitUpdate(e,i){for(let r=0;r<e.length;++r)this._textureUnitMap[e[r]]=null;i>=0&&(this._activeTextureUnit=i)}externalVertexArrayObjectUpdate(){const e=this.capabilities.vao;e&&(e.bindVertexArray(null),this._activeVertexArrayObject=null),this._activeVertexBuffer=null,this._activeIndexBuffer=null}externalVertexBufferUpdate(){this._activeVertexBuffer=null}externalIndexBufferUpdate(){this._activeIndexBuffer=null}setBlendColor(e,i,r,s){e===this._blendColorState.r&&i===this._blendColorState.g&&r===this._blendColorState.b&&s===this._blendColorState.a||(this.gl.blendColor(e,i,r,s),this._blendColorState.r=e,this._blendColorState.g=i,this._blendColorState.b=r,this._blendColorState.a=s,this._stateTracker.invalidateBlending())}setBlendFunction(e,i){e===this._blendFunctionState.srcRGB&&i===this._blendFunctionState.dstRGB||(this.gl.blendFunc(e,i),this._blendFunctionState.srcRGB=e,this._blendFunctionState.srcAlpha=e,this._blendFunctionState.dstRGB=i,this._blendFunctionState.dstAlpha=i,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,i,r,s){this._blendFunctionState.srcRGB===e&&this._blendFunctionState.srcAlpha===r&&this._blendFunctionState.dstRGB===i&&this._blendFunctionState.dstAlpha===s||(this.gl.blendFuncSeparate(e,i,r,s),this._blendFunctionState.srcRGB=e,this._blendFunctionState.srcAlpha=r,this._blendFunctionState.dstRGB=i,this._blendFunctionState.dstAlpha=s,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._blendEquationState.mode!==e&&(this.gl.blendEquation(e),this._blendEquationState.mode=e,this._blendEquationState.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,i){this._blendEquationState.mode===e&&this._blendEquationState.modeAlpha===i||(this.gl.blendEquationSeparate(e,i),this._blendEquationState.mode=e,this._blendEquationState.modeAlpha=i,this._stateTracker.invalidateBlending())}setColorMask(e,i,r,s){this._colorMaskState.r===e&&this._colorMaskState.g===i&&this._colorMaskState.b===r&&this._colorMaskState.a===s||(this.gl.colorMask(e,i,r,s),this._colorMaskState.r=e,this._colorMaskState.g=i,this._colorMaskState.b=r,this._colorMaskState.a=s,this._stateTracker.invalidateColorWrite())}setClearColor(e,i,r,s){this._clearColor.r===e&&this._clearColor.g===i&&this._clearColor.b===r&&this._clearColor.a===s||(this.gl.clearColor(e,i,r,s),this._clearColor.r=e,this._clearColor.g=i,this._clearColor.b=r,this._clearColor.a=s)}setFaceCullingEnabled(e){this._polygonCullingEnabled!==e&&(e===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._polygonCullingEnabled=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._polygonOffsetFillEnabled!==e&&(e===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._polygonOffsetFillEnabled=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,i){this._polygonOffset[0]===e&&this._polygonOffset[1]===i||(this._polygonOffset[0]=e,this._polygonOffset[1]=i,this.gl.polygonOffset(e,i),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._cullFace!==e&&(this.gl.cullFace(e),this._cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._frontFace!==e&&(this.gl.frontFace(e),this._frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._scissorTestEnabled!==e&&(e===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._scissorTestEnabled=e)}setScissorRect(e,i,r,s){this._scissorRect.x===e&&this._scissorRect.y===i&&this._scissorRect.width===r&&this._scissorRect.height===s||(this.gl.scissor(e,i,r,s),this._scissorRect.x=e,this._scissorRect.y=i,this._scissorRect.width=r,this._scissorRect.height=s)}setDepthTestEnabled(e){this._depthTestEnabled!==e&&(e===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._depthTestEnabled=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._clearDepth!==e&&(this.gl.clearDepth(e),this._clearDepth=e)}setDepthFunction(e){this._depthFunction!==e&&(this.gl.depthFunc(e),this._depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._depthWriteEnabled!==e&&(this.gl.depthMask(e),this._depthWriteEnabled=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,i){this._depthRange.zNear===e&&this._depthRange.zFar===i||(this.gl.depthRange(e,i),this._depthRange.zNear=e,this._depthRange.zFar=i,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._stencilTestEnabled!==e&&(e===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._stencilTestEnabled=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._clearStencil&&(this.gl.clearStencil(e),this._clearStencil=e)}setStencilFunction(e,i,r){this._stencilFunction.func===e&&this._stencilFunction.ref===i&&this._stencilFunction.mask===r||(this.gl.stencilFunc(e,i,r),this._stencilFunction.face=1032,this._stencilFunction.func=e,this._stencilFunction.ref=i,this._stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,i,r,s){this._stencilFunction.face===e&&this._stencilFunction.func===i&&this._stencilFunction.ref===r&&this._stencilFunction.mask===s||(this.gl.stencilFuncSeparate(e,i,r,s),this._stencilFunction.face=e,this._stencilFunction.func=i,this._stencilFunction.ref=r,this._stencilFunction.mask=s,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this.gl.stencilMask(e),this._stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,i,r){this._stencilOperation.fail===e&&this._stencilOperation.zFail===i&&this._stencilOperation.zPass===r||(this.gl.stencilOp(e,i,r),this._stencilOperation.face=1032,this._stencilOperation.fail=e,this._stencilOperation.zFail=i,this._stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,i,r,s){this._stencilOperation.face===e&&this._stencilOperation.fail===i&&this._stencilOperation.zFail===r&&this._stencilOperation.zPass===s||(this.gl.stencilOpSeparate(e,i,r,s),this._stencilOperation.face=e,this._stencilOperation.face=e,this._stencilOperation.fail=i,this._stencilOperation.zFail=r,this._stencilOperation.zPass=s,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,i=!1){const r=this._activeTextureUnit;return e>=0&&(i||e!==this._activeTextureUnit)&&(this.gl.activeTexture(aV+e),this._activeTextureUnit=e),r}clear(e){e&&this.gl.clear(e)}clearSafe(e,i=255){e&&(16384&e&&this.setColorMask(!0,!0,!0,!0),256&e&&this.setDepthWriteEnabled(!0),1024&e&&this.setStencilWriteMask(i),this.gl.clear(e))}drawArrays(e,i,r){u0()&&(this._numOfDrawCalls++,this._numOfTriangles+=qme(e,r)),this.gl.drawArrays(e,i,r)}drawElements(e,i,r,s){u0()&&(this._numOfDrawCalls++,this._numOfTriangles+=qme(e,i)),this.gl.drawElements(e,i,r,s)}logIno(){u0()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}get capabilities(){return this._capabilities}setViewport(e,i,r,s){r=Math.max(Math.round(r),1),s=Math.max(Math.round(s),1);const n=this._viewport;n.x===e&&n.y===i&&n.width===r&&n.height===s||(n.x=e,n.y=i,n.width=r,n.height=s,this.gl.viewport(e,i,r,s))}getViewport(){return{x:this._viewport.x,y:this._viewport.y,width:this._viewport.width,height:this._viewport.height}}useProgram(e){var i,r;this._activeShaderProgram!==e&&((i=this._activeShaderProgram)==null||i.stop(),this._activeShaderProgram=e,this.gl.useProgram((r=e==null?void 0:e.glName)!=null?r:null))}bindTexture(e,i,r=!1){(i>=this.parameters.maxTextureImageUnits||i<0)&&console.error("Input texture unit is out of range of available units!");const s=this._textureUnitMap[i];return A(e)||e.glName==null?(_(s)&&(this.setActiveTexture(i,r),this.gl.bindTexture(s.descriptor.target,null)),this._textureUnitMap[i]=null,s):r||s!==e?(this.setActiveTexture(i,r),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._textureUnitMap[i]=e,s):(e.isDirty&&(this.setActiveTexture(i,r),e.applyChanges()),s)}unbindTextureAllUnits(e){for(let i=0;i<this.parameters.maxTextureImageUnits;i++)this._textureUnitMap[i]===e&&(this.bindTexture(null,i),this._textureUnitMap[i]=null)}bindFramebuffer(e,i=!1,r=3553){if(A(e))return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),void(this._activeFramebuffer=null);(i||this._activeFramebuffer!==e)&&(e.initializeAndBind(r),this._activeFramebuffer=e)}bindBuffer(e){e&&(e.bufferType===34962?this._activeVertexBuffer=B4(this.gl,e,e.bufferType,this._activeVertexBuffer):this._activeIndexBuffer=B4(this.gl,e,e.bufferType,this._activeIndexBuffer))}bindRenderbuffer(e){const i=this.gl;e||(i.bindRenderbuffer(i.RENDERBUFFER,null),this._activeRenderbuffer=null),this._activeRenderbuffer!==e&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glName),this._activeRenderbuffer=e)}unbindBuffer(e){e===34962?this._activeVertexBuffer=B4(this.gl,null,e,this._activeVertexBuffer):this._activeIndexBuffer=B4(this.gl,null,e,this._activeIndexBuffer)}bindVAO(e=null){A(e)?this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null):this._activeVertexArrayObject!==e&&(e.bind(),this._activeVertexArrayObject=e)}getBoundFramebufferObject(){return this._activeFramebuffer}getBoundVAO(){return this._activeVertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null),this.unbindBuffer(34962),this.unbindBuffer(34963);for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(1,0),this.setBlendEquation(32774),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(1029),this.setFrontFace(2305),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(513),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(519,0,0),this.setStencilOp(7680,7680,7680),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){var e,i,r,s;const n=this.gl,o=this.capabilities.vao;o&&o.bindVertexArray(null);for(let a=0;a<this.parameters.maxVertexAttributes;a++)n.disableVertexAttribArray(a);if(this._activeVertexBuffer?n.bindBuffer(this._activeVertexBuffer.bufferType,this._activeVertexBuffer.glName):n.bindBuffer(34962,null),this._activeIndexBuffer?n.bindBuffer(this._activeIndexBuffer.bufferType,this._activeIndexBuffer.glName):n.bindBuffer(34963,null),o&&this._activeVertexArrayObject){const a=this._activeVertexArrayObject;this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null),this.bindVAO(a)}n.bindFramebuffer(n.FRAMEBUFFER,(e=(i=this._activeFramebuffer)==null?void 0:i.glName)!=null?e:null),n.useProgram((r=(s=this._activeShaderProgram)==null?void 0:s.glName)!=null?r:null),n.blendColor(this._blendColorState.r,this._blendColorState.g,this._blendColorState.b,this._blendColorState.a),n.bindRenderbuffer(n.RENDERBUFFER,this._activeRenderbuffer?this._activeRenderbuffer.glName:null),this._blendEnabled===!0?n.enable(this.gl.BLEND):n.disable(this.gl.BLEND),n.blendEquationSeparate(this._blendEquationState.mode,this._blendEquationState.modeAlpha),n.blendFuncSeparate(this._blendFunctionState.srcRGB,this._blendFunctionState.dstRGB,this._blendFunctionState.srcAlpha,this._blendFunctionState.dstAlpha),n.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a),n.clearDepth(this._clearDepth),n.clearStencil(this._clearStencil),n.colorMask(this._colorMaskState.r,this._colorMaskState.g,this._colorMaskState.b,this._colorMaskState.a),n.cullFace(this._cullFace),n.depthFunc(this._depthFunction),n.depthRange(this._depthRange.zNear,this._depthRange.zFar),this._depthTestEnabled===!0?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),n.depthMask(this._depthWriteEnabled),n.frontFace(this._frontFace),n.lineWidth(1),this._polygonCullingEnabled===!0?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),n.polygonOffset(this._polygonOffset[0],this._polygonOffset[1]),this._polygonOffsetFillEnabled===!0?n.enable(n.POLYGON_OFFSET_FILL):n.disable(n.POLYGON_OFFSET_FILL),n.scissor(this._scissorRect.x,this._scissorRect.y,this._scissorRect.width,this._scissorRect.height),this._scissorTestEnabled===!0?n.enable(n.SCISSOR_TEST):n.disable(n.SCISSOR_TEST),n.stencilFunc(this._stencilFunction.func,this._stencilFunction.ref,this._stencilFunction.mask),n.stencilOpSeparate(this._stencilOperation.face,this._stencilOperation.fail,this._stencilOperation.zFail,this._stencilOperation.zPass),this._stencilTestEnabled===!0?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),n.stencilMask(this._stencilWriteMask);for(let a=0;a<this.parameters.maxTextureImageUnits;a++){n.activeTexture(aV+a),n.bindTexture(3553,null),n.bindTexture(34067,null),Eo(n)&&n.bindTexture(32879,null);const l=this._textureUnitMap[a];_(l)&&n.bindTexture(l.descriptor.target,l.glName)}n.activeTexture(aV+this._activeTextureUnit),n.viewport(this._viewport.x,this._viewport.y,this._viewport.width,this._viewport.height),u0()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}_loadParameters(e){var i;const r=this.capabilities.textureFilterAnisotropic,s=(i=e.maxAnisotropy)!=null?i:1/0,n={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:r?Math.min(this.gl.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY),s):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE)};return qe.TEXTURE_UNIT_FOR_UPDATES=n.maxTextureImageUnits-1,n}}function B4(t,e,i,r){return e?r!==e&&t.bindBuffer(i,e.glName):t.bindBuffer(i,null),e}function qme(t,e){switch(t){case 0:return 2*e;case 4:return e/3;case 5:case 6:return e-2;default:return 0}}class jrt extends Urt{constructor(e,i,r){super(e,i),this.newCache=r}}const Hme=le.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");let Ow=class extends ve{constructor(t,e,i){super({}),this._stage=t,this._techniqueRepository=e,this._rctx=i,this._idToRefCountedTexture=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new Ci,this._frameTask=t.resourceController.scheduler.registerTask(Qe.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}dispose(){this._frameTask.remove(),this._stage.forEachOfType(4,t=>t.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return A(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(e3,new V7)),this._textureTechnique}acquire(t){const e=this._idToRefCountedTexture.get(t);return e?(e.ref(),Promise.resolve(e)):this._createNewRef(t)}update(){let t=!1;this._frameUpdates.forEach(e=>{const i=e.texture.frameUpdate(this._rctx,this.textureTechnique,e.previousToken);i>=0&&i!==e.previousToken&&(e.previousToken=i,t=!0)}),t&&this.events.emit("changed",0)}async _createNewRef(t){const e=this._stage.getObject(t);if(A(e))return Ze(e!==void 0),null;const i=e.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(t)}),r=new Brt(t,()=>{this._frameTask.schedule(()=>{r.isUnreferenced&&e.unload()})});return this._idToRefCountedTexture.set(t,r),r.ref(),_(e.glTexture)?(this._updateGLTexture(r,e.glTexture),e.requiresFrameUpdates&&this._frameUpdates.set(t,{texture:e,previousToken:-1})):(this._loadingCount++,await this._stage.schedule(()=>{const s=e.load(this._rctx,()=>this.textureTechnique),n=a=>(this._loadingCount--,this._updateGLTexture(r,a),e.requiresFrameUpdates&&this._frameUpdates.set(t,{texture:e,previousToken:-1}),r),o=a=>{this._loadingCount--,bi(a)||Hme.error(a)};return fg(s)?s.then(n,o):n(s)})),r}_updateGLTexture(t,e){t.glTexture=e,this.events.emit("changed",1)}_onTextureUnloaded(t){this._idToRefCountedTexture.delete(t),this._frameUpdates.delete(t)}};u([d()],Ow.prototype,"_loadingCount",void 0),u([d()],Ow.prototype,"_frameTask",void 0),u([d()],Ow.prototype,"updating",null),Ow=u([R("esri.views.3d.webgl-engine.lib.TextureRepository")],Ow);class Brt{constructor(e,i){this.id=e,this._release=i,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(Hme.error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}const Grt=le.getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils");let dC=class extends ve{constructor(){super(...arguments),this._data=new Array,this.loadingState=0}dispose(){this.loadingState=0,this._data.forEach(t=>t.dispose()),this._data.length=0}get updating(){return this.loadingState===1}get ready(){return this.loadingState===2}loadTextures(t){const e=[kt("esri/images/materials/water/normals.jpg"),kt("esri/images/materials/water/perturbation.jpg")];this.loadingState=1,Promise.all(e.map(i=>tl(i))).then(i=>{i.forEach(r=>this._data.push(new qe(t,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:10497,samplingMode:9987,hasMipmap:!0,maxAnisotropy:8,width:r.width,height:r.height},r))),this.loadingState=2}).catch(i=>{Grt.error("Failed to load textures for water material.",i),this.loadingState=0})}bind(t){this.ready&&(t.bindTexture(this._data[0],"texWaveNormal"),t.bindTexture(this._data[1],"texWavePerturbation"))}};u([d()],dC.prototype,"loadingState",void 0),u([d({type:Boolean,readOnly:!0})],dC.prototype,"updating",null),dC=u([R("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],dC);class qrt extends cR{constructor(e,i,r,s=null,n,o=!0){super(),this._rctx=e,this._renderScene=i,this._requestRenderScene=r,this._renderOverlay=s,this.forceCameraHook=n,this.supersample=o,this._screenshotQueue=new Array}dispose(){this._rctx=null}takeScreenshot(e){this._requestRenderScene(0);const i=Th();return this._screenshotQueue.push({settings:e,resolver:i}),i.promise}update(e){for(const i of this._screenshotQueue){if(this.isDisposed){i.resolver.reject();continue}const r=he(E({},i.settings),{pixelRatio:i.settings.pixelRatio*e.viewCamera.pixelRatio}),s=this._ensureScreenshotEncodeCanvas(),n=this._renderScreenshot(e,r),o=dqe(n,r,s,{flipY:!0,premultipliedAlpha:!0});i.resolver(o)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,i,r){if(A(this._renderOverlay))return i;e.width=i.width,e.height=i.height;const s=e.getContext("2d"),n=r.pixelRatio;return s.save(),s.translate(0,i.height),s.scale(1,-1),r.region&&s.translate(-r.region.x,-r.region.y),s.scale(n,n),i=this._renderOverlay(e,i),s.restore(),i}_readbackScreenshot(e){return e.resample?this._readbackScreenshotResampled(e):this._readbackScreenshotImmediate(e)}_readbackScreenshotResampled(e){const{framebufferWidth:i,framebufferHeight:r,region:s,resample:n}=e,o=this._ensureScreenshotEncodeCanvas();let a=nU(i,r,o);this._rctx.gl.readPixels(0,0,i,r,6408,5121,new Uint8Array(a.data.buffer)),a=this._renderScreenshotOverlay(o,a,he(E({},e),{region:null}));const l=nU(s.width,s.height,o);return mqe(a,l,!0,n.region.x,r-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(e){const{framebufferHeight:i,region:r}=e,s=this._ensureScreenshotEncodeCanvas(),n=nU(r.width,r.height,s);return this._rctx.gl.readPixels(r.x,i-(r.y+r.height),r.width,r.height,6408,5121,new Uint8Array(n.data.buffer)),this._renderScreenshotOverlay(s,n,e)}_renderScreenshot(e,i){let r=null;const s=e.viewCamera,{framebufferWidth:n,framebufferHeight:o}=i;let a=!1;const l=i.disableDecorations&&e.frameHasDecorations,c=n!==s.fullWidth||o!==s.fullHeight,h=i.ignorePadding&&s.pixelRatio!==i.pixelRatio,p=c||l||h;if(p){const g=s.clone();if(i.ignorePadding){const b=x6(g.padding);for(let w=0;w<4;w++)b[w]=Math.round(b[w]/g.pixelRatio*i.pixelRatio);g.padding=b}g.fullWidth=n,g.fullHeight=o,g.pixelRatio=i.pixelRatio;const y=s.fovX-g.fovX,v=s.fovY-g.fovY;y<0&&y<v?g.fovX=s.fovX:v<0&&v<y&&(g.fovY=s.fovY),this.forceCameraHook(g),a=!0,r=new ci(this._rctx,{width:g.fullWidth,height:g.fullHeight,colorTarget:0,depthStencilTarget:3}),this._renderScene(r,g,i.disableDecorations?0:1),i.renderScreenshotTwice===!0&&this._renderScene(r,g,i.disableDecorations?0:1)}const f=this._readbackScreenshot(i);if(p&&!this._rctx.contextAttributes.alpha)for(let g=3;g<f.data.length;g+=4)f.data[g]=255;return r&&r.dispose(),this._rctx.bindFramebuffer(null),a&&this.forceCameraHook(s),f}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}function Wme(t,e,i={}){if(!window.WebGLRenderingContext)return Zme(t,Hrt),null;const r=pC(t,e,i);return A(r)&&Zme(t,Wrt),r}function pC(t,e,i={}){const r=e===1?["webgl","experimental-webgl","webkit-3d","moz-webgl"]:["webgl2"];let s=null;for(const n of r){try{s=t.getContext(n,i)}catch{}if(s)break}return s}function Zme(t,e){const i=t.parentNode;i&&(i.innerHTML='<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+e+"</div></div></td></tr></table>")}const Hrt='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',Wrt=`It doesn't appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>`,Jme=le.getLogger("esri.views.3d.webgl-engine.parts.View");let Rs=class extends lR(ve){constructor(t){super({}),this.events=new Ci,this.waterTextureRepository=new dC,this._magnifierHelper=new Tw,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._logicUpdateLast=0,this._container=t.container,this._initializeContext(t),Ke(this.waterTextureRepository,"loadingState",()=>this.requestRender()),this._magnifierHelper.events.on("request-render",()=>this.requestRender()),this._stippleTextureRepository=new $ue(this._rctx),this._shaderTechniqueRepository=new jce({rctx:this._rctx,viewingMode:t.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new Ow(t,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",e=>this.requestRender(e)),this._materialRepository=new Gce(this._textureRepository,this._shaderTechniqueRepository,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new gtt(this._rctx,this._shaderTechniqueRepository),this._renderer=new hp(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,e=>this.requestRender(e),(e,i)=>t.schedule(e,i),t),this._screenshotManager=new qrt(this._rctx,(e,i,r)=>this._renderer.render(e,i,i,r),e=>this.requestRender(e),t.options.screenshot.renderOverlay,e=>this.events.emit("force-camera-for-screenshot",e)),this._registerFrameTask(t)}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=ln(this._frameTask),this._shaderTechniqueRepository=Ge(this._shaderTechniqueRepository),super.dispose(),this._tmpDepthBuffer=null,this._rctx=null}get performanceInfo(){const t=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:t.getUsedTextureMemory!==void 0?t.getUsedTextureMemory():void 0,renderbufferMemory:t.getUsedRenderbufferMemory!==void 0?t.getUsedRenderbufferMemory():void 0,VBOMemory:t.getUsedVBOMemory!==void 0?t.getUsedVBOMemory():void 0}}requestRender(t=1){t===1?this._needsUpdate=!0:this._needsRender=!0}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(t){this._magnifierHelper.magnifier=t}updateLightSources(t,e,i){this._renderer.updateLightSources(t,e,i),this.requestRender()}setRenderParameters(t){t.idleSuspend!==void 0&&this._idleSuspend!==!!t.idleSuspend&&(this._idleSuspend=!!t.idleSuspend,this.requestRender()),this._renderer.setRenderParameters(t)}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}modify(t){this._renderer.modify(t),t.clear()}get canvas(){return this._canvas}takeScreenshot(t){return this._screenshotManager.takeScreenshot(t)}get hasShadowsEnabled(){return this._renderer.hasShadowsEnabled}readAccumulatedShadow(t){return this._renderer.readAccumulatedShadow(t[0],t[1])}getMinimalDepthForArea(t,e,i,r,s,n=s){const o=r.constrainWindowSize(e,i,s*r.pixelRatio,n*r.pixelRatio),a=this._ensureDepthBuffer(o);this._renderer.readDepthPixels(r,o[0],o[1],o[2],o[3],a);let l=Number.MAX_VALUE;for(let c=0;c<o[2]*o[3];c++){const h=wtt(4*c,a,r.nearFar);l>h&&h!==r.nearFar[0]&&h!==r.nearFar[1]&&(l=h)}if(_(t)){const c=t.pickDepth(e*r.pixelRatio,i*r.pixelRatio,r);_(c)&&l>c&&c!==r.nearFar[0]&&c!==r.nearFar[1]&&(l=c)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(t){const e=4*t[2]*t[3];return(A(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<e)&&(this._tmpDepthBuffer=new Uint8Array(e)),this._tmpDepthBuffer}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}get gpuMemoryUsage(){return this._renderer.gpuMemoryUsage}async reloadShaders(){Fpe(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender()}_registerFrameTask(t){const e=t.state,i={viewCamera:e.camera,frameHasDecorations:!1},r={preRender:s=>{t.processSyncLayers();const n=Ft(s.time-this._logicUpdateLast);if(n>QYe||_(this.forcedAnimationTime)){const o={camera:e.camera,dt:n,forcedTime:this.forcedAnimationTime};this._logicUpdateLast=s.time,this._renderer.updateLogic(o)&&this.requestRender(0)}},render:()=>{if((this._needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&e.camera.fullWidth>0&&e.camera.fullHeight>0){const s=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,e.camera,e.contentCamera,1),s&&this._renderer.hasWaterReflection&&(this.requestRender(0),this._needsWaterReflectionUpdate=!0)}},update:()=>{i.viewCamera=e.camera,i.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(i)}};this._frameTask=gg(r)}_initializeContext(t){const e=t.options;this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const i={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:e.stencil==null||e.stencil,powerPreference:"high-performance"};let r;const s=ae("esri-force-webgl");if(s===1||s===2?r=Wme(this._canvas,s,i):(r=pC(this._canvas,2,i),A(r)&&(r=Wme(this._canvas,1,i))),A(r))return void Jme.error(s);const n={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{},maxAnisotropy:8};this._rctx=new jrt(r,n,(o,a)=>t.resourceController.memoryController.newCache(o,a)),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&Jme.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&ae("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}get componentObjectCollection(){return A(this._componentObjectCollection)&&(this._componentObjectCollection=new dtt(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(t){this._componentObjectCollection=t}};u([d({type:Boolean,readOnly:!0})],Rs.prototype,"updating",null),u([Cs()],Rs.prototype,"_rctx",void 0),u([Cs()],Rs.prototype,"_container",void 0),u([Cs()],Rs.prototype,"_canvas",void 0),u([Cs()],Rs.prototype,"_stippleTextureRepository",void 0),u([Cs(),d()],Rs.prototype,"waterTextureRepository",void 0),u([Cs(),d()],Rs.prototype,"_magnifierHelper",void 0),u([Cs(),d()],Rs.prototype,"_textureRepository",void 0),u([Cs()],Rs.prototype,"_compositingHelper",void 0),u([Cs()],Rs.prototype,"_renderer",void 0),u([Cs()],Rs.prototype,"_screenshotManager",void 0),u([Cs()],Rs.prototype,"componentObjectCollection",null),u([Cs()],Rs.prototype,"_componentObjectCollection",void 0),u([d()],Rs.prototype,"_needsUpdate",void 0),u([d()],Rs.prototype,"_needsWaterReflectionUpdate",void 0),Rs=u([R("esri.views.3d.webgl-engine.parts.RenderView")],Rs);var G4;let ao=G4=class extends lR(ve){constructor(t){super(t),this._handles=new dt,this._model=new d4,this._layers=new ct,this._changeSet=new hue,this._layerSyncSet=new Set}initialize(){this._set("renderView",new Rs(this)),this._frameTask=this.resourceController.scheduler.registerTask(Qe.STAGE,this),this._handles.add(this._frameTask)}destroy(){G0.pool.prune(0),this._handles.destroy(),this.dispose()}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating||this._frameTask.updating}add(t){this._model.add(t),dR(t)&&(t.attachStage(this),this._addLayer(t)),this.renderView.requestRender()}remove(t){A(t)||(this.renderView.requestRender(),this._model.remove(t),dR(t)&&(this._removeLayer(t),t.detachStage()))}addMany(t){_(t)&&(this._model.addMany(t),this.renderView.requestRender())}removeMany(t){_(t)&&(this._model.removeMany(t),this.renderView.requestRender())}async load(t){A(t)||(Array.isArray(t)||(t=[t]),await mD(t.filter(e=>A(e.glTexture)).map(e=>this.schedule(()=>this._model.has(e)?e.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique):null))))}loadSynchronous(t){return t.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique)}forEachOfType(t,e){this._model.forEachOfType(t,e)}handleEvent(t,e){this.destroyed||(this._model.dirtySet[t](e),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty}runTask(t){this._frameTask.processQueue(t),t.done||this._commit()}_commit(){const t=this._model.dirtySet;G4.DebugSettings.logDirtySet&&console.log("Dirty set: "+t.formatDebugInfo()),t.commit(this._changeSet),G4.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map(e=>e.id)),console.log("RGs remove: "+this._changeSet.removes.map(e=>e.id))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.requestRender()}schedule(t,e){return this._frameTask.schedule(t,e)}syncLayer(t){this._layerSyncSet.add(t),this.renderView.requestRender()}processSyncLayers(){const t=this._model.dirtySet;this._layers.forAll(e=>{(this._layerSyncSet.has(e.id)||e.updatePolicy===1)&&(t.commitLayer(e.id,this._changeSet),this._layerSyncSet.delete(e.id))});for(const e of this._layerSyncSet)t.commitLayer(e,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)}getObject(t){return this._model.getObject(t)}get layers(){return this._layers}_addLayer(t){this._layers.some(e=>e===t)||this._layers.push(t)}_removeLayer(t){this._commit(),this._layers.removeUnordered(t)!=null&&(this._model.dirtySet.getResidentRenderGeometries(t.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(t,e,i){const r=this.renderView.renderPlugins.add(t,e,i),s=()=>{npe(e)&&this.sceneIntersectionHelper.addIntersectionHandler(e)};if(ZC(r))return r.then(s);s()}removeRenderPlugin(t){npe(t)&&this.sceneIntersectionHelper.removeIntersectionHandler(t),this.renderView.renderPlugins.remove(t)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const t=this;return{getCount:e=>t._model.test.content.filter(i=>i.type===e).length,model:t._model}}};ao.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},u([d({constructOnly:!0})],ao.prototype,"resourceController",void 0),u([d({constructOnly:!0})],ao.prototype,"options",void 0),u([d({constructOnly:!0})],ao.prototype,"state",void 0),u([d({constructOnly:!0})],ao.prototype,"sceneIntersectionHelper",void 0),u([d({readOnly:!0})],ao.prototype,"viewingMode",null),u([d({constructOnly:!0})],ao.prototype,"container",void 0),u([d({constructOnly:!0})],ao.prototype,"renderSR",void 0),u([d({constructOnly:!0})],ao.prototype,"_handles",void 0),u([d({readOnly:!0})],ao.prototype,"updating",null),u([d({constructOnly:!0})],ao.prototype,"_model",void 0),u([Cs(),d()],ao.prototype,"renderView",void 0),ao=G4=u([R("esri.views.3d.webgl-engine.Stage")],ao);function Qme(t){return Bu(t)&&t.intersector===5&&!!t.target}function Yme(t){return Bu(t)&&t.intersector===4&&!!t.target}function Zrt(t){return Bu(t)&&t.intersector===2&&!!t.target}function Xme(t){return Bu(t)&&t.intersector===3&&!!t.target}function Jrt(t){return Bu(t)&&t.intersector===6&&!!t.target}function Kme(t,e){return boe(t)||HV(t)?q4(t.target.object.metadata,e):Zrt(t)?(i=e.map)==null?void 0:i.ground:Qme(t)||Yme(t)||Xme(t)?q4(t.target,e):null;var i}function ege(t,e){return boe(t)||HV(t)?tge(t.target.object.metadata,e):Qme(t)?t.target.createGraphic():Xme(t)||Jrt(t)?tge(t.target,e):Yme(t)?Qrt(t.target,e):null}function tge(t,e){if(A(t)||A(t.graphicUid))return null;const i=q4(t,e);if(A(i))return null;if(i===e.graphics)return _(e.graphicsView)?e.graphicsView.getGraphicFromGraphicUid(t.graphicUid):null;const r=e.allLayerViews.find(s=>s.layer===i);return r&&!r.suspended&&"getGraphicFromGraphicUid"in r&&_(t.graphicUid)?r.getGraphicFromGraphicUid(t.graphicUid):null}function Qrt(t,e){const i=q4(t,e);if(A(i))return null;const r=e.allLayerViews.find(s=>s.layer===i);return r&&!r.suspended&&"getGraphicFromIntersectorTarget"in r?r.getGraphicFromIntersectorTarget(t):null}function q4(t,e){return A(t.layerUid)?null:_(e.graphicsView)&&t.layerUid===e.graphicsView.graphics3d.layer.id?e.graphics:e.map.findLayerByUid(t.layerUid)}async function Yrt(t,e){if(t.type==="2d")return t.hitTest(e);const i=await t.hitTest(e),r=i.results[0],s=i.results.findIndex(n=>n.distance!==r.distance);return s!==-1&&(i.results=i.results.slice(0,s)),i}let dB;function Xrt(){return dB||(dB=Krt()),dB}function Krt(){const t={available:!1,version:0,majorPerformanceCaveat:!1,maxTextureSize:0,supportsHighPrecisionFragment:!1,supportsVertexShaderSamplers:!1,supportsElementIndexUint:!1,supportsStandardDerivatives:!1,supportsInstancedArrays:!1,supportsTextureFloat:!1,supportsColorBufferFloat:!1};if(typeof WebGLRenderingContext===void 0)return t;const e=document.createElement("canvas");if(!e)return t;let i=pC(e,1,{failIfMajorPerformanceCaveat:!0});if(A(i)&&(i=pC(e,1),_(i)&&(t.majorPerformanceCaveat=!0)),A(i))return t;const r=i.getParameter(i.VERSION);if(!r)return t;const s=r.match(/^WebGL\s+([\d.]*)/);if(s){const n=parseFloat(s[1]);t.available=n>=.94;const o=i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT);o&&(t.supportsHighPrecisionFragment=o.precision>0),t.supportsVertexShaderSamplers=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0,t.supportsElementIndexUint=i.getExtension("OES_element_index_uint")!==null,t.supportsStandardDerivatives=i.getExtension("OES_standard_derivatives")!==null,t.supportsInstancedArrays=i.getExtension("ANGLE_instanced_arrays")!==null,t.supportsTextureFloat=i.getExtension("OES_texture_float")!==null,t.supportsColorBufferFloat=i.getExtension("WEBGL_color_buffer_float")!==null&&i.getExtension("EXT_float_blend")!==null}return t.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),t.version=est()?2:1,t}function est(){if(typeof WebGL2RenderingContext===void 0)return!1;const t=document.createElement("canvas");if(!t)return!1;const e=pC(t,2);return!!_(e)}const tst={checkMajorWebPerformanceCaveat:!0};function ist(t){t=E(E({},tst),t);const e=Xrt();return e.available?t.checkMajorWebPerformanceCaveat&&e.majorPerformanceCaveat?new Q("webgl:major-performance-caveat-detected","Your WebGL implementation doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist."):e.supportsHighPrecisionFragment?e.supportsVertexShaderSamplers?e.supportsElementIndexUint?e.supportsStandardDerivatives?e.supportsInstancedArrays?null:new Q("webgl:instanced-arrays-required","WebGL support for instanced rendering is required but not supported."):new Q("webgl:standard-derivatives-required","WebGL support for standard derivatives is required but not supported."):new Q("webgl:element-index-uint-required","WebGL support for uint vertex indices is required but not supported."):new Q("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported."):new Q("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported."):new Q("webgl:required","WebGL is required but not supported.")}function rst(t){return t&&"nodeType"in t}function sst(t){return t&&typeof t.render=="function"}const ige={component:"esri-component"};let Dv=class extends ve{constructor(){super(...arguments),this.widget=null}destroy(){this.widget&&this.widget.destroy(),this.node=null}get id(){return this.get("widget.id")||this.get("node.id")}set node(t){const e=this._get("node");t!==e&&(t&&t.classList.add(ige.component),e&&e.classList.remove(ige.component),this._set("node",t))}castNode(t){return t?typeof t=="string"||rst(t)?(this._set("widget",null),MP(t)):(sst(t)&&!t.domNode&&(t.domNode=document.createElement("div")),this._set("widget",t),t.domNode):(this._set("widget",null),null)}};u([d({dependsOn:[]})],Dv.prototype,"id",null),u([d()],Dv.prototype,"node",null),u([ut("node")],Dv.prototype,"castNode",null),u([d({readOnly:!0})],Dv.prototype,"widget",void 0),Dv=u([R("esri.views.ui.Component")],Dv);const H4=Dv,nst={left:0,top:0,bottom:0,right:0},rge={bottom:30,top:15,right:15,left:15},pB="manual",lo={ui:"esri-ui",corner:"esri-ui-corner",innerContainer:"esri-ui-inner-container",manualContainer:"esri-ui-manual-container",cornerContainer:"esri-ui-corner-container",topLeft:"esri-ui-top-left",topRight:"esri-ui-top-right",bottomLeft:"esri-ui-bottom-left",bottomRight:"esri-ui-bottom-right"};function ost(t){return t&&!t._started&&typeof t.postMixInProperties=="function"&&typeof t.buildRendering=="function"&&typeof t.postCreate=="function"&&typeof t.startup=="function"}function fB(t){const e=t,i=typeof e=="object"&&e!==null&&Object.getPrototypeOf(e);return(i===null||i===Object.prototype)&&("component"in e||"index"in e||"position"in e)?t:null}function mB(t,{top:e,bottom:i,left:r,right:s}){t.style.top=e,t.style.bottom=i,t.style.left=r,t.style.right=s}let dp=class extends Ci.EventedAccessor{constructor(t){super(t),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentToKey=new Map,this._handles=new dt,this.view=null,this._initContainers()}initialize(){this._handles.add([Ke(this,"view.padding, container",this._applyViewPadding.bind(this)),Ke(this,"padding",this._applyUIPadding.bind(this))])}destroy(){this.container=null;for(const t of this._components)t.destroy();this._components.length=0,this._handles.destroy(),this._componentToKey.clear()}set container(t){const e=this._get("container");t!==e&&(t&&(t.classList.add(lo.ui),t.classList.add(tCe()),this._attachContainers(t)),e&&(e.classList.remove(lo.ui),mB(e,{top:"",bottom:"",left:"",right:""}),TZ(e)),this._set("container",t))}get height(){const t=this.get("view.height")||0;if(t===0)return t;const e=this._getViewPadding(),i=e.top+e.bottom;return Math.max(t-i,0)}get padding(){return this._get("padding")}set padding(t){t?this._override("padding",t):this._clearOverride("padding")}castPadding(t){return typeof t=="number"?{bottom:t,top:t,right:t,left:t}:E(E({},rge),t)}get width(){const t=this.get("view.width")||0;if(t===0)return t;const e=this._getViewPadding(),i=e.left+e.right;return Math.max(t-i,0)}add(t,e){let i,r;if(Array.isArray(t))return void t.forEach(n=>this.add(n,e));const s=fB(t);s&&({index:i,position:e,component:t,key:r}=s),e&&typeof e=="object"&&({index:i,key:r,position:e}=e),!t||e&&!this._isValidPosition(e)||this._add(t,e,i,r)}remove(t,e){if(!t)return;if(Array.isArray(t))return t.map(r=>this.remove(r,e));const i=this._find(t);if(i){const r=this._componentToKey;if(r.has(t)&&r.get(t)!==e)return;const s=this._components.indexOf(i);return i.node.parentNode&&i.node.parentNode.removeChild(i.node),this._componentToKey.delete(t),this._components.splice(s,1)[0]}}empty(t){return Array.isArray(t)?t.map(e=>this.empty(e)).reduce((e,i)=>e.concat(i)):(t=t||pB)===pB?Array.prototype.slice.call(this._manualContainer.children).filter(e=>!e.classList.contains(lo.corner)).map(e=>this.remove(e)):this._isValidPosition(t)?Array.prototype.slice.call(this._cornerNameToContainerLookup[t].children).map(this.remove,this):null}move(t,e){if(Array.isArray(t)&&t.forEach(n=>this.move(n,e)),!t)return;let i;const r=fB(t)||fB(e);if(r&&(i=r.index,e=r.position,t=r.component||t),e&&!this._isValidPosition(e))return;const s=this.remove(t);s&&this.add(s,{position:e,index:i})}find(t){if(!t)return null;const e=this._findById(t);return e&&(e.widget||e.node)}getPosition(t){for(const e in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[e].contains(t))return e;return null}_add(t,e,i,r){t instanceof H4||(t=new H4({node:t})),this._place({component:t,position:e,index:i}),this._components.push(t),r&&this._componentToKey.set(t,r)}_find(t){return t?t instanceof H4?this._findByComponent(t):typeof t=="string"?this._findById(t):this._findByNode(t.domNode||t):null}_getViewPadding(){return this.get("view.padding")||nst}_attachContainers(t){t.appendChild(this._innerContainer),t.appendChild(this._manualContainer)}_initContainers(){const t=document.createElement("div");t.classList.add(lo.innerContainer),t.classList.add(lo.cornerContainer);const e=document.createElement("div");e.classList.add(lo.innerContainer),e.classList.add(lo.manualContainer);const i=document.createElement("div");i.classList.add(lo.topLeft),i.classList.add(lo.corner),t.appendChild(i);const r=document.createElement("div");r.classList.add(lo.topRight),r.classList.add(lo.corner),t.appendChild(r);const s=document.createElement("div");s.classList.add(lo.bottomLeft),s.classList.add(lo.corner),t.appendChild(s);const n=document.createElement("div");n.classList.add(lo.bottomRight),n.classList.add(lo.corner),t.appendChild(n),this._innerContainer=t,this._manualContainer=e;const o=yf();this._cornerNameToContainerLookup={"top-left":i,"top-right":r,"bottom-left":s,"bottom-right":n,"top-leading":o?r:i,"top-trailing":o?i:r,"bottom-leading":o?n:s,"bottom-trailing":o?s:n},this._positionNameToContainerLookup=E({manual:e},this._cornerNameToContainerLookup)}_isValidPosition(t){return!!this._positionNameToContainerLookup[t]}_place(t){const e=t.component,i=t.position||pB,r=t.index,s=this._positionNameToContainerLookup[i],n=r>-1;if(ost(e.widget)&&e.widget.startup(),!n)return void s.appendChild(e.node);const o=Array.prototype.slice.call(s.children);if(r===0)return void(s.firstChild?CZ(e.node,s.firstChild):s.appendChild(e.node));r>=o.length?s.appendChild(e.node):CZ(e.node,o[r])}_applyViewPadding(){const t=this.container;t&&mB(t,this._toPxPosition(this._getViewPadding()))}_applyUIPadding(){const t=this._innerContainer;t&&mB(t,this._toPxPosition(this.padding))}_toPxPosition(t){return{top:this._toPxUnit(t.top),left:this._toPxUnit(t.left),right:this._toPxUnit(t.right),bottom:this._toPxUnit(t.bottom)}}_toPxUnit(t){return t===0?"0":t+"px"}_findByComponent(t){let e,i=null;return this._components.some(r=>(e=r===t,e&&(i=r),e)),i}_findById(t){let e,i=null;return this._components.some(r=>(e=r.id===t,e&&(i=r),e)),i}_findByNode(t){let e,i=null;return this._components.some(r=>(e=r.node===t,e&&(i=r),e)),i}};u([d()],dp.prototype,"container",null),u([d()],dp.prototype,"height",null),u([d({value:rge})],dp.prototype,"padding",null),u([ut("padding")],dp.prototype,"castPadding",null),u([d()],dp.prototype,"view",void 0),u([d()],dp.prototype,"width",null),dp=u([R("esri.views.ui.UI")],dp);const ast=dp;function sge(t,e){return t&&"copyright"in t&&(!e||typeof t.originOf=="function"&&t.originOf("copyright")==="user")}function lst(t,e){return t.length!==e.length||t.some((i,r)=>i.text!==e[r].text)}function W4(t,e,i){!i||!e||t.find(r=>r.layerView===e&&r.text===i)||t.push({text:i,layerView:e})}function cst(t){return t.type==="bing-maps"}const rg=[];let Rw=class extends e1{constructor(t){super(t),this.clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.handles.remove("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new We,this.view=null,this._allLayerViewsChange=e=>{this.handles.remove("suspension");const i=this.get("view.allLayerViews");i&&this.handles.add(i.map(r=>r.watch(["suspended","attributionVisible"],this._updateAttributionItems)),"suspension"),e&&e.removed&&e.removed.forEach(r=>{this._pendingAttributions.delete(r),this._fetchedAttributionData.delete(r)}),this._updateAttributionItems()},this._updateAttributionItems=()=>{const e=this.get("view.allLayerViews");rg.length=0,e?(e.forEach(i=>{if(i.suspended||!i.get("layer.attributionVisible"))return;const r=i.layer;if(sge(r,"user"))return void W4(rg,i,r.copyright);if(r.hasAttributionData){if(this._fetchedAttributionData.has(i)){const n=this._fetchedAttributionData.get(i);return void(n?W4(rg,i,this._getDynamicAttribution(n,this.view,r)):sge(r)&&W4(rg,i,r.copyright))}return void this._fetchAttributionData(i)}const s=r.get("portalItem.accessInformation");W4(rg,i,s||r.copyright)}),lst(this.items,rg)&&(this.items.removeAll(),this.items.addMany(rg)),rg.length=0,this.notifyChange("state")):this.clear()},this.handles.add([ks(this,"view.allLayerViews","change",this._allLayerViewsChange,this._allLayerViewsChange,this.clear),dbe(this,"view.stationary",()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"}async _fetchAttributionData(t){if(this._pendingAttributions.has(t))return;this._pendingAttributions.add(t);const e=await zl(t.layer.fetchAttributionData());if(this._pendingAttributions.has(t)){const i=e.ok?this._createContributionIndex(e.value,cst(t.layer)):null;this._pendingAttributions.delete(t),this._fetchedAttributionData.set(t,i)}this._updateAttributionItems()}_createContributionIndex(t,e){const i=t.contributors,r={};if(!i)return r;for(let s=0;s<i.length;s++){const n=i[s],o=n.coverageAreas;if(!o)return;for(const a of o){const l=a.bbox,c=a.zoomMin-(e&&a.zoomMin?1:0),h=a.zoomMax-(e&&a.zoomMax?1:0),p={xmin:l[1],ymin:l[0],xmax:l[3],ymax:l[2],spatialReference:Ue.WGS84},f={extent:Ih(p),attribution:n.attribution||"",score:a.score!=null?a.score:100,id:s};for(let g=c;g<=h;g++)r[g]=r[g]||[],r[g].push(f)}}return r.maxKey=Math.max.apply(null,Object.keys(r)),r}_getDynamicAttribution(t,e,i){const{extent:r,scale:s}=e;let n=i.tileInfo.scaleToZoom(s);if(n=Math.min(t.maxKey,Math.round(n)),!r||n==null||n<=-1)return"";const o=t[n],a=wg(r.center.clone().normalize(),e.spatialReference),l={};return o?o.filter(c=>{const h=!l[c.id]&&a&&ux(c.extent,a);return h&&(l[c.id]=!0),h}).sort((c,h)=>h.score-c.score||c.objectId-h.objectId).map(c=>c.attribution).join(", "):""}};u([d({readOnly:!0,type:We})],Rw.prototype,"items",void 0),u([d({readOnly:!0})],Rw.prototype,"state",null),u([d()],Rw.prototype,"view",void 0),Rw=u([R("esri.widgets.Attribution.AttributionViewModel")],Rw);const nge=Rw,sg={base:"esri-attribution esri-widget",poweredBy:"esri-attribution__powered-by",sources:"esri-attribution__sources",open:"esri-attribution--open",sourcesOpen:"esri-attribution__sources--open",link:"esri-attribution__link",widgetIcon:"esri-icon-description",interactive:"esri-interactive"};let co=class extends Bs{constructor(t,e){super(t,e),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this.iconClass=sg.widgetIcon,this.itemDelimiter=" | ",this.label=void 0,this.messages=null,this.view=null,this.viewModel=new nge}initialize(){this.own(ks(this,"viewModel.items","change",()=>this.scheduleRender()))}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce((t,e)=>(t.indexOf(e.text)===-1&&t.push(e.text),t),[]).join(this.itemDelimiter)}render(){const t={[sg.open]:this._isOpen};return ee("div",{bind:this,class:this.classes(sg.base,t),onclick:this._toggleState,onkeydown:this._toggleState},this.renderSourcesNode(),this.renderPoweredBy())}renderPoweredBy(){return ee("div",{class:sg.poweredBy},"Powered by"," ",ee("a",{class:sg.link,href:"http://www.esri.com/",target:"_blank",rel:"noreferrer"},"Esri"))}renderSourcesNode(){const t=this._isOpen,e=this._isInteractive,i=e?0:-1,{attributionText:r}=this,s=e?"button":void 0,n={[sg.sourcesOpen]:t,[sg.interactive]:e};return ee("div",{afterCreate:this._afterSourcesNodeCreate,afterUpdate:this._afterSourcesNodeUpdate,bind:this,class:this.classes(sg.sources,n),innerHTML:r,role:s,tabIndex:i})}_afterSourcesNodeCreate(t){this._prevSourceNodeHeight=t.clientWidth}_afterSourcesNodeUpdate(t){let e=!1;const{clientHeight:i,clientWidth:r,scrollWidth:s}=t,n=s>=r,o=this._attributionTextOverflowed!==n;if(this._attributionTextOverflowed=n,o&&(e=!0),this._isOpen){const a=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,a&&(this._isOpen=!1,e=!0)}e&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};u([d()],co.prototype,"_isOpen",void 0),u([d()],co.prototype,"_isInteractive",null),u([d()],co.prototype,"_attributionTextOverflowed",void 0),u([d()],co.prototype,"_prevSourceNodeHeight",void 0),u([d({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],co.prototype,"attributionText",null),u([d()],co.prototype,"iconClass",void 0),u([d()],co.prototype,"itemDelimiter",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],co.prototype,"label",void 0),u([d(),qs("esri/widgets/Attribution/t9n/Attribution")],co.prototype,"messages",void 0),u([Ve("viewModel.view")],co.prototype,"view",void 0),u([d({type:nge})],co.prototype,"viewModel",void 0),u([ia()],co.prototype,"_toggleState",null),co=u([R("esri.widgets.Attribution")],co);const ust=co,hst="esri.widgets.CompassViewModel";let Fv=class extends dre(ve){constructor(t){super(t),this._handles=new dt,this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._handles.add(Ke(this,"view",this._updateRotationWatcher))}destroy(){this._handles.destroy(),this._handles=null,this.view=null}get canShowNorth(){const t=this.get("view.spatialReference");return!(!t||!t.isWebMercator&&!t.isGeographic)}get state(){return this.get("view.ready")?this.canShowNorth?"compass":"rotation":"disabled"}reset(){if(!this.get("view.ready"))return;const t={};this.view.type==="2d"?t.rotation=0:t.heading=0,this.callGoTo({target:t})}_updateForRotation(t){t!=null&&(this.orientation={z:t})}_updateForCamera(t){if(!t)return;const e=-t.heading;this.orientation={x:0,y:0,z:e}}_updateRotationWatcher(t){this._handles.removeAll(),t&&(t.type==="2d"?this._handles.add(Ke(this,"view.rotation",this._updateForRotation)):this._handles.add(Ke(this,"view.camera",this._updateForCamera)))}};u([d({readOnly:!0})],Fv.prototype,"canShowNorth",null),u([d()],Fv.prototype,"orientation",void 0),u([d({readOnly:!0})],Fv.prototype,"state",null),u([d()],Fv.prototype,"view",void 0),Fv=u([R(hst)],Fv);const oge=Fv,ng={base:"esri-compass esri-widget--button esri-widget",text:"esri-icon-font-fallback-text",icon:"esri-compass__icon",rotationIcon:"esri-icon-dial",northIcon:"esri-icon-compass",widgetIcon:"esri-icon-locate-circled",interactive:"esri-interactive",disabled:"esri-disabled"};let vh=class extends Bs{constructor(t,e){super(t,e),this.goToOverride=null,this.iconClass=ng.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new oge}reset(){return this.viewModel.reset()}render(){const{orientation:t,state:e}=this.viewModel,i=e==="disabled",r=(e==="rotation"?"rotation":"compass")=="compass",s=i?-1:0,n={[ng.disabled]:i,[ng.interactive]:!i},o={[ng.northIcon]:r,[ng.rotationIcon]:!r},{messages:a}=this;return ee("div",{bind:this,class:this.classes(ng.base,n),onclick:this._reset,onkeydown:this._reset,role:"button",tabIndex:s,"aria-label":a.reset,title:a.reset},ee("span",{"aria-hidden":"true",class:this.classes(ng.icon,o),styles:this._toRotationTransform(t)}),ee("span",{class:ng.text},a.reset))}_reset(){this.viewModel.reset()}_toRotationTransform(t){return{transform:`rotateZ(${t.z}deg)`}}};u([Ve("viewModel.goToOverride")],vh.prototype,"goToOverride",void 0),u([d()],vh.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],vh.prototype,"label",void 0),u([d(),qs("esri/widgets/Compass/t9n/Compass")],vh.prototype,"messages",void 0),u([Ve("viewModel.view")],vh.prototype,"view",void 0),u([d({type:oge})],vh.prototype,"viewModel",void 0),u([ia()],vh.prototype,"_reset",null),vh=u([R("esri.widgets.Compass")],vh);const dst=vh;let Iw=class extends ve{constructor(t){super(t),this._handles=new dt,this.navigationMode="pan",this.view=null}initialize(){this._handles.add(NF(this,"view.inputManager",this._setNavigationMode.bind(this)))}destroy(){this._handles.destroy(),this._handles=null,this.view=null}get state(){return this.get("view.ready")&&this.view.type==="3d"?"ready":"disabled"}toggle(){this.state!=="disabled"&&(this.navigationMode=this.navigationMode!=="pan"?"pan":"rotate",this._setNavigationMode())}_setNavigationMode(){this.get("view.inputManager").primaryDragAction=this.navigationMode==="pan"?"pan":"rotate"}};u([d({readOnly:!0})],Iw.prototype,"state",null),u([d()],Iw.prototype,"navigationMode",void 0),u([d()],Iw.prototype,"view",void 0),Iw=u([R("esri.widgets.NavigationToggleViewModel")],Iw);const age=Iw,Ol={base:"esri-navigation-toggle esri-widget",button:"esri-navigation-toggle__button esri-widget--button",activeButton:"esri-navigation-toggle__button--active",panButton:"esri-navigation-toggle__button--pan",rotateButton:"esri-navigation-toggle__button--rotate",isLayoutHorizontal:"esri-navigation-toggle--horizontal",rotationIcon:"esri-icon-rotate",panIcon:"esri-icon-pan",widgetIcon:"esri-icon-pan2",disabled:"esri-disabled"};let _h=class extends Bs{constructor(t,e){super(t,e),this.iconClass=Ol.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new age}set layout(t){t!=="horizontal"&&(t="vertical"),this._set("layout",t)}toggle(){return this.viewModel.toggle()}render(){const t=this.get("viewModel.state")==="disabled",e=this.get("viewModel.navigationMode")==="pan",i={[Ol.disabled]:t,[Ol.isLayoutHorizontal]:this.layout==="horizontal"},r={[Ol.activeButton]:e},s={[Ol.activeButton]:!e},n=t?-1:0,o=this.messages.toggle;return ee("div",{bind:this,class:this.classes(Ol.base,i),onclick:this._toggle,onkeydown:this._toggle,tabIndex:n,"aria-label":o,title:o},ee("div",{class:this.classes(Ol.button,Ol.panButton,r)},ee("span",{class:Ol.panIcon})),ee("div",{class:this.classes(Ol.button,Ol.rotateButton,s)},ee("span",{class:Ol.rotationIcon})))}_toggle(){this.toggle()}};u([d()],_h.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],_h.prototype,"label",void 0),u([d({value:"vertical"})],_h.prototype,"layout",null),u([d(),qs("esri/widgets/NavigationToggle/t9n/NavigationToggle")],_h.prototype,"messages",void 0),u([Ve("viewModel.view")],_h.prototype,"view",void 0),u([d({type:age})],_h.prototype,"viewModel",void 0),u([ia()],_h.prototype,"_toggle",null),_h=u([R("esri.widgets.NavigationToggle")],_h);const pst=_h,fC={button:"esri-widget--button esri-widget",disabled:"esri-disabled",interactive:"esri-interactive",iconText:"esri-icon-font-fallback-text",icon:"esri-icon"};let og=class extends Bs{constructor(){super(...arguments),this.enabled=!0,this.iconClass="",this.title=""}render(){const t=this.enabled?0:-1,e={[fC.disabled]:!this.enabled,[fC.interactive]:this.enabled},i={[this.iconClass]:!!this.iconClass};return ee("div",{bind:this,class:this.classes(fC.button,e),onclick:this._triggerAction,onkeydown:this._triggerAction,role:"button",tabIndex:t,title:this.title},ee("span",{"aria-hidden":"true",role:"presentation",class:this.classes(fC.icon,i)}),ee("span",{class:fC.iconText},this.title))}_triggerAction(){this.action.call(this)}};u([d()],og.prototype,"action",void 0),u([d()],og.prototype,"enabled",void 0),u([d()],og.prototype,"iconClass",void 0),u([d()],og.prototype,"title",void 0),u([ia()],og.prototype,"_triggerAction",null),og=u([R("esri.widgets.IconButton")],og);const lge=og;let Dw=class extends ve{get canZoomIn(){if(!this.get("view.ready"))return!1;const t=this.get("view.animation.target.scale")||this.get("view.scale"),e=this.get("view.constraints.effectiveMaxScale");return e===0||t>e}get canZoomOut(){if(!this.get("view.ready"))return!1;const t=this.get("view.animation.target.scale")||this.get("view.scale"),e=this.get("view.constraints.effectiveMinScale");return e===0||t<e}};u([d({readOnly:!0})],Dw.prototype,"canZoomIn",null),u([d({readOnly:!0})],Dw.prototype,"canZoomOut",null),u([d()],Dw.prototype,"view",void 0),Dw=u([R("esri.widgets.Zoom.ZoomConditions2D")],Dw);const fst=Dw;let Fw=class extends ve{get canZoomIn(){return!!this.get("view.ready")}get canZoomOut(){return!!this.get("view.ready")}};u([d({readOnly:!0})],Fw.prototype,"canZoomIn",null),u([d({readOnly:!0})],Fw.prototype,"canZoomOut",null),u([d()],Fw.prototype,"view",void 0),Fw=u([R("esri.widgets.Zoom.ZoomConditions3D")],Fw);const mst=Fw;let ag=class extends ve{constructor(t){super(t),this.canZoomIn=!1,this.canZoomOut=!1}destroy(){this.view=null}get state(){return this.get("view.ready")?"ready":"disabled"}set view(t){t?t.type==="2d"?this._zoomConditions=new fst({view:t}):t.type==="3d"&&(this._zoomConditions=new mst({view:t})):this._zoomConditions=null,this._set("view",t)}zoomIn(){if(!this.canZoomIn)return;const t=this.view;t.type==="2d"?t.mapViewNavigation.zoomIn():vD(t.goTo({zoomFactor:2}))}zoomOut(){if(!this.canZoomOut)return;const t=this.view;t.type==="2d"?t.mapViewNavigation.zoomOut():vD(t.goTo({zoomFactor:.5}))}};u([d()],ag.prototype,"_zoomConditions",void 0),u([d({aliasOf:"_zoomConditions.canZoomIn",readOnly:!0})],ag.prototype,"canZoomIn",void 0),u([d({aliasOf:"_zoomConditions.canZoomOut",readOnly:!0})],ag.prototype,"canZoomOut",void 0),u([d({readOnly:!0})],ag.prototype,"state",null),u([d()],ag.prototype,"view",null),ag=u([R("esri.widgets.Zoom.ZoomViewModel")],ag);const cge=ag,mC={base:"esri-zoom esri-widget",horizontalLayout:"esri-zoom--horizontal",zoomInIcon:"esri-icon-plus",zoomOutIcon:"esri-icon-minus",widgetIcon:"esri-icon-zoom-in-magnifying-glass"};let pp=class extends Bs{constructor(t,e){super(t,e),this.iconClass=mC.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new cge}initialize(){this._zoomInButton=new lge({action:this.zoomIn.bind(this),iconClass:mC.zoomInIcon}),this._zoomOutButton=new lge({action:this.zoomOut.bind(this),iconClass:mC.zoomOutIcon})}destroy(){this._zoomInButton.destroy(),this._zoomOutButton.destroy(),this._zoomInButton=null,this._zoomOutButton=null}set layout(t){t!=="horizontal"&&(t="vertical"),this._set("layout",t)}render(){const t=this.viewModel,e={[mC.horizontalLayout]:this.layout==="horizontal"};return this._zoomInButton.enabled=t.state==="ready"&&t.canZoomIn,this._zoomOutButton.enabled=t.state==="ready"&&t.canZoomOut,this._zoomInButton.title=this.messages.zoomIn,this._zoomOutButton.title=this.messages.zoomOut,ee("div",{class:this.classes(mC.base,e)},this._zoomInButton.render(),this._zoomOutButton.render())}zoomIn(){return this.viewModel.zoomIn()}zoomOut(){return this.viewModel.zoomOut()}};u([d()],pp.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],pp.prototype,"label",void 0),u([d({value:"vertical"})],pp.prototype,"layout",null),u([d(),qs("esri/widgets/Zoom/t9n/Zoom")],pp.prototype,"messages",void 0),u([Ve("viewModel.view")],pp.prototype,"view",void 0),u([d({type:cge})],pp.prototype,"viewModel",void 0),pp=u([R("esri.widgets.Zoom")],pp);const gst=pp,uge="esri.views.ui.DefaultUI";function yst(t){return t&&t.view!==void 0}le.getLogger(uge);let Z4=class extends ast{constructor(t){super(t),this._defaultPositionLookup={attribution:"manual",compass:"top-leading","navigation-toggle":"top-leading",zoom:"top-leading"},this.components=[]}initialize(){this._handles.add([Ke(this,"components",this._componentsWatcher.bind(this)),Ke(this,"view",this._updateViewAwareWidgets.bind(this))])}_add(t,e,i,r){if(typeof t=="string"&&this._defaultPositionLookup[t]){if(this._find(t))return;t=this._createComponent(t)}super._add(t,e,i,r)}_removeComponents(t){t.forEach(e=>{const i=this._find(e);i&&(this.remove(i),i.destroy())})}_updateViewAwareWidgets(t){this.components.forEach(e=>{const i=this._find(e),r=i&&i.widget;yst(r)&&(r.view=t)})}_componentsWatcher(t,e){this._removeComponents(e),this._addComponents(t),this._adjustPadding(t)}_adjustPadding(t){if(t.indexOf("attribution")===-1&&!this._isOverridden("padding")){const{top:e}=this.padding;this.padding=e}}_addComponents(t){this.initialized&&t.forEach(e=>this.add(this._createComponent(e),this._defaultPositionLookup[e]))}_createComponent(t){const e=this._createWidget(t);if(e)return new H4({id:t,node:e})}_createWidget(t){return t==="attribution"?this._createAttribution():t==="compass"?this._createCompass():t==="navigation-toggle"?this._createNavigationToggle():t==="zoom"?this._createZoom():void 0}_createAttribution(){return new ust({view:this.view})}_createCompass(){return new dst({view:this.view})}_createNavigationToggle(){return new pst({view:this.view})}_createZoom(){return new gst({view:this.view})}};u([d()],Z4.prototype,"components",void 0),Z4=u([R(uge)],Z4);const vst=Z4;let J4=class extends vst{constructor(t){super(t),this.components=["attribution","zoom","navigation-toggle","compass"]}};u([d()],J4.prototype,"components",void 0),J4=u([R("esri.views.ui.3d.DefaultUI3D")],J4);const hge=J4,Ca=le.getLogger("esri.views.SceneView");let Be=class extends HTe(UFe(t5e(M5e))){constructor(t){super(t),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new Um({slicePlane:fQ},this),this._resourceController=jQe(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new s7({view:this}),this.labeler=new yv({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new bse,this.environmentManager=new ju,this.extent=null,this.floors=new We,this.windowDevicePixelRatio=1,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new $5e({view:this}),this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new DJe,this.scale=null,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new hge,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new ej,y2e(),t&&t.environment||(this._defaults.environment=new q_,this.environment=this._defaults.environment);const e=r=>{_(r)&&r.type===4||(this.updatingChanged(),this.map&&this.map.allLayers.forEach(async s=>{try{await s.when()}catch{}this.updatingChanged()}))};this.handles.add([ks(this,"map.allLayers","after-changes",e,e,e,!0),this.allLayerViews.on("after-changes",r=>this._updateUpdatingMonitors(r)),this.watch("map",r=>{r&&r.load&&r.load().catch(()=>{})})]),this.inputManager=new KVe({view:this});const i=()=>{const r=window.devicePixelRatio;r!==this.windowDevicePixelRatio&&(this.windowDevicePixelRatio=r,this.notifyChange("pixelRatio"))};this.stateManager=new lQe({view:this,updateDevicePixelRatio:i})}initialize(){this.groundView=new e5e({view:this}),this._updateUpdatingMonitors();const t=()=>this._updateDefaultToMapOptions();this.handles.add(ks(this,"map.allLayers","after-changes",t,t,t)),this.updatingHandles.add(this.qualitySettings,"memoryLimit",e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},2),this.updatingHandles.add(this.qualitySettings,"additionalCacheMemory",e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},2),this.updatingHandles.add(this.qualitySettings,"frameRate",e=>f0e(e>0?1e3/Math.ceil(e):0),2),this.updatingHandles.add(Kt,"SCENEVIEW_LOCKING_LOG",e=>this.defaultsFromMap.logDebugInformation=e,2),this.updatingHandles.add(this,"map.ground",t,3),this.updatingHandles.add(this,"map.ground.opacity",()=>this._updateDefaultHitTestOptions(),3),this.handles.add(this.watch("spatialReference",()=>this.notifyChange("clippingArea"),!0))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=tt(this.sharedSymbolResources),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController=tt(this._resourceController),this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView=tt(this.groundView))}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain&&this.basemapTerrain.spatialReference}installContentCameraReset(t={sticky:!1}){return this.stateManager.installContentCameraReset(t)}get clippingArea(){if(this.viewingMode==="global")return null;let t=this._userClippingArea||this.get("map.clippingArea");return!(!!this._userClippingArea||this.get("map.clippingEnabled"))||A(t)?(this._clippingArea=null,null):t instanceof ht?this.spatialReference&&(t=Q4(t,this.spatialReference),A(t))?(Ca.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),A(t.intersection(this.groundAndLayersExtent))&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(Ca.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(t){this.ready&&this.viewingMode==="global"&&_(t)?Ca.error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=t}get renderDataExtent(){if(this.state.viewingMode===1)return null;const t=this.renderSpatialReference,e=this.dataExtent;return A(e)||A(t)||e.spatialReference.equals(t)?e:Q4(e,t)}get dataExtent(){let t=this.groundAndLayersExtent;const e=this.spatialReference||Ue.WGS84,i=Q4(this.clippingArea,e);_(i)&&(t=_(t)?t.intersection(i):i);const r=this._get("dataExtent");return _(t)&&t.equals(r)?r:t}get groundAndLayersExtent(){const t=this.spatialReference||Ue.WGS84;let e;const i=n=>{const o=Q4(n,t);A(o)||(_(e)?e.union(o):e=o.clone())},r=this.basemapTerrain;if(r!=null&&r.spatialReference){const n=r.groundExtent;i(new ht({xmin:n[0],ymin:n[1],zmin:0,xmax:n[2],ymax:n[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const n=o=>{!_(o.fullExtent)||o.type==="graphics"&&o.internal||i(o.fullExtent)};this.map.allLayers.forEach(o=>n(o))}if(A(e))return null;e.hasZ?(e.zmin=Math.min(0,e.zmin),e.zmax=Math.max(0,e.zmax)):(e.zmin=0,e.zmax=0);const s=this._get("groundAndLayersExtent");return e.equals(s)?s:e}set environment(t){t!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",t)}castEnvironment(t){return t?t instanceof q_?t:t instanceof Ase?this.environment!=null?this.environment.cloneWithWebsceneEnvironment(t):q_.fromWebsceneEnvironment(t):Ni(q_,t):new q_}get pixelRatio(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)}set pixelRatio(t){_(t)?this._override("pixelRatio",t):this._clearOverride("pixelRatio")}get maximumPixelRatio(){let t=1/0;const{maximumPixelRatio:e,maximumRenderResolution:i}=this.qualitySettings;if(e!=null&&(t=Math.min(t,e)),i!=null){const r=i/Math.max(this.width,this.height);t=Math.min(t,r)}return t}set maximumPixelRatio(t){_(t)?this._override("maximumPixelRatio",t):this._clearOverride("maximumPixelRatio")}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||_(this.activeTool)}get stationary(){return!this.animation&&!this.resizing&&(A(this.state)||this.state.stationary)}set qualityProfile(t){RI.isValidProfile(t)&&(RI.apply(t,this.qualitySettings),this._set("qualityProfile",t))}get qualityProfile(){return this._get("qualityProfile")||RI.getDefaultProfile()}set slicePlane(t){if(_(this._stage)&&this._stage.renderView.setRenderParameters({slicePlane:t}),A(t))return void this._set("slicePlane",null);const e=this.propertiesPool.get("slicePlane");V1(t,e),this._set("slicePlane",e)}get typeSpecificPreconditionsReady(){return!!this.viewingMode}get resolution(){return this.spatialReference!=null?IQ(this.scale,this.spatialReference):0}get heightModelInfo(){const t=this.getDefaultHeightModelInfo();return t!=null?ay.deriveUnitFromSR(t,this.spatialReference):null}get updating(){var t,e,i;if(this.destroyed)return!1;let r=0,s=this.layerViewManager.updating,n=s?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(o=>{if(o.isFulfilled()){if(o.updating){if(s=!0,o.suspended||nw(o))return;++n,r+=o.updatingProgress}}else++n});for(const o of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.featureTreeDebugger,this.toolViewManager,this.analysisViewManager])if(_(o)&&o.updating){const a=.1;n+=a,r+=.5*a}for(const o of[this.deconflictor,this.labeler,this.basemapTerrain])_(o)&&o.updating&&(++n,r+=o.updatingProgress);if(s=!!(s||n>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||(t=this.inputManager)!=null&&t.hasPendingInputs||(e=this.map)!=null&&(i=e.allLayers)!=null&&i.some(o=>!o.isFulfilled())),s?(this._numUpdating=Math.max(n,this._numUpdating),r+=this._numUpdating-n):this._numUpdating=0,this._numUpdating>0?r/=this._numUpdating:r=s?0:1,this._get("updatingProgress")!==r){const o=this._resourceController.scheduler.now;if(r<1){const a=Math.min((o-this._lastUpdateTime)/2e3,1);r=this.updatingProgress*(1-a)+r*a}this._set("updatingProgress",r),this._lastUpdateTime=s&&r<1?o:0}return s}get viewingMode(){var t;const e=this._predeterminedViewingMode;if(_(e))return $S(e);const i=this.spatialReference;return _((t=this.defaultsFromMap)==null?void 0:t.viewingMode)&&i&&i.equals(this.defaultsFromMap.spatialReference)?$S(this.defaultsFromMap.viewingMode):!i||TO(i,1)?"global":"local"}set viewingMode(t){this.ready?Ca.error("#viewingMode","viewingMode cannot be set once view is ready"):t?this._override("viewingMode",t):t===void 0&&this._clearOverride("viewingMode")}get resourceController(){return this._resourceController}get performanceInfo(){return new hYe(this)}forceAnimationTime(t){this._stage.renderView.forcedAnimationTime=this.basemapTerrain.overlayManager.forcedAnimationTime=t}on(t,e,i,r){return this.viewEvents.on(t,e,i,r)||super.on(t,e)}hasEventListener(t){return super.hasEventListener(t)||this.viewEvents.hasHandler(t)}toMap(t,e){if(!this.ready)return Ca.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=e?this.externalToInternalIntersectOptions(e):this._defaultToMapOptions,r=_(i.graphics)&&(_(i.graphics.include)||_(i.graphics.exclude)),s=Qre(t)?Jre(this,t):t,n=Gh(s);i.enableDraped=i.include&&!i.include.has(T0)||i.exclude&&i.exclude.has(T0);const o=this.sceneIntersectionHelper,a=nl(this.state.viewingMode);if(a.options.selectionMode=!0,a.options.store=r?2:0,o.intersectIntersectorScreen(n,a,i),r){for(const l of a.results.all){const c=ege(l,this);if(A(c))return this._intersectResultToMapPoint(l);if(this._testGraphicUidFilter(i.graphics,c))return this._intersectResultToMapPoint(l)}return null}return this._intersectResultToMapPoint(a.results.min)}toScreen(t){if(!this.ready)return Ca.error("#toScreen()","Scene view cannot be used before it is ready"),null;const e=st(t.z==null&&wc(this.elevationProvider,t),0);return Gr(t,Lw,this.renderSpatialReference,e),this.state.camera.projectToScreen(Lw,gB),Zl(gB[0],gB[1])}pixelSizeAt(t){return this.ready?t?(Gr(t,Lw,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(Lw)):0:(Ca.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(t){const e=this.basemapTerrain.overlayManager;return e?e.overlayPixelSizeInMapUnits(t):1}hitTest(t,e){if(!this.ready)return Ca.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=Qre(t)?Jre(this,t):t,r=Ii(i.x,i.y),s=e?this.externalToInternalIntersectOptions(e):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const n=nl(this.state.viewingMode);n.options.selectionMode=!0,n.options.store=2,this.sceneIntersectionHelper.intersectIntersectorScreen(r,n,s);const o=this._intersectResultsToHits(n.results.all,s.graphics),a=n.results.ground,l=Kme(a,this),c=_(l)&&"type"in l&&l.type==="integrated-mesh"?l:null,h={screenPoint:i,results:o,ground:{mapPoint:this._intersectResultToMapPoint(a),distance:Bu(a)?a.distanceInRenderSpace:0,layer:c}};return Kt.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=n),Promise.resolve(h)}popupHitTest(t){return Yrt(this,t).then(({results:e,ground:i})=>{let r=null;return!(e.length===0||Math.abs(st(e[0].distance,0)-i.distance)<1e-5)||i.layer&&i.layer.type==="integrated-mesh"||(r=i.mapPoint),{results:e,screenPoint:t,mapPoint:r}})}goTo(t,e){return this.updatingHandles.addPromise(this.stateManager.goTo(t,e))}async whenAnalysisView(t){if(A(t.parent))throw new Q("view:no-analysisview-for-analysis","The analysis has not been added to an AnalysisLayer or SceneView.analyses",{analysis:t});return t.parent.type==="analysis"?(await this.whenLayerView(t.parent)).whenAnalysisView(t):this.analysisViewManager.whenAnalysisView(t)}whenLayerView(t){return super.whenLayerView(t)}takeScreenshot(t){return this.whenReady().then(()=>{const e=hqe(t,this);for(const i of this.map.allLayers.items)i.type==="voxel"&&(e.renderScreenshotTwice=!0);return e.pixelRatio/=this.pixelRatio,this._stage.renderView.takeScreenshot(gqe(e,this.supersampleScreenshotsEnabled,this.padding))})}addUpdatingPromise(t){return this.updatingHandles.addPromise(t)}importLayerView(t){return fse.importLayerView(t)}hasLayerViewModule(t){return fse.hasLayerViewModule(t)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var t,e,i,r;return this.map&&"initialViewProperties"in this.map&&((t=this.map)==null||(e=t.initialViewProperties)==null?void 0:e.spatialReference)||((i=this.defaultsFromMap)==null?void 0:i.spatialReference)||((r=this.defaultsFromMap)==null?void 0:r.ready)&&this._initialDefaultSpatialReference||null}async validate(){let t=ist();if(ae("safari")&&ae("safari")<9&&(t=new Q("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:ae("safari")})),_(t))throw Ca.warn("#validate()",t.message),t}get _predeterminedViewingMode(){var t,e;const i=this._isOverridden("viewingMode")?this._get("viewingMode"):(t=this.map&&"initialViewProperties"in this.map?(e=this.map.initialViewProperties)==null?void 0:e.viewingMode:null)!=null?t:null;return _(i)?cse(i):null}getSpatialReferenceSupport({spatialReference:t,layer:e}){const i=this._predeterminedViewingMode;if(_(i))return this._validateSpatialReferenceForViewingMode(t,e,i)?{constraints:this._makeSpatialReferenceConstraints(t,e,i)}:null;const r=this._validateSpatialReferenceForViewingMode(t,e,2),s=this._validateSpatialReferenceForViewingMode(t,e,1);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(t,e,null)}:r?{constraints:this._makeSpatialReferenceConstraints(t,e,2)}:{constraints:this._makeSpatialReferenceConstraints(t,e,1)}:null}_validateSpatialReferenceForViewingMode(t,e,i){return!!TO(t,i)&&(!!A(e)||(!hA(e)||!A(jI(e,t,i)))&&(e.type!=="voxel"||i===2))}_makeSpatialReferenceConstraints(t,e,i){return e&&!hA(e)&&e.type!=="voxel"&&(t.isWebMercator||t.isWGS84)?[{spatialReference:t,viewingMode:i},{spatialReference:t.isWebMercator?Ue.WGS84:Ue.WebMercator,viewingMode:i}]:[{spatialReference:t,viewingMode:i}]}_validateSpatialReference(t){const e=_(this.getSpatialReferenceSupport({spatialReference:t})),i=this._predeterminedViewingMode;return e||(_(i)?Ca.warnOnce(`Spatial reference defined on view not supported in ${$S(i)} viewing mode.`):t.isGeographic&&Ca.warnOnce("Spatial reference is geographic but not supported.")),e}whenReady(){return new Promise(t=>{this.ready?t(this):this._resolveWhenReady.push(t)})}computeMapPointFromVec3d(t,e){let i=this.spatialReference||Ue.WGS84;return Ns(t,this.renderSpatialReference,t,i)||(i=Ue.WGS84,Ns(t,this.renderSpatialReference,t,i)),e?(e.x=t[0],e.y=t[1],e.z=t[2],e.spatialReference=i):e=new je(t,i),e}trackGraphicState(t){if(!t.graphic)return Ca.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const e=this.getViewForGraphic(t.graphic);let i=null,r=!1;const s=n=>{!r&&_(n)&&"graphics3d"in n&&n.graphics3d&&n.graphics3d.graphicsCore&&(i=n.graphics3d.graphicsCore.trackGraphicState(t))};return _(e)?s(e):this.whenViewForGraphic(t.graphic,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{r=!0,_(i)&&(i.remove(),i=null)}}}highlight(t){if(Array.isArray(t))return Gw(t.map(i=>this.highlight(i)));if(We.isCollection(t))return Gw(t.toArray().map(i=>this.highlight(i)));const e=this.getViewForGraphic(t);return e&&"highlight"in e?e.highlight(t):pg()}maskOccludee(t){if(!t)return Ca.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const e=this.getViewForGraphic(t);let i=null,r=!1;const s=n=>{!r&&_(n)&&"graphics3d"in n&&CFe(n)&&(i=n.maskOccludee(t))};return _(e)?s(e):this.whenViewForGraphic(t,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{r=!0,_(i)&&(i.remove(),i=null)}}}getViewForGraphic(t){return t.layer===this.graphics?this.graphicsView:t.layer?this.allLayerViews.find(e=>e.layer===t.layer):null}graphicChanged(t){_(this.graphicsView)&&this.graphicsView.graphicChanged(t)}async whenViewForGraphic(t,e){if(t.layer===this)return await _x(this,"graphicsView"),this.graphicsView;if(!t.layer||!this.map)throw new Q("no-view-for-graphic");return e&&e.waitForLayer&&!this.map.allLayers.includes(t.layer)?new Promise((i,r)=>{const s=this.map.allLayers.on("change",n=>{n.added.indexOf(t.layer)!==-1&&(s.remove(),this.whenLayerView(t.layer).then(i,r))})}):this.whenLayerView(t.layer)}externalToInternalIntersectOptions(t){const e=this._externalToInternalRenderItems(t.include,0),i=this._externalToInternalRenderItems(t.exclude,1);return{include:e.layerUids,exclude:i.layerUids,graphics:{include:e.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(t,e){return t.getIntersectionPoint(Lw)?(e=this.computeMapPointFromVec3d(Lw,e),t.intersector===2&&this.basemapTerrain&&(e.z=st(wc(this.basemapTerrain,e),0)),e):null}_intersectResultsToHits(t,e){const i=new Array;let r=null;for(let s=0;s<t.length;s++){const n=t[s],o=Kme(n,this);if(_(o)&&(o===this.map.ground||"type"in o&&o.type==="integrated-mesh"))break;const a=ege(n,this);if(!_(a))continue;if(A(r)&&s!==t.length-1&&(r=new Set),_(r)){const h=this._getGraphicFilterUid(a);if(r.has(h))continue;r.add(h)}if(!this._testGraphicUidFilter(e,a))continue;const l=this._intersectResultToMapPoint(n),c=n.distanceInRenderSpace;i.push({graphic:a,mapPoint:l,distance:c})}return i}_getGraphicFilterUid(t){if(t.layer&&"objectIdField"in t.layer){const e=t.attributes[t.layer.objectIdField];if(e)return`o-${t.layer.id}-${e}`}return`u-${t.uid}`}_testGraphicUidFilter(t,e){const i=this._getGraphicFilterUid(e);return A(t)||(A(t.include)||t.include.has(i))&&(A(t.exclude)||!t.exclude.has(i))}_externalToInternalRenderItems(t,e,i={layerUids:null,graphicUids:null}){if(!t)return i;if(t instanceof pn)_st(i,this._getGraphicFilterUid(t)),e===0&&(_(this.graphicsView)&&t.layer===this?gC(i,this.graphicsView.graphics3d.layer.id):t.layer&&gC(i,t.layer.uid));else if(Gxe(t))for(const r of t)r===this.graphics&&_(this.graphicsView)?gC(i,this.graphicsView.graphics3d.layer.id):r instanceof vx?r===this.map.ground&&gC(i,T0):this._externalToInternalRenderItems(r,e,i);else gC(i,t.uid);return i}_initBasemapTerrain(){this._set("basemapTerrain",new uet({view:this})),this._set("elevationProvider",new E3({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Cpe({view:this})),this._set("featureTiles",new Zde({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const t=()=>{const e=this.basemapTerrain&&this.basemapTerrain.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const i=_(this.basemapTerrain.extent)?f2(lP(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;_(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(i):this.featureTiles.filterExtent=i}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(Kt,"FEATURE_TILE_TREE_SHOW_TILES",e=>{e&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(import("./FeatureTileTree3DDebugger.ed1ba9f9.js")).then(({FeatureTileTree3DDebugger:i})=>{!this.featureTreeDebugger&&Kt.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new i({view:this}))}):e||!this.featureTreeDebugger||Kt.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null)},3),this.updatingHandles.add(this,"clippingArea",t,3),this.updatingHandles.add(this,"basemapTerrain.extent",t,3)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new PQe(this.map,t));const e=this.state.isGlobal,i=OQ(e,t);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",DI.create(this.state.viewingMode,i)),e||this.handles.add(this.watch("basemapTerrain.extent",r=>{const s=this.renderCoordsHelper.spatialReference;r[0]===0&&r[1]===0&&r[2]===0&&r[3]===0||!WP(r,this.basemapTerrain.spatialReference,dge,s)||(this.renderCoordsHelper.extent=dge)},!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(db/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(t=null){_(t)&&t.type===4||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.handles.add([e.watch(["updating","updatingProgress"],()=>this.updatingChanged(),!0)],"updatingMonitors"),e.when(()=>this.updatingChanged(),()=>this.updatingChanged()))}),this.updatingChanged())}_renderScreenshotOverlay(t,e){if(!this.overlay||!this.overlay.hasVisibleItems)return e;const i=t.getContext("2d");return i.putImageData(e,0,0),this.overlay.renderCanvas(t),i.getImageData(0,0,e.width,e.height)}_initStage(){const t={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(a,l)=>this._renderScreenshotOverlay(a,l)}},e=new pQe(this.state.viewingMode,a=>this._stage.layers.forAll(a),this);this._set("sceneIntersectionHelper",e);const i=MP(this.surface),{resourceController:r,state:s,renderSpatialReference:n}=this;this._stage=new ao({options:t,container:i,resourceController:r,state:s,sceneIntersectionHelper:e,renderSR:n}),this._lostWebGLContextHandle=qC(this._stage.renderView.canvas,"webglcontextlost",()=>this.fatalError=new Q("webgl-context-lost")),this.handles.add([this.updatingHandles.add(this.qualitySettings,"antialiasingEnabled",()=>{this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})},2),this.updatingHandles.add(this.qualitySettings,"highQualityTransparency",()=>{this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency})},2),Ke(this,"magnifier",a=>this._stage.renderView.magnifier=a,!0)],"stage");const o=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:ej.toEngineOptions(this.highlightOptions)})};for(const a of["highlightOptions","highlightOptions.color","highlightOptions.haloColor","highlightOptions.haloOpacity","highlightOptions.fillOpacity","highlightOptions.shadowOpacity","highlightOptions.shadowColor","highlightOptions.shadowDifference"])this.handles.add(this.updatingHandles.add(this,a,o),"stage");o(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(db/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}_initSurface(t){this._exitSurface(),this.state.init(t,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new pYe({view:this,viewingMode:t,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new mJe})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const t=()=>{this._createGraphicsViewController=null,this.updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(t,t),this.updatingChanged()}async _createGraphicsViewAsync(t){const e=(await import("./GraphicsView3D.244d9dcd.js")).default;Dt(t),await bx(this.basemapTerrain,"ready",t),this._set("graphicsView",new e({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),_(this.graphicsView)&&(this.handles.remove(this.graphicsView.graphics3d.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const t=cse(this.viewingMode);if(t===1&&(this._clippingArea=null),this._initSurface(t),this._set("ready",!0),this.handles.add(ks(this,"graphics","after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const i=this.get("map.initialViewProperties.environment");i&&(this.environment=i)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const e=this._resolveWhenReady;this._resolveWhenReady=[],e.forEach(i=>i(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(T0);for(const t of this.map.allLayers.items)t.type==="integrated-mesh"&&this._defaultToMapOptions.include.add(t.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(T0);for(const t of this.map.allLayers.items)t.type==="integrated-mesh"&&t.opacity<1&&this._defaultToMapOptions.exclude.add(t.uid)}}getVoxelWasmPerSceneView(){return j1.getInstance().getVoxelWasmPerSceneView(this)}};function gC(t,e){t.layerUids||(t.layerUids=new Set),t.layerUids.add(e)}function _st(t,e){t.graphicUids||(t.graphicUids=new Set),t.graphicUids.add(e)}function Q4(t,e){return _(t)&&O1(t.spatialReference,e)?f2(t,e):null}u([d()],Be.prototype,"_userClippingArea",void 0),u([d()],Be.prototype,"_resourceController",void 0),u([d()],Be.prototype,"_stage",void 0),u([d({readOnly:!0})],Be.prototype,"deconflictor",void 0),u([d({readOnly:!0})],Be.prototype,"labeler",void 0),u([d({type:j_,readOnly:!0,aliasOf:"state.animation"})],Be.prototype,"animation",void 0),u([d({readOnly:!0})],Be.prototype,"basemapTerrain",void 0),u([d({readOnly:!0})],Be.prototype,"elevationProvider",void 0),u([d({type:yo,aliasOf:"stateManager.camera"})],Be.prototype,"camera",void 0),u([d({type:yo,aliasOf:"stateManager.contentCamera"})],Be.prototype,"contentCamera",void 0),u([d({readOnly:!0})],Be.prototype,"canvas",void 0),u([d({type:je,aliasOf:"stateManager.center"})],Be.prototype,"center",void 0),u([d({type:ht})],Be.prototype,"clippingArea",null),u([d({type:bse})],Be.prototype,"constraints",void 0),u([d({type:ht,readOnly:!0})],Be.prototype,"renderDataExtent",null),u([d({type:ht,readOnly:!0})],Be.prototype,"dataExtent",null),u([d({type:ht,readOnly:!0})],Be.prototype,"groundAndLayersExtent",null),u([d({value:null,type:q_})],Be.prototype,"environment",null),u([ut("environment")],Be.prototype,"castEnvironment",null),u([d({readOnly:!0})],Be.prototype,"environmentManager",void 0),u([d({type:ht,aliasOf:"stateManager.extent"})],Be.prototype,"extent",void 0),u([d()],Be.prototype,"floors",void 0),u([d({readOnly:!0,aliasOf:"stateManager.screenCenter"})],Be.prototype,"screenCenter",void 0),u([d({type:Number})],Be.prototype,"pixelRatio",null),u([d({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],Be.prototype,"maximumPixelRatio",null),u([d({aliasOf:"stateManager.frustum"})],Be.prototype,"frustum",void 0),u([d({type:Number,readOnly:!0})],Be.prototype,"fullOpacity",void 0),u([d({readOnly:!0})],Be.prototype,"graphicsView",void 0),u([d({readOnly:!0})],Be.prototype,"analysisViewManager",void 0),u([d()],Be.prototype,"groundView",void 0),u([d({type:Boolean})],Be.prototype,"initialExtentRequired",null),u([d()],Be.prototype,"_defaultsFromMapSettings",null),u([d({type:Boolean,readOnly:!0})],Be.prototype,"interacting",null),u([d()],Be.prototype,"stationary",null),u([d({aliasOf:"state.navigating"})],Be.prototype,"navigating",void 0),u([d()],Be.prototype,"map",void 0),u([d({readOnly:!0})],Be.prototype,"mapCoordsHelper",void 0),u([d({aliasOf:"stateManager.padding"})],Be.prototype,"padding",void 0),u([d({type:Cpe,readOnly:!0})],Be.prototype,"pointsOfInterest",void 0),u([d({type:Zde,readOnly:!0})],Be.prototype,"featureTiles",void 0),u([d()],Be.prototype,"featureTreeDebugger",void 0),u([d({type:Boolean})],Be.prototype,"screenSizePerspectiveEnabled",void 0),u([d({constructOnly:!0})],Be.prototype,"deactivatedWebGLExtensions",void 0),u([d({constructOnly:!0})],Be.prototype,"debugWebGLExtensions",void 0),u([d({constructOnly:!0})],Be.prototype,"renderCanvas",void 0),u([d({constructOnly:!0})],Be.prototype,"state",void 0),u([d({readOnly:!0})],Be.prototype,"inputManager",void 0),u([d({readOnly:!0})],Be.prototype,"stateManager",void 0),u([d({type:["low","medium","high"]})],Be.prototype,"qualityProfile",null),u([d({type:fpe,get(){let t=this._get("qualitySettings");return t||(t=new fpe,RI.apply(this.qualityProfile,t)),t}})],Be.prototype,"qualitySettings",void 0),u([d()],Be.prototype,"slicePlane",null),u([d({readOnly:!0})],Be.prototype,"typeSpecificPreconditionsReady",null),u([d({readOnly:!0})],Be.prototype,"renderCoordsHelper",void 0),u([d({readOnly:!0})],Be.prototype,"sceneIntersectionHelper",void 0),u([d({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Be.prototype,"resolution",null),u([d({type:Number,aliasOf:"stateManager.scale"})],Be.prototype,"scale",void 0),u([d()],Be.prototype,"heightModelInfo",null),u([d()],Be.prototype,"spatialReference",void 0),u([d({type:Boolean,constructOnly:!0})],Be.prototype,"alphaCompositingEnabled",void 0),u([d({type:Boolean})],Be.prototype,"supersampleScreenshotsEnabled",void 0),u([d({readOnly:!0})],Be.prototype,"type",void 0),u([d({type:hge})],Be.prototype,"ui",void 0),u([d({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating"]})],Be.prototype,"updating",null),u([d({type:Number,readOnly:!0,dependsOn:["updating"]})],Be.prototype,"updatingProgress",void 0),u([d({type:["global","local"]})],Be.prototype,"viewingMode",null),u([d({type:ec,aliasOf:"stateManager.viewpoint"})],Be.prototype,"viewpoint",void 0),u([d({type:Number,aliasOf:"stateManager.zoom"})],Be.prototype,"zoom",void 0),u([d({type:ej})],Be.prototype,"highlightOptions",void 0),Be=u([R("esri.views.SceneView")],Be);const Lw=$(),gB=Ii(),dge=pt(),hlt=Be,bst={type:xc,json:{origins:{service:{read:{source:["tileInfo","minScale","maxScale","minLOD","maxLOD"],reader:wst}}}}};function wst(t,e,i,r){if(!t)return null;const{minScale:s,maxScale:n,minLOD:o,maxLOD:a}=e;if(o!=null&&a!=null)return r&&r.ignoreMinMaxLOD?xc.fromJSON(t):xc.fromJSON(he(E({},t),{lods:t.lods.filter(({level:l})=>l!=null&&l>=o&&l<=a)}));if(s!==0&&n!==0){const l=p=>Math.round(1e4*p)/1e4,c=s?l(s):1/0,h=n?l(n):-1/0;return xc.fromJSON(he(E({},t),{lods:t.lods.filter(p=>{const f=l(p.scale);return f<=c&&f>=h})}))}return xc.fromJSON(t)}class kw{constructor(){this.location={left:0,top:0,width:0,height:0},this._allAvailability="unknown",this.byteSize=40}getAvailability(e,i){if(this._allAvailability!=="unknown")return this._allAvailability;const r=(e-this.location.top)*this.location.width+(i-this.location.left),s=r%8,n=r>>3,o=this._tileAvailabilityBitSet;return n<0||n>o.length?"unknown":o[n]&1<<s?"available":"unavailable"}_updateFromData(e){const i=this.location.width,r=this.location.height;let s=!0,n=!0;const o=Math.ceil(i*r/8),a=new Uint8Array(o);let l=0;for(let c=0;c<e.length;c++){const h=c%8;e[c]?(n=!1,a[l]|=1<<h):s=!1,h===7&&++l}n?this._allAvailability="unavailable":s?this._allAvailability="available":(this._allAvailability="unknown",this._tileAvailabilityBitSet=a,this.byteSize+=a.length)}static fromDefinition(e,i){const r=e.service.request||vt,{row:s,col:n,width:o,height:a}=e,l={query:{f:"json"}};return i=i?E(E({},l),i):l,r(xst(e),i).then(c=>c.data).catch(c=>{if(c&&c.details&&c.details.httpStatus===422)return{location:{top:s,left:n,width:o,height:a},valid:!0,data:Mye(o*a,0)};throw c}).then(c=>{if(c.location&&(c.location.top!==s||c.location.left!==n||c.location.width!==o||c.location.height!==a))throw new Q("tilemap:location-mismatch","Tilemap response for different location than requested",{response:c,definition:{top:s,left:n,width:o,height:a}});return kw.fromJSON(c)})}static fromJSON(e){kw.validateJSON(e);const i=new kw;return i.location=Object.freeze(ie(e.location)),i._updateFromData(e.data),Object.freeze(i)}static validateJSON(e){if(!e||!e.location)throw new Q("tilemap:missing-location","Location missing from tilemap response");if(e.valid===!1)throw new Q("tilemap:invalid","Tilemap response was marked as invalid");if(!e.data)throw new Q("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(e.data))throw new Q("tilemap:data-mismatch","Data must be an array of numbers");if(e.data.length!==e.location.width*e.location.height)throw new Q("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}}function pge(t){return`${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`}function xst(t){let e;if(t.service.type==="vector-tile")e=`${t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`;else{const r=t.service.tileServers;e=`${r&&r.length?r[t.row%r.length]:t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`}const i=t.service.query;return i&&(e=`${e}?${i}`),e}var Lv;const Sst=le.getLogger("esri.layers.support.TilemapCache");let jc=Lv=class extends tu(ve){constructor(t){super(t),this._pendingTilemapRequests={},this._availableLevels={},this.levels=5,this.cacheByteSize=2097152,this.request=vt,this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new zte(this.cacheByteSize),this.handles.add([this.watch(["layer.parsedUrl","layer.tileServers?","layer.apiKey?","layer.customParameters?"],()=>this._initializeTilemapDefinition()),Ke(this,"layer.tileInfo.lods",t=>this._initializeAvailableLevels(t),!0)]),this._initializeTilemapDefinition()}castLevels(t){return t<=2?(Sst.error("Minimum levels for Tilemap is 3, but got ",t),3):t}get size(){return 1<<this.levels}fetchTilemap(t,e,i,r){if(!this._availableLevels[t])return Promise.reject(new Q("tilemap-cache:level-unavailable",`Level ${t} is unavailable in the service`));const s=this._tmpTilemapDefinition,n=this._tilemapFromCache(t,e,i,s);if(n)return Promise.resolve(n);const o=r&&r.signal;return r=he(E({},r),{signal:null}),new Promise((a,l)=>{ps(o,()=>l($t()));const c=pge(s);let h=this._pendingTilemapRequests[c];if(!h){h=kw.fromDefinition(s,r).then(f=>(this._tilemapCache.put(c,f,f.byteSize),f));const p=()=>delete this._pendingTilemapRequests[c];this._pendingTilemapRequests[c]=h,h.then(p,p)}h.then(a,l)})}getAvailability(t,e,i){if(!this._availableLevels[t])return"unavailable";const r=this._tilemapFromCache(t,e,i,this._tmpTilemapDefinition);return r?r.getAvailability(e,i):"unknown"}fetchAvailability(t,e,i,r){return this._availableLevels[t]?this.fetchTilemap(t,e,i,r).catch(s=>s).then(s=>{if(s instanceof kw){const n=s.getAvailability(e,i);return n==="unavailable"?Promise.reject(new Q("tile-map:tile-unavailable","Tile is not available",{level:t,row:e,col:i})):n}if(bi(s))throw s;return"unknown"}):Promise.reject(new Q("tilemap-cache:level-unavailable",`Level ${t} is unavailable in the service`))}fetchAvailabilityUpsample(t,e,i,r,s){r.level=t,r.row=e,r.col=i;const n=this.layer.tileInfo;n.updateTileInfo(r);const o=this.fetchAvailability(t,e,i,s).catch(a=>{if(bi(a))throw a;if(n.upsampleTile(r))return this.fetchAvailabilityUpsample(r.level,r.row,r.col,r);throw a});return this._fetchAvailabilityUpsamplePrefetch(r.id,t,e,i,s,o),o}async _fetchAvailabilityUpsamplePrefetch(t,e,i,r,s,n){if(!this._prefetchingEnabled)return;const o=`prefetch-${t}`;if(this.handles.has(o))return;const a=new AbortController;n.then(()=>a.abort(),()=>a.abort());let l=!1;const c={remove(){l||(l=!0,a.abort())}};if(this.handles.add(c,o),await g0e(10,a.signal).catch(()=>{}),l||(l=!0,this.handles.remove(o)),Ir(a))return;const h={id:t,level:e,row:i,col:r},p=he(E({},s),{signal:a.signal}),f=this.layer.tileInfo;for(let g=0;Lv._prefetches.length<Lv._maxPrefetch&&f.upsampleTile(h);++g){const y=this.fetchAvailability(h.level,h.row,h.col,p);Lv._prefetches.push(y);const v=()=>{Lv._prefetches.removeUnordered(y)};y.then(v,v)}}_initializeTilemapDefinition(){var t;if(!this.layer.parsedUrl)return;const{parsedUrl:e,apiKey:i,customParameters:r}=this.layer;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:_g(he(E(E({},e.query),r),{token:i!=null?i:(t=e.query)==null?void 0:t.token})),tileServers:this.layer.tileServers,request:this.request,type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(t,e,i,r){r.level=t,r.row=e-e%this.size,r.col=i-i%this.size;const s=pge(r);return this._tilemapCache.get(s)}_initializeAvailableLevels(t){this._availableLevels={},t&&t.forEach(e=>this._availableLevels[e.level]=!0)}get test(){const t=this;return{get prefetchingEnabled(){return t._prefetchingEnabled},set prefetchingEnabled(e){t._prefetchingEnabled=e},hasTilemap:(e,i,r)=>!!t._tilemapFromCache(e,i,r,t._tmpTilemapDefinition)}}};jc._maxPrefetch=4,jc._prefetches=new ct({initialSize:Lv._maxPrefetch}),u([d({constructOnly:!0,type:Number})],jc.prototype,"levels",void 0),u([ut("levels")],jc.prototype,"castLevels",null),u([d({readOnly:!0,type:Number})],jc.prototype,"size",null),u([d({constructOnly:!0,type:Number})],jc.prototype,"cacheByteSize",void 0),u([d({constructOnly:!0})],jc.prototype,"layer",void 0),u([d({constructOnly:!0})],jc.prototype,"request",void 0),jc=Lv=u([R("esri.layers.support.TilemapCache")],jc);const Tst=t=>{let e=class extends t{constructor(){super(...arguments),this.copyright=null,this.minScale=0,this.maxScale=0,this.spatialReference=null,this.tileInfo=null,this.tilemapCache=null}readMinScale(i,r){return r.minLOD!=null&&r.maxLOD!=null?i:0}readMaxScale(i,r){return r.minLOD!=null&&r.maxLOD!=null?i:0}get supportsBlankTile(){return this.version>=10.2}readTilemapCache(i,r){return r.capabilities&&r.capabilities.indexOf("Tilemap")>-1?new jc({layer:this}):null}};return u([d({json:{read:{source:"copyrightText"}}})],e.prototype,"copyright",void 0),u([d()],e.prototype,"minScale",void 0),u([Ce("service","minScale")],e.prototype,"readMinScale",null),u([d()],e.prototype,"maxScale",void 0),u([Ce("service","maxScale")],e.prototype,"readMaxScale",null),u([d({type:Ue})],e.prototype,"spatialReference",void 0),u([d({readOnly:!0})],e.prototype,"supportsBlankTile",null),u([d(bst)],e.prototype,"tileInfo",void 0),u([d()],e.prototype,"tilemapCache",void 0),u([Ce("service","tilemapCache",["capabilities"])],e.prototype,"readTilemapCache",null),u([d()],e.prototype,"version",void 0),e=u([R("esri.layers.mixins.ArcGISCachedService")],e),e},fge=le.getLogger("esri.layers.ElevationLayer");let an=class extends Tst(aie(s9(a9(O$(n1))))){constructor(...t){super(...t),this.copyright=null,this.heightModelInfo=null,this.path=null,this.opacity=1,this.operationalLayerType="ArcGISTiledElevationServiceLayer",this.sourceJSON=null,this.type="elevation",this.url=null,this.version=null,this._lercDecoder=Ape()}normalizeCtorArgs(t,e){return typeof t=="string"?E({url:t},e):t}destroy(){this._lercDecoder=nr(this._lercDecoder)}set minScale(t){this.constructed&&fge.warn(`${this.declaredClass}.minScale support has been removed (since 4.5)`)}get minScale(){}set maxScale(t){this.constructed&&fge.warn(`${this.declaredClass}.maxScale support has been removed (since 4.5)`)}get maxScale(){}readVersion(t,e){let i=e.currentVersion;return i||(i=9.3),i}load(t){const e=_(t)?t.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"],supportsData:!1,validateItem:i=>{for(let r=0;r<i.typeKeywords.length;r++)if(i.typeKeywords[r].toLowerCase()==="elevation 3d layer")return!0;throw new Q("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}' ",{type:"Image Service",expectedType:"Image Service Elevation 3D Layer"})}},t).catch(Wc).then(()=>this._fetchImageService(e))),Promise.resolve(this)}fetchTile(t,e,i,r){const s=_((r=r||{signal:null}).signal)?r.signal:r.signal=new AbortController().signal,n={responseType:"array-buffer",signal:s},o={noDataValue:r.noDataValue,returnFileInfo:!0};return this.load().then(()=>this._fetchTileAvailability(t,e,i,r)).then(()=>vt(this.getTileUrl(t,e,i),n)).then(a=>this._lercDecoder.decode(a.data,o,s)).then(a=>({values:a.pixelData,width:a.width,height:a.height,maxZError:a.fileInfo.maxZError,noDataValue:a.noDataValue,minValue:a.minValue,maxValue:a.maxValue}))}getTileUrl(t,e,i){const r=!this.tilemapCache&&this.supportsBlankTile,s=_g(he(E({},this.parsedUrl.query),{blankTile:!r&&null}));return`${this.parsedUrl.path}/tile/${t}/${e}/${i}${s?"?"+s:""}`}async queryElevation(t,e){const{ElevationQuery:i}=await import("./ElevationQuery.e16dbd5e.js");return Dt(e),new i().query(this,t,e)}async createElevationSampler(t,e){const{ElevationQuery:i}=await import("./ElevationQuery.e16dbd5e.js");return Dt(e),new i().createSampler(this,t,e)}_fetchTileAvailability(t,e,i,r){return this.tilemapCache?this.tilemapCache.fetchAvailability(t,e,i,r):Promise.resolve("unknown")}async _fetchImageService(t){if(this.sourceJSON)return this.sourceJSON;const e={query:E({f:"json"},this.parsedUrl.query),responseType:"json",signal:t},i=await vt(this.parsedUrl.path,e);i.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),this.sourceJSON=i.data,this.read(i.data,{origin:"service",url:this.parsedUrl})}get hasOverriddenFetchTile(){return!this.fetchTile.__isDefault__}};u([d({json:{read:{source:"copyrightText"}}})],an.prototype,"copyright",void 0),u([d({readOnly:!0,type:ay})],an.prototype,"heightModelInfo",void 0),u([d({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],an.prototype,"path",void 0),u([d({type:["show","hide"]})],an.prototype,"listMode",void 0),u([d({json:{read:!1,write:!1,origins:{service:{read:!1,write:!1},"portal-item":{read:!1,write:!1},"web-document":{read:!1,write:!1}}}})],an.prototype,"minScale",null),u([d({json:{read:!1,write:!1,origins:{service:{read:!1,write:!1},"portal-item":{read:!1,write:!1},"web-document":{read:!1,write:!1}}}})],an.prototype,"maxScale",null),u([d({json:{read:!1,write:!1,origins:{"web-document":{read:!1,write:!1}}}})],an.prototype,"opacity",void 0),u([d({type:["ArcGISTiledElevationServiceLayer"]})],an.prototype,"operationalLayerType",void 0),u([d()],an.prototype,"sourceJSON",void 0),u([d({json:{read:!1},value:"elevation",readOnly:!0})],an.prototype,"type",void 0),u([d(bie)],an.prototype,"url",void 0),u([d()],an.prototype,"version",void 0),u([Ce("version",["currentVersion"])],an.prototype,"readVersion",null),an=u([R("esri.layers.ElevationLayer")],an),an.prototype.fetchTile.__isDefault__=!0;const Cst=an;var Mst=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Cst});let fp=class extends Y8(c9(n1)){constructor(t){super(t),this.elevationInfo=null,this.graphics=new r0,this.screenSizePerspectiveEnabled=!0,this.type="graphics",this.internal=!1}destroy(){this.removeAll(),this.graphics.destroy()}add(t){return this.graphics.add(t),this}addMany(t){return this.graphics.addMany(t),this}removeAll(){return this.graphics.removeAll(),this}remove(t){this.graphics.remove(t)}removeMany(t){this.graphics.removeMany(t)}on(t,e){return super.on(t,e)}graphicChanged(t){this.emit("graphic-update",t)}};u([d({type:yie})],fp.prototype,"elevationInfo",void 0),u([d(V9(r0,"graphics"))],fp.prototype,"graphics",void 0),u([d({type:["show","hide"]})],fp.prototype,"listMode",void 0),u([d()],fp.prototype,"screenSizePerspectiveEnabled",void 0),u([d({readOnly:!0})],fp.prototype,"type",void 0),u([d({constructOnly:!0})],fp.prototype,"internal",void 0),fp=u([R("esri.layers.GraphicsLayer")],fp);const dlt=fp;var yB;let lg=yB=class extends ge{constructor(t){super(t)}clone(){return new yB({customLayerParameters:ie(this.customLayerParameters),customParameters:ie(this.customParameters),layerIdentifier:this.layerIdentifier,tileMatrixSet:this.tileMatrixSet,url:this.url})}};u([d({json:{type:Object,write:!0}})],lg.prototype,"customLayerParameters",void 0),u([d({json:{type:Object,write:!0}})],lg.prototype,"customParameters",void 0),u([d({type:String,json:{write:!0}})],lg.prototype,"layerIdentifier",void 0),u([d({type:String,json:{write:!0}})],lg.prototype,"tileMatrixSet",void 0),u([d({type:String,json:{write:!0}})],lg.prototype,"url",void 0),lg=yB=u([R("esri.layer.support.WMTSLayerInfo")],lg);const Pst=lg;let $r=class extends Y8(Tie(c9(s9(a9(O$(n1)))))){constructor(...t){super(...t),this.copyright="",this.fullExtent=new ht(-20037508342787e-6,-2003750834278e-5,2003750834278e-5,20037508342787e-6,Ue.WebMercator),this.legendEnabled=!1,this.isReference=null,this.popupEnabled=!1,this.spatialReference=Ue.WebMercator,this.subDomains=null,this.tileInfo=new xc({size:[256,256],dpi:96,format:"png8",compressionQuality:0,origin:new je({x:-20037508342787e-6,y:20037508342787e-6,spatialReference:Ue.WebMercator}),spatialReference:Ue.WebMercator,lods:[new qi({level:0,scale:591657527591555e-6,resolution:156543.033928}),new qi({level:1,scale:295828763795777e-6,resolution:78271.5169639999}),new qi({level:2,scale:147914381897889e-6,resolution:39135.7584820001}),new qi({level:3,scale:73957190948944e-6,resolution:19567.8792409999}),new qi({level:4,scale:36978595474472e-6,resolution:9783.93962049996}),new qi({level:5,scale:18489297737236e-6,resolution:4891.96981024998}),new qi({level:6,scale:9244648868618e-6,resolution:2445.98490512499}),new qi({level:7,scale:4622324434309e-6,resolution:1222.99245256249}),new qi({level:8,scale:2311162217155e-6,resolution:611.49622628138}),new qi({level:9,scale:1155581108577e-6,resolution:305.748113140558}),new qi({level:10,scale:577790.554289,resolution:152.874056570411}),new qi({level:11,scale:288895.277144,resolution:76.4370282850732}),new qi({level:12,scale:144447.638572,resolution:38.2185141425366}),new qi({level:13,scale:72223.819286,resolution:19.1092570712683}),new qi({level:14,scale:36111.909643,resolution:9.55462853563415}),new qi({level:15,scale:18055.954822,resolution:4.77731426794937}),new qi({level:16,scale:9027.977411,resolution:2.38865713397468}),new qi({level:17,scale:4513.988705,resolution:1.19432856685505}),new qi({level:18,scale:2256.994353,resolution:.597164283559817}),new qi({level:19,scale:1128.497176,resolution:.298582141647617}),new qi({level:20,scale:564.248588,resolution:.14929107082380833}),new qi({level:21,scale:282.124294,resolution:.07464553541190416}),new qi({level:22,scale:141.062147,resolution:.03732276770595208}),new qi({level:23,scale:70.5310735,resolution:.01866138385297604})]}),this.type="web-tile",this.urlTemplate=null,this.wmtsInfo=null}normalizeCtorArgs(t,e){return typeof t=="string"?E({urlTemplate:t},e):t}load(t){const e=this.loadFromPortal({supportedTypes:["WMTS"]},t).then(()=>{let i="";if(this.urlTemplate)if(this.spatialReference.equals(this.tileInfo.spatialReference)){const r=new Ah(this.urlTemplate);!!this.subDomains&&this.subDomains.length>0||r.authority.indexOf("{subDomain}")===-1||(i="is missing 'subDomains' property")}else i="spatialReference must match tileInfo.spatialReference";else i="is missing the required 'urlTemplate' property value";if(i)throw new Q("web-tile-layer:load",`WebTileLayer (title: '${this.title}', id: '${this.id}') ${i}`)});return this.addResolvingPromise(e),Promise.resolve(this)}get levelValues(){const t=[];if(!this.tileInfo)return null;for(const e of this.tileInfo.lods)t[e.level]=e.levelValue||e.level;return t}readSpatialReference(t,e){return t||e.fullExtent&&e.fullExtent.spatialReference&&Ue.fromJSON(e.fullExtent.spatialReference)}get tileServers(){if(!this.urlTemplate)return null;const t=[],{urlTemplate:e,subDomains:i}=this,r=new Ah(e),s=r.scheme?r.scheme+"://":"//",n=s+r.authority+"/";if(r.authority.indexOf("{subDomain}")===-1)t.push(n);else if(i&&i.length>0&&r.authority.split(".").length>1)for(const o of i)t.push(s+r.authority.replace(/\{subDomain\}/gi,o)+"/");return t.map(o=>(o.charAt(o.length-1)!=="/"&&(o+="/"),o))}get urlPath(){if(!this.urlTemplate)return null;const t=this.urlTemplate,e=new Ah(t),i=(e.scheme?e.scheme+"://":"//")+e.authority+"/";return t.substring(i.length)}readUrlTemplate(t,e){return t||e.templateUrl}writeUrlTemplate(t,e){t&&Vl(t)&&(t="https:"+t),t&&(t=t.replace(/\{z\}/gi,"{level}").replace(/\{x\}/gi,"{col}").replace(/\{y\}/gi,"{row}"),t=Ia(t)),e.templateUrl=t}fetchTile(t,e,i,r={}){const{signal:s}=r,n=this.getTileUrl(t,e,i),o={responseType:"image",signal:s,query:E({},this.refreshParameters)};return vt(n,o).then(a=>a.data)}getTileUrl(t,e,i){const r=this.levelValues[t];return this.tileServers[e%this.tileServers.length]+Dl(this.urlPath,{level:r,z:r,col:i,x:i,row:e,y:e})}};u([d({type:String,value:"",json:{write:!0}})],$r.prototype,"copyright",void 0),u([d({type:ht,json:{write:!0},nonNullable:!0})],$r.prototype,"fullExtent",void 0),u([d({readOnly:!0,json:{read:!1,write:!1}})],$r.prototype,"legendEnabled",void 0),u([d({type:["show","hide"]})],$r.prototype,"listMode",void 0),u([d()],$r.prototype,"levelValues",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],$r.prototype,"isReference",void 0),u([d({type:["WebTiledLayer"],value:"WebTiledLayer"})],$r.prototype,"operationalLayerType",void 0),u([d({readOnly:!0,json:{read:!1,write:!1}})],$r.prototype,"popupEnabled",void 0),u([d({type:Ue})],$r.prototype,"spatialReference",void 0),u([Ce("spatialReference",["spatialReference","fullExtent.spatialReference"])],$r.prototype,"readSpatialReference",null),u([d({type:[String],json:{write:!0}})],$r.prototype,"subDomains",void 0),u([d({type:xc,json:{write:!0}})],$r.prototype,"tileInfo",void 0),u([d({readOnly:!0})],$r.prototype,"tileServers",null),u([d({json:{read:!1}})],$r.prototype,"type",void 0),u([d()],$r.prototype,"urlPath",null),u([d({type:String,json:{origins:{"portal-item":{read:{source:"url"}}}}})],$r.prototype,"urlTemplate",void 0),u([Ce("urlTemplate",["urlTemplate","templateUrl"])],$r.prototype,"readUrlTemplate",null),u([Ee("urlTemplate",{templateUrl:{type:String}})],$r.prototype,"writeUrlTemplate",null),u([d({type:Pst,json:{write:!0}})],$r.prototype,"wmtsInfo",void 0),$r=u([R("esri.layers.WebTileLayer")],$r);const Ast=$r;var plt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Ast}),mge,gge={exports:{}};mge=function(){var t=function(){if(typeof Map!="undefined")return Map;function k(j,V){var q=-1;return j.some(function(J,O){return J[0]===V&&(q=O,!0)}),q}return function(){function j(){this.__entries__=[]}return Object.defineProperty(j.prototype,"size",{get:function(){return this.__entries__.length},enumerable:!0,configurable:!0}),j.prototype.get=function(V){var q=k(this.__entries__,V),J=this.__entries__[q];return J&&J[1]},j.prototype.set=function(V,q){var J=k(this.__entries__,V);~J?this.__entries__[J][1]=q:this.__entries__.push([V,q])},j.prototype.delete=function(V){var q=this.__entries__,J=k(q,V);~J&&q.splice(J,1)},j.prototype.has=function(V){return!!~k(this.__entries__,V)},j.prototype.clear=function(){this.__entries__.splice(0)},j.prototype.forEach=function(V,q){q===void 0&&(q=null);for(var J=0,O=this.__entries__;J<O.length;J++){var L=O[J];V.call(q,L[1],L[0])}},j}()}(),e=typeof window!="undefined"&&typeof document!="undefined"&&window.document===document,i=q8!==void 0&&q8.Math===Math?q8:typeof self!="undefined"&&self.Math===Math?self:typeof window!="undefined"&&window.Math===Math?window:Function("return this")(),r=typeof requestAnimationFrame=="function"?requestAnimationFrame.bind(i):function(k){return setTimeout(function(){return k(Date.now())},1e3/60)},s=2;function n(k,j){var V=!1,q=!1,J=0;function O(){V&&(V=!1,k()),q&&N()}function L(){r(O)}function N(){var B=Date.now();if(V){if(B-J<s)return;q=!0}else V=!0,q=!1,setTimeout(L,j);J=B}return N}var o=20,a=["top","right","bottom","left","width","height","size","weight"],l=typeof MutationObserver!="undefined",c=function(){function k(){this.connected_=!1,this.mutationEventsAdded_=!1,this.mutationsObserver_=null,this.observers_=[],this.onTransitionEnd_=this.onTransitionEnd_.bind(this),this.refresh=n(this.refresh.bind(this),o)}return k.prototype.addObserver=function(j){~this.observers_.indexOf(j)||this.observers_.push(j),this.connected_||this.connect_()},k.prototype.removeObserver=function(j){var V=this.observers_,q=V.indexOf(j);~q&&V.splice(q,1),!V.length&&this.connected_&&this.disconnect_()},k.prototype.refresh=function(){this.updateObservers_()&&this.refresh()},k.prototype.updateObservers_=function(){var j=this.observers_.filter(function(V){return V.gatherActive(),V.hasActive()});return j.forEach(function(V){return V.broadcastActive()}),j.length>0},k.prototype.connect_=function(){e&&!this.connected_&&(document.addEventListener("transitionend",this.onTransitionEnd_),window.addEventListener("resize",this.refresh),l?(this.mutationsObserver_=new MutationObserver(this.refresh),this.mutationsObserver_.observe(document,{attributes:!0,childList:!0,characterData:!0,subtree:!0})):(document.addEventListener("DOMSubtreeModified",this.refresh),this.mutationEventsAdded_=!0),this.connected_=!0)},k.prototype.disconnect_=function(){e&&this.connected_&&(document.removeEventListener("transitionend",this.onTransitionEnd_),window.removeEventListener("resize",this.refresh),this.mutationsObserver_&&this.mutationsObserver_.disconnect(),this.mutationEventsAdded_&&document.removeEventListener("DOMSubtreeModified",this.refresh),this.mutationsObserver_=null,this.mutationEventsAdded_=!1,this.connected_=!1)},k.prototype.onTransitionEnd_=function(j){var V=j.propertyName,q=V===void 0?"":V;a.some(function(J){return!!~q.indexOf(J)})&&this.refresh()},k.getInstance=function(){return this.instance_||(this.instance_=new k),this.instance_},k.instance_=null,k}(),h=function(k,j){for(var V=0,q=Object.keys(j);V<q.length;V++){var J=q[V];Object.defineProperty(k,J,{value:j[J],enumerable:!1,writable:!1,configurable:!0})}return k},p=function(k){return k&&k.ownerDocument&&k.ownerDocument.defaultView||i},f=P(0,0,0,0);function g(k){return parseFloat(k)||0}function y(k){for(var j=[],V=1;V<arguments.length;V++)j[V-1]=arguments[V];return j.reduce(function(q,J){return q+g(k["border-"+J+"-width"])},0)}function v(k){for(var j={},V=0,q=["top","right","bottom","left"];V<q.length;V++){var J=q[V],O=k["padding-"+J];j[J]=g(O)}return j}function b(k){var j=k.getBBox();return P(0,0,j.width,j.height)}function w(k){var j=k.clientWidth,V=k.clientHeight;if(!j&&!V)return f;var q=p(k).getComputedStyle(k),J=v(q),O=J.left+J.right,L=J.top+J.bottom,N=g(q.width),B=g(q.height);if(q.boxSizing==="border-box"&&(Math.round(N+O)!==j&&(N-=y(q,"left","right")+O),Math.round(B+L)!==V&&(B-=y(q,"top","bottom")+L)),!T(k)){var W=Math.round(N+O)-j,Y=Math.round(B+L)-V;Math.abs(W)!==1&&(N-=W),Math.abs(Y)!==1&&(B-=Y)}return P(J.left,J.top,N,B)}var S=typeof SVGGraphicsElement!="undefined"?function(k){return k instanceof p(k).SVGGraphicsElement}:function(k){return k instanceof p(k).SVGElement&&typeof k.getBBox=="function"};function T(k){return k===p(k).document.documentElement}function C(k){return e?S(k)?b(k):w(k):f}function M(k){var j=k.x,V=k.y,q=k.width,J=k.height,O=typeof DOMRectReadOnly!="undefined"?DOMRectReadOnly:Object,L=Object.create(O.prototype);return h(L,{x:j,y:V,width:q,height:J,top:V,right:j+q,bottom:J+V,left:j}),L}function P(k,j,V,q){return{x:k,y:j,width:V,height:q}}var F=function(){function k(j){this.broadcastWidth=0,this.broadcastHeight=0,this.contentRect_=P(0,0,0,0),this.target=j}return k.prototype.isActive=function(){var j=C(this.target);return this.contentRect_=j,j.width!==this.broadcastWidth||j.height!==this.broadcastHeight},k.prototype.broadcastRect=function(){var j=this.contentRect_;return this.broadcastWidth=j.width,this.broadcastHeight=j.height,j},k}(),z=function(){function k(j,V){var q=M(V);h(this,{target:j,contentRect:q})}return k}(),D=function(){function k(j,V,q){if(this.activeObservations_=[],this.observations_=new t,typeof j!="function")throw new TypeError("The callback provided as parameter 1 is not a function.");this.callback_=j,this.controller_=V,this.callbackCtx_=q}return k.prototype.observe=function(j){if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");if(typeof Element!="undefined"&&Element instanceof Object){if(!(j instanceof p(j).Element))throw new TypeError('parameter 1 is not of type "Element".');var V=this.observations_;V.has(j)||(V.set(j,new F(j)),this.controller_.addObserver(this),this.controller_.refresh())}},k.prototype.unobserve=function(j){if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");if(typeof Element!="undefined"&&Element instanceof Object){if(!(j instanceof p(j).Element))throw new TypeError('parameter 1 is not of type "Element".');var V=this.observations_;V.has(j)&&(V.delete(j),V.size||this.controller_.removeObserver(this))}},k.prototype.disconnect=function(){this.clearActive(),this.observations_.clear(),this.controller_.removeObserver(this)},k.prototype.gatherActive=function(){var j=this;this.clearActive(),this.observations_.forEach(function(V){V.isActive()&&j.activeObservations_.push(V)})},k.prototype.broadcastActive=function(){if(this.hasActive()){var j=this.callbackCtx_,V=this.activeObservations_.map(function(q){return new z(q.target,q.broadcastRect())});this.callback_.call(j,V,j),this.clearActive()}},k.prototype.clearActive=function(){this.activeObservations_.splice(0)},k.prototype.hasActive=function(){return this.activeObservations_.length>0},k}(),U=typeof WeakMap!="undefined"?new WeakMap:new t,G=function(){function k(j){if(!(this instanceof k))throw new TypeError("Cannot call a class as a function.");if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");var V=c.getInstance(),q=new D(j,V,this);U.set(this,q)}return k}();return["observe","unobserve","disconnect"].forEach(function(k){G.prototype[k]=function(){var j;return(j=U.get(this))[k].apply(j,arguments)}}),i.ResizeObserver!==void 0?i.ResizeObserver:G},gge.exports=mge();const $st=gge.exports,yge="esri.widgets.Slider.SliderViewModel",Est=le.getLogger(yge);let Ma=class extends ve{constructor(t){super(t),this.precision=4,this.thumbsConstrained=!0}set labelFormatFunction(t){this._set("labelFormatFunction",t)}set inputFormatFunction(t){this._set("inputFormatFunction",t)}set inputParseFunction(t){this._set("inputParseFunction",t)}get labels(){const{max:t,min:e,values:i}=this,r=i&&i.length?i.map((s,n)=>this.getLabelForValue(s,"value",n)):[];return{max:this.getLabelForValue(t,"max"),min:this.getLabelForValue(e,"min"),values:r}}set max(t){this.setMax(t)}set min(t){this.setMin(t)}get state(){const{max:t,min:e}=this;return _(t)&&_(e)&&t>e?"ready":"disabled"}set values(t){const{max:e,min:i}=this,r=this.values;r&&t&&r.length===t.length&&r.every((s,n)=>s===t[n])||(this._set("values",null),t&&t.length&&(_(i)&&t.some(s=>s<i)&&(this.min=Math.min(...t)),_(e)&&t.some(s=>s>e)&&(this.max=Math.max(...t))),this._set("values",t))}toPrecision(t){return parseFloat(t.toFixed(this.precision))}defaultLabelFormatFunction(t){const{max:e,min:i,precision:r}=this,s=e-i>10?2:r;return parseFloat(t.toFixed(s)).toString()}defaultInputFormatFunction(t){return t.toString()}defaultInputParseFunction(t){return parseFloat(t)}getBoundsForValueAtIndex(t){const{thumbsConstrained:e,max:i,min:r,values:s}=this;if(e){const n=t-1,o=t+1;return{min:_(s[n])?s[n]:r,max:_(s[o])?s[o]:i}}return{min:r,max:i}}getLabelForValue(t,e,i){return _(t)?this.labelFormatFunction?this.labelFormatFunction(t,e,i):this.defaultLabelFormatFunction(t):null}setMax(t){const{max:e,values:i}=this;if(isNaN(t))return void this._logError("slider:invalid-value","Property 'max' must of type 'number'.");if(t===null)return void this._set("max",null);const r=this.toPrecision(t);if(e!==r&&(this._set("max",r),i&&i.length))for(let s=0;s<i.length;s++)r<i[s]&&this.setValue(s,r)}setMin(t){const{min:e,values:i}=this;if(isNaN(t))return void this._logError("slider:invalid-value","Property 'min' must of type 'number'.");if(t===null)return void this._set("min",null);const r=this.toPrecision(t);if(e!==r&&(this._set("min",r),i&&i.length))for(let s=0;s<i.length;s++)r>i[s]&&this.setValue(s,r)}setValue(t,e){if(isNaN(e))return void this._logError("slider:invalid-value","Members of property 'values' must of type 'number'.");const{values:i}=this,r=i[t],s=this.toPrecision(e);if(r===s)return;const n=[...i];n[t]=s,this._set("values",n),this.notifyChange("labels")}_logError(t,e,i){Est.error(new Q(t,e,i))}};u([d()],Ma.prototype,"labelFormatFunction",null),u([d()],Ma.prototype,"inputFormatFunction",null),u([d()],Ma.prototype,"inputParseFunction",null),u([d({readOnly:!0})],Ma.prototype,"labels",null),u([d()],Ma.prototype,"max",null),u([d()],Ma.prototype,"min",null),u([d()],Ma.prototype,"precision",void 0),u([d({readOnly:!0})],Ma.prototype,"state",null),u([d()],Ma.prototype,"thumbsConstrained",void 0),u([d()],Ma.prototype,"values",null),Ma=u([R(yge)],Ma);const Ost=Ma,Rt={base:"esri-slider",reversed:"esri-slider--reversed",horizontalLayout:"esri-slider--horizontal",verticalLayout:"esri-slider--vertical",contentElement:"esri-slider__content",extraContentElement:"esri-slider__extra-content",trackElement:"esri-slider__track",ticksContainerElement:"esri-slider__ticks",tickElement:"esri-slider__tick",tickLabelElement:"esri-slider__tick-label",maxElement:"esri-slider__max",minElement:"esri-slider__min",maxElementInteractive:"esri-slider__max--interactive",minElementInteractive:"esri-slider__min--interactive",rangeInput:"esri-slider__range-input",anchorElement:"esri-slider__anchor",movingAnchorElement:"esri-slider__anchor--moving",lastMovedAnchorElement:"esri-slider__anchor--moved",anchorElementActive:"esri-slider__anchor--active",anchorElementIndexPrefix:"esri-slider__anchor-",segmentElement:"esri-slider__segment",segmentElementIndexPrefix:"esri-slider__segment-",segmentElementInteractive:"esri-slider__segment--interactive",segmentElementActive:"esri-slider__segment--active",thumbElement:"esri-slider__thumb",labelElement:"esri-slider__label",labelElementInteractive:"esri-slider__label--interactive",labelInput:"esri-slider__label-input",esriWidget:"esri-widget",widgetIcon:"esri-icon-edit",disabled:"esri-disabled",hidden:"esri-hidden"},jo={showInput:"Enter",hideInput1:"Enter",hideInput2:"Escape",hideInput3:"Tab",moveAnchorUp:"ArrowUp",moveAnchorDown:"ArrowDown",moveAnchorLeft:"ArrowLeft",moveAnchorRight:"ArrowRight",moveAnchorToMax:"End",moveAnchorToMin:"Home"},Rst="esri.widgets.Slider",vge=le.getLogger("esri.widgets.Slider"),_ge={labels:!1,rangeLabels:!1};let It=class extends Bs{constructor(t,e){super(t,e),this._activeLabelInputIndex=null,this._anchorElements=[],this._baseNode=null,this._dragged=!1,this._dragStartInfo=null,this._focusedAnchorIndex=null,this._isMinInputActive=!1,this._isMaxInputActive=!1,this._lastMovedHandleIndex=null,this._observer=null,this._positionPrecision=5,this._segmentDragStartInfo=null,this._trackHeight=null,this._trackWidth=null,this._zIndices=null,this._zIndexOffset=3,this.disabled=!1,this.extraNodes=[],this.draggableSegmentsEnabled=!0,this.inputCreatedFunction=null,this.inputFormatFunction=null,this.inputParseFunction=null,this.label=void 0,this.labelElements=new We,this.labelInputsEnabled=!1,this.labelFormatFunction=null,this.labels=null,this.max=null,this.maxLabelElement=null,this.messages=null,this.min=null,this.minLabelElement=null,this.precision=4,this.rangeLabelInputsEnabled=!1,this.segmentElements=new We,this.snapOnClickEnabled=!0,this.steps=null,this.syncedSegmentsEnabled=!1,this.thumbsConstrained=!0,this.thumbCreatedFunction=null,this.thumbElements=new We,this.tickElements=new We,this.trackElement=null,this.values=null,this.viewModel=new Ost,this.visibleElements=E({},_ge),this._observer=new $st(()=>this.scheduleRender()),this._onAnchorPointerDown=this._onAnchorPointerDown.bind(this),this._onAnchorPointerMove=this._onAnchorPointerMove.bind(this),this._onAnchorPointerUp=this._onAnchorPointerUp.bind(this),this._onLabelPointerDown=this._onLabelPointerDown.bind(this),this._onLabelPointerUp=this._onLabelPointerUp.bind(this),this._onSegmentPointerDown=this._onSegmentPointerDown.bind(this),this._onSegmentPointerMove=this._onSegmentPointerMove.bind(this),this._onSegmentPointerUp=this._onSegmentPointerUp.bind(this),this._onTrackPointerDown=this._onTrackPointerDown.bind(this),this._onTrackPointerMove=this._onTrackPointerMove.bind(this),this._onTrackPointerUp=this._onTrackPointerUp.bind(this)}destroy(){document.removeEventListener("pointerup",this._onLabelPointerUp),document.removeEventListener("pointermove",this._onLabelPointerMove),document.removeEventListener("pointerup",this._onAnchorPointerUp),document.removeEventListener("pointermove",this._onAnchorPointerMove),this.labelElements.removeAll(),this.labelElements.destroy(),this.segmentElements.removeAll(),this.segmentElements.destroy(),this.thumbElements.removeAll(),this.thumbElements.destroy(),this.tickElements.removeAll(),this.tickElements.destroy()}set labelsVisible(t){rD(vge,"labelsVisible",{replacement:"visibleElements.labels",version:"4.15"}),this.visibleElements=he(E({},this.visibleElements),{labels:t})}set layout(t){["vertical","vertical-reversed","horizontal","horizontal-reversed"].indexOf(t)===-1&&(t="horizontal"),this._set("layout",t)}set rangeLabelsVisible(t){rD(vge,"rangeLabelsVisible",{replacement:"visibleElements.rangeLabels",version:"4.15"}),this.visibleElements=he(E({},this.visibleElements),{rangeLabels:t})}get state(){const{_activeLabelInputIndex:t,_isMaxInputActive:e,_isMinInputActive:i,_dragStartInfo:r,_segmentDragStartInfo:s,disabled:n,viewModel:o}=this,a=_(r)||_(s);return n?"disabled":t===null&&!e&&!i?a?"dragging":o.state:"editing"}set tickConfigs(t){this._set("tickConfigs",t),this.scheduleRender()}castVisibleElements(t){return E(E({},_ge),t)}render(){const{label:t}=this,e=this.classes(Rt.base,Rt.esriWidget,this._isHorizontalLayout()?Rt.horizontalLayout:Rt.verticalLayout,this._isReversedLayout()?Rt.reversed:null,this._isDisabled()?Rt.disabled:null);return this._storeTrackDimensions(),ee("div",{afterCreate:this._afterBaseNodeCreate,bind:this,"aria-label":t,class:e,"touch-action":"none"},this.renderContent())}toNextStep(t){this._toStep(t,1)}toPreviousStep(t){this._toStep(t,-1)}renderContent(){const{max:t,min:e}=this;if(_(e)&&_(t)&&!(e>=t))return[this.renderMin(),this.renderSliderContainer(),this.renderMax()]}renderSliderContainer(){return ee("div",{key:"slider-container",bind:this,class:Rt.contentElement},this.renderTrackElement(),this.renderTicksContainer(),this.renderExtraContentElements())}renderTrackElement(){return ee("div",{afterCreate:this._afterTrackCreate,afterRemoved:this._afterTrackRemoved,bind:this,class:Rt.trackElement,"data-node-ref":"trackElement","touch-action":"none"},this.renderSegmentElements(),this.renderAnchorElements())}renderSegmentElements(){if(!this.trackElement||!this.values||!this.values.length)return;const t=this.values.length+1,e=[];for(let i=0;i<t;i++)e.push(this.renderSegmentElement(i));return e}renderSegmentElement(t){const{_trackHeight:e,_trackWidth:i,draggableSegmentsEnabled:r,id:s,state:n,values:o}=this,a=this._isHorizontalLayout(),l=a?i:e,c=t===o.length?null:t,h=t===0?null:t-1,p=_(c),f=_(h);let g,y;const v=[...o].sort((C,M)=>C-M);this._isReversedLayout()?(g=f?this._positionFromValue(v[h]):a?l:0,y=p?this._positionFromValue(v[c]):a?0:l):(g=p?this._positionFromValue(v[c]):a?l:0,y=f?this._positionFromValue(v[h]):a?0:l);const b=this._applyPrecisionToPosition(100*y/l),w=(g-y)/l,S=a?`transform: translate(${b}%, 0px) scale(${w}, 1);`:`transform: translate(0px, ${b}%) scale(1, ${w});`,T=this.classes(Rt.segmentElement,Rt.segmentElementIndexPrefix+t,r&&p&&f&&n!=="disabled"?Rt.segmentElementInteractive:null);return ee("div",{afterCreate:this._afterSegmentCreate,afterRemoved:this._afterSegmentRemoved,bind:this,class:T,"data-max-thumb-index":c,"data-min-thumb-index":h,"data-segment-index":t,key:`${s}-segment-${t}`,style:S,"touch-action":"none"})}renderAnchorElements(){const{trackElement:t,values:e}=this;if(e&&e.length)return this._zIndices=e.map((i,r)=>{const s=this._positionFromValue(i),n=this._positionToPercent(s),o=(this._isHorizontalLayout()?n>50:n<50)?-1:1;return this._zIndexOffset+(e.length+o*r)}),t&&e&&e.length?e.map((i,r)=>this.renderAnchorElement(i,r)):null}renderAnchorElement(t,e){const i=this._positionFromValue(t),r=this._valueFromPosition(i);if(!_(r)||isNaN(r))return;const{_dragStartInfo:s,_lastMovedHandleIndex:n,id:o,layout:a,values:l,visibleElements:{labels:c}}=this,h=s&&s.index===e,p=n===e,f=this.classes(Rt.anchorElement,Rt.anchorElementIndexPrefix+e,h?Rt.movingAnchorElement:null,p?Rt.lastMovedAnchorElement:null),g=this.labels.values[e],y=this._getStyleForAnchor(t,e,h||p),{min:v,max:b}=this.viewModel.getBoundsForValueAtIndex(e),{messages:w}=this,S=l.length===2?yu(e===0?w.rangeMinimum:w.rangeMaximum,{value:t}):g,T=l.length===1?null:e===0?`${o}-handle-${e+1}`:e===l.length-1?`${o}-handle-${e-1}`:`${o}-handle-${e-1} ${o}-handle-${e+1}`;return ee("div",{afterCreate:this._afterAnchorCreate,afterUpdate:this._afterAnchorUpdate,afterRemoved:this._afterAnchorRemoved,"aria-controls":T,"aria-label":w.sliderValue,"aria-labelledby":c?`${o}-label-${e}`:null,"aria-orientation":a,"aria-valuemax":b.toString(),"aria-valuemin":v.toString(),"aria-valuenow":t.toString(),"aria-valuetext":S,bind:this,class:f,"data-thumb-index":e,"data-value":t,id:`${o}-handle-${e}`,key:`${o}-handle-${e}`,onkeydown:this._onAnchorKeyDown,"touch-action":"none",role:"slider",style:y,tabIndex:0},ee("span",{afterCreate:this._afterThumbCreate,afterRemoved:this._afterThumbRemoved,bind:this,class:Rt.thumbElement,"data-thumb-index":e,"touch-action":"none"}),this.renderThumbLabel(e))}renderThumbLabel(t){const{id:e,labels:i,labelInputsEnabled:r,state:s}=this,n=this.visibleElements.labels,o=i.values[t],a=this.classes(Rt.labelElement,n?null:Rt.hidden,r&&s!=="disabled"?Rt.labelElementInteractive:null);return ee("span",{afterCreate:this._afterLabelCreate,afterRemoved:this._afterLabelRemoved,"aria-hidden":(!n).toString(),bind:this,class:a,"data-thumb-index":t,key:`${e}-label-${t}`,id:`${e}-label-${t}`,role:r?"button":null,"touch-action":"none"},this._activeLabelInputIndex===t?this.renderValueInput(t):o)}renderValueInput(t){const e=this.values[t];return ee("input",{afterCreate:this._afterInputCreate,"aria-label":this.messages.sliderValue,bind:this,class:Rt.labelInput,"data-input-type":"thumb","data-input-index":t,required:!0,tabIndex:0,type:"text",value:this._formatInputValue(e,"value",t),onblur:this._onLabelInputBlur,onkeydown:this._onInputKeyDown})}renderMax(){const{_isMaxInputActive:t,labels:e,rangeLabelInputsEnabled:i,state:r}=this,s=this.visibleElements.rangeLabels,n=this.classes(Rt.maxElement,s?null:Rt.hidden,i&&r!=="disabled"?Rt.maxElementInteractive:null);return ee("div",{"aria-hidden":(!s).toString(),afterCreate:this._afterMaxLabelCreate,bind:this,class:n,onclick:this._onMaxLabelClick,onkeydown:this._onMaxLabelKeyDown,role:i?"button":null,tabIndex:i?0:null},t?this.renderMaxInput():e.max)}renderMin(){const{_isMinInputActive:t,labels:e,rangeLabelInputsEnabled:i,state:r}=this,s=this.visibleElements.rangeLabels,n=this.classes(Rt.minElement,s?null:Rt.hidden,i&&r!=="disabled"?Rt.minElementInteractive:null);return ee("div",{"aria-hidden":(!s).toString(),afterCreate:this._afterMinLabelCreate,bind:this,class:n,onclick:this._onMinLabelClick,onkeydown:this._onMinLabelKeyDown,role:i?"button":null,tabIndex:i?0:null},t?this.renderMinInput():e.min)}renderMaxInput(){return ee("input",{afterCreate:this._afterInputCreate,"aria-label":this.messages.maximumValue,bind:this,class:Rt.rangeInput,"data-input-type":"max",required:!0,tabIndex:0,type:"text",value:this._formatInputValue(this.max,"max"),onblur:this._onMaxInputBlur,onkeydown:this._onInputKeyDown})}renderMinInput(){return ee("input",{afterCreate:this._afterInputCreate,"aria-label":this.messages.minimumValue,bind:this,class:Rt.rangeInput,"data-input-type":"min",required:!0,tabIndex:0,type:"text",value:this._formatInputValue(this.min,"min"),onblur:this._onMinInputBlur,onkeydown:this._onInputKeyDown})}renderExtraContentElements(){return ee("div",{bind:this,class:Rt.extraContentElement},this.extraNodes)}renderTicksContainer(){if(this.tickConfigs&&this.trackElement&&(this._trackHeight!==0||this._trackWidth!==0))return this.tickConfigs.map((t,e)=>ee("div",{key:"ticks-container",class:this.classes(Rt.ticksContainerElement)},this.renderTicks(t,e)))}renderTicks(t,e){const{mode:i,values:r}=t;if(this.tickElements.getItemAt(e)||this.tickElements.add(new We,e),i==="position"){const o=Array.isArray(r)?r:[r];return this._calculateTickPositions(o).map((a,l)=>this.renderTickGroup(t,l,e,a))}if(i==="percent"&&Array.isArray(r)){const{max:o,min:a}=this,l=o-a,c=r.map(h=>this._applyPrecisionToPosition(h/100*l+a));return this._calculateTickPositions(c).map((h,p)=>this.renderTickGroup(t,p,e,h))}const s=Array.isArray(r)&&r.length?r[0]:isNaN(r)?null:r,n=this._getTickCounts(s,t);return this._calculateEquidistantTickPositions(n).map((o,a)=>this.renderTickGroup(t,a,e,o))}renderTickGroup(t,e,i,r){const s=t.mode==="position"?Array.isArray(t.values)?t.values[e]:t.values:this._valueFromPosition(r);if(_(s)&&!isNaN(s))return ee("div",{afterCreate:this._afterTickGroupCreate,afterRemoved:this._afterTickGroupRemoved,bind:this,"data-config":t,"data-position":r,"data-tick-config-index":i,"data-tick-group-index":e,"data-value":s,onclick:this._onTickGroupClick,key:`tick-group-${e}`},this.renderTickLine(t,e,i,s),t.labelsVisible?this.renderTickLabel(t,e,i,s):null)}renderTickLine(t,e,i,r){return ee("div",{afterCreate:this._afterTickLineCreate,"aria-valuenow":r.toString(),bind:this,class:Rt.tickElement,"data-config":t,"data-tick-config-index":i,"data-tick-group-index":e,"data-value":r,key:`tick-label-${e}`,style:this._getPositionStyleForElement(r)})}renderTickLabel(t,e,i,r){const s=t.labelFormatFunction?t.labelFormatFunction(r,"tick",e):this.viewModel.getLabelForValue(r,"tick",e);return ee("div",{afterCreate:this._afterTickLabelCreate,"aria-label":s,"aria-valuenow":r.toString(),"aria-valuetext":s,bind:this,class:Rt.tickLabelElement,"data-config":t,"data-tick-config-index":i,"data-tick-group-index":e,"data-value":r,key:`tick-label-${e}`,style:`transform: translate(-50%); ${this._getPositionStyleForElement(r)}`},s)}_afterBaseNodeCreate(t){this._baseNode&&this._observer.unobserve(this._baseNode),this._baseNode=t,this._observer.observe(this._baseNode)}_afterTrackCreate(t){this._set("trackElement",t),t.addEventListener("pointerdown",this._onTrackPointerDown),this.scheduleRender()}_afterTrackRemoved(t){t.removeEventListener("pointerdown",this._onTrackPointerDown),document.removeEventListener("pointermove",this._onTrackPointerMove),document.removeEventListener("pointerup",this._onTrackPointerUp)}_afterSegmentCreate(t){this.segmentElements.add(t),t.addEventListener("pointerdown",this._onSegmentPointerDown)}_afterSegmentRemoved(t){this.segmentElements.remove(t),t.removeEventListener("pointerdown",this._onSegmentPointerDown)}_afterAnchorCreate(t){if(this._anchorElements.push(t),t.addEventListener("pointerdown",this._onAnchorPointerDown),this.thumbCreatedFunction){const e=t["data-thumb-index"],i=t["data-value"],r=this.thumbElements.getItemAt(e)||null,s=this.labelElements.getItemAt(e)||null;this.thumbCreatedFunction(e,i,r,s)}}_afterAnchorUpdate(t){_(this._focusedAnchorIndex)&&t["data-thumb-index"]===this._focusedAnchorIndex&&(t.focus(),this._focusedAnchorIndex=null)}_afterAnchorRemoved(t){const e=this._anchorElements.indexOf(t,0);e>-1&&this._anchorElements.splice(e,1),t.removeEventListener("pointerdown",this._onAnchorPointerDown)}_afterThumbCreate(t){this.thumbElements.add(t)}_afterThumbRemoved(t){this.thumbElements.remove(t)}_afterLabelCreate(t){this.labelElements.add(t),t.addEventListener("pointerdown",this._onLabelPointerDown),t.addEventListener("pointerup",this._onLabelPointerUp)}_afterLabelRemoved(t){this.labelElements.remove(t),t.removeEventListener("pointerdown",this._onLabelPointerDown),t.removeEventListener("pointerup",this._onLabelPointerUp)}_afterInputCreate(t){if(t.focus(),t.select(),this.inputCreatedFunction){const e=t.getAttribute("data-input-type"),i=e==="thumb"?t["data-input-index"]:null;this.inputCreatedFunction(t,e,i)}}_afterTickLineCreate(t){const e=t["data-tick-config-index"],i=t["data-tick-group-index"],r=this.tickElements.getItemAt(e);r.getItemAt(i)?r.getItemAt(i).tickElement=t:r.add({groupElement:null,tickElement:t,labelElement:null},i)}_afterTickLabelCreate(t){const e=t["data-tick-config-index"],i=t["data-tick-group-index"],r=this.tickElements.getItemAt(e);r.getItemAt(i)?r.getItemAt(i).labelElement=t:r.add({groupElement:null,labelElement:t,tickElement:null},i)}_afterTickGroupRemoved(t){const e=t["data-tick-config-index"],i=this.tickElements.items[e],r=i==null?void 0:i.find(s=>s.groupElement===t);r&&i.remove(r)}_afterTickGroupCreate(t){const e=t["data-config"];if(e&&e.tickCreatedFunction){var i,r;const s=t["data-tick-config-index"],n=t["data-tick-group-index"],o=t["data-value"],a=(i=this.tickElements)==null||(r=i.getItemAt(s))==null?void 0:r.getItemAt(n);if(a){a.groupElement=t;const l=a.tickElement||null,c=a.labelElement||null;e.tickCreatedFunction(o,l,c)}}}_afterMaxLabelCreate(t){this._set("maxLabelElement",t)}_afterMinLabelCreate(t){this._set("minLabelElement",t)}_onAnchorKeyDown(t){if(this._isDisabled()||this.state==="editing")return;const{target:e}=t,i=Fl(t),{_anchorElements:r,values:s}=this,n=e["data-thumb-index"],o=r[n],a=s[n],l=this._isHorizontalLayout(),c=[jo.moveAnchorUp,jo.moveAnchorDown,jo.moveAnchorLeft,jo.moveAnchorRight];if(i===jo.showInput&&this.labelInputsEnabled)this._activeLabelInputIndex=n,this.notifyChange("state");else if(c.indexOf(i)>-1){t.preventDefault();const{steps:h}=this,p=i===jo.moveAnchorUp||i===jo.moveAnchorRight?1:-1;if(_(h))this._toStep(n,this._isReversedLayout()?-1*p:p);else{const{precision:g}=this,y=this._getPositionOfElement(o),v=this._valueFromPosition(y),b=this._isHorizontalLayout()?p:-1*p;let w;w=g===0?this._positionFromValue(v+b):g===1?this._positionFromValue(v+.1*b):y+b,this._toPosition(n,w)}const f=this.values[n];a!==f&&this._emitThumbChangeEvent({index:n,oldValue:a,value:f})}else if(i===jo.moveAnchorToMax||i===jo.moveAnchorToMin){t.preventDefault();const{min:h,max:p}=this._getAnchorBoundsInPixels(n),f=l?i===jo.moveAnchorToMax?p:h:i===jo.moveAnchorToMin?p:h;this._toPosition(n,f);const g=this.values[n];a!==g&&this._emitThumbChangeEvent({index:n,oldValue:a,value:g})}}_onAnchorPointerDown(t){if(this._isDisabled())return;const{target:e,clientX:i,clientY:r}=t,s=e["data-thumb-index"];s!==void 0&&(t.preventDefault(),this._anchorElements[s]&&this._anchorElements[s].focus(),this._storeTrackDimensions(),this._dragStartInfo={clientX:i,clientY:r,index:s,position:this._getPositionOfElement(this._anchorElements[s])},this.notifyChange("state"),document.addEventListener("pointerup",this._onAnchorPointerUp),document.addEventListener("pointermove",this._onAnchorPointerMove))}_onAnchorPointerMove(t){if(this.state==="editing"||!this._dragStartInfo)return;t.preventDefault();const{values:e,_anchorElements:i,_dragged:r,_dragStartInfo:s,_dragStartInfo:{index:n,position:o}}=this,{clientX:a,clientY:l}=t,c=r?"drag":"start",h=i[n],p=this._getPositionOfElement(h),f=this._applyPrecisionToPosition(this._isHorizontalLayout()?o+a-s.clientX:o+l-s.clientY);if(p===f)return;const g=e[n];this._dragged=!0,this._toPosition(n,f);const y=this.values[n];r?g!==y&&this._emitThumbDragEvent({index:n,state:c,value:y}):this._emitThumbDragEvent({index:n,state:c,value:g})}_onAnchorPointerUp(t){if(document.removeEventListener("pointerup",this._onAnchorPointerUp),document.removeEventListener("pointermove",this._onAnchorPointerMove),!this._dragStartInfo)return;t.preventDefault();const{index:e}=this._dragStartInfo,i=this._dragged,r=this.values[e];this._dragged=!1,this._dragStartInfo=null,this._lastMovedHandleIndex=e,this.notifyChange("state"),i?this._emitThumbDragEvent({index:e,state:"stop",value:r}):(this.scheduleRender(),this.state!=="editing"&&this._emitThumbClickEvent({index:e,value:r}))}_onTrackPointerDown(t){const{_dragStartInfo:e,snapOnClickEnabled:i,state:r,values:s}=this;if(this._isDisabled()||r==="editing"||e||(document.addEventListener("pointermove",this._onTrackPointerMove),document.addEventListener("pointerup",this._onTrackPointerUp),!i||!s.length))return;const{steps:n}=this,{clientX:o,clientY:a}=t,l=this._getCursorPositionFromEvent(t),c=this._valueFromPosition(l),h=this._getIndexOfNearestValue(c),p=s[h],f=s.some((b,w)=>b===p&&w!==h)&&c>p?this.values.lastIndexOf(p):h;if(!_(f))return;const g=s[f],y=_(n)?this._calculateNearestStepPosition(l):l;this._toPosition(f,y),this._dragged=!0,this._dragStartInfo={clientX:o,clientY:a,index:f,position:y},this._focusedAnchorIndex=f,this.notifyChange("state"),this._emitThumbDragEvent({index:f,state:"start",value:g});const v=this.values[f];g!==v&&this._emitThumbDragEvent({index:f,state:"drag",value:v}),document.addEventListener("pointerup",this._onAnchorPointerUp),document.addEventListener("pointermove",this._onAnchorPointerMove)}_onTrackPointerMove(t){t.preventDefault(),this._dragged=!0}_onTrackPointerUp(t){if(t.preventDefault(),document.removeEventListener("pointermove",this._onTrackPointerMove),document.removeEventListener("pointerup",this._onTrackPointerUp),this.snapOnClickEnabled||(this._dragged=!1),!this._dragged){const e=this._getCursorPositionFromEvent(t),i=this._valueFromPosition(e);this._emitTrackClickEvent({value:i})}}_onSegmentPointerDown(t){t.preventDefault();const e=t.target,i=e["data-segment-index"],r=e["data-min-thumb-index"],s=e["data-max-thumb-index"];if(this._isDisabled()||!_(r)||!_(s))return;t.stopPropagation(),this._storeTrackDimensions(),document.addEventListener("pointerup",this._onSegmentPointerUp);const n=this._getAnchorDetails(r),o=this._getAnchorDetails(s);var a,l;this.syncedSegmentsEnabled?(this.segmentElements.forEach(c=>c.classList.add(Rt.segmentElementActive)),this._anchorElements.forEach(c=>c.classList.add(Rt.anchorElementActive))):(this.segmentElements.getItemAt(i).classList.add(Rt.segmentElementActive),(a=this._anchorElements[n.index])==null||a.classList.add(Rt.anchorElementActive),(l=this._anchorElements[o.index])==null||l.classList.add(Rt.anchorElementActive)),this._segmentDragStartInfo={cursorPosition:this._getCursorPositionFromEvent(t),index:i,details:this._normalizeSegmentDetails({min:n,max:o})},this.draggableSegmentsEnabled&&(document.addEventListener("pointermove",this._onSegmentPointerMove),this.notifyChange("state"),this._emitSegmentDragEvent({index:i,state:"start",thumbIndices:[r,s]}))}_onSegmentPointerMove(t){if(!this._segmentDragStartInfo)return;t.preventDefault();const{_trackHeight:e,_trackWidth:i,_segmentDragStartInfo:{index:r,cursorPosition:s,details:{min:n,max:o}}}=this,{index:a,position:l,value:c}=n,{index:h,position:p,value:f}=o;this._dragged=!0;const g=this._getCursorPositionFromEvent(t);if(g===s)return;const y=this._positionToPercent(s),v=this._positionToPercent(g)-y,b=this._positionToPercent(l)+v,w=this._positionToPercent(p)+v,{min:S}=this._getAnchorBoundsAsPercents(a),{max:T}=this._getAnchorBoundsAsPercents(h);let C=!1,M=!1;if(b<S?C=!0:w>T&&(M=!0),C){const{min:j,max:V}=this.viewModel.getBoundsForValueAtIndex(a),q=this._isPositionInverted()?V:j,J=q,O=f+(q-c),L=O-this.values[h];return void(this.syncedSegmentsEnabled?this._updateAnchorValuesByDifference(L):this._updateAnchorValues([a,h],[J,O]))}if(M){const{min:j,max:V}=this.viewModel.getBoundsForValueAtIndex(h),q=this._isPositionInverted()?j:V,J=q,O=c+(q-f),L=O-this.values[a];return void(this.syncedSegmentsEnabled?this._updateAnchorValuesByDifference(L):this._updateAnchorValues([a,h],[O,J]))}const P=this._isHorizontalLayout()?i:e,F=w/100*P,z=b/100*P,D=this.values,U=[D[a],D[h]],G=this._getValueForAnchorAtPosition(a,z),k=this._getValueForAnchorAtPosition(h,F);this.syncedSegmentsEnabled?this._updateAnchorValuesByDifference(G-U[0]):this._updateAnchorValues([a,h],[G,k]),[this.values[a],this.values[h]].every((j,V)=>j===U[V])||this._emitSegmentDragEvent({index:r,state:"drag",thumbIndices:[a,h]})}_onSegmentPointerUp(t){if(t.preventDefault(),document.removeEventListener("pointerup",this._onSegmentPointerUp),document.removeEventListener("pointermove",this._onSegmentPointerMove),!this._segmentDragStartInfo)return;const{_dragged:e,max:i,min:r,values:s}=this,{index:n,details:{min:{index:o},max:{index:a}}}=this._segmentDragStartInfo;if(this.segmentElements.forEach(l=>l.classList.remove(Rt.segmentElementActive)),this._anchorElements.forEach(l=>l.classList.remove(Rt.anchorElementActive)),this.draggableSegmentsEnabled){const l=i-r,c=s[o],h=s[a];this._lastMovedHandleIndex=c===h?c>l/2?o:a:null,this._dragged=!1,this._segmentDragStartInfo=null,this.notifyChange("state"),this._emitSegmentDragEvent({index:n,state:"stop",thumbIndices:[o,a]})}if(!e){const l=this._getCursorPositionFromEvent(t),c=this._valueFromPosition(l);this._emitSegmentClickEvent({index:n,value:c,thumbIndices:[o,a]})}}_onTickGroupClick(t){const e=t.target;if(e["data-config"]){const i=e["data-tick-config-index"],r=e["data-tick-group-index"],s=e["data-value"];this._emitTickClickEvent({configIndex:i,groupIndex:r,value:s})}}_storeTrackDimensions(){if(this.trackElement){const t=this._getDimensions(this.trackElement);this._trackHeight=t.height,this._trackWidth=t.width}}_onLabelPointerDown(){this._isDisabled()||(this._dragged=!1,document.addEventListener("pointerup",this._onAnchorPointerUp),document.addEventListener("pointermove",this._onAnchorPointerMove))}_onLabelPointerMove(){this._isDisabled()||(this._dragged=!0)}_onLabelPointerUp(t){if(this._isDisabled())return;const e=t.target["data-thumb-index"];this.labelInputsEnabled&&!this._dragged&&_(e)&&(this._activeLabelInputIndex=e),this._dragged=!1,this.notifyChange("state"),document.removeEventListener("pointerup",this._onLabelPointerUp),document.removeEventListener("pointermove",this._onLabelPointerMove)}_onLabelInputBlur(t){const{_activeLabelInputIndex:e,values:i,viewModel:r}=this,s=t.target.value;if(this._activeLabelInputIndex=null,this.notifyChange("state"),!s)return;const n=this._parseInputValue(s,"value",e),o=i[e],{min:a,max:l}=this.viewModel.getBoundsForValueAtIndex(e);if(n<a||n>l)return;r.setValue(e,n);const c=this.values[e];o!==c&&this._emitThumbChangeEvent({index:e,oldValue:o,value:c})}_onInputKeyDown(t){if(this._isDisabled())return;const{target:e}=t,i=Fl(t),{hideInput1:r,hideInput2:s,hideInput3:n}=jo,{_activeLabelInputIndex:o,_anchorElements:a}=this,l=e;if(i===r||i===s||i===n){t.stopPropagation();const c=o;l.blur(),_(c)?a[c].focus():l.parentElement.focus()}}_onMaxLabelClick(){this._isDisabled()||(this._emitRangeLabelClickEvent({type:"max-click",value:this.max}),this.rangeLabelInputsEnabled&&(this._isMaxInputActive=!0,this.notifyChange("state")))}_onMaxLabelKeyDown(t){this._isDisabled()||Fl(t)!==jo.showInput||(this._isMaxInputActive=!0,this.notifyChange("state"))}_onMaxInputBlur(t){const e=t.target.value;if(this._isMaxInputActive=!1,this.notifyChange("state"),!e)return;const i=this.max,r=this._parseInputValue(e,"max");r<=this.min||(this.viewModel.set("max",r),this.max!==i&&this._emitMaxChangeEvent({oldValue:i,value:this.max}))}_onMinLabelClick(){this._isDisabled()||(this._emitRangeLabelClickEvent({type:"min-click",value:this.min}),this.rangeLabelInputsEnabled&&(this._isMinInputActive=!0,this.notifyChange("state")))}_onMinLabelKeyDown(t){this._isDisabled()||Fl(t)!==jo.showInput||(this._isMinInputActive=!0,this.notifyChange("state"))}_onMinInputBlur(t){const e=t.target.value;if(this._isMinInputActive=!1,this.notifyChange("state"),!e)return;const i=this.min,r=this._parseInputValue(e,"min");r>=this.max||(this.viewModel.set("min",r),this.min!==i&&this._emitMinChangeEvent({oldValue:i,value:this.min}))}_isDisabled(){return this.disabled||this.state==="disabled"}_positionFromValue(t){const{max:e,min:i}=this,r=e-i;if(r===0)return 0;const{_trackHeight:s,_trackWidth:n}=this,o=this._isHorizontalLayout();let a=parseFloat(o?(n*(t-i)/r).toFixed(2):(s*(e-t)/r).toFixed(2));return this._isReversedLayout()&&(a=o?n-a:s-a),a}_valueFromPosition(t){const{_trackHeight:e,_trackWidth:i,max:r,min:s,precision:n}=this,o=r-s;let a=this._isHorizontalLayout()?t*o/i+s:o*(1e3-t/e*1e3)/1e3+s;return this._isReversedLayout()&&(a=r+s-a),parseFloat(a.toFixed(n))}_positionToPercent(t){const{_trackHeight:e,_trackWidth:i}=this,r=100*t/(this._isHorizontalLayout()?i:e);return this._applyPrecisionToPosition(r)}_applyPrecisionToPosition(t){return parseFloat(t.toFixed(this._positionPrecision))}_isPositionInverted(){const{layout:t}=this;return t==="horizontal-reversed"||t==="vertical"}_isHorizontalLayout(){return this.layout.indexOf("horizontal")>-1}_isReversedLayout(){return this.layout.indexOf("reversed")>-1}_normalizeSegmentDetails(t){if(this._isPositionInverted()){const{min:e,max:i}=t;return{min:i,max:e}}return t}_parseInputValue(t,e,i){return this.inputParseFunction?this.inputParseFunction(t,e,i):this.viewModel.defaultInputParseFunction(t)}_formatInputValue(t,e,i){return this.inputFormatFunction?this.inputFormatFunction(t,e,i):this.viewModel.defaultInputFormatFunction(t)}_getAnchorDetails(t){const e=[...this.values].sort((r,s)=>r-s)[t],i=this.values.indexOf(e);return{index:i,position:this._getPositionOfElement(this._anchorElements[i]),value:e}}_updateAnchorStyle(t,e){const i=this._anchorElements[t];i&&(this._isHorizontalLayout()?i.style.left=`${e}`:i.style.top=`${e}`)}_getStyleForAnchor(t,e,i){const r=this._getPositionStyleForElement(t);if(this.values.length===1)return`${r}`;const s=this._zIndices[e];return`${r}; z-index: ${i?this._zIndexOffset+s:s}`}_getPositionStyleForElement(t){const e=this._positionFromValue(t),i=this._positionToPercent(e);return`${this._isHorizontalLayout()?"left":"top"}: ${i+"%"}`}_getPositionOfElement(t){const e=this._getDimensions(t.offsetParent),i=this._getDimensions(t);return this._isHorizontalLayout()?this._applyPrecisionToPosition(i.left-e.left):this._applyPrecisionToPosition(i.top-e.top)}_updateAnchorValues(t,e){t.forEach((i,r)=>this._toValue(i,e[r]))}_updateAnchorValuesByDifference(t){const{min:e,max:i,values:r}=this;r.forEach((s,n)=>this._toValue(n,Math.max(Math.min(s+t,i),e)))}_toValue(t,e){_(this.steps)&&(e=this._getStepValues()[this._getIndexOfNearestStepValue(e)]),this._updateAnchorStyle(t,this._getPositionStyleForElement(e)),this.viewModel.setValue(t,e)}_toPosition(t,e){const i=_(this.steps)?this._getStepValueForAnchorAtPosition(t,e):this._getValueForAnchorAtPosition(t,e);this._updateAnchorStyle(t,this._getPositionStyleForElement(i)),this.viewModel.setValue(t,i)}_getValueForAnchorAtPosition(t,e){const{min:i,max:r}=this._getAnchorBoundsInPixels(t),{min:s,max:n}=this.viewModel.getBoundsForValueAtIndex(t);let o,a,l=null;return this._isPositionInverted()?(o=s,a=n):(o=n,a=s),l=e>r?o:e<i?a:this._valueFromPosition(e),l>n?l=n:l<s&&(l=s),l}_getStepValueForAnchorAtPosition(t,e){const i=this._getStepValues(),r=this._calculateNearestStepPosition(e),s=this._getValueForAnchorAtPosition(t,r);return i[this._getIndexOfNearestStepValue(s)]}_getAnchorBoundsAsPercents(t){const{min:e,max:i}=this._getAnchorBoundsInPixels(t);return{min:this._positionToPercent(e),max:this._positionToPercent(i)}}_getAnchorBoundsInPixels(t){const{_anchorElements:e,_trackHeight:i,_trackWidth:r,thumbsConstrained:s}=this,n=e[t-1],o=e[t+1],a=this._isHorizontalLayout()?r:i;return s?this._isPositionInverted()?{max:n?this._getPositionOfElement(n):a,min:o?this._getPositionOfElement(o):0}:{max:o?this._getPositionOfElement(o):a,min:n?this._getPositionOfElement(n):0}:{max:a,min:0}}_getIndexOfNearestValue(t){return this.values.indexOf(this.values.reduce((e,i)=>Math.abs(i-t)<Math.abs(e-t)?i:e))}_getCursorPositionFromEvent(t){const e=this._getDimensions(this.trackElement);return this._isHorizontalLayout()?t.clientX-e.left:t.clientY-e.top}_getStepValues(){const{steps:t}=this;if(Array.isArray(t))return t;const{max:e,min:i}=this,r=Math.ceil((e-i)/t),s=[];for(let n=0;n<=r;n++){const o=i+t*n;s.push(o>e?e:o)}return s}_toStep(t,e){const{values:i,viewModel:r}=this,s=i[t],n=this._getStepValues(),o=n.indexOf(s);let a=null;if(o>-1){const l=n[o+e],c=this._positionFromValue(l);a=this._getStepValueForAnchorAtPosition(t,c)}else a=n[this._getIndexOfNearestStepValue(s)+e];r.setValue(t,a)}_getIndexOfNearestStepValue(t){const{steps:e}=this;if(!_(e))return null;const i=this._getStepValues(),r=i.reduce((s,n)=>Math.abs(n-t)<Math.abs(s-t)?n:s);return i.indexOf(r)}_calculateNearestStepPosition(t){const e=this._valueFromPosition(t),i=this._getIndexOfNearestStepValue(e),r=this._getStepValues();return this._positionFromValue(r[i])}_getTickCounts(t,e){const{mode:i}=e;return i==="count"||i==="position"?t||0:i==="percent"&&100/t||0}_calculateTickPositions(t){return t.map(e=>this._positionFromValue(e))}_calculateEquidistantTickPositions(t){const{_trackWidth:e,_trackHeight:i}=this,r=this._isHorizontalLayout()?e:i,s=r/(t-1),n=[];if(t===1)return[r/2];for(let o=0;o<t;o++){const a=o*s;a<=r&&n.push(a)}return n}_getDimensions(t){try{return t.getBoundingClientRect()}catch(e){if(typeof e=="object"&&e!==null)return new DOMRect(0,0,0,0);throw e}}_emitTrackClickEvent(t){this.emit("track-click",he(E({},t),{type:"track-click"}))}_emitTickClickEvent(t){this.emit("tick-click",he(E({},t),{type:"tick-click"}))}_emitMaxChangeEvent(t){this.emit("max-change",he(E({},t),{type:"max-change"}))}_emitMinChangeEvent(t){this.emit("min-change",he(E({},t),{type:"min-change"}))}_emitThumbChangeEvent(t){this.emit("thumb-change",he(E({},t),{type:"thumb-change"}))}_emitThumbClickEvent(t){this.emit("thumb-click",he(E({},t),{type:"thumb-click"}))}_emitThumbDragEvent(t){this.emit("thumb-drag",he(E({},t),{type:"thumb-drag"}))}_emitSegmentClickEvent(t){this.emit("segment-click",he(E({},t),{type:"segment-click"}))}_emitSegmentDragEvent(t){this.emit("segment-drag",he(E({},t),{type:"segment-drag"}))}_emitRangeLabelClickEvent(t){this.emit(t.type,E({},t))}};u([d()],It.prototype,"disabled",void 0),u([d()],It.prototype,"extraNodes",void 0),u([d()],It.prototype,"draggableSegmentsEnabled",void 0),u([d()],It.prototype,"inputCreatedFunction",void 0),u([Ve("viewModel.inputFormatFunction")],It.prototype,"inputFormatFunction",void 0),u([Ve("viewModel.inputParseFunction")],It.prototype,"inputParseFunction",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],It.prototype,"label",void 0),u([d({readOnly:!0})],It.prototype,"labelElements",void 0),u([d()],It.prototype,"labelInputsEnabled",void 0),u([Ve("viewModel.labelFormatFunction")],It.prototype,"labelFormatFunction",void 0),u([Ve("viewModel.labels")],It.prototype,"labels",void 0),u([d()],It.prototype,"labelsVisible",null),u([d({value:"horizontal"})],It.prototype,"layout",null),u([Ve("viewModel.max")],It.prototype,"max",void 0),u([d({readOnly:!0})],It.prototype,"maxLabelElement",void 0),u([d(),qs("esri/widgets/Slider/t9n/Slider")],It.prototype,"messages",void 0),u([Ve("viewModel.min")],It.prototype,"min",void 0),u([d({readOnly:!0})],It.prototype,"minLabelElement",void 0),u([Ve("viewModel.precision")],It.prototype,"precision",void 0),u([d()],It.prototype,"rangeLabelInputsEnabled",void 0),u([d()],It.prototype,"rangeLabelsVisible",null),u([d({readOnly:!0})],It.prototype,"segmentElements",void 0),u([d()],It.prototype,"snapOnClickEnabled",void 0),u([d({readOnly:!0})],It.prototype,"state",null),u([d()],It.prototype,"steps",void 0),u([d()],It.prototype,"syncedSegmentsEnabled",void 0),u([Ve("viewModel.thumbsConstrained")],It.prototype,"thumbsConstrained",void 0),u([d()],It.prototype,"thumbCreatedFunction",void 0),u([d({readOnly:!0})],It.prototype,"thumbElements",void 0),u([d()],It.prototype,"tickConfigs",null),u([d({readOnly:!0})],It.prototype,"tickElements",void 0),u([d({readOnly:!0})],It.prototype,"trackElement",void 0),u([Ve("viewModel.values")],It.prototype,"values",void 0),u([d()],It.prototype,"viewModel",void 0),u([d()],It.prototype,"visibleElements",void 0),u([ut("visibleElements")],It.prototype,"castVisibleElements",null),It=u([R(Rst)],It);const flt=It;let cg=class extends ve{constructor(t){super(t),this._viewpointHandle=null,this._handles=new dt,this.group=null}initialize(){this._handles.add(ks(this,"view.ui","expand",t=>{const{target:e}=t;e&&e!==this&&e.expanded&&e.group&&e.group===this.group&&this._collapse()}))}destroy(){this._viewpointHandle=null,this.view=null,this._handles.destroy(),this._handles=null}set autoCollapse(t){this._set("autoCollapse",t),this._watchViewpoint()}set expanded(t){const e=!!t;this._set("expanded",e);const i=this.get("view.ui");i&&i.emit("expand",{target:this}),this._viewpointHandleChange(e)}get state(){return this.get("view.ready")?"ready":"disabled"}set view(t){this._get("view")!==t&&(this._set("view",t),t&&bx(t,"ready",()=>{this.view===t&&this._watchViewpoint()}))}_viewpointHandleChange(t){this._viewpointHandle&&(t?bx(this.view,"stationary",()=>this._viewpointHandle.resume()):this._viewpointHandle.pause())}_watchViewpoint(){const t="viewpoint";this._handles.remove(t),this._viewpointHandle=null;const{autoCollapse:e,view:i}=this;if(i&&e){const r=i.type==="3d"?"camera":"viewpoint",s=$H(i,r,()=>this._collapse());this._handles.add(s,t),this._viewpointHandle=s}}_collapse(){this.expanded=!1}};u([d({value:!1})],cg.prototype,"autoCollapse",null),u([d({value:!1})],cg.prototype,"expanded",null),u([d()],cg.prototype,"group",void 0),u([d({readOnly:!0})],cg.prototype,"state",null),u([d({value:null})],cg.prototype,"view",null),cg=u([R("esri.widgets.Expand.ExpandViewModel")],cg);const bge=cg,Xr={base:"esri-expand esri-widget",modeAuto:"esri-expand--auto",modeDrawer:"esri-expand--drawer",modeFloating:"esri-expand--floating",container:"esri-expand__container",containerExpanded:"esri-expand__container--expanded",panel:"esri-expand__panel",button:"esri-widget--button",text:"esri-icon-font-fallback-text",icon:"esri-collapse__icon",iconExpanded:"esri-expand__icon--expanded",iconNumber:"esri-expand__icon-number",iconNumberExpanded:"esri-expand__icon-number--expanded",expandIcon:"esri-icon-expand",collapseIcon:"esri-icon-collapse",content:"esri-expand__content",contentExpanded:"esri-expand__content--expanded",expandMask:"esri-expand__mask",expandMaskExpanded:"esri-expand__mask--expanded"};let Er=class extends Bs{constructor(t,e){super(t,e),this.autoCollapse=null,this.closeOnEsc=!0,this.collapseTooltip="",this.content="",this.expanded=null,this.expandTooltip="",this.group=null,this.iconNumber=0,this.label=void 0,this.messages=null,this.messagesCommon=null,this.mode="auto",this.view=null,this.viewModel=new bge,this._handleKeyDown=i=>{const{closeOnEsc:r,_toggleButtonEl:s,expanded:n}=this;!n||!r||i.target===s||i.key!=="Escape"||(typeof r=="function"?r(i):r)&&(this.expanded=!1,s==null||s.focus())}}get contentId(){return`${this.id}_controls_content`}get expandTitle(){const{expanded:t,messagesCommon:e,collapseTooltip:i,expandTooltip:r}=this;return t?i||e.collapse:r||e.expand}get collapseIconClass(){return Xr.collapseIcon}set collapseIconClass(t){t?this._override("collapseIconClass",t):this._clearOverride("collapseIconClass")}get expandIconClass(){return DA(this.content)?this.content.iconClass:Xr.expandIcon}set expandIconClass(t){t?this._override("expandIconClass",t):this._clearOverride("expandIconClass")}expand(){this.viewModel.expanded=!0}collapse(){this.viewModel.expanded=!1}toggle(){this.viewModel.expanded=!this.viewModel.expanded}render(){const{mode:t}=this,e={[Xr.modeAuto]:t==="auto",[Xr.modeDrawer]:t==="drawer",[Xr.modeFloating]:t==="floating"};return ee("div",{class:this.classes(Xr.base,e),onkeydown:this._handleKeyDown},this.renderMask(),this.renderContainer())}renderContainer(){const{expanded:t}=this,e={[Xr.containerExpanded]:t};return ee("div",{class:this.classes(Xr.container,e)},this.renderPanel(),this.renderContent())}renderMask(){const{expanded:t}=this,e={[Xr.expandMaskExpanded]:t};return ee("div",{bind:this,onclick:this._toggle,class:this.classes(Xr.expandMask,e)})}renderBadgeNumber(){const{expanded:t,iconNumber:e}=this;return e&&!t?ee("span",{key:"expand__icon-number",class:Xr.iconNumber},e):null}renderPanelNumber(){const{iconNumber:t,expanded:e}=this;return t&&e?ee("span",{key:"expand__expand-icon-number",class:this.classes(Xr.iconNumber,Xr.iconNumberExpanded)},t):null}renderIcon(){const{collapseIconClass:t,expandIconClass:e,expanded:i}=this,r={[Xr.iconExpanded]:i,[t]:i,[e]:!i};return t===e&&(r[t]=!0),ee("span",{"aria-hidden":"true",class:this.classes(Xr.icon,r)})}renderTitle(){return ee("span",{class:Xr.text},this.expandTitle)}renderExpandButton(){const{expanded:t,expandTitle:e,contentId:i}=this;return ee("div",{afterCreate:this._storeToggleButtonEl,"aria-controls":i,"aria-expanded":t?"true":"false",bind:this,class:Xr.button,onclick:this._toggle,onkeydown:this._toggle,role:"button",tabindex:"0",title:e},this.renderBadgeNumber(),this.renderIcon(),this.renderTitle())}renderPanel(){return ee("div",{class:Xr.panel},this.renderExpandButton(),this.renderPanelNumber())}renderContent(){const{expanded:t,contentId:e,content:i}=this,r={[Xr.contentExpanded]:t},s={id:e,role:"region",class:this.classes(Xr.content,r)};return typeof i=="string"?ee("div",E({key:"content__string",innerHTML:i},s)):DA(i)?ee("div",E({key:"content__widget"},s),i.render()):i instanceof HTMLElement?ee("div",E({key:"content__html-element",bind:i,afterCreate:this._attachToNode},s)):SX(i)?ee("div",E({key:"content__node",bind:i.domNode,afterCreate:this._attachToNode},s)):null}_toggle(){this.toggle()}_attachToNode(t){const e=this;t.appendChild(e)}_storeToggleButtonEl(t){this._toggleButtonEl=t}};u([d({readOnly:!0})],Er.prototype,"contentId",null),u([d({readOnly:!0})],Er.prototype,"expandTitle",null),u([Ve("viewModel.autoCollapse")],Er.prototype,"autoCollapse",void 0),u([d()],Er.prototype,"closeOnEsc",void 0),u([d()],Er.prototype,"collapseIconClass",null),u([d()],Er.prototype,"collapseTooltip",void 0),u([d()],Er.prototype,"content",void 0),u([Ve("viewModel.expanded")],Er.prototype,"expanded",void 0),u([d()],Er.prototype,"expandIconClass",null),u([d()],Er.prototype,"expandTooltip",void 0),u([Ve("viewModel.group")],Er.prototype,"group",void 0),u([d()],Er.prototype,"iconNumber",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Er.prototype,"label",void 0),u([d(),qs("esri/widgets/Expand/t9n/Expand")],Er.prototype,"messages",void 0),u([d(),qs("esri/t9n/common")],Er.prototype,"messagesCommon",void 0),u([d()],Er.prototype,"mode",void 0),u([Ve("viewModel.view")],Er.prototype,"view",void 0),u([d({type:bge})],Er.prototype,"viewModel",void 0),u([ia()],Er.prototype,"_toggle",null),Er=u([R("esri.widgets.Expand")],Er);const mlt=Er;let Bc=class extends ve{constructor(){super(...arguments),this.outSpatialReference=null,this.processExtent=null,this.processSpatialReference=null,this.returnFeatureCollection=!1,this.returnM=!1,this.returnZ=!1}};u([d({type:Ue})],Bc.prototype,"outSpatialReference",void 0),u([d({type:ht})],Bc.prototype,"processExtent",void 0),u([d({type:Ue})],Bc.prototype,"processSpatialReference",void 0),u([d({nonNullable:!0})],Bc.prototype,"returnFeatureCollection",void 0),u([d({nonNullable:!0})],Bc.prototype,"returnM",void 0),u([d({nonNullable:!0})],Bc.prototype,"returnZ",void 0),Bc=u([R("esri/rest/geoprocessor/GPOptions")],Bc),Bc.from=Ni(Bc);const zw=Bc;let Gc=class extends ge{constructor(){super(...arguments),this.extent=null,this.height=null,this.href=null,this.opacity=1,this.rotation=0,this.scale=null,this.visible=!0,this.width=null}};u([d({type:ht})],Gc.prototype,"extent",void 0),u([d()],Gc.prototype,"height",void 0),u([d()],Gc.prototype,"href",void 0),u([d()],Gc.prototype,"opacity",void 0),u([d()],Gc.prototype,"rotation",void 0),u([d()],Gc.prototype,"scale",void 0),u([d()],Gc.prototype,"visible",void 0),u([d()],Gc.prototype,"width",void 0),Gc=u([R("esri.layer.support.MapImage")],Gc);const wge=Gc;let yC=class extends ge{constructor(t){super(t),this.itemId=null,this.url=null}};u([d({type:String,json:{read:{source:"itemID"},write:{target:"itemID"}}})],yC.prototype,"itemId",void 0),u([d({type:String,json:{write:!0}})],yC.prototype,"url",void 0),yC=u([R("esri.rest.support.DataFile")],yC);const vB=yC,xge=new wt({esriMeters:"meters",esriFeet:"feet",esriKilometers:"kilometers",esriMiles:"miles",esriNauticalMiles:"nautical-miles",esriYards:"yards"},{ignoreUnknown:!1});let vC=class extends ge{constructor(t){super(t),this.distance=0,this.units=null}};u([d({json:{write:!0}})],vC.prototype,"distance",void 0),u([d({json:{read:xge.read,write:xge.write}})],vC.prototype,"units",void 0),vC=u([R("esri/rest/support/LinearUnit")],vC);const Sge=vC,Tge=new wt({GPBoolean:"boolean",GPDataFile:"data-file",GPDate:"date",GPDouble:"double",GPFeatureRecordSetLayer:"feature-record-set-layer",GPField:"field",GPLinearUnit:"linear-unit",GPLong:"long",GPRasterData:"raster-data",GPRasterDataLayer:"raster-data-layer",GPRecordSet:"record-set",GPString:"string","GPMultiValue:GPBoolean":"multi-value","GPMultiValue:GPDataFile":"multi-value","GPMultiValue:GPDate":"multi-value","GPMultiValue:GPDouble":"multi-value","GPMultiValue:GPFeatureRecordSetLayer":"multi-value","GPMultiValue:GPField":"multi-value","GPMultiValue:GPLinearUnit":"multi-value","GPMultiValue:GPLong":"multi-value","GPMultiValue:GPRasterData":"multi-value","GPMultiValue:GPRasterDataLayer":"multi-value","GPMultiValue:GPRecordSet":"multi-value","GPMultiValue:GPString":"multi-value"});let _C=class extends ge{constructor(t){super(t),this.dataType=null,this.value=null}};u([d({json:{read:Tge.read,write:Tge.write}})],_C.prototype,"dataType",void 0),u([d()],_C.prototype,"value",void 0),_C=u([R("esri.rest.support.ParameterValue")],_C);const Ist=_C;let Vw=class extends ge{constructor(t){super(t),this.format=null,this.itemId=null,this.url=null}};u([d()],Vw.prototype,"format",void 0),u([d({json:{read:{source:"itemID"},write:{target:"itemID"}}})],Vw.prototype,"itemId",void 0),u([d()],Vw.prototype,"url",void 0),Vw=u([R("esri/rest/support/RasterData")],Vw);const Cge=Vw;async function Mge(t,e,i,r,s){const n={},o={},a=[];return Dst(r,a,n),NA(a).then(l=>{const{outSpatialReference:c,processExtent:h,processSpatialReference:p,returnFeatureCollection:f,returnM:g,returnZ:y}=i,{path:v}=ss(t);for(const M in n){const P=n[M];o[M]=l.slice(P[0],P[1])}const b=c?c.wkid||c:null,w=p?p.wkid||p:null,S=e==="execute"?{returnFeatureCollection:f||void 0,returnM:g||void 0,returnZ:y||void 0}:null,T=Y4(he(E(E(E({},h?{context:{extent:h,outSR:b,processSR:w}}:{"env:outSR":b,"env:processSR":w}),r),S),{f:"json"}),null,o),C=he(E({},s),{query:T});return vt(`${v}/${e}`,C)})}function Dst(t,e,i){for(const r in t){const s=t[r];if(s&&typeof s=="object"&&s instanceof Cu){const{features:n}=s;i[r]=[e.length,e.length+n.length],n.forEach(o=>{e.push(o.geometry)})}}}function _B(t){const e=t.dataType,i=Ist.fromJSON(t);switch(e){case"GPBoolean":case"GPDouble":case"GPLong":case"GPString":case"GPMultiValue:GPBoolean":case"GPMultiValue:GPDouble":case"GPMultiValue:GPLong":case"GPMultiValue:GPString":return i;case"GPDate":i.value=new Date(i.value);break;case"GPDataFile":i.value=vB.fromJSON(i.value);break;case"GPLinearUnit":i.value=Sge.fromJSON(i.value);break;case"GPFeatureRecordSetLayer":case"GPRecordSet":{const r=t.value.url;i.value=r?vB.fromJSON(i.value):Cu.fromJSON(i.value);break}case"GPRasterData":case"GPRasterDataLayer":{const r=t.value.mapImage;i.value=r?wge.fromJSON(r):Cge.fromJSON(i.value);break}case"GPField":i.value=t_.fromJSON(i.value);break;case"GPMultiValue:GPDate":{const r=i.value;i.value=r.map(s=>new Date(s));break}case"GPMultiValue:GPDataFile":i.value=i.value.map(r=>vB.fromJSON(r));break;case"GPMultiValue:GPLinearUnit":i.value=i.value.map(r=>Sge.fromJSON(r));break;case"GPMultiValue:GPFeatureRecordSetLayer":case"GPMultiValue:GPRecordSet":i.value=i.value.map(r=>Cu.fromJSON(r));break;case"GPMultiValue:GPRasterData":case"GPMultiValue:GPRasterDataLayer":i.value=i.value.map(r=>r?wge.fromJSON(r):Cge.fromJSON(i.value));break;case"GPMultiValue:GPField":i.value=i.value.map(r=>t_.fromJSON(r))}return i}function Y4(t,e,i){for(const r in t){const s=t[r];Array.isArray(s)?t[r]=JSON.stringify(s.map(n=>Y4({item:n},!0).item)):s instanceof Date&&(t[r]=s.getTime())}return kX(t,e,i)}const Pge=new wt({esriJobMessageTypeInformative:"informative",esriJobMessageTypeProcessDefinition:"process-definition",esriJobMessageTypeProcessStart:"process-start",esriJobMessageTypeProcessStop:"process-stop",esriJobMessageTypeWarning:"warning",esriJobMessageTypeError:"error",esriJobMessageTypeEmpty:"empty",esriJobMessageTypeAbort:"abort"});let bC=class extends ge{constructor(t){super(t),this.description=null,this.type=null}};u([d({type:String,json:{write:!0}})],bC.prototype,"description",void 0),u([d({type:String,json:{read:Pge.read,write:Pge.write}})],bC.prototype,"type",void 0),bC=u([R("esri.rest.support.GPMessage")],bC);const Age=bC;async function Fst(t,e,i,r){return i=zw.from(i||{}),Mge(t,"execute",i,e,r).then(s=>{const n=s.data.results||[],o=s.data.messages||[];return{results:n.map(_B),messages:o.map(a=>Age.fromJSON(a))}})}var X4;const Lst=new wt({esriJobCancelled:"job-cancelled",esriJobCancelling:"job-cancelling",esriJobDeleted:"job-deleted",esriJobDeleting:"job-deleting",esriJobTimedOut:"job-timed-out",esriJobExecuting:"job-executing",esriJobFailed:"job-failed",esriJobNew:"job-new",esriJobSubmitted:"job-submitted",esriJobSucceeded:"job-succeeded",esriJobWaiting:"job-waiting"});let ug=X4=class extends ge{constructor(t){super(t),this.jobId=null,this.jobStatus=null,this.messages=null,this.requestOptions=null,this.sourceUrl=null,this._timer=null}cancelJob(t){const{jobId:e,sourceUrl:i}=this,{path:r}=ss(i),s=he(E(E({},this.requestOptions),t),{query:{f:"json"}});return this._clearTimer(),vt(`${r}/jobs/${e}/cancel`,s).then(n=>{const o=X4.fromJSON(n.data);return this.messages=o.messages,this.jobStatus=o.jobStatus,this})}destroy(){clearInterval(this._timer)}checkJobStatus(t){const{path:e}=ss(this.sourceUrl),i=he(E(E({},this.requestOptions),t),{query:{f:"json"}}),r=`${e}/jobs/${this.jobId}`;return vt(r,i).then(({data:s})=>{const n=X4.fromJSON(s);return this.messages=n.messages,this.jobStatus=n.jobStatus,this})}fetchResultData(t,e,i){e=zw.from(e||{});const{returnFeatureCollection:r,returnM:s,returnZ:n,outSpatialReference:o}=e,{path:a}=ss(this.sourceUrl),l=Y4({returnFeatureCollection:r,returnM:s,returnZ:n,outSR:o,returnType:"data",f:"json"},null),c=he(E(E({},this.requestOptions),i),{query:l}),h=`${a}/jobs/${this.jobId}/results/${t}`;return vt(h,c).then(p=>_B(p.data))}fetchResultImage(t,e,i){const{path:r}=ss(this.sourceUrl),s=he(E({},e.toJSON()),{f:"json"}),n=Y4(s),o=he(E(E({},this.requestOptions),i),{query:n}),a=`${r}/jobs/${this.jobId}/results/${t}`;return vt(a,o).then(l=>_B(l.data))}async fetchResultMapImageLayer(){const{path:t}=ss(this.sourceUrl),e=t.indexOf("/GPServer/"),i=`${t.substring(0,e)}/MapServer/jobs/${this.jobId}`;return new(await import("./MapImageLayer.136e3603.js")).default({url:i})}async waitForJobCompletion(t={}){const{interval:e=1e3,signal:i,statusCallback:r}=t;return new Promise((s,n)=>{ps(i,()=>{this._clearTimer(),n($t())}),this._clearTimer();const o=setInterval(()=>{this._timer||n($t()),this.checkJobStatus(this.requestOptions).then(a=>{const{jobStatus:l}=a;switch(this.jobStatus=l,l){case"job-succeeded":this._clearTimer(),s(this);break;case"job-submitted":case"job-executing":case"job-waiting":case"job-new":r&&r(this);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-timed-out":case"job-failed":this._clearTimer(),n(this)}})},e);this._timer=o})}_clearTimer(){this._timer&&(clearInterval(this._timer),this._timer=null)}};u([d()],ug.prototype,"jobId",void 0),u([d({json:{read:Lst.read}})],ug.prototype,"jobStatus",void 0),u([d({type:[Age]})],ug.prototype,"messages",void 0),u([d()],ug.prototype,"requestOptions",void 0),u([d({json:{write:!0}})],ug.prototype,"sourceUrl",void 0),ug=X4=u([R("esri.rest.support.JobInfo")],ug);const $ge=ug;async function kst(t,e,i,r){return i=zw.from(i||{}),Mge(t,"submitJob",i,e,r).then(s=>{const n=$ge.fromJSON(s.data);return n.sourceUrl=t,n})}let mp=class extends EK{constructor(t){super(t),this._jobs=new Map,this.outSpatialReference=null,this.processExtent=null,this.processSpatialReference=null,this.returnFeatureCollection=!1,this.returnM=!1,this.returnZ=!1}destroy(){this._jobs.forEach(t=>t.destroy()),this._jobs.clear()}cancelJob(t,e){const i=this._getOrAddJob(t),r=E(E({},this.requestOptions),e);return i.cancelJob(r)}checkJobStatus(t,e){const i=this._getOrAddJob(t),r=E(E({},this.requestOptions),e);return i.checkJobStatus(r)}execute(t,e){const i=new zw({outSpatialReference:this.outSpatialReference,processExtent:this.processExtent,processSpatialReference:this.processSpatialReference,returnFeatureCollection:this.returnFeatureCollection,returnM:this.returnM,returnZ:this.returnZ}),r=E(E({},this.requestOptions),e);return Fst(this.url,t,i,r)}getResultData(t,e,i){const r=this._getOrAddJob(t),{returnFeatureCollection:s,returnM:n,returnZ:o,outSpatialReference:a}=this,l=new zw({returnFeatureCollection:s,returnM:n,returnZ:o,outSpatialReference:a,url:this.url}),c=E(E({},this.requestOptions),i);return r.fetchResultData(e,l,c)}getResultImage(t,e,i,r){const s=this._getOrAddJob(t),n=E(E({},this.requestOptions),r);return s.fetchResultImage(e,i,n)}async getResultMapImageLayer(t){return this._getOrAddJob(t).fetchResultMapImageLayer()}submitJob(t,e){const i=new zw({outSpatialReference:this.outSpatialReference,processExtent:this.processExtent,processSpatialReference:this.processSpatialReference,returnFeatureCollection:this.returnFeatureCollection,returnM:this.returnM,returnZ:this.returnZ}),r=E(E({},this.requestOptions),e);return kst(this.url,t,i,r).then(s=>(s.sourceUrl=this.url,this._jobs.set(s.jobId,s),s))}waitForJobCompletion(t,e={}){return this._getOrAddJob(t).waitForJobCompletion(e)}_getOrAddJob(t){let e=this._jobs.get(t);return e||(e=new $ge({sourceUrl:this.url,jobId:t}),this._jobs.set(e.jobId,e)),e}};u([d({type:Ue})],mp.prototype,"outSpatialReference",void 0),u([d({type:ht})],mp.prototype,"processExtent",void 0),u([d({type:Ue})],mp.prototype,"processSpatialReference",void 0),u([d({nonNullable:!0})],mp.prototype,"returnFeatureCollection",void 0),u([d({nonNullable:!0})],mp.prototype,"returnM",void 0),u([d({nonNullable:!0})],mp.prototype,"returnZ",void 0),mp=u([R("esri/tasks/Geoprocessor")],mp);const glt=mp;FB(le.getLogger("esri.tasks.support.FeatureSet"),"esri.tasks.support.FeatureSet",{replacement:"esri.rest.support.FeatureSet",version:"4.20",warnOnce:!0});FB(le.getLogger("esri.tasks.support.LinearUnit"),"esri.tasks.support.LinearUnit",{replacement:"esri.rest.support.LinearUnit",version:"4.20",warnOnce:!0});export{OL as $,_ as A,rP as B,Ae as C,M1 as D,A as E,Et as F,Wie as G,NM as H,QRe as I,bi as J,tt as K,Xp as L,n1 as M,M7e as N,jn as O,We as P,Mat as Q,kat as R,iy as S,Ke as T,Q as U,kRe as V,Xot as W,TP as X,Kot as Y,n2 as Z,eat as _,Rxe as a,ry as a$,Jx as a0,$ie as a1,Nwe as a2,Yot as a3,Ci as a4,Tat as a5,ySe as a6,xo as a7,Tu as a8,YZe as a9,Eat as aA,$at as aB,NF as aC,ks as aD,LM as aE,V_ as aF,Qe as aG,ln as aH,Yce as aI,En as aJ,vr as aK,Kst as aL,xp as aM,or as aN,Yl as aO,_x as aP,ne as aQ,Ns as aR,de as aS,se as aT,$$ as aU,Sat as aV,wJ as aW,vat as aX,RUe as aY,O1 as aZ,at as a_,EUe as aa,zl as ab,Dt as ac,sD as ad,ae,Fnt as af,le as ag,nl as ah,A1 as ai,g4e as aj,st as ak,ii as al,rL as am,re as an,uu as ao,ja as ap,$ as aq,lr as ar,Um as as,ht as at,N_ as au,ct as av,Rat as aw,Oat as ax,Wat as ay,D7 as az,xP as b,pi as b$,XZe as b0,l7 as b1,su as b2,S8 as b3,Yw as b4,pt as b5,Wde as b6,Lnt as b7,Mi as b8,cat as b9,Jw as bA,Ir as bB,Hh as bC,Gg as bD,Oo as bE,cP as bF,zi as bG,Id as bH,HO as bI,NO as bJ,N0 as bK,_R as bL,jje as bM,vle as bN,Gu as bO,yG as bP,qg as bQ,cM as bR,Kt as bS,ps as bT,$t as bU,Yst as bV,Mr as bW,Gb as bX,uP as bY,wg as bZ,CQe as b_,Bp as ba,Ont as bb,Gp as bc,qW as bd,K5 as be,pg as bf,Kr as bg,VB as bh,kB as bi,Xnt as bj,f2 as bk,hat as bl,jW as bm,bo as bn,yD as bo,Wc as bp,$g as bq,Jo as br,SM as bs,gDe as bt,vt as bu,po as bv,ms as bw,qYe as bx,BYe as by,HYe as bz,glt as c,eu as c$,Ss as c0,x as c1,Zi as c2,Lr as c3,ll as c4,GO as c5,yd as c6,Qa as c7,X as c8,vi as c9,c4e as cA,Gw as cB,Rpe as cC,Go as cD,Ave as cE,rc as cF,be as cG,Ut as cH,nUe as cI,fet as cJ,Tfe as cK,iot as cL,$ye as cM,Hst as cN,Fye as cO,Lye as cP,Ue as cQ,DP as cR,Aye as cS,Vqe as cT,Mq as cU,xne as cV,bV as cW,slt as cX,ult as cY,bne as cZ,qS as c_,tr as ca,Si as cb,fi as cc,Ht as cd,Pc as ce,wm as cf,Yf as cg,_m as ch,_t as ci,xm as cj,PE as ck,U0 as cl,$o as cm,XN as cn,Pt as co,$m as cp,kb as cq,Q0 as cr,ZO as cs,rx as ct,tu as cu,sUe as cv,x6 as cw,pW as cx,_nt as cy,ywe as cz,je as d,nr as d$,Ep as d0,Fi as d1,Ot as d2,Ai as d3,Oe as d4,BW as d5,Ce as d6,Oi as d7,Zot as d8,Zte as d9,uhe as dA,il as dB,ttt as dC,Bw as dD,Knt as dE,Oet as dF,my as dG,wi as dH,H2e as dI,Ka as dJ,rp as dK,rot as dL,Th as dM,Ls as dN,x1 as dO,Pte as dP,Ate as dQ,Pat as dR,YZ as dS,mJ as dT,Jwe as dU,Q5 as dV,Tnt as dW,ie as dX,ge as dY,S6 as dZ,Te as d_,Ph as da,lDe as db,_De as dc,yie as dd,sIe as de,vie as df,Xe as dg,wt as dh,uDe as di,JB as dj,fP as dk,YW as dl,Ql as dm,XW as dn,fo as dp,Ld as dq,Mpe as dr,PC as ds,gg as dt,Y2e as du,pat as dv,clt as dw,YE as dx,H6 as dy,vp as dz,Sge as e,ux as e$,$h as e0,Eh as e1,Lat as e2,Re as e3,Kv as e4,int as e5,Ra as e6,WC as e7,mb as e8,ma as e9,ax as eA,Da as eB,Rh as eC,bg as eD,gJ as eE,Ho as eF,ZDe as eG,fnt as eH,NA as eI,Lp as eJ,Cq as eK,s1e as eL,TK as eM,Mot as eN,Iot as eO,Fot as eP,yK as eQ,_K as eR,mK as eS,OAe as eT,Mnt as eU,mat as eV,L1e as eW,j1e as eX,Eg as eY,bK as eZ,iW as e_,Aat as ea,Goe as eb,Ln as ec,L7e as ed,llt as ee,am as ef,rQ as eg,cn as eh,qt as ei,ye as ej,un as ek,ue as el,dE as em,WP as en,Qwe as eo,uat as ep,$Qe as eq,tnt as er,Uh as es,l7e as et,c7e as eu,Ee as ev,eot as ew,kt as ex,nD as ey,Jv as ez,CM as f,vg as f$,ont as f0,kp as f1,u8 as f2,NRe as f3,g1 as f4,Vst as f5,dnt as f6,snt as f7,kG as f8,lL as f9,Na as fA,gwe as fB,ice as fC,gat as fD,S7e as fE,wat as fF,Int as fG,Wst as fH,tlt as fI,Ent as fJ,lP as fK,TPe as fL,xat as fM,yi as fN,FX as fO,HPe as fP,Iat as fQ,Dat as fR,bx as fS,xG as fT,eW as fU,Jst as fV,kn as fW,_Je as fX,jot as fY,gi as fZ,KG as f_,Jg as fa,bp as fb,qo as fc,yxe as fd,Zv as fe,FC as ff,dCe as fg,Mp as fh,znt as fi,vo as fj,lRe as fk,cRe as fl,t_ as fm,n_ as fn,tK as fo,bat as fp,u4e as fq,Jot as fr,rD as fs,got as ft,Cnt as fu,bnt as fv,xnt as fw,wnt as fx,Snt as fy,Sx as fz,Cu as g,Xat as g$,Bt as g0,yot as g1,vot as g2,rlt as g3,nlt as g4,Dnt as g5,oxe as g6,Ev as g7,ilt as g8,tR as g9,EC as gA,zs as gB,Ds as gC,Zz as gD,fRe as gE,j1 as gF,Sh as gG,XC as gH,e1 as gI,o6 as gJ,O1e as gK,De as gL,xq as gM,Zw as gN,Xpe as gO,Xrt as gP,fJ as gQ,gSe as gR,qe as gS,$y as gT,jZ as gU,dh as gV,Yat as gW,elt as gX,$pe as gY,Epe as gZ,Qat as g_,zu as ga,Dd as gb,knt as gc,uS as gd,li as ge,Mt as gf,Fs as gg,WW as gh,olt as gi,alt as gj,iL as gk,HSe as gl,Fd as gm,Di as gn,Vs as go,Ab as gp,Ge as gq,Tr as gr,Nt as gs,Hat as gt,AX as gu,vPe as gv,hQ as gw,l0e as gx,jst as gy,IE as gz,pn as h,vm as h$,Jat as h0,HI as h1,C$ as h2,EYe as h3,io as h4,ant as h5,_7 as h6,hl as h7,jS as h8,qi as h9,ZL as hA,v2e as hB,Qt as hC,W_ as hD,kSe as hE,os as hF,jr as hG,Dn as hH,RF as hI,Pp as hJ,_p as hK,ku as hL,q5e as hM,Lh as hN,P6 as hO,k1 as hP,hi as hQ,NS as hR,Sr as hS,y2 as hT,tA as hU,oot as hV,mx as hW,Li as hX,Y5e as hY,tLe as hZ,Xs as h_,xc as ha,Xi as hb,ut as hc,QF as hd,ZF as he,JF as hf,ev as hg,lat as hh,au as hi,xSe as hj,Gr as hk,vnt as hl,wSe as hm,_e as hn,Ye as ho,fy as hp,ke as hq,tot as hr,mnt as hs,si as ht,gnt as hu,H_ as hv,oF as hw,Lb as hx,nt as hy,wc as hz,jbe as i,Rnt as i$,Pg as i0,zat as i1,hn as i2,VF as i3,q1e as i4,lnt as i5,cr as i6,Hnt as i7,qnt as i8,A2e as i9,Gbe as iA,ji as iB,Nd as iC,Fn as iD,KU as iE,mQe as iF,mR as iG,sU as iH,go as iI,ar as iJ,qu as iK,zr as iL,cnt as iM,Sde as iN,kP as iO,Ust as iP,not as iQ,vs as iR,Gh as iS,sot as iT,Qoe as iU,Yme as iV,YP as iW,Zrt as iX,ege as iY,CF as iZ,br as i_,M2e as ia,iH as ib,Wnt as ic,FP as id,WZ as ie,Gnt as ig,Qnt as ih,Jnt as ii,Znt as ij,ys as ik,$A as il,mot as im,pot as io,fot as ip,hot as iq,dot as ir,Tc as is,Ao as it,tV as iu,eV as iv,Fwe as iw,Ii as ix,Me as iy,ynt as iz,x9 as j,Su as j$,Rl as j0,unt as j1,cbe as j2,yp as j3,vD as j4,ff as j5,tn as j6,Qf as j7,WO as j8,t5 as j9,hM as jA,zv as jB,_g as jC,nnt as jD,D2 as jE,GPe as jF,rnt as jG,ss as jH,EK as jI,Age as jJ,PPe as jK,_q as jL,Zat as jM,Ni as jN,SQe as jO,ppe as jP,y$ as jQ,$te as jR,kst as jS,Fst as jT,ARe as jU,Zl as jV,pM as jW,Eq as jX,qst as jY,i$e as jZ,wIe as j_,kl as ja,Ynt as jb,DI as jc,YSe as jd,_y as je,_2 as jf,CTe as jg,Xh as jh,nA as ji,obe as jj,N2e as jk,C6 as jl,qs as jm,Bs as jn,ee as jo,yu as jp,Q6 as jq,DA as jr,_r as js,BB as jt,Ah as ju,dM as jv,hq as jw,qC as jx,ei as jy,Ia as jz,Cst as k,lAe as k$,$Pe as k0,Bo as k1,Y4e as k2,X4e as k3,K4e as k4,swe as k5,COe as k6,HW as k7,Dot as k8,vne as k9,xot as kA,Oot as kB,Eot as kC,Ble as kD,nK as kE,fat as kF,Cie as kG,hnt as kH,bPe as kI,xK as kJ,wK as kK,Aot as kL,Pot as kM,BM as kN,Pnt as kO,Ant as kP,$nt as kQ,rbe as kR,_at as kS,Kk as kT,yat as kU,On as kV,fAe as kW,JRe as kX,Jbe as kY,YPe as kZ,Lot as k_,_ne as ka,pf as kb,Bi as kc,ir as kd,jnt as ke,qT as kf,QL as kg,Dr as kh,_U as ki,mo as kj,nSe as kk,jat as kl,X_ as km,H0 as kn,Wt as ko,Nat as kp,Bat as kq,R2e as kr,Uat as ks,Iqe as kt,kqe as ku,Dqe as kv,Fqe as kw,Lqe as kx,oK as ky,iK as kz,Xx as l,na as l$,QX as l0,rK as l1,Rot as l2,Xxe as l3,Uot as l4,lre as l5,fg as l6,Wk as l7,Zk as l8,gD as l9,Got as lA,Gat as lB,oHe as lC,o2 as lD,rZ as lE,SL as lF,qot as lG,Y8 as lH,F4e as lI,c9 as lJ,aie as lK,s9 as lL,a9 as lM,O$ as lN,Tie as lO,CIe as lP,l4e as lQ,aot as lR,oq as lS,bie as lT,S4e as lU,uv as lV,CD as lW,i_ as lX,Ea as lY,fDe as lZ,qte as l_,$a as la,Nst as lb,Bst as lc,Gst as ld,LB as le,xh as lf,Lt as lg,wot as lh,pbe as li,uo as lj,$ot as lk,UA as ll,xt as lm,sf as ln,Unt as lo,Nnt as lp,jve as lq,HD as lr,Kat as ls,aD as lt,iIe as lu,Bot as lv,Vot as lw,Wve as lx,tIe as ly,_1 as lz,Jl as m,az as m$,Bv as m0,Lie as m1,i1 as m2,VC as m3,AY as m4,RCe as m5,cot as m6,uot as m7,lot as m8,Gn as m9,ute as mA,S$e as mB,$Oe as mC,ROe as mD,gt as mE,cte as mF,La as mG,qOe as mH,NOe as mI,Oy as mJ,BF as mK,WOe as mL,ZOe as mM,XOe as mN,Iz as mO,eRe as mP,KOe as mQ,tRe as mR,$q as mS,Q2 as mT,MOe as mU,BOe as mV,UOe as mW,kOe as mX,zOe as mY,jOe as mZ,sRe as m_,qn as ma,Zs as mb,ho as mc,Mu as md,a$ as me,Y2 as mf,kz as mg,n$ as mh,mD as mi,Ww as mj,fr as mk,HOe as ml,Cf as mm,mn,GOe as mo,Wa as mp,gG as mq,Qst as mr,YOe as ms,JOe as mt,QOe as mu,VOe as mv,LOe as mw,FOe as mx,zy as my,aa as mz,dlt as n,LW as n$,zot as n0,IOe as n1,DOe as n2,OOe as n3,EOe as n4,w_ as n5,YKe as n6,yLe as n7,U6e as n8,vke as n9,Vnt as nA,XDe as nB,rat as nC,oat as nD,aat as nE,QDe as nF,xx as nG,WBe as nH,q8 as nI,pR as nJ,cje as nK,ktt as nL,Xtt as nM,A4 as nN,mit as nO,yit as nP,GD as nQ,Vat as nR,Rqe as nS,va as nT,Fat as nU,Iit as nV,Vje as nW,jqe as nX,iZe as nY,CZe as nZ,_Ze as n_,xke as na,Cke as nb,Yke as nc,Ile as nd,CNe as ne,qO as nf,PBe as ng,EBe as nh,lBe as ni,CKe as nj,OKe as nk,Lfe as nl,ntt as nm,ftt as nn,lit as no,Wot as np,Hot as nq,pP as nr,sL as ns,dxe as nt,mke as nu,iR as nv,wUe as nw,nat as nx,sat as ny,iat as nz,mlt as o,wZ as o$,Qot as o0,w4e as o1,ay as o2,qPe as o3,Gk as o4,ZPe as o5,JPe as o6,qp as o7,Ube as o8,zbe as o9,Ste as oA,pFe as oB,$Re as oC,fFe as oD,kte as oE,b$ as oF,ent as oG,vte as oH,dRe as oI,E$ as oJ,WPe as oK,wst as oL,jc as oM,ix as oN,pnt as oO,Zst as oP,tW as oQ,EW as oR,wx as oS,Z$ as oT,Die as oU,yx as oV,oIe as oW,v8 as oX,C4e as oY,T4e as oZ,Gv as o_,sH as oa,ox as ob,b4e as oc,CP as od,C1 as oe,A4e as of,h4e as og,uW as oh,dW as oi,oDe as oj,_ie as ok,Nie as ol,G$ as om,_4e as on,C9 as oo,Dte as op,Ve as oq,kX as or,Og as os,_D as ot,Cot as ou,yAe as ov,mAe as ow,U0e as ox,ti as oy,rS as oz,flt as p,Sot as p$,Tst as p0,_ot as p1,Wv as p2,Vl as p3,uq as p4,x4e as p5,bot as p6,wve as p7,Xst as p8,I as p9,Uhe as pA,qhe as pB,m3 as pC,cv as pD,Zr as pE,Hn as pF,rl as pG,Xb as pH,fHe as pI,Lhe as pJ,Nhe as pK,zhe as pL,pHe as pM,vU as pN,Vhe as pO,Jf as pP,cHe as pQ,Zf as pR,w7 as pS,v0 as pT,LUe as pU,jHe as pV,UHe as pW,NHe as pX,dat as pY,gRe as pZ,w1e as p_,Bnt as pa,Pst as pb,GXe as pc,sfe as pd,tfe as pe,c0 as pf,N3 as pg,xj as ph,wj as pi,nKe as pj,kot as pk,tDe as pl,iDe as pm,rDe as pn,zte as po,rRe as pp,Py as pq,iRe as pr,Jc as ps,E6e as pt,LSe as pu,DSe as pv,Kc as pw,The as px,EG as py,b6e as pz,zh as q,Tot as q0,Not as q1,tat as q2,Cat as q3,qat as q4,Mst as q5,plt as q6,u as r,hlt as s,d as t,dt as u,Zo as v,R as w,Ast as x,Kg as y,ve as z};
