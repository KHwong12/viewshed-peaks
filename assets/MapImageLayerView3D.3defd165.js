var S=Object.defineProperty,D=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var N=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable;var b=(a,e,t)=>e in a?S(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,E=(a,e)=>{for(var t in e||(e={}))N.call(e,t)&&b(a,t,e[t]);if(I)for(var t of I(e))Q.call(e,t)&&b(a,t,e[t]);return a},F=(a,e)=>D(a,G(e));import{e as o,d as p,fd as T,i as A,x as _,r as u,aq as $,aN as q}from"./index.89a7b683.js";import{V as z}from"./DynamicLayerView3D.6f0fb52b.js";import{c as H}from"./ExportImageParameters.f8ed207e.js";import{s as L}from"./clickToleranceUtils.f03f410d.js";import{t as R,d as j}from"./popupUtils.85d7881b.js";import{n as U}from"./floorFilterUtils.1acb5b5d.js";import{a as k}from"./drapedUtils.fa6ab048.js";import"./projectExtentUtils.c2292b8f.js";import"./ImageMaterialTechnique.971b25d8.js";import"./RefreshableLayerView.567b5392.js";import"./sublayerUtils.5227ee88.js";const B=a=>{let e=class extends a{initialize(){this.exportImageParameters=new H({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(t,n){const{layer:d}=this;if(!t)return Promise.reject(new _("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:d}));const y=this.get("view.scale"),h=[],f=async r=>{const i=r.minScale===0||y<=r.minScale,s=r.maxScale===0||y>=r.maxScale;if(r.visible&&i&&s){if(r.sublayers)r.sublayers.forEach(f);else if(r.popupEnabled){const m=j(r,F(E({},n),{defaultPopupTemplateEnabled:!1}));u(m)&&h.unshift({sublayer:r,popupTemplate:m})}}},V=d.sublayers.toArray().reverse().map(f);await Promise.all(V);const M=h.map(async({sublayer:r,popupTemplate:i})=>{await r.load().catch(()=>{});const s=r.createQuery(),m=u(n)?n.event:null,g=L({renderer:r.renderer,event:m}),w=this.createFetchPopupFeaturesQueryGeometry(t,g);if(s.geometry=w,s.outFields=await R(r,i),this.layer.type==="map-image"&&"floors"in this.view){var x,v;const O=(x=this.view)==null||(v=x.floors)==null?void 0:v.clone(),l=U(O,r);u(l)&&(s.where=s.where?`(${s.where}) AND (${l})`:l)}const P=await this._loadArcadeModules(i);return P&&P.arcadeUtils.hasGeometryOperations(i)||(s.maxAllowableOffset=w.width/g),(await r.queryFeatures(s)).features});return(await $(M)).reduce((r,i)=>i.value?[...r,...i.value]:r,[]).filter(r=>r!=null)}canResume(){var t;return!!super.canResume()&&((t=this.timeExtent)==null||!t.isEmpty)}_loadArcadeModules(t){if(t.get("expressionInfos.length")||Array.isArray(t.content)&&t.content.some(n=>n.type==="expression"))return q()}};return o([p()],e.prototype,"exportImageParameters",void 0),o([p({readOnly:!0})],e.prototype,"exportImageVersion",null),o([p()],e.prototype,"layer",void 0),o([p()],e.prototype,"suspended",void 0),o([p(T)],e.prototype,"timeExtent",void 0),e=o([A("esri.views.layers.MapImageLayerView")],e),e};let c=class extends B(z){constructor(){super(...arguments),this.type="map-image-3d"}initialize(){this.updatingHandles.add(this,"exportImageVersion",()=>this.updatingHandles.addPromise(this.refreshDebounced()))}createFetchPopupFeaturesQueryGeometry(a,e){return k(a,e,this.view)}getFetchOptions(){return{timeExtent:this.timeExtent}}};c=o([A("esri.views.3d.layers.MapImageLayerView3D")],c);const ie=c;export{ie as default};
